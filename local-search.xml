<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>yolov5æºç è¯¦è§£</title>
    <link href="/2022/10/21/yolov5%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3/"/>
    <url>/2022/10/21/yolov5%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="yolo.yaml">yolo.yaml</h1><ul><li>ä»¥yolov5s.yamlä¸ºä¾‹</li></ul><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-comment"># YOLOv5 ğŸš€ by Ultralytics, GPL-3.0 license</span><br><br><span class="hljs-comment"># Parameters</span><br><span class="hljs-attr">nc:</span> <span class="hljs-number">80</span>  <span class="hljs-comment"># number of classes</span><br><span class="hljs-attr">depth_multiple:</span> <span class="hljs-number">0.33</span>  <span class="hljs-comment"># model depth multiple</span><br><span class="hljs-attr">width_multiple:</span> <span class="hljs-number">0.50</span>  <span class="hljs-comment"># layer channel multiple</span><br><span class="hljs-attr">anchors:</span><br>  <span class="hljs-bullet">-</span> [<span class="hljs-number">10</span>,<span class="hljs-number">13</span>, <span class="hljs-number">16</span>,<span class="hljs-number">30</span>, <span class="hljs-number">33</span>,<span class="hljs-number">23</span>]  <span class="hljs-comment"># P3/8</span><br>  <span class="hljs-bullet">-</span> [<span class="hljs-number">30</span>,<span class="hljs-number">61</span>, <span class="hljs-number">62</span>,<span class="hljs-number">45</span>, <span class="hljs-number">59</span>,<span class="hljs-number">119</span>]  <span class="hljs-comment"># P4/16</span><br>  <span class="hljs-bullet">-</span> [<span class="hljs-number">116</span>,<span class="hljs-number">90</span>, <span class="hljs-number">156</span>,<span class="hljs-number">198</span>, <span class="hljs-number">373</span>,<span class="hljs-number">326</span>]  <span class="hljs-comment"># P5/32</span><br><br><span class="hljs-comment"># YOLOv5 v6.0 backbone</span><br><span class="hljs-attr">backbone:</span><br>  <span class="hljs-comment"># [from, number, module, args]</span><br>  [[<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">64</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>]],  <span class="hljs-comment"># 0-P1/2</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">128</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]],  <span class="hljs-comment"># 1-P2/4</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">128</span>]],<br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]],  <span class="hljs-comment"># 3-P3/8</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">6</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">256</span>]],<br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]],  <span class="hljs-comment"># 5-P4/16</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">9</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">512</span>]],<br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">1024</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]],  <span class="hljs-comment"># 7-P5/32</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">1024</span>]],<br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">SPPF</span>, [<span class="hljs-number">1024</span>, <span class="hljs-number">5</span>]],  <span class="hljs-comment"># 9</span><br>  ]<br><br><span class="hljs-comment"># YOLOv5 v6.0 head</span><br><span class="hljs-attr">head:</span><br>  [[<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">512</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]],<br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">nn.Upsample</span>, [<span class="hljs-string">None</span>, <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;nearest&#x27;</span>]],<br>   [[<span class="hljs-number">-1</span>, <span class="hljs-number">6</span>], <span class="hljs-number">1</span>, <span class="hljs-string">Concat</span>, [<span class="hljs-number">1</span>]],  <span class="hljs-comment"># cat backbone P4</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">512</span>, <span class="hljs-literal">False</span>]],  <span class="hljs-comment"># 13</span><br><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">256</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]],<br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">nn.Upsample</span>, [<span class="hljs-string">None</span>, <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;nearest&#x27;</span>]],<br>   [[<span class="hljs-number">-1</span>, <span class="hljs-number">4</span>], <span class="hljs-number">1</span>, <span class="hljs-string">Concat</span>, [<span class="hljs-number">1</span>]],  <span class="hljs-comment"># cat backbone P3</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">256</span>, <span class="hljs-literal">False</span>]],  <span class="hljs-comment"># 17 (P3/8-small)</span><br><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]],<br>   [[<span class="hljs-number">-1</span>, <span class="hljs-number">14</span>], <span class="hljs-number">1</span>, <span class="hljs-string">Concat</span>, [<span class="hljs-number">1</span>]],  <span class="hljs-comment"># cat head P4</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">512</span>, <span class="hljs-literal">False</span>]],  <span class="hljs-comment"># 20 (P4/16-medium)</span><br><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]],<br>   [[<span class="hljs-number">-1</span>, <span class="hljs-number">10</span>], <span class="hljs-number">1</span>, <span class="hljs-string">Concat</span>, [<span class="hljs-number">1</span>]],  <span class="hljs-comment"># cat head P5</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">1024</span>, <span class="hljs-literal">False</span>]],  <span class="hljs-comment"># 23 (P5/32-large)</span><br><br>   [[<span class="hljs-number">17</span>, <span class="hljs-number">20</span>, <span class="hljs-number">23</span>], <span class="hljs-number">1</span>, <span class="hljs-string">Detect</span>, [<span class="hljs-string">nc</span>, <span class="hljs-string">anchors</span>]],  <span class="hljs-comment"># Detect(P3, P4, P5)</span><br>  ]<br><br></code></pre></div></td></tr></table></figure><h1 id="yolo.py">yolo.py</h1><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># é¡¹ç›®åœ°å€ä¿å­˜</span><br>FILE = Path(__file__).resolve()<br>ROOT = FILE.parents[<span class="hljs-number">1</span>]  <span class="hljs-comment"># YOLOv5 root directory</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(ROOT) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> sys.path:<br>    sys.path.append(<span class="hljs-built_in">str</span>(ROOT))  <span class="hljs-comment"># add ROOT to PATH</span><br><span class="hljs-keyword">if</span> platform.system() != <span class="hljs-string">&#x27;Windows&#x27;</span>:<br>    ROOT = Path(os.path.relpath(ROOT, Path.cwd()))  <span class="hljs-comment"># relative</span><br>    <br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Detect</span>(nn.Module):<br>    stride = <span class="hljs-literal">None</span>  <span class="hljs-comment"># strides computed during build</span><br>    onnx_dynamic = <span class="hljs-literal">False</span>  <span class="hljs-comment"># ONNX export parameter</span><br>    export = <span class="hljs-literal">False</span>  <span class="hljs-comment"># export mode</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, nc=<span class="hljs-number">80</span>, anchors=(<span class="hljs-params"></span>), ch=(<span class="hljs-params"></span>), inplace=<span class="hljs-literal">True</span></span>):  <span class="hljs-comment"># detection layer</span><br>        <span class="hljs-built_in">super</span>().__init__()<br>        self.nc = nc  <span class="hljs-comment"># number of classes</span><br>        self.no = nc + <span class="hljs-number">5</span>  <span class="hljs-comment"># number of outputs per anchor</span><br>        self.nl = <span class="hljs-built_in">len</span>(anchors)  <span class="hljs-comment"># number of detection layers</span><br>        self.na = <span class="hljs-built_in">len</span>(anchors[<span class="hljs-number">0</span>]) // <span class="hljs-number">2</span>  <span class="hljs-comment"># number of anchors</span><br>        self.grid = [torch.zeros(<span class="hljs-number">1</span>)] * self.nl  <span class="hljs-comment"># init grid</span><br>        self.anchor_grid = [torch.zeros(<span class="hljs-number">1</span>)] * self.nl  <span class="hljs-comment"># init anchor grid</span><br>        self.register_buffer(<span class="hljs-string">&#x27;anchors&#x27;</span>, torch.tensor(anchors).<span class="hljs-built_in">float</span>().view(self.nl, -<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))  <span class="hljs-comment"># shape(nl,na,2)</span><br>        self.m = nn.ModuleList(nn.Conv2d(x, self.no * self.na, <span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ch)  <span class="hljs-comment"># output conv</span><br>        self.inplace = inplace  <span class="hljs-comment"># use in-place ops (e.g. slice assignment)</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        z = []  <span class="hljs-comment"># inference output</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.nl):<br>            x[i] = self.m[i](x[i])  <span class="hljs-comment"># conv</span><br>            bs, _, ny, nx = x[i].shape  <span class="hljs-comment"># x(bs,255,20,20) to x(bs,3,20,20,85)</span><br>            <span class="hljs-comment"># permute()ç”¨äºtensorçš„è¡Œåˆ—è¿›è¡Œäº¤æ¢</span><br>            <span class="hljs-comment"># contiguous()ä¸åœ¨å…ƒæ•°æ®ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œä¼šè¿›è¡Œæ·±æ‹·è´</span><br>            x[i] = x[i].view(bs, self.na, self.no, ny, nx).permute(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>).contiguous()<br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.training:  <span class="hljs-comment"># inference</span><br>                <span class="hljs-keyword">if</span> self.onnx_dynamic <span class="hljs-keyword">or</span> self.grid[i].shape[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] != x[i].shape[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>]:<br>                    self.grid[i], self.anchor_grid[i] = self._make_grid(nx, ny, i)<br><br>                y = x[i].sigmoid()<br>                <span class="hljs-keyword">if</span> self.inplace:<br>                    y[..., <span class="hljs-number">0</span>:<span class="hljs-number">2</span>] = (y[..., <span class="hljs-number">0</span>:<span class="hljs-number">2</span>] * <span class="hljs-number">2</span> + self.grid[i]) * self.stride[i]  <span class="hljs-comment"># xy</span><br>                    y[..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>] = (y[..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>] * <span class="hljs-number">2</span>) ** <span class="hljs-number">2</span> * self.anchor_grid[i]  <span class="hljs-comment"># wh</span><br>                <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># for YOLOv5 on AWS Inferentia https://github.com/ultralytics/yolov5/pull/2953</span><br>                    xy, wh, conf = y.split((<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, self.nc + <span class="hljs-number">1</span>), <span class="hljs-number">4</span>)  <span class="hljs-comment"># y.tensor_split((2, 4, 5), 4)  # torch 1.8.0</span><br>                    xy = (xy * <span class="hljs-number">2</span> + self.grid[i]) * self.stride[i]  <span class="hljs-comment"># xy</span><br>                    wh = (wh * <span class="hljs-number">2</span>) ** <span class="hljs-number">2</span> * self.anchor_grid[i]  <span class="hljs-comment"># wh</span><br>                    y = torch.cat((xy, wh, conf), <span class="hljs-number">4</span>)<br>                z.append(y.view(bs, -<span class="hljs-number">1</span>, self.no))<br><br>        <span class="hljs-keyword">return</span> x <span class="hljs-keyword">if</span> self.training <span class="hljs-keyword">else</span> (torch.cat(z, <span class="hljs-number">1</span>),) <span class="hljs-keyword">if</span> self.export <span class="hljs-keyword">else</span> (torch.cat(z, <span class="hljs-number">1</span>), x)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_make_grid</span>(<span class="hljs-params">self, nx=<span class="hljs-number">20</span>, ny=<span class="hljs-number">20</span>, i=<span class="hljs-number">0</span></span>):<br>        d = self.anchors[i].device<br>        t = self.anchors[i].dtype<br>        shape = <span class="hljs-number">1</span>, self.na, ny, nx, <span class="hljs-number">2</span>  <span class="hljs-comment"># grid shape</span><br>        <span class="hljs-comment"># arange()ç”¨äºç”Ÿæˆå¼ é‡</span><br>        y, x = torch.arange(ny, device=d, dtype=t), torch.arange(nx, device=d, dtype=t)<br>        <span class="hljs-keyword">if</span> check_version(torch.__version__, <span class="hljs-string">&#x27;1.10.0&#x27;</span>):  <span class="hljs-comment"># torch&gt;=1.10.0 meshgrid workaround for torch&gt;=0.7 compatibility</span><br>            <span class="hljs-comment"># meshgrid()ç”¨äºç”Ÿæˆç½‘æ ¼ï¼Œå¯ç”¨äºç”Ÿæˆåæ ‡ï¼Œè¡Œæ•°ä¸ºç¬¬ä¸€ä¸ªå¼ é‡çš„å…ƒç´ ä¸ªæ•°ï¼Œåˆ—æ•°ä¸ºç¬¬äºŒä¸ªå¼ é‡çš„å…ƒç´ ä¸ªæ•°</span><br>            <span class="hljs-comment"># yv: ny * nx, xv: ny * nx</span><br>            <span class="hljs-comment"># example: y = tensor([1, 2, 3, 4]), x = tensor([5, 6, 7])</span><br>            <span class="hljs-comment"># yv = [[1, 1, 1], </span><br>            <span class="hljs-comment">#       [2, 2, 2], </span><br>            <span class="hljs-comment">#       [3, 3, 3], </span><br>            <span class="hljs-comment">#       [4, 4, 4]]</span><br>            <span class="hljs-comment"># xv = [[5, 6, 7], </span><br>            <span class="hljs-comment">#       [5, 6, 7], </span><br>            <span class="hljs-comment">#       [5, 6, 7], </span><br>            <span class="hljs-comment">#       [5, 6, 7]]</span><br>            yv, xv = torch.meshgrid(y, x, indexing=<span class="hljs-string">&#x27;ij&#x27;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            yv, xv = torch.meshgrid(y, x)<br>        <span class="hljs-comment"># stack()ç”¨äºæ‹¼æ¥å¼ é‡ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæ‹¼æ¥çš„ç»´åº¦</span><br>        <span class="hljs-comment"># expand()ç”¨æ¥æ‰©å±•ç»´åº¦</span><br>        grid = torch.stack((xv, yv), <span class="hljs-number">2</span>).expand(shape) - <span class="hljs-number">0.5</span>  <span class="hljs-comment"># add grid offset, i.e. y = 2.0 * x - 0.5</span><br>        anchor_grid = (self.anchors[i] * self.stride[i]).view((<span class="hljs-number">1</span>, self.na, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)).expand(shape)<br>        <span class="hljs-keyword">return</span> grid, anchor_grid<br>    <br>    <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span>(nn.Module):<br>    <span class="hljs-comment"># YOLOv5 model</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, cfg=<span class="hljs-string">&#x27;yolov5s.yaml&#x27;</span>, ch=<span class="hljs-number">3</span>, nc=<span class="hljs-literal">None</span>, anchors=<span class="hljs-literal">None</span></span>):  <span class="hljs-comment"># model, input channels, number of classes</span><br>        <span class="hljs-built_in">super</span>().__init__()<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(cfg, <span class="hljs-built_in">dict</span>):<br>            self.yaml = cfg  <span class="hljs-comment"># model dict</span><br>        <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># is *.yaml</span><br>            <span class="hljs-keyword">import</span> yaml  <span class="hljs-comment"># for torch hub</span><br>            self.yaml_file = Path(cfg).name<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(cfg, encoding=<span class="hljs-string">&#x27;ascii&#x27;</span>, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>                self.yaml = yaml.safe_load(f)  <span class="hljs-comment"># model dict</span><br><br>        <span class="hljs-comment"># Define model</span><br>        ch = self.yaml[<span class="hljs-string">&#x27;ch&#x27;</span>] = self.yaml.get(<span class="hljs-string">&#x27;ch&#x27;</span>, ch)  <span class="hljs-comment"># input channelsï¼Œå¦‚æœyamlæ–‡ä»¶ä¸­æ²¡æœ‰chï¼Œåˆ™å†™å…¥</span><br>        <span class="hljs-keyword">if</span> nc <span class="hljs-keyword">and</span> nc != self.yaml[<span class="hljs-string">&#x27;nc&#x27;</span>]:<br>            LOGGER.info(<span class="hljs-string">f&quot;Overriding model.yaml nc=<span class="hljs-subst">&#123;self.yaml[<span class="hljs-string">&#x27;nc&#x27;</span>]&#125;</span> with nc=<span class="hljs-subst">&#123;nc&#125;</span>&quot;</span>)<br>            self.yaml[<span class="hljs-string">&#x27;nc&#x27;</span>] = nc  <span class="hljs-comment"># override yaml value</span><br>        <span class="hljs-keyword">if</span> anchors:<br>            LOGGER.info(<span class="hljs-string">f&#x27;Overriding model.yaml anchors with anchors=<span class="hljs-subst">&#123;anchors&#125;</span>&#x27;</span>)<br>            self.yaml[<span class="hljs-string">&#x27;anchors&#x27;</span>] = <span class="hljs-built_in">round</span>(anchors)  <span class="hljs-comment"># override yaml valueï¼Œround()å››èˆäº”å…¥</span><br>        self.model, self.save = parse_model(deepcopy(self.yaml), ch=[ch])  <span class="hljs-comment"># model, savelist</span><br>        self.names = [<span class="hljs-built_in">str</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.yaml[<span class="hljs-string">&#x27;nc&#x27;</span>])]  <span class="hljs-comment"># default names</span><br>        self.inplace = self.yaml.get(<span class="hljs-string">&#x27;inplace&#x27;</span>, <span class="hljs-literal">True</span>)<br><br>        <span class="hljs-comment"># Build strides, anchors</span><br>        m = self.model[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># Detect()</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m, Detect):<br>            s = <span class="hljs-number">256</span>  <span class="hljs-comment"># 2x min stride</span><br>            m.inplace = self.inplace<br>            <span class="hljs-comment"># æ­¥é•¿æœ€åç»“æœä¸º[8, 16, 32]</span><br>            m.stride = torch.tensor([s / x.shape[-<span class="hljs-number">2</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self.forward(torch.zeros(<span class="hljs-number">1</span>, ch, s, s))])  <span class="hljs-comment"># forward</span><br>            <span class="hljs-comment"># æ£€æµ‹anchoré¡ºåºæœ‰æ²¡æœ‰é”™</span><br>            check_anchor_order(m)  <span class="hljs-comment"># must be in pixel-space (not grid-space)</span><br>            <span class="hljs-comment"># anchoréœ€è¦é™¤ä»¥æ­¥é•¿æ¥å¾—åˆ°æœ€åå†ç‰¹å¾å›¾ä¸Šçš„å¤§å°</span><br>            m.anchors /= m.stride.view(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>            self.stride = m.stride<br>            <span class="hljs-comment"># ä¹±ä¸ƒå…«ç³Ÿçš„åˆå§‹åŒ–</span><br>            self._initialize_biases()  <span class="hljs-comment"># only run once</span><br><br>        <span class="hljs-comment"># Init weights, biases</span><br>        initialize_weights(self)<br>        self.info()<br>        LOGGER.info(<span class="hljs-string">&#x27;&#x27;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, augment=<span class="hljs-literal">False</span>, profile=<span class="hljs-literal">False</span>, visualize=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-comment"># åˆ†ä¸ºæ˜¯å¦æ•°æ®å¢å¼ºåçš„å‰å‘ä¼ æ’­</span><br>        <span class="hljs-keyword">if</span> augment:<br>            <span class="hljs-keyword">return</span> self._forward_augment(x)  <span class="hljs-comment"># augmented inference, None</span><br>        <span class="hljs-keyword">return</span> self._forward_once(x, profile, visualize)  <span class="hljs-comment"># single-scale inference, train</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_forward_augment</span>(<span class="hljs-params">self, x</span>):<br>        img_size = x.shape[-<span class="hljs-number">2</span>:]  <span class="hljs-comment"># height, width</span><br>        s = [<span class="hljs-number">1</span>, <span class="hljs-number">0.83</span>, <span class="hljs-number">0.67</span>]  <span class="hljs-comment"># scales</span><br>        f = [<span class="hljs-literal">None</span>, <span class="hljs-number">3</span>, <span class="hljs-literal">None</span>]  <span class="hljs-comment"># flips (2-ud, 3-lr)</span><br>        y = []  <span class="hljs-comment"># outputs</span><br>        <span class="hljs-keyword">for</span> si, fi <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(s, f):<br>            xi = scale_img(x.flip(fi) <span class="hljs-keyword">if</span> fi <span class="hljs-keyword">else</span> x, si, gs=<span class="hljs-built_in">int</span>(self.stride.<span class="hljs-built_in">max</span>()))<br>            yi = self._forward_once(xi)[<span class="hljs-number">0</span>]  <span class="hljs-comment"># forward</span><br>            <span class="hljs-comment"># cv2.imwrite(f&#x27;img_&#123;si&#125;.jpg&#x27;, 255 * xi[0].cpu().numpy().transpose((1, 2, 0))[:, :, ::-1])  # save</span><br>            yi = self._descale_pred(yi, fi, si, img_size)<br>            y.append(yi)<br>        y = self._clip_augmented(y)  <span class="hljs-comment"># clip augmented tails</span><br>        <span class="hljs-keyword">return</span> torch.cat(y, <span class="hljs-number">1</span>), <span class="hljs-literal">None</span>  <span class="hljs-comment"># augmented inference, train</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_forward_once</span>(<span class="hljs-params">self, x, profile=<span class="hljs-literal">False</span>, visualize=<span class="hljs-literal">False</span></span>):<br>        y, dt = [], []  <span class="hljs-comment"># outputs</span><br>        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> self.model:<br>            <span class="hljs-keyword">if</span> m.f != -<span class="hljs-number">1</span>:  <span class="hljs-comment"># if not from previous layer</span><br>                x = y[m.f] <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m.f, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> [x <span class="hljs-keyword">if</span> j == -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> y[j] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> m.f]  <span class="hljs-comment"># from earlier layers</span><br>            <span class="hljs-keyword">if</span> profile:<br>                self._profile_one_layer(m, x, dt)<br>            x = m(x)  <span class="hljs-comment"># run</span><br>            y.append(x <span class="hljs-keyword">if</span> m.i <span class="hljs-keyword">in</span> self.save <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>)  <span class="hljs-comment"># save output</span><br>            <span class="hljs-keyword">if</span> visualize:<br>                feature_visualization(x, m.<span class="hljs-built_in">type</span>, m.i, save_dir=visualize)<br>        <span class="hljs-keyword">return</span> x<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_descale_pred</span>(<span class="hljs-params">self, p, flips, scale, img_size</span>):<br>        <span class="hljs-comment"># de-scale predictions following augmented inference (inverse operation)</span><br>        <span class="hljs-keyword">if</span> self.inplace:<br>            p[..., :<span class="hljs-number">4</span>] /= scale  <span class="hljs-comment"># de-scale</span><br>            <span class="hljs-keyword">if</span> flips == <span class="hljs-number">2</span>:<br>                p[..., <span class="hljs-number">1</span>] = img_size[<span class="hljs-number">0</span>] - p[..., <span class="hljs-number">1</span>]  <span class="hljs-comment"># de-flip ud</span><br>            <span class="hljs-keyword">elif</span> flips == <span class="hljs-number">3</span>:<br>                p[..., <span class="hljs-number">0</span>] = img_size[<span class="hljs-number">1</span>] - p[..., <span class="hljs-number">0</span>]  <span class="hljs-comment"># de-flip lr</span><br>        <span class="hljs-keyword">else</span>:<br>            x, y, wh = p[..., <span class="hljs-number">0</span>:<span class="hljs-number">1</span>] / scale, p[..., <span class="hljs-number">1</span>:<span class="hljs-number">2</span>] / scale, p[..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>] / scale  <span class="hljs-comment"># de-scale</span><br>            <span class="hljs-keyword">if</span> flips == <span class="hljs-number">2</span>:<br>                y = img_size[<span class="hljs-number">0</span>] - y  <span class="hljs-comment"># de-flip ud</span><br>            <span class="hljs-keyword">elif</span> flips == <span class="hljs-number">3</span>:<br>                x = img_size[<span class="hljs-number">1</span>] - x  <span class="hljs-comment"># de-flip lr</span><br>            p = torch.cat((x, y, wh, p[..., <span class="hljs-number">4</span>:]), -<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> p<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_clip_augmented</span>(<span class="hljs-params">self, y</span>):<br>        <span class="hljs-comment"># Clip YOLOv5 augmented inference tails</span><br>        nl = self.model[-<span class="hljs-number">1</span>].nl  <span class="hljs-comment"># number of detection layers (P3-P5)</span><br>        g = <span class="hljs-built_in">sum</span>(<span class="hljs-number">4</span> ** x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(nl))  <span class="hljs-comment"># grid points</span><br>        e = <span class="hljs-number">1</span>  <span class="hljs-comment"># exclude layer count</span><br>        i = (y[<span class="hljs-number">0</span>].shape[<span class="hljs-number">1</span>] // g) * <span class="hljs-built_in">sum</span>(<span class="hljs-number">4</span> ** x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(e))  <span class="hljs-comment"># indices</span><br>        y[<span class="hljs-number">0</span>] = y[<span class="hljs-number">0</span>][:, :-i]  <span class="hljs-comment"># large</span><br>        i = (y[-<span class="hljs-number">1</span>].shape[<span class="hljs-number">1</span>] // g) * <span class="hljs-built_in">sum</span>(<span class="hljs-number">4</span> ** (nl - <span class="hljs-number">1</span> - x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(e))  <span class="hljs-comment"># indices</span><br>        y[-<span class="hljs-number">1</span>] = y[-<span class="hljs-number">1</span>][:, i:]  <span class="hljs-comment"># small</span><br>        <span class="hljs-keyword">return</span> y<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_profile_one_layer</span>(<span class="hljs-params">self, m, x, dt</span>):<br>        c = <span class="hljs-built_in">isinstance</span>(m, Detect)  <span class="hljs-comment"># is final layer, copy input as inplace fix</span><br>        o = thop.profile(m, inputs=(x.copy() <span class="hljs-keyword">if</span> c <span class="hljs-keyword">else</span> x,), verbose=<span class="hljs-literal">False</span>)[<span class="hljs-number">0</span>] / <span class="hljs-number">1E9</span> * <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> thop <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>  <span class="hljs-comment"># FLOPs</span><br>        t = time_sync()<br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>            m(x.copy() <span class="hljs-keyword">if</span> c <span class="hljs-keyword">else</span> x)<br>        dt.append((time_sync() - t) * <span class="hljs-number">100</span>)<br>        <span class="hljs-keyword">if</span> m == self.model[<span class="hljs-number">0</span>]:<br>            LOGGER.info(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;time (ms)&#x27;</span>:&gt;10s&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;GFLOPs&#x27;</span>:&gt;10s&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;params&#x27;</span>:&gt;10s&#125;</span>  <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;module&#x27;</span>&#125;</span>&quot;</span>)<br>        LOGGER.info(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;dt[-<span class="hljs-number">1</span>]:<span class="hljs-number">10.2</span>f&#125;</span> <span class="hljs-subst">&#123;o:<span class="hljs-number">10.2</span>f&#125;</span> <span class="hljs-subst">&#123;m.np:<span class="hljs-number">10.0</span>f&#125;</span>  <span class="hljs-subst">&#123;m.<span class="hljs-built_in">type</span>&#125;</span>&#x27;</span>)<br>        <span class="hljs-keyword">if</span> c:<br>            LOGGER.info(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">sum</span>(dt):<span class="hljs-number">10.2</span>f&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;-&#x27;</span>:&gt;10s&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;-&#x27;</span>:&gt;10s&#125;</span>  Total&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_initialize_biases</span>(<span class="hljs-params">self, cf=<span class="hljs-literal">None</span></span>):  <span class="hljs-comment"># initialize biases into Detect(), cf is class frequency</span><br>        <span class="hljs-comment"># https://arxiv.org/abs/1708.02002 section 3.3</span><br>        <span class="hljs-comment"># cf = torch.bincount(torch.tensor(np.concatenate(dataset.labels, 0)[:, 0]).long(), minlength=nc) + 1.</span><br>        m = self.model[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># Detect() module</span><br>        <span class="hljs-keyword">for</span> mi, s <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(m.m, m.stride):  <span class="hljs-comment"># from</span><br>            b = mi.bias.view(m.na, -<span class="hljs-number">1</span>)  <span class="hljs-comment"># conv.bias(255) to (3,85)</span><br>            b.data[:, <span class="hljs-number">4</span>] += math.log(<span class="hljs-number">8</span> / (<span class="hljs-number">640</span> / s) ** <span class="hljs-number">2</span>)  <span class="hljs-comment"># obj (8 objects per 640 image)</span><br>            b.data[:, <span class="hljs-number">5</span>:] += math.log(<span class="hljs-number">0.6</span> / (m.nc - <span class="hljs-number">0.999999</span>)) <span class="hljs-keyword">if</span> cf <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> torch.log(cf / cf.<span class="hljs-built_in">sum</span>())  <span class="hljs-comment"># cls</span><br>            mi.bias = torch.nn.Parameter(b.view(-<span class="hljs-number">1</span>), requires_grad=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_print_biases</span>(<span class="hljs-params">self</span>):<br>        m = self.model[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># Detect() module</span><br>        <span class="hljs-keyword">for</span> mi <span class="hljs-keyword">in</span> m.m:  <span class="hljs-comment"># from</span><br>            b = mi.bias.detach().view(m.na, -<span class="hljs-number">1</span>).T  <span class="hljs-comment"># conv.bias(255) to (3,85)</span><br>            LOGGER.info(<br>                (<span class="hljs-string">&#x27;%6g Conv2d.bias:&#x27;</span> + <span class="hljs-string">&#x27;%10.3g&#x27;</span> * <span class="hljs-number">6</span>) % (mi.weight.shape[<span class="hljs-number">1</span>], *b[:<span class="hljs-number">5</span>].mean(<span class="hljs-number">1</span>).tolist(), b[<span class="hljs-number">5</span>:].mean()))<br><br>    <span class="hljs-comment"># def _print_weights(self):</span><br>    <span class="hljs-comment">#     for m in self.model.modules():</span><br>    <span class="hljs-comment">#         if type(m) is Bottleneck:</span><br>    <span class="hljs-comment">#             LOGGER.info(&#x27;%10.3g&#x27; % (m.w.detach().sigmoid() * 2))  # shortcut weights</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fuse</span>(<span class="hljs-params">self</span>):  <span class="hljs-comment"># fuse model Conv2d() + BatchNorm2d() layers</span><br>        LOGGER.info(<span class="hljs-string">&#x27;Fusing layers... &#x27;</span>)<br>        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> self.model.modules():<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m, (Conv, DWConv)) <span class="hljs-keyword">and</span> <span class="hljs-built_in">hasattr</span>(m, <span class="hljs-string">&#x27;bn&#x27;</span>):<br>                m.conv = fuse_conv_and_bn(m.conv, m.bn)  <span class="hljs-comment"># update conv</span><br>                <span class="hljs-built_in">delattr</span>(m, <span class="hljs-string">&#x27;bn&#x27;</span>)  <span class="hljs-comment"># remove batchnorm</span><br>                m.forward = m.forward_fuse  <span class="hljs-comment"># update forward</span><br>        self.info()<br>        <span class="hljs-keyword">return</span> self<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">info</span>(<span class="hljs-params">self, verbose=<span class="hljs-literal">False</span>, img_size=<span class="hljs-number">640</span></span>):  <span class="hljs-comment"># print model information</span><br>        model_info(self, verbose, img_size)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_apply</span>(<span class="hljs-params">self, fn</span>):<br>        <span class="hljs-comment"># Apply to(), cpu(), cuda(), half() to model tensors that are not parameters or registered buffers</span><br>        self = <span class="hljs-built_in">super</span>()._apply(fn)<br>        m = self.model[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># Detect()</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m, Detect):<br>            m.stride = fn(m.stride)<br>            m.grid = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(fn, m.grid))<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m.anchor_grid, <span class="hljs-built_in">list</span>):<br>                m.anchor_grid = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(fn, m.anchor_grid))<br>        <span class="hljs-keyword">return</span> self<br>    <br>    <br><span class="hljs-comment"># è§£ææ¨¡å‹ï¼Œè¿”å›yamlä¸­æ‰€å±•ç¤ºçš„æ¨¡å‹ï¼Œsavelist</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_model</span>(<span class="hljs-params">d, ch</span>):  <span class="hljs-comment"># model_dict, input_channels(3)</span><br>    LOGGER.info(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;&#x27;</span>:&gt;<span class="hljs-number">3</span>&#125;</span><span class="hljs-subst">&#123;<span class="hljs-string">&#x27;from&#x27;</span>:&gt;<span class="hljs-number">18</span>&#125;</span><span class="hljs-subst">&#123;<span class="hljs-string">&#x27;n&#x27;</span>:&gt;<span class="hljs-number">3</span>&#125;</span><span class="hljs-subst">&#123;<span class="hljs-string">&#x27;params&#x27;</span>:&gt;<span class="hljs-number">10</span>&#125;</span>  <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;module&#x27;</span>:&lt;<span class="hljs-number">40</span>&#125;</span><span class="hljs-subst">&#123;<span class="hljs-string">&#x27;arguments&#x27;</span>:&lt;<span class="hljs-number">30</span>&#125;</span>&quot;</span>)<br>    anchors, nc, gd, gw = d[<span class="hljs-string">&#x27;anchors&#x27;</span>], d[<span class="hljs-string">&#x27;nc&#x27;</span>], d[<span class="hljs-string">&#x27;depth_multiple&#x27;</span>], d[<span class="hljs-string">&#x27;width_multiple&#x27;</span>]<br>    na = (<span class="hljs-built_in">len</span>(anchors[<span class="hljs-number">0</span>]) // <span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(anchors, <span class="hljs-built_in">list</span>) <span class="hljs-keyword">else</span> anchors  <span class="hljs-comment"># number of anchors</span><br>    no = na * (nc + <span class="hljs-number">5</span>)  <span class="hljs-comment"># number of outputs = anchors * (classes + 5)</span><br><br>    layers, save, c2 = [], [], ch[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># layers, savelist, ch out</span><br>    <span class="hljs-comment"># å¼€å§‹è¯»å…¥backboneå’Œheadçš„æ¨¡å‹å‚æ•°</span><br>    <span class="hljs-keyword">for</span> i, (f, n, m, args) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(d[<span class="hljs-string">&#x27;backbone&#x27;</span>] + d[<span class="hljs-string">&#x27;head&#x27;</span>]):  <span class="hljs-comment"># from, number, module, args</span><br>        m = <span class="hljs-built_in">eval</span>(m) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> m  <span class="hljs-comment"># eval strings</span><br>        <span class="hljs-keyword">for</span> j, a <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(args):<br>            <span class="hljs-keyword">try</span>:<br>                args[j] = <span class="hljs-built_in">eval</span>(a) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(a, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> a  <span class="hljs-comment"># eval strings</span><br>            <span class="hljs-keyword">except</span> NameError:<br>                <span class="hljs-keyword">pass</span><br><br>        n = n_ = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">round</span>(n * gd), <span class="hljs-number">1</span>) <span class="hljs-keyword">if</span> n &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> n  <span class="hljs-comment"># depth gainï¼Œæ ¹æ®æ¨¡å‹å¤§å°æ¥å°†moduleæ•°é‡ä¹˜ä»¥depth_multiple</span><br>        <span class="hljs-keyword">if</span> m <span class="hljs-keyword">in</span> (Conv, GhostConv, Bottleneck, GhostBottleneck, SPP, SPPF, DWConv, MixConv2d, Focus, CrossConv,<br>                 BottleneckCSP, C3, C3TR, C3SPP, C3Ghost):<br>            c1, c2 = ch[f], args[<span class="hljs-number">0</span>]<span class="hljs-comment"># c1ä¸ºè¾“å…¥é€šé“æ•°ï¼Œc2ä¸ºè¾“å‡º</span><br>            <span class="hljs-keyword">if</span> c2 != no:  <span class="hljs-comment"># if not output</span><br>                <span class="hljs-comment"># make_divisibleä¸­è¿”å›math.ceil(c2 * gw / 8) * 8</span><br>                <span class="hljs-comment"># ä¸ºäº†ä½¿é€šé“æ•°ä¸º8çš„å€æ•°</span><br>                c2 = make_divisible(c2 * gw, <span class="hljs-number">8</span>)<br><span class="hljs-comment"># argsçš„åˆ—è¡¨ä¸º[è¾“å…¥é€šé“æ•°ï¼Œè¾“å‡ºé€šé“æ•°ï¼Œyamlæ–‡ä»¶ä¸­åé¢çš„å‚æ•°]</span><br>            args = [c1, c2, *args[<span class="hljs-number">1</span>:]]<br>            <span class="hljs-comment"># å¦‚æœmoduleä¸ºä¸‹é¢è¿™äº›moduleï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸‰ä½æ”¾å…¥éœ€è¦å¾ªç¯çš„æ•°é‡n</span><br>            <span class="hljs-keyword">if</span> m <span class="hljs-keyword">in</span> [BottleneckCSP, C3, C3TR, C3Ghost]:<br>                args.insert(<span class="hljs-number">2</span>, n)  <span class="hljs-comment"># number of repeats</span><br>                n = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">elif</span> m <span class="hljs-keyword">is</span> nn.BatchNorm2d:<br>            <span class="hljs-comment"># å¦‚æœmæ˜¯BatchNorm2dï¼Œé‚£ä¹ˆå‚æ•°å°±ä¸ºä¸Šä¸€ä¸ªmoduleçš„è¾“å‡ºé€šé“æ•°</span><br>            args = [ch[f]]<br>        <span class="hljs-keyword">elif</span> m <span class="hljs-keyword">is</span> Concat:<br>            <span class="hljs-comment"># å¦‚æœmæ˜¯Concatï¼Œé‚£ä¹ˆè¾“å‡ºé€šé“æ•°c2å°±ä¸ºæ¥çš„å‡ ä¸ªmoduleçš„è¾“å‡ºé€šé“æ•°ä¹‹å’Œ</span><br>            c2 = <span class="hljs-built_in">sum</span>(ch[x] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> f)<br>        <span class="hljs-keyword">elif</span> m <span class="hljs-keyword">is</span> Detect:<br>            <span class="hljs-comment"># å¦‚æœmæ˜¯Detectï¼Œé‚£ä¹ˆå‚æ•°å°±åŠ ä¸Šä¸ºæ¥çš„å‡ ä¸ªmoduleçš„è¾“å‡ºé€šé“æ•°çš„åˆ—è¡¨</span><br>            args.append([ch[x] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> f])<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(args[<span class="hljs-number">1</span>], <span class="hljs-built_in">int</span>):  <span class="hljs-comment"># number of anchors</span><br>                args[<span class="hljs-number">1</span>] = [<span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(args[<span class="hljs-number">1</span>] * <span class="hljs-number">2</span>))] * <span class="hljs-built_in">len</span>(f)<br>        <span class="hljs-keyword">elif</span> m <span class="hljs-keyword">is</span> Contract:<br>            c2 = ch[f] * args[<span class="hljs-number">0</span>] ** <span class="hljs-number">2</span><br>        <span class="hljs-keyword">elif</span> m <span class="hljs-keyword">is</span> Expand:<br>            c2 = ch[f] // args[<span class="hljs-number">0</span>] ** <span class="hljs-number">2</span><br>        <span class="hljs-keyword">else</span>:<br>            c2 = ch[f]<br><br>        <span class="hljs-comment"># å°†yamlçš„moduleæ·»åŠ åˆ°nn.Sequentialä¸­</span><br>        m_ = nn.Sequential(*(m(*args) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n))) <span class="hljs-keyword">if</span> n &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> m(*args)  <span class="hljs-comment"># module</span><br>        t = <span class="hljs-built_in">str</span>(m)[<span class="hljs-number">8</span>:-<span class="hljs-number">2</span>].replace(<span class="hljs-string">&#x27;__main__.&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)  <span class="hljs-comment"># module type</span><br>        np = <span class="hljs-built_in">sum</span>(x.numel() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> m_.parameters())  <span class="hljs-comment"># number params</span><br>        m_.i, m_.f, m_.<span class="hljs-built_in">type</span>, m_.np = i, f, t, np  <span class="hljs-comment"># attach index, &#x27;from&#x27; index, type, number params</span><br>        LOGGER.info(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;i:&gt;<span class="hljs-number">3</span>&#125;</span><span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(f):&gt;<span class="hljs-number">18</span>&#125;</span><span class="hljs-subst">&#123;n_:&gt;<span class="hljs-number">3</span>&#125;</span><span class="hljs-subst">&#123;np:<span class="hljs-number">10.0</span>f&#125;</span>  <span class="hljs-subst">&#123;t:&lt;<span class="hljs-number">40</span>&#125;</span><span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(args):&lt;<span class="hljs-number">30</span>&#125;</span>&#x27;</span>)  <span class="hljs-comment"># print</span><br>        save.extend(x % i <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ([f] <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(f, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> f) <span class="hljs-keyword">if</span> x != -<span class="hljs-number">1</span>)  <span class="hljs-comment"># append to savelist</span><br>        layers.append(m_)<span class="hljs-comment"># layeråˆ—è¡¨ä¸­æ·»åŠ æ­¤æ—¶éå†çš„module</span><br>        <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span>:<span class="hljs-comment"># å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªmoduleï¼Œå…ˆæ¸…ç©ºchåˆ—è¡¨</span><br>            ch = []<br>        ch.append(c2)<span class="hljs-comment"># åœ¨chä¸­æ·»åŠ è¾“å‡ºé€šé“æ•°</span><br>    <span class="hljs-keyword">return</span> nn.Sequential(*layers), <span class="hljs-built_in">sorted</span>(save)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    parser = argparse.ArgumentParser()<br>    parser.add_argument(<span class="hljs-string">&#x27;--cfg&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-string">&#x27;yolov5s.yaml&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;model.yaml&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;--batch-size&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">1</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;total batch size for all GPUs&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;--device&#x27;</span>, default=<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;cuda device, i.e. 0 or 0,1,2,3 or cpu&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;--profile&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;profile model speed&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;--line-profile&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;profile model speed layer by layer&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;--test&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;test all yolo*.yaml&#x27;</span>)<br>    opt = parser.parse_args()<br>    opt.cfg = check_yaml(opt.cfg)  <span class="hljs-comment"># check YAML</span><br>    print_args(<span class="hljs-built_in">vars</span>(opt))<br>    device = select_device(opt.device)<br><br>    <span class="hljs-comment"># Create model</span><br>    im = torch.rand(opt.batch_size, <span class="hljs-number">3</span>, <span class="hljs-number">640</span>, <span class="hljs-number">640</span>).to(device)<br>    model = Model(opt.cfg).to(device)<br><br>    <span class="hljs-comment"># Options</span><br>    <span class="hljs-keyword">if</span> opt.line_profile:  <span class="hljs-comment"># profile layer by layer</span><br>        _ = model(im, profile=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-keyword">elif</span> opt.profile:  <span class="hljs-comment"># profile forward-backward</span><br>        results = profile(<span class="hljs-built_in">input</span>=im, ops=[model], n=<span class="hljs-number">3</span>)<br><br>    <span class="hljs-keyword">elif</span> opt.test:  <span class="hljs-comment"># test all models</span><br>        <span class="hljs-keyword">for</span> cfg <span class="hljs-keyword">in</span> Path(ROOT / <span class="hljs-string">&#x27;models&#x27;</span>).rglob(<span class="hljs-string">&#x27;yolo*.yaml&#x27;</span>):<br>            <span class="hljs-keyword">try</span>:<br>                _ = Model(cfg)<br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Error in <span class="hljs-subst">&#123;cfg&#125;</span>: <span class="hljs-subst">&#123;e&#125;</span>&#x27;</span>)<br></code></pre></div></td></tr></table></figure><h1 id="train.py">train.py</h1><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># è¯»å–æ–‡ä»¶åœ°å€</span><br>FILE = Path(__file__).resolve()<br>ROOT = FILE.parents[<span class="hljs-number">0</span>]  <span class="hljs-comment"># YOLOv5 root directory</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(ROOT) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> sys.path:<br>    sys.path.append(<span class="hljs-built_in">str</span>(ROOT))  <span class="hljs-comment"># add ROOT to PATH</span><br>ROOT = Path(os.path.relpath(ROOT, Path.cwd()))  <span class="hljs-comment"># relative</span><br><br><span class="hljs-comment"># ç”¨äºå¤šGPUè®­ç»ƒ</span><br><span class="hljs-comment"># rankä»£è¡¨è¿›ç¨‹åºå·ï¼Œlocal_rankä»£è¡¨gpu</span><br>LOCAL_RANK = <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">&#x27;LOCAL_RANK&#x27;</span>, -<span class="hljs-number">1</span>))  <span class="hljs-comment"># https://pytorch.org/docs/stable/elastic/run.html</span><br>RANK = <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">&#x27;RANK&#x27;</span>, -<span class="hljs-number">1</span>))<br><span class="hljs-comment"># world_sizeä»£è¡¨æœ‰å¤šå°‘è¿›ç¨‹</span><br>WORLD_SIZE = <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">&#x27;WORLD_SIZE&#x27;</span>, <span class="hljs-number">1</span>))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">hyp, opt, device, callbacks</span>):  <span class="hljs-comment"># hyp is path/to/hyp.yaml or hyp dictionary</span><br>    save_dir, epochs, batch_size, weights, single_cls, evolve, data, cfg, resume, noval, nosave, workers, freeze = \<br>        Path(opt.save_dir), opt.epochs, opt.batch_size, opt.weights, opt.single_cls, opt.evolve, opt.data, opt.cfg, \<br>        opt.resume, opt.noval, opt.nosave, opt.workers, opt.freeze<br>    callbacks.run(<span class="hljs-string">&#x27;on_pretrain_routine_start&#x27;</span>)<br><br>    <span class="hljs-comment"># Directories</span><br>    w = save_dir / <span class="hljs-string">&#x27;weights&#x27;</span>  <span class="hljs-comment"># weights dir</span><br>    (w.parent <span class="hljs-keyword">if</span> evolve <span class="hljs-keyword">else</span> w).mkdir(parents=<span class="hljs-literal">True</span>, exist_ok=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># make dir</span><br>    last, best = w / <span class="hljs-string">&#x27;last.pt&#x27;</span>, w / <span class="hljs-string">&#x27;best.pt&#x27;</span><br><br>    <span class="hljs-comment"># Hyperparameters</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(hyp, <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(hyp, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            hyp = yaml.safe_load(f)  <span class="hljs-comment"># load hyps dict</span><br>    LOGGER.info(colorstr(<span class="hljs-string">&#x27;hyperparameters: &#x27;</span>) + <span class="hljs-string">&#x27;, &#x27;</span>.join(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;k&#125;</span>=<span class="hljs-subst">&#123;v&#125;</span>&#x27;</span> <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> hyp.items()))<br><br>    <span class="hljs-comment"># Save run settings</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> evolve:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(save_dir / <span class="hljs-string">&#x27;hyp.yaml&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            yaml.safe_dump(hyp, f, sort_keys=<span class="hljs-literal">False</span>)<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(save_dir / <span class="hljs-string">&#x27;opt.yaml&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            yaml.safe_dump(<span class="hljs-built_in">vars</span>(opt), f, sort_keys=<span class="hljs-literal">False</span>)<br><br>    <span class="hljs-comment"># Loggers</span><br>    data_dict = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> [-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]:<br>        loggers = Loggers(save_dir, weights, opt, hyp, LOGGER)  <span class="hljs-comment"># loggers instance</span><br>        <span class="hljs-keyword">if</span> loggers.wandb:<br>            data_dict = loggers.wandb.data_dict<br>            <span class="hljs-keyword">if</span> resume:<br>                weights, epochs, hyp, batch_size = opt.weights, opt.epochs, opt.hyp, opt.batch_size<br><br>        <span class="hljs-comment"># Register actions</span><br>        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> methods(loggers):<br>            callbacks.register_action(k, callback=<span class="hljs-built_in">getattr</span>(loggers, k))<br><br>    <span class="hljs-comment"># Config</span><br>    plots = <span class="hljs-keyword">not</span> evolve <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> opt.noplots  <span class="hljs-comment"># create plots</span><br>    cuda = device.<span class="hljs-built_in">type</span> != <span class="hljs-string">&#x27;cpu&#x27;</span><br>    init_seeds(<span class="hljs-number">1</span> + RANK)<br>    <span class="hljs-keyword">with</span> torch_distributed_zero_first(LOCAL_RANK):<br>        data_dict = data_dict <span class="hljs-keyword">or</span> check_dataset(data)  <span class="hljs-comment"># check if None</span><br>    train_path, val_path = data_dict[<span class="hljs-string">&#x27;train&#x27;</span>], data_dict[<span class="hljs-string">&#x27;val&#x27;</span>]<br>    nc = <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> single_cls <span class="hljs-keyword">else</span> <span class="hljs-built_in">int</span>(data_dict[<span class="hljs-string">&#x27;nc&#x27;</span>])  <span class="hljs-comment"># number of classes</span><br>    names = [<span class="hljs-string">&#x27;item&#x27;</span>] <span class="hljs-keyword">if</span> single_cls <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(data_dict[<span class="hljs-string">&#x27;names&#x27;</span>]) != <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> data_dict[<span class="hljs-string">&#x27;names&#x27;</span>]  <span class="hljs-comment"># class names</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(names) == nc, <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(names)&#125;</span> names found for nc=<span class="hljs-subst">&#123;nc&#125;</span> dataset in <span class="hljs-subst">&#123;data&#125;</span>&#x27;</span>  <span class="hljs-comment"># check</span><br>    is_coco = <span class="hljs-built_in">isinstance</span>(val_path, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">and</span> val_path.endswith(<span class="hljs-string">&#x27;coco/val2017.txt&#x27;</span>)  <span class="hljs-comment"># COCO dataset</span><br><br>    <span class="hljs-comment"># Model</span><br>    check_suffix(weights, <span class="hljs-string">&#x27;.pt&#x27;</span>)  <span class="hljs-comment"># check weights</span><br>    pretrained = weights.endswith(<span class="hljs-string">&#x27;.pt&#x27;</span>)<br>    <span class="hljs-keyword">if</span> pretrained:<br>        <span class="hljs-keyword">with</span> torch_distributed_zero_first(LOCAL_RANK):<br>            weights = attempt_download(weights)  <span class="hljs-comment"># download if not found locally</span><br>        ckpt = torch.load(weights, map_location=<span class="hljs-string">&#x27;cpu&#x27;</span>)  <span class="hljs-comment"># load checkpoint to CPU to avoid CUDA memory leak</span><br>        model = Model(cfg <span class="hljs-keyword">or</span> ckpt[<span class="hljs-string">&#x27;model&#x27;</span>].yaml, ch=<span class="hljs-number">3</span>, nc=nc, anchors=hyp.get(<span class="hljs-string">&#x27;anchors&#x27;</span>)).to(device)  <span class="hljs-comment"># create</span><br>        exclude = [<span class="hljs-string">&#x27;anchor&#x27;</span>] <span class="hljs-keyword">if</span> (cfg <span class="hljs-keyword">or</span> hyp.get(<span class="hljs-string">&#x27;anchors&#x27;</span>)) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> resume <span class="hljs-keyword">else</span> []  <span class="hljs-comment"># exclude keys</span><br>        csd = ckpt[<span class="hljs-string">&#x27;model&#x27;</span>].<span class="hljs-built_in">float</span>().state_dict()  <span class="hljs-comment"># checkpoint state_dict as FP32</span><br>        csd = intersect_dicts(csd, model.state_dict(), exclude=exclude)  <span class="hljs-comment"># intersect</span><br>        model.load_state_dict(csd, strict=<span class="hljs-literal">False</span>)  <span class="hljs-comment"># load</span><br>        LOGGER.info(<span class="hljs-string">f&#x27;Transferred <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(csd)&#125;</span>/<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(model.state_dict())&#125;</span> items from <span class="hljs-subst">&#123;weights&#125;</span>&#x27;</span>)  <span class="hljs-comment"># report</span><br>    <span class="hljs-keyword">else</span>:<br>        model = Model(cfg, ch=<span class="hljs-number">3</span>, nc=nc, anchors=hyp.get(<span class="hljs-string">&#x27;anchors&#x27;</span>)).to(device)  <span class="hljs-comment"># create</span><br><br>    <span class="hljs-comment"># Freeze</span><br>    freeze = [<span class="hljs-string">f&#x27;model.<span class="hljs-subst">&#123;x&#125;</span>.&#x27;</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> (freeze <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(freeze) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-built_in">range</span>(freeze[<span class="hljs-number">0</span>]))]  <span class="hljs-comment"># layers to freeze</span><br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> model.named_parameters():<br>        v.requires_grad = <span class="hljs-literal">True</span>  <span class="hljs-comment"># train all layers</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(x <span class="hljs-keyword">in</span> k <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> freeze):<br>            LOGGER.info(<span class="hljs-string">f&#x27;freezing <span class="hljs-subst">&#123;k&#125;</span>&#x27;</span>)<br>            v.requires_grad = <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># Image size</span><br>    gs = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">int</span>(model.stride.<span class="hljs-built_in">max</span>()), <span class="hljs-number">32</span>)  <span class="hljs-comment"># grid size (max stride)</span><br>    imgsz = check_img_size(opt.imgsz, gs, floor=gs * <span class="hljs-number">2</span>)  <span class="hljs-comment"># verify imgsz is gs-multiple</span><br><br>    <span class="hljs-comment"># Batch size</span><br>    <span class="hljs-keyword">if</span> RANK == -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> batch_size == -<span class="hljs-number">1</span>:  <span class="hljs-comment"># single-GPU only, estimate best batch size</span><br>        batch_size = check_train_batch_size(model, imgsz)<br>        loggers.on_params_update(&#123;<span class="hljs-string">&quot;batch_size&quot;</span>: batch_size&#125;)<br><br>    <span class="hljs-comment"># Optimizer</span><br>    nbs = <span class="hljs-number">64</span>  <span class="hljs-comment"># nominal batch size</span><br>    accumulate = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">round</span>(nbs / batch_size), <span class="hljs-number">1</span>)  <span class="hljs-comment"># accumulate loss before optimizing</span><br>    hyp[<span class="hljs-string">&#x27;weight_decay&#x27;</span>] *= batch_size * accumulate / nbs  <span class="hljs-comment"># scale weight_decay</span><br>    LOGGER.info(<span class="hljs-string">f&quot;Scaled weight_decay = <span class="hljs-subst">&#123;hyp[<span class="hljs-string">&#x27;weight_decay&#x27;</span>]&#125;</span>&quot;</span>)<br><br>    g = [], [], []  <span class="hljs-comment"># optimizer parameter groups</span><br>    bn = <span class="hljs-built_in">tuple</span>(v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> nn.__dict__.items() <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;Norm&#x27;</span> <span class="hljs-keyword">in</span> k)  <span class="hljs-comment"># normalization layers, i.e. BatchNorm2d()</span><br>    <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> model.modules():<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(v, <span class="hljs-string">&#x27;bias&#x27;</span>) <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(v.bias, nn.Parameter):  <span class="hljs-comment"># bias</span><br>            g[<span class="hljs-number">2</span>].append(v.bias)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(v, bn):  <span class="hljs-comment"># weight (no decay)</span><br>            g[<span class="hljs-number">1</span>].append(v.weight)<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(v, <span class="hljs-string">&#x27;weight&#x27;</span>) <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(v.weight, nn.Parameter):  <span class="hljs-comment"># weight (with decay)</span><br>            g[<span class="hljs-number">0</span>].append(v.weight)<br><br>    <span class="hljs-keyword">if</span> opt.optimizer == <span class="hljs-string">&#x27;Adam&#x27;</span>:<br>        optimizer = Adam(g[<span class="hljs-number">2</span>], lr=hyp[<span class="hljs-string">&#x27;lr0&#x27;</span>], betas=(hyp[<span class="hljs-string">&#x27;momentum&#x27;</span>], <span class="hljs-number">0.999</span>))  <span class="hljs-comment"># adjust beta1 to momentum</span><br>    <span class="hljs-keyword">elif</span> opt.optimizer == <span class="hljs-string">&#x27;AdamW&#x27;</span>:<br>        optimizer = AdamW(g[<span class="hljs-number">2</span>], lr=hyp[<span class="hljs-string">&#x27;lr0&#x27;</span>], betas=(hyp[<span class="hljs-string">&#x27;momentum&#x27;</span>], <span class="hljs-number">0.999</span>))  <span class="hljs-comment"># adjust beta1 to momentum</span><br>    <span class="hljs-keyword">else</span>:<br>        optimizer = SGD(g[<span class="hljs-number">2</span>], lr=hyp[<span class="hljs-string">&#x27;lr0&#x27;</span>], momentum=hyp[<span class="hljs-string">&#x27;momentum&#x27;</span>], nesterov=<span class="hljs-literal">True</span>)<br><br>    optimizer.add_param_group(&#123;<span class="hljs-string">&#x27;params&#x27;</span>: g[<span class="hljs-number">0</span>], <span class="hljs-string">&#x27;weight_decay&#x27;</span>: hyp[<span class="hljs-string">&#x27;weight_decay&#x27;</span>]&#125;)  <span class="hljs-comment"># add g0 with weight_decay</span><br>    optimizer.add_param_group(&#123;<span class="hljs-string">&#x27;params&#x27;</span>: g[<span class="hljs-number">1</span>]&#125;)  <span class="hljs-comment"># add g1 (BatchNorm2d weights)</span><br>    LOGGER.info(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;colorstr(<span class="hljs-string">&#x27;optimizer:&#x27;</span>)&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-built_in">type</span>(optimizer).__name__&#125;</span> with parameter groups &quot;</span><br>                <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(g[<span class="hljs-number">1</span>])&#125;</span> weight (no decay), <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(g[<span class="hljs-number">0</span>])&#125;</span> weight, <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(g[<span class="hljs-number">2</span>])&#125;</span> bias&quot;</span>)<br>    <span class="hljs-keyword">del</span> g<br><br>    <span class="hljs-comment"># Scheduler</span><br>    <span class="hljs-keyword">if</span> opt.cos_lr:<br>        lf = one_cycle(<span class="hljs-number">1</span>, hyp[<span class="hljs-string">&#x27;lrf&#x27;</span>], epochs)  <span class="hljs-comment"># cosine 1-&gt;hyp[&#x27;lrf&#x27;]</span><br>    <span class="hljs-keyword">else</span>:<br>        lf = <span class="hljs-keyword">lambda</span> x: (<span class="hljs-number">1</span> - x / epochs) * (<span class="hljs-number">1.0</span> - hyp[<span class="hljs-string">&#x27;lrf&#x27;</span>]) + hyp[<span class="hljs-string">&#x27;lrf&#x27;</span>]  <span class="hljs-comment"># linear</span><br>    scheduler = lr_scheduler.LambdaLR(optimizer, lr_lambda=lf)  <span class="hljs-comment"># plot_lr_scheduler(optimizer, scheduler, epochs)</span><br><br>    <span class="hljs-comment"># EMA</span><br>    ema = ModelEMA(model) <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> [-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>] <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># Resume</span><br>    start_epoch, best_fitness = <span class="hljs-number">0</span>, <span class="hljs-number">0.0</span><br>    <span class="hljs-keyword">if</span> pretrained:<br>        <span class="hljs-comment"># Optimizer</span><br>        <span class="hljs-keyword">if</span> ckpt[<span class="hljs-string">&#x27;optimizer&#x27;</span>] <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            optimizer.load_state_dict(ckpt[<span class="hljs-string">&#x27;optimizer&#x27;</span>])<br>            best_fitness = ckpt[<span class="hljs-string">&#x27;best_fitness&#x27;</span>]<br><br>        <span class="hljs-comment"># EMA</span><br>        <span class="hljs-keyword">if</span> ema <span class="hljs-keyword">and</span> ckpt.get(<span class="hljs-string">&#x27;ema&#x27;</span>):<br>            ema.ema.load_state_dict(ckpt[<span class="hljs-string">&#x27;ema&#x27;</span>].<span class="hljs-built_in">float</span>().state_dict())<br>            ema.updates = ckpt[<span class="hljs-string">&#x27;updates&#x27;</span>]<br><br>        <span class="hljs-comment"># Epochs</span><br>        start_epoch = ckpt[<span class="hljs-string">&#x27;epoch&#x27;</span>] + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> resume:<br>            <span class="hljs-keyword">assert</span> start_epoch &gt; <span class="hljs-number">0</span>, <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;weights&#125;</span> training to <span class="hljs-subst">&#123;epochs&#125;</span> epochs is finished, nothing to resume.&#x27;</span><br>        <span class="hljs-keyword">if</span> epochs &lt; start_epoch:<br>            LOGGER.info(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;weights&#125;</span> has been trained for <span class="hljs-subst">&#123;ckpt[<span class="hljs-string">&#x27;epoch&#x27;</span>]&#125;</span> epochs. Fine-tuning for <span class="hljs-subst">&#123;epochs&#125;</span> more epochs.&quot;</span>)<br>            epochs += ckpt[<span class="hljs-string">&#x27;epoch&#x27;</span>]  <span class="hljs-comment"># finetune additional epochs</span><br><br>        <span class="hljs-keyword">del</span> ckpt, csd<br><br>    <span class="hljs-comment"># DP mode</span><br>    <span class="hljs-keyword">if</span> cuda <span class="hljs-keyword">and</span> RANK == -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> torch.cuda.device_count() &gt; <span class="hljs-number">1</span>:<br>        LOGGER.warning(<span class="hljs-string">&#x27;WARNING: DP not recommended, use torch.distributed.run for best DDP Multi-GPU results.\n&#x27;</span><br>                       <span class="hljs-string">&#x27;See Multi-GPU Tutorial at https://github.com/ultralytics/yolov5/issues/475 to get started.&#x27;</span>)<br>        model = torch.nn.DataParallel(model)<br><br>    <span class="hljs-comment"># SyncBatchNorm</span><br>    <span class="hljs-keyword">if</span> opt.sync_bn <span class="hljs-keyword">and</span> cuda <span class="hljs-keyword">and</span> RANK != -<span class="hljs-number">1</span>:<br>        model = torch.nn.SyncBatchNorm.convert_sync_batchnorm(model).to(device)<br>        LOGGER.info(<span class="hljs-string">&#x27;Using SyncBatchNorm()&#x27;</span>)<br><br>    <span class="hljs-comment"># Trainloader</span><br>    train_loader, dataset = create_dataloader(train_path,<br>                                              imgsz,<br>                                              batch_size // WORLD_SIZE,<br>                                              gs,<br>                                              single_cls,<br>                                              hyp=hyp,<br>                                              augment=<span class="hljs-literal">True</span>,<br>                                              cache=<span class="hljs-literal">None</span> <span class="hljs-keyword">if</span> opt.cache == <span class="hljs-string">&#x27;val&#x27;</span> <span class="hljs-keyword">else</span> opt.cache,<br>                                              rect=opt.rect,<br>                                              rank=LOCAL_RANK,<br>                                              workers=workers,<br>                                              image_weights=opt.image_weights,<br>                                              quad=opt.quad,<br>                                              prefix=colorstr(<span class="hljs-string">&#x27;train: &#x27;</span>),<br>                                              shuffle=<span class="hljs-literal">True</span>)<br>    mlc = <span class="hljs-built_in">int</span>(np.concatenate(dataset.labels, <span class="hljs-number">0</span>)[:, <span class="hljs-number">0</span>].<span class="hljs-built_in">max</span>())  <span class="hljs-comment"># max label class</span><br>    nb = <span class="hljs-built_in">len</span>(train_loader)  <span class="hljs-comment"># number of batches</span><br>    <span class="hljs-keyword">assert</span> mlc &lt; nc, <span class="hljs-string">f&#x27;Label class <span class="hljs-subst">&#123;mlc&#125;</span> exceeds nc=<span class="hljs-subst">&#123;nc&#125;</span> in <span class="hljs-subst">&#123;data&#125;</span>. Possible class labels are 0-<span class="hljs-subst">&#123;nc - <span class="hljs-number">1</span>&#125;</span>&#x27;</span><br><br>    <span class="hljs-comment"># Process 0</span><br>    <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> [-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]:<br>        val_loader = create_dataloader(val_path,<br>                                       imgsz,<br>                                       batch_size // WORLD_SIZE * <span class="hljs-number">2</span>,<br>                                       gs,<br>                                       single_cls,<br>                                       hyp=hyp,<br>                                       cache=<span class="hljs-literal">None</span> <span class="hljs-keyword">if</span> noval <span class="hljs-keyword">else</span> opt.cache,<br>                                       rect=<span class="hljs-literal">True</span>,<br>                                       rank=-<span class="hljs-number">1</span>,<br>                                       workers=workers * <span class="hljs-number">2</span>,<br>                                       pad=<span class="hljs-number">0.5</span>,<br>                                       prefix=colorstr(<span class="hljs-string">&#x27;val: &#x27;</span>))[<span class="hljs-number">0</span>]<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resume:<br>            labels = np.concatenate(dataset.labels, <span class="hljs-number">0</span>)<br>            <span class="hljs-comment"># c = torch.tensor(labels[:, 0])  # classes</span><br>            <span class="hljs-comment"># cf = torch.bincount(c.long(), minlength=nc) + 1.  # frequency</span><br>            <span class="hljs-comment"># model._initialize_biases(cf.to(device))</span><br>            <span class="hljs-keyword">if</span> plots:<br>                plot_labels(labels, names, save_dir)<br><br>            <span class="hljs-comment"># Anchors</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> opt.noautoanchor:<br>                check_anchors(dataset, model=model, thr=hyp[<span class="hljs-string">&#x27;anchor_t&#x27;</span>], imgsz=imgsz)<br>            model.half().<span class="hljs-built_in">float</span>()  <span class="hljs-comment"># pre-reduce anchor precision</span><br><br>        callbacks.run(<span class="hljs-string">&#x27;on_pretrain_routine_end&#x27;</span>)<br><br>    <span class="hljs-comment"># DDP mode</span><br>    <span class="hljs-keyword">if</span> cuda <span class="hljs-keyword">and</span> RANK != -<span class="hljs-number">1</span>:<br>        model = DDP(model, device_ids=[LOCAL_RANK], output_device=LOCAL_RANK)<br><br>    <span class="hljs-comment"># Model attributes</span><br>    nl = de_parallel(model).model[-<span class="hljs-number">1</span>].nl  <span class="hljs-comment"># number of detection layers (to scale hyps)</span><br>    hyp[<span class="hljs-string">&#x27;box&#x27;</span>] *= <span class="hljs-number">3</span> / nl  <span class="hljs-comment"># scale to layers</span><br>    hyp[<span class="hljs-string">&#x27;cls&#x27;</span>] *= nc / <span class="hljs-number">80</span> * <span class="hljs-number">3</span> / nl  <span class="hljs-comment"># scale to classes and layers</span><br>    hyp[<span class="hljs-string">&#x27;obj&#x27;</span>] *= (imgsz / <span class="hljs-number">640</span>) ** <span class="hljs-number">2</span> * <span class="hljs-number">3</span> / nl  <span class="hljs-comment"># scale to image size and layers</span><br>    hyp[<span class="hljs-string">&#x27;label_smoothing&#x27;</span>] = opt.label_smoothing<br>    model.nc = nc  <span class="hljs-comment"># attach number of classes to model</span><br>    model.hyp = hyp  <span class="hljs-comment"># attach hyperparameters to model</span><br>    model.class_weights = labels_to_class_weights(dataset.labels, nc).to(device) * nc  <span class="hljs-comment"># attach class weights</span><br>    model.names = names<br><br>    <span class="hljs-comment"># Start training</span><br>    t0 = time.time()<br>    nw = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">round</span>(hyp[<span class="hljs-string">&#x27;warmup_epochs&#x27;</span>] * nb), <span class="hljs-number">100</span>)  <span class="hljs-comment"># number of warmup iterations, max(3 epochs, 100 iterations)</span><br>    <span class="hljs-comment"># nw = min(nw, (epochs - start_epoch) / 2 * nb)  # limit warmup to &lt; 1/2 of training</span><br>    last_opt_step = -<span class="hljs-number">1</span><br>    maps = np.zeros(nc)  <span class="hljs-comment"># mAP per class</span><br>    results = (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># P, R, mAP@.5, mAP@.5-.95, val_loss(box, obj, cls)</span><br>    scheduler.last_epoch = start_epoch - <span class="hljs-number">1</span>  <span class="hljs-comment"># do not move</span><br>    scaler = amp.GradScaler(enabled=cuda)<br>    stopper = EarlyStopping(patience=opt.patience)<br>    compute_loss = ComputeLoss(model)  <span class="hljs-comment"># init loss class</span><br>    callbacks.run(<span class="hljs-string">&#x27;on_train_start&#x27;</span>)<br>    LOGGER.info(<span class="hljs-string">f&#x27;Image sizes <span class="hljs-subst">&#123;imgsz&#125;</span> train, <span class="hljs-subst">&#123;imgsz&#125;</span> val\n&#x27;</span><br>                <span class="hljs-string">f&#x27;Using <span class="hljs-subst">&#123;train_loader.num_workers * WORLD_SIZE&#125;</span> dataloader workers\n&#x27;</span><br>                <span class="hljs-string">f&quot;Logging results to <span class="hljs-subst">&#123;colorstr(<span class="hljs-string">&#x27;bold&#x27;</span>, save_dir)&#125;</span>\n&quot;</span><br>                <span class="hljs-string">f&#x27;Starting training for <span class="hljs-subst">&#123;epochs&#125;</span> epochs...&#x27;</span>)<br>    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(start_epoch, epochs):  <span class="hljs-comment"># epoch ------------------------------------------------------------------</span><br>        callbacks.run(<span class="hljs-string">&#x27;on_train_epoch_start&#x27;</span>)<br>        model.train()<br><br>        <span class="hljs-comment"># Update image weights (optional, single-GPU only)</span><br>        <span class="hljs-keyword">if</span> opt.image_weights:<br>            cw = model.class_weights.cpu().numpy() * (<span class="hljs-number">1</span> - maps) ** <span class="hljs-number">2</span> / nc  <span class="hljs-comment"># class weights</span><br>            iw = labels_to_image_weights(dataset.labels, nc=nc, class_weights=cw)  <span class="hljs-comment"># image weights</span><br>            dataset.indices = random.choices(<span class="hljs-built_in">range</span>(dataset.n), weights=iw, k=dataset.n)  <span class="hljs-comment"># rand weighted idx</span><br><br>        <span class="hljs-comment"># Update mosaic border (optional)</span><br>        <span class="hljs-comment"># b = int(random.uniform(0.25 * imgsz, 0.75 * imgsz + gs) // gs * gs)</span><br>        <span class="hljs-comment"># dataset.mosaic_border = [b - imgsz, -b]  # height, width borders</span><br><br>        mloss = torch.zeros(<span class="hljs-number">3</span>, device=device)  <span class="hljs-comment"># mean losses</span><br>        <span class="hljs-keyword">if</span> RANK != -<span class="hljs-number">1</span>:<br>            train_loader.sampler.set_epoch(epoch)<br>        pbar = <span class="hljs-built_in">enumerate</span>(train_loader)<br>        LOGGER.info((<span class="hljs-string">&#x27;\n&#x27;</span> + <span class="hljs-string">&#x27;%10s&#x27;</span> * <span class="hljs-number">7</span>) % (<span class="hljs-string">&#x27;Epoch&#x27;</span>, <span class="hljs-string">&#x27;gpu_mem&#x27;</span>, <span class="hljs-string">&#x27;box&#x27;</span>, <span class="hljs-string">&#x27;obj&#x27;</span>, <span class="hljs-string">&#x27;cls&#x27;</span>, <span class="hljs-string">&#x27;labels&#x27;</span>, <span class="hljs-string">&#x27;img_size&#x27;</span>))<br>        <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> (-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>):<br>            pbar = tqdm(pbar, total=nb, bar_format=<span class="hljs-string">&#x27;&#123;l_bar&#125;&#123;bar:10&#125;&#123;r_bar&#125;&#123;bar:-10b&#125;&#x27;</span>)  <span class="hljs-comment"># progress bar</span><br>        optimizer.zero_grad()<br>        <span class="hljs-keyword">for</span> i, (imgs, targets, paths, _) <span class="hljs-keyword">in</span> pbar:  <span class="hljs-comment"># batch -------------------------------------------------------------</span><br>            callbacks.run(<span class="hljs-string">&#x27;on_train_batch_start&#x27;</span>)<br>            ni = i + nb * epoch  <span class="hljs-comment"># number integrated batches (since train start)</span><br>            imgs = imgs.to(device, non_blocking=<span class="hljs-literal">True</span>).<span class="hljs-built_in">float</span>() / <span class="hljs-number">255</span>  <span class="hljs-comment"># uint8 to float32, 0-255 to 0.0-1.0</span><br><br>            <span class="hljs-comment"># Warmup</span><br>            <span class="hljs-keyword">if</span> ni &lt;= nw:<br>                xi = [<span class="hljs-number">0</span>, nw]  <span class="hljs-comment"># x interp</span><br>                <span class="hljs-comment"># compute_loss.gr = np.interp(ni, xi, [0.0, 1.0])  # iou loss ratio (obj_loss = 1.0 or iou)</span><br>                accumulate = <span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, np.interp(ni, xi, [<span class="hljs-number">1</span>, nbs / batch_size]).<span class="hljs-built_in">round</span>())<br>                <span class="hljs-keyword">for</span> j, x <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(optimizer.param_groups):<br>                    <span class="hljs-comment"># bias lr falls from 0.1 to lr0, all other lrs rise from 0.0 to lr0</span><br>                    x[<span class="hljs-string">&#x27;lr&#x27;</span>] = np.interp(ni, xi, [hyp[<span class="hljs-string">&#x27;warmup_bias_lr&#x27;</span>] <span class="hljs-keyword">if</span> j == <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0.0</span>, x[<span class="hljs-string">&#x27;initial_lr&#x27;</span>] * lf(epoch)])<br>                    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;momentum&#x27;</span> <span class="hljs-keyword">in</span> x:<br>                        x[<span class="hljs-string">&#x27;momentum&#x27;</span>] = np.interp(ni, xi, [hyp[<span class="hljs-string">&#x27;warmup_momentum&#x27;</span>], hyp[<span class="hljs-string">&#x27;momentum&#x27;</span>]])<br><br>            <span class="hljs-comment"># Multi-scale</span><br>            <span class="hljs-keyword">if</span> opt.multi_scale:<br>                sz = random.randrange(imgsz * <span class="hljs-number">0.5</span>, imgsz * <span class="hljs-number">1.5</span> + gs) // gs * gs  <span class="hljs-comment"># size</span><br>                sf = sz / <span class="hljs-built_in">max</span>(imgs.shape[<span class="hljs-number">2</span>:])  <span class="hljs-comment"># scale factor</span><br>                <span class="hljs-keyword">if</span> sf != <span class="hljs-number">1</span>:<br>                    ns = [math.ceil(x * sf / gs) * gs <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> imgs.shape[<span class="hljs-number">2</span>:]]  <span class="hljs-comment"># new shape (stretched to gs-multiple)</span><br>                    imgs = nn.functional.interpolate(imgs, size=ns, mode=<span class="hljs-string">&#x27;bilinear&#x27;</span>, align_corners=<span class="hljs-literal">False</span>)<br><br>            <span class="hljs-comment"># Forward</span><br>            <span class="hljs-keyword">with</span> amp.autocast(enabled=cuda):<br>                pred = model(imgs)  <span class="hljs-comment"># forward</span><br>                loss, loss_items = compute_loss(pred, targets.to(device))  <span class="hljs-comment"># loss scaled by batch_size</span><br>                <span class="hljs-keyword">if</span> RANK != -<span class="hljs-number">1</span>:<br>                    loss *= WORLD_SIZE  <span class="hljs-comment"># gradient averaged between devices in DDP mode</span><br>                <span class="hljs-keyword">if</span> opt.quad:<br>                    loss *= <span class="hljs-number">4.</span><br><br>            <span class="hljs-comment"># Backward</span><br>            scaler.scale(loss).backward()<br><br>            <span class="hljs-comment"># Optimize</span><br>            <span class="hljs-keyword">if</span> ni - last_opt_step &gt;= accumulate:<br>                scaler.step(optimizer)  <span class="hljs-comment"># optimizer.step</span><br>                scaler.update()<br>                optimizer.zero_grad()<br>                <span class="hljs-keyword">if</span> ema:<br>                    ema.update(model)<br>                last_opt_step = ni<br><br>            <span class="hljs-comment"># Log</span><br>            <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> (-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>):<br>                mloss = (mloss * i + loss_items) / (i + <span class="hljs-number">1</span>)  <span class="hljs-comment"># update mean losses</span><br>                mem = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;torch.cuda.memory_reserved() / <span class="hljs-number">1E9</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>:<span class="hljs-number">.3</span>g&#125;</span>G&#x27;</span>  <span class="hljs-comment"># (GB)</span><br>                pbar.set_description((<span class="hljs-string">&#x27;%10s&#x27;</span> * <span class="hljs-number">2</span> + <span class="hljs-string">&#x27;%10.4g&#x27;</span> * <span class="hljs-number">5</span>) %<br>                                     (<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;epoch&#125;</span>/<span class="hljs-subst">&#123;epochs - <span class="hljs-number">1</span>&#125;</span>&#x27;</span>, mem, *mloss, targets.shape[<span class="hljs-number">0</span>], imgs.shape[-<span class="hljs-number">1</span>]))<br>                callbacks.run(<span class="hljs-string">&#x27;on_train_batch_end&#x27;</span>, ni, model, imgs, targets, paths, plots)<br>                <span class="hljs-keyword">if</span> callbacks.stop_training:<br>                    <span class="hljs-keyword">return</span><br>            <span class="hljs-comment"># end batch ------------------------------------------------------------------------------------------------</span><br><br>        <span class="hljs-comment"># Scheduler</span><br>        lr = [x[<span class="hljs-string">&#x27;lr&#x27;</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> optimizer.param_groups]  <span class="hljs-comment"># for loggers</span><br>        scheduler.step()<br><br>        <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> (-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>):<br>            <span class="hljs-comment"># mAP</span><br>            callbacks.run(<span class="hljs-string">&#x27;on_train_epoch_end&#x27;</span>, epoch=epoch)<br>            ema.update_attr(model, include=[<span class="hljs-string">&#x27;yaml&#x27;</span>, <span class="hljs-string">&#x27;nc&#x27;</span>, <span class="hljs-string">&#x27;hyp&#x27;</span>, <span class="hljs-string">&#x27;names&#x27;</span>, <span class="hljs-string">&#x27;stride&#x27;</span>, <span class="hljs-string">&#x27;class_weights&#x27;</span>])<br>            final_epoch = (epoch + <span class="hljs-number">1</span> == epochs) <span class="hljs-keyword">or</span> stopper.possible_stop<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> noval <span class="hljs-keyword">or</span> final_epoch:  <span class="hljs-comment"># Calculate mAP</span><br>                results, maps, _ = val.run(data_dict,<br>                                           batch_size=batch_size // WORLD_SIZE * <span class="hljs-number">2</span>,<br>                                           imgsz=imgsz,<br>                                           model=ema.ema,<br>                                           single_cls=single_cls,<br>                                           dataloader=val_loader,<br>                                           save_dir=save_dir,<br>                                           plots=<span class="hljs-literal">False</span>,<br>                                           callbacks=callbacks,<br>                                           compute_loss=compute_loss)<br><br>            <span class="hljs-comment"># Update best mAP</span><br>            fi = fitness(np.array(results).reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>))  <span class="hljs-comment"># weighted combination of [P, R, mAP@.5, mAP@.5-.95]</span><br>            <span class="hljs-keyword">if</span> fi &gt; best_fitness:<br>                best_fitness = fi<br>            log_vals = <span class="hljs-built_in">list</span>(mloss) + <span class="hljs-built_in">list</span>(results) + lr<br>            callbacks.run(<span class="hljs-string">&#x27;on_fit_epoch_end&#x27;</span>, log_vals, epoch, best_fitness, fi)<br><br>            <span class="hljs-comment"># Save model</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> nosave) <span class="hljs-keyword">or</span> (final_epoch <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> evolve):  <span class="hljs-comment"># if save</span><br>                ckpt = &#123;<br>                    <span class="hljs-string">&#x27;epoch&#x27;</span>: epoch,<br>                    <span class="hljs-string">&#x27;best_fitness&#x27;</span>: best_fitness,<br>                    <span class="hljs-string">&#x27;model&#x27;</span>: deepcopy(de_parallel(model)).half(),<br>                    <span class="hljs-string">&#x27;ema&#x27;</span>: deepcopy(ema.ema).half(),<br>                    <span class="hljs-string">&#x27;updates&#x27;</span>: ema.updates,<br>                    <span class="hljs-string">&#x27;optimizer&#x27;</span>: optimizer.state_dict(),<br>                    <span class="hljs-string">&#x27;wandb_id&#x27;</span>: loggers.wandb.wandb_run.<span class="hljs-built_in">id</span> <span class="hljs-keyword">if</span> loggers.wandb <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,<br>                    <span class="hljs-string">&#x27;date&#x27;</span>: datetime.now().isoformat()&#125;<br><br>                <span class="hljs-comment"># Save last, best and delete</span><br>                torch.save(ckpt, last)<br>                <span class="hljs-keyword">if</span> best_fitness == fi:<br>                    torch.save(ckpt, best)<br>                <span class="hljs-keyword">if</span> (epoch &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">and</span> (opt.save_period &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">and</span> (epoch % opt.save_period == <span class="hljs-number">0</span>):<br>                    torch.save(ckpt, w / <span class="hljs-string">f&#x27;epoch<span class="hljs-subst">&#123;epoch&#125;</span>.pt&#x27;</span>)<br>                <span class="hljs-keyword">del</span> ckpt<br>                callbacks.run(<span class="hljs-string">&#x27;on_model_save&#x27;</span>, last, epoch, final_epoch, best_fitness, fi)<br><br>            <span class="hljs-comment"># Stop Single-GPU</span><br>            <span class="hljs-keyword">if</span> RANK == -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> stopper(epoch=epoch, fitness=fi):<br>                <span class="hljs-keyword">break</span><br><br>            <span class="hljs-comment"># Stop DDP <span class="hljs-doctag">TODO:</span> known issues shttps://github.com/ultralytics/yolov5/pull/4576</span><br>            <span class="hljs-comment"># stop = stopper(epoch=epoch, fitness=fi)</span><br>            <span class="hljs-comment"># if RANK == 0:</span><br>            <span class="hljs-comment">#    dist.broadcast_object_list([stop], 0)  # broadcast &#x27;stop&#x27; to all ranks</span><br><br>        <span class="hljs-comment"># Stop DPP</span><br>        <span class="hljs-comment"># with torch_distributed_zero_first(RANK):</span><br>        <span class="hljs-comment"># if stop:</span><br>        <span class="hljs-comment">#    break  # must break all DDP ranks</span><br><br>        <span class="hljs-comment"># end epoch ----------------------------------------------------------------------------------------------------</span><br>    <span class="hljs-comment"># end training -----------------------------------------------------------------------------------------------------</span><br>    <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> (-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>):<br>        LOGGER.info(<span class="hljs-string">f&#x27;\n<span class="hljs-subst">&#123;epoch - start_epoch + <span class="hljs-number">1</span>&#125;</span> epochs completed in <span class="hljs-subst">&#123;(time.time() - t0) / <span class="hljs-number">3600</span>:<span class="hljs-number">.3</span>f&#125;</span> hours.&#x27;</span>)<br>        <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> last, best:<br>            <span class="hljs-keyword">if</span> f.exists():<br>                strip_optimizer(f)  <span class="hljs-comment"># strip optimizers</span><br>                <span class="hljs-keyword">if</span> f <span class="hljs-keyword">is</span> best:<br>                    LOGGER.info(<span class="hljs-string">f&#x27;\nValidating <span class="hljs-subst">&#123;f&#125;</span>...&#x27;</span>)<br>                    results, _, _ = val.run(<br>                        data_dict,<br>                        batch_size=batch_size // WORLD_SIZE * <span class="hljs-number">2</span>,<br>                        imgsz=imgsz,<br>                        model=attempt_load(f, device).half(),<br>                        iou_thres=<span class="hljs-number">0.65</span> <span class="hljs-keyword">if</span> is_coco <span class="hljs-keyword">else</span> <span class="hljs-number">0.60</span>,  <span class="hljs-comment"># best pycocotools results at 0.65</span><br>                        single_cls=single_cls,<br>                        dataloader=val_loader,<br>                        save_dir=save_dir,<br>                        save_json=is_coco,<br>                        verbose=<span class="hljs-literal">True</span>,<br>                        plots=plots,<br>                        callbacks=callbacks,<br>                        compute_loss=compute_loss)  <span class="hljs-comment"># val best model with plots</span><br>                    <span class="hljs-keyword">if</span> is_coco:<br>                        callbacks.run(<span class="hljs-string">&#x27;on_fit_epoch_end&#x27;</span>, <span class="hljs-built_in">list</span>(mloss) + <span class="hljs-built_in">list</span>(results) + lr, epoch, best_fitness, fi)<br><br>        callbacks.run(<span class="hljs-string">&#x27;on_train_end&#x27;</span>, last, best, plots, epoch, results)<br>        LOGGER.info(<span class="hljs-string">f&quot;Results saved to <span class="hljs-subst">&#123;colorstr(<span class="hljs-string">&#x27;bold&#x27;</span>, save_dir)&#125;</span>&quot;</span>)<br><br>    torch.cuda.empty_cache()<br>    <span class="hljs-keyword">return</span> results<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_opt</span>(<span class="hljs-params">known=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-comment"># è¿›è¡Œå‘½ä»¤è¡Œå‚æ•°è§£æ</span><br>    parser = argparse.ArgumentParser()<br>    <span class="hljs-comment"># è¦ä½¿ç”¨çš„æƒé‡æ–‡ä»¶</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--weights&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=ROOT / <span class="hljs-string">&#x27;yolov5s.pt&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;initial weights path&#x27;</span>)<br>    <span class="hljs-comment"># ä½¿ç”¨çš„æ¨¡å‹çš„yamlæ–‡ä»¶ä½ç½®</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--cfg&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;model.yaml path&#x27;</span>)<br>    <span class="hljs-comment"># æ•°æ®é›†çš„yamlä½ç½®</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--data&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=ROOT / <span class="hljs-string">&#x27;data/coco128.yaml&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;dataset.yaml path&#x27;</span>)<br>    <span class="hljs-comment"># è¶…å‚æ•°yamlä½ç½®</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--hyp&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=ROOT / <span class="hljs-string">&#x27;data/hyps/hyp.scratch-low.yaml&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;hyperparameters path&#x27;</span>)<br>    <span class="hljs-comment"># è®¾ç½®epoch</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--epochs&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">300</span>)<br>    <span class="hljs-comment"># è®¾ç½®batch_size</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--batch-size&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">16</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;total batch size for all GPUs, -1 for autobatch&#x27;</span>)<br>    <span class="hljs-comment"># è®¾ç½®ç…§ç‰‡size</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--imgsz&#x27;</span>, <span class="hljs-string">&#x27;--img&#x27;</span>, <span class="hljs-string">&#x27;--img-size&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">640</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;train, val image size (pixels)&#x27;</span>)<br>    <span class="hljs-comment"># å»é™¤åœ¨ä»¿å°„å˜æ¢æˆ(640,640)æ—¶çš„å†—ä½™æ•°æ®ï¼Œä»¤çŸ­è¾¹æ»¡è¶³32çš„å€æ•°å³å¯</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--rect&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;rectangular training&#x27;</span>)<br>    <span class="hljs-comment"># æ¢å¤æœ€è¿‘çš„è®­ç»ƒï¼Œå³æ–­ç‚¹</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--resume&#x27;</span>, nargs=<span class="hljs-string">&#x27;?&#x27;</span>, const=<span class="hljs-literal">True</span>, default=<span class="hljs-literal">False</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;resume most recent training&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦åªä¿ç•™æœ€åä¸€è½®çš„ptæ–‡ä»¶</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--nosave&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;only save final checkpoint&#x27;</span>)<br>    <span class="hljs-comment"># åªåœ¨æœ€åä¸€è½®ä¸Šé¢æµ‹è¯•map</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--noval&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;only validate final epoch&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦ç¦ç”¨è‡ªåŠ¨é”šæ¡†ï¼Œé»˜è®¤å¼€å¯ï¼Œå¯ä»¥ç®€åŒ–è®­ç»ƒè¿‡ç¨‹</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--noautoanchor&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;disable AutoAnchor&#x27;</span>)<br>    <span class="hljs-comment"># å¼€å¯åä¸ä¿å­˜ç»˜å›¾æ–‡ä»¶</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--noplots&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;save no plot files&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦ä½¿ç”¨é—ä¼ ç®—æ³•æ¥è¿›è¡Œè¶…å‚æ•°è¿›åŒ–ï¼Œä¼šæ¶ˆè€—å¤§é‡çš„èµ„æºå’Œæ—¶é—´</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--evolve&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, nargs=<span class="hljs-string">&#x27;?&#x27;</span>, const=<span class="hljs-number">300</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;evolve hyperparameters for x generations&#x27;</span>)<br>    <span class="hljs-comment"># ä¸‹è½½è°·æ­Œäº‘ç›˜çš„ä¸œè¥¿ï¼Œæ²¡ç”¨ï¼</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--bucket&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;gsutil bucket&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦æå‰ç¼“å­˜ç…§ç‰‡åˆ°å†…å­˜ï¼ŒåŠ å¿«è®­ç»ƒé€Ÿåº¦</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--cache&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, nargs=<span class="hljs-string">&#x27;?&#x27;</span>, const=<span class="hljs-string">&#x27;ram&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;--cache images in &quot;ram&quot; (default) or &quot;disk&quot;&#x27;</span>)<br>    <span class="hljs-comment"># å›¾åƒåŠ æƒç­–ç•¥ï¼Œé»˜è®¤ä¸å¼€å¯ï¼Œè§£å†³æ ·æœ¬ä¸å‡è¡¡ï¼Œå¯¹äºä¸Šä¸€è½®è®­ç»ƒä¸å¥½çš„ç…§ç‰‡ï¼Œä¸‹ä¸€è½®åŠ ä¸€äº›æƒé‡</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--image-weights&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;use weighted image selection for training&#x27;</span>)<br>    <span class="hljs-comment"># æŒ‡å®šè®¾å¤‡ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ¤æ–­</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--device&#x27;</span>, default=<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;cuda device, i.e. 0 or 0,1,2,3 or cpu&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦å¯åŠ¨å¤šå°ºåº¦è®­ç»ƒï¼Œé»˜è®¤ä¸å¼€å¯ï¼Œä¼šä½¿ç”¨ä¸åŒè¾“å…¥å°ºåº¦çš„å›¾ç‰‡ï¼Œå¯ä»¥å¢å¼ºæ¨¡å‹çš„é²æ£’æ€§</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--multi-scale&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;vary img-size +/- 50%%&#x27;</span>)<br>    <span class="hljs-comment"># è®­ç»ƒé›†æ˜¯å¤šç±»åˆ«è¿˜æ˜¯å•ç±»åˆ«ï¼Œé»˜è®¤å¤šç±»åˆ«</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--single-cls&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;train multi-class data as single-class&#x27;</span>)<br>    <span class="hljs-comment"># ä¼˜åŒ–å™¨ï¼Œé»˜è®¤SGDï¼Œå¯ä»¥ä½¿ç”¨SGDï¼ŒAdamï¼ŒAdamW</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--optimizer&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, choices=[<span class="hljs-string">&#x27;SGD&#x27;</span>, <span class="hljs-string">&#x27;Adam&#x27;</span>, <span class="hljs-string">&#x27;AdamW&#x27;</span>], default=<span class="hljs-string">&#x27;SGD&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;optimizer&#x27;</span>)<br>    <span class="hljs-comment"># å¤šGPUåˆ†å¸ƒå¼è®­ç»ƒ</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--sync-bn&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;use SyncBatchNorm, only available in DDP mode&#x27;</span>)<br>    <span class="hljs-comment"># æœ€å¤§workersçš„æ•°é‡</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--workers&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">8</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;max dataloader workers (per RANK in DDP mode)&#x27;</span>)<br>    <span class="hljs-comment"># è®­ç»ƒå¥½çš„æ¨¡å‹ä¿å­˜åœ°å€</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--project&#x27;</span>, default=ROOT / <span class="hljs-string">&#x27;runs/train&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;save to project/name&#x27;</span>)<br>    <span class="hljs-comment"># æ¨¡å‹çš„ä¿å­˜æ–‡ä»¶å¤¹å</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--name&#x27;</span>, default=<span class="hljs-string">&#x27;exp&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;save to project/name&#x27;</span>)<br>    <span class="hljs-comment"># æ¯æ¬¡é¢„æµ‹æ¨¡å‹çš„ç»“æœæ˜¯å¦ä¿å­˜åœ¨åŸæ¥çš„æ–‡ä»¶å¤¹ï¼Œå¦‚æœæŒ‡å®šäº†è¿™ä¸ªå‚æ•°çš„è¯ï¼Œé‚£ä¹ˆæœ¬æ¬¡é¢„æµ‹çš„ç»“æœè¿˜æ˜¯ä¿å­˜åœ¨ä¸Šä¸€æ¬¡ä¿å­˜çš„æ–‡ä»¶å¤¹é‡Œï¼Œå¦‚æœä¸æŒ‡å®šå°±æ˜¯æ¯æ¬¡é¢„æµ‹ç»“æœä¿å­˜ä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹ä¸‹ã€‚</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--exist-ok&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;existing project/name ok, do not increment&#x27;</span>)<br>    <span class="hljs-comment"># å¦‚æœå¼€å¯çš„è¯å¯¹é«˜åˆ†è¾¨ç‡çš„æ•°æ®é›†æ•ˆæœæ¯”è¾ƒå¥½</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--quad&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;quad dataloader&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦å¼€å¯ä½™å¼¦å­¦ä¹ ç‡</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--cos-lr&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;cosine LR scheduler&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦å¯¹æ ‡ç­¾è¿›è¡Œå¹³æ»‘å¤„ç†ï¼Œé»˜è®¤ä¸å¼€å¯ï¼Œåœ¨è®­ç»ƒæ ·æœ¬ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯æ‰€æœ‰sampleéƒ½æ ‡æ³¨æ­£ç¡®ï¼Œå¦‚æœæŸä¸ªæ ·æœ¬æ ‡æ³¨é”™è¯¯ï¼Œå°±å¯èƒ½äº§ç”Ÿè´Ÿé¢å°è±¡ï¼Œå¦‚æœæˆ‘ä»¬æœ‰åŠæ³•å‘Šè¯‰æ¨¡å‹ï¼Œæ ·æœ¬çš„æ ‡ç­¾ä¸ä¸€å®šæ­£ç¡®</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--label-smoothing&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">float</span>, default=<span class="hljs-number">0.0</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Label smoothing epsilon&#x27;</span>)<br>    <span class="hljs-comment"># å¦‚æœæ¨¡å‹åœ¨è®¾å®šçš„è½®æ•°ä¸­ä¸€ç›´æ²¡æœ‰æå‡ï¼Œé‚£å°±ç»ˆæ­¢è®­ç»ƒ</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--patience&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">100</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;EarlyStopping patience (epochs without improvement)&#x27;</span>)<br>    <span class="hljs-comment"># æŒ‡å®šä¸œæ¥å±‚</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--freeze&#x27;</span>, nargs=<span class="hljs-string">&#x27;+&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=[<span class="hljs-number">0</span>], <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Freeze layers: backbone=10, first3=0 1 2&#x27;</span>)<br>    <span class="hljs-comment"># å¤šå°‘ä¸ªepochä¿å­˜ä¸€æ¬¡checkpoints</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--save-period&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=-<span class="hljs-number">1</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Save checkpoint every x epochs (disabled if &lt; 1)&#x27;</span>)<br>    <span class="hljs-comment"># ç”¨äºå¤šå¡è®­ç»ƒï¼Œå•å¡ä¸ç”¨è®¾ç½®</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--local_rank&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=-<span class="hljs-number">1</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;DDP parameter, do not modify&#x27;</span>)<br><br>    <span class="hljs-comment"># Weights &amp; Biases arguments</span><br>    <span class="hljs-comment"># åœ¨çº¿å¯è§†åŒ–å·¥å…·</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--entity&#x27;</span>, default=<span class="hljs-literal">None</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;W&amp;B: Entity&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦ä¸Šä¼ æ•°æ®é›†åˆ°wandb table</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--upload_dataset&#x27;</span>, nargs=<span class="hljs-string">&#x27;?&#x27;</span>, const=<span class="hljs-literal">True</span>, default=<span class="hljs-literal">False</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;W&amp;B: Upload data, &quot;val&quot; option&#x27;</span>)<br>    <span class="hljs-comment"># è®¾ç½®ç•Œæ¡†å›¾åƒè®°å½•é—´éš”</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--bbox_interval&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=-<span class="hljs-number">1</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;W&amp;B: Set bounding-box image logging interval&#x27;</span>)<br>    <span class="hljs-comment"># ä½œè€…è¿˜æœªå®ç°</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--artifact_alias&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-string">&#x27;latest&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;W&amp;B: Version of dataset artifact to use&#x27;</span>)<br><span class="hljs-comment"># parse_known_args()è¿”å›çš„æ˜¯ä¸€ä¸ªæœ‰ä¸¤ä¸ªå…ƒç´ çš„å…ƒç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯NameSpaceï¼Œç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ªåˆ—è¡¨ã€‚</span><br>    <span class="hljs-comment"># NameSpaceå°±æ˜¯æˆ‘ä»¬å‘½ä»¤è¡Œè¾“å…¥çš„ä¸œè¥¿</span><br>    <span class="hljs-comment"># parse_args()åªæœ‰ä¸€ä¸ªNameSpace</span><br>    opt = parser.parse_known_args()[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> known <span class="hljs-keyword">else</span> parser.parse_args()<br>    <span class="hljs-keyword">return</span> opt<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">opt, callbacks=Callbacks(<span class="hljs-params"></span>)</span>):<br>    <span class="hljs-comment"># Checks</span><br>    <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> (-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>):<br>        print_args(<span class="hljs-built_in">vars</span>(opt))<br>        check_git_status()<br>        check_requirements(exclude=[<span class="hljs-string">&#x27;thop&#x27;</span>])<br><br>    <span class="hljs-comment"># Resume</span><br>    <span class="hljs-keyword">if</span> opt.resume <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> check_wandb_resume(opt) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> opt.evolve:  <span class="hljs-comment"># resume an interrupted run</span><br>        ckpt = opt.resume <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(opt.resume, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> get_latest_run()  <span class="hljs-comment"># specified or most recent path</span><br>        <span class="hljs-keyword">assert</span> os.path.isfile(ckpt), <span class="hljs-string">&#x27;ERROR: --resume checkpoint does not exist&#x27;</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(Path(ckpt).parent.parent / <span class="hljs-string">&#x27;opt.yaml&#x27;</span>, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            opt = argparse.Namespace(**yaml.safe_load(f))  <span class="hljs-comment"># replace</span><br>        opt.cfg, opt.weights, opt.resume = <span class="hljs-string">&#x27;&#x27;</span>, ckpt, <span class="hljs-literal">True</span>  <span class="hljs-comment"># reinstate</span><br>        LOGGER.info(<span class="hljs-string">f&#x27;Resuming training from <span class="hljs-subst">&#123;ckpt&#125;</span>&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        opt.data, opt.cfg, opt.hyp, opt.weights, opt.project = \<br>            check_file(opt.data), check_yaml(opt.cfg), check_yaml(opt.hyp), <span class="hljs-built_in">str</span>(opt.weights), <span class="hljs-built_in">str</span>(opt.project)  <span class="hljs-comment"># checks</span><br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(opt.cfg) <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(opt.weights), <span class="hljs-string">&#x27;either --cfg or --weights must be specified&#x27;</span><br>        <span class="hljs-keyword">if</span> opt.evolve:<br>            <span class="hljs-keyword">if</span> opt.project == <span class="hljs-built_in">str</span>(ROOT / <span class="hljs-string">&#x27;runs/train&#x27;</span>):  <span class="hljs-comment"># if default project name, rename to runs/evolve</span><br>                opt.project = <span class="hljs-built_in">str</span>(ROOT / <span class="hljs-string">&#x27;runs/evolve&#x27;</span>)<br>            opt.exist_ok, opt.resume = opt.resume, <span class="hljs-literal">False</span>  <span class="hljs-comment"># pass resume to exist_ok and disable resume</span><br>        <span class="hljs-keyword">if</span> opt.name == <span class="hljs-string">&#x27;cfg&#x27;</span>:<br>            opt.name = Path(opt.cfg).stem  <span class="hljs-comment"># use model.yaml as name</span><br>        opt.save_dir = <span class="hljs-built_in">str</span>(increment_path(Path(opt.project) / opt.name, exist_ok=opt.exist_ok))<br><br>    <span class="hljs-comment"># DDP mode</span><br>    device = select_device(opt.device, batch_size=opt.batch_size)<br>    <span class="hljs-keyword">if</span> LOCAL_RANK != -<span class="hljs-number">1</span>:<br>        msg = <span class="hljs-string">&#x27;is not compatible with YOLOv5 Multi-GPU DDP training&#x27;</span><br>        <span class="hljs-keyword">assert</span> <span class="hljs-keyword">not</span> opt.image_weights, <span class="hljs-string">f&#x27;--image-weights <span class="hljs-subst">&#123;msg&#125;</span>&#x27;</span><br>        <span class="hljs-keyword">assert</span> <span class="hljs-keyword">not</span> opt.evolve, <span class="hljs-string">f&#x27;--evolve <span class="hljs-subst">&#123;msg&#125;</span>&#x27;</span><br>        <span class="hljs-keyword">assert</span> opt.batch_size != -<span class="hljs-number">1</span>, <span class="hljs-string">f&#x27;AutoBatch with --batch-size -1 <span class="hljs-subst">&#123;msg&#125;</span>, please pass a valid --batch-size&#x27;</span><br>        <span class="hljs-keyword">assert</span> opt.batch_size % WORLD_SIZE == <span class="hljs-number">0</span>, <span class="hljs-string">f&#x27;--batch-size <span class="hljs-subst">&#123;opt.batch_size&#125;</span> must be multiple of WORLD_SIZE&#x27;</span><br>        <span class="hljs-keyword">assert</span> torch.cuda.device_count() &gt; LOCAL_RANK, <span class="hljs-string">&#x27;insufficient CUDA devices for DDP command&#x27;</span><br>        torch.cuda.set_device(LOCAL_RANK)<br>        device = torch.device(<span class="hljs-string">&#x27;cuda&#x27;</span>, LOCAL_RANK)<br>        dist.init_process_group(backend=<span class="hljs-string">&quot;nccl&quot;</span> <span class="hljs-keyword">if</span> dist.is_nccl_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;gloo&quot;</span>)<br><br>    <span class="hljs-comment"># Train</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> opt.evolve:<br>        train(opt.hyp, opt, device, callbacks)<br>        <span class="hljs-keyword">if</span> WORLD_SIZE &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> RANK == <span class="hljs-number">0</span>:<br>            LOGGER.info(<span class="hljs-string">&#x27;Destroying process group... &#x27;</span>)<br>            dist.destroy_process_group()<br><br>    <span class="hljs-comment"># Evolve hyperparameters (optional)</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># Hyperparameter evolution metadata (mutation scale 0-1, lower_limit, upper_limit)</span><br>        meta = &#123;<br>            <span class="hljs-string">&#x27;lr0&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">1e-5</span>, <span class="hljs-number">1e-1</span>),  <span class="hljs-comment"># initial learning rate (SGD=1E-2, Adam=1E-3)</span><br>            <span class="hljs-string">&#x27;lrf&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># final OneCycleLR learning rate (lr0 * lrf)</span><br>            <span class="hljs-string">&#x27;momentum&#x27;</span>: (<span class="hljs-number">0.3</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.98</span>),  <span class="hljs-comment"># SGD momentum/Adam beta1</span><br>            <span class="hljs-string">&#x27;weight_decay&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.001</span>),  <span class="hljs-comment"># optimizer weight decay</span><br>            <span class="hljs-string">&#x27;warmup_epochs&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">5.0</span>),  <span class="hljs-comment"># warmup epochs (fractions ok)</span><br>            <span class="hljs-string">&#x27;warmup_momentum&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.95</span>),  <span class="hljs-comment"># warmup initial momentum</span><br>            <span class="hljs-string">&#x27;warmup_bias_lr&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.2</span>),  <span class="hljs-comment"># warmup initial bias lr</span><br>            <span class="hljs-string">&#x27;box&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.02</span>, <span class="hljs-number">0.2</span>),  <span class="hljs-comment"># box loss gain</span><br>            <span class="hljs-string">&#x27;cls&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">4.0</span>),  <span class="hljs-comment"># cls loss gain</span><br>            <span class="hljs-string">&#x27;cls_pw&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">2.0</span>),  <span class="hljs-comment"># cls BCELoss positive_weight</span><br>            <span class="hljs-string">&#x27;obj&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">4.0</span>),  <span class="hljs-comment"># obj loss gain (scale with pixels)</span><br>            <span class="hljs-string">&#x27;obj_pw&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">2.0</span>),  <span class="hljs-comment"># obj BCELoss positive_weight</span><br>            <span class="hljs-string">&#x27;iou_t&#x27;</span>: (<span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.7</span>),  <span class="hljs-comment"># IoU training threshold</span><br>            <span class="hljs-string">&#x27;anchor_t&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">8.0</span>),  <span class="hljs-comment"># anchor-multiple threshold</span><br>            <span class="hljs-string">&#x27;anchors&#x27;</span>: (<span class="hljs-number">2</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">10.0</span>),  <span class="hljs-comment"># anchors per output grid (0 to ignore)</span><br>            <span class="hljs-string">&#x27;fl_gamma&#x27;</span>: (<span class="hljs-number">0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">2.0</span>),  <span class="hljs-comment"># focal loss gamma (efficientDet default gamma=1.5)</span><br>            <span class="hljs-string">&#x27;hsv_h&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.1</span>),  <span class="hljs-comment"># image HSV-Hue augmentation (fraction)</span><br>            <span class="hljs-string">&#x27;hsv_s&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.9</span>),  <span class="hljs-comment"># image HSV-Saturation augmentation (fraction)</span><br>            <span class="hljs-string">&#x27;hsv_v&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.9</span>),  <span class="hljs-comment"># image HSV-Value augmentation (fraction)</span><br>            <span class="hljs-string">&#x27;degrees&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">45.0</span>),  <span class="hljs-comment"># image rotation (+/- deg)</span><br>            <span class="hljs-string">&#x27;translate&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.9</span>),  <span class="hljs-comment"># image translation (+/- fraction)</span><br>            <span class="hljs-string">&#x27;scale&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.9</span>),  <span class="hljs-comment"># image scale (+/- gain)</span><br>            <span class="hljs-string">&#x27;shear&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">10.0</span>),  <span class="hljs-comment"># image shear (+/- deg)</span><br>            <span class="hljs-string">&#x27;perspective&#x27;</span>: (<span class="hljs-number">0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.001</span>),  <span class="hljs-comment"># image perspective (+/- fraction), range 0-0.001</span><br>            <span class="hljs-string">&#x27;flipud&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># image flip up-down (probability)</span><br>            <span class="hljs-string">&#x27;fliplr&#x27;</span>: (<span class="hljs-number">0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># image flip left-right (probability)</span><br>            <span class="hljs-string">&#x27;mosaic&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># image mixup (probability)</span><br>            <span class="hljs-string">&#x27;mixup&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># image mixup (probability)</span><br>            <span class="hljs-string">&#x27;copy_paste&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>)&#125;  <span class="hljs-comment"># segment copy-paste (probability)</span><br><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(opt.hyp, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            hyp = yaml.safe_load(f)  <span class="hljs-comment"># load hyps dict</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;anchors&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> hyp:  <span class="hljs-comment"># anchors commented in hyp.yaml</span><br>                hyp[<span class="hljs-string">&#x27;anchors&#x27;</span>] = <span class="hljs-number">3</span><br>        opt.noval, opt.nosave, save_dir = <span class="hljs-literal">True</span>, <span class="hljs-literal">True</span>, Path(opt.save_dir)  <span class="hljs-comment"># only val/save final epoch</span><br>        <span class="hljs-comment"># ei = [isinstance(x, (int, float)) for x in hyp.values()]  # evolvable indices</span><br>        evolve_yaml, evolve_csv = save_dir / <span class="hljs-string">&#x27;hyp_evolve.yaml&#x27;</span>, save_dir / <span class="hljs-string">&#x27;evolve.csv&#x27;</span><br>        <span class="hljs-keyword">if</span> opt.bucket:<br>            os.system(<span class="hljs-string">f&#x27;gsutil cp gs://<span class="hljs-subst">&#123;opt.bucket&#125;</span>/evolve.csv <span class="hljs-subst">&#123;evolve_csv&#125;</span>&#x27;</span>)  <span class="hljs-comment"># download evolve.csv if exists</span><br><br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(opt.evolve):  <span class="hljs-comment"># generations to evolve</span><br>            <span class="hljs-keyword">if</span> evolve_csv.exists():  <span class="hljs-comment"># if evolve.csv exists: select best hyps and mutate</span><br>                <span class="hljs-comment"># Select parent(s)</span><br>                parent = <span class="hljs-string">&#x27;single&#x27;</span>  <span class="hljs-comment"># parent selection method: &#x27;single&#x27; or &#x27;weighted&#x27;</span><br>                x = np.loadtxt(evolve_csv, ndmin=<span class="hljs-number">2</span>, delimiter=<span class="hljs-string">&#x27;,&#x27;</span>, skiprows=<span class="hljs-number">1</span>)<br>                n = <span class="hljs-built_in">min</span>(<span class="hljs-number">5</span>, <span class="hljs-built_in">len</span>(x))  <span class="hljs-comment"># number of previous results to consider</span><br>                x = x[np.argsort(-fitness(x))][:n]  <span class="hljs-comment"># top n mutations</span><br>                w = fitness(x) - fitness(x).<span class="hljs-built_in">min</span>() + <span class="hljs-number">1E-6</span>  <span class="hljs-comment"># weights (sum &gt; 0)</span><br>                <span class="hljs-keyword">if</span> parent == <span class="hljs-string">&#x27;single&#x27;</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(x) == <span class="hljs-number">1</span>:<br>                    <span class="hljs-comment"># x = x[random.randint(0, n - 1)]  # random selection</span><br>                    x = x[random.choices(<span class="hljs-built_in">range</span>(n), weights=w)[<span class="hljs-number">0</span>]]  <span class="hljs-comment"># weighted selection</span><br>                <span class="hljs-keyword">elif</span> parent == <span class="hljs-string">&#x27;weighted&#x27;</span>:<br>                    x = (x * w.reshape(n, <span class="hljs-number">1</span>)).<span class="hljs-built_in">sum</span>(<span class="hljs-number">0</span>) / w.<span class="hljs-built_in">sum</span>()  <span class="hljs-comment"># weighted combination</span><br><br>                <span class="hljs-comment"># Mutate</span><br>                mp, s = <span class="hljs-number">0.8</span>, <span class="hljs-number">0.2</span>  <span class="hljs-comment"># mutation probability, sigma</span><br>                npr = np.random<br>                npr.seed(<span class="hljs-built_in">int</span>(time.time()))<br>                g = np.array([meta[k][<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> hyp.keys()])  <span class="hljs-comment"># gains 0-1</span><br>                ng = <span class="hljs-built_in">len</span>(meta)<br>                v = np.ones(ng)<br>                <span class="hljs-keyword">while</span> <span class="hljs-built_in">all</span>(v == <span class="hljs-number">1</span>):  <span class="hljs-comment"># mutate until a change occurs (prevent duplicates)</span><br>                    v = (g * (npr.random(ng) &lt; mp) * npr.randn(ng) * npr.random() * s + <span class="hljs-number">1</span>).clip(<span class="hljs-number">0.3</span>, <span class="hljs-number">3.0</span>)<br>                <span class="hljs-keyword">for</span> i, k <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(hyp.keys()):  <span class="hljs-comment"># plt.hist(v.ravel(), 300)</span><br>                    hyp[k] = <span class="hljs-built_in">float</span>(x[i + <span class="hljs-number">7</span>] * v[i])  <span class="hljs-comment"># mutate</span><br><br>            <span class="hljs-comment"># Constrain to limits</span><br>            <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> meta.items():<br>                hyp[k] = <span class="hljs-built_in">max</span>(hyp[k], v[<span class="hljs-number">1</span>])  <span class="hljs-comment"># lower limit</span><br>                hyp[k] = <span class="hljs-built_in">min</span>(hyp[k], v[<span class="hljs-number">2</span>])  <span class="hljs-comment"># upper limit</span><br>                hyp[k] = <span class="hljs-built_in">round</span>(hyp[k], <span class="hljs-number">5</span>)  <span class="hljs-comment"># significant digits</span><br><br>            <span class="hljs-comment"># Train mutation</span><br>            results = train(hyp.copy(), opt, device, callbacks)<br>            callbacks = Callbacks()<br>            <span class="hljs-comment"># Write mutation results</span><br>            print_mutation(results, hyp.copy(), save_dir, opt.bucket)<br><br>        <span class="hljs-comment"># Plot results</span><br>        plot_evolve(evolve_csv)<br>        LOGGER.info(<span class="hljs-string">f&#x27;Hyperparameter evolution finished <span class="hljs-subst">&#123;opt.evolve&#125;</span> generations\n&#x27;</span><br>                    <span class="hljs-string">f&quot;Results saved to <span class="hljs-subst">&#123;colorstr(<span class="hljs-string">&#x27;bold&#x27;</span>, save_dir)&#125;</span>\n&quot;</span><br>                    <span class="hljs-string">f&#x27;Usage example: $ python train.py --hyp <span class="hljs-subst">&#123;evolve_yaml&#125;</span>&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">**kwargs</span>):<br>    <span class="hljs-comment"># Usage: import train; train.run(data=&#x27;coco128.yaml&#x27;, imgsz=320, weights=&#x27;yolov5m.pt&#x27;)</span><br>    opt = parse_opt(<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> kwargs.items():<br>        <span class="hljs-comment"># æ„æ€æ˜¯opt.k = v</span><br>        <span class="hljs-built_in">setattr</span>(opt, k, v)<br>    main(opt)<br>    <span class="hljs-keyword">return</span> opt<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    opt = parse_opt()<br>    main(opt)<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>cv</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>yolov1</title>
    <link href="/2022/09/30/yolov1/"/>
    <url>/2022/09/30/yolov1/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¨¡å‹ä»‹ç»">æ¨¡å‹ä»‹ç»</h1><p><img src="/img/cv/image-20220930153754299.png" /></p><p><img src="/img/cv/image-20220930153824653.png" /></p><p><img src="/img/cv/image-20220930153848083.png" /></p><p><img src="/img/cv/image-20220930153904048.png" /></p><p><img src="/img/cv/image-20220930153921376.png" /></p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>cv</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>SSD</title>
    <link href="/2022/09/30/SSD/"/>
    <url>/2022/09/30/SSD/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¨¡å‹ä»‹ç»">æ¨¡å‹ä»‹ç»</h1><p><img src="/img/cv/image-20220930152818338.png" /></p><p><img src="/img/cv/image-20220930152839522.png" /></p><p><img src="/img/cv/image-20220930152851705.png" /></p><p><img src="/img/cv/image-20220930152903880.png" /></p><p><img src="/img/cv/image-20220930152918813.png" /></p><p><img src="/img/cv/image-20220930152930806.png" /></p><p><img src="/img/cv/image-20220930152941778.png" /></p><p><img src="/img/cv/image-20220930152952521.png" /></p><p><img src="/img/cv/image-20220930153004458.png" /></p><p><img src="/img/cv/image-20220930153015647.png" /></p><p><img src="/img/cv/image-20220930153028568.png" /></p><p><img src="/img/cv/image-20220930153042132.png" /></p><p><img src="/img/cv/image-20220930153054831.png" /></p><p><img src="/img/cv/image-20220930153110871.png" /></p><p><img src="/img/cv/image-20220930153121772.png" /></p><p><img src="/img/cv/image-20220930153132417.png" /></p><p><img src="/img/cv/image-20220930153142800.png" /></p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>cv</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>FPN</title>
    <link href="/2022/09/30/FPN/"/>
    <url>/2022/09/30/FPN/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¨¡å‹ä»‹ç»">æ¨¡å‹ä»‹ç»</h1><p><img src="/img/cv/image-20220930111912244.png" /></p><p><img src="/img/cv/image-20220930111926838.png" /></p><p><img src="/img/cv/image-20220930111940668.png" /></p><p><img src="/img/cv/image-20220930112000674.png" /></p><p><img src="/img/cv/image-20220930112024501.png" /></p><p><img src="/img/cv/image-20220930112036794.png" /></p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>cv</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Faster_R-CNN</title>
    <link href="/2022/09/30/Faster-R-CNN/"/>
    <url>/2022/09/30/Faster-R-CNN/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¨¡å‹ä»‹ç»">æ¨¡å‹ä»‹ç»</h1><p><img src="/img/cv/image-20220930104009662.png" /></p><p><img src="/img/cv/image-20220930104029226.png" /></p><p><img src="/img/cv/image-20220930104047080.png" /></p><p><img src="/img/cv/image-20220930104101860.png" /></p><p><img src="/img/cv/image-20220930104253294.png" /></p><p><img src="/img/cv/image-20220930104309535.png" /></p><p><img src="/img/cv/image-20220930104322156.png" /></p><p><img src="/img/cv/image-20220930104332006.png" /></p><p><img src="/img/cv/image-20220930104345120.png" /></p><p><img src="/img/cv/image-20220930104356421.png" /></p><p><img src="/img/cv/image-20220930104409007.png" /></p><p><img src="/img/cv/image-20220930104420565.png" /></p><p><img src="/img/cv/image-20220930104433453.png" /></p><p><img src="/img/cv/image-20220930104446017.png" /></p><p><img src="/img/cv/image-20220930104500570.png" /></p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>cv</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Fast_R-CNN</title>
    <link href="/2022/09/30/Fast-R-CNN/"/>
    <url>/2022/09/30/Fast-R-CNN/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¨¡å‹ä»‹ç»">æ¨¡å‹ä»‹ç»</h1><p><img src="/img/cv/image-20220930103138705.png" /></p><p><img src="/img/cv/image-20220930103151991.png" /></p><p><img src="/img/cv/image-20220930103204019.png" /></p><p><img src="/img/cv/image-20220930103243703.png" /></p><p><img src="/img/cv/image-20220930103316912.png" /></p><p><img src="/img/cv/image-20220930103331647.png" /></p><p><img src="/img/cv/image-20220930103413400.png" /></p><p><img src="/img/cv/image-20220930103431178.png" /></p><p><img src="/img/cv/image-20220930103445275.png" /></p><p><img src="/img/cv/image-20220930103507638.png" /></p><p><img src="/img/cv/image-20220930103520918.png" /></p><p><img src="/img/cv/image-20220930103548664.png" /></p><p><img src="/img/cv/image-20220930103600909.png" /></p><p><img src="/img/cv/image-20220930103638505.png" /></p><p><img src="/img/cv/image-20220930103656760.png" /></p><p><img src="/img/cv/image-20220930103721592.png" /></p><p><img src="/img/cv/image-20220930103736379.png" /></p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>cv</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>RCNN</title>
    <link href="/2022/09/29/RCNN/"/>
    <url>/2022/09/29/RCNN/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¨¡å‹ä»‹ç»">æ¨¡å‹ä»‹ç»</h1><p><img src="/img/cv/image-20220929174947399.png" /></p><p><img src="/img/cv/image-20220929174959830.png" /></p><p><img src="/img/cv/image-20220929175012228.png" /></p><p><img src="/img/cv/image-20220929175024811.png" /></p><p><img src="/img/cv/image-20220929175035980.png" /></p><p><img src="/img/cv/image-20220929175055640.png" /></p><p><img src="/img/cv/image-20220929175116843.png" /></p><p><img src="/img/cv/image-20220929175137830.png" /></p><p><img src="/img/cv/image-20220929175155293.png" /></p><p><img src="/img/cv/image-20220929175207362.png" /></p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>cv</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>GoogleNet</title>
    <link href="/2022/09/29/GoogleNet/"/>
    <url>/2022/09/29/GoogleNet/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¨¡å‹ä»‹ç»">æ¨¡å‹ä»‹ç»</h1><p><img src="/img/cv/image-20220929165102079.png" /></p><p><img src="/img/cv/image-20220929165115906.png" /></p><p><img src="/img/cv/image-20220929165128922.png" /></p><p><img src="/img/cv/image-20220929165145364.png" /></p><p><img src="/img/cv/image-20220929165157614.png" /></p><p><img src="/img/cv/image-20220929165210033.png" /></p><p><img src="/img/cv/image-20220929165223735.png" /></p><h1 id="æ¨¡å‹ä»£ç ">æ¨¡å‹ä»£ç </h1><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">GoogLeNet</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_classes=<span class="hljs-number">1000</span>, aux_logits=<span class="hljs-literal">True</span>, init_weights=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-built_in">super</span>(GoogLeNet, self).__init__()<br>        self.aux_logits = aux_logits<br><br>        self.conv1 = BasicConv2d(<span class="hljs-number">3</span>, <span class="hljs-number">64</span>, kernel_size=<span class="hljs-number">7</span>, stride=<span class="hljs-number">2</span>, padding=<span class="hljs-number">3</span>)<br>        self.maxpool1 = nn.MaxPool2d(<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>, ceil_mode=<span class="hljs-literal">True</span>)<br><br>        self.conv2 = BasicConv2d(<span class="hljs-number">64</span>, <span class="hljs-number">64</span>, kernel_size=<span class="hljs-number">1</span>)<br>        self.conv3 = BasicConv2d(<span class="hljs-number">64</span>, <span class="hljs-number">192</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>)<br>        self.maxpool2 = nn.MaxPool2d(<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>, ceil_mode=<span class="hljs-literal">True</span>)<br><br>        self.inception3a = Inception(<span class="hljs-number">192</span>, <span class="hljs-number">64</span>, <span class="hljs-number">96</span>, <span class="hljs-number">128</span>, <span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>)<br>        self.inception3b = Inception(<span class="hljs-number">256</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">192</span>, <span class="hljs-number">32</span>, <span class="hljs-number">96</span>, <span class="hljs-number">64</span>)<br>        self.maxpool3 = nn.MaxPool2d(<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>, ceil_mode=<span class="hljs-literal">True</span>)<br><br>        self.inception4a = Inception(<span class="hljs-number">480</span>, <span class="hljs-number">192</span>, <span class="hljs-number">96</span>, <span class="hljs-number">208</span>, <span class="hljs-number">16</span>, <span class="hljs-number">48</span>, <span class="hljs-number">64</span>)<br>        self.inception4b = Inception(<span class="hljs-number">512</span>, <span class="hljs-number">160</span>, <span class="hljs-number">112</span>, <span class="hljs-number">224</span>, <span class="hljs-number">24</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>)<br>        self.inception4c = Inception(<span class="hljs-number">512</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>, <span class="hljs-number">24</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>)<br>        self.inception4d = Inception(<span class="hljs-number">512</span>, <span class="hljs-number">112</span>, <span class="hljs-number">144</span>, <span class="hljs-number">288</span>, <span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>)<br>        self.inception4e = Inception(<span class="hljs-number">528</span>, <span class="hljs-number">256</span>, <span class="hljs-number">160</span>, <span class="hljs-number">320</span>, <span class="hljs-number">32</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>)<br>        self.maxpool4 = nn.MaxPool2d(<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>, ceil_mode=<span class="hljs-literal">True</span>)<br><br>        self.inception5a = Inception(<span class="hljs-number">832</span>, <span class="hljs-number">256</span>, <span class="hljs-number">160</span>, <span class="hljs-number">320</span>, <span class="hljs-number">32</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>)<br>        self.inception5b = Inception(<span class="hljs-number">832</span>, <span class="hljs-number">384</span>, <span class="hljs-number">192</span>, <span class="hljs-number">384</span>, <span class="hljs-number">48</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>)<br><br>        <span class="hljs-keyword">if</span> self.aux_logits:<br>            self.aux1 = InceptionAux(<span class="hljs-number">512</span>, num_classes)<br>            self.aux2 = InceptionAux(<span class="hljs-number">528</span>, num_classes)<br><br>        self.avgpool = nn.AdaptiveAvgPool2d((<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))<br>        self.dropout = nn.Dropout(<span class="hljs-number">0.4</span>)<br>        self.fc = nn.Linear(<span class="hljs-number">1024</span>, num_classes)<br>        <span class="hljs-keyword">if</span> init_weights:<br>            self._initialize_weights()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        <span class="hljs-comment"># N x 3 x 224 x 224</span><br>        x = self.conv1(x)<br>        <span class="hljs-comment"># N x 64 x 112 x 112</span><br>        x = self.maxpool1(x)<br>        <span class="hljs-comment"># N x 64 x 56 x 56</span><br>        x = self.conv2(x)<br>        <span class="hljs-comment"># N x 64 x 56 x 56</span><br>        x = self.conv3(x)<br>        <span class="hljs-comment"># N x 192 x 56 x 56</span><br>        x = self.maxpool2(x)<br><br>        <span class="hljs-comment"># N x 192 x 28 x 28</span><br>        x = self.inception3a(x)<br>        <span class="hljs-comment"># N x 256 x 28 x 28</span><br>        x = self.inception3b(x)<br>        <span class="hljs-comment"># N x 480 x 28 x 28</span><br>        x = self.maxpool3(x)<br>        <span class="hljs-comment"># N x 480 x 14 x 14</span><br>        x = self.inception4a(x)<br>        <span class="hljs-comment"># N x 512 x 14 x 14</span><br>        <span class="hljs-keyword">if</span> self.training <span class="hljs-keyword">and</span> self.aux_logits:    <span class="hljs-comment"># eval model lose this layer</span><br>            aux1 = self.aux1(x)<br><br>        x = self.inception4b(x)<br>        <span class="hljs-comment"># N x 512 x 14 x 14</span><br>        x = self.inception4c(x)<br>        <span class="hljs-comment"># N x 512 x 14 x 14</span><br>        x = self.inception4d(x)<br>        <span class="hljs-comment"># N x 528 x 14 x 14</span><br>        <span class="hljs-keyword">if</span> self.training <span class="hljs-keyword">and</span> self.aux_logits:    <span class="hljs-comment"># eval model lose this layer</span><br>            aux2 = self.aux2(x)<br><br>        x = self.inception4e(x)<br>        <span class="hljs-comment"># N x 832 x 14 x 14</span><br>        x = self.maxpool4(x)<br>        <span class="hljs-comment"># N x 832 x 7 x 7</span><br>        x = self.inception5a(x)<br>        <span class="hljs-comment"># N x 832 x 7 x 7</span><br>        x = self.inception5b(x)<br>        <span class="hljs-comment"># N x 1024 x 7 x 7</span><br><br>        x = self.avgpool(x)<br>        <span class="hljs-comment"># N x 1024 x 1 x 1</span><br>        x = torch.flatten(x, <span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># N x 1024</span><br>        x = self.dropout(x)<br>        x = self.fc(x)<br>        <span class="hljs-comment"># N x 1000 (num_classes)</span><br>        <span class="hljs-keyword">if</span> self.training <span class="hljs-keyword">and</span> self.aux_logits:   <span class="hljs-comment"># eval model lose this layer</span><br>            <span class="hljs-keyword">return</span> x, aux2, aux1<br>        <span class="hljs-keyword">return</span> x<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_initialize_weights</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> self.modules():<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m, nn.Conv2d):<br>                nn.init.kaiming_normal_(m.weight, mode=<span class="hljs-string">&#x27;fan_out&#x27;</span>, nonlinearity=<span class="hljs-string">&#x27;relu&#x27;</span>)<br>                <span class="hljs-keyword">if</span> m.bias <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                    nn.init.constant_(m.bias, <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(m, nn.Linear):<br>                nn.init.normal_(m.weight, <span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>)<br>                nn.init.constant_(m.bias, <span class="hljs-number">0</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Inception</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_channels, ch1x1, ch3x3red, ch3x3, ch5x5red, ch5x5, pool_proj</span>):<br>        <span class="hljs-built_in">super</span>(Inception, self).__init__()<br><br>        self.branch1 = BasicConv2d(in_channels, ch1x1, kernel_size=<span class="hljs-number">1</span>)<br><br>        self.branch2 = nn.Sequential(<br>            BasicConv2d(in_channels, ch3x3red, kernel_size=<span class="hljs-number">1</span>),<br>            BasicConv2d(ch3x3red, ch3x3, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>)   <span class="hljs-comment"># ä¿è¯è¾“å‡ºå¤§å°ç­‰äºè¾“å…¥å¤§å°</span><br>        )<br><br>        self.branch3 = nn.Sequential(<br>            BasicConv2d(in_channels, ch5x5red, kernel_size=<span class="hljs-number">1</span>),<br>            <span class="hljs-comment"># åœ¨å®˜æ–¹çš„å®ç°ä¸­ï¼Œå…¶å®æ˜¯3x3çš„kernelå¹¶ä¸æ˜¯5x5ï¼Œè¿™é‡Œæˆ‘ä¹Ÿæ‡’å¾—æ”¹äº†ï¼Œå…·ä½“å¯ä»¥å‚è€ƒä¸‹é¢çš„issue</span><br>            <span class="hljs-comment"># Please see https://github.com/pytorch/vision/issues/906 for details.</span><br>            BasicConv2d(ch5x5red, ch5x5, kernel_size=<span class="hljs-number">5</span>, padding=<span class="hljs-number">2</span>)   <span class="hljs-comment"># ä¿è¯è¾“å‡ºå¤§å°ç­‰äºè¾“å…¥å¤§å°</span><br>        )<br><br>        self.branch4 = nn.Sequential(<br>            nn.MaxPool2d(kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">1</span>),<br>            BasicConv2d(in_channels, pool_proj, kernel_size=<span class="hljs-number">1</span>)<br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        branch1 = self.branch1(x)<br>        branch2 = self.branch2(x)<br>        branch3 = self.branch3(x)<br>        branch4 = self.branch4(x)<br><br>        outputs = [branch1, branch2, branch3, branch4]<br>        <span class="hljs-keyword">return</span> torch.cat(outputs, <span class="hljs-number">1</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">InceptionAux</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_channels, num_classes</span>):<br>        <span class="hljs-built_in">super</span>(InceptionAux, self).__init__()<br>        self.averagePool = nn.AvgPool2d(kernel_size=<span class="hljs-number">5</span>, stride=<span class="hljs-number">3</span>)<br>        self.conv = BasicConv2d(in_channels, <span class="hljs-number">128</span>, kernel_size=<span class="hljs-number">1</span>)  <span class="hljs-comment"># output[batch, 128, 4, 4]</span><br><br>        self.fc1 = nn.Linear(<span class="hljs-number">2048</span>, <span class="hljs-number">1024</span>)<br>        self.fc2 = nn.Linear(<span class="hljs-number">1024</span>, num_classes)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        <span class="hljs-comment"># aux1: N x 512 x 14 x 14, aux2: N x 528 x 14 x 14</span><br>        x = self.averagePool(x)<br>        <span class="hljs-comment"># aux1: N x 512 x 4 x 4, aux2: N x 528 x 4 x 4</span><br>        x = self.conv(x)<br>        <span class="hljs-comment"># N x 128 x 4 x 4</span><br>        x = torch.flatten(x, <span class="hljs-number">1</span>)<br>        x = F.dropout(x, <span class="hljs-number">0.5</span>, training=self.training)<br>        <span class="hljs-comment"># N x 2048</span><br>        x = F.relu(self.fc1(x), inplace=<span class="hljs-literal">True</span>)<br>        x = F.dropout(x, <span class="hljs-number">0.5</span>, training=self.training)<br>        <span class="hljs-comment"># N x 1024</span><br>        x = self.fc2(x)<br>        <span class="hljs-comment"># N x num_classes</span><br>        <span class="hljs-keyword">return</span> x<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicConv2d</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_channels, out_channels, **kwargs</span>):<br>        <span class="hljs-built_in">super</span>(BasicConv2d, self).__init__()<br>        self.conv = nn.Conv2d(in_channels, out_channels, **kwargs)<br>        self.relu = nn.ReLU(inplace=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        x = self.conv(x)<br>        x = self.relu(x)<br>        <span class="hljs-keyword">return</span> x<br></code></pre></div></td></tr></table></figure><h1 id="è®­ç»ƒä»£ç ">è®­ç»ƒä»£ç </h1><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms, datasets<br><span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><br><span class="hljs-keyword">from</span> model <span class="hljs-keyword">import</span> GoogLeNet<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    device = torch.device(<span class="hljs-string">&quot;cuda:0&quot;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;cpu&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;using &#123;&#125; device.&quot;</span>.<span class="hljs-built_in">format</span>(device))<br><br>    data_transform = &#123;<br>        <span class="hljs-string">&quot;train&quot;</span>: transforms.Compose([transforms.RandomResizedCrop(<span class="hljs-number">224</span>),<br>                                     transforms.RandomHorizontalFlip(),<br>                                     transforms.ToTensor(),<br>                                     transforms.Normalize((<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>), (<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>))]),<br>        <span class="hljs-string">&quot;val&quot;</span>: transforms.Compose([transforms.Resize((<span class="hljs-number">224</span>, <span class="hljs-number">224</span>)),<br>                                   transforms.ToTensor(),<br>                                   transforms.Normalize((<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>), (<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>))])&#125;<br><br>    data_root = os.path.abspath(os.path.join(os.getcwd(), <span class="hljs-string">&quot;../..&quot;</span>))  <span class="hljs-comment"># get data root path</span><br>    image_path = os.path.join(data_root, <span class="hljs-string">&quot;data_set&quot;</span>, <span class="hljs-string">&quot;flower_data&quot;</span>)  <span class="hljs-comment"># flower data set path</span><br>    <span class="hljs-keyword">assert</span> os.path.exists(image_path), <span class="hljs-string">&quot;&#123;&#125; path does not exist.&quot;</span>.<span class="hljs-built_in">format</span>(image_path)<br>    train_dataset = datasets.ImageFolder(root=os.path.join(image_path, <span class="hljs-string">&quot;train&quot;</span>),<br>                                         transform=data_transform[<span class="hljs-string">&quot;train&quot;</span>])<br>    train_num = <span class="hljs-built_in">len</span>(train_dataset)<br><br>    <span class="hljs-comment"># &#123;&#x27;daisy&#x27;:0, &#x27;dandelion&#x27;:1, &#x27;roses&#x27;:2, &#x27;sunflower&#x27;:3, &#x27;tulips&#x27;:4&#125;</span><br>    flower_list = train_dataset.class_to_idx<br>    cla_dict = <span class="hljs-built_in">dict</span>((val, key) <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">in</span> flower_list.items())<br>    <span class="hljs-comment"># write dict into json file</span><br>    json_str = json.dumps(cla_dict, indent=<span class="hljs-number">4</span>)<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;class_indices.json&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> json_file:<br>        json_file.write(json_str)<br><br>    batch_size = <span class="hljs-number">32</span><br>    nw = <span class="hljs-built_in">min</span>([os.cpu_count(), batch_size <span class="hljs-keyword">if</span> batch_size &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>, <span class="hljs-number">8</span>])  <span class="hljs-comment"># number of workers</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Using &#123;&#125; dataloader workers every process&#x27;</span>.<span class="hljs-built_in">format</span>(nw))<br><br>    train_loader = torch.utils.data.DataLoader(train_dataset,<br>                                               batch_size=batch_size, shuffle=<span class="hljs-literal">True</span>,<br>                                               num_workers=nw)<br><br>    validate_dataset = datasets.ImageFolder(root=os.path.join(image_path, <span class="hljs-string">&quot;val&quot;</span>),<br>                                            transform=data_transform[<span class="hljs-string">&quot;val&quot;</span>])<br>    val_num = <span class="hljs-built_in">len</span>(validate_dataset)<br>    validate_loader = torch.utils.data.DataLoader(validate_dataset,<br>                                                  batch_size=batch_size, shuffle=<span class="hljs-literal">False</span>,<br>                                                  num_workers=nw)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;using &#123;&#125; images for training, &#123;&#125; images for validation.&quot;</span>.<span class="hljs-built_in">format</span>(train_num,<br>                                                                           val_num))<br><br>    <span class="hljs-comment"># test_data_iter = iter(validate_loader)</span><br>    <span class="hljs-comment"># test_image, test_label = test_data_iter.next()</span><br><br>    net = GoogLeNet(num_classes=<span class="hljs-number">5</span>, aux_logits=<span class="hljs-literal">True</span>, init_weights=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># å¦‚æœè¦ä½¿ç”¨å®˜æ–¹çš„é¢„è®­ç»ƒæƒé‡ï¼Œæ³¨æ„æ˜¯å°†æƒé‡è½½å…¥å®˜æ–¹çš„æ¨¡å‹ï¼Œä¸æ˜¯æˆ‘ä»¬è‡ªå·±å®ç°çš„æ¨¡å‹</span><br>    <span class="hljs-comment"># å®˜æ–¹çš„æ¨¡å‹ä¸­ä½¿ç”¨äº†bnå±‚ä»¥åŠæ”¹äº†ä¸€äº›å‚æ•°ï¼Œä¸èƒ½æ··ç”¨</span><br>    <span class="hljs-comment"># import torchvision</span><br>    <span class="hljs-comment"># net = torchvision.models.googlenet(num_classes=5)</span><br>    <span class="hljs-comment"># model_dict = net.state_dict()</span><br>    <span class="hljs-comment"># # é¢„è®­ç»ƒæƒé‡ä¸‹è½½åœ°å€: https://download.pytorch.org/models/googlenet-1378be20.pth</span><br>    <span class="hljs-comment"># pretrain_model = torch.load(&quot;googlenet.pth&quot;)</span><br>    <span class="hljs-comment"># del_list = [&quot;aux1.fc2.weight&quot;, &quot;aux1.fc2.bias&quot;,</span><br>    <span class="hljs-comment">#             &quot;aux2.fc2.weight&quot;, &quot;aux2.fc2.bias&quot;,</span><br>    <span class="hljs-comment">#             &quot;fc.weight&quot;, &quot;fc.bias&quot;]</span><br>    <span class="hljs-comment"># pretrain_dict = &#123;k: v for k, v in pretrain_model.items() if k not in del_list&#125;</span><br>    <span class="hljs-comment"># model_dict.update(pretrain_dict)</span><br>    <span class="hljs-comment"># net.load_state_dict(model_dict)</span><br>    net.to(device)<br>    loss_function = nn.CrossEntropyLoss()<br>    optimizer = optim.Adam(net.parameters(), lr=<span class="hljs-number">0.0003</span>)<br><br>    epochs = <span class="hljs-number">30</span><br>    best_acc = <span class="hljs-number">0.0</span><br>    save_path = <span class="hljs-string">&#x27;./googleNet.pth&#x27;</span><br>    train_steps = <span class="hljs-built_in">len</span>(train_loader)<br>    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(epochs):<br>        <span class="hljs-comment"># train</span><br>        net.train()<br>        running_loss = <span class="hljs-number">0.0</span><br>        train_bar = tqdm(train_loader, file=sys.stdout)<br>        <span class="hljs-keyword">for</span> step, data <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_bar):<br>            images, labels = data<br>            optimizer.zero_grad()<br>            logits, aux_logits2, aux_logits1 = net(images.to(device))<br>            loss0 = loss_function(logits, labels.to(device))<br>            loss1 = loss_function(aux_logits1, labels.to(device))<br>            loss2 = loss_function(aux_logits2, labels.to(device))<br>            loss = loss0 + loss1 * <span class="hljs-number">0.3</span> + loss2 * <span class="hljs-number">0.3</span><br>            loss.backward()<br>            optimizer.step()<br><br>            <span class="hljs-comment"># print statistics</span><br>            running_loss += loss.item()<br><br>            train_bar.desc = <span class="hljs-string">&quot;train epoch[&#123;&#125;/&#123;&#125;] loss:&#123;:.3f&#125;&quot;</span>.<span class="hljs-built_in">format</span>(epoch + <span class="hljs-number">1</span>,<br>                                                                     epochs,<br>                                                                     loss)<br><br>        <span class="hljs-comment"># validate</span><br>        net.<span class="hljs-built_in">eval</span>()<br>        acc = <span class="hljs-number">0.0</span>  <span class="hljs-comment"># accumulate accurate number / epoch</span><br>        <span class="hljs-keyword">with</span> torch.no_grad():<br>            val_bar = tqdm(validate_loader, file=sys.stdout)<br>            <span class="hljs-keyword">for</span> val_data <span class="hljs-keyword">in</span> val_bar:<br>                val_images, val_labels = val_data<br>                outputs = net(val_images.to(device))  <span class="hljs-comment"># eval model only have last output layer</span><br>                predict_y = torch.<span class="hljs-built_in">max</span>(outputs, dim=<span class="hljs-number">1</span>)[<span class="hljs-number">1</span>]<br>                acc += torch.eq(predict_y, val_labels.to(device)).<span class="hljs-built_in">sum</span>().item()<br><br>        val_accurate = acc / val_num<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[epoch %d] train_loss: %.3f  val_accuracy: %.3f&#x27;</span> %<br>              (epoch + <span class="hljs-number">1</span>, running_loss / train_steps, val_accurate))<br><br>        <span class="hljs-keyword">if</span> val_accurate &gt; best_acc:<br>            best_acc = val_accurate<br>            torch.save(net.state_dict(), save_path)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Finished Training&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()\<br></code></pre></div></td></tr></table></figure><h1 id="é¢„æµ‹ä»£ç ">é¢„æµ‹ä»£ç </h1><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><br><span class="hljs-keyword">from</span> model <span class="hljs-keyword">import</span> GoogLeNet<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    device = torch.device(<span class="hljs-string">&quot;cuda:0&quot;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;cpu&quot;</span>)<br><br>    data_transform = transforms.Compose(<br>        [transforms.Resize((<span class="hljs-number">224</span>, <span class="hljs-number">224</span>)),<br>         transforms.ToTensor(),<br>         transforms.Normalize((<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>), (<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>))])<br><br>    <span class="hljs-comment"># load image</span><br>    img_path = <span class="hljs-string">&quot;../tulip.jpg&quot;</span><br>    <span class="hljs-keyword">assert</span> os.path.exists(img_path), <span class="hljs-string">&quot;file: &#x27;&#123;&#125;&#x27; dose not exist.&quot;</span>.<span class="hljs-built_in">format</span>(img_path)<br>    img = Image.<span class="hljs-built_in">open</span>(img_path)<br>    plt.imshow(img)<br>    <span class="hljs-comment"># [N, C, H, W]</span><br>    img = data_transform(img)<br>    <span class="hljs-comment"># expand batch dimension</span><br>    img = torch.unsqueeze(img, dim=<span class="hljs-number">0</span>)<br><br>    <span class="hljs-comment"># read class_indict</span><br>    json_path = <span class="hljs-string">&#x27;./class_indices.json&#x27;</span><br>    <span class="hljs-keyword">assert</span> os.path.exists(json_path), <span class="hljs-string">&quot;file: &#x27;&#123;&#125;&#x27; dose not exist.&quot;</span>.<span class="hljs-built_in">format</span>(json_path)<br><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(json_path, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> f:<br>        class_indict = json.load(f)<br><br>    <span class="hljs-comment"># create model</span><br>    model = GoogLeNet(num_classes=<span class="hljs-number">5</span>, aux_logits=<span class="hljs-literal">False</span>).to(device)<br><br>    <span class="hljs-comment"># load model weights</span><br>    weights_path = <span class="hljs-string">&quot;./googleNet.pth&quot;</span><br>    <span class="hljs-keyword">assert</span> os.path.exists(weights_path), <span class="hljs-string">&quot;file: &#x27;&#123;&#125;&#x27; dose not exist.&quot;</span>.<span class="hljs-built_in">format</span>(weights_path)<br>    missing_keys, unexpected_keys = model.load_state_dict(torch.load(weights_path, map_location=device),<br>                                                          strict=<span class="hljs-literal">False</span>)<br><br>    model.<span class="hljs-built_in">eval</span>()<br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-comment"># predict class</span><br>        output = torch.squeeze(model(img.to(device))).cpu()<br>        predict = torch.softmax(output, dim=<span class="hljs-number">0</span>)<br>        predict_cla = torch.argmax(predict).numpy()<br><br>    print_res = <span class="hljs-string">&quot;class: &#123;&#125;   prob: &#123;:.3&#125;&quot;</span>.<span class="hljs-built_in">format</span>(class_indict[<span class="hljs-built_in">str</span>(predict_cla)],<br>                                                 predict[predict_cla].numpy())<br>    plt.title(print_res)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(predict)):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;class: &#123;:10&#125;   prob: &#123;:.3&#125;&quot;</span>.<span class="hljs-built_in">format</span>(class_indict[<span class="hljs-built_in">str</span>(i)],<br>                                                  predict[i].numpy()))<br>    plt.show()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>cv</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>AlexNet</title>
    <link href="/2022/09/29/AlexNet/"/>
    <url>/2022/09/29/AlexNet/</url>
    
    <content type="html"><![CDATA[<h1 id="ç½‘ç»œä»‹ç»">ç½‘ç»œä»‹ç»</h1><p><img src="/img/cv/image-20220929160500941.png" /></p><p><img src="/img/cv/image-20220929160537393.png" /></p><p><img src="/img/cv/image-20220929160556682.png" /></p><p><img src="/img/cv/image-20220929160608567.png" /></p><ul><li>ä½¿ç”¨äº†ä¸Šä¸‹ä¸¤å±‚çš„ç»“æ„ï¼Œä¸Šä¸‹ä¸¤å±‚ç»“æ„ä¸€æ ·</li></ul><p><img src="/img/cv/image-20220929160655961.png" /></p><p><img src="/img/cv/image-20220929160708562.png" /></p><h1 id="æ¨¡å‹ä»£ç ">æ¨¡å‹ä»£ç </h1><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AlexNet</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_classes=<span class="hljs-number">1000</span>, init_weights=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-built_in">super</span>(AlexNet, self).__init__()<br>        self.features = nn.Sequential(<br>            nn.Conv2d(<span class="hljs-number">3</span>, <span class="hljs-number">48</span>, kernel_size=<span class="hljs-number">11</span>, stride=<span class="hljs-number">4</span>, padding=<span class="hljs-number">2</span>),  <span class="hljs-comment"># input[3, 224, 224]  output[48, 55, 55]</span><br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.MaxPool2d(kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>),                  <span class="hljs-comment"># output[48, 27, 27]</span><br>            nn.Conv2d(<span class="hljs-number">48</span>, <span class="hljs-number">128</span>, kernel_size=<span class="hljs-number">5</span>, padding=<span class="hljs-number">2</span>),           <span class="hljs-comment"># output[128, 27, 27]</span><br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.MaxPool2d(kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>),                  <span class="hljs-comment"># output[128, 13, 13]</span><br>            nn.Conv2d(<span class="hljs-number">128</span>, <span class="hljs-number">192</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>),          <span class="hljs-comment"># output[192, 13, 13]</span><br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.Conv2d(<span class="hljs-number">192</span>, <span class="hljs-number">192</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>),          <span class="hljs-comment"># output[192, 13, 13]</span><br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.Conv2d(<span class="hljs-number">192</span>, <span class="hljs-number">128</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>),          <span class="hljs-comment"># output[128, 13, 13]</span><br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.MaxPool2d(kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>),                  <span class="hljs-comment"># output[128, 6, 6]</span><br>        )<br>        self.classifier = nn.Sequential(<br>            nn.Dropout(p=<span class="hljs-number">0.5</span>),<br>            nn.Linear(<span class="hljs-number">128</span> * <span class="hljs-number">6</span> * <span class="hljs-number">6</span>, <span class="hljs-number">2048</span>),<br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.Dropout(p=<span class="hljs-number">0.5</span>),<br>            nn.Linear(<span class="hljs-number">2048</span>, <span class="hljs-number">2048</span>),<br>            nn.ReLU(inplace=<span class="hljs-literal">True</span>),<br>            nn.Linear(<span class="hljs-number">2048</span>, num_classes),<br>        )<br>        <span class="hljs-keyword">if</span> init_weights:<br>            self._initialize_weights()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        x = self.features(x)<br>        x = torch.flatten(x, start_dim=<span class="hljs-number">1</span>)<br>        x = self.classifier(x)<br>        <span class="hljs-keyword">return</span> x<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_initialize_weights</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> self.modules():<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m, nn.Conv2d):<br>                nn.init.kaiming_normal_(m.weight, mode=<span class="hljs-string">&#x27;fan_out&#x27;</span>, nonlinearity=<span class="hljs-string">&#x27;relu&#x27;</span>)<br>                <span class="hljs-keyword">if</span> m.bias <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                    nn.init.constant_(m.bias, <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(m, nn.Linear):<br>                nn.init.normal_(m.weight, <span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>)<br>                nn.init.constant_(m.bias, <span class="hljs-number">0</span>)<br></code></pre></div></td></tr></table></figure><h1 id="è®­ç»ƒä»£ç ">è®­ç»ƒä»£ç </h1><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms, datasets, utils<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><br><span class="hljs-keyword">from</span> model <span class="hljs-keyword">import</span> AlexNet<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    device = torch.device(<span class="hljs-string">&quot;cuda:0&quot;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;cpu&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;using &#123;&#125; device.&quot;</span>.<span class="hljs-built_in">format</span>(device))<br><br>    data_transform = &#123;<br>        <span class="hljs-string">&quot;train&quot;</span>: transforms.Compose([transforms.RandomResizedCrop(<span class="hljs-number">224</span>),<br>                                     transforms.RandomHorizontalFlip(),<br>                                     transforms.ToTensor(),<br>                                     transforms.Normalize((<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>), (<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>))]),<br>        <span class="hljs-string">&quot;val&quot;</span>: transforms.Compose([transforms.Resize((<span class="hljs-number">224</span>, <span class="hljs-number">224</span>)),  <span class="hljs-comment"># cannot 224, must (224, 224)</span><br>                                   transforms.ToTensor(),<br>                                   transforms.Normalize((<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>), (<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>))])&#125;<br><br>    data_root = os.path.abspath(os.path.join(os.getcwd(), <span class="hljs-string">&quot;../..&quot;</span>))  <span class="hljs-comment"># get data root path</span><br>    image_path = os.path.join(data_root, <span class="hljs-string">&quot;data_set&quot;</span>, <span class="hljs-string">&quot;flower_data&quot;</span>)  <span class="hljs-comment"># flower data set path</span><br>    <span class="hljs-keyword">assert</span> os.path.exists(image_path), <span class="hljs-string">&quot;&#123;&#125; path does not exist.&quot;</span>.<span class="hljs-built_in">format</span>(image_path)<br>    train_dataset = datasets.ImageFolder(root=os.path.join(image_path, <span class="hljs-string">&quot;train&quot;</span>),<br>                                         transform=data_transform[<span class="hljs-string">&quot;train&quot;</span>])<br>    train_num = <span class="hljs-built_in">len</span>(train_dataset)<br><br>    <span class="hljs-comment"># &#123;&#x27;daisy&#x27;:0, &#x27;dandelion&#x27;:1, &#x27;roses&#x27;:2, &#x27;sunflower&#x27;:3, &#x27;tulips&#x27;:4&#125;</span><br>    flower_list = train_dataset.class_to_idx<br>    cla_dict = <span class="hljs-built_in">dict</span>((val, key) <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">in</span> flower_list.items())<br>    <span class="hljs-comment"># write dict into json file</span><br>    json_str = json.dumps(cla_dict, indent=<span class="hljs-number">4</span>)<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;class_indices.json&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> json_file:<br>        json_file.write(json_str)<br><br>    batch_size = <span class="hljs-number">32</span><br>    nw = <span class="hljs-built_in">min</span>([os.cpu_count(), batch_size <span class="hljs-keyword">if</span> batch_size &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>, <span class="hljs-number">8</span>])  <span class="hljs-comment"># number of workers</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Using &#123;&#125; dataloader workers every process&#x27;</span>.<span class="hljs-built_in">format</span>(nw))<br><br>    train_loader = torch.utils.data.DataLoader(train_dataset,<br>                                               batch_size=batch_size, shuffle=<span class="hljs-literal">True</span>,<br>                                               num_workers=nw)<br><br>    validate_dataset = datasets.ImageFolder(root=os.path.join(image_path, <span class="hljs-string">&quot;val&quot;</span>),<br>                                            transform=data_transform[<span class="hljs-string">&quot;val&quot;</span>])<br>    val_num = <span class="hljs-built_in">len</span>(validate_dataset)<br>    validate_loader = torch.utils.data.DataLoader(validate_dataset,<br>                                                  batch_size=<span class="hljs-number">4</span>, shuffle=<span class="hljs-literal">False</span>,<br>                                                  num_workers=nw)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;using &#123;&#125; images for training, &#123;&#125; images for validation.&quot;</span>.<span class="hljs-built_in">format</span>(train_num,<br>                                                                           val_num))<br>    <span class="hljs-comment"># test_data_iter = iter(validate_loader)</span><br>    <span class="hljs-comment"># test_image, test_label = test_data_iter.next()</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># def imshow(img):</span><br>    <span class="hljs-comment">#     img = img / 2 + 0.5  # unnormalize</span><br>    <span class="hljs-comment">#     npimg = img.numpy()</span><br>    <span class="hljs-comment">#     plt.imshow(np.transpose(npimg, (1, 2, 0)))</span><br>    <span class="hljs-comment">#     plt.show()</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># print(&#x27; &#x27;.join(&#x27;%5s&#x27; % cla_dict[test_label[j].item()] for j in range(4)))</span><br>    <span class="hljs-comment"># imshow(utils.make_grid(test_image))</span><br><br>    net = AlexNet(num_classes=<span class="hljs-number">5</span>, init_weights=<span class="hljs-literal">True</span>)<br><br>    net.to(device)<br>    loss_function = nn.CrossEntropyLoss()<br>    <span class="hljs-comment"># pata = list(net.parameters())</span><br>    optimizer = optim.Adam(net.parameters(), lr=<span class="hljs-number">0.0002</span>)<br><br>    epochs = <span class="hljs-number">10</span><br>    save_path = <span class="hljs-string">&#x27;./AlexNet.pth&#x27;</span><br>    best_acc = <span class="hljs-number">0.0</span><br>    train_steps = <span class="hljs-built_in">len</span>(train_loader)<br>    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(epochs):<br>        <span class="hljs-comment"># train</span><br>        net.train()<br>        running_loss = <span class="hljs-number">0.0</span><br>        train_bar = tqdm(train_loader, file=sys.stdout)<br>        <span class="hljs-keyword">for</span> step, data <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_bar):<br>            images, labels = data<br>            optimizer.zero_grad()<br>            outputs = net(images.to(device))<br>            loss = loss_function(outputs, labels.to(device))<br>            loss.backward()<br>            optimizer.step()<br><br>            <span class="hljs-comment"># print statistics</span><br>            running_loss += loss.item()<br><br>            train_bar.desc = <span class="hljs-string">&quot;train epoch[&#123;&#125;/&#123;&#125;] loss:&#123;:.3f&#125;&quot;</span>.<span class="hljs-built_in">format</span>(epoch + <span class="hljs-number">1</span>,<br>                                                                     epochs,<br>                                                                     loss)<br><br>        <span class="hljs-comment"># validate</span><br>        net.<span class="hljs-built_in">eval</span>()<br>        acc = <span class="hljs-number">0.0</span>  <span class="hljs-comment"># accumulate accurate number / epoch</span><br>        <span class="hljs-keyword">with</span> torch.no_grad():<br>            val_bar = tqdm(validate_loader, file=sys.stdout)<br>            <span class="hljs-keyword">for</span> val_data <span class="hljs-keyword">in</span> val_bar:<br>                val_images, val_labels = val_data<br>                outputs = net(val_images.to(device))<br>                predict_y = torch.<span class="hljs-built_in">max</span>(outputs, dim=<span class="hljs-number">1</span>)[<span class="hljs-number">1</span>]<br>                acc += torch.eq(predict_y, val_labels.to(device)).<span class="hljs-built_in">sum</span>().item()<br><br>        val_accurate = acc / val_num<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[epoch %d] train_loss: %.3f  val_accuracy: %.3f&#x27;</span> %<br>              (epoch + <span class="hljs-number">1</span>, running_loss / train_steps, val_accurate))<br><br>        <span class="hljs-keyword">if</span> val_accurate &gt; best_acc:<br>            best_acc = val_accurate<br>            torch.save(net.state_dict(), save_path)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Finished Training&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></div></td></tr></table></figure><h1 id="é¢„æµ‹ä»£ç ">é¢„æµ‹ä»£ç </h1><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><br><span class="hljs-keyword">from</span> model <span class="hljs-keyword">import</span> AlexNet<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    device = torch.device(<span class="hljs-string">&quot;cuda:0&quot;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;cpu&quot;</span>)<br><br>    data_transform = transforms.Compose(<br>        [transforms.Resize((<span class="hljs-number">224</span>, <span class="hljs-number">224</span>)),<br>         transforms.ToTensor(),<br>         transforms.Normalize((<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>), (<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>))])<br><br>    <span class="hljs-comment"># load image</span><br>    img_path = <span class="hljs-string">&quot;../tulip.jpg&quot;</span><br>    <span class="hljs-keyword">assert</span> os.path.exists(img_path), <span class="hljs-string">&quot;file: &#x27;&#123;&#125;&#x27; dose not exist.&quot;</span>.<span class="hljs-built_in">format</span>(img_path)<br>    img = Image.<span class="hljs-built_in">open</span>(img_path)<br><br>    plt.imshow(img)<br>    <span class="hljs-comment"># [N, C, H, W]</span><br>    img = data_transform(img)<br>    <span class="hljs-comment"># expand batch dimension</span><br>    img = torch.unsqueeze(img, dim=<span class="hljs-number">0</span>)<br><br>    <span class="hljs-comment"># read class_indict</span><br>    json_path = <span class="hljs-string">&#x27;./class_indices.json&#x27;</span><br>    <span class="hljs-keyword">assert</span> os.path.exists(json_path), <span class="hljs-string">&quot;file: &#x27;&#123;&#125;&#x27; dose not exist.&quot;</span>.<span class="hljs-built_in">format</span>(json_path)<br><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(json_path, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> f:<br>        class_indict = json.load(f)<br><br>    <span class="hljs-comment"># create model</span><br>    model = AlexNet(num_classes=<span class="hljs-number">5</span>).to(device)<br><br>    <span class="hljs-comment"># load model weights</span><br>    weights_path = <span class="hljs-string">&quot;./AlexNet.pth&quot;</span><br>    <span class="hljs-keyword">assert</span> os.path.exists(weights_path), <span class="hljs-string">&quot;file: &#x27;&#123;&#125;&#x27; dose not exist.&quot;</span>.<span class="hljs-built_in">format</span>(weights_path)<br>    model.load_state_dict(torch.load(weights_path))<br><br>    model.<span class="hljs-built_in">eval</span>()<br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-comment"># predict class</span><br>        output = torch.squeeze(model(img.to(device))).cpu()<br>        predict = torch.softmax(output, dim=<span class="hljs-number">0</span>)<br>        predict_cla = torch.argmax(predict).numpy()<br><br>    print_res = <span class="hljs-string">&quot;class: &#123;&#125;   prob: &#123;:.3&#125;&quot;</span>.<span class="hljs-built_in">format</span>(class_indict[<span class="hljs-built_in">str</span>(predict_cla)],<br>                                                 predict[predict_cla].numpy())<br>    plt.title(print_res)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(predict)):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;class: &#123;:10&#125;   prob: &#123;:.3&#125;&quot;</span>.<span class="hljs-built_in">format</span>(class_indict[<span class="hljs-built_in">str</span>(i)],<br>                                                  predict[i].numpy()))<br>    plt.show()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>cv</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>redis</title>
    <link href="/2022/09/19/redis/"/>
    <url>/2022/09/19/redis/</url>
    
    <content type="html"><![CDATA[<p>ä»€ä¹ˆé¬¼å•Šï¼å¿«ç‚¹éƒ¨ç½²æˆåŠŸï¼ï¼ï¼ï¼</p>]]></content>
    
    
    <categories>
      
      <category>å¼€å‘</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>é€’å½’</title>
    <link href="/2022/08/18/%E9%80%92%E5%BD%92/"/>
    <url>/2022/08/18/%E9%80%92%E5%BD%92/</url>
    
    <content type="html"><![CDATA[<h2 id="powx-n">50ã€Pow(x, n)</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/50.png" /></p><p>ä½¿ç”¨é€’å½’çš„æ€æƒ³ï¼Œç›´æ¥å¾ªç¯ä¼šå¯¼è‡´è¿è¡Œæ—¶é—´è¿‡é•¿</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">myPow</span>(<span class="hljs-params">self, x: <span class="hljs-built_in">float</span>, n: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">float</span>:<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">quickPow</span>(<span class="hljs-params">N</span>):<br>            <span class="hljs-keyword">if</span> N == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">1.0</span><br>            y = quickPow(N // <span class="hljs-number">2</span>)<br>            <span class="hljs-keyword">return</span> y * y <span class="hljs-keyword">if</span> N % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> y * y * x<br>        <span class="hljs-keyword">return</span> quickPow(n) <span class="hljs-keyword">if</span> n &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1.0</span> / quickPow(-n)<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>LeetCode</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>SpringBoot</title>
    <link href="/2022/07/26/SpringBoot/"/>
    <url>/2022/07/26/SpringBoot/</url>
    
    <content type="html"><![CDATA[<h1 id="å‘˜å·¥ç®¡ç†ç³»ç»Ÿ">å‘˜å·¥ç®¡ç†ç³»ç»Ÿ</h1><h2 id="å›½é™…åŒ–">å›½é™…åŒ–</h2><p>æ–°å»ºpropertiesé…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºç¬¬äºŒä¸ªzh_CNæ–‡ä»¶æ˜¯ä¼šè‡ªåŠ¨ç”ŸæˆResourceBundleæ–‡ä»¶å¤¹ï¼Œå¯é€šè¿‡å³é”®æ–‡ä»¶å¤¹å¿«é€Ÿç”Ÿæˆé…ç½®æ–‡ä»¶</p><p><img src="/img/å¼€å‘/SpringBoot/1.png" /></p><p>å®‰è£…äº†Resource Bundle Editoræ’ä»¶åï¼Œå¯ä»¥ç‚¹å‡»å·¦ä¸‹è§’çš„ResourceBundleè¿›è¡Œå¯è§†åŒ–é…ç½®</p><p><img src="/img/å¼€å‘/SpringBoot/2.png" /></p><p>å°±ä¼šå‡ºç°è¿™ä¸ªé¡µé¢</p><p><img src="/img/å¼€å‘/SpringBoot/3.png" /></p><p>å³é”®æ·»åŠ é…ç½®</p><p><img src="/img/å¼€å‘/SpringBoot/4.png" /></p><p>å¯é€šè¿‡æ­¤æ–¹æ³•è¿›è¡Œå¯è§†åŒ–é…ç½®å›½é™…åŒ–</p><p><img src="/img/å¼€å‘/SpringBoot/5.png" /></p><p>éšååœ¨application.propertiesä¸­å°†é…ç½®æ–‡ä»¶å¯¼å…¥</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"># å›½é™…åŒ–é…ç½®æ–‡ä»¶åœ¨è¿™<br>spring.messages.basename=i18n.login<br></code></pre></div></td></tr></table></figure><p>åœ¨htmlä¸­å°†éœ€è¦å›½é™…åŒ–çš„æ–‡å­—è¿›è¡Œä¿®æ”¹ï¼Œé€šè¿‡#{xxxx}å–å¾—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> <span class="hljs-attr">th:placeholder</span>=<span class="hljs-string">&quot;#&#123;login.username&#125;&quot;</span> <span class="hljs-attr">required</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">autofocus</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> <span class="hljs-attr">th:placeholder</span>=<span class="hljs-string">&quot;#&#123;login.password&#125;&quot;</span> <span class="hljs-attr">required</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;checkbox&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;remember-me&quot;</span>&gt;</span>[[#&#123;login.remember&#125;]]<br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-lg btn-primary btn-block&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;#&#123;login.btn&#125;&quot;</span>&gt;</span>Sign in<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>ä¸ºäº†èƒ½å¤Ÿåœ¨é¡µé¢ä¸­ç‚¹å‡»ä¸­æ–‡æˆ–è€…è‹±æ–‡æŒ‰é’®è¿›è¡Œé¡µé¢çš„ä¸­è‹±æ–‡åˆ‡æ¢ï¼Œæˆ‘ä»¬åœ¨htmlä¸­å‘é€è¯·æ±‚ï¼Œå¹¶ä¸”åœ¨configæ–‡ä»¶å¤¹æ–°å»ºMyLocaleResolverç±»</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-sm&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/index.html(l=&#x27;zh_CN&#x27;)&#125;&quot;</span>&gt;</span>ä¸­æ–‡<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-sm&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/index.html(l=&#x27;en_US&#x27;)&#125;&quot;</span>&gt;</span>English<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyLocaleResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LocaleResolver</span> &#123;<br><br>    <span class="hljs-comment">//è§£æè¯·æ±‚</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Locale <span class="hljs-title function_">resolveLocale</span><span class="hljs-params">(HttpServletRequest httpServletRequest)</span> &#123;<br>        <span class="hljs-comment">//è·å–è¯·æ±‚ä¸­çš„è¯­è¨€å‚æ•°</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">language</span> <span class="hljs-operator">=</span> httpServletRequest.getParameter(<span class="hljs-string">&quot;l&quot;</span>);<br>        <br>        <span class="hljs-comment">//å¦‚æœæ²¡æœ‰å°±ä½¿ç”¨é»˜è®¤çš„</span><br>        <span class="hljs-type">Locale</span> <span class="hljs-variable">locale</span> <span class="hljs-operator">=</span> Locale.getDefault();<br>        <br>        <span class="hljs-comment">//å¦‚æœè¯·æ±‚çš„å‚æ•°é“¾æ¥æºå¸¦äº†å›½é™…åŒ–çš„å‚æ•°</span><br>        <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(language)) &#123;<br>            <span class="hljs-comment">//zh_CN</span><br>            String[] split = language.split(<span class="hljs-string">&quot;_&quot;</span>);<br>            <span class="hljs-comment">//å›½å®¶ï¼Œåœ°åŒº</span><br>            locale = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Locale</span>(split[<span class="hljs-number">0</span>], split[<span class="hljs-number">1</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> locale;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLocale</span><span class="hljs-params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Locale locale)</span> &#123;<br><br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æœ€ååœ¨è§†å›¾è§£æå™¨ä¸­æ³¨å†ŒBean</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMVCConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br><br>    <span class="hljs-comment">//é¡µé¢è·³è½¬</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addViewControllers</span><span class="hljs-params">(ViewControllerRegistry registry)</span> &#123;<br>        registry.addViewController(<span class="hljs-string">&quot;/&quot;</span>).setViewName(<span class="hljs-string">&quot;index&quot;</span>);<br>        registry.addViewController(<span class="hljs-string">&quot;/index.html&quot;</span>).setViewName(<span class="hljs-string">&quot;index&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//è‡ªå®šä¹‰çš„å›½é™…åŒ–ä¸»é”®å°±ç”Ÿæ•ˆäº†</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> LocaleResolver <span class="hljs-title function_">localeResolver</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyLocaleResolver</span>();<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="ç™»å½•åŠŸèƒ½å®ç°">ç™»å½•åŠŸèƒ½å®ç°</h2><p>åœ¨htmlä¸­è¿›è¡Œè¡¨å•è¯·æ±‚</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-signin&quot;</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">&quot;@&#123;/user/login&#125;&quot;</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>åç«¯æ–°å»ºLoginControllerç±»è¿›è¡Œå¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginController</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/user/login&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username, <span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String password, Model model)</span> &#123;<br>        <span class="hljs-comment">//å…·ä½“çš„ä¸šåŠ¡</span><br>        <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(username) &amp;&amp; <span class="hljs-string">&quot;123123&quot;</span>.equals(password)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;dashboard&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//å‘Šè¯‰ç”¨æˆ·ï¼Œä½ ç™»å½•é”™è¯¯äº†</span><br>            model.addAttribute(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;index&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>åœ¨å‰ç«¯é¡µé¢ä¸­æ˜¾ç¤ºç™»å½•é”™è¯¯çš„ä¿¡æ¯</p><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-comment">&lt;!--å¦‚æœmsgæ¶ˆæ¯ä¸ºç©ºï¼Œå°±ä¸æ˜¾ç¤ºæ¶ˆæ¯--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color: red&quot;</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;msg&#125;&quot;</span> <span class="hljs-attr">th:if</span>=<span class="hljs-string">&quot;$&#123;not #strings.isEmpty(msg)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>ä¸ºäº†ä½¿å¾—æ›´åŠ è§„èŒƒï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä½¿ç”¨é‡å®šå‘ï¼Œä½¿å¾—ç½‘å€é¡µé¢ä¸ä¼šæ˜¾ç¤ºè¿‡å¤šä¿¡æ¯</p><p>å…ˆåœ¨è§†å›¾è§£æå™¨ä¸­æ·»åŠ main.htmlé¡µé¢è·³è½¬</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//é¡µé¢è·³è½¬</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addViewControllers</span><span class="hljs-params">(ViewControllerRegistry registry)</span> &#123;<br>        registry.addViewController(<span class="hljs-string">&quot;/&quot;</span>).setViewName(<span class="hljs-string">&quot;index&quot;</span>);<br>        registry.addViewController(<span class="hljs-string">&quot;/index.html&quot;</span>).setViewName(<span class="hljs-string">&quot;index&quot;</span>);<br>        registry.addViewController(<span class="hljs-string">&quot;/main.html&quot;</span>).setViewName(<span class="hljs-string">&quot;dashboard&quot;</span>);<br>    &#125;<br></code></pre></div></td></tr></table></figure><p>ä¿®æ”¹controllerä¸­çš„é‡å®šå‘</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (!StringUtils.isEmpty(username) &amp;&amp; <span class="hljs-string">&quot;123123&quot;</span>.equals(password)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/main.html&quot;</span>;<br>        &#125;<br></code></pre></div></td></tr></table></figure><p>ä½¿ç”¨äº†é‡å®šå‘åï¼Œæˆ‘ä»¬ä¸éœ€è¦ç™»å½•éƒ½å¯ä»¥é€šè¿‡è¾“å…¥ç½‘å€è¿›è¡Œè®¿é—®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‹¦æˆªå™¨</p><h2 id="ç™»å½•æ‹¦æˆªå™¨">ç™»å½•æ‹¦æˆªå™¨</h2><p>æ‹¦æˆªå™¨çš„æ€æƒ³æ˜¯é€šè¿‡æŸ¥çœ‹sessionä¸­æ˜¯å¦æœ‰ç™»å½•çš„ä¿¡æ¯ä»è€Œåˆ¤æ–­æ˜¯å¦å·²ç»ç™»å½•ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆåœ¨LoginControllerä¸­è¾“å…¥å‚æ•°å…ˆåŠ å…¥HttpSessionï¼Œåœ¨æˆåŠŸç™»å½•çš„æ—¶å€™æ·»åŠ session</p><p><code>addPathPatternsï¼šè¯¥æ–¹æ³•ç”¨äºæŒ‡å®šæ‹¦æˆªè·¯å¾„ï¼Œä¾‹å¦‚æ‹¦æˆªè·¯å¾„ä¸ºâ€œ/**â€ï¼Œè¡¨ç¤ºæ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼ŒåŒ…æ‹¬å¯¹é™æ€èµ„æºçš„è¯·æ±‚ã€‚</code><code>excludePathPatternsï¼šè¯¥æ–¹æ³•ç”¨äºæ’é™¤æ‹¦æˆªè·¯å¾„ï¼Œå³æŒ‡å®šä¸éœ€è¦è¢«æ‹¦æˆªå™¨æ‹¦æˆªçš„è¯·æ±‚ã€‚</code></p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginController</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/user/login&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username, <span class="hljs-meta">@RequestParam(&quot;password&quot;)</span> String password, Model model, HttpSession session)</span> &#123;<br>        <span class="hljs-comment">//å…·ä½“</span><br>        <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(username) &amp;&amp; <span class="hljs-string">&quot;123123&quot;</span>.equals(password)) &#123;<br>            session.setAttribute(<span class="hljs-string">&quot;loginUser&quot;</span>, username);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/main.html&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//å‘Šè¯‰ç”¨æˆ·ï¼Œä½ ç™»å½•é”™è¯¯äº†</span><br>            model.addAttribute(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;index&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>éšååœ¨Configæ–‡ä»¶å¤¹ä¸­æ·»åŠ LoginHandlerInterceptoræ‹¦æˆªå™¨ç±»ï¼Œè¿”å›trueä»£è¡¨å¯ä»¥è®¿é—®ï¼Œè¿”å›falseä»£è¡¨ä¸èƒ½è®¿é—®</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginHandlerInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//ç™»å½•æˆåŠŸä¹‹åï¼Œåº”è¯¥æœ‰ç”¨æˆ·çš„session</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">loginUser</span> <span class="hljs-operator">=</span> request.getSession().getAttribute(<span class="hljs-string">&quot;loginUser&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (loginUser == <span class="hljs-literal">null</span>) &#123;<br>            request.setAttribute(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;æ²¡æœ‰æƒé™ï¼Œè¯·å…ˆç™»å½•&quot;</span>);<br>            request.getRequestDispatcher(<span class="hljs-string">&quot;/index.html&quot;</span>).forward(request, response);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æœ€ååœ¨è§†å›¾è§£æå™¨ä¸­æ·»åŠ æ‹¦æˆªå™¨ï¼Œå…¶ä¸­excludePathPatternsä¸­çš„å‚æ•°ä»£è¡¨ä¸éœ€è¦è¿‡æ»¤çš„èµ„æºï¼Œä¾‹å¦‚ç™»å½•é¡µé¢å’Œé™æ€èµ„æº</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginHandlerInterceptor</span>()).addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>).excludePathPatterns(<span class="hljs-string">&quot;/index.html&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;/user/login&quot;</span>, <span class="hljs-string">&quot;/static/**&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="å±•ç¤ºå‘˜å·¥åˆ—è¡¨">å±•ç¤ºå‘˜å·¥åˆ—è¡¨</h2><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmploeeController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    EmployeeDao employeeDao;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/emps&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">list</span><span class="hljs-params">(Model model)</span> &#123;<br>        Collection&lt;Employee&gt; employees = employeeDao.getAll();<br>        model.addAttribute(<span class="hljs-string">&quot;emps&quot;</span>, employees);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;emp/list&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">role</span>=<span class="hljs-string">&quot;main&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col-md-9 ml-sm-auto col-lg-10 pt-3 px-4&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-sm btn-success&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/emp&#125;&quot;</span>&gt;</span>æ·»åŠ å‘˜å·¥<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;table-responsive&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;table table-striped table-sm&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>id<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>lastName<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>email<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>gender<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>department<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>birth<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>æ“ä½œ<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">th:each</span>=<span class="hljs-string">&quot;emp:$&#123;emps&#125;&quot;</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;emp.getId()&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;emp.getLastName()&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;emp.getEmail()&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;emp.getGender()==0?&#x27;å¥³&#x27;:&#x27;ç”·&#x27;&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;emp.getDepartment().getDepartmentName()&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;#dates.format(emp.getBirth(), &#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-sm btn-primary&quot;</span>&gt;</span>ç¼–è¾‘<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>                                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-sm btn-danger&quot;</span>&gt;</span>åˆ é™¤<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>                            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h2 id="å¢åŠ å‘˜å·¥">å¢åŠ å‘˜å·¥</h2><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/emp&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addEmp</span><span class="hljs-params">(Employee employee)</span> &#123;<br><br>        employeeDao.save(employee);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/emps&quot;</span>;<br>    &#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">&quot;@&#123;/emp&#125;&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-group&quot;</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>LastName<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lastName&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;æµ·ç»µå®å®&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-group&quot;</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>Email<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;email&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;email&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;1176244270@qq.com&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-group&quot;</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>Gender<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-check form-check-inline&quot;</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-check-input&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;radio&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;gender&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-check-label&quot;</span>&gt;</span>ç”·<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-check form-check-inline&quot;</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-check-input&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;radio&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;gender&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;0&quot;</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-check-label&quot;</span>&gt;</span>å¥³<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-group&quot;</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>department<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;department.id&quot;</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">th:each</span>=<span class="hljs-string">&quot;dept:$&#123;departments&#125;&quot;</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;dept.getDepartmentName()&#125;&quot;</span> <span class="hljs-attr">th:value</span>=<span class="hljs-string">&quot;$&#123;dept.getId()&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-group&quot;</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>Birth<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;birth&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;å˜¤å˜¤å˜¤&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-primary&quot;</span>&gt;</span>æ·»åŠ <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h2 id="ä¿®æ”¹å‘˜å·¥">ä¿®æ”¹å‘˜å·¥</h2><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//å»å‘˜å·¥çš„ä¿®æ”¹é¡µé¢</span><br>    <span class="hljs-meta">@GetMapping(&quot;/emp/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toUpdateEmp</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span>Integer id, Model model)</span> &#123;<br>        <span class="hljs-comment">//æŸ¥å‡ºæ¥åŸæ¥çš„æ•°æ®</span><br>        <span class="hljs-type">Employee</span> <span class="hljs-variable">employee</span> <span class="hljs-operator">=</span> employeeDao.getEmployById(id);<br>        model.addAttribute(<span class="hljs-string">&quot;emp&quot;</span>, employee);<br><br>        Collection&lt;Department&gt; departments = departmentDao.getDepartments();<br>        model.addAttribute(<span class="hljs-string">&quot;departments&quot;</span>, departments);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;emp/update&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/updateEmp&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">updateEmp</span><span class="hljs-params">(Employee employee)</span> &#123;<br>        employeeDao.save(employee);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/emps&quot;</span>;<br>    &#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-sm btn-primary&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/emp/&#123;id&#125;(id=$&#123;emp.getId()&#125;)&#125;&quot;</span>&gt;</span>ç¼–è¾‘<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></div></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">&quot;@&#123;/updateEmp&#125;&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">th:value</span>=<span class="hljs-string">&quot;$&#123;emp.getId()&#125;&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-group&quot;</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>LastName<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">th:value</span>=<span class="hljs-string">&quot;$&#123;emp.getLastName()&#125;&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lastName&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;æµ·ç»µå®å®&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-group&quot;</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>Email<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">th:value</span>=<span class="hljs-string">&quot;$&#123;emp.getEmail()&#125;&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;email&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;email&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;1176244270@qq.com&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-group&quot;</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>Gender<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-check form-check-inline&quot;</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">th:checked</span>=<span class="hljs-string">&quot;$&#123;emp.getGender()==1&#125;&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-check-input&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;radio&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;gender&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-check-label&quot;</span>&gt;</span>ç”·<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-check form-check-inline&quot;</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">th:checked</span>=<span class="hljs-string">&quot;$&#123;emp.getGender()==0&#125;&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-check-input&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;radio&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;gender&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;0&quot;</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-check-label&quot;</span>&gt;</span>å¥³<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-group&quot;</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>department<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;department.id&quot;</span>&gt;</span><br>                     <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">th:selected</span>=<span class="hljs-string">&quot;$&#123;dept.getId() == emp.getDepartment().getId()&#125;&quot;</span> <span class="hljs-attr">th:each</span>=<span class="hljs-string">&quot;dept:$&#123;departments&#125;&quot;</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;dept.getDepartmentName()&#125;&quot;</span> <span class="hljs-attr">th:value</span>=<span class="hljs-string">&quot;$&#123;dept.getId()&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span><br>                 <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-group&quot;</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>Birth<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">th:value</span>=<span class="hljs-string">&quot;$&#123;#dates.format(emp.getBirth(), &#x27;yyyy-MM-dd HH:mm&#x27;)&#125;&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;birth&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;å˜¤å˜¤å˜¤&quot;</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-primary&quot;</span>&gt;</span>ä¿®æ”¹<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h2 id="åˆ é™¤å‘˜å·¥">åˆ é™¤å‘˜å·¥</h2><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//åˆ é™¤å‘˜å·¥</span><br>    <span class="hljs-meta">@GetMapping(&quot;/deleteEmp/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deleteEmp</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> <span class="hljs-type">int</span> id)</span> &#123;<br>        employeeDao.delete(id);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/emps&quot;</span>;<br>    &#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-sm btn-danger&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/deleteEmp/&#123;id&#125;(id=$&#123;emp.getId()&#125;)&#125;&quot;</span>&gt;</span>åˆ é™¤<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h2 id="section">404</h2><p>SpringBootåªç”¨åœ¨templatesä¸­æ–°å»ºä¸€ä¸ªerroræ–‡ä»¶å¤¹ï¼Œåœ¨errorä¸­æ”¾ç½®æˆ‘ä»¬è‡ªå®šä¹‰çš„404.htmlå³å¯</p><h2 id="æ³¨é”€">æ³¨é”€</h2><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/user/logout&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">logout</span><span class="hljs-params">(HttpSession session)</span> &#123;<br>        session.invalidate();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/index.html&quot;</span>;<br>    &#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav-link&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/user/logout&#125;&quot;</span>&gt;</span>é€€å‡º<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></div></td></tr></table></figure><h1 id="spring-data">Spring Data</h1><h2 id="æ•´åˆjdbc">æ•´åˆJDBC</h2><p>æ–°å»ºé¡¹ç›®æ—¶éœ€è¦å‹¾é€‰ä¸Šå…³ç³»å‹æ•°æ®åº“ä¸­çš„<code>JDBC API</code>ä»¥åŠ<code>MYSQL Driver</code></p><p>é¦–å…ˆæ–°å»ºä¸€ä¸ªapplication.ymlæ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶ä¸­è¾“å…¥</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123123</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/mybatis?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br></code></pre></div></td></tr></table></figure><p>ç¼–å†™ä¸€ä¸ªControlleræ¥æµ‹è¯•ä¸€ä¸‹jdbcçš„ä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JDBCController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    JdbcTemplate jdbcTemplate;<br><br>    <span class="hljs-comment">//æŸ¥è¯¢æ•°æ®åº“çš„æ‰€æœ‰ä¿¡æ¯</span><br>    <span class="hljs-meta">@GetMapping(&quot;/userList&quot;)</span><br>    <span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">userList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select * from user&quot;</span>;<br>        List&lt;Map&lt;String, Object&gt;&gt; list_maps = jdbcTemplate.queryForList(sql);<br>        <span class="hljs-keyword">return</span> list_maps;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/addList&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addUser</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;insert into mybatis.user values (4, &#x27;å°æ˜&#x27;, &#x27;123123&#x27;)&quot;</span>;<br>        jdbcTemplate.update(sql);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;add-ok&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/updateList/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> <span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;update mybatis.user set name=?, pwd=? where id =&quot;</span> + id;<br>        Object[] objects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">2</span>];<br>        objects[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;å°æ˜2&quot;</span>;<br>        objects[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;asdfasdf&quot;</span>;<br>        jdbcTemplate.update(sql, objects);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;update-ok&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/deleteList/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> <span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;delete from mybatis.user where id=?&quot;</span> ;<br>        jdbcTemplate.update(sql, id);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;delete-ok&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="æ•´åˆdruidæ•°æ®æº">æ•´åˆDruidæ•°æ®æº</h2><p>æ·»åŠ ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>åœ¨application.ymlä¸­è¿›è¡ŒDruidé…ç½®</p><figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123123</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/mybatis?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br><br>    <span class="hljs-comment">#SpringBooté»˜è®¤æ˜¯ä¸æ³¨å…¥è¿™äº›çš„ï¼Œéœ€è¦è‡ªå·±ç»‘å®š</span><br>    <span class="hljs-comment">#druidæ•°æ®æºä¸“æœ‰é…ç½®</span><br>    <span class="hljs-attr">initialSize:</span> <span class="hljs-number">5</span><br>    <span class="hljs-attr">minIdle:</span> <span class="hljs-number">5</span><br>    <span class="hljs-attr">maxActive:</span> <span class="hljs-number">20</span><br>    <span class="hljs-attr">maxWait:</span> <span class="hljs-number">60000</span><br>    <span class="hljs-attr">timeBetweenEvictionRunsMillis:</span> <span class="hljs-number">60000</span><br>    <span class="hljs-attr">minEvictableIdleTimeMillis:</span> <span class="hljs-number">300000</span><br>    <span class="hljs-attr">validationQuery:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-string">FROM</span> <span class="hljs-string">DUAL</span><br>    <span class="hljs-attr">testWhileIdle:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">testOnBorrow:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">testOnReturn:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">poolPreparedStatements:</span> <span class="hljs-literal">true</span><br><br>    <span class="hljs-comment">#é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filtersï¼Œstatï¼šç›‘æ§ç»Ÿè®¡ã€log4jï¼šæ—¥å¿—è®°å½•ã€wallï¼šé˜²å¾¡sqlæ³¨å…¥</span><br>    <span class="hljs-comment">#å¦‚æœå…è®¸æŠ¥é”™ï¼Œjava.lang.ClassNotFoundException: org.apache.Log4j.Properity</span><br>    <span class="hljs-comment">#åˆ™å¯¼å…¥log4j ä¾èµ–å°±è¡Œ</span><br>    <span class="hljs-attr">filters:</span> <span class="hljs-string">stat,wall,log4j</span><br>    <span class="hljs-attr">maxPoolPreparedStatementPerConnectionSize:</span> <span class="hljs-number">20</span><br>    <span class="hljs-attr">useGlobalDataSourceStat:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">connectionoProperties:</span> <span class="hljs-string">druid.stat.mergeSql=true;druid.stat.slowSqlMillis=500</span><br></code></pre></div></td></tr></table></figure><p>æˆ‘ä»¬æ–°å»ºconfigæ–‡ä»¶å¤¹ï¼Œæ–°å»ºä¸€ä¸ªDruidConfigç±»è¿›è¡Œè‡ªå®šä¹‰é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DruidConfig</span> &#123;<br><br>    <span class="hljs-meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">druidDataSource</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DruidDataSource</span>();<br>    &#125;<br><br>    <span class="hljs-comment">//åå°ç›‘æ§</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> ServletRegistrationBean <span class="hljs-title function_">statViewServlet</span><span class="hljs-params">()</span> &#123;<br>        ServletRegistrationBean&lt;StatViewServlet&gt; bean= <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRegistrationBean</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StatViewServlet</span>(), <span class="hljs-string">&quot;/druid/*&quot;</span>);<br>        <span class="hljs-comment">//åå°éœ€è¦æœ‰äººç™»å½•</span><br>        HashMap&lt;String, String&gt; initParameters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-comment">//å¢åŠ é…ç½®</span><br>        initParameters.put(<span class="hljs-string">&quot;loinUsername&quot;</span>, <span class="hljs-string">&quot;admin&quot;</span>); <span class="hljs-comment">//ç™»å½•keyæ˜¯å›ºå®šçš„ loinUsernameå’ŒloginPassword</span><br>        initParameters.put(<span class="hljs-string">&quot;loginPassword&quot;</span>, <span class="hljs-string">&quot;123123&quot;</span>);<br><br>        <span class="hljs-comment">//å…è®¸è°è®¿é—®</span><br>        initParameters.put(<span class="hljs-string">&quot;allow&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br><br>        bean.setInitParameters(initParameters);<span class="hljs-comment">//åˆå§‹åŒ–å‚æ•°</span><br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br></code></pre></div></td></tr></table></figure><p>åœ¨ç½‘é¡µä¸­è¾“å…¥<code>localhost:8080/druid</code>å³å¯è¿›å…¥åå°ç›‘æ§ï¼Œå¯ä»¥åœ¨ç›‘æ§ä¸­æŸ¥çœ‹å„ç§sqlï¼ŒSessionç­‰ã€‚</p><h2 id="æ•´åˆmybatis">æ•´åˆMyBatis</h2><p>å¯¼å…¥ä¸SpringBootæ•´åˆçš„ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>æ–°å»ºä¸€ä¸ªpojo</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String pwd;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>æ–°å»ºä¸€ä¸ªMapperæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//è¿™ä¸ªæ³¨è§£è¡¨ç¤ºäº†è¿™æ˜¯ä¸€ä¸ªmybatisçš„mapperç±»</span><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> &#123;<br>    List&lt;User&gt; <span class="hljs-title function_">queryUserList</span><span class="hljs-params">()</span>;<br><br>    User <span class="hljs-title function_">queryUserById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span>;<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">addUser</span><span class="hljs-params">(User user)</span>;<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span>;<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å¯¹äºMapperæ¥å£çš„å®ç°éœ€è¦åœ¨resourcesæ–‡ä»¶å¤¹ä¸­è¿›è¡Œå®ç°ï¼Œæ–°å»ºæ–‡ä»¶ç›®å½•ä¸º</p><ul><li>resources<ul><li>mybatis<ul><li>mapper<ul><li>UserMapper.xml</li></ul></li></ul></li></ul></li></ul><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//dtd Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.zhou.mapper.UserMapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;queryUserList&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span><br>        select * from user;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;queryUserById&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span><br>        select * from user where id = #&#123;id&#125;;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;addUser&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span><br>        insert into mybatis.user(id, name, pwd) VALUES (#&#123;id&#125;,#&#123;name&#125;,#&#123;pwd&#125;);<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;updateUser&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span><br>        update user set name = #&#123;name&#125;,pwd=#&#123;pwd&#125; where id = #&#123;id&#125;;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;deleteUserById&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;int&quot;</span>&gt;</span><br>        delete from user where id = #&#123;id&#125;;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>ä¸ºäº†ä½¿å¾—åŒ…èƒ½å¤Ÿè¢«æ‰«æåˆ°ï¼Œéœ€è¦åœ¨applicationä¸­è¿›è¡Œé…ç½®</p><figure class="highlight properties"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs properties"><span class="hljs-comment"># æ•´åˆmybatis</span><br><span class="hljs-attr">mybatis.type-aliases-package</span>=<span class="hljs-string">com.zhou.pojo</span><br><span class="hljs-attr">mybatis.mapper-locations</span>=<span class="hljs-string">classpath:mybatis/mapper/*.xml</span><br></code></pre></div></td></tr></table></figure><p>ä¸ºäº†å­¦ä¹ ï¼Œçœç•¥äº†serviceå±‚ï¼Œç›´æ¥ä»Controllerå±‚è°ƒç”¨Mapper</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/queryUserList&quot;)</span><br>    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">queryUserList</span><span class="hljs-params">()</span> &#123;<br>        List&lt;User&gt; users = userMapper.queryUserList();<br>        <span class="hljs-keyword">return</span> users;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/addUser&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addUser</span><span class="hljs-params">()</span> &#123;<br>        userMapper.addUser(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;è‚˜å­å¼€&quot;</span>, <span class="hljs-string">&quot;123123&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;add_finished&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/updateUser&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">updateUser</span><span class="hljs-params">()</span> &#123;<br>        userMapper.updateUser(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;è‚˜å­å¼€2&quot;</span>, <span class="hljs-string">&quot;12351234&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;update_finished&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/deleteUser&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deleteUser</span><span class="hljs-params">()</span> &#123;<br>        userMapper.deleteUser(<span class="hljs-number">4</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;delete_finished&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="springsecurity">SpringSecurity</h1><p>shiroå’ŒSpringSecurityå¾ˆåƒï¼Œé™¤äº†ç±»ä¸ä¸€æ ·ï¼Œåå­—ä¸ä¸€æ ·</p><ul><li>åŠŸèƒ½æƒé™</li><li>è®¿é—®æƒé™</li><li>èœå•æƒé™</li><li>æ‹¦æˆªå™¨ã€è¿‡æ»¤å™¨</li></ul><h2 id="ç”¨æˆ·è®¤è¯å’Œæˆæƒ">ç”¨æˆ·è®¤è¯å’Œæˆæƒ</h2><p>å¯¼å…¥æ¨¡æ¿</p><p><img src="/img/å¼€å‘/SpringBoot/8.png" /></p><p>å…ˆå¯¹é¡µé¢è®¿é—®è¿›è¡Œç¼–å†™controllerè¿›è¡Œè·³è½¬</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RouterController</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/&quot;,&quot;/index&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;index&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/toLogin&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toLogin</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;views/login&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/level1/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">level1</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> <span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;views/level1/&quot;</span> + id;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/level2/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">level2</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> <span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;views/level2/&quot;</span> + id;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/level3/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">level3</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> <span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;views/level3/&quot;</span> + id;<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure><p>è®¿é—®ä¸»é¡µä¸º</p><p><img src="/img/å¼€å‘/SpringBoot/9.png" /></p><p>å¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬è¦å®ç°ä¸åŒæƒé™çš„äººè®¿é—®ä¸åŒçš„åŠŸèƒ½é¡µé¢ï¼Œä¾‹å¦‚åªæœ‰vip1æƒé™çš„ç”¨æˆ·æ‰èƒ½è®¿é—®level1ä¸‹çš„é¡µé¢ï¼Œè¿™æ—¶å€™éœ€è¦æ–°å»ºä¸€ä¸ªé…ç½®ç±»è¿›è¡Œé…ç½®</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-comment">//æˆæƒ</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//é¦–é¡µæ‰€æœ‰äººéƒ½å¯ä»¥è®¿é—®ï¼ŒåŠŸèƒ½é¡µåªæœ‰å¯¹åº”æœ‰æƒé™çš„äººæ‰èƒ½è®¿é—®</span><br>        <span class="hljs-comment">//ç¬¬ä¸€è¡Œä»£è¡¨é¦–é¡µæ‰€æœ‰äººéƒ½å¯ä»¥è®¿é—® ç¬¬äºŒè¡Œä»£è¡¨éœ€è¦vip1æ‰èƒ½è¿›è¡Œè®¿é—®</span><br>        http.authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/&quot;</span>).permitAll()<br>                .antMatchers(<span class="hljs-string">&quot;/level1/**&quot;</span>).hasRole(<span class="hljs-string">&quot;vip1&quot;</span>)<br>                .antMatchers(<span class="hljs-string">&quot;/level2/**&quot;</span>).hasRole(<span class="hljs-string">&quot;vip2&quot;</span>)<br>                .antMatchers(<span class="hljs-string">&quot;/level3/**&quot;</span>).hasRole(<span class="hljs-string">&quot;vip3&quot;</span>);<br><br>        <span class="hljs-comment">//æ²¡æœ‰æƒé™é»˜è®¤ä¼šå›åˆ°ç™»é™†é¡µé¢</span><br>        http.formLogin();<br>    &#125;<br><br>    <span class="hljs-comment">//è®¤è¯</span><br>    <span class="hljs-comment">//å¯†ç ç¼–ç ï¼šPasswordEncoder</span><br>    <span class="hljs-comment">//åœ¨Spring Security 5.0+ æ–°å¢äº†å¾ˆå¤šçš„åŠ å¯†æ–¹æ³• éœ€è¦å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œå¦åˆ™ä¼šæŠ¥é”™</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//è¿™äº›æ•°æ®æ­£å¸¸åº”è¯¥ä»æ•°æ®åº“ä¸­è¯»</span><br>        auth.inMemoryAuthentication().passwordEncoder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>())<br>                .withUser(<span class="hljs-string">&quot;zhouzikai&quot;</span>).password(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>().encode(<span class="hljs-string">&quot;123123&quot;</span>)).roles(<span class="hljs-string">&quot;vip2&quot;</span>, <span class="hljs-string">&quot;vip3&quot;</span>)<br>                .and()<br>                .withUser(<span class="hljs-string">&quot;root&quot;</span>).password(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>().encode(<span class="hljs-string">&quot;123123&quot;</span>)).roles(<span class="hljs-string">&quot;vip1&quot;</span>, <span class="hljs-string">&quot;vip2&quot;</span>, <span class="hljs-string">&quot;vip3&quot;</span>)<br>                .and()<br>                .withUser(<span class="hljs-string">&quot;guest&quot;</span>).password(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>().encode(<span class="hljs-string">&quot;123123&quot;</span>)).roles(<span class="hljs-string">&quot;vip1&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h2 id="æ³¨é”€åŠæƒé™æ§åˆ¶">æ³¨é”€åŠæƒé™æ§åˆ¶</h2><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//æˆæƒ</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//é¦–é¡µæ‰€æœ‰äººéƒ½å¯ä»¥è®¿é—®ï¼ŒåŠŸèƒ½é¡µåªæœ‰å¯¹åº”æœ‰æƒé™çš„äººæ‰èƒ½è®¿é—®</span><br>        <span class="hljs-comment">//ç¬¬ä¸€è¡Œä»£è¡¨é¦–é¡µæ‰€æœ‰äººéƒ½å¯ä»¥è®¿é—® ç¬¬äºŒè¡Œä»£è¡¨éœ€è¦vip1æ‰èƒ½è¿›è¡Œè®¿é—®</span><br>        http.authorizeRequests()<br>                .antMatchers(<span class="hljs-string">&quot;/&quot;</span>).permitAll()<br>                .antMatchers(<span class="hljs-string">&quot;/level1/**&quot;</span>).hasRole(<span class="hljs-string">&quot;vip1&quot;</span>)<br>                .antMatchers(<span class="hljs-string">&quot;/level2/**&quot;</span>).hasRole(<span class="hljs-string">&quot;vip2&quot;</span>)<br>                .antMatchers(<span class="hljs-string">&quot;/level3/**&quot;</span>).hasRole(<span class="hljs-string">&quot;vip3&quot;</span>);<br><br>        <span class="hljs-comment">//æ²¡æœ‰æƒé™é»˜è®¤ä¼šå›åˆ°ç™»é™†é¡µé¢</span><br>        http.formLogin();<br><br>        <span class="hljs-comment">//æ³¨é”€ï¼Œå¼€å¯äº†æ³¨é”€åŠŸèƒ½ï¼Œå†è·³åˆ°é¦–é¡µ</span><br>        http.logout().logoutSuccessUrl(<span class="hljs-string">&quot;/&quot;</span>);<br>    &#125;<br></code></pre></div></td></tr></table></figure><h2 id="è®°ä½æˆ‘åŠé¦–é¡µå®šåˆ¶">è®°ä½æˆ‘åŠé¦–é¡µå®šåˆ¶</h2><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//å¼€å¯è®°ä½æˆ‘åŠŸèƒ½:cookieï¼Œé»˜è®¤ä¿å­˜ä¸¤å‘¨</span><br>        http.rememberMe();<br></code></pre></div></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//æ²¡æœ‰æƒé™é»˜è®¤ä¼šå›åˆ°ç™»é™†é¡µé¢</span><br>        <span class="hljs-comment">//å®šåˆ¶ç™»å½•é¡µåˆ°toLogin</span><br>        http.formLogin().loginPage(<span class="hljs-string">&quot;/toLogin&quot;</span>);<br></code></pre></div></td></tr></table></figure><h1 id="swagger">Swagger</h1><h2 id="é›†æˆswagger">é›†æˆswagger</h2><p>å¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/io.springfox/springfox-swagger2 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-swagger2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/io.springfox/springfox-swagger-ui --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></div></td></tr></table></figure><p>ç¼–å†™helloçš„Controller</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(value = &quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><p>é…ç½®Swagger</p><ul><li>æ–°å»ºconfig.SwaggerConfig.java</li></ul><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableSwagger2</span>   <span class="hljs-comment">//å¼€å¯Swagger2</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SwaggerConfig</span> &#123;<br><br>&#125;<br></code></pre></div></td></tr></table></figure><p>æµ‹è¯•è¿è¡Œ</p><ul><li>è¾“å…¥<code>localhost:8080/swagger-ui.html</code></li></ul><p><img src="/img/å¼€å‘/SpringBoot/10.png" /></p><h2 id="é…ç½®swaggerä¿¡æ¯">é…ç½®Swaggerä¿¡æ¯</h2><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//é…ç½®äº†Swaggerçš„beanå®ä¾‹</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">docket</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>                .apiInfo(apiInfo());<br>    &#125;<br><br>    <span class="hljs-comment">//é…ç½®Swaggerä¿¡æ¯</span><br>    <span class="hljs-keyword">private</span> ApiInfo <span class="hljs-title function_">apiInfo</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-comment">//ä½œè€…ä¿¡æ¯</span><br>        <span class="hljs-type">Contact</span> <span class="hljs-variable">contact</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Contact</span>(<span class="hljs-string">&quot;è‚˜å­å¼€&quot;</span>, <span class="hljs-string">&quot;https://www.baidu.com&quot;</span>, <span class="hljs-string">&quot;13600004906&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfo</span>(<span class="hljs-string">&quot;è‚˜å­å¼€çš„SwaggerAPIæ–‡æ¡£&quot;</span>,<br>                <span class="hljs-string">&quot;Api Documentation&quot;</span>,<br>                <span class="hljs-string">&quot;1.0&quot;</span>,<br>                <span class="hljs-string">&quot;urn:tos&quot;</span>,<br>                contact,<br>                <span class="hljs-string">&quot;Apache 2.0&quot;</span>,<br>                <span class="hljs-string">&quot;http://www.apache.org/licenses/LICENSE-2.0&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>());<br>    &#125;<br></code></pre></div></td></tr></table></figure><p><img src="/img/å¼€å‘/SpringBoot/11.png" /></p><h2 id="é…ç½®æ‰«ææ¥å£åŠå¼€å…³">é…ç½®æ‰«ææ¥å£åŠå¼€å…³</h2><ul><li>é€šè¿‡select()ã€apis()ä»¥åŠbuild()æ–¹æ³•è¿›è¡Œé…ç½®éœ€è¦æ‰«æçš„æ¥å£</li></ul><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//é…ç½®äº†Swaggerçš„beanå®ä¾‹</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">docket</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>                .apiInfo(apiInfo())<br>                .select()<br>                <span class="hljs-comment">//RequestHandlerSelectorsé…ç½®è¦æ‰«æç»“æœçš„æ–¹å¼</span><br>                <span class="hljs-comment">//basePackage()æŒ‡å®šè¦æ‰«æçš„åŒ…</span><br>            <span class="hljs-comment">//any()æ‰«æå…¨éƒ¨</span><br>                <span class="hljs-comment">//none()ä¸æ‰«æ</span><br>                <span class="hljs-comment">//withClassAnnotationæ‰«æç±»ä¸Šçš„æ³¨è§£</span><br>                <span class="hljs-comment">//withMethodAnnotationæ‰«ææ–¹æ³•ä¸Šçš„æ³¨è§£</span><br>                .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.example.swagger.controller&quot;</span>))<br>            <span class="hljs-comment">//path()è¿‡æ»¤è·¯å¾„</span><br>                <span class="hljs-comment">//.paths(PathSelectors.ant(&quot;/zhou/**&quot;))</span><br>                .build();<br>    &#125;<br></code></pre></div></td></tr></table></figure><ul><li>é€šè¿‡enable()æ–¹æ³•å¯¹swaggerè¿›è¡Œå¼€å…³</li></ul><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//é…ç½®äº†Swaggerçš„beanå®ä¾‹</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">docket</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>                .apiInfo(apiInfo())<br>                <span class="hljs-comment">//å¦‚æœä¸ºfalseåˆ™ä¸å¯åŠ¨</span><br>                .enable(<span class="hljs-literal">false</span>)<br>                .select()<br>                .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.example.swagger.controller&quot;</span>))<br>                .build();<br>    &#125;<br></code></pre></div></td></tr></table></figure><ul><li>å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨ä¸Šçº¿ç¯å¢ƒä¸­ä¸ä½¿ç”¨</li><li>é¦–å…ˆä¼šæ–°å»ºä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œåˆ†åˆ«ä¸ºapplication-dev.propertieså’Œapplication-prod.propertiesï¼Œåˆ†åˆ«ä¸ºå¼€å‘ç¯å¢ƒå’Œä¸Šçº¿ç¯å¢ƒä¸­çš„é…ç½®</li><li>ä¹‹åå¯¹ç¯å¢ƒè¿›è¡Œè¯»å–ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºå¼€å‘ç¯å¢ƒï¼Œå†ä¼ ç»™enable()</li></ul><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">docket</span><span class="hljs-params">(Environment environment)</span> &#123;<br><br>        <span class="hljs-comment">//è®¾ç½®è¦æ˜¾ç¤ºçš„Swaggerç¯å¢ƒ</span><br>        <span class="hljs-type">Profiles</span> <span class="hljs-variable">profiles</span> <span class="hljs-operator">=</span> Profiles.of(<span class="hljs-string">&quot;dev&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-comment">//é€šè¿‡environment.acceptsProfilesåˆ¤æ–­æ˜¯å¦åœ¨è‡ªå·±è®¾å®šçš„ç¯å¢ƒå½“ä¸­</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> environment.acceptsProfiles(profiles);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>                .apiInfo(apiInfo())<br>                .enable(flag)<br>                .select()<br>                .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.example.swagger.controller&quot;</span>))<br>                .build();<br>    &#125;<br></code></pre></div></td></tr></table></figure><ul><li>åœ¨application.propertiesä¸­é…ç½®</li></ul><figure class="highlight properties"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs properties"><span class="hljs-attr">spring.profiles.active</span>=<span class="hljs-string">dev</span><br></code></pre></div></td></tr></table></figure><ul><li>åœ¨application-dev.propertiesä¸­é…ç½®</li></ul><figure class="highlight properties"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs properties"><span class="hljs-attr">server.port</span>=<span class="hljs-string">8081</span><br></code></pre></div></td></tr></table></figure><ul><li>åœ¨application-prod.propertiesä¸­é…ç½®</li></ul><figure class="highlight properties"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs properties"><span class="hljs-attr">server.port</span>=<span class="hljs-string">8082</span><br></code></pre></div></td></tr></table></figure><h2 id="é…ç½®apiåˆ†ç»„">é…ç½®apiåˆ†ç»„</h2><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br>   <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">docket1</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2).groupName(<span class="hljs-string">&quot;A&quot;</span>);<br>   &#125;<br><br>   <span class="hljs-meta">@Bean</span><br>   <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">docket2</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2).groupName(<span class="hljs-string">&quot;B&quot;</span>);<br>   &#125;<br><br>   <span class="hljs-meta">@Bean</span><br>   <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">docket3</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2).groupName(<span class="hljs-string">&quot;C&quot;</span>);<br>   &#125;<br><br><span class="hljs-meta">@Bean</span><br>   <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">docket</span><span class="hljs-params">(Environment environment)</span> &#123;<br><br>       <span class="hljs-type">Profiles</span> <span class="hljs-variable">profiles</span> <span class="hljs-operator">=</span> Profiles.of(<span class="hljs-string">&quot;dev&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br><br>       <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> environment.acceptsProfiles(profiles);<br><br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>               .apiInfo(apiInfo())<br>               .enable(flag)<br>               .groupName(<span class="hljs-string">&quot;è‚˜å­å¼€&quot;</span>)<br>               .select()<br>               .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.example.swagger.controller&quot;</span>))<br>               .build();<br>   &#125;<br></code></pre></div></td></tr></table></figure><ul><li>æ–°å»ºå®ä½“ç±»ï¼Œå…¶ä¸­apiæ³¨è§£ç›¸å½“äºæ˜¯æ³¨é‡Šï¼Œèƒ½å¤Ÿåœ¨swaggerä¸­çœ‹åˆ°</li></ul><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@ApiModel(&quot;ç”¨æˆ·å®ä½“ç±»&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <br>    <span class="hljs-meta">@ApiModelProperty(&quot;ç”¨æˆ·å&quot;)</span><br>    <span class="hljs-keyword">public</span> String username;<br>    <br>    <span class="hljs-meta">@ApiModelProperty(&quot;å¯†ç &quot;)</span><br>    <span class="hljs-keyword">public</span> String password;<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>åœ¨æ§åˆ¶ç±»è¿›è¡Œæ³¨é‡Š</li></ul><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;Helloæ§åˆ¶æ–¹æ³•&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/hello2&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello2</span><span class="hljs-params">(<span class="hljs-meta">@ApiParam(&quot;ç”¨æˆ·å&quot;)</span> String username)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span> + username;<br>    &#125;<br>    <br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="å¼‚æ­¥ä»»åŠ¡">å¼‚æ­¥ä»»åŠ¡</h1><p>é¦–å…ˆç¼–å†™ä¸€ä¸ªç­‰å¾…3ç§’é’Ÿå›å¤è¯·æ±‚çš„éœ€æ±‚</p><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncService</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            Thread.sleep(<span class="hljs-number">3000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;æ•°æ®æ­£åœ¨å¤„ç†ã€‚ã€‚ã€‚&quot;</span>);<br><br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    AsyncService asyncService;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        asyncService.hello();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure><p>è¿™æ—¶å€™ç”¨æˆ·å¿…é¡»è¦ç­‰å¾…3ç§’ä¹‹åæ‰å¯ä»¥æ”¶åˆ°å›å¤çš„è¯·æ±‚ï¼Œè¿™æ—¶å€™éœ€è¦å¼‚æ­¥è¯·æ±‚</p><ul><li>å…ˆåœ¨Serviceä¸­æ·»åŠ <code>@Async</code>æ³¨è§£</li></ul><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncService</span> &#123;<br><br>    <span class="hljs-comment">//å‘Šè¯‰Springè¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„æ–¹æ³•</span><br>    <span class="hljs-meta">@Async</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            Thread.sleep(<span class="hljs-number">3000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;æ•°æ®æ­£åœ¨å¤„ç†ã€‚ã€‚ã€‚&quot;</span>);<br><br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>ä¹‹åå†mainæ–¹æ³•ä¸­å¼€å¯æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//å¼€å¯å¼‚æ­¥æ³¨è§£åŠŸèƒ½</span><br><span class="hljs-meta">@EnableAsync</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(TestApplication.class, args);<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="é‚®ä»¶ä»»åŠ¡">é‚®ä»¶ä»»åŠ¡</h1><ul><li>æ·»åŠ ä¾èµ–</li></ul><figure class="highlight xml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></div></td></tr></table></figure><ul><li>éœ€è¦å†é…ç½®æ–‡ä»¶ä¸­æ·»åŠ é…ç½®</li></ul><figure class="highlight properties"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs properties"><span class="hljs-attr">spring.mail.username</span>=<span class="hljs-string">1735257086@qq.com</span><br><span class="hljs-attr">spring.mail.password</span>=<span class="hljs-string">dzzmxmfwltrpcbid</span><br><span class="hljs-attr">spring.mail.host</span>=<span class="hljs-string">smtp.qq.com</span><br><span class="hljs-comment"># å¦‚æœæ˜¯qqé‚®ç®±ï¼Œå¼€å¯åŠ å¯†éªŒè¯</span><br><span class="hljs-attr">spring.mail.properties.mail.smtp.ssl.enable</span>=<span class="hljs-string">true</span><br></code></pre></div></td></tr></table></figure><ul><li>ç¼–å†™è¯·æ±‚</li></ul><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestApplicationTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    JavaMailSenderImpl mailSender;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextLoads</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//ä¸€ä¸ªç®€å•çš„é‚®ä»¶</span><br>        <span class="hljs-type">SimpleMailMessage</span> <span class="hljs-variable">mailMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMailMessage</span>();<br><br>        mailMessage.setSubject(<span class="hljs-string">&quot;è‚˜å­å¼€ä½ å¥½&quot;</span>);<br>        mailMessage.setText(<span class="hljs-string">&quot;è°¢è°¢ä½ è‚˜å­å¼€,å¤ªå–œæ¬¢ä½ å•¦&quot;</span>);<br><br>        mailMessage.setTo(<span class="hljs-string">&quot;1735257086@qq.com&quot;</span>);<br>        mailMessage.setFrom(<span class="hljs-string">&quot;1735257086@qq.com&quot;</span>);<br><br>        mailSender.send(mailMessage);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextLoads2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> MessagingException &#123;<br>        <span class="hljs-comment">//ä¸€ä¸ªå¤æ‚çš„é‚®ä»¶</span><br>        <span class="hljs-type">MimeMessage</span> <span class="hljs-variable">mimeMessage</span> <span class="hljs-operator">=</span> mailSender.createMimeMessage();<br><br>        <span class="hljs-type">MimeMessageHelper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MimeMessageHelper</span>(mimeMessage, <span class="hljs-literal">true</span>);<br><br>        helper.setSubject(<span class="hljs-string">&quot;è‚˜å­å¼€ä½ å¥½&quot;</span>);<br>        helper.setText(<span class="hljs-string">&quot;&lt;p style=&#x27;color:red&gt;é‚®ä»¶æµ‹è¯•&lt;/p&gt;&quot;</span>, <span class="hljs-literal">true</span>);   <span class="hljs-comment">//trueä»£è¡¨ä¸ºhtml</span><br><br>        <span class="hljs-comment">//é™„ä»¶</span><br>        helper.addAttachment(<span class="hljs-string">&quot;1.jpg&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;D:\\1.jpg&quot;</span>));<br><br>        helper.setTo(<span class="hljs-string">&quot;1735257086@qq.com&quot;</span>);<br>        helper.setFrom(<span class="hljs-string">&quot;1735257086@qq.com&quot;</span>);<br><br>        mailSender.send(mimeMessage);<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="å®šæ—¶ä»»åŠ¡">å®šæ—¶ä»»åŠ¡</h1><ul><li>åœ¨mainæ–¹æ³•ä¸­æ·»åŠ æ³¨é‡Š</li></ul><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//å¼€å¯å¼‚æ­¥æ³¨è§£åŠŸèƒ½</span><br><span class="hljs-meta">@EnableAsync</span><br><span class="hljs-comment">//å¼€å§‹å®šæ—¶åŠŸèƒ½æ³¨è§£</span><br><span class="hljs-meta">@EnableScheduling</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(TestApplication.class, args);<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>ç¼–å†™éœ€æ±‚</li></ul><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduledService</span> &#123;<br><br>    <span class="hljs-comment">//åœ¨ç‰¹å®šçš„æ—¶é—´ç‚¹æ‰§è¡Œè¿™ä¸ªæ–¹æ³• Timer</span><br>    <span class="hljs-comment">//Cronè¡¨è¾¾å¼</span><br>    <span class="hljs-comment">//ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨å‡ </span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    * 30 15 10 * * ï¼Ÿ    æ¯å¤©çš„10ç‚¹15åˆ†30ç§’</span><br><span class="hljs-comment">    * 30 0/5 10,18 * * ?    æ¯å¤©10ç‚¹å’Œ18ç‚¹ï¼Œæ¯éš”5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡</span><br><span class="hljs-comment">    * */</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0 * * * * 0-7&quot;)</span>  <span class="hljs-comment">//æ¯å¤©æ¯åˆ†é’Ÿçš„ç¬¬0ç§’è¿è¡Œ</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;ä½ è¢«æ‰§è¡Œäº†&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></div></td></tr></table></figure><ul><li>cronè¡¨è¾¾å¼å¯ä»¥åœ¨ç™¾åº¦æŸ¥æ‰¾ç”Ÿæˆå™¨</li></ul><h1 id="æ•´åˆredis">æ•´åˆRedis</h1><ul><li>æ–°å»ºé¡¹ç›®æ—¶éœ€è¦åœ¨éå…³ç³»å‹æ•°æ®åº“(NoSQL)ä¸­å‹¾é€‰ä¸ŠSpring Data Redis(Access+Driver)</li></ul><h1 id="åˆ†å¸ƒå¼ç†è®º">åˆ†å¸ƒå¼ç†è®º</h1>]]></content>
    
    
    <categories>
      
      <category>å¼€å‘</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬åä¸‰è®²-åŸºäºä¸Šä¸‹æ–‡çš„è¡¨å¾ä¸NLPé¢„è®­ç»ƒæ¨¡å‹</title>
    <link href="/2022/06/15/%E7%AC%AC%E5%8D%81%E4%B8%89%E8%AE%B2-%E5%9F%BA%E4%BA%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E8%A1%A8%E5%BE%81%E4%B8%8ENLP%E9%A2%84%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B/"/>
    <url>/2022/06/15/%E7%AC%AC%E5%8D%81%E4%B8%89%E8%AE%B2-%E5%9F%BA%E4%BA%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E8%A1%A8%E5%BE%81%E4%B8%8ENLP%E9%A2%84%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="è¯å‘é‡çŸ¥è¯†å›é¡¾">1 è¯å‘é‡çŸ¥è¯†å›é¡¾</h1><h2 id="è¯å‘é‡è¡¨å¾">1.1 è¯å‘é‡è¡¨å¾</h2><ul><li>ç°åœ¨æˆ‘ä»¬å¯ä»¥è·å¾—ä¸€ä¸ªå•è¯çš„è¡¨ç¤º<ul><li>æˆ‘ä»¬å¼€å§‹æ—¶å­¦è¿‡çš„å•è¯å‘é‡<ul><li>Word2vecï¼ŒGloVeï¼ŒfastText</li></ul></li></ul></li></ul><h2 id="é¢„è®­ç»ƒçš„è¯å‘é‡">1.2 é¢„è®­ç»ƒçš„è¯å‘é‡</h2><ul><li>æˆ‘ä»¬å¯ä»¥éšæœºåˆå§‹åŒ–è¯å‘é‡ï¼Œå¹¶æ ¹æ®æˆ‘ä»¬è‡ªå·±çš„ä¸‹æ¸¸ä»»åŠ¡è®­ç»ƒå®ƒä»¬</li><li>ä½†åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½¿ç”¨é¢„è®­ç»ƒè¯å‘é‡æ˜¯æœ‰å¸®åŠ©çš„ï¼Œå› ä¸ºå®ƒä»¬æœ¬èº«æ˜¯è‡ªå¸¦ä¿¡æ¯çš„(æˆ‘ä»¬å¯ä»¥åœ¨æ›´å¤§ä½“é‡çš„é¢„è®­ç»ƒè¯­æ–™ä¸Šè®­ç»ƒå¾—åˆ°å®ƒä»¬)</li></ul><h2 id="æœªçŸ¥è¯çš„è¯å‘é‡åº”ç”¨å»ºè®®">1.3 æœªçŸ¥è¯çš„è¯å‘é‡åº”ç”¨å»ºè®®</h2><ul><li><p>ç®€å•ä¸”å¸¸è§çš„è§£å†³æ–¹æ¡ˆï¼š</p></li><li><p>è®­ç»ƒæ—¶ï¼šè¯æ±‡è¡¨<span class="math inline">\(\{\text { wordsoccurring, say }, \geq 5 \text { times }\}\cup\{&lt;\mathrm{UNK}&gt;\}\)</span></p><ul><li>å°†<strong>æ‰€æœ‰</strong>ç½•è§çš„è¯ (æ•°æ®é›†ä¸­å‡ºç°æ¬¡æ•°å°äº 5)éƒ½æ˜ å°„ä¸º<spanclass="math inline">\(&lt;UNK&gt;\)</span>ï¼Œä¸ºå…¶è®­ç»ƒä¸€ä¸ªè¯å‘é‡</li></ul></li><li><p><strong>è¿è¡Œæ—¶</strong>ï¼šä½¿ç”¨<spanclass="math inline">\(&lt;UNK&gt;\)</span>ä»£æ›¿è¯æ±‡è¡¨ä¹‹å¤–çš„è¯OOV</p></li><li><p><strong>é—®é¢˜</strong>ï¼š</p><ul><li>æ²¡æœ‰åŠæ³•åŒºåˆ†ä¸åŒ UNK wordsï¼Œæ— è®ºæ˜¯èº«ä»½è¿˜æ˜¯æ„ä¹‰</li></ul></li></ul><p><strong>è§£å†³æ–¹æ¡ˆ</strong></p><p>â€‹ <strong>ä½¿ç”¨å­—ç¬¦çº§æ¨¡å‹å­¦ä¹ è¯å‘é‡</strong></p><ul><li>ç‰¹åˆ«æ˜¯åœ¨ QA ä¸­ï¼Œmatch on word identityæ˜¯å¾ˆé‡è¦çš„ï¼Œå³ä½¿è¯å‘é‡è¯æ±‡è¡¨ä»¥å¤–çš„å•è¯</li></ul><p>â€‹ <strong>å°è¯•è¿™äº›å»ºè®®</strong> (from Dhingra, Liu, Salakhutdinov,Cohen 2017)</p><ul><li><p>å¦‚æœæµ‹è¯•æ—¶çš„<spanclass="math inline">\(&lt;UNK&gt;\)</span>å•è¯ä¸åœ¨ä½ çš„è¯æ±‡è¡¨ä¸­ï¼Œä½†æ˜¯å‡ºç°åœ¨ä½ ä½¿ç”¨çš„æ— ç›‘ç£è¯åµŒå…¥ä¸­ï¼Œæµ‹è¯•æ—¶ç›´æ¥ä½¿ç”¨è¿™ä¸ªå‘é‡</p></li><li><p>æ­¤å¤–ï¼Œä½ å¯ä»¥å°†å…¶è§†ä¸ºæ–°çš„å•è¯ï¼Œå¹¶ä¸ºå…¶åˆ†é…ä¸€ä¸ªéšæœºå‘é‡ï¼Œå°†å®ƒä»¬æ·»åŠ åˆ°ä½ çš„è¯æ±‡è¡¨</p></li><li><p>å¸®åŠ©å¾ˆå¤§æˆ–è€…ä¹Ÿè®¸èƒ½å¸®ç‚¹å¿™</p></li><li><p>ä½ å¯ä»¥è¯•è¯•å¦ä¸€ä»¶äº‹</p><ul><li>å°†å®ƒä»¬åˆ†è§£ä¸ºè¯ç±» (å¦‚æœªçŸ¥å·ç ï¼Œå¤§å†™ç­‰ç­‰)ï¼Œæ¯ç§éƒ½å¯¹åº”ä¸€ä¸ª <spanclass="math inline">\(&lt;UNK-class&gt;\)</span></li></ul></li></ul><h2 id="å•è¯çš„è¡¨ç¤º">1.4 å•è¯çš„è¡¨ç¤º</h2><p><strong>å­˜åœ¨ä¸¤ä¸ªå¤§é—®é¢˜</strong></p><ul><li>å¯¹äºä¸€ä¸ª word type æ€»æ˜¯æ˜¯ç”¨ç›¸åŒçš„è¡¨ç¤ºï¼Œä¸è€ƒè™‘è¿™ä¸ª word tokenå‡ºç°çš„ä¸Šä¸‹æ–‡<ul><li>æˆ‘ä»¬å¯ä»¥è¿›è¡Œéå¸¸ç»†ç²’åº¦çš„è¯ä¹‰æ¶ˆæ­§</li></ul></li><li>æˆ‘ä»¬å¯¹ä¸€ä¸ªè¯åªæœ‰ä¸€ç§è¡¨ç¤ºï¼Œä½†æ˜¯å•è¯æœ‰ä¸åŒçš„æ–¹é¢ï¼ŒåŒ…æ‹¬è¯­ä¹‰ï¼Œå¥æ³•è¡Œä¸ºï¼Œä»¥åŠè¡¨è¾¾/ å«ä¹‰</li></ul><h2 id="æˆ‘ä»¬ä¸€ç›´éƒ½æœ‰è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•å—">1.5æˆ‘ä»¬ä¸€ç›´éƒ½æœ‰è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•å—ï¼Ÿ</h2><ul><li>åœ¨NLMä¸­ï¼Œæˆ‘ä»¬ç›´æ¥å°†å•è¯å‘é‡ (å¯èƒ½åªåœ¨è¯­æ–™åº“ä¸Šè®­ç»ƒ) æ’å…¥LSTMå±‚</li><li>é‚£äº›LSTMå±‚è¢«è®­ç»ƒæ¥é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯</li><li>ä½†è¿™äº›è¯­è¨€æ¨¡å‹åœ¨æ¯ä¸€ä¸ªä½ç½®ç”Ÿæˆç‰¹å®šäºä¸Šä¸‹æ–‡çš„è¯è¡¨ç¤º</li></ul><h2 id="è®ºæ–‡è§£è¯»-peters-et-al.-2017-taglm-pre-elmo">1.6 è®ºæ–‡è§£è¯» Peterset al. (2017): TagLM â€“ â€œPre-ELMoâ€</h2><ul><li><strong>æƒ³æ³•</strong>ï¼šæƒ³è¦è·å¾—å•è¯åœ¨ä¸Šä¸‹æ–‡çš„æ„æ€ï¼Œä½†æ ‡å‡†çš„ RNNå­¦ä¹ ä»»åŠ¡åªåœ¨ task-labeled çš„å°æ•°æ®ä¸Š (å¦‚ NER )</li><li>ä¸ºä»€ä¹ˆä¸é€šè¿‡åŠç›‘ç£å­¦ä¹ çš„æ–¹å¼åœ¨å¤§å‹æ— æ ‡ç­¾æ•°æ®é›†ä¸Šè®­ç»ƒNLMï¼Œè€Œä¸åªæ˜¯è¯å‘é‡</li></ul><h2 id="æ ‡ç­¾è¯­è¨€æ¨¡å‹-tag-lm">1.7 æ ‡ç­¾è¯­è¨€æ¨¡å‹ (Tag LM )</h2><ul><li><strong>æ­¥éª¤3</strong>ï¼šåœ¨åºåˆ—æ ‡è®°æ¨¡å‹ä¸­åŒæ—¶ä½¿ç”¨å•è¯åµŒå…¥å’Œ LMåµŒå…¥</li><li><strong>æ­¥éª¤2</strong>ï¼šä¸ºè¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸ªæ ‡è®°å‡†å¤‡å•è¯åµŒå…¥å’Œ LMåµŒå…¥</li><li><strong>æ­¥éª¤1</strong>ï¼šé¢„è®­ç»ƒè¯åµŒå…¥å’Œè¯­è¨€æ¨¡å‹</li><li>ä¸ä¸Šæ–‡æ— å…³çš„å•è¯åµŒå…¥ + RNN model å¾—åˆ°çš„ hidden statesä½œä¸ºç‰¹å¾è¾“å…¥</li></ul><p><img src="/img/nlp/ç¬¬åä¸‰è®²/1.png" /></p><ul><li>Char CNN / RNN + Token Embedding ä½œä¸º bi-LSTM çš„è¾“å…¥</li><li>å¾—åˆ°çš„ hidden states ä¸ Pre-trained bi-LM (å†»ç»“çš„) çš„ hidden statesè¿æ¥èµ·æ¥è¾“å…¥åˆ°ç¬¬äºŒå±‚çš„ bi-LSTM ä¸­</li></ul><p><img src="/img/nlp/ç¬¬åä¸‰è®²/2.png" /></p><h2 id="å‘½åå®ä½“è¯†åˆ«-ner">1.8 å‘½åå®ä½“è¯†åˆ« (NER)</h2><ul><li>ä¸€ä¸ªéå¸¸é‡è¦çš„NLPå­ä»»åŠ¡ï¼š<strong>æŸ¥æ‰¾</strong>å’Œ<strong>åˆ†ç±»</strong>æ–‡æœ¬ä¸­çš„å®ä½“</li></ul><h2 id="è®ºæ–‡è§£è¯»-peters-et-al.2017-taglm-pre-elmo">1.9 è®ºæ–‡è§£è¯» Peterset al.(2017): TagLM-"Pre-ELMo"</h2><ul><li>è¯­è¨€æ¨¡å‹åœ¨ <code>Billion word benchmark</code>çš„8äº¿ä¸ªè®­ç»ƒå•è¯ä¸Šè®­ç»ƒ</li></ul><p><strong>è¯­è¨€æ¨¡å‹è§‚å¯Ÿç»“æœ</strong></p><ul><li>åœ¨ç›‘ç£æ•°æ®é›†ä¸Šè®­ç»ƒçš„è¯­è¨€æ¨¡å‹å¹¶ä¸ä¼šå—ç›Š</li><li>åŒå‘è¯­è¨€æ¨¡å‹ä»…æœ‰åŠ©äº forward è¿‡ç¨‹ï¼Œæå‡çº¦ 0.2</li><li>å…·æœ‰å·¨å¤§çš„è¯­è¨€æ¨¡å‹è®¾è®¡ (å›°æƒ‘åº¦ 30) æ¯”è¾ƒå°çš„æ¨¡å‹ (å›°æƒ‘åº¦ 48) æå‡çº¦0.3</li></ul><p><strong>ä»»åŠ¡ç‰¹å®šçš„BiLSTMè§‚å¯Ÿç»“æœ</strong></p><ul><li>ä»…ä½¿ç”¨LMåµŒå…¥æ¥é¢„æµ‹å¹¶ä¸æ˜¯å¾ˆå¥½ï¼š88.17 F1<ul><li>è¿œä½äºä»…åœ¨æ ‡è®°æ•°æ®ä¸Šä½¿ç”¨ BiLSTM æ ‡è®°å™¨</li></ul></li></ul><h2 id="è®ºæ–‡è§£è¯»-also-in-the-air-mccann-et-al.2017cove">1.10 è®ºæ–‡è§£è¯»Also in the air: McCann et al.2017:CoVe</h2><ul><li><p>ä¹Ÿæœ‰ä¸€ç§æ€è·¯ï¼šä½¿ç”¨è®­ç»ƒå¥½çš„åºåˆ—æ¨¡å‹ï¼Œä¸ºå…¶ä»–NLPæ¨¡å‹æä¾›ä¸Šä¸‹æ–‡</p></li><li><p><strong>æ€è·¯</strong>ï¼šæœºå™¨ç¿»è¯‘æ˜¯ä¸ºäº†ä¿å­˜æ„æ€ï¼Œæ‰€ä»¥è¿™ä¹Ÿè®¸æ˜¯ä¸ªå¥½ç›®æ ‡ï¼Ÿ</p></li><li><p>ä½¿ç”¨ seq2seq + attention NMT system ä¸­çš„ Encoderï¼Œå³ 2 å±‚bi-LSTMï¼Œä½œä¸ºä¸Šä¸‹æ–‡æä¾›è€…</p></li><li><p>æ‰€å¾—åˆ°çš„ CoVe å‘é‡åœ¨å„ç§ä»»åŠ¡ä¸Šéƒ½ä¼˜äº GloVe å‘é‡</p></li><li><p>ä½†æ˜¯ï¼Œç»“æœå¹¶ä¸åƒå…¶ä»–å¹»ç¯ç‰‡ä¸­æè¿°çš„æ›´ç®€å•çš„ NLMè®­ç»ƒé‚£ä¹ˆå¥½ï¼Œæ‰€ä»¥ä¼¼ä¹è¢«æ”¾å¼ƒäº†</p><ul><li>ä¹Ÿè®¸NMTåªæ˜¯æ¯”è¯­è¨€å»ºæ¨¡æ›´éš¾ï¼Ÿ</li><li>æˆ–è®¸æœ‰ä¸€å¤©è¿™ä¸ªæƒ³æ³•ä¼šå›æ¥ï¼Ÿ</li></ul></li></ul><h1 id="elmoæ¨¡å‹">2.ELMoæ¨¡å‹</h1><h2id="è®ºæ–‡è§£è¯»-peters-et-al.-2018-elmo-embeddings-from-language-models">2.1è®ºæ–‡è§£è¯» Peters et al. (2018): ELMo: Embeddings from LanguageModels</h2><ul><li><p>å•è¯æ ‡è®°å‘é‡æˆ–ä¸Šä¸‹æ–‡è¯å‘é‡çš„çªç ´</p></li><li><p>ä½¿ç”¨é•¿ä¸Šä¸‹æ–‡è€Œä¸æ˜¯ä¸Šä¸‹æ–‡çª—å£å­¦ä¹ è¯æ ‡è®°å‘é‡(è¿™é‡Œï¼Œæ•´ä¸ªå¥å­å¯èƒ½æ›´é•¿)</p></li><li><p>å­¦ä¹ æ·±åº¦ Bi-NLMï¼Œå¹¶åœ¨é¢„æµ‹ä¸­ä½¿ç”¨å®ƒçš„æ‰€æœ‰å±‚</p></li><li><p>è®­ç»ƒä¸€ä¸ªåŒå‘è¯­è¨€æ¨¡å‹ (LM)</p></li><li><p>ç›®æ ‡æ˜¯æ•ˆæœ OK ä½†ä¸è¦å¤ªå¤§çš„è¯­è¨€æ¨¡å‹ (LM)</p><ul><li>ä½¿ç”¨ 2 ä¸ª biLSTM å±‚</li><li>(ä»…) ä½¿ç”¨å­—ç¬¦CNNæ„å»ºåˆå§‹å•è¯è¡¨ç¤º<ul><li>2048 ä¸ª char n-gram filters å’Œ 2 ä¸ª highway layersï¼Œ512 ç»´çš„projection</li></ul></li><li>4096 dim hidden/cell LSTMçŠ¶æ€ï¼Œä½¿ç”¨ 512 dimçš„å¯¹ä¸‹ä¸€ä¸ªè¾“å…¥çš„æŠ•å½±</li><li>ä½¿ç”¨æ®‹å·®è¿æ¥</li><li>ç»‘å®š token çš„è¾“å…¥å’Œè¾“å‡ºçš„å‚æ•°(softmax)ï¼Œå¹¶å°†è¿™äº›å‚æ•°ç»‘å®šåˆ°æ­£å‘å’Œåå‘è¯­è¨€æ¨¡å‹ (LM) ä¹‹é—´</li></ul></li><li><p>ELMo å­¦ä¹  biLM è¡¨ç¤ºçš„ç‰¹å®šä»»åŠ¡ç»„åˆ</p></li><li><p>è¿™æ˜¯ä¸€ä¸ªåˆ›æ–°ï¼ŒTagLM ä¸­ä»…ä»…ä½¿ç”¨å †å  LSTM çš„é¡¶å±‚ï¼ŒELMo è®¤ä¸º BiLSTMæ‰€æœ‰å±‚éƒ½æ˜¯æœ‰ç”¨çš„</p></li></ul><p><span class="math display">\[\begin{aligned}R_{k} &amp;=\left\{\mathbf{x}_{k}^{L M}, \overrightarrow{\mathbf{h}}_{k,j}^{L M}, \overleftarrow{\mathbf{h}}_{k, j}^{L M} \mid j=1, \ldots,L\right\} \\&amp;=\left\{\mathbf{h}_{k, j}^{L M} \mid j=0, \ldots, L\right\}\end{aligned}\]</span></p><p><span class="math display">\[\mathbf{E L M o}_{k}^{\text {task }}=E\left(R_{k} ; \Theta^{\text {task}}\right)=\gamma^{\text {task }} \sum_{j=0}^{L} s_{j}^{\text {task }}\mathbf{h}_{k, j}^{L M}\]</span></p><ul><li><p><span class="math inline">\(\gamma^{t a s k}\)</span>è¡¡é‡ ELMoå¯¹ä»»åŠ¡çš„æ€»ä½“æœ‰ç”¨æ€§ï¼Œæ˜¯ä¸ºç‰¹å®šä»»åŠ¡å­¦ä¹ çš„å…¨å±€æ¯”ä¾‹å› å­</p></li><li><p><span class="math inline">\(s^{task}\)</span>æ˜¯ softmaxå½’ä¸€åŒ–çš„æ··åˆæ¨¡å‹æƒé‡ï¼Œæ˜¯ BiLSTMçš„åŠ æƒå¹³å‡å€¼çš„æƒé‡ï¼Œå¯¹ä¸åŒçš„ä»»åŠ¡æ˜¯ä¸åŒçš„ï¼Œå› ä¸ºä¸åŒçš„ä»»åŠ¡å¯¹ä¸åŒå±‚çš„BiLSTM çš„</p></li><li><p>é¦–å…ˆè¿è¡Œ biLM è·å–æ¯ä¸ªå•è¯çš„è¡¨ç¤º</p></li><li><p>ç„¶åï¼Œè®© (æ— è®ºä»€ä¹ˆ) æœ€ç»ˆä»»åŠ¡æ¨¡å‹ä½¿ç”¨å®ƒä»¬</p><ul><li>å†»ç»“ ELMo çš„æƒé‡ï¼Œç”¨äºç›‘ç£æ¨¡å‹</li><li>å°† ELMo æƒé‡è¿æ¥åˆ°ç‰¹å®šäºä»»åŠ¡çš„æ¨¡å‹ä¸­<ul><li>ç»†èŠ‚å–å†³äºä»»åŠ¡<ul><li>åƒ TagLM ä¸€æ ·è¿æ¥åˆ°ä¸­é—´å±‚æ˜¯å…¸å‹çš„</li><li>å¯ä»¥åœ¨ç”Ÿäº§è¾“å‡ºæ—¶æä¾›æ›´å¤šçš„è¡¨ç¤ºï¼Œä¾‹å¦‚åœ¨é—®ç­”ç³»ç»Ÿä¸­</li></ul></li></ul></li></ul></li></ul><h2 id="elmoåœ¨åºåˆ—æ ‡è®°å™¨ä¸­çš„ä½¿ç”¨">2.2 ELMoåœ¨åºåˆ—æ ‡è®°å™¨ä¸­çš„ä½¿ç”¨</h2><p><img src="/img/nlp/ç¬¬åä¸‰è®²/3.png" /></p><h2 id="elmo-å±‚æƒé‡">2.3 ELMo ï¼šå±‚æƒé‡</h2><ul><li>è¿™ä¸¤ä¸ª biLSTM NLM å±‚æœ‰ä¸åŒçš„ç”¨é€” / å«ä¹‰<ul><li>ä½å±‚æ›´é€‚åˆä½çº§è¯­æ³•ï¼Œä¾‹å¦‚<ul><li>è¯æ€§æ ‡æ³¨(part-of-speech tagging)ã€å¥æ³•ä¾èµ–(syntacticdependency)ã€NER</li></ul></li><li>é«˜å±‚æ›´é€‚åˆæ›´é«˜çº§åˆ«çš„è¯­ä¹‰<ul><li>æƒ…ç»ªã€è¯­ä¹‰è§’è‰²æ ‡è®°ã€é—®ç­”ç³»ç»Ÿã€SNLI</li></ul></li></ul></li><li>è¿™ä¼¼ä¹å¾ˆæœ‰è¶£ï¼Œä½†å®ƒæ˜¯å¦‚ä½•é€šè¿‡ä¸¤å±‚ä»¥ä¸Šçš„ç½‘ç»œæ¥å®ç°çš„çœ‹èµ·æ¥æ›´æœ‰è¶£</li></ul><h1 id="ulmfitæ¨¡å‹">3.ULMfitæ¨¡å‹</h1><h2 id="ulmfit">3.1 ULMfit</h2><ul><li><p>è½¬ç§» NLM çŸ¥è¯†çš„ä¸€èˆ¬æ€è·¯æ˜¯ä¸€æ ·çš„</p></li><li><p>è¿™é‡Œåº”ç”¨äºæ–‡æœ¬åˆ†ç±»</p><p><img src="/img/nlp/ç¬¬åä¸‰è®²/4.png" /></p></li><li><p>åœ¨å¤§å‹é€šç”¨é¢†åŸŸçš„æ— ç›‘ç£è¯­æ–™åº“ä¸Šä½¿ç”¨ biLM è®­ç»ƒ</p><ul><li><p>åœ¨ç›®æ ‡ä»»åŠ¡æ•°æ®ä¸Šè°ƒæ•´ LM</p></li><li><p>å¯¹ç‰¹å®šä»»åŠ¡å°†åˆ†ç±»å™¨è¿›è¡Œå¾®è°ƒ</p><p><img src="/img/nlp/ç¬¬åä¸‰è®²/5.png" /></p></li></ul></li><li><p>ä½¿ç”¨åˆç†å¤§å°çš„ <code>1 GPU</code>è¯­è¨€æ¨¡å‹ï¼Œå¹¶ä¸æ˜¯çœŸçš„å¾ˆå¤§</p></li><li><p>åœ¨LMè°ƒä¼˜ä¸­è¦æ³¨æ„å¾ˆå¤š</p><ul><li>ä¸åŒçš„æ¯å±‚å­¦ä¹ é€Ÿåº¦</li><li>å€¾æ–œä¸‰è§’å½¢å­¦ä¹ ç‡ (STLR) è®¡åˆ’</li></ul></li><li><p>å­¦ä¹ åˆ†ç±»å™¨æ—¶é€æ­¥åˆ†å±‚è§£å†»å’ŒSTLR</p></li><li><p>ä½¿ç”¨<span class="math inline">\(\left[h_{T},\operatorname{maxpool}(\mathbf{h}), \text { meanpool}(\mathbf{h})\right]\)</span>è¿›è¡Œåˆ†ç±»</p></li><li><p>ä½¿ç”¨å¤§å‹çš„é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹ï¼Œæ˜¯ä¸€ç§æé«˜æ€§èƒ½çš„éå¸¸æœ‰æ•ˆçš„æ–¹æ³•</p></li></ul><h1 id="transformerç»“æ„">4.Transformerç»“æ„</h1><h2 id="transformerä»‹ç»">4.1 Transformerä»‹ç»</h2><p><img src="/img/nlp/ç¬¬åä¸‰è®²/6.png" /></p><ul><li>æ‰€æœ‰è¿™äº›æ¨¡å‹éƒ½æ˜¯ä»¥Transformerä¸ºä¸»ç»“æ„çš„ï¼Œæˆ‘ä»¬åº”è¯¥å­¦ä¹ ä¸€ä¸‹Transformerå§</li></ul><p><strong>è¡¥å……è¯´æ˜</strong></p><ul><li>Transformer ä¸ä»…å¾ˆå¼ºå¤§ï¼Œè€Œä¸”å…è®¸æ‰©å±•åˆ°æ›´å¤§çš„å°ºå¯¸</li></ul><h2 id="transformers-åŠ¨æœº">4.2 Transformers åŠ¨æœº</h2><ul><li><p>æˆ‘ä»¬æƒ³è¦å¹¶è¡ŒåŒ–ï¼Œä½†æ˜¯RNNsæœ¬è´¨ä¸Šæ˜¯é¡ºåºçš„</p></li><li><p>å°½ç®¡æœ‰ GRUs å’Œ LSTMsï¼ŒRNNsä»ç„¶éœ€è¦æ³¨æ„æœºåˆ¶æ¥å¤„ç†é•¿æœŸä¾èµ–å…³ç³»â€”â€”å¦åˆ™çŠ¶æ€ä¹‹é—´çš„ path length<strong>è·¯å¾„é•¿åº¦</strong> ä¼šéšç€åºåˆ—å¢é•¿</p></li><li><p>ä½†å¦‚æœæ³¨æ„åŠ›è®©æˆ‘ä»¬è¿›å…¥ä»»ä½•ä¸€ä¸ªçŠ¶æ€â€¦â€¦ä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥åªç”¨æ³¨æ„åŠ›è€Œä¸éœ€è¦RNN?</p></li></ul><h2 id="transformer-æ¦‚è§ˆ">4.3 Transformer æ¦‚è§ˆ</h2><ul><li>åºåˆ—åˆ°åºåˆ—ç¼–ç è§£ç æ¨¡å‹ï¼Œä½†å®ƒæ˜¯éå¾ªç¯éä¸²è¡Œç»“æ„</li><li><strong>ä»»åŠ¡</strong>ï¼šå¹³è¡Œè¯­æ–™åº“çš„æœºå™¨ç¿»è¯‘</li><li>é¢„æµ‹æ¯ä¸ªç¿»è¯‘å•è¯</li><li>æœ€ç»ˆæˆæœ¬/è¯¯å·®å‡½æ•°æ˜¯ softmax åˆ†ç±»å™¨åŸºç¡€ä¸Šçš„æ ‡å‡†äº¤å‰ç†µè¯¯å·®</li></ul><p><img src="/img/nlp/ç¬¬åä¸‰è®²/7.png" /></p><h2 id="transformer-åŸºç¡€">4.4 Transformer åŸºç¡€</h2><ul><li>è‡ªå­¦ transformer<ul><li>ä¸»è¦æ¨èèµ„æº<ul><li>http://nlp.seas.harvard.edu/2018/04/03/attention.html</li><li>The Annotated Transformer by Sasha Rush</li></ul></li><li>ä¸€ä¸ªä½¿ç”¨PyTorchçš„Jupyterç¬”è®°æœ¬ï¼Œè§£é‡Šäº†ä¸€åˆ‡ï¼</li></ul></li><li>ç°åœ¨ï¼šæˆ‘ä»¬å®šä¹‰ Transformer ç½‘ç»œçš„åŸºæœ¬æ„å»ºå—ï¼šç¬¬ä¸€ï¼Œæ–°çš„æ³¨æ„åŠ›å±‚</li></ul><h2 id="ç‚¹ä¹˜æ³¨æ„åŠ›-dot-product-attention">4.5 ç‚¹ä¹˜æ³¨æ„åŠ› Dot-ProductAttention</h2><ul><li><p><strong>è¾“å…¥</strong>ï¼šå¯¹äºä¸€ä¸ªè¾“å‡ºè€Œè¨€çš„æŸ¥è¯¢<spanclass="math inline">\(q\)</span>å’Œä¸€ç»„é”®-å€¼å¯¹<spanclass="math inline">\((k-v)\)</span></p></li><li><p>Queryï¼Œkeysï¼Œvaluesï¼Œand output éƒ½æ˜¯å‘é‡</p></li><li><p>è¾“å‡ºå€¼çš„åŠ æƒå’Œ</p></li><li><p>æƒé‡çš„æ¯ä¸ªå€¼æ˜¯ç”±æŸ¥è¯¢å’Œç›¸å…³é”®çš„å†…ç§¯è®¡ç®—ç»“æœ</p></li><li><p>Query å’Œ keys æœ‰ç›¸åŒç»´æ•°<spanclass="math inline">\(d_k\)</span>ï¼Œvalue çš„ç»´æ•°ä¸º<spanclass="math inline">\(d_v\)</span></p></li></ul><p><span class="math display">\[A(q, K, V)=\sum_{i} \frac{e^{q \cdot k_{i}}}{\sum_{j} e^{q \cdot k_{j}}}v_{i}\]</span></p><h2 id="ç‚¹ä¹˜æ³¨æ„åŠ›çŸ©é˜µè¡¨ç¤ºæ³•">4.6 ç‚¹ä¹˜æ³¨æ„åŠ›çŸ©é˜µè¡¨ç¤ºæ³•</h2><ul><li>å½“æˆ‘ä»¬æœ‰å¤šä¸ªæŸ¥è¯¢<spanclass="math inline">\(q\)</span>æ—¶ï¼Œæˆ‘ä»¬å°†å®ƒä»¬å åŠ åœ¨ä¸€ä¸ªçŸ©é˜µ<spanclass="math inline">\(Q\)</span>ä¸­</li><li>å˜æˆ<span class="math inline">\(A(Q, K,V)=\operatorname{softmax}\left(Q K^{T}\right) V\)</span></li></ul><h2 id="ç¼©æ”¾ç‚¹ä¹˜æ³¨æ„åŠ›">4.7 ç¼©æ”¾ç‚¹ä¹˜æ³¨æ„åŠ›</h2><ul><li><p><strong>é—®é¢˜</strong>ï¼š<spanclass="math inline">\(d_k\)</span>å˜å¤§æ—¶ï¼Œ<spanclass="math inline">\(q^Tk\)</span>çš„æ–¹å·®å¢å¤§ â†’ ä¸€äº› softmaxä¸­çš„å€¼çš„æ–¹å·®å°†ä¼šå˜å¤§ â†’ softmax å¾—åˆ°çš„æ˜¯å³°å€¼ â†’ å› æ­¤æ¢¯åº¦å˜å°äº†</p></li><li><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šé€šè¿‡ query / keyå‘é‡çš„é•¿åº¦è¿›è¡Œç¼©æ”¾</p></li></ul><p><span class="math display">\[A(Q, K, V)=\operatorname{softmax}\left(\frac{QK^{T}}{\sqrt{d_{k}}}\right) V\]</span></p><p><img src="/img/nlp/ç¬¬åä¸‰è®²/11.png" /></p><p><img src="/img/nlp/ç¬¬åä¸‰è®²/9.png" /></p><p><img src="/img/nlp/ç¬¬åä¸‰è®²/8.png" /></p><p><img src="/img/nlp/ç¬¬åä¸‰è®²/10.png" /></p><h2 id="ç¼–ç å™¨ä¸­çš„è‡ªæ³¨æ„åŠ›">4.8 ç¼–ç å™¨ä¸­çš„è‡ªæ³¨æ„åŠ›</h2><ul><li><p>è¾“å…¥å•è¯å‘é‡æ˜¯ queriesï¼Œkeys and values</p></li><li><p>æ¢å¥è¯è¯´ï¼š<strong>è¿™ä¸ªè¯å‘é‡è‡ªå·±é€‰æ‹©å½¼æ­¤</strong></p></li><li><p>è¯å‘é‡å †æ ˆ= Q = K = V</p></li><li><p>æˆ‘ä»¬ä¼šé€šè¿‡è§£ç å™¨æ˜ç™½ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨å®šä¹‰ä¸­å°†ä»–ä»¬åˆ†å¼€</p></li></ul><h2 id="å¤šå¤´æ³¨æ„åŠ›">4.9 å¤šå¤´æ³¨æ„åŠ›</h2><ul><li>ç®€å• self-attention çš„é—®é¢˜<ul><li>å•è¯åªæœ‰ä¸€ç§ç›¸äº’äº¤äº’çš„æ–¹å¼</li></ul></li><li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š<strong>å¤šå¤´æ³¨æ„åŠ›</strong></li><li>é¦–å…ˆï¼Œé€šè¿‡çŸ©é˜µ<span class="math inline">\(W\)</span>å°†<spanclass="math inline">\(Q\)</span>ï¼Œ<spanclass="math inline">\(K\)</span>ï¼Œ<spanclass="math inline">\(V\)</span>æ˜ å°„åˆ°<spanclass="math inline">\(h=8\)</span>çš„è®¸å¤šä½ç»´ç©ºé—´</li><li>ç„¶åï¼Œåº”ç”¨æ³¨æ„åŠ›ï¼Œç„¶åè¿æ¥è¾“å‡ºï¼Œé€šè¿‡çº¿æ€§å±‚</li></ul><p><span class="math display">\[\operatorname{MultiHead}(\boldsymbol{Q}, \boldsymbol{K},\boldsymbol{V})=\operatorname{Concat}\left(\right.  head  _{1}, \ldots ,head  \left._{h}\right)  where \ head\  hention  _{i}=  Attention (\left.Q W_{i}^{Q}, K W_{i}^{K}, V W_{i}^{V}\right)\]</span></p><p><img src="/img/nlp/ç¬¬åä¸‰è®²/12.png" /></p><p><img src="/img/nlp/ç¬¬åä¸‰è®²/13.png" /></p><h2 id="å®Œæ•´çš„transformeræ¨¡å—">4.10 å®Œæ•´çš„transformeræ¨¡å—</h2><ul><li><p>æ¯ä¸ª Block éƒ½æœ‰ä¸¤ä¸ªå­å±‚</p><ul><li><p>å¤šå¤´ attention</p></li><li><p>ä¸¤å±‚çš„å‰é¦ˆç¥ç»ç½‘ç»œï¼Œä½¿ç”¨ ReLU</p></li></ul></li><li><p>è¿™ä¸¤ä¸ªå­å±‚éƒ½</p><ul><li>æ®‹å·®è¿æ¥ä»¥åŠå±‚å½’ä¸€åŒ–</li><li>LayerNorm(x+Sublayer(x))</li><li>å±‚å½’ä¸€åŒ–å°†è¾“å…¥è½¬åŒ–ä¸ºå‡å€¼æ˜¯0ï¼Œæ–¹å·®æ˜¯1ï¼Œæ¯ä¸€å±‚å’Œæ¯ä¸€ä¸ªè®­ç»ƒç‚¹(å¹¶ä¸”æ·»åŠ äº†ä¸¤ä¸ªå‚æ•°)</li></ul></li></ul><p><span class="math display">\[\mu^{l}=\frac{1}{H} \sum_{i=1}^{H} a_{i}^{l} \quad\sigma^{l}=\sqrt{\frac{1}{H}\sum_{i=1}^{H}\left(a_{i}^{l}-\mu^{l}\right)^{2}} \quadh_{i}=f\left(\frac{g_{i}}{\sigma_{i}}\left(a_{i}-\mu_{i}\right)+b_{i}\right)\]</span></p><h2 id="ç¼–ç å™¨è¾“å…¥">4.11 ç¼–ç å™¨è¾“å…¥</h2><ul><li><p>å®é™…çš„è¯è¡¨ç¤ºæ˜¯ byte-pair ç¼–ç </p></li><li><p>è¿˜æ·»åŠ äº†ä¸€ä¸ª positional encodingä½ç½®ç¼–ç ï¼Œç›¸åŒçš„è¯è¯­åœ¨ä¸åŒçš„ä½ç½®æœ‰ä¸åŒçš„æ•´ä½“è¡¨å¾</p></li></ul><p><span class="math display">\[\left\{\begin{array}{l}P E(p o s, 2 i)=\sin \left(p o s / 10000^{2 i / d_{\text {model}}}\right) \\P E(\operatorname{pos}, 2 i+1)=\cos \left(p o s / 10000^{2 i / d_{\text{model }}}\right)\end{array}\right.\]</span></p><p><img src="/img/nlp/ç¬¬åä¸‰è®²/14.png" /></p><h2 id="å®Œæ•´ç¼–ç å™¨encoder">4.12 å®Œæ•´ç¼–ç å™¨Encoder</h2><ul><li><p>encoder ä¸­ï¼Œæ¯ä¸ª Block éƒ½æ˜¯æ¥è‡ªå‰ä¸€å±‚çš„<spanclass="math inline">\(Q,K,V\)</span></p></li><li><p>Blocks è¢«é‡å¤ 6 æ¬¡ (å‚ç›´æ–¹å‘)</p></li><li><p>åœ¨æ¯ä¸ªé˜¶æ®µï¼Œä½ å¯ä»¥é€šè¿‡å¤šå¤´æ³¨æ„åŠ›çœ‹åˆ°å¥å­ä¸­çš„å„ä¸ªåœ°æ–¹ï¼Œç´¯ç§¯ä¿¡æ¯å¹¶å°†å…¶æ¨é€åˆ°ä¸‹ä¸€å±‚ã€‚åœ¨ä»»ä¸€æ–¹å‘ä¸Šçš„åºåˆ—é€æ­¥æ¨é€ä¿¡æ¯æ¥è®¡ç®—æ„Ÿå…´è¶£çš„å€¼</p></li><li><p>éå¸¸å–„äºå­¦ä¹ è¯­è¨€ç»“æ„</p></li></ul><p><img src="/img/nlp/ç¬¬åä¸‰è®²/15.png" /></p><h2 id="æ³¨æ„åŠ›å¯è§†åŒ–">4.13 æ³¨æ„åŠ›å¯è§†åŒ–</h2><p><img src="/img/nlp/ç¬¬åä¸‰è®²/16.png" /></p><h2 id="transformerè§£ç å™¨">4.14 Transformerè§£ç å™¨</h2><ul><li><p>decoder ä¸­æœ‰ä¸¤ä¸ªç¨åŠ æ”¹å˜çš„å­å±‚</p></li><li><p>å¯¹ä¹‹å‰ç”Ÿæˆçš„è¾“å‡ºè¿›è¡Œ Masked decoder self-attention</p></li><li><p>Encoder-Decoder Attentionï¼Œqueries æ¥è‡ªäºå‰ä¸€ä¸ª decoder å±‚ï¼Œkeyså’Œ values æ¥è‡ªäº encoder çš„è¾“å‡º</p></li><li><p>Blocks åŒæ ·é‡å¤ 6 æ¬¡</p></li></ul><p><img src="/img/nlp/ç¬¬åä¸‰è®²/17.png" /></p><h2 id="transformerçš„æŠ€å·§ä¸å»ºè®®">4.15 Transformerçš„æŠ€å·§ä¸å»ºè®®</h2><p><strong>ç»†èŠ‚</strong>(è®ºæ–‡/ä¹‹åçš„è®²åº§)</p><ul><li><p>Byte-pair encodings</p></li><li><p>Checkpoint averaging</p></li><li><p>Adam ä¼˜åŒ–å™¨æ§åˆ¶å­¦ä¹ é€Ÿç‡å˜åŒ–</p></li><li><p>è®­ç»ƒæ—¶ï¼Œåœ¨æ¯ä¸€å±‚æ·»åŠ æ®‹å·®ä¹‹å‰è¿›è¡Œ Dropout</p></li><li><p>æ ‡ç­¾å¹³æ»‘</p></li><li><p>å¸¦æœ‰æŸæœç´¢å’Œé•¿åº¦æƒ©ç½šçš„è‡ªå›å½’è§£ç </p></li><li><p>å› ä¸º transformeræ­£åœ¨è”“å»¶ï¼Œä½†ä»–ä»¬å¾ˆéš¾ä¼˜åŒ–å¹¶ä¸”ä¸åƒLSTMsé‚£æ ·å¼€ç®±å³ç”¨ï¼Œä»–ä»¬è¿˜ä¸èƒ½å¾ˆå¥½ä¸å…¶ä»–ä»»åŠ¡çš„æ„ä»¶å…±åŒå·¥ä½œ</p></li></ul><h1 id="bertæ¨¡å‹">5.BERTæ¨¡å‹</h1><h2 id="è®ºæ–‡è§£è¯»-bert-devlin-chang-lee-toutanova-2018">5.1 è®ºæ–‡è§£è¯»BERT: Devlin, Chang, Lee, Toutanova (2018)</h2><ul><li><p>BERTï¼šç”¨äºè¯­è¨€ç†è§£çš„é¢„è®­ç»ƒæ·±åº¦åŒå‘ transformers</p></li><li><p>é—®é¢˜ï¼šè¯­è¨€æ¨¡å‹åªä½¿ç”¨å·¦ä¸Šä¸‹æ–‡æˆ–å³ä¸Šä¸‹æ–‡ï¼Œä½†è¯­è¨€ç†è§£æ˜¯åŒå‘çš„</p></li><li><p>ä¸ºä»€ä¹ˆLMsæ˜¯å•å‘çš„ï¼Ÿ</p><ul><li><strong>åŸå› 1</strong>ï¼šæ–¹å‘æ€§å¯¹äºç”Ÿæˆæ ¼å¼è‰¯å¥½çš„æ¦‚ç‡åˆ†å¸ƒæ˜¯æœ‰å¿…è¦çš„[æˆ‘ä»¬ä¸åœ¨ä¹è¿™ä¸ª]</li><li><strong>åŸå› 2</strong>ï¼šåŒå‘ç¼–ç å™¨ä¸­å•è¯å¯ä»¥<code>çœ‹åˆ°è‡ªå·±</code></li></ul></li></ul><p><img src="/img/nlp/ç¬¬åä¸‰è®²/18.png" /></p><ul><li><p>è§£å†³æ–¹æ¡ˆï¼šæ©ç›–k%çš„è¾“å…¥å•è¯ï¼Œç„¶åé¢„æµ‹ masked words</p></li><li><p>ä¸å†æ˜¯ä¼ ç»Ÿçš„è®¡ç®—ç”Ÿæˆå¥å­çš„æ¦‚ç‡çš„è¯­è¨€æ¨¡å‹ï¼Œç›®æ ‡æ˜¯å¡«ç©º</p><ul><li>æ€»æ˜¯ä½¿ç”¨k=15%</li></ul></li><li><p>Masking å¤ªå°‘ï¼šè®­ç»ƒå¤ªæ˜‚è´µ</p></li><li><p>Masking å¤ªå¤šï¼šæ²¡æœ‰è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡</p></li><li><p><strong>GPT</strong> æ˜¯ç»å…¸çš„å•é¡¹çš„è¯­è¨€æ¨¡å‹</p></li><li><p><strong>ELMo</strong>æ˜¯åŒå‘çš„ï¼Œä½†æ˜¯ä¸¤ä¸ªæ¨¡å‹æ˜¯å®Œå…¨ç‹¬ç«‹è®­ç»ƒçš„ï¼Œåªæ˜¯å°†è¾“å‡ºè¿æ¥åœ¨ä¸€èµ·ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨åŒå‘çš„context</p></li><li><p><strong>BERT</strong> ä½¿ç”¨ maskçš„æ–¹å¼è¿›è¡Œæ•´ä¸ªä¸Šä¸‹æ–‡çš„é¢„æµ‹ï¼Œä½¿ç”¨äº†åŒå‘çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</p></li></ul><p><img src="/img/nlp/ç¬¬åä¸‰è®²/19.png" /></p><h2 id="bert-æ¨¡å‹å¾®è°ƒ">5.2 BERT æ¨¡å‹å¾®è°ƒ</h2><ul><li>åªå­¦ä¹ ä¸€ä¸ªå»ºç«‹åœ¨é¡¶å±‚çš„åˆ†ç±»å™¨ï¼Œå¾®è°ƒçš„æ¯ä¸ªä»»åŠ¡</li></ul><p><img src="/img/nlp/ç¬¬åä¸‰è®²/120.png" /></p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬åä¸€è®²-NLPä¸­çš„å·ç§¯ç¥ç»ç½‘ç»œ</title>
    <link href="/2022/06/15/%E7%AC%AC%E5%8D%81%E4%B8%80%E8%AE%B2-NLP%E4%B8%AD%E7%9A%84%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/"/>
    <url>/2022/06/15/%E7%AC%AC%E5%8D%81%E4%B8%80%E8%AE%B2-NLP%E4%B8%AD%E7%9A%84%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬åè®²-NLPä¸­çš„é—®ç­”ç³»ç»Ÿ</title>
    <link href="/2022/06/06/%E7%AC%AC%E5%8D%81%E8%AE%B2-NLP%E4%B8%AD%E7%9A%84%E9%97%AE%E7%AD%94%E7%B3%BB%E7%BB%9F/"/>
    <url>/2022/06/06/%E7%AC%AC%E5%8D%81%E8%AE%B2-NLP%E4%B8%AD%E7%9A%84%E9%97%AE%E7%AD%94%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="squadé—®ç­”æ•°æ®é›†">1ã€SQuADé—®ç­”æ•°æ®é›†</h1><h2 id="æ–¯å¦ç¦é—®ç­”æ•°æ®é›†-squad">1.1 æ–¯å¦ç¦é—®ç­”æ•°æ®é›† (SQuAD)</h2><ul><li><p>Passageæ˜¯æ¥è‡ªç»´åŸºç™¾ç§‘çš„ä¸€æ®µæ–‡æœ¬ï¼Œç³»ç»Ÿéœ€è¦å›ç­”é—®é¢˜ï¼Œåœ¨æ–‡ç« ä¸­æ‰¾å‡ºç­”æ¡ˆ</p></li><li><p><span class="math inline">\(1000k\)</span>ä¸ªæ ·æœ¬</p></li><li><p>ç­”æ¡ˆå¿…é¡»æ˜¯æ–‡ç« ä¸­çš„ä¸€ç³»åˆ—å•è¯åºåˆ—</p></li><li><p>ä¹Ÿå°±æ˜¯æå–å¼é—®ç­”</p></li></ul><h2 id="squad-è¯„ä¼°v1.1">1.2 SQuAD è¯„ä¼°ï¼Œv1.1</h2><p>ä½œè€…æ”¶é›†äº†3ä¸ªå‚è€ƒç­”æ¡ˆ</p><p>ç³»ç»Ÿåœ¨ä¸¤ä¸ªæŒ‡æ ‡ä¸Šè®¡ç®—å¾—åˆ† -<strong>ç²¾ç¡®åŒ¹é…</strong>ï¼š1/0çš„å‡†ç¡®åº¦ï¼Œä½ æ˜¯å¦åŒ¹é…ä¸‰ä¸ªç­”æ¡ˆä¸­çš„ä¸€ä¸ª -F1ï¼šå°†ç³»ç»Ÿå’Œæ¯ä¸ªç­”æ¡ˆéƒ½è§†ä¸ºè¯è¢‹ï¼Œå¹¶è¯„ä¼°</p><p><span class="math display">\[\text { Precision }=\frac{T P}{T P+F P}\]</span></p><p><span class="math display">\[\text { Recall }=\frac{T P}{T P+F N}\]</span></p><p><span class="math display">\[\text { harmonic mean } \mathrm{F} 1=\frac{2 P R}{P+R}\]</span></p><ul><li>åˆ†æ•°æ˜¯ (å®è§‚) å¹³å‡æ¯é¢˜ F1åˆ†æ•°</li></ul><p>F1æµ‹é‡è¢«è§†ä¸ºæ›´å¯é çš„æŒ‡æ ‡ï¼Œä½œä¸ºä¸»è¦æŒ‡æ ‡ä½¿ç”¨</p><ul><li>å®ƒä¸æ˜¯åŸºäºé€‰æ‹©æ˜¯å¦å’Œäººç±»é€‰æ‹©çš„è·¨åº¦å®Œå…¨ç›¸åŒï¼Œäººç±»é€‰æ‹©çš„è·¨åº¦å®¹æ˜“å—åˆ°å„ç§å½±å“ï¼ŒåŒ…æ‹¬æ¢è¡Œ</li><li>åœ¨å•æ¬¡çº§åˆ«åŒ¹é…ä¸åŒçš„ç­”æ¡ˆ</li></ul><p>è¿™ä¸¤ä¸ªæŒ‡æ ‡å¿½è§†æ ‡ç‚¹ç¬¦å·å’Œå† è¯ (a, an, the only)</p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>æ–°é—»æ–‡æœ¬åˆ†ç±»</title>
    <link href="/2022/05/20/%E6%96%B0%E9%97%BB%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/"/>
    <url>/2022/05/20/%E6%96%B0%E9%97%BB%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="è§£é¢˜æ€è·¯">è§£é¢˜æ€è·¯</h1><p>èµ›é¢˜æ€è·¯åˆ†æï¼šèµ›é¢˜æœ¬è´¨æ˜¯ä¸€ä¸ªæ–‡æœ¬åˆ†ç±»é—®é¢˜ï¼Œéœ€è¦æ ¹æ®æ¯å¥çš„å­—ç¬¦è¿›è¡Œåˆ†ç±»ã€‚ä½†èµ›é¢˜ç»™å‡ºçš„æ•°æ®æ˜¯åŒ¿ååŒ–çš„ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨ä¸­æ–‡åˆ†è¯ç­‰æ“ä½œï¼Œè¿™ä¸ªæ˜¯èµ›é¢˜çš„éš¾ç‚¹ã€‚</p><p>å› æ­¤æœ¬æ¬¡èµ›é¢˜çš„éš¾ç‚¹æ˜¯éœ€è¦å¯¹åŒ¿åå­—ç¬¦è¿›è¡Œå»ºæ¨¡ï¼Œè¿›è€Œå®Œæˆæ–‡æœ¬åˆ†ç±»çš„è¿‡ç¨‹ã€‚ç”±äºæ–‡æœ¬æ•°æ®æ˜¯ä¸€ç§å…¸å‹çš„éç»“æ„åŒ–æ•°æ®ï¼Œå› æ­¤å¯èƒ½æ¶‰åŠåˆ°<code>ç‰¹å¾æå–</code>å’Œ<code>åˆ†ç±»æ¨¡å‹</code>ä¸¤ä¸ªéƒ¨åˆ†ã€‚ä¸ºäº†å‡ä½å‚èµ›éš¾åº¦ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€äº›è§£é¢˜æ€è·¯ä¾›å¤§å®¶å‚è€ƒï¼š</p><ul><li>æ€è·¯1ï¼šTF-IDF + æœºå™¨å­¦ä¹ åˆ†ç±»å™¨</li></ul><p>ç›´æ¥ä½¿ç”¨TF-IDFå¯¹æ–‡æœ¬æå–ç‰¹å¾ï¼Œå¹¶ä½¿ç”¨åˆ†ç±»å™¨è¿›è¡Œåˆ†ç±»ã€‚åœ¨åˆ†ç±»å™¨çš„é€‰æ‹©ä¸Šï¼Œå¯ä»¥ä½¿ç”¨SVMã€LRã€æˆ–è€…XGBoostã€‚</p><ul><li>æ€è·¯2ï¼šFastText</li></ul><p>FastTextæ˜¯å…¥é—¨æ¬¾çš„è¯å‘é‡ï¼Œåˆ©ç”¨Facebookæä¾›çš„FastTextå·¥å…·ï¼Œå¯ä»¥å¿«é€Ÿæ„å»ºå‡ºåˆ†ç±»å™¨ã€‚</p><ul><li>æ€è·¯3ï¼šWordVec + æ·±åº¦å­¦ä¹ åˆ†ç±»å™¨</li></ul><p>WordVecæ˜¯è¿›é˜¶æ¬¾çš„è¯å‘é‡ï¼Œå¹¶é€šè¿‡æ„å»ºæ·±åº¦å­¦ä¹ åˆ†ç±»å®Œæˆåˆ†ç±»ã€‚æ·±åº¦å­¦ä¹ åˆ†ç±»çš„ç½‘ç»œç»“æ„å¯ä»¥é€‰æ‹©TextCNNã€TextRNNæˆ–è€…BiLSTMã€‚</p><ul><li>æ€è·¯4ï¼šBertè¯å‘é‡</li></ul><p>Bertæ˜¯é«˜é…æ¬¾çš„è¯å‘é‡ï¼Œå…·æœ‰å¼ºå¤§çš„å»ºæ¨¡å­¦ä¹ èƒ½åŠ›ã€‚</p><h2 id="æ•°æ®ä¸‹è½½">æ•°æ®ä¸‹è½½</h2><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">! mkdir ./data<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">train data</span><br>! wget https://tianchi-competition.oss-cn-hangzhou.aliyuncs.com/531810/train_set.csv.zip<br>! unzip train_set.csv.zip -d ./data<br>! rm train_set.csv.zip<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">test</span> data</span><br>! wget https://tianchi-competition.oss-cn-hangzhou.aliyuncs.com/531810/test_a.csv.zip<br>! unzip test_a.csv.zip -d ./data<br>! rm test_a.csv.zip<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">2.é¢„è®­ç»ƒä¸‹è½½</span><br>! wget http://tianchi-media.oss-cn-beijing.aliyuncs.com/dragonball/NLP/emb.zip<br>! unzip emb.zip<br>! rm emb.zip<br>! mv ./emb/bert-mini/bert_config.json ./emb/bert-mini/config.json <br></code></pre></div></td></tr></table></figure><h2 id="æ–°å»ºä¿å­˜ç›®å½•">æ–°å»ºä¿å­˜ç›®å½•</h2><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">! mkdir ./save<br></code></pre></div></td></tr></table></figure><h2 id="å®‰è£…å¿…è¦åŒ…">å®‰è£…å¿…è¦åŒ…</h2><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">! pip install fasttext transformers==2.9.0 gensim torch==1.3.0<br></code></pre></div></td></tr></table></figure><h2 id="æ•°æ®è¯»å–">æ•°æ®è¯»å–</h2><p>èµ›é¢˜æ•°æ®è™½ç„¶æ˜¯æ–‡æœ¬æ•°æ®ï¼Œæ¯ä¸ªæ–°é—»æ˜¯ä¸å®šé•¿çš„ï¼Œä½†ä»»ç„¶ä½¿ç”¨csvæ ¼å¼è¿›è¡Œå­˜å‚¨ã€‚å› æ­¤å¯ä»¥ç›´æ¥ç”¨<code>Pandas</code>å®Œæˆæ•°æ®è¯»å–çš„æ“ä½œã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br>train_df = pd.read_csv(<span class="hljs-string">&#x27;./data/train_set.csv&#x27;</span>, sep=<span class="hljs-string">&#x27;\t&#x27;</span>, nrows=<span class="hljs-number">100</span>)<br></code></pre></div></td></tr></table></figure><p>è¿™é‡Œçš„<code>read_csv</code>ç”±ä¸‰éƒ¨åˆ†æ„æˆï¼š</p><ul><li>è¯»å–çš„æ–‡ä»¶è·¯å¾„ï¼Œè¿™é‡Œéœ€è¦æ ¹æ®æ”¹æˆä½ æœ¬åœ°çš„è·¯å¾„ï¼Œå¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„ï¼›</li><li>åˆ†éš”ç¬¦<code>sep</code>ï¼Œä¸ºæ¯åˆ—åˆ†å‰²çš„å­—ç¬¦ï¼Œè®¾ç½®ä¸º<code>\t</code>å³å¯ï¼›</li><li>è¯»å–è¡Œæ•°<code>nrows</code>ï¼Œä¸ºæ­¤æ¬¡è¯»å–æ–‡ä»¶çš„å‡½æ•°ï¼Œæ˜¯æ•°å€¼ç±»å‹ï¼ˆç”±äºæ•°æ®é›†æ¯”è¾ƒå¤§ï¼Œå»ºè®®å…ˆè®¾ç½®ä¸º100ï¼‰ï¼›</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">train_df.head()<br></code></pre></div></td></tr></table></figure><table><thead><tr class="header"><th style="text-align: left;">label</th><th style="text-align: left;">text</th><th></th></tr></thead><tbody><tr class="odd"><td style="text-align: left;">0</td><td style="text-align: left;">2</td><td>2967 6758 339 2021 1854 3731 4109 3792 4149 15...</td></tr><tr class="even"><td style="text-align: left;">1</td><td style="text-align: left;">11</td><td>4464 486 6352 5619 2465 4802 1452 3137 5778 54...</td></tr><tr class="odd"><td style="text-align: left;">2</td><td style="text-align: left;">3</td><td>7346 4068 5074 3747 5681 6093 1777 2226 7354 6...</td></tr><tr class="even"><td style="text-align: left;">3</td><td style="text-align: left;">2</td><td>7159 948 4866 2109 5520 2490 211 3956 5520 549...</td></tr><tr class="odd"><td style="text-align: left;">4</td><td style="text-align: left;">3</td><td>3646 3055 3055 2490 4659 6065 3370 5814 2465 5...</td></tr></tbody></table><p>ä¸Šå›¾æ˜¯è¯»å–å¥½çš„æ•°æ®ï¼Œæ˜¯è¡¨æ ¼çš„å½¢å¼ã€‚ç¬¬ä¸€åˆ—ä¸ºæ–°é—»çš„ç±»åˆ«ï¼Œç¬¬äºŒåˆ—ä¸ºæ–°é—»çš„å­—ç¬¦ã€‚</p><h1 id="æ•°æ®åˆ†æ">æ•°æ®åˆ†æ</h1><p>åœ¨è¯»å–å®Œæˆæ•°æ®é›†åï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¯¹æ•°æ®é›†è¿›è¡Œæ•°æ®åˆ†æçš„æ“ä½œã€‚è™½ç„¶å¯¹äºéç»“æ„æ•°æ®å¹¶ä¸éœ€è¦åšå¾ˆå¤šçš„æ•°æ®åˆ†æï¼Œä½†é€šè¿‡æ•°æ®åˆ†æè¿˜æ˜¯å¯ä»¥æ‰¾å‡ºä¸€äº›è§„å¾‹çš„ã€‚</p><p>æ­¤æ­¥éª¤æˆ‘ä»¬è¯»å–äº†æ‰€æœ‰çš„è®­ç»ƒé›†æ•°æ®ï¼Œåœ¨æ­¤æˆ‘ä»¬é€šè¿‡æ•°æ®åˆ†æå¸Œæœ›å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š</p><ul><li>èµ›é¢˜æ•°æ®ä¸­ï¼Œæ–°é—»æ–‡æœ¬çš„é•¿åº¦æ˜¯å¤šå°‘ï¼Ÿ</li><li>èµ›é¢˜æ•°æ®çš„ç±»åˆ«åˆ†å¸ƒæ˜¯æ€ä¹ˆæ ·çš„ï¼Œå“ªäº›ç±»åˆ«æ¯”è¾ƒå¤šï¼Ÿ</li><li>èµ›é¢˜æ•°æ®ä¸­ï¼Œå­—ç¬¦åˆ†å¸ƒæ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ</li></ul><h2 id="å¥å­é•¿åº¦åˆ†æ">å¥å­é•¿åº¦åˆ†æ</h2><p>åœ¨èµ›é¢˜æ•°æ®ä¸­æ¯è¡Œå¥å­çš„å­—ç¬¦ä½¿ç”¨ç©ºæ ¼è¿›è¡Œéš”å¼€ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç»Ÿè®¡å•è¯çš„ä¸ªæ•°æ¥å¾—åˆ°æ¯ä¸ªå¥å­çš„é•¿åº¦ã€‚ç»Ÿè®¡å¹¶å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">%pylab inline<br>train_df[<span class="hljs-string">&#x27;text_len&#x27;</span>] = train_df[<span class="hljs-string">&#x27;text&#x27;</span>].apply(<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">len</span>(x.split(<span class="hljs-string">&#x27; &#x27;</span>)))<br><span class="hljs-built_in">print</span>(train_df[<span class="hljs-string">&#x27;text_len&#x27;</span>].describe())<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">opulating the interactive namespace from numpy and matplotlib<br>count     100.000000<br>mean      872.320000<br>std       923.138191<br>min        64.000000<br><span class="hljs-meta prompt_">25% </span><span class="language-bash">      359.500000</span><br><span class="hljs-meta prompt_">50% </span><span class="language-bash">      598.000000</span><br><span class="hljs-meta prompt_">75% </span><span class="language-bash">     1058.000000</span><br>max      7125.000000<br>Name: text_len, dtype: float64<br></code></pre></div></td></tr></table></figure><p>å¯¹æ–°é—»å¥å­çš„ç»Ÿè®¡å¯ä»¥å¾—å‡ºï¼Œæœ¬æ¬¡èµ›é¢˜ç»™å®šçš„æ–‡æœ¬æ¯”è¾ƒé•¿ï¼Œæ¯ä¸ªå¥å­å¹³å‡ç”±907ä¸ªå­—ç¬¦æ„æˆï¼Œæœ€çŸ­çš„å¥å­é•¿åº¦ä¸º2ï¼Œæœ€é•¿çš„å¥å­é•¿åº¦ä¸º57921ã€‚</p><h2 id="æ–°é—»ç±»åˆ«åˆ†å¸ƒ">æ–°é—»ç±»åˆ«åˆ†å¸ƒ</h2><p>æ¥ä¸‹æ¥å¯ä»¥å¯¹æ•°æ®é›†çš„ç±»åˆ«è¿›è¡Œåˆ†å¸ƒç»Ÿè®¡ï¼Œå…·ä½“ç»Ÿè®¡æ¯ç±»æ–°é—»çš„æ ·æœ¬ä¸ªæ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">train_df[<span class="hljs-string">&#x27;label&#x27;</span>].value_counts().plot(kind=<span class="hljs-string">&#x27;bar&#x27;</span>)<br>plt.title(<span class="hljs-string">&#x27;News class count&#x27;</span>)<br>plt.xlabel(<span class="hljs-string">&quot;category&quot;</span>)<br></code></pre></div></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">Text</span><span class="hljs-params">(<span class="hljs-number">0.5</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;category&#x27;</span>)</span></span><br></code></pre></div></td></tr></table></figure><p><img src="/img/nlp/æ–°é—»æ–‡æœ¬åˆ†ç±»/1.png" /></p><p>åœ¨æ•°æ®é›†ä¸­æ ‡ç­¾çš„å¯¹åº”çš„å…³ç³»å¦‚ä¸‹ï¼š{'ç§‘æŠ€': 0, 'è‚¡ç¥¨': 1, 'ä½“è‚²': 2,'å¨±ä¹': 3, 'æ—¶æ”¿': 4, 'ç¤¾ä¼š': 5, 'æ•™è‚²': 6, 'è´¢ç»': 7, 'å®¶å±…': 8,'æ¸¸æˆ': 9, 'æˆ¿äº§': 10, 'æ—¶å°š': 11, 'å½©ç¥¨': 12, 'æ˜Ÿåº§': 13}</p><p>ä»ç»Ÿè®¡ç»“æœå¯ä»¥çœ‹å‡ºï¼Œèµ›é¢˜çš„æ•°æ®é›†ç±»åˆ«åˆ†å¸ƒå­˜åœ¨è¾ƒä¸ºä¸å‡åŒ€çš„æƒ…å†µã€‚åœ¨è®­ç»ƒé›†ä¸­ç§‘æŠ€ç±»æ–°é—»æœ€å¤šï¼Œå…¶æ¬¡æ˜¯è‚¡ç¥¨ç±»æ–°é—»ï¼Œæœ€å°‘çš„æ–°é—»æ˜¯æ˜Ÿåº§æ–°é—»ã€‚</p><h2 id="å­—ç¬¦åˆ†å¸ƒç»Ÿè®¡">å­—ç¬¦åˆ†å¸ƒç»Ÿè®¡</h2><p>æ¥ä¸‹æ¥å¯ä»¥ç»Ÿè®¡æ¯ä¸ªå­—ç¬¦å‡ºç°çš„æ¬¡æ•°ï¼Œé¦–å…ˆå¯ä»¥å°†è®­ç»ƒé›†ä¸­æ‰€æœ‰çš„å¥å­è¿›è¡Œæ‹¼æ¥è¿›è€Œåˆ’åˆ†ä¸ºå­—ç¬¦ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªå­—ç¬¦çš„ä¸ªæ•°ã€‚</p><p>ä»ç»Ÿè®¡ç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨è®­ç»ƒé›†ä¸­æ€»å…±åŒ…æ‹¬6869ä¸ªå­—ï¼Œå…¶ä¸­ç¼–å·3750çš„å­—å‡ºç°çš„æ¬¡æ•°æœ€å¤šï¼Œç¼–å·5034çš„å­—å‡ºç°çš„æ¬¡æ•°æœ€å°‘ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> Counter<br>all_lines = <span class="hljs-string">&#x27; &#x27;</span>.join(<span class="hljs-built_in">list</span>(train_df[<span class="hljs-string">&#x27;text&#x27;</span>]))<br>word_count = Counter(all_lines.split(<span class="hljs-string">&quot; &quot;</span>))<br>word_count = <span class="hljs-built_in">sorted</span>(word_count.items(), key=<span class="hljs-keyword">lambda</span> d:d[<span class="hljs-number">1</span>], reverse = <span class="hljs-literal">True</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(word_count))<br><br><span class="hljs-built_in">print</span>(word_count[<span class="hljs-number">0</span>])<br><br><span class="hljs-built_in">print</span>(word_count[-<span class="hljs-number">1</span>])<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">2405<br>(&#x27;3750&#x27;, 3702)<br>(&#x27;5034&#x27;, 1)<br></code></pre></div></td></tr></table></figure><h2 id="æ•°æ®åˆ†æçš„ç»“è®º">æ•°æ®åˆ†æçš„ç»“è®º</h2><p>é€šè¿‡ä¸Šè¿°åˆ†ææˆ‘ä»¬å¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š</p><ol type="1"><li>èµ›é¢˜ä¸­æ¯ä¸ªæ–°é—»åŒ…å«çš„å­—ç¬¦ä¸ªæ•°å¹³å‡ä¸º1000ä¸ªï¼Œè¿˜æœ‰ä¸€äº›æ–°é—»å­—ç¬¦è¾ƒé•¿ï¼›</li><li>èµ›é¢˜ä¸­æ–°é—»ç±»åˆ«åˆ†å¸ƒä¸å‡åŒ€ï¼Œç§‘æŠ€ç±»æ–°é—»æ ·æœ¬é‡æ¥è¿‘4wï¼Œæ˜Ÿåº§ç±»æ–°é—»æ ·æœ¬é‡ä¸åˆ°1kï¼›</li><li>èµ›é¢˜æ€»å…±åŒ…æ‹¬7000-8000ä¸ªå­—ç¬¦ï¼›</li></ol><p>é€šè¿‡æ•°æ®åˆ†æï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š</p><ol type="1"><li>æ¯ä¸ªæ–°é—»å¹³å‡å­—ç¬¦ä¸ªæ•°è¾ƒå¤šï¼Œå¯èƒ½éœ€è¦æˆªæ–­ï¼›</li><li>ç”±äºç±»åˆ«ä¸å‡è¡¡ï¼Œä¼šä¸¥é‡å½±å“æ¨¡å‹çš„ç²¾åº¦ï¼›</li></ol><h1 id="åŸºäºæœºå™¨å­¦ä¹ çš„æ–‡æœ¬åˆ†ç±»">åŸºäºæœºå™¨å­¦ä¹ çš„æ–‡æœ¬åˆ†ç±»</h1><h2 id="å­¦ä¹ ç›®æ ‡"><strong>å­¦ä¹ ç›®æ ‡</strong></h2><ul><li>å­¦ä¼šTF-IDFçš„åŸç†å’Œä½¿ç”¨</li><li>ä½¿ç”¨sklearnçš„æœºå™¨å­¦ä¹ æ¨¡å‹å®Œæˆæ–‡æœ¬åˆ†ç±»</li></ul><h2 id="æ–‡æœ¬è¡¨ç¤ºæ–¹æ³•">æ–‡æœ¬è¡¨ç¤ºæ–¹æ³•</h2><h3 id="one-hot">One-hot</h3><p>è¿™é‡Œçš„One-hotä¸æ•°æ®æŒ–æ˜ä»»åŠ¡ä¸­çš„æ“ä½œæ˜¯ä¸€è‡´çš„ï¼Œå³å°†æ¯ä¸€ä¸ªå•è¯ä½¿ç”¨ä¸€ä¸ªç¦»æ•£çš„å‘é‡è¡¨ç¤ºã€‚å…·ä½“å°†æ¯ä¸ªå­—/è¯ç¼–ç ä¸€ä¸ªç´¢å¼•ï¼Œç„¶åæ ¹æ®ç´¢å¼•è¿›è¡Œèµ‹å€¼ã€‚</p><p>One-hotè¡¨ç¤ºæ–¹æ³•çš„ä¾‹å­å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">å¥å­<span class="hljs-number">1</span>ï¼šæˆ‘ çˆ± åŒ— äº¬ å¤© å®‰ é—¨<br>å¥å­<span class="hljs-number">2</span>ï¼šæˆ‘ å–œ æ¬¢ ä¸Š æµ·<br></code></pre></div></td></tr></table></figure><p>é¦–å…ˆå¯¹æ‰€æœ‰å¥å­çš„å­—è¿›è¡Œç´¢å¼•ï¼Œå³å°†æ¯ä¸ªå­—ç¡®å®šä¸€ä¸ªç¼–å·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">&#x27;æˆ‘&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;çˆ±&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;åŒ—&#x27;</span>: <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;äº¬&#x27;</span>: <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;å¤©&#x27;</span>: <span class="hljs-number">5</span>,<br>  <span class="hljs-string">&#x27;å®‰&#x27;</span>: <span class="hljs-number">6</span>, <span class="hljs-string">&#x27;é—¨&#x27;</span>: <span class="hljs-number">7</span>, <span class="hljs-string">&#x27;å–œ&#x27;</span>: <span class="hljs-number">8</span>, <span class="hljs-string">&#x27;æ¬¢&#x27;</span>: <span class="hljs-number">9</span>, <span class="hljs-string">&#x27;ä¸Š&#x27;</span>: <span class="hljs-number">10</span>, <span class="hljs-string">&#x27;æµ·&#x27;</span>: <span class="hljs-number">11</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>åœ¨è¿™é‡Œå…±åŒ…æ‹¬11ä¸ªå­—ï¼Œå› æ­¤æ¯ä¸ªå­—å¯ä»¥è½¬æ¢ä¸ºä¸€ä¸ª11ç»´åº¦ç¨€ç–å‘é‡ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs prolog">æˆ‘ï¼š[<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]<br>çˆ±ï¼š[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]<br>...<br>æµ·ï¼š[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>]<br></code></pre></div></td></tr></table></figure><h3 id="bag-of-words">Bag of Words</h3><p>Bag of Wordsï¼ˆè¯è¢‹è¡¨ç¤ºï¼‰ï¼Œä¹Ÿç§°ä¸ºCountVectorsï¼Œæ¯ä¸ªæ–‡æ¡£çš„å­—/è¯å¯ä»¥ä½¿ç”¨å…¶å‡ºç°æ¬¡æ•°æ¥è¿›è¡Œè¡¨ç¤ºã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">å¥å­<span class="hljs-number">1</span>ï¼šæˆ‘ çˆ± åŒ— äº¬ å¤© å®‰ é—¨<br>å¥å­<span class="hljs-number">2</span>ï¼šæˆ‘ å–œ æ¬¢ ä¸Š æµ·<br></code></pre></div></td></tr></table></figure><p>ç›´æ¥ç»Ÿè®¡æ¯ä¸ªå­—å‡ºç°çš„æ¬¡æ•°ï¼Œå¹¶è¿›è¡Œèµ‹å€¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">å¥å­<span class="hljs-number">1</span>ï¼šæˆ‘ çˆ± åŒ— äº¬ å¤© å®‰ é—¨<br>è½¬æ¢ä¸º [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]<br><br>å¥å­<span class="hljs-number">2</span>ï¼šæˆ‘ å–œ æ¬¢ ä¸Š æµ·<br>è½¬æ¢ä¸º [<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]<br></code></pre></div></td></tr></table></figure><p>åœ¨sklearnä¸­å¯ä»¥ç›´æ¥<code>CountVectorizer</code>æ¥å®ç°è¿™ä¸€æ­¥éª¤ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sklearn.feature_extraction.text <span class="hljs-keyword">import</span> CountVectorizer<br>corpus = [<br>    <span class="hljs-string">&#x27;This is the first document.&#x27;</span>,<br>    <span class="hljs-string">&#x27;This document is the second document.&#x27;</span>,<br>    <span class="hljs-string">&#x27;And this is the third one.&#x27;</span>,<br>    <span class="hljs-string">&#x27;Is this the first document?&#x27;</span>,<br>]<br>vectorizer = CountVectorizer()<br>vectorizer.fit_transform(corpus).toarray()<br></code></pre></div></td></tr></table></figure><h3 id="n-gram">N-gram</h3><p>N-gramä¸CountVectorsç±»ä¼¼ï¼Œä¸è¿‡åŠ å…¥äº†ç›¸é‚»å•è¯ç»„åˆæˆä¸ºæ–°çš„å•è¯ï¼Œå¹¶è¿›è¡Œè®¡æ•°ã€‚</p><p>å¦‚æœNå–å€¼ä¸º2ï¼Œåˆ™å¥å­1å’Œå¥å­2å°±å˜ä¸ºï¼š</p><figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs">å¥å­1ï¼šæˆ‘çˆ± çˆ±åŒ— åŒ—äº¬ äº¬å¤© å¤©å®‰ å®‰é—¨<br>å¥å­2ï¼šæˆ‘å–œ å–œæ¬¢ æ¬¢ä¸Š ä¸Šæµ·<br></code></pre></div></td></tr></table></figure><h3 id="tf-idf">TF-IDF</h3><p>TF-IDF åˆ†æ•°ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šç¬¬ä¸€éƒ¨åˆ†æ˜¯<strong>è¯è¯­é¢‘ç‡</strong>ï¼ˆTermFrequencyï¼‰ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯<strong>é€†æ–‡æ¡£é¢‘ç‡</strong>ï¼ˆInverse DocumentFrequencyï¼‰ã€‚å…¶ä¸­è®¡ç®—è¯­æ–™åº“ä¸­æ–‡æ¡£æ€»æ•°é™¤ä»¥å«æœ‰è¯¥è¯è¯­çš„æ–‡æ¡£æ•°é‡ï¼Œç„¶åå†å–å¯¹æ•°å°±æ˜¯é€†æ–‡æ¡£é¢‘ç‡ã€‚</p><figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">TF</span><span class="hljs-params">(t)</span></span>= è¯¥è¯è¯­åœ¨å½“å‰æ–‡æ¡£å‡ºç°çš„æ¬¡æ•° / å½“å‰æ–‡æ¡£ä¸­è¯è¯­çš„æ€»æ•°<br><span class="hljs-function"><span class="hljs-title">IDF</span><span class="hljs-params">(t)</span></span>= log_eï¼ˆæ–‡æ¡£æ€»æ•° / å‡ºç°è¯¥è¯è¯­çš„æ–‡æ¡£æ€»æ•°ï¼‰<br></code></pre></div></td></tr></table></figure><h2 id="åŸºäºæœºå™¨å­¦ä¹ çš„æ–‡æœ¬åˆ†ç±»-1">åŸºäºæœºå™¨å­¦ä¹ çš„æ–‡æœ¬åˆ†ç±»</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†å¯¹æ¯”ä¸åŒæ–‡æœ¬è¡¨ç¤ºç®—æ³•çš„ç²¾åº¦ï¼Œé€šè¿‡æœ¬åœ°æ„å»ºéªŒè¯é›†è®¡ç®—F1å¾—åˆ†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># Count Vectors + RidgeClassifier</span><br><br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br><span class="hljs-keyword">from</span> sklearn.feature_extraction.text <span class="hljs-keyword">import</span> CountVectorizer<br><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> RidgeClassifier<br><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> f1_score<br><br>train_df = pd.read_csv(<span class="hljs-string">&#x27;./data/train_set.csv&#x27;</span>, sep=<span class="hljs-string">&#x27;\t&#x27;</span>, nrows=<span class="hljs-number">15000</span>)<br><br>vectorizer = CountVectorizer(max_features=<span class="hljs-number">3000</span>)<br>train_test = vectorizer.fit_transform(train_df[<span class="hljs-string">&#x27;text&#x27;</span>])<br><br>clf = RidgeClassifier()<br>clf.fit(train_test[:<span class="hljs-number">10000</span>], train_df[<span class="hljs-string">&#x27;label&#x27;</span>].values[:<span class="hljs-number">10000</span>])<br><br>val_pred = clf.predict(train_test[<span class="hljs-number">10000</span>:])<br><span class="hljs-built_in">print</span>(f1_score(train_df[<span class="hljs-string">&#x27;label&#x27;</span>].values[<span class="hljs-number">10000</span>:], val_pred, average=<span class="hljs-string">&#x27;macro&#x27;</span>))<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">0.741494277019762<br></code></pre></div></td></tr></table></figure><h1id="åŸºäºæ·±åº¦å­¦ä¹ çš„æ–‡æœ¬åˆ†ç±»-word2vec">åŸºäºæ·±åº¦å­¦ä¹ çš„æ–‡æœ¬åˆ†ç±»-Word2Vec</h1><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> torch<br><br>logging.basicConfig(level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">&#x27;%(asctime)-15s %(levelname)s: %(message)s&#x27;</span>)<br><br><span class="hljs-comment"># set seed</span><br>seed = <span class="hljs-number">666</span><br>random.seed(seed)<br>np.random.seed(seed)<br>torch.cuda.manual_seed(seed)<br>torch.manual_seed(seed)<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># split data to 10 fold</span><br>fold_num = <span class="hljs-number">10</span><br>data_file = <span class="hljs-string">&#x27;./data/train_set.csv&#x27;</span><br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">all_data2fold</span>(<span class="hljs-params">fold_num, num=<span class="hljs-number">10000</span></span>):<br>    fold_data = []<br>    f = pd.read_csv(data_file, sep=<span class="hljs-string">&#x27;\t&#x27;</span>, encoding=<span class="hljs-string">&#x27;UTF-8&#x27;</span>)<br>    <span class="hljs-comment"># texts: [&#x27;2967 6758 339 2021 1854 3731 4109 3792 4149 1519 ...]</span><br>    texts = f[<span class="hljs-string">&#x27;text&#x27;</span>].tolist()[:num]<br>    <span class="hljs-comment"># labels: [2, 11, 3, 2, 3, 9, 3, 10, 12, 3, 0, 7, 4, 0, 0 ...]</span><br>    labels = f[<span class="hljs-string">&#x27;label&#x27;</span>].tolist()[:num]<br><br>    total = <span class="hljs-built_in">len</span>(labels)<br><br>    <span class="hljs-comment"># æ‰“ä¹±indexé¡ºåºï¼Œä½¿all_textså’Œall_labelséšæœºï¼ˆä¸€ä¸€å¯¹åº”ï¼‰ã€‚</span><br>    index = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(total))<br>    <span class="hljs-comment"># index: [3447, 966, 593, 5029, 4382, 2345, 974, 3786, 2249, ...]</span><br>    np.random.shuffle(index)<br><br>    all_texts = []<br>    all_labels = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> index:<br>        all_texts.append(texts[i])<br>        all_labels.append(labels[i])<br>    <span class="hljs-comment"># all_texts: [&#x27;600 3373 2828 2515 5026 245 3743 26 2396 6122 3720 14 ...]</span><br>    <span class="hljs-comment"># all_labels: [2, 4, 8, 7, 0, 0, 2, 1, 12, 0, ...]</span><br><br>    <span class="hljs-comment"># åˆ›å»ºkey:valueå­—å…¸ï¼Œå…¶ä¸­keyæ˜¯label,valueæ˜¯labelå¯¹åº”çš„indexåˆ—è¡¨ã€‚</span><br>    label2id = &#123;&#125;<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(total):<br>        label = <span class="hljs-built_in">str</span>(all_labels[i])<br>        <span class="hljs-keyword">if</span> label <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> label2id:<br>            label2id[label] = [i]<br>        <span class="hljs-keyword">else</span>:<br>            label2id[label].append(i)<br>    <span class="hljs-comment"># label2id: &#123;&#x27;2&#x27;: [0, 6, 14, 21, 27, 28, 32, 39, ...], &#x27;4&#x27;: [...], ...&#125;</span><br><br>    <span class="hljs-comment"># å°†åŒä¸€labelåˆ’åˆ†ä¸º10æŠ˜ã€‚</span><br>    all_index = [[] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(fold_num)]<br>    <span class="hljs-keyword">for</span> label, data <span class="hljs-keyword">in</span> label2id.items():<br>        <span class="hljs-comment"># print(label, len(data))</span><br>        <span class="hljs-comment"># è®¾data = 105</span><br>        <span class="hljs-comment"># fold_num = 10</span><br>        <span class="hljs-comment"># batch_size = 10</span><br>        <span class="hljs-comment"># other = 5</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        i=0, cur_batch_size = 11, datch_data = [data[0], data[1], ... , data[10]]</span><br><span class="hljs-string">        i=1, cur_batch_size = 11, datch_data = [data[10], data[11], ... , data[20]]</span><br><span class="hljs-string">        ......</span><br><span class="hljs-string">        i=5, cur_batch_size = 10, datch_data = [data[50], data[51], ... , data[59]]</span><br><span class="hljs-string">        i=6, cur_batch_size = 10, datch_data = [data[60], data[61], ... , data[69]]</span><br><span class="hljs-string">        ......</span><br><span class="hljs-string">        i=9, cur_batch_size = 10, datch_data = [data[90], data[91], ... , data[99]]</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># print(label, len(data))</span><br>        batch_size = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">len</span>(data) / fold_num)<br>        other = <span class="hljs-built_in">len</span>(data) - batch_size * fold_num<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(fold_num):<br>            cur_batch_size = batch_size + <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> i &lt; other <span class="hljs-keyword">else</span> batch_size<br>            <span class="hljs-comment"># print(cur_batch_size)</span><br>            batch_data = [data[i * batch_size + b] <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(cur_batch_size)]<br>            all_index[i].extend(batch_data)<br><br>    batch_size = <span class="hljs-built_in">int</span>(total / fold_num)<br>    other_texts = []<br>    other_labels = []<br>    other_num = <span class="hljs-number">0</span><br>    start = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># å°†10æŠ˜åˆ†ç±»åçš„all_indexæŒ‰ç…§indexåˆ†åˆ«åˆ’åˆ†</span><br>    <span class="hljs-keyword">for</span> fold <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(fold_num):<br>        num = <span class="hljs-built_in">len</span>(all_index[fold])<br>        texts = [all_texts[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> all_index[fold]]<br>        labels = [all_labels[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> all_index[fold]]<br><br>        <span class="hljs-comment"># å•æŠ˜æ•°é‡&gt;10æŠ˜å¹³å‡æ•°æ—¶ï¼Œæ–‡æœ¬æ•°æˆªæ–­è‡³å¹³å‡æ•°batch_size,å¹¶é™æˆªæ–­çš„æ–‡æœ¬åˆ†è‡³other_texts,æ ‡ç­¾fold_labelsåŒä¸Š</span><br>        <span class="hljs-keyword">if</span> num &gt; batch_size:<br>            fold_texts = texts[:batch_size]<br>            other_texts.extend(texts[batch_size:])<br>            fold_labels = labels[:batch_size]<br>            other_labels.extend(labels[batch_size:])<br>            other_num += num - batch_size<br>        <span class="hljs-comment"># å•æŠ˜æ•°é‡&lt;10æŠ˜å¹³å‡æ•°æ—¶ï¼ŒåŸæœ‰çš„æ–‡æœ¬åŠ other_sizeä¸­batch_size-numçš„æ–‡æœ¬æ•°ï¼Œæ ‡ç­¾fold_labelsåŒä¸Š</span><br>        <span class="hljs-keyword">elif</span> num &lt; batch_size:<br>            end = start + batch_size - num<br>            fold_texts = texts + other_texts[start: end]<br>            fold_labels = labels + other_labels[start: end]<br>            start = end<br>        <span class="hljs-comment"># å¦åˆ™ï¼Œæ–‡æœ¬æ•°å’Œæ ‡ç­¾æ•°ä¸å˜ã€‚</span><br>        <span class="hljs-keyword">else</span>:<br>            fold_texts = texts<br>            fold_labels = labels<br><br>        <span class="hljs-keyword">assert</span> batch_size == <span class="hljs-built_in">len</span>(fold_labels)<br><br>        <span class="hljs-comment"># shuffleï¼Œå¯¹10æŠ˜æ–‡æœ¬å’Œæ ‡ç­¾é‡æ–°åˆ·æ–°ã€‚</span><br>        index = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(batch_size))<br>        np.random.shuffle(index)<br><br>        shuffle_fold_texts = []<br>        shuffle_fold_labels = []<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> index:<br>            shuffle_fold_texts.append(fold_texts[i])<br>            shuffle_fold_labels.append(fold_labels[i])<br><br>        data = &#123;<span class="hljs-string">&#x27;label&#x27;</span>: shuffle_fold_labels, <span class="hljs-string">&#x27;text&#x27;</span>: shuffle_fold_texts&#125;<br>        fold_data.append(data)<br><br>    logging.info(<span class="hljs-string">&quot;Fold lens %s&quot;</span>, <span class="hljs-built_in">str</span>([<span class="hljs-built_in">len</span>(data[<span class="hljs-string">&#x27;label&#x27;</span>]) <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> fold_data]))<br><br>    <span class="hljs-keyword">return</span> fold_data<br><br><br>fold_data = all_data2fold(<span class="hljs-number">10</span>)<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># build train data for word2vec</span><br>fold_id = <span class="hljs-number">9</span><br><br>train_texts = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, fold_id):<br>    data = fold_data[i]<br>    train_texts.extend(data[<span class="hljs-string">&#x27;text&#x27;</span>])<br>    <br>logging.info(<span class="hljs-string">&#x27;Total %d docs.&#x27;</span> % <span class="hljs-built_in">len</span>(train_texts))<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">logging.info(<span class="hljs-string">&#x27;Start training...&#x27;</span>)<br><span class="hljs-keyword">from</span> gensim.models.word2vec <span class="hljs-keyword">import</span> Word2Vec<br><br>num_features = <span class="hljs-number">100</span>     <span class="hljs-comment"># Word vector dimensionality</span><br>num_workers = <span class="hljs-number">8</span>       <span class="hljs-comment"># Number of threads to run in parallel</span><br><br>train_texts = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">list</span>(x.split()), train_texts))<br>model = Word2Vec(train_texts, workers=num_workers, size=num_features)<br>model.init_sims(replace=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># save model</span><br>model.save(<span class="hljs-string">&quot;./save/word2vec.bin&quot;</span>)<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># load model</span><br>model = Word2Vec.load(<span class="hljs-string">&quot;./save/word2vec.bin&quot;</span>)<br><br><span class="hljs-comment"># convert format</span><br>model.wv.save_word2vec_format(<span class="hljs-string">&#x27;./save/word2vec.txt&#x27;</span>, binary=<span class="hljs-literal">False</span>)<br></code></pre></div></td></tr></table></figure><h1id="åŸºäºæ·±åº¦å­¦ä¹ çš„æ–‡æœ¬åˆ†ç±»-textrnn">åŸºäºæ·±åº¦å­¦ä¹ çš„æ–‡æœ¬åˆ†ç±»-TextRNN</h1><p>TextRNNåˆ©ç”¨RNNï¼ˆå¾ªç¯ç¥ç»ç½‘ç»œï¼‰è¿›è¡Œæ–‡æœ¬ç‰¹å¾æŠ½å–ï¼Œç”±äºæ–‡æœ¬æœ¬èº«æ˜¯ä¸€ç§åºåˆ—ï¼Œè€ŒLSTMå¤©ç„¶é€‚åˆå»ºæ¨¡åºåˆ—æ•°æ®ã€‚TextRNNå°†å¥å­ä¸­æ¯ä¸ªè¯çš„è¯å‘é‡ä¾æ¬¡è¾“å…¥åˆ°åŒå‘åŒå±‚LSTMï¼Œåˆ†åˆ«å°†ä¸¤ä¸ªæ–¹å‘æœ€åä¸€ä¸ªæœ‰æ•ˆä½ç½®çš„éšè—å±‚æ‹¼æ¥æˆä¸€ä¸ªå‘é‡ä½œä¸ºæ–‡æœ¬çš„è¡¨ç¤º</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> torch<br><br>logging.basicConfig(level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">&#x27;%(asctime)-15s %(levelname)s: %(message)s&#x27;</span>)<br><br><span class="hljs-comment"># set seed</span><br>seed = <span class="hljs-number">666</span><br>random.seed(seed)<br>np.random.seed(seed)<br>torch.cuda.manual_seed(seed)<br>torch.manual_seed(seed)<br><br><span class="hljs-comment"># set cuda</span><br>gpu = <span class="hljs-number">0</span><br>use_cuda = gpu &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> torch.cuda.is_available()<br><span class="hljs-keyword">if</span> use_cuda:<br>    torch.cuda.set_device(gpu)<br>    device = torch.device(<span class="hljs-string">&quot;cuda&quot;</span>, gpu)<br><span class="hljs-keyword">else</span>:<br>    device = torch.device(<span class="hljs-string">&quot;cpu&quot;</span>)<br>logging.info(<span class="hljs-string">&quot;Use cuda: %s, gpu id: %d.&quot;</span>, use_cuda, gpu)<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># split data to 10 fold</span><br>fold_num = <span class="hljs-number">10</span><br>data_file = <span class="hljs-string">&#x27;../data/train_set.csv&#x27;</span><br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">all_data2fold</span>(<span class="hljs-params">fold_num, num=<span class="hljs-number">1000</span></span>):<br>    fold_data = []<br>    f = pd.read_csv(data_file, sep=<span class="hljs-string">&#x27;\t&#x27;</span>, encoding=<span class="hljs-string">&#x27;UTF-8&#x27;</span>)<br>    texts = f[<span class="hljs-string">&#x27;text&#x27;</span>].tolist()[:num]<br>    labels = f[<span class="hljs-string">&#x27;label&#x27;</span>].tolist()[:num]<br><br>    total = <span class="hljs-built_in">len</span>(labels)<br><br>    index = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(total))<br>    np.random.shuffle(index)<br><br>    all_texts = []<br>    all_labels = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> index:<br>        all_texts.append(texts[i])<br>        all_labels.append(labels[i])<br><br>    label2id = &#123;&#125;<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(total):<br>        label = <span class="hljs-built_in">str</span>(all_labels[i])<br>        <span class="hljs-keyword">if</span> label <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> label2id:<br>            label2id[label] = [i]<br>        <span class="hljs-keyword">else</span>:<br>            label2id[label].append(i)<br><br>    all_index = [[] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(fold_num)]<br>    <span class="hljs-keyword">for</span> label, data <span class="hljs-keyword">in</span> label2id.items():<br>        <span class="hljs-comment"># print(label, len(data))</span><br>        batch_size = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">len</span>(data) / fold_num)<br>        other = <span class="hljs-built_in">len</span>(data) - batch_size * fold_num<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(fold_num):<br>            cur_batch_size = batch_size + <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> i &lt; other <span class="hljs-keyword">else</span> batch_size<br>            <span class="hljs-comment"># print(cur_batch_size)</span><br>            batch_data = [data[i * batch_size + b] <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(cur_batch_size)]<br>            all_index[i].extend(batch_data)<br><br>    batch_size = <span class="hljs-built_in">int</span>(total / fold_num)<br>    other_texts = []<br>    other_labels = []<br>    other_num = <span class="hljs-number">0</span><br>    start = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> fold <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(fold_num):<br>        num = <span class="hljs-built_in">len</span>(all_index[fold])<br>        texts = [all_texts[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> all_index[fold]]<br>        labels = [all_labels[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> all_index[fold]]<br><br>        <span class="hljs-keyword">if</span> num &gt; batch_size:<br>            fold_texts = texts[:batch_size]<br>            other_texts.extend(texts[batch_size:])<br>            fold_labels = labels[:batch_size]<br>            other_labels.extend(labels[batch_size:])<br>            other_num += num - batch_size<br>        <span class="hljs-keyword">elif</span> num &lt; batch_size:<br>            end = start + batch_size - num<br>            fold_texts = texts + other_texts[start: end]<br>            fold_labels = labels + other_labels[start: end]<br>            start = end<br>        <span class="hljs-keyword">else</span>:<br>            fold_texts = texts<br>            fold_labels = labels<br><br>        <span class="hljs-keyword">assert</span> batch_size == <span class="hljs-built_in">len</span>(fold_labels)<br><br>        <span class="hljs-comment"># shuffle</span><br>        index = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(batch_size))<br>        np.random.shuffle(index)<br><br>        shuffle_fold_texts = []<br>        shuffle_fold_labels = []<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> index:<br>            shuffle_fold_texts.append(fold_texts[i])<br>            shuffle_fold_labels.append(fold_labels[i])<br><br>        data = &#123;<span class="hljs-string">&#x27;label&#x27;</span>: shuffle_fold_labels, <span class="hljs-string">&#x27;text&#x27;</span>: shuffle_fold_texts&#125;<br>        fold_data.append(data)<br><br>    logging.info(<span class="hljs-string">&quot;Fold lens %s&quot;</span>, <span class="hljs-built_in">str</span>([<span class="hljs-built_in">len</span>(data[<span class="hljs-string">&#x27;label&#x27;</span>]) <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> fold_data]))<br><br>    <span class="hljs-keyword">return</span> fold_data<br><br><br>fold_data = all_data2fold(<span class="hljs-number">10</span>)<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># build vocab</span><br><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> Counter<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> BasicTokenizer<br><br>basic_tokenizer = BasicTokenizer()<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vocab</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, train_data</span>):<br>        self.min_count = <span class="hljs-number">5</span><br>        self.pad = <span class="hljs-number">0</span><br>        self.unk = <span class="hljs-number">1</span><br>        self._id2word = [<span class="hljs-string">&#x27;[PAD]&#x27;</span>, <span class="hljs-string">&#x27;[UNK]&#x27;</span>]<br>        self._id2extword = [<span class="hljs-string">&#x27;[PAD]&#x27;</span>, <span class="hljs-string">&#x27;[UNK]&#x27;</span>]<br><br>        self._id2label = []<br>        self.target_names = []<br><br>        self.build_vocab(train_data)<br><br>        reverse = <span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(x, <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(x))))<br>        <br>        <span class="hljs-comment"># _word2id = &#123;&#x27;[PAD]&#x27;: 0, &#x27;[UNK]&#x27;: 1&#125;</span><br>        self._word2id = reverse(self._id2word)<br>        self._label2id = reverse(self._id2label)<br><br>        logging.info(<span class="hljs-string">&quot;Build vocab: words %d, labels %d.&quot;</span> % (self.word_size, self.label_size))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_vocab</span>(<span class="hljs-params">self, data</span>):<br>        self.word_counter = Counter()<br><br>        <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> data[<span class="hljs-string">&#x27;text&#x27;</span>]:<br>            words = text.split()<br>            <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> words:<br>                self.word_counter[word] += <span class="hljs-number">1</span><br><br>        <span class="hljs-keyword">for</span> word, count <span class="hljs-keyword">in</span> self.word_counter.most_common():<br>            <span class="hljs-keyword">if</span> count &gt;= self.min_count:<br>                self._id2word.append(word)<br><br>        label2name = &#123;<span class="hljs-number">0</span>: <span class="hljs-string">&#x27;ç§‘æŠ€&#x27;</span>, <span class="hljs-number">1</span>: <span class="hljs-string">&#x27;è‚¡ç¥¨&#x27;</span>, <span class="hljs-number">2</span>: <span class="hljs-string">&#x27;ä½“è‚²&#x27;</span>, <span class="hljs-number">3</span>: <span class="hljs-string">&#x27;å¨±ä¹&#x27;</span>, <span class="hljs-number">4</span>: <span class="hljs-string">&#x27;æ—¶æ”¿&#x27;</span>, <span class="hljs-number">5</span>: <span class="hljs-string">&#x27;ç¤¾ä¼š&#x27;</span>, <span class="hljs-number">6</span>: <span class="hljs-string">&#x27;æ•™è‚²&#x27;</span>, <span class="hljs-number">7</span>: <span class="hljs-string">&#x27;è´¢ç»&#x27;</span>,<br>                      <span class="hljs-number">8</span>: <span class="hljs-string">&#x27;å®¶å±…&#x27;</span>, <span class="hljs-number">9</span>: <span class="hljs-string">&#x27;æ¸¸æˆ&#x27;</span>, <span class="hljs-number">10</span>: <span class="hljs-string">&#x27;æˆ¿äº§&#x27;</span>, <span class="hljs-number">11</span>: <span class="hljs-string">&#x27;æ—¶å°š&#x27;</span>, <span class="hljs-number">12</span>: <span class="hljs-string">&#x27;å½©ç¥¨&#x27;</span>, <span class="hljs-number">13</span>: <span class="hljs-string">&#x27;æ˜Ÿåº§&#x27;</span>&#125;<br><br>        self.label_counter = Counter(data[<span class="hljs-string">&#x27;label&#x27;</span>])<br><br>        <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(self.label_counter)):<br>            count = self.label_counter[label]<br>            self._id2label.append(label)<br>            self.target_names.append(label2name[label])<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_pretrained_embs</span>(<span class="hljs-params">self, embfile</span>):<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(embfile, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            lines = f.readlines()<br>            items = lines[<span class="hljs-number">0</span>].split()<br>            word_count, embedding_dim = <span class="hljs-built_in">int</span>(items[<span class="hljs-number">0</span>]), <span class="hljs-built_in">int</span>(items[<span class="hljs-number">1</span>])<br><br>        index = <span class="hljs-built_in">len</span>(self._id2extword)<br>        embeddings = np.zeros((word_count + index, embedding_dim))<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines[<span class="hljs-number">1</span>:]:<br>            values = line.split()<br>            self._id2extword.append(values[<span class="hljs-number">0</span>])<br>            vector = np.array(values[<span class="hljs-number">1</span>:], dtype=<span class="hljs-string">&#x27;float64&#x27;</span>)<br>            embeddings[self.unk] += vector<br>            embeddings[index] = vector<br>            index += <span class="hljs-number">1</span><br><br>        embeddings[self.unk] = embeddings[self.unk] / word_count<br>        embeddings = embeddings / np.std(embeddings)<br><br>        reverse = <span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(x, <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(x))))<br>        self._extword2id = reverse(self._id2extword)<br><br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">set</span>(self._id2extword)) == <span class="hljs-built_in">len</span>(self._id2extword)<br><br>        <span class="hljs-keyword">return</span> embeddings<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">word2id</span>(<span class="hljs-params">self, xs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(xs, <span class="hljs-built_in">list</span>):<br>            <span class="hljs-keyword">return</span> [self._word2id.get(x, self.unk) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> xs]<br>        <span class="hljs-keyword">return</span> self._word2id.get(xs, self.unk)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extword2id</span>(<span class="hljs-params">self, xs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(xs, <span class="hljs-built_in">list</span>):<br>            <span class="hljs-keyword">return</span> [self._extword2id.get(x, self.unk) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> xs]<br>        <span class="hljs-keyword">return</span> self._extword2id.get(xs, self.unk)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">label2id</span>(<span class="hljs-params">self, xs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(xs, <span class="hljs-built_in">list</span>):<br>            <span class="hljs-keyword">return</span> [self._label2id.get(x, self.unk) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> xs]<br>        <span class="hljs-keyword">return</span> self._label2id.get(xs, self.unk)<br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">word_size</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self._id2word)<br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extword_size</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self._id2extword)<br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">label_size</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self._id2label)<br><br><br>vocab = Vocab(train_data)<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># build module</span><br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Attention</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, hidden_size</span>):<br>        <span class="hljs-built_in">super</span>(Attention, self).__init__()<br>        self.weight = nn.Parameter(torch.Tensor(hidden_size, hidden_size))<br>        self.weight.data.normal_(mean=<span class="hljs-number">0.0</span>, std=<span class="hljs-number">0.05</span>)<br><br>        self.bias = nn.Parameter(torch.Tensor(hidden_size))<br>        b = np.zeros(hidden_size, dtype=np.float32)<br>        self.bias.data.copy_(torch.from_numpy(b))<br><br>        self.query = nn.Parameter(torch.Tensor(hidden_size))<br>        self.query.data.normal_(mean=<span class="hljs-number">0.0</span>, std=<span class="hljs-number">0.05</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, batch_hidden, batch_masks</span>):<br>        <span class="hljs-comment"># batch_hidden: b x len x hidden_size (2 * hidden_size of lstm)</span><br>        <span class="hljs-comment"># batch_masks:  b x len</span><br><br>        <span class="hljs-comment"># linear</span><br>        key = torch.matmul(batch_hidden, self.weight) + self.bias  <span class="hljs-comment"># b x len x hidden</span><br><br>        <span class="hljs-comment"># compute attention</span><br>        outputs = torch.matmul(key, self.query)  <span class="hljs-comment"># b x len</span><br><br>        masked_outputs = outputs.masked_fill((<span class="hljs-number">1</span> - batch_masks).<span class="hljs-built_in">bool</span>(), <span class="hljs-built_in">float</span>(-<span class="hljs-number">1e32</span>))<br><br>        attn_scores = F.softmax(masked_outputs, dim=<span class="hljs-number">1</span>)  <span class="hljs-comment"># b x len</span><br><br>        <span class="hljs-comment"># å¯¹äºå…¨é›¶å‘é‡ï¼Œ-1e32çš„ç»“æœä¸º 1/len, -infä¸ºnan, é¢å¤–è¡¥0</span><br>        masked_attn_scores = attn_scores.masked_fill((<span class="hljs-number">1</span> - batch_masks).<span class="hljs-built_in">bool</span>(), <span class="hljs-number">0.0</span>)<br><br>        <span class="hljs-comment"># sum weighted sources</span><br>        batch_outputs = torch.bmm(masked_attn_scores.unsqueeze(<span class="hljs-number">1</span>), key).squeeze(<span class="hljs-number">1</span>)  <span class="hljs-comment"># b x hidden</span><br><br>        <span class="hljs-keyword">return</span> batch_outputs, attn_scores<br><br><br><span class="hljs-comment"># build word encoder</span><br>word2vec_path = <span class="hljs-string">&#x27;../emb/word2vec.txt&#x27;</span><br>dropout = <span class="hljs-number">0.15</span><br>word_hidden_size = <span class="hljs-number">128</span><br>word_num_layers = <span class="hljs-number">2</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">WordLSTMEncoder</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, vocab</span>):<br>        <span class="hljs-built_in">super</span>(WordLSTMEncoder, self).__init__()<br>        self.dropout = nn.Dropout(dropout)<br>        self.word_dims = <span class="hljs-number">100</span><br><br>        self.word_embed = nn.Embedding(vocab.word_size, self.word_dims, padding_idx=<span class="hljs-number">0</span>)<br><br>        extword_embed = vocab.load_pretrained_embs(word2vec_path)<br>        extword_size, word_dims = extword_embed.shape<br>        logging.info(<span class="hljs-string">&quot;Load extword embed: words %d, dims %d.&quot;</span> % (extword_size, word_dims))<br><br>        self.extword_embed = nn.Embedding(extword_size, word_dims, padding_idx=<span class="hljs-number">0</span>)<br>        self.extword_embed.weight.data.copy_(torch.from_numpy(extword_embed))<br>        self.extword_embed.weight.requires_grad = <span class="hljs-literal">False</span><br><br>        input_size = self.word_dims<br><br>        self.word_lstm = nn.LSTM(<br>            input_size=input_size,<br>            hidden_size=word_hidden_size,<br>            num_layers=word_num_layers,<br>            batch_first=<span class="hljs-literal">True</span>,<br>            bidirectional=<span class="hljs-literal">True</span><br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, word_ids, extword_ids, batch_masks</span>):<br>        <span class="hljs-comment"># word_ids: sen_num x sent_len</span><br>        <span class="hljs-comment"># extword_ids: sen_num x sent_len</span><br>        <span class="hljs-comment"># batch_masks   sen_num x sent_len</span><br><br>        word_embed = self.word_embed(word_ids)  <span class="hljs-comment"># sen_num x sent_len x 100</span><br>        extword_embed = self.extword_embed(extword_ids)<br>        batch_embed = word_embed + extword_embed<br><br>        <span class="hljs-keyword">if</span> self.training:<br>            batch_embed = self.dropout(batch_embed)<br><br>        hiddens, _ = self.word_lstm(batch_embed)  <span class="hljs-comment"># sen_num x sent_len x  hidden*2</span><br>        hiddens = hiddens * batch_masks.unsqueeze(<span class="hljs-number">2</span>)<br><br>        <span class="hljs-keyword">if</span> self.training:<br>            hiddens = self.dropout(hiddens)<br><br>        <span class="hljs-keyword">return</span> hiddens<br><br><br><span class="hljs-comment"># build sent encoder</span><br>sent_hidden_size = <span class="hljs-number">256</span><br>sent_num_layers = <span class="hljs-number">2</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SentEncoder</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, sent_rep_size</span>):<br>        <span class="hljs-built_in">super</span>(SentEncoder, self).__init__()<br>        self.dropout = nn.Dropout(dropout)<br><br>        self.sent_lstm = nn.LSTM(<br>            input_size=sent_rep_size,<br>            hidden_size=sent_hidden_size,<br>            num_layers=sent_num_layers,<br>            batch_first=<span class="hljs-literal">True</span>,<br>            bidirectional=<span class="hljs-literal">True</span><br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, sent_reps, sent_masks</span>):<br>        <span class="hljs-comment"># sent_reps:  b x doc_len x sent_rep_size</span><br>        <span class="hljs-comment"># sent_masks: b x doc_len</span><br><br>        sent_hiddens, _ = self.sent_lstm(sent_reps)  <span class="hljs-comment"># b x doc_len x hidden*2</span><br>        sent_hiddens = sent_hiddens * sent_masks.unsqueeze(<span class="hljs-number">2</span>)<br><br>        <span class="hljs-keyword">if</span> self.training:<br>            sent_hiddens = self.dropout(sent_hiddens)<br><br>        <span class="hljs-keyword">return</span> sent_hiddens<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># build model</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, vocab</span>):<br>        <span class="hljs-built_in">super</span>(Model, self).__init__()<br>        self.sent_rep_size = word_hidden_size * <span class="hljs-number">2</span><br>        self.doc_rep_size = sent_hidden_size * <span class="hljs-number">2</span><br>        self.all_parameters = &#123;&#125;<br>        parameters = []<br>        self.word_encoder = WordLSTMEncoder(vocab)<br>        self.word_attention = Attention(self.sent_rep_size)<br>        parameters.extend(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> p: p.requires_grad, self.word_encoder.parameters())))<br>        parameters.extend(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> p: p.requires_grad, self.word_attention.parameters())))<br><br>        self.sent_encoder = SentEncoder(self.sent_rep_size)<br>        self.sent_attention = Attention(self.doc_rep_size)<br>        parameters.extend(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> p: p.requires_grad, self.sent_encoder.parameters())))<br>        parameters.extend(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> p: p.requires_grad, self.sent_attention.parameters())))<br><br>        self.out = nn.Linear(self.doc_rep_size, vocab.label_size, bias=<span class="hljs-literal">True</span>)<br>        parameters.extend(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> p: p.requires_grad, self.out.parameters())))<br><br>        <span class="hljs-keyword">if</span> use_cuda:<br>            self.to(device)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parameters) &gt; <span class="hljs-number">0</span>:<br>            self.all_parameters[<span class="hljs-string">&quot;basic_parameters&quot;</span>] = parameters<br><br>        logging.info(<span class="hljs-string">&#x27;Build model with lstm word encoder, lstm sent encoder.&#x27;</span>)<br><br>        para_num = <span class="hljs-built_in">sum</span>([np.prod(<span class="hljs-built_in">list</span>(p.size())) <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.parameters()])<br>        logging.info(<span class="hljs-string">&#x27;Model param num: %.2f M.&#x27;</span> % (para_num / <span class="hljs-number">1e6</span>))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, batch_inputs</span>):<br>        <span class="hljs-comment"># batch_inputs(batch_inputs1, batch_inputs2): b x doc_len x sent_len</span><br>        <span class="hljs-comment"># batch_masks : b x doc_len x sent_len</span><br>        batch_inputs1, batch_inputs2, batch_masks = batch_inputs<br>        batch_size, max_doc_len, max_sent_len = batch_inputs1.shape[<span class="hljs-number">0</span>], batch_inputs1.shape[<span class="hljs-number">1</span>], batch_inputs1.shape[<span class="hljs-number">2</span>]<br>        batch_inputs1 = batch_inputs1.view(batch_size * max_doc_len, max_sent_len)  <span class="hljs-comment"># sen_num x sent_len</span><br>        batch_inputs2 = batch_inputs2.view(batch_size * max_doc_len, max_sent_len)  <span class="hljs-comment"># sen_num x sent_len</span><br>        batch_masks = batch_masks.view(batch_size * max_doc_len, max_sent_len)  <span class="hljs-comment"># sen_num x sent_len</span><br><br>        batch_hiddens = self.word_encoder(batch_inputs1, batch_inputs2,<br>                                          batch_masks)  <span class="hljs-comment"># sen_num x sent_len x sent_rep_size</span><br>        sent_reps, atten_scores = self.word_attention(batch_hiddens, batch_masks)  <span class="hljs-comment"># sen_num x sent_rep_size</span><br><br>        sent_reps = sent_reps.view(batch_size, max_doc_len, self.sent_rep_size)  <span class="hljs-comment"># b x doc_len x sent_rep_size</span><br>        batch_masks = batch_masks.view(batch_size, max_doc_len, max_sent_len)  <span class="hljs-comment"># b x doc_len x max_sent_len</span><br>        sent_masks = batch_masks.<span class="hljs-built_in">bool</span>().<span class="hljs-built_in">any</span>(<span class="hljs-number">2</span>).<span class="hljs-built_in">float</span>()  <span class="hljs-comment"># b x doc_len</span><br><br>        sent_hiddens = self.sent_encoder(sent_reps, sent_masks)  <span class="hljs-comment"># b x doc_len x doc_rep_size</span><br>        doc_reps, atten_scores = self.sent_attention(sent_hiddens, sent_masks)  <span class="hljs-comment"># b x doc_rep_size</span><br><br>        batch_outputs = self.out(doc_reps)  <span class="hljs-comment"># b x num_labels</span><br><br>        <span class="hljs-keyword">return</span> batch_outputs<br><br><br>model = Model(vocab)<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># build optimizer</span><br>learning_rate = <span class="hljs-number">2e-4</span><br>decay = <span class="hljs-number">.75</span><br>decay_step = <span class="hljs-number">1000</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Optimizer</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model_parameters</span>):<br>        self.all_params = []<br>        self.optims = []<br>        self.schedulers = []<br><br>        <span class="hljs-keyword">for</span> name, parameters <span class="hljs-keyword">in</span> model_parameters.items():<br>            <span class="hljs-keyword">if</span> name.startswith(<span class="hljs-string">&quot;basic&quot;</span>):<br>                optim = torch.optim.Adam(parameters, lr=learning_rate)<br>                self.optims.append(optim)<br><br>                l = <span class="hljs-keyword">lambda</span> step: decay ** (step // decay_step)<br>                scheduler = torch.optim.lr_scheduler.LambdaLR(optim, lr_lambda=l)<br>                self.schedulers.append(scheduler)<br>                self.all_params.extend(parameters)<br><br>            <span class="hljs-keyword">else</span>:<br>                Exception(<span class="hljs-string">&quot;no nameed parameters.&quot;</span>)<br><br>        self.num = <span class="hljs-built_in">len</span>(self.optims)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">for</span> optim, scheduler <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.optims, self.schedulers):<br>            optim.step()<br>            scheduler.step()<br>            optim.zero_grad()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">zero_grad</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">for</span> optim <span class="hljs-keyword">in</span> self.optims:<br>            optim.zero_grad()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_lr</span>(<span class="hljs-params">self</span>):<br>        lrs = <span class="hljs-built_in">tuple</span>(<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: x.get_lr()[-<span class="hljs-number">1</span>], self.schedulers))<br>        lr = <span class="hljs-string">&#x27; %.5f&#x27;</span> * self.num<br>        res = lr % lrs<br>        <span class="hljs-keyword">return</span> res<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># build dataset</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sentence_split</span>(<span class="hljs-params">text, vocab, max_sent_len=<span class="hljs-number">256</span>, max_segment=<span class="hljs-number">16</span></span>):<br>    words = text.strip().split()<br>    document_len = <span class="hljs-built_in">len</span>(words)<br><br>    index = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, document_len, max_sent_len))<br>    index.append(document_len)<br><br>    segments = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(index) - <span class="hljs-number">1</span>):<br>        segment = words[index[i]: index[i + <span class="hljs-number">1</span>]]<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(segment) &gt; <span class="hljs-number">0</span><br>        segment = [word <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> vocab._id2word <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;&lt;UNK&gt;&#x27;</span> <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> segment]<br>        segments.append([<span class="hljs-built_in">len</span>(segment), segment])<br><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(segments) &gt; <span class="hljs-number">0</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(segments) &gt; max_segment:<br>        segment_ = <span class="hljs-built_in">int</span>(max_segment / <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">return</span> segments[:segment_] + segments[-segment_:]<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> segments<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_examples</span>(<span class="hljs-params">data, vocab, max_sent_len=<span class="hljs-number">256</span>, max_segment=<span class="hljs-number">8</span></span>):<br>    label2id = vocab.label2id<br>    examples = []<br><br>    <span class="hljs-keyword">for</span> text, label <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(data[<span class="hljs-string">&#x27;text&#x27;</span>], data[<span class="hljs-string">&#x27;label&#x27;</span>]):<br>        <span class="hljs-comment"># label</span><br>        <span class="hljs-built_in">id</span> = label2id(label)<br><br>        <span class="hljs-comment"># words</span><br>        sents_words = sentence_split(text, vocab, max_sent_len, max_segment)<br>        doc = []<br>        <span class="hljs-keyword">for</span> sent_len, sent_words <span class="hljs-keyword">in</span> sents_words:<br>            word_ids = vocab.word2id(sent_words)<br>            extword_ids = vocab.extword2id(sent_words)<br>            doc.append([sent_len, word_ids, extword_ids])<br>        examples.append([<span class="hljs-built_in">id</span>, <span class="hljs-built_in">len</span>(doc), doc])<br><br>    logging.info(<span class="hljs-string">&#x27;Total %d docs.&#x27;</span> % <span class="hljs-built_in">len</span>(examples))<br>    <span class="hljs-keyword">return</span> examples<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># build loader</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_slice</span>(<span class="hljs-params">data, batch_size</span>):<br>    batch_num = <span class="hljs-built_in">int</span>(np.ceil(<span class="hljs-built_in">len</span>(data) / <span class="hljs-built_in">float</span>(batch_size)))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(batch_num):<br>        cur_batch_size = batch_size <span class="hljs-keyword">if</span> i &lt; batch_num - <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-built_in">len</span>(data) - batch_size * i<br>        docs = [data[i * batch_size + b] <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(cur_batch_size)]<br><br>        <span class="hljs-keyword">yield</span> docs<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">data_iter</span>(<span class="hljs-params">data, batch_size, shuffle=<span class="hljs-literal">True</span>, noise=<span class="hljs-number">1.0</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    randomly permute data, then sort by source length, and partition into batches</span><br><span class="hljs-string">    ensure that the length of  sentences in each batch</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    batched_data = []<br>    <span class="hljs-keyword">if</span> shuffle:<br>        np.random.shuffle(data)<br><br>    lengths = [example[<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> example <span class="hljs-keyword">in</span> data]<br>    noisy_lengths = [- (l + np.random.uniform(- noise, noise)) <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> lengths]<br>    sorted_indices = np.argsort(noisy_lengths).tolist()<br>    sorted_data = [data[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sorted_indices]<br><br>    batched_data.extend(<span class="hljs-built_in">list</span>(batch_slice(sorted_data, batch_size)))<br><br>    <span class="hljs-keyword">if</span> shuffle:<br>        np.random.shuffle(batched_data)<br><br>    <span class="hljs-keyword">for</span> batch <span class="hljs-keyword">in</span> batched_data:<br>        <span class="hljs-keyword">yield</span> batch<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># some function</span><br><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> f1_score, precision_score, recall_score<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_score</span>(<span class="hljs-params">y_ture, y_pred</span>):<br>    y_ture = np.array(y_ture)<br>    y_pred = np.array(y_pred)<br>    f1 = f1_score(y_ture, y_pred, average=<span class="hljs-string">&#x27;macro&#x27;</span>) * <span class="hljs-number">100</span><br>    p = precision_score(y_ture, y_pred, average=<span class="hljs-string">&#x27;macro&#x27;</span>) * <span class="hljs-number">100</span><br>    r = recall_score(y_ture, y_pred, average=<span class="hljs-string">&#x27;macro&#x27;</span>) * <span class="hljs-number">100</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>((reformat(p, <span class="hljs-number">2</span>), reformat(r, <span class="hljs-number">2</span>), reformat(f1, <span class="hljs-number">2</span>))), reformat(f1, <span class="hljs-number">2</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">reformat</span>(<span class="hljs-params">num, n</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">float</span>(<span class="hljs-built_in">format</span>(num, <span class="hljs-string">&#x27;0.&#x27;</span> + <span class="hljs-built_in">str</span>(n) + <span class="hljs-string">&#x27;f&#x27;</span>))<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># build trainer</span><br><br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> classification_report<br><br>clip = <span class="hljs-number">5.0</span><br>epochs = <span class="hljs-number">1</span><br>early_stops = <span class="hljs-number">3</span><br>log_interval = <span class="hljs-number">200</span><br><br>test_batch_size = <span class="hljs-number">16</span><br>train_batch_size = <span class="hljs-number">16</span><br><br>save_model = <span class="hljs-string">&#x27;../save/rnn.bin&#x27;</span><br>save_test = <span class="hljs-string">&#x27;../save/rnn.csv&#x27;</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Trainer</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model, vocab</span>):<br>        self.model = model<br>        self.report = <span class="hljs-literal">True</span><br><br>        self.train_data = get_examples(train_data, vocab)<br>        self.batch_num = <span class="hljs-built_in">int</span>(np.ceil(<span class="hljs-built_in">len</span>(self.train_data) / <span class="hljs-built_in">float</span>(train_batch_size)))<br>        self.dev_data = get_examples(dev_data, vocab)<br>        self.test_data = get_examples(test_data, vocab)<br><br>        <span class="hljs-comment"># criterion</span><br>        self.criterion = nn.CrossEntropyLoss()<br><br>        <span class="hljs-comment"># label name</span><br>        self.target_names = vocab.target_names<br><br>        <span class="hljs-comment"># optimizer</span><br>        self.optimizer = Optimizer(model.all_parameters)<br><br>        <span class="hljs-comment"># count</span><br>        self.step = <span class="hljs-number">0</span><br>        self.early_stop = -<span class="hljs-number">1</span><br>        self.best_train_f1, self.best_dev_f1 = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>        self.last_epoch = epochs<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">self</span>):<br>        logging.info(<span class="hljs-string">&#x27;Start training...&#x27;</span>)<br>        <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, epochs + <span class="hljs-number">1</span>):<br>            train_f1 = self._train(epoch)<br><br>            dev_f1 = self._<span class="hljs-built_in">eval</span>(epoch)<br><br>            <span class="hljs-keyword">if</span> self.best_dev_f1 &lt;= dev_f1:<br>                logging.info(<br>                    <span class="hljs-string">&quot;Exceed history dev = %.2f, current dev = %.2f&quot;</span> % (self.best_dev_f1, dev_f1))<br>                torch.save(self.model.state_dict(), save_model)<br><br>                self.best_train_f1 = train_f1<br>                self.best_dev_f1 = dev_f1<br>                self.early_stop = <span class="hljs-number">0</span><br>            <span class="hljs-keyword">else</span>:<br>                self.early_stop += <span class="hljs-number">1</span><br>                <span class="hljs-keyword">if</span> self.early_stop == early_stops:<br>                    logging.info(<br>                        <span class="hljs-string">&quot;Eearly stop in epoch %d, best train: %.2f, dev: %.2f&quot;</span> % (<br>                            epoch - early_stops, self.best_train_f1, self.best_dev_f1))<br>                    self.last_epoch = epoch<br>                    <span class="hljs-keyword">break</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>(<span class="hljs-params">self</span>):<br>        self.model.load_state_dict(torch.load(save_model))<br>        self._<span class="hljs-built_in">eval</span>(self.last_epoch + <span class="hljs-number">1</span>, test=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_train</span>(<span class="hljs-params">self, epoch</span>):<br>        self.optimizer.zero_grad()<br>        self.model.train()<br><br>        start_time = time.time()<br>        epoch_start_time = time.time()<br>        overall_losses = <span class="hljs-number">0</span><br>        losses = <span class="hljs-number">0</span><br>        batch_idx = <span class="hljs-number">1</span><br>        y_pred = []<br>        y_true = []<br>        <span class="hljs-keyword">for</span> batch_data <span class="hljs-keyword">in</span> data_iter(self.train_data, train_batch_size, shuffle=<span class="hljs-literal">True</span>):<br>            torch.cuda.empty_cache()<br>            batch_inputs, batch_labels = self.batch2tensor(batch_data)<br>            batch_outputs = self.model(batch_inputs)<br>            loss = self.criterion(batch_outputs, batch_labels)<br>            loss.backward()<br><br>            loss_value = loss.detach().cpu().item()<br>            losses += loss_value<br>            overall_losses += loss_value<br><br>            y_pred.extend(torch.<span class="hljs-built_in">max</span>(batch_outputs, dim=<span class="hljs-number">1</span>)[<span class="hljs-number">1</span>].cpu().numpy().tolist())<br>            y_true.extend(batch_labels.cpu().numpy().tolist())<br><br>            nn.utils.clip_grad_norm_(self.optimizer.all_params, max_norm=clip)<br>            <span class="hljs-keyword">for</span> optimizer, scheduler <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.optimizer.optims, self.optimizer.schedulers):<br>                optimizer.step()<br>                scheduler.step()<br>            self.optimizer.zero_grad()<br><br>            self.step += <span class="hljs-number">1</span><br><br>            <span class="hljs-keyword">if</span> batch_idx % log_interval == <span class="hljs-number">0</span>:<br>                elapsed = time.time() - start_time<br><br>                lrs = self.optimizer.get_lr()<br>                logging.info(<br>                    <span class="hljs-string">&#x27;| epoch &#123;:3d&#125; | step &#123;:3d&#125; | batch &#123;:3d&#125;/&#123;:3d&#125; | lr&#123;&#125; | loss &#123;:.4f&#125; | s/batch &#123;:.2f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<br>                        epoch, self.step, batch_idx, self.batch_num, lrs,<br>                        losses / log_interval,<br>                        elapsed / log_interval))<br><br>                losses = <span class="hljs-number">0</span><br>                start_time = time.time()<br><br>            batch_idx += <span class="hljs-number">1</span><br><br>        overall_losses /= self.batch_num<br>        during_time = time.time() - epoch_start_time<br><br>        <span class="hljs-comment"># reformat</span><br>        overall_losses = reformat(overall_losses, <span class="hljs-number">4</span>)<br>        score, f1 = get_score(y_true, y_pred)<br><br>        logging.info(<br>            <span class="hljs-string">&#x27;| epoch &#123;:3d&#125; | score &#123;&#125; | f1 &#123;&#125; | loss &#123;:.4f&#125; | time &#123;:.2f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(epoch, score, f1,<br>                                                                                  overall_losses,<br>                                                                                  during_time))<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">set</span>(y_true) == <span class="hljs-built_in">set</span>(y_pred) <span class="hljs-keyword">and</span> self.report:<br>            report = classification_report(y_true, y_pred, digits=<span class="hljs-number">4</span>, target_names=self.target_names)<br>            logging.info(<span class="hljs-string">&#x27;\n&#x27;</span> + report)<br><br>        <span class="hljs-keyword">return</span> f1<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_eval</span>(<span class="hljs-params">self, epoch, test=<span class="hljs-literal">False</span></span>):<br>        self.model.<span class="hljs-built_in">eval</span>()<br>        start_time = time.time()<br><br>        y_pred = []<br>        y_true = []<br>        <span class="hljs-keyword">with</span> torch.no_grad():<br>            <span class="hljs-keyword">for</span> batch_data <span class="hljs-keyword">in</span> data_iter(self.dev_data, test_batch_size, shuffle=<span class="hljs-literal">False</span>):<br>                torch.cuda.empty_cache()<br>                batch_inputs, batch_labels = self.batch2tensor(batch_data)<br>                batch_outputs = self.model(batch_inputs)<br>                y_pred.extend(torch.<span class="hljs-built_in">max</span>(batch_outputs, dim=<span class="hljs-number">1</span>)[<span class="hljs-number">1</span>].cpu().numpy().tolist())<br>                y_true.extend(batch_labels.cpu().numpy().tolist())<br><br>            score, f1 = get_score(y_true, y_pred)<br><br>            during_time = time.time() - start_time<br>            <br>            <span class="hljs-keyword">if</span> test:<br>                df = pd.DataFrame(&#123;<span class="hljs-string">&#x27;label&#x27;</span>: y_pred&#125;)<br>                df.to_csv(save_test, index=<span class="hljs-literal">False</span>, sep=<span class="hljs-string">&#x27;,&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                logging.info(<br>                    <span class="hljs-string">&#x27;| epoch &#123;:3d&#125; | dev | score &#123;&#125; | f1 &#123;&#125; | time &#123;:.2f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(epoch, score, f1,<br>                                                                              during_time))<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">set</span>(y_true) == <span class="hljs-built_in">set</span>(y_pred) <span class="hljs-keyword">and</span> self.report:<br>                    report = classification_report(y_true, y_pred, digits=<span class="hljs-number">4</span>, target_names=self.target_names)<br>                    logging.info(<span class="hljs-string">&#x27;\n&#x27;</span> + report)<br><br>        <span class="hljs-keyword">return</span> f1<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">batch2tensor</span>(<span class="hljs-params">self, batch_data</span>):<br>        <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">            [[label, doc_len, [[sent_len, [sent_id0, ...], [sent_id1, ...]], ...]]</span><br><span class="hljs-string">        &#x27;&#x27;&#x27;</span><br>        batch_size = <span class="hljs-built_in">len</span>(batch_data)<br>        doc_labels = []<br>        doc_lens = []<br>        doc_max_sent_len = []<br>        <span class="hljs-keyword">for</span> doc_data <span class="hljs-keyword">in</span> batch_data:<br>            doc_labels.append(doc_data[<span class="hljs-number">0</span>])<br>            doc_lens.append(doc_data[<span class="hljs-number">1</span>])<br>            sent_lens = [sent_data[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> sent_data <span class="hljs-keyword">in</span> doc_data[<span class="hljs-number">2</span>]]<br>            max_sent_len = <span class="hljs-built_in">max</span>(sent_lens)<br>            doc_max_sent_len.append(max_sent_len)<br><br>        max_doc_len = <span class="hljs-built_in">max</span>(doc_lens)<br>        max_sent_len = <span class="hljs-built_in">max</span>(doc_max_sent_len)<br><br>        batch_inputs1 = torch.zeros((batch_size, max_doc_len, max_sent_len), dtype=torch.int64)<br>        batch_inputs2 = torch.zeros((batch_size, max_doc_len, max_sent_len), dtype=torch.int64)<br>        batch_masks = torch.zeros((batch_size, max_doc_len, max_sent_len), dtype=torch.float32)<br>        batch_labels = torch.LongTensor(doc_labels)<br><br>        <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(batch_size):<br>            <span class="hljs-keyword">for</span> sent_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(doc_lens[b]):<br>                sent_data = batch_data[b][<span class="hljs-number">2</span>][sent_idx]<br>                <span class="hljs-keyword">for</span> word_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(sent_data[<span class="hljs-number">0</span>]):<br>                    batch_inputs1[b, sent_idx, word_idx] = sent_data[<span class="hljs-number">1</span>][word_idx]<br>                    batch_inputs2[b, sent_idx, word_idx] = sent_data[<span class="hljs-number">2</span>][word_idx]<br>                    batch_masks[b, sent_idx, word_idx] = <span class="hljs-number">1</span><br><br>        <span class="hljs-keyword">if</span> use_cuda:<br>            batch_inputs1 = batch_inputs1.to(device)<br>            batch_inputs2 = batch_inputs2.to(device)<br>            batch_masks = batch_masks.to(device)<br>            batch_labels = batch_labels.to(device)<br><br>        <span class="hljs-keyword">return</span> (batch_inputs1, batch_inputs2, batch_masks), batch_labels<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># train</span><br>trainer = Trainer(model, vocab)<br>trainer.train()<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># test</span><br>trainer.test()<br></code></pre></div></td></tr></table></figure><h1 id="åŸºäºæ·±åº¦å­¦ä¹ çš„æ–‡æœ¬åˆ†ç±»-bert">åŸºäºæ·±åº¦å­¦ä¹ çš„æ–‡æœ¬åˆ†ç±»-BERT</h1><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> torch<br><br>logging.basicConfig(level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">&#x27;%(asctime)-15s %(levelname)s: %(message)s&#x27;</span>)<br><br><span class="hljs-comment"># set seed</span><br>seed = <span class="hljs-number">666</span><br>random.seed(seed)<br>np.random.seed(seed)<br>torch.cuda.manual_seed(seed)<br>torch.manual_seed(seed)<br><br><span class="hljs-comment"># set cuda</span><br>gpu = <span class="hljs-number">0</span><br>use_cuda = gpu &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> torch.cuda.is_available()<br><span class="hljs-keyword">if</span> use_cuda:<br>    torch.cuda.set_device(gpu)<br>    device = torch.device(<span class="hljs-string">&quot;cuda&quot;</span>, gpu)<br><span class="hljs-keyword">else</span>:<br>    device = torch.device(<span class="hljs-string">&quot;cpu&quot;</span>)<br>logging.info(<span class="hljs-string">&quot;Use cuda: %s, gpu id: %d.&quot;</span>, use_cuda, gpu)<br><br><span class="hljs-comment"># split data to 10 fold</span><br>fold_num = <span class="hljs-number">10</span><br>data_file = <span class="hljs-string">&#x27;../data/train_set.csv&#x27;</span><br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">all_data2fold</span>(<span class="hljs-params">fold_num, num=<span class="hljs-number">10000</span></span>):<br>    fold_data = []<br>    f = pd.read_csv(data_file, sep=<span class="hljs-string">&#x27;\t&#x27;</span>, encoding=<span class="hljs-string">&#x27;UTF-8&#x27;</span>)<br>    texts = f[<span class="hljs-string">&#x27;text&#x27;</span>].tolist()[:num]<br>    labels = f[<span class="hljs-string">&#x27;label&#x27;</span>].tolist()[:num]<br><br>    total = <span class="hljs-built_in">len</span>(labels)<br><br>    index = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(total))<br>    np.random.shuffle(index)<br><br>    all_texts = []<br>    all_labels = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> index:<br>        all_texts.append(texts[i])<br>        all_labels.append(labels[i])<br><br>    label2id = &#123;&#125;<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(total):<br>        label = <span class="hljs-built_in">str</span>(all_labels[i])<br>        <span class="hljs-keyword">if</span> label <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> label2id:<br>            label2id[label] = [i]<br>        <span class="hljs-keyword">else</span>:<br>            label2id[label].append(i)<br><br>    all_index = [[] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(fold_num)]<br>    <span class="hljs-keyword">for</span> label, data <span class="hljs-keyword">in</span> label2id.items():<br>        <span class="hljs-comment"># print(label, len(data))</span><br>        batch_size = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">len</span>(data) / fold_num)<br>        other = <span class="hljs-built_in">len</span>(data) - batch_size * fold_num<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(fold_num):<br>            cur_batch_size = batch_size + <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> i &lt; other <span class="hljs-keyword">else</span> batch_size<br>            <span class="hljs-comment"># print(cur_batch_size)</span><br>            batch_data = [data[i * batch_size + b] <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(cur_batch_size)]<br>            all_index[i].extend(batch_data)<br><br>    batch_size = <span class="hljs-built_in">int</span>(total / fold_num)<br>    other_texts = []<br>    other_labels = []<br>    other_num = <span class="hljs-number">0</span><br>    start = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> fold <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(fold_num):<br>        num = <span class="hljs-built_in">len</span>(all_index[fold])<br>        texts = [all_texts[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> all_index[fold]]<br>        labels = [all_labels[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> all_index[fold]]<br><br>        <span class="hljs-keyword">if</span> num &gt; batch_size:<br>            fold_texts = texts[:batch_size]<br>            other_texts.extend(texts[batch_size:])<br>            fold_labels = labels[:batch_size]<br>            other_labels.extend(labels[batch_size:])<br>            other_num += num - batch_size<br>        <span class="hljs-keyword">elif</span> num &lt; batch_size:<br>            end = start + batch_size - num<br>            fold_texts = texts + other_texts[start: end]<br>            fold_labels = labels + other_labels[start: end]<br>            start = end<br>        <span class="hljs-keyword">else</span>:<br>            fold_texts = texts<br>            fold_labels = labels<br><br>        <span class="hljs-keyword">assert</span> batch_size == <span class="hljs-built_in">len</span>(fold_labels)<br><br>        <span class="hljs-comment"># shuffle</span><br>        index = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(batch_size))<br>        np.random.shuffle(index)<br><br>        shuffle_fold_texts = []<br>        shuffle_fold_labels = []<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> index:<br>            shuffle_fold_texts.append(fold_texts[i])<br>            shuffle_fold_labels.append(fold_labels[i])<br><br>        data = &#123;<span class="hljs-string">&#x27;label&#x27;</span>: shuffle_fold_labels, <span class="hljs-string">&#x27;text&#x27;</span>: shuffle_fold_texts&#125;<br>        fold_data.append(data)<br><br>    logging.info(<span class="hljs-string">&quot;Fold lens %s&quot;</span>, <span class="hljs-built_in">str</span>([<span class="hljs-built_in">len</span>(data[<span class="hljs-string">&#x27;label&#x27;</span>]) <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> fold_data]))<br><br>    <span class="hljs-keyword">return</span> fold_data<br><br><br>fold_data = all_data2fold(<span class="hljs-number">10</span>)<br><br><span class="hljs-comment"># build train, dev, test data</span><br>fold_id = <span class="hljs-number">9</span><br><br><span class="hljs-comment"># dev</span><br>dev_data = fold_data[fold_id]<br><br><span class="hljs-comment"># train</span><br>train_texts = []<br>train_labels = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, fold_id):<br>    data = fold_data[i]<br>    train_texts.extend(data[<span class="hljs-string">&#x27;text&#x27;</span>])<br>    train_labels.extend(data[<span class="hljs-string">&#x27;label&#x27;</span>])<br><br>train_data = &#123;<span class="hljs-string">&#x27;label&#x27;</span>: train_labels, <span class="hljs-string">&#x27;text&#x27;</span>: train_texts&#125;<br><br><span class="hljs-comment"># test</span><br>test_data_file = <span class="hljs-string">&#x27;../data/test_a.csv&#x27;</span><br>f = pd.read_csv(test_data_file, sep=<span class="hljs-string">&#x27;\t&#x27;</span>, encoding=<span class="hljs-string">&#x27;UTF-8&#x27;</span>)<br>texts = f[<span class="hljs-string">&#x27;text&#x27;</span>].tolist()<br>test_data = &#123;<span class="hljs-string">&#x27;label&#x27;</span>: [<span class="hljs-number">0</span>] * <span class="hljs-built_in">len</span>(texts), <span class="hljs-string">&#x27;text&#x27;</span>: texts&#125;<br><br><span class="hljs-comment"># build vocab</span><br><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> Counter<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> BasicTokenizer<br><br><span class="hljs-comment"># åˆ†è¯å™¨</span><br>basic_tokenizer = BasicTokenizer()<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vocab</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, train_data</span>):<br>        self.min_count = <span class="hljs-number">5</span><br>        self.pad = <span class="hljs-number">0</span><br>        self.unk = <span class="hljs-number">1</span><br>        self._id2word = [<span class="hljs-string">&#x27;[PAD]&#x27;</span>, <span class="hljs-string">&#x27;[UNK]&#x27;</span>]<br>        self._id2extword = [<span class="hljs-string">&#x27;[PAD]&#x27;</span>, <span class="hljs-string">&#x27;[UNK]&#x27;</span>]<br><br>        self._id2label = []<br>        self.target_names = []<br><br>        self.build_vocab(train_data)<br><br>        reverse = <span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(x, <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(x))))<br>        self._word2id = reverse(self._id2word)<br>        self._label2id = reverse(self._id2label)<br><br>        logging.info(<span class="hljs-string">&quot;Build vocab: words %d, labels %d.&quot;</span> % (self.word_size, self.label_size))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_vocab</span>(<span class="hljs-params">self, data</span>):<br>        self.word_counter = Counter()<br><br>        <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> data[<span class="hljs-string">&#x27;text&#x27;</span>]:<br>            words = text.split()<br>            <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> words:<br>                self.word_counter[word] += <span class="hljs-number">1</span><br><br>        <span class="hljs-keyword">for</span> word, count <span class="hljs-keyword">in</span> self.word_counter.most_common():<br>            <span class="hljs-keyword">if</span> count &gt;= self.min_count:<br>                self._id2word.append(word)<br><br>        label2name = &#123;<span class="hljs-number">0</span>: <span class="hljs-string">&#x27;ç§‘æŠ€&#x27;</span>, <span class="hljs-number">1</span>: <span class="hljs-string">&#x27;è‚¡ç¥¨&#x27;</span>, <span class="hljs-number">2</span>: <span class="hljs-string">&#x27;ä½“è‚²&#x27;</span>, <span class="hljs-number">3</span>: <span class="hljs-string">&#x27;å¨±ä¹&#x27;</span>, <span class="hljs-number">4</span>: <span class="hljs-string">&#x27;æ—¶æ”¿&#x27;</span>, <span class="hljs-number">5</span>: <span class="hljs-string">&#x27;ç¤¾ä¼š&#x27;</span>, <span class="hljs-number">6</span>: <span class="hljs-string">&#x27;æ•™è‚²&#x27;</span>, <span class="hljs-number">7</span>: <span class="hljs-string">&#x27;è´¢ç»&#x27;</span>,<br>                      <span class="hljs-number">8</span>: <span class="hljs-string">&#x27;å®¶å±…&#x27;</span>, <span class="hljs-number">9</span>: <span class="hljs-string">&#x27;æ¸¸æˆ&#x27;</span>, <span class="hljs-number">10</span>: <span class="hljs-string">&#x27;æˆ¿äº§&#x27;</span>, <span class="hljs-number">11</span>: <span class="hljs-string">&#x27;æ—¶å°š&#x27;</span>, <span class="hljs-number">12</span>: <span class="hljs-string">&#x27;å½©ç¥¨&#x27;</span>, <span class="hljs-number">13</span>: <span class="hljs-string">&#x27;æ˜Ÿåº§&#x27;</span>&#125;<br><br>        self.label_counter = Counter(data[<span class="hljs-string">&#x27;label&#x27;</span>])<br><br>        <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(self.label_counter)):<br>            count = self.label_counter[label]<br>            self._id2label.append(label)<br>            self.target_names.append(label2name[label])<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_pretrained_embs</span>(<span class="hljs-params">self, embfile</span>):<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(embfile, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            lines = f.readlines()<br>            items = lines[<span class="hljs-number">0</span>].split()<br>            word_count, embedding_dim = <span class="hljs-built_in">int</span>(items[<span class="hljs-number">0</span>]), <span class="hljs-built_in">int</span>(items[<span class="hljs-number">1</span>])<br><br>        index = <span class="hljs-built_in">len</span>(self._id2extword)<br>        embeddings = np.zeros((word_count + index, embedding_dim))<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines[<span class="hljs-number">1</span>:]:<br>            values = line.split()<br>            self._id2extword.append(values[<span class="hljs-number">0</span>])<br>            vector = np.array(values[<span class="hljs-number">1</span>:], dtype=<span class="hljs-string">&#x27;float64&#x27;</span>)<br>            embeddings[self.unk] += vector<br>            embeddings[index] = vector<br>            index += <span class="hljs-number">1</span><br><br>        embeddings[self.unk] = embeddings[self.unk] / word_count<br>        embeddings = embeddings / np.std(embeddings)<br><br>        reverse = <span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(x, <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(x))))<br>        self._extword2id = reverse(self._id2extword)<br><br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">set</span>(self._id2extword)) == <span class="hljs-built_in">len</span>(self._id2extword)<br><br>        <span class="hljs-keyword">return</span> embeddings<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">word2id</span>(<span class="hljs-params">self, xs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(xs, <span class="hljs-built_in">list</span>):<br>            <span class="hljs-keyword">return</span> [self._word2id.get(x, self.unk) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> xs]<br>        <span class="hljs-keyword">return</span> self._word2id.get(xs, self.unk)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extword2id</span>(<span class="hljs-params">self, xs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(xs, <span class="hljs-built_in">list</span>):<br>            <span class="hljs-keyword">return</span> [self._extword2id.get(x, self.unk) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> xs]<br>        <span class="hljs-keyword">return</span> self._extword2id.get(xs, self.unk)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">label2id</span>(<span class="hljs-params">self, xs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(xs, <span class="hljs-built_in">list</span>):<br>            <span class="hljs-keyword">return</span> [self._label2id.get(x, self.unk) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> xs]<br>        <span class="hljs-keyword">return</span> self._label2id.get(xs, self.unk)<br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">word_size</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self._id2word)<br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extword_size</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self._id2extword)<br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">label_size</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self._id2label)<br><br><br>vocab = Vocab(train_data)<br><br><span class="hljs-comment"># build module</span><br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Attention</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, hidden_size</span>):<br>        <span class="hljs-built_in">super</span>(Attention, self).__init__()<br>        self.weight = nn.Parameter(torch.Tensor(hidden_size, hidden_size))<br>        self.weight.data.normal_(mean=<span class="hljs-number">0.0</span>, std=<span class="hljs-number">0.05</span>)<br><br>        self.bias = nn.Parameter(torch.Tensor(hidden_size))<br>        b = np.zeros(hidden_size, dtype=np.float32)<br>        self.bias.data.copy_(torch.from_numpy(b))<br><br>        self.query = nn.Parameter(torch.Tensor(hidden_size))<br>        self.query.data.normal_(mean=<span class="hljs-number">0.0</span>, std=<span class="hljs-number">0.05</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, batch_hidden, batch_masks</span>):<br>        <span class="hljs-comment"># batch_hidden: b x len x hidden_size (2 * hidden_size of lstm)</span><br>        <span class="hljs-comment"># batch_masks:  b x len</span><br><br>        <span class="hljs-comment"># linear</span><br>        key = torch.matmul(batch_hidden, self.weight) + self.bias  <span class="hljs-comment"># b x len x hidden</span><br><br>        <span class="hljs-comment"># compute attention</span><br>        outputs = torch.matmul(key, self.query)  <span class="hljs-comment"># b x len</span><br><br>        masked_outputs = outputs.masked_fill((<span class="hljs-number">1</span> - batch_masks).<span class="hljs-built_in">bool</span>(), <span class="hljs-built_in">float</span>(-<span class="hljs-number">1e32</span>))<br><br>        attn_scores = F.softmax(masked_outputs, dim=<span class="hljs-number">1</span>)  <span class="hljs-comment"># b x len</span><br><br>        <span class="hljs-comment"># å¯¹äºå…¨é›¶å‘é‡ï¼Œ-1e32çš„ç»“æœä¸º 1/len, -infä¸ºnan, é¢å¤–è¡¥0</span><br>        masked_attn_scores = attn_scores.masked_fill((<span class="hljs-number">1</span> - batch_masks).<span class="hljs-built_in">bool</span>(), <span class="hljs-number">0.0</span>)<br><br>        <span class="hljs-comment"># sum weighted sources</span><br>        batch_outputs = torch.bmm(masked_attn_scores.unsqueeze(<span class="hljs-number">1</span>), key).squeeze(<span class="hljs-number">1</span>)  <span class="hljs-comment"># b x hidden</span><br><br>        <span class="hljs-keyword">return</span> batch_outputs, attn_scores<br><br><br><span class="hljs-comment"># build word encoder</span><br>bert_path = <span class="hljs-string">&#x27;./emb/bert-mini/&#x27;</span><br>dropout = <span class="hljs-number">0.15</span><br><br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> BertModel<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">WordBertEncoder</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(WordBertEncoder, self).__init__()<br>        self.dropout = nn.Dropout(dropout)<br><br>        self.tokenizer = WhitespaceTokenizer()<br>        self.bert = BertModel.from_pretrained(bert_path)<br><br>        self.pooled = <span class="hljs-literal">False</span><br>        logging.info(<span class="hljs-string">&#x27;Build Bert encoder with pooled &#123;&#125;.&#x27;</span>.<span class="hljs-built_in">format</span>(self.pooled))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encode</span>(<span class="hljs-params">self, tokens</span>):<br>        tokens = self.tokenizer.tokenize(tokens)<br>        <span class="hljs-keyword">return</span> tokens<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_bert_parameters</span>(<span class="hljs-params">self</span>):<br>        no_decay = [<span class="hljs-string">&#x27;bias&#x27;</span>, <span class="hljs-string">&#x27;LayerNorm.weight&#x27;</span>]<br>        optimizer_parameters = [<br>            &#123;<span class="hljs-string">&#x27;params&#x27;</span>: [p <span class="hljs-keyword">for</span> n, p <span class="hljs-keyword">in</span> self.bert.named_parameters() <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">any</span>(nd <span class="hljs-keyword">in</span> n <span class="hljs-keyword">for</span> nd <span class="hljs-keyword">in</span> no_decay)],<br>             <span class="hljs-string">&#x27;weight_decay&#x27;</span>: <span class="hljs-number">0.01</span>&#125;,<br>            &#123;<span class="hljs-string">&#x27;params&#x27;</span>: [p <span class="hljs-keyword">for</span> n, p <span class="hljs-keyword">in</span> self.bert.named_parameters() <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(nd <span class="hljs-keyword">in</span> n <span class="hljs-keyword">for</span> nd <span class="hljs-keyword">in</span> no_decay)],<br>             <span class="hljs-string">&#x27;weight_decay&#x27;</span>: <span class="hljs-number">0.0</span>&#125;<br>        ]<br>        <span class="hljs-keyword">return</span> optimizer_parameters<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, input_ids, token_type_ids</span>):<br>        <span class="hljs-comment"># input_ids: sen_num x bert_len</span><br>        <span class="hljs-comment"># token_type_ids: sen_num  x bert_len</span><br><br>        <span class="hljs-comment"># sen_num x bert_len x 256, sen_num x 256</span><br>        sequence_output, pooled_output = self.bert(input_ids=input_ids, token_type_ids=token_type_ids)<br><br>        <span class="hljs-keyword">if</span> self.pooled:<br>            reps = pooled_output<br>        <span class="hljs-keyword">else</span>:<br>            reps = sequence_output[:, <span class="hljs-number">0</span>, :]  <span class="hljs-comment"># sen_num x 256</span><br><br>        <span class="hljs-keyword">if</span> self.training:<br>            reps = self.dropout(reps)<br><br>        <span class="hljs-keyword">return</span> reps<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">WhitespaceTokenizer</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;WhitespaceTokenizer with vocab.&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        vocab_file = bert_path + <span class="hljs-string">&#x27;vocab.txt&#x27;</span><br>        self._token2id = self.load_vocab(vocab_file)<br>        self._id2token = &#123;v: k <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> self._token2id.items()&#125;<br>        self.max_len = <span class="hljs-number">256</span><br>        self.unk = <span class="hljs-number">1</span><br><br>        logging.info(<span class="hljs-string">&quot;Build Bert vocab with size %d.&quot;</span> % (self.vocab_size))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_vocab</span>(<span class="hljs-params">self, vocab_file</span>):<br>        f = <span class="hljs-built_in">open</span>(vocab_file, <span class="hljs-string">&#x27;r&#x27;</span>)<br>        lines = f.readlines()<br>        lines = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: x.strip(), lines))<br>        vocab = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(lines, <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(lines))))<br>        <span class="hljs-keyword">return</span> vocab<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">tokenize</span>(<span class="hljs-params">self, tokens</span>):<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(tokens) &lt;= self.max_len - <span class="hljs-number">2</span><br>        tokens = [<span class="hljs-string">&quot;[CLS]&quot;</span>] + tokens + [<span class="hljs-string">&quot;[SEP]&quot;</span>]<br>        output_tokens = self.token2id(tokens)<br>        <span class="hljs-keyword">return</span> output_tokens<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">token2id</span>(<span class="hljs-params">self, xs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(xs, <span class="hljs-built_in">list</span>):<br>            <span class="hljs-keyword">return</span> [self._token2id.get(x, self.unk) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> xs]<br>        <span class="hljs-keyword">return</span> self._token2id.get(xs, self.unk)<br><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">vocab_size</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self._id2token)<br><br><br><span class="hljs-comment"># build sent encoder</span><br>sent_hidden_size = <span class="hljs-number">256</span><br>sent_num_layers = <span class="hljs-number">2</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SentEncoder</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, sent_rep_size</span>):<br>        <span class="hljs-built_in">super</span>(SentEncoder, self).__init__()<br>        self.dropout = nn.Dropout(dropout)<br><br>        self.sent_lstm = nn.LSTM(<br>            input_size=sent_rep_size,<br>            hidden_size=sent_hidden_size,<br>            num_layers=sent_num_layers,<br>            batch_first=<span class="hljs-literal">True</span>,<br>            bidirectional=<span class="hljs-literal">True</span><br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, sent_reps, sent_masks</span>):<br>        <span class="hljs-comment"># sent_reps:  b x doc_len x sent_rep_size</span><br>        <span class="hljs-comment"># sent_masks: b x doc_len</span><br><br>        sent_hiddens, _ = self.sent_lstm(sent_reps)  <span class="hljs-comment"># b x doc_len x hidden*2</span><br>        sent_hiddens = sent_hiddens * sent_masks.unsqueeze(<span class="hljs-number">2</span>)<br><br>        <span class="hljs-keyword">if</span> self.training:<br>            sent_hiddens = self.dropout(sent_hiddens)<br><br>        <span class="hljs-keyword">return</span> sent_hiddens<br><br><br><span class="hljs-comment"># build model</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, vocab</span>):<br>        <span class="hljs-built_in">super</span>(Model, self).__init__()<br>        self.sent_rep_size = <span class="hljs-number">256</span><br>        self.doc_rep_size = sent_hidden_size * <span class="hljs-number">2</span><br>        self.all_parameters = &#123;&#125;<br>        parameters = []<br>        self.word_encoder = WordBertEncoder()<br>        bert_parameters = self.word_encoder.get_bert_parameters()<br><br>        self.sent_encoder = SentEncoder(self.sent_rep_size)<br>        self.sent_attention = Attention(self.doc_rep_size)<br>        parameters.extend(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> p: p.requires_grad, self.sent_encoder.parameters())))<br>        parameters.extend(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> p: p.requires_grad, self.sent_attention.parameters())))<br><br>        self.out = nn.Linear(self.doc_rep_size, vocab.label_size, bias=<span class="hljs-literal">True</span>)<br>        parameters.extend(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> p: p.requires_grad, self.out.parameters())))<br><br>        <span class="hljs-keyword">if</span> use_cuda:<br>            self.to(device)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parameters) &gt; <span class="hljs-number">0</span>:<br>            self.all_parameters[<span class="hljs-string">&quot;basic_parameters&quot;</span>] = parameters<br>        self.all_parameters[<span class="hljs-string">&quot;bert_parameters&quot;</span>] = bert_parameters<br><br>        logging.info(<span class="hljs-string">&#x27;Build model with bert word encoder, lstm sent encoder.&#x27;</span>)<br><br>        para_num = <span class="hljs-built_in">sum</span>([np.prod(<span class="hljs-built_in">list</span>(p.size())) <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.parameters()])<br>        logging.info(<span class="hljs-string">&#x27;Model param num: %.2f M.&#x27;</span> % (para_num / <span class="hljs-number">1e6</span>))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, batch_inputs</span>):<br>        <span class="hljs-comment"># batch_inputs(batch_inputs1, batch_inputs2): b x doc_len x sent_len</span><br>        <span class="hljs-comment"># batch_masks : b x doc_len x sent_len</span><br>        batch_inputs1, batch_inputs2, batch_masks = batch_inputs<br>        batch_size, max_doc_len, max_sent_len = batch_inputs1.shape[<span class="hljs-number">0</span>], batch_inputs1.shape[<span class="hljs-number">1</span>], batch_inputs1.shape[<span class="hljs-number">2</span>]<br>        batch_inputs1 = batch_inputs1.view(batch_size * max_doc_len, max_sent_len)  <span class="hljs-comment"># sen_num x sent_len</span><br>        batch_inputs2 = batch_inputs2.view(batch_size * max_doc_len, max_sent_len)  <span class="hljs-comment"># sen_num x sent_len</span><br>        batch_masks = batch_masks.view(batch_size * max_doc_len, max_sent_len)  <span class="hljs-comment"># sen_num x sent_len</span><br><br>        sent_reps = self.word_encoder(batch_inputs1, batch_inputs2)  <span class="hljs-comment"># sen_num x sent_rep_size</span><br><br>        sent_reps = sent_reps.view(batch_size, max_doc_len, self.sent_rep_size)  <span class="hljs-comment"># b x doc_len x sent_rep_size</span><br>        batch_masks = batch_masks.view(batch_size, max_doc_len, max_sent_len)  <span class="hljs-comment"># b x doc_len x max_sent_len</span><br>        sent_masks = batch_masks.<span class="hljs-built_in">bool</span>().<span class="hljs-built_in">any</span>(<span class="hljs-number">2</span>).<span class="hljs-built_in">float</span>()  <span class="hljs-comment"># b x doc_len</span><br><br>        sent_hiddens = self.sent_encoder(sent_reps, sent_masks)  <span class="hljs-comment"># b x doc_len x doc_rep_size</span><br>        doc_reps, atten_scores = self.sent_attention(sent_hiddens, sent_masks)  <span class="hljs-comment"># b x doc_rep_size</span><br><br>        batch_outputs = self.out(doc_reps)  <span class="hljs-comment"># b x num_labels</span><br><br>        <span class="hljs-keyword">return</span> batch_outputs<br><br><br>model = Model(vocab)<br><br><span class="hljs-comment"># build optimizer</span><br>learning_rate = <span class="hljs-number">2e-4</span><br>bert_lr = <span class="hljs-number">5e-5</span><br>decay = <span class="hljs-number">.75</span><br>decay_step = <span class="hljs-number">1000</span><br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AdamW, get_linear_schedule_with_warmup<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Optimizer</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model_parameters, steps</span>):<br>        self.all_params = []<br>        self.optims = []<br>        self.schedulers = []<br><br>        <span class="hljs-keyword">for</span> name, parameters <span class="hljs-keyword">in</span> model_parameters.items():<br>            <span class="hljs-keyword">if</span> name.startswith(<span class="hljs-string">&quot;basic&quot;</span>):<br>                optim = torch.optim.Adam(parameters, lr=learning_rate)<br>                self.optims.append(optim)<br><br>                l = <span class="hljs-keyword">lambda</span> step: decay ** (step // decay_step)<br>                scheduler = torch.optim.lr_scheduler.LambdaLR(optim, lr_lambda=l)<br>                self.schedulers.append(scheduler)<br>                self.all_params.extend(parameters)<br>            <span class="hljs-keyword">elif</span> name.startswith(<span class="hljs-string">&quot;bert&quot;</span>):<br>                optim_bert = AdamW(parameters, bert_lr, eps=<span class="hljs-number">1e-8</span>)<br>                self.optims.append(optim_bert)<br><br>                scheduler_bert = get_linear_schedule_with_warmup(optim_bert, <span class="hljs-number">0</span>, steps)<br>                self.schedulers.append(scheduler_bert)<br><br>                <span class="hljs-keyword">for</span> group <span class="hljs-keyword">in</span> parameters:<br>                    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> group[<span class="hljs-string">&#x27;params&#x27;</span>]:<br>                        self.all_params.append(p)<br>            <span class="hljs-keyword">else</span>:<br>                Exception(<span class="hljs-string">&quot;no nameed parameters.&quot;</span>)<br><br>        self.num = <span class="hljs-built_in">len</span>(self.optims)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">for</span> optim, scheduler <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.optims, self.schedulers):<br>            optim.step()<br>            scheduler.step()<br>            optim.zero_grad()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">zero_grad</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">for</span> optim <span class="hljs-keyword">in</span> self.optims:<br>            optim.zero_grad()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_lr</span>(<span class="hljs-params">self</span>):<br>        lrs = <span class="hljs-built_in">tuple</span>(<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: x.get_lr()[-<span class="hljs-number">1</span>], self.schedulers))<br>        lr = <span class="hljs-string">&#x27; %.5f&#x27;</span> * self.num<br>        res = lr % lrs<br>        <span class="hljs-keyword">return</span> res<br><br><span class="hljs-comment"># build dataset</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sentence_split</span>(<span class="hljs-params">text, vocab, max_sent_len=<span class="hljs-number">256</span>, max_segment=<span class="hljs-number">16</span></span>):<br>    words = text.strip().split()<br>    document_len = <span class="hljs-built_in">len</span>(words)<br><br>    index = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, document_len, max_sent_len))<br>    index.append(document_len)<br><br>    segments = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(index) - <span class="hljs-number">1</span>):<br>        segment = words[index[i]: index[i + <span class="hljs-number">1</span>]]<br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(segment) &gt; <span class="hljs-number">0</span><br>        segment = [word <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> vocab._id2word <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;&lt;UNK&gt;&#x27;</span> <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> segment]<br>        segments.append([<span class="hljs-built_in">len</span>(segment), segment])<br><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(segments) &gt; <span class="hljs-number">0</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(segments) &gt; max_segment:<br>        segment_ = <span class="hljs-built_in">int</span>(max_segment / <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">return</span> segments[:segment_] + segments[-segment_:]<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> segments<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_examples</span>(<span class="hljs-params">data, word_encoder, vocab, max_sent_len=<span class="hljs-number">256</span>, max_segment=<span class="hljs-number">8</span></span>):<br>    label2id = vocab.label2id<br>    examples = []<br><br>    <span class="hljs-keyword">for</span> text, label <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(data[<span class="hljs-string">&#x27;text&#x27;</span>], data[<span class="hljs-string">&#x27;label&#x27;</span>]):<br>        <span class="hljs-comment"># label</span><br>        <span class="hljs-built_in">id</span> = label2id(label)<br><br>        <span class="hljs-comment"># words</span><br>        sents_words = sentence_split(text, vocab, max_sent_len-<span class="hljs-number">2</span>, max_segment)<br>        doc = []<br>        <span class="hljs-keyword">for</span> sent_len, sent_words <span class="hljs-keyword">in</span> sents_words:<br>            token_ids = word_encoder.encode(sent_words)<br>            sent_len = <span class="hljs-built_in">len</span>(token_ids)<br>            token_type_ids = [<span class="hljs-number">0</span>] * sent_len<br>            doc.append([sent_len, token_ids, token_type_ids])<br>        examples.append([<span class="hljs-built_in">id</span>, <span class="hljs-built_in">len</span>(doc), doc])<br><br>    logging.info(<span class="hljs-string">&#x27;Total %d docs.&#x27;</span> % <span class="hljs-built_in">len</span>(examples))<br>    <span class="hljs-keyword">return</span> examples<br><br><br><span class="hljs-comment"># build loader</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_slice</span>(<span class="hljs-params">data, batch_size</span>):<br>    batch_num = <span class="hljs-built_in">int</span>(np.ceil(<span class="hljs-built_in">len</span>(data) / <span class="hljs-built_in">float</span>(batch_size)))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(batch_num):<br>        cur_batch_size = batch_size <span class="hljs-keyword">if</span> i &lt; batch_num - <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-built_in">len</span>(data) - batch_size * i<br>        docs = [data[i * batch_size + b] <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(cur_batch_size)]<br><br>        <span class="hljs-keyword">yield</span> docs<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">data_iter</span>(<span class="hljs-params">data, batch_size, shuffle=<span class="hljs-literal">True</span>, noise=<span class="hljs-number">1.0</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    randomly permute data, then sort by source length, and partition into batches</span><br><span class="hljs-string">    ensure that the length of  sentences in each batch</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    batched_data = []<br>    <span class="hljs-keyword">if</span> shuffle:<br>        np.random.shuffle(data)<br><br>        lengths = [example[<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> example <span class="hljs-keyword">in</span> data]<br>        noisy_lengths = [- (l + np.random.uniform(- noise, noise)) <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> lengths]<br>        sorted_indices = np.argsort(noisy_lengths).tolist()<br>        sorted_data = [data[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sorted_indices]<br>    <span class="hljs-keyword">else</span>:<br>        sorted_data = data<br><br>    batched_data.extend(<span class="hljs-built_in">list</span>(batch_slice(sorted_data, batch_size)))<br><br>    <span class="hljs-keyword">if</span> shuffle:<br>        np.random.shuffle(batched_data)<br><br>    <span class="hljs-keyword">for</span> batch <span class="hljs-keyword">in</span> batched_data:<br>        <span class="hljs-keyword">yield</span> batch<br><br><span class="hljs-comment"># some function</span><br><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> f1_score, precision_score, recall_score<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_score</span>(<span class="hljs-params">y_ture, y_pred</span>):<br>    y_ture = np.array(y_ture)<br>    y_pred = np.array(y_pred)<br>    f1 = f1_score(y_ture, y_pred, average=<span class="hljs-string">&#x27;macro&#x27;</span>) * <span class="hljs-number">100</span><br>    p = precision_score(y_ture, y_pred, average=<span class="hljs-string">&#x27;macro&#x27;</span>) * <span class="hljs-number">100</span><br>    r = recall_score(y_ture, y_pred, average=<span class="hljs-string">&#x27;macro&#x27;</span>) * <span class="hljs-number">100</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>((reformat(p, <span class="hljs-number">2</span>), reformat(r, <span class="hljs-number">2</span>), reformat(f1, <span class="hljs-number">2</span>))), reformat(f1, <span class="hljs-number">2</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">reformat</span>(<span class="hljs-params">num, n</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">float</span>(<span class="hljs-built_in">format</span>(num, <span class="hljs-string">&#x27;0.&#x27;</span> + <span class="hljs-built_in">str</span>(n) + <span class="hljs-string">&#x27;f&#x27;</span>))<br><br><br><span class="hljs-comment"># build trainer</span><br><br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> classification_report<br><br>clip = <span class="hljs-number">5.0</span><br>epochs = <span class="hljs-number">1</span><br>early_stops = <span class="hljs-number">3</span><br>log_interval = <span class="hljs-number">50</span><br><br>test_batch_size = <span class="hljs-number">16</span><br>train_batch_size = <span class="hljs-number">16</span><br><br>save_model = <span class="hljs-string">&#x27;./bert.bin&#x27;</span><br>save_test = <span class="hljs-string">&#x27;./bert.csv&#x27;</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Trainer</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model, vocab</span>):<br>        self.model = model<br>        self.report = <span class="hljs-literal">True</span><br><br>        self.train_data = get_examples(train_data, model.word_encoder, vocab)<br>        self.batch_num = <span class="hljs-built_in">int</span>(np.ceil(<span class="hljs-built_in">len</span>(self.train_data) / <span class="hljs-built_in">float</span>(train_batch_size)))<br>        self.dev_data = get_examples(dev_data, model.word_encoder, vocab)<br>        self.test_data = get_examples(test_data, model.word_encoder, vocab)<br><br>        <span class="hljs-comment"># criterion</span><br>        self.criterion = nn.CrossEntropyLoss()<br><br>        <span class="hljs-comment"># label name</span><br>        self.target_names = vocab.target_names<br><br>        <span class="hljs-comment"># optimizer</span><br>        self.optimizer = Optimizer(model.all_parameters, steps=self.batch_num * epochs)<br><br>        <span class="hljs-comment"># count</span><br>        self.step = <span class="hljs-number">0</span><br>        self.early_stop = -<span class="hljs-number">1</span><br>        self.best_train_f1, self.best_dev_f1 = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>        self.last_epoch = epochs<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">self</span>):<br>        logging.info(<span class="hljs-string">&#x27;Start training...&#x27;</span>)<br>        <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, epochs + <span class="hljs-number">1</span>):<br>            train_f1 = self._train(epoch)<br><br>            dev_f1 = self._<span class="hljs-built_in">eval</span>(epoch)<br><br>            <span class="hljs-keyword">if</span> self.best_dev_f1 &lt;= dev_f1:<br>                logging.info(<br>                    <span class="hljs-string">&quot;Exceed history dev = %.2f, current dev = %.2f&quot;</span> % (self.best_dev_f1, dev_f1))<br>                torch.save(self.model.state_dict(), save_model)<br><br>                self.best_train_f1 = train_f1<br>                self.best_dev_f1 = dev_f1<br>                self.early_stop = <span class="hljs-number">0</span><br>            <span class="hljs-keyword">else</span>:<br>                self.early_stop += <span class="hljs-number">1</span><br>                <span class="hljs-keyword">if</span> self.early_stop == early_stops:<br>                    logging.info(<br>                        <span class="hljs-string">&quot;Eearly stop in epoch %d, best train: %.2f, dev: %.2f&quot;</span> % (<br>                            epoch - early_stops, self.best_train_f1, self.best_dev_f1))<br>                    self.last_epoch = epoch<br>                    <span class="hljs-keyword">break</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test</span>(<span class="hljs-params">self</span>):<br>        self.model.load_state_dict(torch.load(save_model))<br>        self._<span class="hljs-built_in">eval</span>(self.last_epoch + <span class="hljs-number">1</span>, test=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_train</span>(<span class="hljs-params">self, epoch</span>):<br>        self.optimizer.zero_grad()<br>        self.model.train()<br><br>        start_time = time.time()<br>        epoch_start_time = time.time()<br>        overall_losses = <span class="hljs-number">0</span><br>        losses = <span class="hljs-number">0</span><br>        batch_idx = <span class="hljs-number">1</span><br>        y_pred = []<br>        y_true = []<br>        <span class="hljs-keyword">for</span> batch_data <span class="hljs-keyword">in</span> data_iter(self.train_data, train_batch_size, shuffle=<span class="hljs-literal">True</span>):<br>            torch.cuda.empty_cache()<br>            batch_inputs, batch_labels = self.batch2tensor(batch_data)<br>            batch_outputs = self.model(batch_inputs)<br>            loss = self.criterion(batch_outputs, batch_labels)<br>            loss.backward()<br><br>            loss_value = loss.detach().cpu().item()<br>            losses += loss_value<br>            overall_losses += loss_value<br><br>            y_pred.extend(torch.<span class="hljs-built_in">max</span>(batch_outputs, dim=<span class="hljs-number">1</span>)[<span class="hljs-number">1</span>].cpu().numpy().tolist())<br>            y_true.extend(batch_labels.cpu().numpy().tolist())<br><br>            nn.utils.clip_grad_norm_(self.optimizer.all_params, max_norm=clip)<br>            <span class="hljs-keyword">for</span> optimizer, scheduler <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.optimizer.optims, self.optimizer.schedulers):<br>                optimizer.step()<br>                scheduler.step()<br>            self.optimizer.zero_grad()<br><br>            self.step += <span class="hljs-number">1</span><br><br>            <span class="hljs-keyword">if</span> batch_idx % log_interval == <span class="hljs-number">0</span>:<br>                elapsed = time.time() - start_time<br><br>                lrs = self.optimizer.get_lr()<br>                logging.info(<br>                    <span class="hljs-string">&#x27;| epoch &#123;:3d&#125; | step &#123;:3d&#125; | batch &#123;:3d&#125;/&#123;:3d&#125; | lr&#123;&#125; | loss &#123;:.4f&#125; | s/batch &#123;:.2f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<br>                        epoch, self.step, batch_idx, self.batch_num, lrs,<br>                        losses / log_interval,<br>                        elapsed / log_interval))<br><br>                losses = <span class="hljs-number">0</span><br>                start_time = time.time()<br><br>            batch_idx += <span class="hljs-number">1</span><br><br>        overall_losses /= self.batch_num<br>        during_time = time.time() - epoch_start_time<br><br>        <span class="hljs-comment"># reformat</span><br>        overall_losses = reformat(overall_losses, <span class="hljs-number">4</span>)<br>        score, f1 = get_score(y_true, y_pred)<br><br>        logging.info(<br>            <span class="hljs-string">&#x27;| epoch &#123;:3d&#125; | score &#123;&#125; | f1 &#123;&#125; | loss &#123;:.4f&#125; | time &#123;:.2f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(epoch, score, f1,<br>                                                                                  overall_losses,<br>                                                                                  during_time))<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">set</span>(y_true) == <span class="hljs-built_in">set</span>(y_pred) <span class="hljs-keyword">and</span> self.report:<br>            report = classification_report(y_true, y_pred, digits=<span class="hljs-number">4</span>, target_names=self.target_names)<br>            logging.info(<span class="hljs-string">&#x27;\n&#x27;</span> + report)<br><br>        <span class="hljs-keyword">return</span> f1<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_eval</span>(<span class="hljs-params">self, epoch, test=<span class="hljs-literal">False</span></span>):<br>        self.model.<span class="hljs-built_in">eval</span>()<br>        start_time = time.time()<br>        data = self.test_data <span class="hljs-keyword">if</span> test <span class="hljs-keyword">else</span> self.dev_data<br>        y_pred = []<br>        y_true = []<br>        <span class="hljs-keyword">with</span> torch.no_grad():<br>            <span class="hljs-keyword">for</span> batch_data <span class="hljs-keyword">in</span> data_iter(data, test_batch_size, shuffle=<span class="hljs-literal">False</span>):<br>                torch.cuda.empty_cache()<br>                batch_inputs, batch_labels = self.batch2tensor(batch_data)<br>                batch_outputs = self.model(batch_inputs)<br>                y_pred.extend(torch.<span class="hljs-built_in">max</span>(batch_outputs, dim=<span class="hljs-number">1</span>)[<span class="hljs-number">1</span>].cpu().numpy().tolist())<br>                y_true.extend(batch_labels.cpu().numpy().tolist())<br><br>            score, f1 = get_score(y_true, y_pred)<br><br>            during_time = time.time() - start_time<br><br>            <span class="hljs-keyword">if</span> test:<br>                df = pd.DataFrame(&#123;<span class="hljs-string">&#x27;label&#x27;</span>: y_pred&#125;)<br>                df.to_csv(save_test, index=<span class="hljs-literal">False</span>, sep=<span class="hljs-string">&#x27;,&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                logging.info(<br>                    <span class="hljs-string">&#x27;| epoch &#123;:3d&#125; | dev | score &#123;&#125; | f1 &#123;&#125; | time &#123;:.2f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(epoch, score, f1,<br>                                                                                  during_time))<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">set</span>(y_true) == <span class="hljs-built_in">set</span>(y_pred) <span class="hljs-keyword">and</span> self.report:<br>                    report = classification_report(y_true, y_pred, digits=<span class="hljs-number">4</span>, target_names=self.target_names)<br>                    logging.info(<span class="hljs-string">&#x27;\n&#x27;</span> + report)<br><br>        <span class="hljs-keyword">return</span> f1<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">batch2tensor</span>(<span class="hljs-params">self, batch_data</span>):<br>        <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">            [[label, doc_len, [[sent_len, [sent_id0, ...], [sent_id1, ...]], ...]]</span><br><span class="hljs-string">        &#x27;&#x27;&#x27;</span><br>        batch_size = <span class="hljs-built_in">len</span>(batch_data)<br>        doc_labels = []<br>        doc_lens = []<br>        doc_max_sent_len = []<br>        <span class="hljs-keyword">for</span> doc_data <span class="hljs-keyword">in</span> batch_data:<br>            doc_labels.append(doc_data[<span class="hljs-number">0</span>])<br>            doc_lens.append(doc_data[<span class="hljs-number">1</span>])<br>            sent_lens = [sent_data[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> sent_data <span class="hljs-keyword">in</span> doc_data[<span class="hljs-number">2</span>]]<br>            max_sent_len = <span class="hljs-built_in">max</span>(sent_lens)<br>            doc_max_sent_len.append(max_sent_len)<br><br>        max_doc_len = <span class="hljs-built_in">max</span>(doc_lens)<br>        max_sent_len = <span class="hljs-built_in">max</span>(doc_max_sent_len)<br><br>        batch_inputs1 = torch.zeros((batch_size, max_doc_len, max_sent_len), dtype=torch.int64)<br>        batch_inputs2 = torch.zeros((batch_size, max_doc_len, max_sent_len), dtype=torch.int64)<br>        batch_masks = torch.zeros((batch_size, max_doc_len, max_sent_len), dtype=torch.float32)<br>        batch_labels = torch.LongTensor(doc_labels)<br><br>        <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(batch_size):<br>            <span class="hljs-keyword">for</span> sent_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(doc_lens[b]):<br>                sent_data = batch_data[b][<span class="hljs-number">2</span>][sent_idx]<br>                <span class="hljs-keyword">for</span> word_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(sent_data[<span class="hljs-number">0</span>]):<br>                    batch_inputs1[b, sent_idx, word_idx] = sent_data[<span class="hljs-number">1</span>][word_idx]<br>                    batch_inputs2[b, sent_idx, word_idx] = sent_data[<span class="hljs-number">2</span>][word_idx]<br>                    batch_masks[b, sent_idx, word_idx] = <span class="hljs-number">1</span><br><br>        <span class="hljs-keyword">if</span> use_cuda:<br>            batch_inputs1 = batch_inputs1.to(device)<br>            batch_inputs2 = batch_inputs2.to(device)<br>            batch_masks = batch_masks.to(device)<br>            batch_labels = batch_labels.to(device)<br><br>        <span class="hljs-keyword">return</span> (batch_inputs1, batch_inputs2, batch_masks), batch_labels<br><br><span class="hljs-comment"># train</span><br>trainer = Trainer(model, vocab)<br>trainer.train()<br><br><span class="hljs-comment"># test</span><br>trainer.test()<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>NLP-Assignment4</title>
    <link href="/2022/05/15/NLP-Assignment4/"/>
    <url>/2022/05/15/NLP-Assignment4/</url>
    
    <content type="html"><![CDATA[<h1 id="assignment4è®²è§£">Assignment4è®²è§£</h1><h2 id="rnnå’Œç¥ç»ç½‘ç»œæœºå™¨ç¿»è¯‘">RNNå’Œç¥ç»ç½‘ç»œæœºå™¨ç¿»è¯‘</h2><p>æœºå™¨ç¿»è¯‘æ˜¯æŒ‡ï¼Œæ„å»ºä¸€ä¸ªç³»ç»Ÿå®Œæˆæºè¯­è¨€åˆ°ç›®æ ‡è¯­è¨€çš„å˜æ¢æ˜ å°„ï¼Œæ¯”å¦‚ç»™å®šä¸€ä¸ªæºå¥å­ï¼ˆæ¯”å¦‚è¥¿ç­ç‰™è¯­ï¼‰ï¼Œè¾“å‡ºä¸€ä¸ªç›®æ ‡å¥å­ï¼ˆæ¯”å¦‚è‹±è¯­ï¼‰ã€‚æœ¬æ¬¡ä½œä¸šä¸­è¦å®ç°çš„æ˜¯ä¸€ä¸ªå¸¦æ³¨æ„åŠ›æœºåˆ¶çš„Seq2Seqç¥ç»æ¨¡å‹ï¼Œç”¨äºæ„å»ºç¥ç»ç½‘ç»œæœºå™¨ç¿»è¯‘ï¼ˆNMTï¼‰ç³»ç»Ÿã€‚é¦–å…ˆæˆ‘ä»¬æ¥çœ‹NMTç³»ç»Ÿçš„è®­ç»ƒè¿‡ç¨‹ï¼Œå®ƒç”¨åˆ°äº†åŒå‘LSTMä½œä¸ºç¼–ç å™¨ï¼ˆencoderï¼‰å’Œå•å‘LSTMä½œä¸ºè§£ç å™¨ï¼ˆdecoderï¼‰ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/0060yMmAly1gsjzdzvwbaj30pv0hzjuy.jpg" referrerpolicy="no-referrer"/></p><p>ç»™å®šé•¿åº¦ä¸ºmçš„æºè¯­è¨€å¥å­ï¼ˆsourceï¼‰ï¼Œç»è¿‡åµŒå…¥å±‚ï¼Œå¾—åˆ°è¾“å…¥åºåˆ— <spanclass="math inline">\(x_1, x_2, â€¦, x_m \in R^{e \times1}\)</span>ï¼Œ<spanclass="math inline">\(e\)</span>æ˜¯è¯å‘é‡å¤§å°ã€‚ç»è¿‡åŒå‘Encoderåï¼Œå¾—åˆ°å‰å‘ï¼ˆâ†’ï¼‰å’Œåå‘ï¼ˆâ†ï¼‰LSTMçš„éšè—å±‚å’Œç¥ç»å…ƒçŠ¶æ€ï¼Œå°†ä¸¤ä¸ªæ–¹å‘çš„çŠ¶æ€è¿æ¥èµ·æ¥å¾—åˆ°æ—¶é—´æ­¥<span class="math inline">\(i\)</span> çš„éšè—çŠ¶æ€ <spanclass="math inline">\(h_i^{enc}\)</span> å’Œ <spanclass="math inline">\(c_i^{enc}\)</span> ï¼š <spanclass="math display">\[\mathbf{h}_{i}^{\text {enc }}=\left[\overleftarrow{\mathbf{h}_{i}^{\text{enc }}} ; \overrightarrow{\mathbf{h}_{i}^{\text {enc }}}\right] \text {where } \mathbf{h}_{i}^{\text {enc }} \in \mathbb{R}^{2 h \times 1},\overleftarrow{\mathbf{h}_{i}^{\text {enc }}},\overrightarrow{\mathbf{h}_{i}^{\text {en }}} \in \mathbb{R}^{h \times1} \quad 1 \leq i \leq m\]</span></p><p><span class="math display">\[\mathbf{c}_{i}^{\text {enc }}=\left[\overleftarrow{\mathbf{c}_{i}^{\text{enc }}} ; \overrightarrow{\mathbf{c}_{i}^{\text {enc }}}\right] \text {where } \mathbf{c}_{i}^{\text {enc }} \in \mathbb{R}^{2 h \times 1},\overleftarrow{\mathbf{c}_{i}^{\text {enc }}},\overrightarrow{\mathbf{c}_{i}^{\text {en }}} \in \mathbb{R}^{h \times1} \quad 1 \leq i \leq m\]</span></p><p>æ¥ç€æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªçº¿æ€§å±‚æ¥åˆå§‹åŒ–Decoderçš„åˆå§‹éšè—ã€ç¥ç»å…ƒçš„çŠ¶æ€ï¼š <spanclass="math display">\[\mathbf{h}_{0}^{\text {dec}}=\mathbf{W}_{h}\left[\overleftarrow{\mathbf{h}_{1}^{\text {enc }}} ;\overrightarrow{\mathbf{h}_{m}^{\text {enc }}}\right] \text { where }\mathbf{h}_{0}^{\text {dec }} \in \mathbb{R}^{h \times 1},\mathbf{W}_{h} \in \mathbb{R}^{h \times 2 h}\]</span></p><p><span class="math display">\[\mathbf{c}_{0}^{\text {dec}}=\mathbf{W}_{c}\left[\overleftarrow{\mathbf{c}_{1}^{\text {enc }}} ;\overrightarrow{\mathbf{c}_{m}^{\text {enc }}}\right] \text { where }\mathbf{c}_{0}^{\text {dec }} \in \mathbb{R}^{h \times 1},\mathbf{W}_{c} \in \mathbb{R}^{h \times 2 h}\]</span></p><p>Decoderçš„æ—¶é—´æ­¥<span class="math inline">\(t\)</span> çš„è¾“å…¥ä¸º <spanclass="math inline">\(\bar{y}_t\)</span> ï¼Œå®ƒç”±ç›®æ ‡è¯­è¨€å¥å­ <spanclass="math inline">\(y_t\)</span>å’Œä¸Šä¸€ç¥ç»å…ƒçš„è¾“å‡ºå’Œä¸Šä¸€ç¥ç»å…ƒçš„è¾“å‡º<spanclass="math inline">\(o_{t-1}\)</span>ç»è¿‡è¿æ¥å¾—åˆ°ï¼Œç»è¿‡è¿æ¥å¾—åˆ°ï¼Œ<spanclass="math inline">\(o_0\)</span>æ˜¯0å‘é‡ï¼Œæ‰€ä»¥ <spanclass="math inline">\(\bar{y}_t \in R^{(e + h) \times 1}\)</span> <spanclass="math display">\[\mathbf{h}_{t}^{\mathrm{dec}},\mathbf{c}_{t}^{\mathrm{dec}}=\operatorname{Decoder}\left(\overline{\mathbf{y}_{t}},\mathbf{h}_{t-1}^{\mathrm{dec}}, \mathbf{c}_{t-1}^{\mathrm{dec}}\right)\text { where } \mathbf{h}_{t}^{\mathrm{dec}} \in \mathbb{R}^{h \times1}, \mathbf{c}_{t}^{\mathrm{dec}} \in \mathbb{R}^{h \times 1}\]</span> æ¥ç€æˆ‘ä»¬ä½¿ç”¨ <span class="math inline">\(h^{dec}_t\)</span>æ¥è®¡ç®—åœ¨ <span class="math inline">\(h^{enc}_0, h^{enc}_1, â€¦,h^{enc}_m\)</span> çš„ä¹˜ç§¯æ³¨æ„åŠ›ï¼ˆmultiplicative attentionï¼‰ï¼š <spanclass="math display">\[\begin{array}{c}\mathbf{e}_{t, i}=\left(\mathbf{h}_{t}^{\mathrm{dec}}\right)^{T}\mathbf{W}_{\text {attProj }} \mathbf{h}_{i}^{\text {enc }} \text {where } \mathbf{e}_{t} \in \mathbb{R}^{m \times 1}, \mathbf{W}_{\text{attProj }} \in \mathbb{R}^{h \times 2 h} \quad 1 \leq i \leq m \\\alpha_{t}=\operatorname{softmax}\left(\mathbf{e}_{t}\right) \text {where } \alpha_{t} \in \mathbb{R}^{m \times 1} \\\mathbf{a}_{t}=\sum_{i=1}^{m} \alpha_{t, i} \mathbf{h}_{i}^{\text {enc}} \text { where } \mathbf{a}_{t} \in \mathbb{R}^{2 h \times 1}\end{array}\]</span> ç„¶åå°†æ³¨æ„åŠ› <span class="math inline">\(a_t\)</span>å’Œè§£ç å™¨çš„éšè—çŠ¶æ€ <span class="math inline">\(h^{dec}_t\)</span>è¿æ¥ï¼Œé€å…¥çº¿æ€§å±‚ï¼Œå¾—åˆ° <em>combined-output</em> å‘é‡ <spanclass="math inline">\(o_t\)</span> <span class="math display">\[\begin{array}{r}\mathbf{u}_{t}=\left[\mathbf{a}_{t} ;\mathbf{h}_{t}^{\mathrm{dec}}\right] \text { where } \mathbf{u}_{t} \in\mathbb{R}^{3 h \times 1} \\\mathbf{v}_{t}=\mathbf{W}_{u} \mathbf{u}_{t} \text { where }\mathbf{v}_{t} \in \mathbb{R}^{h \times 1}, \mathbf{W}_{u} \in\mathbb{R}^{h \times 3 h} \\\mathbf{o}_{t}=\operatorname{Dropout}\left(\tanh\left(\mathbf{v}_{t}\right)\right) \text { where } \mathbf{o}_{t} \in\mathbb{R}^{h \times 1}\end{array}\]</span> è¿™æ ·ä»¥æ¥ï¼Œç›®æ ‡è¯çš„æ¦‚ç‡åˆ†å¸ƒåˆ™ä¸ºï¼š <span class="math display">\[\mathbf{P}_{t}=\operatorname{softmax}\left(\mathbf{W}_{\text {vocab }}\mathbf{o}_{t}\right) \text { where } \mathbf{P}_{t} \in\mathbb{R}^{V_{t} \times 1}, \mathbf{W}_{\text {vocab }} \in\mathbb{R}^{V_{t} \times h}\]</span> ä½¿ç”¨äº¤å‰ç†µåšç›®æ ‡å‡½æ•°å³å¯ <span class="math display">\[J_{t}(\theta)=\text { CrossEntropy }\left(\mathbf{P}_{t},\mathbf{g}_{t}\right)\]</span></p><p>ä»£ç å®ç°éƒ¨åˆ†ï¼Œå…³é”®åœ¨äºè¿‡ç¨‹ä¸­çš„å‘é‡ç»´åº¦ï¼Œå‘é‡ç»´åº¦åŒ¹é…æ²¡æœ‰é—®é¢˜ï¼Œæ•´ä¸ªè¿‡ç¨‹çš„å®ç°å°±æ¯”è¾ƒæ¸…æ™°ã€‚</p><h2 id="part1-ç¥ç»ç½‘ç»œç¿»è¯‘ç³»ç»Ÿä»£ç å®ç°">part1ç¥ç»ç½‘ç»œç¿»è¯‘ç³»ç»Ÿä»£ç å®ç°</h2><h3 id="a-pad_sents">(a) pad_sents</h3><p>In order to apply tensor operations, we must ensure that thesentences in a given batch are of the same length. Thus, we mustidentify the longest sentence in a batch and pad others to be the samelength. Implement the pad sents function in utils.py, which shallproduce these padded sentences.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">pad_sents</span>(<span class="hljs-params">sents, pad_token</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; Pad list of sentences according to the longest sentence in the batch.</span><br><span class="hljs-string">    @param sents (list[list[str]]): list of sentences, where each sentence</span><br><span class="hljs-string">                                    is represented as a list of words</span><br><span class="hljs-string">    @param pad_token (str): padding token</span><br><span class="hljs-string">    @returns sents_padded (list[list[str]]): list of sentences where sentences shorter</span><br><span class="hljs-string">        than the max length sentence are padded out with the pad_token, such that</span><br><span class="hljs-string">        each sentences in the batch now has equal length.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    sents_padded = []<br><br>    <span class="hljs-comment"># YOUR CODE HERE (~6 Lines)</span><br>    corpus_size = <span class="hljs-built_in">len</span>(sents)<br>    lens = [<span class="hljs-built_in">len</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sents]  <span class="hljs-comment"># every sentence&#x27;s length</span><br>    max_lens = <span class="hljs-built_in">max</span>(lens)<br>    sents_padded = [sents[i] + [pad_token] * (max_lens - lens[i]) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(corpus_size)]      <span class="hljs-comment"># shape N x max_lens</span><br>    <span class="hljs-comment"># END YOUR CODE</span><br><br>    <span class="hljs-keyword">return</span> sents_padded<br></code></pre></div></td></tr></table></figure><h3 id="b-modelembeddings">(b) ModelEmbeddings</h3><p>Implement the <code>__init__</code> function in model embeddings.pyto initialize the necessary source and target embeddings.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelEmbeddings</span>(nn.Module): <br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Class that converts input words to their embeddings.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, embed_size, vocab</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Init the Embedding layers.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        @param embed_size (int): Embedding size (dimensionality)</span><br><span class="hljs-string">        @param vocab (Vocab): Vocabulary object containing src and tgt languages</span><br><span class="hljs-string">                              See vocab.py for documentation.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">super</span>(ModelEmbeddings, self).__init__()<br>        self.embed_size = embed_size<br><br>        <span class="hljs-comment"># default values</span><br>        self.source = <span class="hljs-literal">None</span><br>        self.target = <span class="hljs-literal">None</span><br><br>        src_pad_token_idx = vocab.src[<span class="hljs-string">&#x27;&lt;pad&gt;&#x27;</span>]<br>        tgt_pad_token_idx = vocab.tgt[<span class="hljs-string">&#x27;&lt;pad&gt;&#x27;</span>]<br><br>        <span class="hljs-comment"># YOUR CODE HERE (~2 Lines)</span><br>        <span class="hljs-comment"># TODO - Initialize the following variables:</span><br>        <span class="hljs-comment">#     self.source (Embedding Layer for source language)</span><br>        <span class="hljs-comment">#     self.target (Embedding Layer for target langauge)</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment"># Note:</span><br>        <span class="hljs-comment">#     1. `vocab` object contains two vocabularies:</span><br>        <span class="hljs-comment">#            `vocab.src` for source</span><br>        <span class="hljs-comment">#            `vocab.tgt` for target</span><br>        <span class="hljs-comment">#     2. You can get the length of a specific vocabulary by running:</span><br>        <span class="hljs-comment">#             `len(vocab.&lt;specific_vocabulary&gt;)`</span><br>        <span class="hljs-comment">#     3. Remember to include the padding token for the specific vocabulary</span><br>        <span class="hljs-comment">#        when creating your Embedding.</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment"># Use the following docs to properly initialize these variables:</span><br>        <span class="hljs-comment">#     Embedding Layer:</span><br>        <span class="hljs-comment">#         https://pytorch.org/docs/stable/nn.html#torch.nn.Embedding</span><br><br>        self.source = nn.Embedding(<span class="hljs-built_in">len</span>(vocab.src), embed_size, padding_idx=src_pad_token_idx)<br>        self.target = nn.Embedding(<span class="hljs-built_in">len</span>(vocab.tgt), embed_size, padding_idx=tgt_pad_token_idx)<br><br>        <span class="hljs-comment"># END YOUR CODE</span><br></code></pre></div></td></tr></table></figure><h3 id="c-nmt">(c) NMT</h3><p>Implement the <code>__init__</code> function in nmt model.py toinitialize the necessary model embeddings (using the ModelEmbeddingsclass from model embeddings.py) and layers (LSTM, projection, anddropout) for the NMT system</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NMT</span>(nn.Module):<br>    <span class="hljs-string">&quot;&quot;&quot; Simple Neural Machine Translation Model:</span><br><span class="hljs-string">        - Bidrectional LSTM Encoder</span><br><span class="hljs-string">        - Unidirection LSTM Decoder</span><br><span class="hljs-string">        - Global Attention Model (Luong, et al. 2015)</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, embed_size, hidden_size, vocab, dropout_rate=<span class="hljs-number">0.2</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot; Init NMT Model.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        @param embed_size (int): Embedding size (dimensionality)</span><br><span class="hljs-string">        @param hidden_size (int): Hidden Size (dimensionality)</span><br><span class="hljs-string">        @param vocab (Vocab): Vocabulary object containing src and tgt languages</span><br><span class="hljs-string">                              See vocab.py for documentation.</span><br><span class="hljs-string">        @param dropout_rate (float): Dropout probability, for attention</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">super</span>(NMT, self).__init__()<br>        self.model_embeddings = ModelEmbeddings(embed_size, vocab)<br>        self.hidden_size = hidden_size<br>        self.dropout_rate = dropout_rate<br>        self.vocab = vocab<br><br>        <span class="hljs-comment"># default values</span><br>        self.encoder = <span class="hljs-literal">None</span> <br>        self.decoder = <span class="hljs-literal">None</span><br>        self.h_projection = <span class="hljs-literal">None</span><br>        self.c_projection = <span class="hljs-literal">None</span><br>        self.att_projection = <span class="hljs-literal">None</span><br>        self.combined_output_projection = <span class="hljs-literal">None</span><br>        self.target_vocab_projection = <span class="hljs-literal">None</span><br>        self.dropout = <span class="hljs-literal">None</span><br><br>        <span class="hljs-comment"># YOUR CODE HERE (~8 Lines)</span><br>        <span class="hljs-comment"># TODO - Initialize the following variables:</span><br>        <span class="hljs-comment">#     self.encoder (Bidirectional LSTM with bias)</span><br>        <span class="hljs-comment">#     self.decoder (LSTM Cell with bias)</span><br>        <span class="hljs-comment">#     self.h_projection (Linear Layer with no bias), called W_&#123;h&#125; in the PDF.</span><br>        <span class="hljs-comment">#     self.c_projection (Linear Layer with no bias), called W_&#123;c&#125; in the PDF.</span><br>        <span class="hljs-comment">#     self.att_projection (Linear Layer with no bias), called W_&#123;attProj&#125; in the PDF.</span><br>        <span class="hljs-comment">#     self.combined_output_projection (Linear Layer with no bias), called W_&#123;u&#125; in the PDF.</span><br>        <span class="hljs-comment">#     self.target_vocab_projection (Linear Layer with no bias), called W_&#123;vocab&#125; in the PDF.</span><br>        <span class="hljs-comment">#     self.dropout (Dropout Layer)</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment"># Use the following docs to properly initialize these variables:</span><br>        <span class="hljs-comment">#     LSTM:</span><br>        <span class="hljs-comment">#         https://pytorch.org/docs/stable/nn.html#torch.nn.LSTM</span><br>        <span class="hljs-comment">#     LSTM Cell:</span><br>        <span class="hljs-comment">#         https://pytorch.org/docs/stable/nn.html#torch.nn.LSTMCell</span><br>        <span class="hljs-comment">#     Linear Layer:</span><br>        <span class="hljs-comment">#         https://pytorch.org/docs/stable/nn.html#torch.nn.Linear</span><br>        <span class="hljs-comment">#     Dropout Layer:</span><br>        <span class="hljs-comment">#         https://pytorch.org/docs/stable/nn.html#torch.nn.Dropout</span><br><br>        self.encoder = nn.LSTM(embed_size, hidden_size, bias=<span class="hljs-literal">True</span>, bidirectional=<span class="hljs-literal">True</span>)<br>        self.decoder = nn.LSTMCell(embed_size + hidden_size, hidden_size, bias=<span class="hljs-literal">True</span>)<br>        self.h_projection = nn.Linear(hidden_size * <span class="hljs-number">2</span>, hidden_size, bias=<span class="hljs-literal">False</span>) <span class="hljs-comment"># prj output of last h_state of encode (R^2h) to R^h</span><br>        self.c_projection = nn.Linear(hidden_size * <span class="hljs-number">2</span>, hidden_size, bias=<span class="hljs-literal">False</span>)<br>        self.att_projection = nn.Linear(hidden_size * <span class="hljs-number">2</span>, hidden_size, bias=<span class="hljs-literal">False</span>) <span class="hljs-comment"># 1 x 2h (h_encode_i) * 2h x h (W) * h * 1 (h_decode_t) = 1 x 1 = e_t,i</span><br>        self.combined_output_projection = nn.Linear(hidden_size * <span class="hljs-number">3</span>, hidden_size, bias=<span class="hljs-literal">False</span>) <span class="hljs-comment"># use after combined attention output and h_decode</span><br>        self.target_vocab_projection    = nn.Linear(hidden_size, <span class="hljs-built_in">len</span>(vocab.tgt), bias=<span class="hljs-literal">False</span>) <span class="hljs-comment"># for softmax of last</span><br>        self.dropout = nn.Dropout(self.dropout_rate)<br>        <span class="hljs-comment"># END YOUR CODE</span><br><br>        <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, source: <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]], target: <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]</span>) -&gt; torch.Tensor:<br>        <span class="hljs-string">&quot;&quot;&quot; Take a mini-batch of source and target sentences, compute the log-likelihood of</span><br><span class="hljs-string">        target sentences under the language models learned by the NMT system.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        @param source (List[List[str]]): list of source sentence tokens</span><br><span class="hljs-string">        @param target (List[List[str]]): list of target sentence tokens, wrapped by `&lt;s&gt;` and `&lt;/s&gt;`</span><br><span class="hljs-string"></span><br><span class="hljs-string">        @returns scores (Tensor): a variable/tensor of shape (b, ) representing the</span><br><span class="hljs-string">                                    log-likelihood of generating the gold-standard target sentence for</span><br><span class="hljs-string">                                    each example in the input batch. Here b = batch size.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># Compute sentence lengths</span><br>        source_lengths = [<span class="hljs-built_in">len</span>(s) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> source]<br><br>        <span class="hljs-comment"># Convert list of lists into tensors</span><br>        source_padded = self.vocab.src.to_input_tensor(source, device=self.device)   <span class="hljs-comment"># Tensor: (src_len, b)</span><br>        target_padded = self.vocab.tgt.to_input_tensor(target, device=self.device)   <span class="hljs-comment"># Tensor: (tgt_len, b)</span><br><br>        <span class="hljs-comment">#     Run the network forward:</span><br>        <span class="hljs-comment">#     1. Apply the encoder to `source_padded` by calling `self.encode()`</span><br>        <span class="hljs-comment">#     2. Generate sentence masks for `source_padded` by calling `self.generate_sent_masks()`</span><br>        <span class="hljs-comment">#     3. Apply the decoder to compute combined-output by calling `self.decode()`</span><br>        <span class="hljs-comment">#     4. Compute log probability distribution over the target vocabulary using the</span><br>        <span class="hljs-comment">#        combined_outputs returned by the `self.decode()` function.</span><br><br>        enc_hiddens, dec_init_state = self.encode(source_padded, source_lengths)<br>        enc_masks = self.generate_sent_masks(enc_hiddens, source_lengths)<br>        combined_outputs = self.decode(enc_hiddens, enc_masks, dec_init_state, target_padded)<br>        P = F.log_softmax(self.target_vocab_projection(combined_outputs), dim=-<span class="hljs-number">1</span>)<br><br>        <span class="hljs-comment"># Zero out, probabilities for which we have nothing in the target text</span><br>        target_masks = (target_padded != self.vocab.tgt[<span class="hljs-string">&#x27;&lt;pad&gt;&#x27;</span>]).<span class="hljs-built_in">float</span>()<br>        <br>        <span class="hljs-comment"># Compute log probability of generating true target words</span><br>        target_gold_words_log_prob = torch.gather(P, index=target_padded[<span class="hljs-number">1</span>:].unsqueeze(-<span class="hljs-number">1</span>), dim=-<span class="hljs-number">1</span>).squeeze(-<span class="hljs-number">1</span>) * target_masks[<span class="hljs-number">1</span>:]<br>        scores = target_gold_words_log_prob.<span class="hljs-built_in">sum</span>(dim=<span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> scores<br></code></pre></div></td></tr></table></figure><h3 id="d-encode">(d) encode</h3><p>Implement the <code>encode</code> function in nmt model.py. Thisfunction converts the padded source sentences into the tensor<spanclass="math inline">\(X\)</span>, generates<spanclass="math inline">\(h^{enc}_1,...,h^{enc}_m\)</span> , and computesthe initial state<span class="math inline">\(\ h^{dec}_0\)</span>andinitial cell<span class="math inline">\(\ c^{dec}_0\)</span>for theDecoder. You can run a non-comprehensive sanity check byexecuting:<code>python sanity_check.py 1d</code></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">encode</span>(<span class="hljs-params">self, source_padded: torch.Tensor, source_lengths: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-type">Tuple</span>[torch.Tensor, <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor]]:<br>   <span class="hljs-string">&quot;&quot;&quot; Apply the encoder to source sentences to obtain encoder hidden states.</span><br><span class="hljs-string">       Additionally, take the final states of the encoder and project them to obtain initial states for decoder.</span><br><span class="hljs-string"></span><br><span class="hljs-string">   @param source_padded (Tensor): Tensor of padded source sentences with shape (src_len, b), where</span><br><span class="hljs-string">                                   b = batch_size, src_len = maximum source sentence length. Note that </span><br><span class="hljs-string">                                  these have already been sorted in order of longest to shortest sentence.</span><br><span class="hljs-string">   @param source_lengths (List[int]): List of actual lengths for each of the source sentences in the batch</span><br><span class="hljs-string">   @returns enc_hiddens (Tensor): Tensor of hidden units with shape (b, src_len, h*2), where</span><br><span class="hljs-string">                                   b = batch size, src_len = maximum source sentence length, h = hidden size.</span><br><span class="hljs-string">   @returns dec_init_state (tuple(Tensor, Tensor)): Tuple of tensors representing the decoder&#x27;s initial</span><br><span class="hljs-string">                                           hidden state and cell.</span><br><span class="hljs-string">   &quot;&quot;&quot;</span><br>   enc_hiddens, dec_init_state = <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>   <span class="hljs-comment"># YOUR CODE HERE (~ 8 Lines)</span><br>   <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span></span><br>   <span class="hljs-comment">#     1. Construct Tensor `X` of source sentences with shape (src_len, b, e) using the source model embeddings.</span><br>   <span class="hljs-comment">#         src_len = maximum source sentence length, b = batch size, e = embedding size. Note</span><br>   <span class="hljs-comment">#         that there is no initial hidden state or cell for the decoder.</span><br>   <span class="hljs-comment">#     2. Compute `enc_hiddens`, `last_hidden`, `last_cell` by applying the encoder to `X`.</span><br>   <span class="hljs-comment">#         - Before you can apply the encoder, you need to apply the `pack_padded_sequence` function to X.</span><br>   <span class="hljs-comment">#         - After you apply the encoder, you need to apply the `pad_packed_sequence` function to enc_hiddens.</span><br>   <span class="hljs-comment">#         - Note that the shape of the tensor returned by the encoder is (src_len b, h*2) and we want to</span><br>   <span class="hljs-comment">#           return a tensor of shape (b, src_len, h*2) as `enc_hiddens`.</span><br>   <span class="hljs-comment">#     3. Compute `dec_init_state` = (init_decoder_hidden, init_decoder_cell):</span><br>   <span class="hljs-comment">#         - `init_decoder_hidden`:</span><br>   <span class="hljs-comment">#             `last_hidden` is a tensor shape (2, b, h). The first dimension corresponds to forwards and backwards.</span><br>   <span class="hljs-comment">#             Concatenate the forwards and backwards tensors to obtain a tensor shape (b, 2*h).</span><br>   <span class="hljs-comment">#             Apply the h_projection layer to this in order to compute init_decoder_hidden.</span><br>   <span class="hljs-comment">#             This is h_0^&#123;dec&#125; in the PDF. Here b = batch size, h = hidden size</span><br>   <span class="hljs-comment">#         - `init_decoder_cell`:</span><br>   <span class="hljs-comment">#             `last_cell` is a tensor shape (2, b, h). The first dimension corresponds to forwards and backwards.</span><br>   <span class="hljs-comment">#             Concatenate the forwards and backwards tensors to obtain a tensor shape (b, 2*h).</span><br>   <span class="hljs-comment">#             Apply the c_projection layer to this in order to compute init_decoder_cell.</span><br>   <span class="hljs-comment">#             This is c_0^&#123;dec&#125; in the PDF. Here b = batch size, h = hidden size</span><br>   <span class="hljs-comment">#</span><br>   <span class="hljs-comment"># See the following docs, as you may need to use some of the following functions in your implementation:</span><br>   <span class="hljs-comment">#     Pack the padded sequence X before passing to the encoder:</span><br>   <span class="hljs-comment">#         https://pytorch.org/docs/stable/nn.html#torch.nn.utils.rnn.pack_padded_sequence</span><br>   <span class="hljs-comment">#     Pad the packed sequence, enc_hiddens, returned by the encoder:</span><br>   <span class="hljs-comment">#         https://pytorch.org/docs/stable/nn.html#torch.nn.utils.rnn.pad_packed_sequence</span><br>   <span class="hljs-comment">#     Tensor Concatenation:</span><br>   <span class="hljs-comment">#         https://pytorch.org/docs/stable/torch.html#torch.cat</span><br>   <span class="hljs-comment">#     Tensor Permute:</span><br>   <span class="hljs-comment">#         https://pytorch.org/docs/stable/tensors.html#torch.Tensor.permute</span><br>   X = self.model_embeddings.source(source_padded) <span class="hljs-comment"># (src_len, b, e)</span><br>   X = pack_padded_sequence(X, lengths=source_lengths) <span class="hljs-comment"># if feed pack to RNN, it will not calculate output for pad element</span><br>   <span class="hljs-comment"># pack_padded_sequence and pad_packed_sequence example:</span><br>   <span class="hljs-comment"># https://github.com/HarshTrivedi/packing-unpacking-pytorch-minimal-tutorial</span><br>   <span class="hljs-comment"># PackedSequence: Named Tuple with 2 attribute data &amp; batch_size</span><br>   <span class="hljs-comment"># data: shape (batch_sum_len x embed_dim)</span><br>   <span class="hljs-comment"># batch_size: each columns when feed to lstm (max = batch_size (start word of all sentence), min = 1 (only one word in this column))</span><br><br>   <span class="hljs-comment"># After feed PackedSequence to LSTM, return PackedSequence with the same attributes : data &amp; batch_size</span><br>   enc_hiddens, (last_hidden, last_cell) = self.encoder(X)<br>   <span class="hljs-comment"># pad_packed_sequence will unpack PackedSequence, which transform (data &amp; batch_size) -&gt; (max_len, b, h * 2)</span><br>   <span class="hljs-comment"># padded indice will be 0s</span><br>   enc_hiddens, _ = pad_packed_sequence(enc_hiddens)<br>   enc_hiddens = enc_hiddens.transpose(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)<span class="hljs-comment"># (b, max_len, h* 2) ç»´åº¦äº’æ¢</span><br><br>   last_hidden = torch.cat((last_hidden[<span class="hljs-number">0</span>], last_hidden[<span class="hljs-number">1</span>]), <span class="hljs-number">1</span>)<span class="hljs-comment"># (2, b, h) -&gt; (b, h * 2)</span><br>   init_decoder_hidden = self.h_projection(last_hidden)<br><br>   last_cell = torch.cat((last_cell[<span class="hljs-number">0</span>], last_cell[<span class="hljs-number">1</span>]), <span class="hljs-number">1</span>)<br>   init_decoder_cell = self.c_projection(last_cell)<br><br>   dec_init_state = (init_decoder_hidden, init_decoder_cell)<br>   <span class="hljs-comment"># END YOUR CODE</span><br><br>   <span class="hljs-keyword">return</span> enc_hiddens, dec_init_state<br></code></pre></div></td></tr></table></figure><h3 id="e-decode">(e) decode</h3><p>Implement the <code>decode</code> function in nmt model.py. Thisfunction constructs yÂ¯ and runs the step function over every timestepfor the input. You can run a non-comprehensive sanity check byexecuting:<code>python sanity_check.py 1e</code></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">self, enc_hiddens: torch.Tensor, enc_masks: torch.Tensor,</span><br><span class="hljs-params">            dec_init_state: <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor], target_padded: torch.Tensor</span>) -&gt; torch.Tensor:<br>    <span class="hljs-string">&quot;&quot;&quot;Compute combined output vectors for a batch.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    @param enc_hiddens (Tensor): Hidden states (b, src_len, h*2), where</span><br><span class="hljs-string">                                 b = batch size, src_len = maximum source sentence length, h = hidden size.</span><br><span class="hljs-string">    @param enc_masks (Tensor): Tensor of sentence masks (b, src_len), where</span><br><span class="hljs-string">                                 b = batch size, src_len = maximum source sentence length.</span><br><span class="hljs-string">    @param dec_init_state (tuple(Tensor, Tensor)): Initial state and cell for decoder</span><br><span class="hljs-string">    @param target_padded (Tensor): Gold-standard padded target sentences (tgt_len, b), where</span><br><span class="hljs-string">                                   tgt_len = maximum target sentence length, b = batch size. </span><br><span class="hljs-string"></span><br><span class="hljs-string">    @returns combined_outputs (Tensor): combined output tensor  (tgt_len, b,  h), where</span><br><span class="hljs-string">                                    tgt_len = maximum target sentence length, b = batch_size,  h = hidden size</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Chop of the &lt;END&gt; token for max length sentences.</span><br>    target_padded = target_padded[:-<span class="hljs-number">1</span>]<br><br>    <span class="hljs-comment"># Initialize the decoder state (hidden and cell)</span><br>    dec_state = dec_init_state<br><br>    <span class="hljs-comment"># Initialize previous combined output vector o_&#123;t-1&#125; as zero</span><br>    batch_size = enc_hiddens.size(<span class="hljs-number">0</span>)<br>    o_prev = torch.zeros(batch_size, self.hidden_size, device=self.device)<br><br>    <span class="hljs-comment"># Initialize a list we will use to collect the combined output o_t on each step</span><br>    combined_outputs = []<br><br>    <span class="hljs-comment"># YOUR CODE HERE (~9 Lines)</span><br>    <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span></span><br>    <span class="hljs-comment">#     1. Apply the attention projection layer to `enc_hiddens` to obtain `enc_hiddens_proj`,</span><br>    <span class="hljs-comment">#         which should be shape (b, src_len, h),</span><br>    <span class="hljs-comment">#         where b = batch size, src_len = maximum source length, h = hidden size.</span><br>    <span class="hljs-comment">#         This is applying W_&#123;attProj&#125; to h^enc, as described in the PDF.</span><br>    <span class="hljs-comment">#     2. Construct tensor `Y` of target sentences with shape (tgt_len, b, e) using the target model embeddings.</span><br>    <span class="hljs-comment">#         where tgt_len = maximum target sentence length, b = batch size, e = embedding size.</span><br>    <span class="hljs-comment">#     3. Use the torch.split function to iterate over the time dimension of Y.</span><br>    <span class="hljs-comment">#         Within the loop, this will give you Y_t of shape (1, b, e) where b = batch size, e = embedding size.</span><br>    <span class="hljs-comment">#             - Squeeze Y_t into a tensor of dimension (b, e).</span><br>    <span class="hljs-comment">#             - Construct Ybar_t by concatenating Y_t with o_prev.</span><br>    <span class="hljs-comment">#             - Use the step function to compute the the Decoder&#x27;s next (cell, state) values</span><br>    <span class="hljs-comment">#               as well as the new combined output o_t.</span><br>    <span class="hljs-comment">#             - Append o_t to combined_outputs</span><br>    <span class="hljs-comment">#             - Update o_prev to the new o_t.</span><br>    <span class="hljs-comment">#     4. Use torch.stack to convert combined_outputs from a list length tgt_len of</span><br>    <span class="hljs-comment">#         tensors shape (b, h), to a single tensor shape (tgt_len, b, h)</span><br>    <span class="hljs-comment">#         where tgt_len = maximum target sentence length, b = batch size, h = hidden size.</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># Note:</span><br>    <span class="hljs-comment">#    - When using the squeeze() function make sure to specify the dimension you want to squeeze</span><br>    <span class="hljs-comment">#      over. Otherwise, you will remove the batch dimension accidentally, if batch_size = 1.</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># Use the following docs to implement this functionality:</span><br>    <span class="hljs-comment">#     Zeros Tensor:</span><br>    <span class="hljs-comment">#         https://pytorch.org/docs/stable/torch.html#torch.zeros</span><br>    <span class="hljs-comment">#     Tensor Splitting (iteration):</span><br>    <span class="hljs-comment">#         https://pytorch.org/docs/stable/torch.html#torch.split</span><br>    <span class="hljs-comment">#     Tensor Dimension Squeezing:</span><br>    <span class="hljs-comment">#         https://pytorch.org/docs/stable/torch.html#torch.squeeze</span><br>    <span class="hljs-comment">#     Tensor Concatenation:</span><br>    <span class="hljs-comment">#         https://pytorch.org/docs/stable/torch.html#torch.cat</span><br>    <span class="hljs-comment">#     Tensor Stacking:</span><br>    <span class="hljs-comment">#         https://pytorch.org/docs/stable/torch.html#torch.stack</span><br><br>    <span class="hljs-comment"># 1,</span><br>    enc_hiddens_proj = self.att_projection(enc_hiddens) <span class="hljs-comment"># enc_hiddens: (b, l, h * 2)  dot (h * 2, h) -&gt; b, l, h</span><br>    <span class="hljs-comment"># 2,</span><br>    Y = self.model_embeddings.target(target_padded) <span class="hljs-comment"># (tgt_len, b, h)</span><br>    <span class="hljs-comment"># 3,</span><br>    <span class="hljs-keyword">for</span> Y_t <span class="hljs-keyword">in</span> torch.split(Y, <span class="hljs-number">1</span>, dim=<span class="hljs-number">0</span>):<br>        squeezed = torch.squeeze(Y_t) <span class="hljs-comment"># shape (b, e)</span><br>        Ybar_t = torch.cat((squeezed, o_prev), dim=<span class="hljs-number">1</span>) <span class="hljs-comment"># shape (b, e + h)</span><br>        dec_state, o_t, _ = self.step(Ybar_t, dec_state, enc_hiddens, enc_hiddens_proj, enc_masks)<br>        combined_outputs.append(o_t)<br>        o_prev = o_t<br>    <span class="hljs-comment"># 4,</span><br>    combined_outputs = torch.stack(combined_outputs, dim=<span class="hljs-number">0</span>)<br>    <span class="hljs-comment"># END YOUR CODE</span><br><br>    <span class="hljs-keyword">return</span> combined_outputs<br></code></pre></div></td></tr></table></figure><h3 id="f-step">(f) step</h3><p>Implement the <code>step</code> function in nmt model.py. Thisfunction applies the Decoderâ€™s LSTM cell for a single timestep,computing the encoding of the target word h dec t , the attention scoreset, attention distribution Î±t, the attention output at, and finally thecombined output ot. You can run a non-comprehensive sanity check byexecuting:<code>python sanity_check.py 1f</code></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">self, Ybar_t: torch.Tensor,</span><br><span class="hljs-params">        dec_state: <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor],</span><br><span class="hljs-params">        enc_hiddens: torch.Tensor,</span><br><span class="hljs-params">        enc_hiddens_proj: torch.Tensor,</span><br><span class="hljs-params">        enc_masks: torch.Tensor</span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-type">Tuple</span>, torch.Tensor, torch.Tensor]:<br>    <span class="hljs-string">&quot;&quot;&quot; Compute one forward step of the LSTM decoder, including the attention computation.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    @param Ybar_t (Tensor): Concatenated Tensor of [Y_t o_prev], with shape (b, e + h). The input for the decoder,</span><br><span class="hljs-string">                            where b = batch size, e = embedding size, h = hidden size.</span><br><span class="hljs-string">    @param dec_state (tuple(Tensor, Tensor)): Tuple of tensors both with shape (b, h), where b = batch size, h = hidden size.</span><br><span class="hljs-string">            First tensor is decoder&#x27;s prev hidden state, second tensor is decoder&#x27;s prev cell.</span><br><span class="hljs-string">    @param enc_hiddens (Tensor): Encoder hidden states Tensor, with shape (b, src_len, h * 2), where b = batch size,</span><br><span class="hljs-string">                                src_len = maximum source length, h = hidden size.</span><br><span class="hljs-string">    @param enc_hiddens_proj (Tensor): Encoder hidden states Tensor, projected from (h * 2) to h. Tensor is with shape (b, src_len, h),</span><br><span class="hljs-string">                                where b = batch size, src_len = maximum source length, h = hidden size.</span><br><span class="hljs-string">    @param enc_masks (Tensor): Tensor of sentence masks shape (b, src_len),</span><br><span class="hljs-string">                                where b = batch size, src_len is maximum source length. </span><br><span class="hljs-string"></span><br><span class="hljs-string">    @returns dec_state (tuple (Tensor, Tensor)): Tuple of tensors both shape (b, h), where b = batch size, h = hidden size.</span><br><span class="hljs-string">            First tensor is decoder&#x27;s new hidden state, second tensor is decoder&#x27;s new cell.</span><br><span class="hljs-string">    @returns combined_output (Tensor): Combined output Tensor at timestep t, shape (b, h), where b = batch size, h = hidden size.</span><br><span class="hljs-string">    @returns e_t (Tensor): Tensor of shape (b, src_len). It is attention scores distribution.</span><br><span class="hljs-string">                            Note: You will not use this outside of this function.</span><br><span class="hljs-string">                                  We are simply returning this value so that we can sanity check</span><br><span class="hljs-string">                                  your implementation.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    combined_output = <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># YOUR CODE HERE (~3 Lines)</span><br>    <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span></span><br>    <span class="hljs-comment">#     1. Apply the decoder to `Ybar_t` and `dec_state`to obtain the new dec_state.</span><br>    <span class="hljs-comment">#     2. Split dec_state into its two parts (dec_hidden, dec_cell)</span><br>    <span class="hljs-comment">#     3. Compute the attention scores e_t, a Tensor shape (b, src_len).</span><br>    <span class="hljs-comment">#        Note: b = batch_size, src_len = maximum source length, h = hidden size.</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment">#       Hints:</span><br>    <span class="hljs-comment">#         - dec_hidden is shape (b, h) and corresponds to h^dec_t in the PDF (batched)</span><br>    <span class="hljs-comment">#         - enc_hiddens_proj is shape (b, src_len, h) and corresponds to W_&#123;attProj&#125; h^enc (batched).</span><br>    <span class="hljs-comment">#         - Use batched matrix multiplication (torch.bmm) to compute e_t.</span><br>    <span class="hljs-comment">#         - To get the tensors into the right shapes for bmm, you will need to do some squeezing and unsqueezing.</span><br>    <span class="hljs-comment">#         - When using the squeeze() function make sure to specify the dimension you want to squeeze</span><br>    <span class="hljs-comment">#             over. Otherwise, you will remove the batch dimension accidentally, if batch_size = 1.</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># Use the following docs to implement this functionality:</span><br>    <span class="hljs-comment">#     Batch Multiplication:</span><br>    <span class="hljs-comment">#        https://pytorch.org/docs/stable/torch.html#torch.bmm</span><br>    <span class="hljs-comment">#     Tensor Unsqueeze:</span><br>    <span class="hljs-comment">#         https://pytorch.org/docs/stable/torch.html#torch.unsqueeze</span><br>    <span class="hljs-comment">#     Tensor Squeeze:</span><br>    <span class="hljs-comment">#         https://pytorch.org/docs/stable/torch.html#torch.squeeze</span><br><br>    <span class="hljs-comment"># 1,</span><br>    dec_state = self.decoder(Ybar_t, dec_state)<br>    (dec_hidden, dec_cell) = dec_state<br>    <span class="hljs-comment"># 3, (b, src_len, h) .dot(b, h, 1) -&gt; (b, src_len, 1) -&gt; (b, src_len)</span><br>    e_t = enc_hiddens_proj.bmm(dec_hidden.unsqueeze(<span class="hljs-number">2</span>)).squeeze(<span class="hljs-number">2</span>)<br>    <span class="hljs-comment">### END YOUR CODE</span><br><br>    <span class="hljs-comment"># Set e_t to -inf where enc_masks has 1</span><br>    <span class="hljs-keyword">if</span> enc_masks <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        e_t.data.masked_fill_(enc_masks.byte(), -<span class="hljs-built_in">float</span>(<span class="hljs-string">&#x27;inf&#x27;</span>)) <span class="hljs-comment"># mask the 0s with -inf, so e^x = 0</span><br><br>    <span class="hljs-comment"># YOUR CODE HERE (~6 Lines)</span><br>    <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span></span><br>    <span class="hljs-comment">#     1. Apply softmax to e_t to yield alpha_t</span><br>    <span class="hljs-comment">#     2. Use batched matrix multiplication between alpha_t and enc_hiddens to obtain the</span><br>    <span class="hljs-comment">#         attention output vector, a_t.</span><br>    <span class="hljs-comment">#     Hints:</span><br>    <span class="hljs-comment">#           - alpha_t is shape (b, src_len)</span><br>    <span class="hljs-comment">#           - enc_hiddens is shape (b, src_len, 2h)</span><br>    <span class="hljs-comment">#           - a_t should be shape (b, 2h)</span><br>    <span class="hljs-comment">#           - You will need to do some squeezing and unsqueezing.</span><br>    <span class="hljs-comment">#     Note: b = batch size, src_len = maximum source length, h = hidden size.</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment">#     3. Concatenate dec_hidden with a_t to compute tensor U_t</span><br>    <span class="hljs-comment">#     4. Apply the combined output projection layer to U_t to compute tensor V_t</span><br>    <span class="hljs-comment">#     5. Compute tensor O_t by first applying the Tanh function and then the dropout layer.</span><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># Use the following docs to implement this functionality:</span><br>    <span class="hljs-comment">#     Softmax:</span><br>    <span class="hljs-comment">#         https://pytorch.org/docs/stable/nn.html#torch.nn.functional.softmax</span><br>    <span class="hljs-comment">#     Batch Multiplication:</span><br>    <span class="hljs-comment">#        https://pytorch.org/docs/stable/torch.html#torch.bmm</span><br>    <span class="hljs-comment">#     Tensor View:</span><br>    <span class="hljs-comment">#         https://pytorch.org/docs/stable/tensors.html#torch.Tensor.view</span><br>    <span class="hljs-comment">#     Tensor Concatenation:</span><br>    <span class="hljs-comment">#         https://pytorch.org/docs/stable/torch.html#torch.cat</span><br>    <span class="hljs-comment">#     Tanh:</span><br>    <span class="hljs-comment">#         https://pytorch.org/docs/stable/torch.html#torch.tanh</span><br><br>    <span class="hljs-comment"># 1, apply softmax to e_t</span><br>    alpha_t = F.softmax(e_t, dim=<span class="hljs-number">1</span>) <span class="hljs-comment"># (b, src_len)</span><br>    <span class="hljs-comment"># 2, (b, 1, src_len) x (b, src_len, 2h) = (b, 1, 2h) -&gt; (b, 2h)</span><br>    <span class="hljs-comment"># a_t = e_t.unsqueeze(1).bmm(enc_hiddens).squeeze(1)</span><br>    att_view = (alpha_t.size(<span class="hljs-number">0</span>), <span class="hljs-number">1</span>, alpha_t.size(<span class="hljs-number">1</span>))<br>    a_t = torch.bmm(alpha_t.view(*att_view), enc_hiddens).squeeze(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 3, concate a_t (b, 2h) and dec_hidden (b, h) to U_t (b, 3h)</span><br>    U_t = torch.cat((a_t, dec_hidden), dim=<span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># 4, apply combined output to U_T -&gt; V_t, shape (b, h)</span><br>    V_t = self.combined_output_projection(U_t)<br>    O_t = self.dropout(torch.tanh(V_t))<br><br>    <span class="hljs-comment"># END YOUR CODE</span><br><br>    combined_output = O_t<br>    <span class="hljs-keyword">return</span> dec_state, combined_output, e_t<br></code></pre></div></td></tr></table></figure><h3 id="g-generate_sent_masks">(g) generate_sent_masks</h3><p>The generate sent masks() function in nmt model.py produces a tensorcalled enc masks. It has shape (batch size, max source sentence length)and contains 1s in positions corresponding to â€˜padâ€™ tokens in the input,and 0s for non-pad tokens. Look at how the masks are used during theattention computation in the step() function (lines 295-296). Firstexplain (in around three sentences) what effect the masks have on theentire attention computation. Then explain (in one or two sentences) whyit is necessary to use the masks in this way.</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_sent_masks</span>(<span class="hljs-params">self, enc_hiddens: torch.Tensor, source_lengths: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; torch.Tensor:<br>    <span class="hljs-string">&quot;&quot;&quot; Generate sentence masks for encoder hidden states.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    @param enc_hiddens (Tensor): encodings of shape (b, src_len, 2*h), where b = batch size,</span><br><span class="hljs-string">                                 src_len = max source length, h = hidden size. </span><br><span class="hljs-string">    @param source_lengths (List[int]): List of actual lengths for each of the sentences in the batch.</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    @returns enc_masks (Tensor): Tensor of sentence masks of shape (b, src_len),</span><br><span class="hljs-string">                                where src_len = max source length, h = hidden size.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    enc_masks = torch.zeros(enc_hiddens.size(<span class="hljs-number">0</span>), enc_hiddens.size(<span class="hljs-number">1</span>), dtype=torch.<span class="hljs-built_in">float</span>)<br>    <span class="hljs-keyword">for</span> e_id, src_len <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(source_lengths):<br>        enc_masks[e_id, src_len:] = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> enc_masks.to(self.device)<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬å…«è®²-æœºå™¨ç¿»è¯‘ã€seq2seqä¸æ³¨æ„åŠ›æœºåˆ¶</title>
    <link href="/2022/05/14/%E7%AC%AC%E5%85%AB%E8%AE%B2-%E6%9C%BA%E5%99%A8%E7%BF%BB%E8%AF%91%E3%80%81seq2seq%E4%B8%8E%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6/"/>
    <url>/2022/05/14/%E7%AC%AC%E5%85%AB%E8%AE%B2-%E6%9C%BA%E5%99%A8%E7%BF%BB%E8%AF%91%E3%80%81seq2seq%E4%B8%8E%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="æœºå™¨ç¿»è¯‘ä¸smtç»Ÿè®¡æœºå™¨ç¿»è¯‘">1.æœºå™¨ç¿»è¯‘ä¸SMTï¼ˆç»Ÿè®¡æœºå™¨ç¿»è¯‘ï¼‰</h1><h2 id="æœºå™¨ç¿»è¯‘">1.1 æœºå™¨ç¿»è¯‘</h2><p>æœºå™¨ç¿»è¯‘(MT)æ˜¯å°†ä¸€ä¸ªå¥å­<spanclass="math inline">\(x\)</span>ä»ä¸€ç§è¯­è¨€(<strong>æºè¯­è¨€</strong>)è½¬æ¢ä¸ºå¦ä¸€ç§è¯­è¨€(<strong>ç›®æ ‡è¯­è¨€</strong>)çš„å¥å­<spanclass="math inline">\(y\)</span>çš„ä»»åŠ¡ã€‚</p><h2 id="sæ—©æœŸæœºå™¨ç¿»è¯‘">1.2 1950sï¼šæ—©æœŸæœºå™¨ç¿»è¯‘</h2><p>æœºå™¨ç¿»è¯‘ç ”ç©¶å§‹äº20ä¸–çºª50å¹´ä»£åˆã€‚</p><ul><li>ä¿„è¯­ â†’ è‹±è¯­(å†·æˆ˜çš„æ¨åŠ¨)</li><li>ç³»ç»Ÿä¸»è¦æ˜¯<strong>åŸºäºè§„åˆ™</strong>çš„ï¼Œä½¿ç”¨åŒè¯­è¯å…¸æ¥è®²ä¿„è¯­å•è¯æ˜ å°„ä¸ºå¯¹åº”çš„è‹±è¯­éƒ¨åˆ†</li></ul><h2 id="s-2010sç»Ÿè®¡æœºå™¨ç¿»è¯‘">1.3 1990s-2010sï¼šç»Ÿè®¡æœºå™¨ç¿»è¯‘</h2><p><strong>æ ¸å¿ƒæƒ³æ³•</strong>ï¼šä»<strong>æ•°æ®</strong>ä¸­å­¦ä¹ <strong>æ¦‚ç‡æ¨¡å‹</strong></p><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨ç¿»è¯‘æ³•è¯­ â†’ è‹±è¯­ï¼Œå¯¹äºç»™å®šæ³•è¯­å¥å­<spanclass="math inline">\(x\)</span>ï¼Œæˆ‘ä»¬æƒ³è¦æ‰¾åˆ°<strong>æœ€å¥½çš„è‹±è¯­å¥å­</strong><spanclass="math inline">\(y\  argmax_yP(y|x)\)</span>ï¼Œä½¿ç”¨Bayesè§„åˆ™å°†å…¶åˆ†è§£ä¸º<strong>ä¸¤ä¸ªç»„ä»¶</strong>ä»è€Œåˆ†åˆ«å­¦ä¹ <span class="math display">\[argmaxx_yP(x|y)P(y)\]</span></p><ul><li><span class="math inline">\(P(x|y)\)</span>ï¼š<strong>TranslationModel / ç¿»è¯‘æ¨¡å‹</strong><ul><li>åˆ†æå•è¯å’ŒçŸ­è¯­åº”è¯¥å¦‚ä½•ç¿»è¯‘(é€¼çœŸ)</li><li>ä»å¹¶è¡Œæ•°æ®ä¸­å­¦ä¹ </li></ul></li><li><span class="math inline">\(P(y)\)</span>ï¼š<strong>Language Model /è¯­è¨€æ¨¡å‹</strong><ul><li>æ¨¡å‹å¦‚ä½•å†™å‡ºå¥½è‹±è¯­(æµåˆ©)</li><li>ä»å•è¯­æ•°æ®ä¸­å­¦ä¹ </li></ul></li></ul><h2 id="s-2010sç»Ÿè®¡æœºå™¨ç¿»è¯‘-1">1.4 1990s-2010sï¼šç»Ÿè®¡æœºå™¨ç¿»è¯‘</h2><p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•å­¦ä¹ ç¿»è¯‘æ¨¡å‹<spanclass="math inline">\(P(x|y)\)</span>ï¼Ÿ</p><p>é¦–å…ˆï¼Œéœ€è¦å¤§é‡çš„<strong>å¹¶è¡Œæ•°æ®</strong>(ä¾‹å¦‚æˆå¯¹çš„äººå·¥ç¿»è¯‘çš„æ³•è¯­/è‹±è¯­å¥å­)</p><h2 id="smtçš„å­¦ä¹ å¯¹é½">1.5SMTçš„å­¦ä¹ å¯¹é½</h2><p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•ä»å¹¶è¡Œè¯­æ–™åº“ä¸­å­¦ä¹ ç¿»è¯‘æ¨¡å‹<spanclass="math inline">\(P(x|y)\)</span>ï¼Ÿ</p><p>è¿›ä¸€æ­¥åˆ†è§£ï¼šæˆ‘ä»¬å®é™…ä¸Šæƒ³è¦è€ƒè™‘</p><p><span class="math display">\[P(x,a|y)\]</span></p><ul><li><span class="math inline">\(a\)</span>æ˜¯å¯¹é½</li><li>å³æ³•è¯­å¥å­<span class="math inline">\(x\)</span>å’Œè‹±è¯­å¥å­<spanclass="math inline">\(y\)</span>ä¹‹é—´çš„å•è¯çº§å¯¹åº”</li></ul><h2 id="å¯¹é½">1.6 å¯¹é½</h2><p>å¯¹é½æ˜¯ç¿»è¯‘å¥å­ä¸­ç‰¹å®šè¯è¯­ä¹‹é—´çš„å¯¹åº”å…³ç³»</p><ul><li>æ³¨æ„ï¼šæœ‰äº›è¯æ²¡æœ‰å¯¹åº”è¯</li></ul><p><img src="/img/nlp/ç¬¬å…«è®²/1.png" /></p><h2 id="å¯¹é½æ˜¯å¤æ‚çš„">1.7 å¯¹é½æ˜¯å¤æ‚çš„</h2><p>å¯¹é½å¯ä»¥æ˜¯å¤šå¯¹ä¸€çš„</p><p><img src="/img/nlp/ç¬¬å…«è®²/2.png" /></p><p>å¯¹é½å¯ä»¥æ˜¯ä¸€å¯¹å¤šçš„</p><p><img src="/img/nlp/ç¬¬å…«è®²/3.png" /></p><p>æœ‰äº›è¯å¾ˆä¸°å¯Œ</p><p>å¯¹é½å¯ä»¥æ˜¯<strong>å¤šå¯¹å¤š</strong>(çŸ­è¯­çº§)</p><p>æˆ‘ä»¬å­¦ä¹ å¾ˆå¤šå› ç´ çš„ç»„åˆï¼ŒåŒ…æ‹¬</p><ul><li>ç‰¹å®šå•è¯å¯¹é½çš„æ¦‚ç‡(ä¹Ÿå–å†³äºå‘é€ä½ç½®)</li><li>ç‰¹å®šå•è¯å…·æœ‰ç‰¹å®šå¤šè¯å¯¹åº”çš„æ¦‚ç‡(å¯¹åº”å•è¯çš„æ•°é‡)</li></ul><h2 id="smtçš„å­¦ä¹ å¯¹é½-1">1.8 SMTçš„å­¦ä¹ å¯¹é½</h2><ul><li>é—®é¢˜ï¼šå¦‚ä½•è®¡ç®—argmax<ul><li>æˆ‘ä»¬å¯ä»¥åˆ—ä¸¾æ‰€æœ‰å¯èƒ½çš„<spanclass="math inline">\(y\)</span>å¹¶è®¡ç®—æ¦‚ç‡ï¼Ÿâ†’ è®¡ç®—æˆæœ¬å¤ªé«˜</li></ul></li><li>å›ç­”ï¼šä½¿ç”¨å¯å‘å¼æœç´¢ç®—æ³•æœç´¢æœ€ä½³ç¿»è¯‘ï¼Œä¸¢å¼ƒæ¦‚ç‡è¿‡ä½çš„å‡è®¾<ul><li>è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º<strong>è§£ç </strong></li></ul></li></ul><h2 id="smtè§£ç ">1.9 SMTè§£ç </h2><p><img src="/img/nlp/ç¬¬å…«è®²/4.png" /></p><p><img src="/img/nlp/ç¬¬å…«è®²/5.png" /></p><h2 id="s-2010sç»Ÿè®¡æœºå™¨ç¿»è¯‘-2">1.10 1990s-2010sï¼šç»Ÿè®¡æœºå™¨ç¿»è¯‘</h2><p>SMTæ˜¯ä¸€ä¸ª<strong>å·¨å¤§çš„ç ”ç©¶é¢†åŸŸ</strong></p><p>æœ€å¥½çš„ç³»ç»Ÿéå¸¸å¤æ‚</p><ul><li>æ•°ä»¥ç™¾è®¡çš„é‡è¦ç»†èŠ‚æˆ‘ä»¬è¿˜æ²¡æœ‰æåˆ°</li><li>ç³»ç»Ÿæœ‰è®¸å¤š<strong>ç‹¬ç«‹è®¾è®¡å­ç»„ä»¶å·¥ç¨‹</strong></li><li>å¤§é‡ç‰¹å¾å·¥ç¨‹<ul><li>å¾ˆå¤šåŠŸèƒ½éœ€è¦è®¾è®¡ç‰¹æ€§æ¥è·å–ç‰¹å®šçš„è¯­è¨€ç°è±¡</li></ul></li><li>éœ€è¦ç¼–è¯‘å’Œç»´æŠ¤é¢å¤–çš„èµ„æº<ul><li>æ¯”å¦‚åŒè¯­çŸ­è¯­å¯¹åº”è¡¨</li></ul></li><li>éœ€è¦å¤§é‡çš„äººåŠ›æ¥ç»´æŠ¤<ul><li>å¯¹äºæ¯ä¸€å¯¹è¯­è¨€éƒ½éœ€è¦é‡å¤æ“ä½œ</li></ul></li></ul><h1 id="ç¥ç»ç½‘ç»œæœºå™¨ç¿»è¯‘">2.ç¥ç»ç½‘ç»œæœºå™¨ç¿»è¯‘</h1><h2 id="ç¥ç»æœºå™¨ç¿»è¯‘neural-machine-translationnmt">2.1ç¥ç»æœºå™¨ç¿»è¯‘Neural Machine Translation(NMT)</h2><p><strong>ç¥ç»æœºå™¨ç¿»è¯‘</strong>(NMT)æ˜¯åˆ©ç”¨å•ä¸ªç¥ç»ç½‘ç»œè¿›è¡Œæœºå™¨ç¿»è¯‘çš„ä¸€ç§æ–¹æ³•</p><p>ç¥ç»ç½‘ç»œæ¶æ„ç§°ä¸º <strong>sequence-to-sequence</strong>(åˆåseq2seq)ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªRNNs</p><ul><li>ç¼–ç å™¨RNNç”Ÿæˆæºè¯­å¥çš„ç¼–ç </li><li>æºè¯­å¥çš„ç¼–ç ä¸ºè§£ç å™¨RNNæä¾›åˆå§‹éšè—çŠ¶æ€</li><li>è§£ç å™¨RNNæ˜¯ä¸€ç§ä»¥ç¼–ç ä¸ºæ¡ä»¶ç”Ÿæˆç›®æ ‡å¥çš„è¯­è¨€æ¨¡å‹</li><li><strong>æ³¨æ„</strong>ï¼šæ­¤å›¾æ˜¾ç¤ºäº†æµ‹è¯•æ—¶è¡Œä¸º â†’è§£ç å™¨è¾“å‡ºä½œä¸ºä¸‹ä¸€æ­¥çš„è¾“å…¥</li></ul><p><img src="/img/nlp/ç¬¬å…«è®²/6.png" /></p><h2 id="sequence-to-sequenceæ˜¯å¤šåŠŸèƒ½çš„">2.2Sequence-to-sequenceæ˜¯å¤šåŠŸèƒ½çš„ï¼</h2><p>åºåˆ—åˆ°åºåˆ—ä¸ä»…ä»…å¯¹æœºå™¨ç¿»è¯‘æœ‰ç”¨</p><p>è®¸å¤šNLPä»»åŠ¡å¯ä»¥æŒ‰ç…§é¡ºåºè¿›è¡Œè¡¨è¾¾</p><ul><li><strong>æ‘˜è¦</strong>(é•¿æ–‡æœ¬ â†’ çŸ­æ–‡æœ¬)</li><li><strong>å¯¹è¯</strong>(å‰ä¸€å¥è¯ â†’ ä¸‹ä¸€å¥è¯)</li><li><strong>è§£æ</strong>(è¾“å…¥æ–‡æœ¬ â†’ è¾“å‡ºè§£æä¸ºåºåˆ—)</li><li><strong>ä»£ç ç”Ÿæˆ</strong>(è‡ªç„¶è¯­è¨€ â†’ Pythonä»£ç )</li></ul><h2 id="ç¥ç»æœºå™¨ç¿»è¯‘nmt">2.3 ç¥ç»æœºå™¨ç¿»è¯‘(NMT)</h2><p><strong>sequence-to-sequence</strong>æ¨¡å‹æ˜¯æ¡ä»¶è¯­è¨€æ¨¡å‹çš„ä¸€ä¸ªä¾‹å­</p><ul><li>è¯­è¨€æ¨¡å‹(Language Model)ï¼Œå› ä¸ºè§£ç å™¨æ­£åœ¨é¢„æµ‹ç›®æ ‡å¥çš„ä¸‹ä¸€ä¸ªå•è¯<spanclass="math inline">\(y\)</span></li><li>æ¡ä»¶çº¦æŸçš„(Conditional)ï¼Œå› ä¸ºé¢„æµ‹ä¹Ÿå–å†³äºæºå¥<spanclass="math inline">\(x\)</span></li></ul><p>NMTç›´æ¥è®¡ç®—<span class="math inline">\(P(y|x)\)</span>ï¼š <spanclass="math display">\[P(y \mid x)=P\left(y_{1} \mid x\right) P\left(y_{2} \mid y_{1}, x\right)P\left(y_{3} \mid y_{1}, y_{2}, x\right) \ldots P\left(y_{T} \mid y_{1},\ldots, y_{T-1}, x\right)\]</span></p><ul><li>ä¸Šå¼ä¸­æœ€åä¸€é¡¹ä¸ºï¼Œç»™å®šåˆ°ç›®å‰ä¸ºæ­¢çš„ç›®æ ‡è¯å’Œæºå¥<spanclass="math inline">\(x\)</span>ï¼Œä¸‹ä¸€ä¸ªç›®æ ‡è¯çš„æ¦‚ç‡</li></ul><p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•è®­ç»ƒNMTç³»ç»Ÿï¼Ÿ</p><p><strong>å›ç­”</strong>ï¼šæ‰¾ä¸€ä¸ªå¤§çš„å¹³è¡Œè¯­æ–™åº“</p><h2 id="è®­ç»ƒä¸€ä¸ªæœºå™¨ç¿»è¯‘ç³»ç»Ÿ">2.4 è®­ç»ƒä¸€ä¸ªæœºå™¨ç¿»è¯‘ç³»ç»Ÿ</h2><p>Seq2seqè¢«ä¼˜åŒ–ä¸ºä¸€ä¸ªå•ä¸€çš„ç³»ç»Ÿã€‚åå‘ä¼ æ’­è¿è¡Œåœ¨â€œç«¯åˆ°ç«¯â€ä¸­</p><p><img src="/img/nlp/ç¬¬å…«è®²/7.png" /></p><h1 id="æœºå™¨ç¿»è¯‘è§£ç ">3.æœºå™¨ç¿»è¯‘è§£ç </h1><h2 id="è´ªå©ªè§£ç ">3.1 è´ªå©ªè§£ç </h2><p>æˆ‘ä»¬äº†è§£äº†å¦‚ä½•ç”Ÿæˆ(æˆ–â€œè§£ç â€)ç›®æ ‡å¥ï¼Œé€šè¿‡å¯¹è§£ç å™¨çš„æ¯ä¸ªæ­¥éª¤ä½¿ç”¨argmax</p><p>è¿™æ˜¯<strong>è´ªå©ªè§£ç </strong>(æ¯ä¸€æ­¥éƒ½å–æœ€å¯èƒ½çš„å•è¯)</p><p><strong>è¿™ç§æ–¹æ³•æœ‰é—®é¢˜å—</strong>ï¼Ÿ</p><p><img src="/img/nlp/ç¬¬å…«è®²/8.png" /></p><h2 id="è´ªå©ªè§£ç çš„é—®é¢˜">3.2 è´ªå©ªè§£ç çš„é—®é¢˜</h2><p>è´ªå©ªè§£ç æ²¡æœ‰åŠæ³•æ’¤é”€å†³å®š</p><p><img src="/img/nlp/ç¬¬å…«è®²/9.png" /></p><p>å¦‚ä½•ä¿®å¤ï¼Ÿ</p><h2 id="ç©·ä¸¾æœç´¢è§£ç ">3.3 ç©·ä¸¾æœç´¢è§£ç </h2><p>ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æƒ³è¦æ‰¾åˆ°ä¸€ä¸ª(é•¿åº¦ä¸º<spanclass="math inline">\(T\)</span>)çš„ç¿»è¯‘<spanclass="math inline">\(y\)</span>ä½¿å…¶æœ€å¤§åŒ– <span class="math display">\[\begin{aligned}P(y \mid x) &amp;=P\left(y_{1} \mid x\right) P\left(y_{2} \mid y_{1},x\right) P\left(y_{3} \mid y_{1}, y_{2}, x\right) \ldots, P\left(y_{T}\mid y_{1}, \ldots, y_{T-1}, x\right) \\&amp;=\prod_{t=1}^{T} P\left(y_{t} \mid y_{1}, \ldots, y_{t-1}, x\right)\end{aligned}\]</span></p><p>æˆ‘ä»¬å¯ä»¥å°è¯•è®¡ç®—æ‰€æœ‰å¯èƒ½çš„åºåˆ— - è¿™æ„å‘³ç€åœ¨è§£ç å™¨çš„æ¯ä¸€æ­¥<spanclass="math inline">\(t\)</span>ï¼Œæˆ‘ä»¬è·Ÿè¸ª<spanclass="math inline">\(V^t\)</span>ä¸ªå¯èƒ½çš„éƒ¨åˆ†ç¿»è¯‘ï¼Œå…¶ä¸­<spanclass="math inline">\(V\)</span>æ˜¯vocab å¤§å° - è¿™ç§<spanclass="math inline">\(O(V^t)\)</span>çš„å¤æ‚æ€§<strong>å¤ªæ˜‚è´µ</strong>äº†ï¼</p><h2 id="é›†æŸæœç´¢è§£ç ">3.4 é›†æŸæœç´¢è§£ç </h2><ul><li>æ ¸å¿ƒæ€æƒ³ï¼šåœ¨è§£ç å™¨çš„æ¯ä¸€æ­¥ï¼Œè·Ÿè¸ªä¸ªæœ€å¯èƒ½çš„éƒ¨åˆ†ç¿»è¯‘(æˆ‘ä»¬ç§°ä¹‹ä¸ºå‡è®¾[hypotheses] )<ul><li><spanclass="math inline">\(k\)</span>æ˜¯Beamçš„å¤§å°(å®é™…ä¸­å¤§çº¦æ˜¯5åˆ°10)</li></ul></li><li>å‡è®¾<spanclass="math inline">\(y_1,y_2,...,y_t\)</span>æœ‰ä¸€ä¸ª<strong>åˆ†æ•°</strong>ï¼Œå³å®ƒçš„å¯¹æ•°æ¦‚ç‡</li></ul><p><span class="math display">\[\operatorname{score}\left(y_{1}, \ldots, y_{t}\right)=\logP_{\mathrm{LM}}\left(y_{1}, \ldots, y_{t} \mid x\right)=\sum_{i=1}^{t}\log P_{\mathrm{LM}}\left(y_{i} \mid y_{1}, \ldots, y_{i-1}, x\right)\]</span></p><ul><li><p>åˆ†æ•°éƒ½æ˜¯è´Ÿæ•°ï¼Œåˆ†æ•°è¶Šé«˜è¶Šå¥½</p></li><li><p>æˆ‘ä»¬å¯»æ‰¾å¾—åˆ†è¾ƒé«˜çš„å‡è®¾ï¼Œè·Ÿè¸ªæ¯ä¸€æ­¥çš„ top k ä¸ªéƒ¨åˆ†ç¿»è¯‘</p></li><li><p>æ³¢æŸæœç´¢ <strong>ä¸ä¸€å®šèƒ½</strong> æ‰¾åˆ°æœ€ä¼˜è§£</p></li><li><p>ä½†æ¯”ç©·ä¸¾æœç´¢<strong>æ•ˆç‡é«˜å¾—å¤š</strong></p></li></ul><h2 id="é›†æŸæœç´¢è§£ç ç¤ºä¾‹">3.5 é›†æŸæœç´¢è§£ç ï¼šç¤ºä¾‹</h2><p>Beam size = k = 2ï¼Œè“è‰²çš„æ•°å­—æ˜¯ <span class="math display">\[\operatorname{score}\left(y_{1}, \ldots, y_{t}\right)=\sum_{i=1}^{t}\log P_{\mathrm{LM}}\left(y_{i} \mid y_{1}, \ldots, y_{i-1}, x\right)\]</span> <img src="/img/nlp/ç¬¬å…«è®²/10.png" /></p><ul><li>è®¡ç®—ä¸‹ä¸€ä¸ªå•è¯çš„æ¦‚ç‡åˆ†å¸ƒ</li><li>å–å‰ä¸ªå•è¯å¹¶è®¡ç®—åˆ†æ•°<ul><li>å¯¹äºæ¯ä¸€æ¬¡çš„<spanclass="math inline">\(k\)</span>ä¸ªå‡è®¾ï¼Œæ‰¾å‡ºæœ€å‰é¢çš„<spanclass="math inline">\(k\)</span>ä¸ªå•è¯å¹¶è®¡ç®—åˆ†æ•°</li><li>åœ¨çš„å‡è®¾ä¸­ï¼Œä¿ç•™ä¸ªæœ€é«˜çš„åˆ†å€¼<ul><li><span class="math inline">\(t=2\)</span>æ—¶ï¼Œä¿ç•™åˆ†æ•°æœ€é«˜çš„<code>hit</code> å’Œ <code>was</code></li><li><span class="math inline">\(t=3\)</span>æ—¶ï¼Œä¿ç•™åˆ†æ•°æœ€é«˜çš„<code>a</code> å’Œ <code>me</code></li><li><span class="math inline">\(t=4\)</span>æ—¶ï¼Œä¿ç•™åˆ†æ•°æœ€é«˜çš„<code>pie</code> å’Œ <code>with</code></li><li><span class="math inline">\(t=5\)</span>æ—¶ï¼Œä¿ç•™åˆ†æ•°æœ€é«˜çš„<code>a</code> å’Œ <code>one</code></li><li><span class="math inline">\(t=6\)</span>æ—¶ï¼Œä¿ç•™åˆ†æ•°æœ€é«˜çš„<code>pie</code></li></ul></li></ul></li><li>è¿™æ˜¯æœ€é«˜å¾—åˆ†çš„å‡è®¾</li><li>å›æº¯ä»¥è·å¾—å®Œæ•´çš„å‡è®¾</li></ul><h2 id="é›†æŸæœç´¢è§£ç åœæ­¢åˆ¤æ®">3.6 é›†æŸæœç´¢è§£ç ï¼šåœæ­¢åˆ¤æ®</h2><ul><li>åœ¨è´ªå¿ƒè§£ç ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸è§£ç åˆ°æ¨¡å‹äº§ç”Ÿä¸€ä¸ªä»¤ç‰Œ<ul><li>ä¾‹å¦‚ï¼š he hit me with a pie</li></ul></li><li>åœ¨é›†æŸæœç´¢è§£ç ä¸­ï¼Œä¸åŒçš„å‡è®¾å¯èƒ½åœ¨<strong>ä¸åŒçš„æ—¶é—´æ­¥é•¿</strong>ä¸Šäº§ç”Ÿä»¤ç‰Œ<ul><li>å½“ä¸€ä¸ªå‡è®¾ç”Ÿæˆäº†ä»¤ç‰Œï¼Œè¯¥å‡è®¾<strong>å®Œæˆ</strong></li><li><strong>æŠŠå®ƒæ”¾åœ¨ä¸€è¾¹</strong>ï¼Œé€šè¿‡ Beam Searchç»§ç»­æ¢ç´¢å…¶ä»–å‡è®¾</li></ul></li><li>é€šå¸¸æˆ‘ä»¬ç»§ç»­è¿›è¡Œ Beam Search ï¼Œç›´åˆ°<ul><li>æˆ‘ä»¬åˆ°è¾¾æ—¶é—´æ­¥é•¿<span class="math inline">\(T\)</span>(å…¶ä¸­<spanclass="math inline">\(T\)</span>æ˜¯é¢„å®šä¹‰æˆªæ­¢ç‚¹)</li><li>æˆ‘ä»¬è‡³å°‘æœ‰<spanclass="math inline">\(n\)</span>ä¸ªå·²å®Œæˆçš„å‡è®¾(å…¶ä¸­<spanclass="math inline">\(n\)</span>æ˜¯é¢„å®šä¹‰æˆªæ­¢ç‚¹)</li></ul></li></ul><h2 id="é›†æŸæœç´¢è§£ç å®Œæˆ">3.7 é›†æŸæœç´¢è§£ç ï¼šå®Œæˆ</h2><p>æˆ‘ä»¬æœ‰å®Œæ•´çš„å‡è®¾åˆ—è¡¨,å¦‚ä½•é€‰æ‹©å¾—åˆ†æœ€é«˜çš„ï¼Ÿ</p><p>æˆ‘ä»¬æ¸…å•ä¸Šçš„æ¯ä¸ªå‡è®¾<spanclass="math inline">\(y_1,...,y_t\)</span>éƒ½æœ‰ä¸€ä¸ªåˆ†æ•° <spanclass="math display">\[\operatorname{score}\left(y_{1}, \ldots, y_{t}\right)=\logP_{\mathrm{LM}}\left(y_{1}, \ldots, y_{t} \mid x\right)=\sum_{i=1}^{t}\log P_{\mathrm{LM}}\left(y_{i} \mid y_{1}, \ldots, y_{i-1}, x\right)\]</span> <strong>é—®é¢˜åœ¨äº</strong> ï¼šè¾ƒé•¿çš„å‡è®¾å¾—åˆ†è¾ƒä½</p><p><strong>ä¿®æ­£</strong>ï¼šæŒ‰é•¿åº¦æ ‡å‡†åŒ–ã€‚ç”¨ä¸‹å¼æ¥é€‰æ‹©top one <spanclass="math display">\[\frac{1}{t} \sum_{i=1}^{t} \log P_{\mathrm{LM}}\left(y_{i} \mid y_{1},\ldots, y_{i-1}, x\right)\]</span></p><h2 id="ç¥ç»æœºå™¨ç¿»è¯‘nmtçš„ä¼˜ç‚¹">3.8 ç¥ç»æœºå™¨ç¿»è¯‘(NMT)çš„ä¼˜ç‚¹</h2><p>ä¸SMTç›¸æ¯”ï¼ŒNMTæœ‰å¾ˆå¤š<strong>ä¼˜ç‚¹</strong></p><p>æ›´å¥½çš„æ€§èƒ½</p><ul><li>æ›´æµåˆ©</li><li>æ›´å¥½åœ°ä½¿ç”¨ä¸Šä¸‹æ–‡</li><li>æ›´å¥½åœ°ä½¿ç”¨çŸ­è¯­ç›¸ä¼¼æ€§</li></ul><p>å•ä¸ªç¥ç»ç½‘ç»œç«¯åˆ°ç«¯ä¼˜åŒ–</p><ul><li>æ²¡æœ‰å­ç»„ä»¶éœ€è¦å•ç‹¬ä¼˜åŒ–</li></ul><p>éœ€è¦æ›´å°‘çš„äººç±»å·¥ç¨‹ä»˜å‡º</p><ul><li>æ— ç‰¹å¾å·¥ç¨‹</li><li>æ‰€æœ‰è¯­è¨€å¯¹çš„æ–¹æ³•ç›¸åŒ</li></ul><h2 id="ç¥ç»æœºå™¨ç¿»è¯‘nmtçš„ç¼ºç‚¹">3.9 ç¥ç»æœºå™¨ç¿»è¯‘(NMT)çš„ç¼ºç‚¹</h2><p>SMTç›¸æ¯”ï¼ŒNMTçš„<strong>ç¼ºç‚¹</strong></p><p>NMTçš„å¯è§£é‡Šæ€§è¾ƒå·®</p><ul><li>éš¾ä»¥è°ƒè¯•</li></ul><p>NMTå¾ˆéš¾æ§åˆ¶</p><ul><li>ä¾‹å¦‚ï¼Œä¸èƒ½è½»æ¾æŒ‡å®šç¿»è¯‘è§„åˆ™æˆ–æŒ‡å—</li><li>å®‰å…¨é—®é¢˜</li></ul><h1 id="æœºå™¨ç¿»è¯‘è¯„ä¼°">4.æœºå™¨ç¿»è¯‘è¯„ä¼°</h1><h2 id="å¦‚ä½•è¯„ä¼°æœºå™¨ç¿»è¯‘è´¨é‡">4.1 å¦‚ä½•è¯„ä¼°æœºå™¨ç¿»è¯‘è´¨é‡</h2><p>BLEU(Bilingual Evaluation Understudy)</p><ul><li>ä½ å°†ä¼šåœ¨ Assignment 4 ä¸­çœ‹åˆ°BLEUçš„ç»†èŠ‚</li></ul><p>BLEUå°†æœºå™¨ç¿»è¯‘å’Œäººå·¥ç¿»è¯‘(ä¸€ä¸ªæˆ–å¤šä¸ª)ï¼Œå¹¶è®¡ç®—ä¸€ä¸ªç›¸ä¼¼çš„åˆ†æ•°</p><ul><li>n-gram ç²¾åº¦ (né€šå¸¸ä¸º1-4)</li><li>å¯¹è¿‡äºçŸ­çš„æœºå™¨ç¿»è¯‘çš„åŠ ä¸Šæƒ©ç½š</li></ul><p>BLEUå¾ˆæœ‰ç”¨ï¼Œä½†ä¸å®Œç¾</p><ul><li>æœ‰å¾ˆå¤šæœ‰æ•ˆçš„æ–¹æ³•æ¥ç¿»è¯‘ä¸€ä¸ªå¥å­</li><li>æ‰€ä»¥ä¸€ä¸ª<strong>å¥½çš„</strong>ç¿»è¯‘å¯ä»¥å¾—åˆ°ä¸€ä¸ªç³Ÿç³•çš„BLEUscoreï¼Œå› ä¸ºå®ƒä¸äººå·¥ç¿»è¯‘çš„n-gramé‡å è¾ƒä½</li></ul><h2 id="æœºå™¨ç¿»è¯‘é—®é¢˜å®Œç¾è§£å†³äº†å—">4.2 æœºå™¨ç¿»è¯‘é—®é¢˜å®Œç¾è§£å†³äº†å—ï¼Ÿ</h2><p>æ²¡æœ‰ï¼</p><p>è®¸å¤šå›°éš¾ä»ç„¶å­˜åœ¨</p><ul><li><strong>è¯è¡¨å¤–</strong>çš„å•è¯å¤„ç†</li><li>è®­ç»ƒå’Œæµ‹è¯•æ•°æ®ä¹‹é—´çš„<strong>é¢†åŸŸä¸åŒ¹é…</strong></li><li>åœ¨è¾ƒé•¿æ–‡æœ¬ä¸Šç»´æŠ¤ä¸Šä¸‹æ–‡</li><li><strong>èµ„æºè¾ƒä½</strong>çš„è¯­è¨€å¯¹</li></ul><p>ä½¿ç”¨å¸¸è¯†ä»ç„¶å¾ˆéš¾</p><ul><li>NMTåœ¨è®­ç»ƒæ•°æ®ä¸­å‘ç°åå·®</li><li>æ— æ³•è§£é‡Šçš„ç³»ç»Ÿä¼šåšä¸€äº›å¥‡æ€ªçš„äº‹æƒ…</li></ul><h1 id="æ³¨æ„åŠ›æœºåˆ¶">5.æ³¨æ„åŠ›æœºåˆ¶</h1><h2 id="sequence-to-sequenceç“¶é¢ˆé—®é¢˜">5.1Sequence-to-sequenceï¼šç“¶é¢ˆé—®é¢˜</h2><ul><li>æºè¯­å¥çš„ç¼–ç </li><li>éœ€è¦æ•è·å…³äºæºè¯­å¥çš„æ‰€æœ‰ä¿¡æ¯</li><li>ä¿¡æ¯ç“¶é¢ˆï¼</li></ul><p><img src="/img/nlp/ç¬¬å…«è®²/11.png" /></p><h2 id="æ³¨æ„åŠ›">5.2 æ³¨æ„åŠ›</h2><p><strong>æ³¨æ„åŠ›</strong>ä¸ºç“¶é¢ˆé—®é¢˜æä¾›äº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ</p><p><strong>æ ¸å¿ƒç†å¿µ</strong>ï¼šåœ¨è§£ç å™¨çš„æ¯ä¸€æ­¥ï¼Œä½¿ç”¨ä¸<strong>ç¼–ç å™¨çš„ç›´æ¥è¿æ¥</strong>æ¥ä¸“æ³¨äºæºåºåˆ—çš„<strong>ç‰¹å®šéƒ¨åˆ†</strong></p><p>é¦–å…ˆæˆ‘ä»¬å°†é€šè¿‡å›¾è¡¨å±•ç¤º(æ²¡æœ‰æ–¹ç¨‹)ï¼Œç„¶åæˆ‘ä»¬å°†ç”¨æ–¹ç¨‹å±•ç¤º</p><h2 id="å¸¦æ³¨æ„åŠ›æœºåˆ¶çš„åºåˆ—åˆ°åºåˆ—æ¨¡å‹">5.3å¸¦æ³¨æ„åŠ›æœºåˆ¶çš„åºåˆ—åˆ°åºåˆ—æ¨¡å‹</h2><ul><li>å°†è§£ç å™¨éƒ¨åˆ†çš„ç¬¬ä¸€ä¸ªtoken ä¸æºè¯­å¥ä¸­çš„æ¯ä¸€ä¸ªæ—¶é—´æ­¥çš„éšè—çŠ¶æ€è¿›è¡Œ DotProduct å¾—åˆ°æ¯ä¸€æ—¶é—´æ­¥çš„åˆ†æ•°</li></ul><p><img src="/img/nlp/ç¬¬å…«è®²/15.png" /></p><p><img src="/img/nlp/ç¬¬å…«è®²/16.png" /></p><ul><li>é€šè¿‡softmaxå°†åˆ†æ•°è½¬åŒ–ä¸ºæ¦‚ç‡åˆ†å¸ƒ</li><li>åœ¨è¿™ä¸ªè§£ç å™¨æ—¶é—´æ­¥é•¿ä¸Šï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ç¬¬ä¸€ä¸ªç¼–ç å™¨éšè—çŠ¶æ€(â€œheâ€)</li></ul><p><img src="/img/nlp/ç¬¬å…«è®²/17.png" /></p><ul><li>åˆ©ç”¨<strong>æ³¨æ„åŠ›åˆ†å¸ƒ</strong>å¯¹ç¼–ç å™¨çš„éšè—çŠ¶æ€è¿›è¡Œ<strong>åŠ æƒæ±‚å’Œ</strong></li><li>æ³¨æ„åŠ›è¾“å‡ºä¸»è¦åŒ…å«æ¥è‡ªäºå—åˆ°<strong>é«˜åº¦å…³æ³¨</strong>çš„<strong>éšè—çŠ¶æ€</strong>çš„ä¿¡æ¯</li></ul><p><img src="/img/nlp/ç¬¬å…«è®²/18.png" /></p><p>è¿æ¥çš„<strong>æ³¨æ„åŠ›è¾“å‡º</strong>ä¸<strong>è§£ç å™¨éšè—çŠ¶æ€</strong>ï¼Œç„¶åç”¨æ¥è®¡ç®—<span class="math inline">\(\hat{y_1}\)</span></p><p><img src="/img/nlp/ç¬¬å…«è®²/19.png" /></p><p>æœ‰æ—¶ï¼Œæˆ‘ä»¬ä»å‰é¢çš„æ­¥éª¤ä¸­æå–æ³¨æ„åŠ›è¾“å‡ºï¼Œå¹¶å°†å…¶è¾“å…¥è§£ç å™¨(è¿åŒé€šå¸¸çš„è§£ç å™¨è¾“å…¥)ã€‚æˆ‘ä»¬åœ¨ä½œä¸š4ä¸­åšè¿™ä¸ªã€‚</p><p><img src="/img/nlp/ç¬¬å…«è®²/20.png" /></p><p><img src="/img/nlp/ç¬¬å…«è®²/21.png" /></p><p><img src="/img/nlp/ç¬¬å…«è®²/12.png" /></p><h2 id="æ³¨æ„åŠ›å…¬å¼">5.4 æ³¨æ„åŠ›ï¼šå…¬å¼</h2><p>æˆ‘ä»¬æœ‰ç¼–ç å™¨éšè—çŠ¶æ€<span class="math inline">\(h_{1}, \ldots, h_{N}\in \mathbb{R}^{h}\)</span></p><p>åœ¨æ—¶é—´æ­¥<spanclass="math inline">\(t\)</span>ä¸Šï¼Œæˆ‘ä»¬æœ‰è§£ç å™¨éšè—çŠ¶æ€<spanclass="math inline">\(s_{t} \in \mathbb{R}^{h}\)</span></p><p>æˆ‘ä»¬å¾—åˆ°è¿™ä¸€æ­¥çš„æ³¨æ„åˆ†æ•° <span class="math display">\[e^{t}=\left[s_{t}^{T} \boldsymbol{h}_{1}, \ldots, \boldsymbol{s}_{t}^{T}\boldsymbol{h}_{N}\right] \in \mathbb{R}^{N}\]</span> æˆ‘ä»¬ä½¿ç”¨softmaxå¾—åˆ°è¿™ä¸€æ­¥çš„æ³¨æ„åˆ†å¸ƒ<spanclass="math inline">\(\alpha^t\)</span>(è¿™æ˜¯ä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒï¼Œå’Œä¸º1) <spanclass="math display">\[\alpha^{t}=\operatorname{softmax}\left(e^{t}\right) \in \mathbb{R}^{N}\]</span> æˆ‘ä»¬ä½¿ç”¨<spanclass="math inline">\(\alpha^t\)</span>æ¥è·å¾—ç¼–ç å™¨éšè—çŠ¶æ€çš„åŠ æƒå’Œï¼Œå¾—åˆ°æ³¨æ„åŠ›è¾“å‡º<spanclass="math inline">\(\alpha^{t} \boldsymbol{a}_{t}=\sum_{i=1}^{N}\alpha_{i}^{t} \boldsymbol{h}_{i} \in \mathbb{R}^{h}\)</span></p><p>æœ€åï¼Œæˆ‘ä»¬å°†æ³¨æ„è¾“å‡º<spanclass="math inline">\(\alpha^t\)</span>ä¸è§£ç å™¨éšè—çŠ¶æ€è¿æ¥èµ·æ¥ï¼Œå¹¶æŒ‰ç…§éæ³¨æ„seq2seq æ¨¡å‹ç»§ç»­è¿›è¡Œ <span class="math display">\[\left[\boldsymbol{a}_{t} ; \boldsymbol{s}_{t}\right] \in \mathbb{R}^{2h}\]</span></p><h2 id="æ³¨æ„åŠ›å¾ˆæ£’">5.5 æ³¨æ„åŠ›å¾ˆæ£’ï¼</h2><p>æ³¨æ„åŠ›æ˜¾è‘—æé«˜äº†NMTæ€§èƒ½</p><ul><li>è¿™æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œè®©è§£ç å™¨ä¸“æ³¨äºæŸäº›éƒ¨åˆ†çš„æºè¯­å¥</li></ul><p>æ³¨æ„åŠ›è§£å†³ç“¶é¢ˆé—®é¢˜</p><ul><li>æ³¨æ„åŠ›å…è®¸è§£ç å™¨ç›´æ¥æŸ¥çœ‹æºè¯­å¥ï¼›ç»•è¿‡ç“¶é¢ˆ</li></ul><p>æ³¨æ„åŠ›å¸®åŠ©æ¶ˆå¤±æ¢¯åº¦é—®é¢˜</p><ul><li>æä¾›äº†é€šå¾€é¥è¿œçŠ¶æ€çš„æ·å¾„</li></ul><p>æ³¨æ„åŠ›æä¾›äº†ä¸€äº›å¯è§£é‡Šæ€§</p><ul><li>é€šè¿‡æ£€æŸ¥æ³¨æ„åŠ›çš„åˆ†å¸ƒï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è§£ç å™¨åœ¨å…³æ³¨ä»€ä¹ˆ</li><li>æˆ‘ä»¬å¯ä»¥å…è´¹å¾—åˆ°(è½¯)å¯¹é½</li><li>è¿™å¾ˆé…·ï¼Œå› ä¸ºæˆ‘ä»¬ä»æ¥æ²¡æœ‰æ˜ç¡®è®­ç»ƒè¿‡å¯¹é½ç³»ç»Ÿ</li><li>ç½‘ç»œåªæ˜¯è‡ªä¸»å­¦ä¹ äº†å¯¹é½</li></ul><h2 id="æ³¨æ„åŠ›æ˜¯ä¸€ç§æ™®éçš„æ·±åº¦å­¦ä¹ æŠ€å·§">5.6æ³¨æ„åŠ›æ˜¯ä¸€ç§æ™®éçš„æ·±åº¦å­¦ä¹ æŠ€å·§</h2><p>æˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼Œæ³¨æ„åŠ›æ˜¯æ”¹è¿›æœºå™¨ç¿»è¯‘çš„åºåˆ—åˆ°åºåˆ—æ¨¡å‹çš„ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ³•</p><p>ç„¶è€Œï¼šä½ å¯ä»¥åœ¨<strong>è®¸å¤šç»“æ„</strong>(ä¸ä»…ä»…æ˜¯seq2seq)å’Œè®¸å¤šä»»åŠ¡(ä¸ä»…ä»…æ˜¯MT)ä¸­ä½¿ç”¨æ³¨æ„åŠ›</p><p>æˆ‘ä»¬æœ‰æ—¶è¯´ <strong>query attends to the values</strong></p><p>ä¾‹å¦‚ï¼Œåœ¨seq2seq +attentionæ¨¡å‹ä¸­ï¼Œæ¯ä¸ªè§£ç å™¨çš„éšè—çŠ¶æ€(æŸ¥è¯¢)å…³æ³¨æ‰€æœ‰ç¼–ç å™¨çš„éšè—çŠ¶æ€(å€¼)</p><h2 id="æ³¨æ„åŠ›æ˜¯ä¸€ç§æ™®éçš„æ·±åº¦å­¦ä¹ æŠ€å·§-1">5.7æ³¨æ„åŠ›æ˜¯ä¸€ç§æ™®éçš„æ·±åº¦å­¦ä¹ æŠ€å·§</h2><p>æ³¨æ„åŠ›çš„æ›´ä¸€èˆ¬å®šä¹‰</p><ul><li>ç»™å®šä¸€ç»„å‘é‡<strong>å€¼</strong>å’Œä¸€ä¸ªå‘é‡<strong>æŸ¥è¯¢</strong>ï¼Œæ³¨æ„åŠ›æ˜¯ä¸€ç§æ ¹æ®æŸ¥è¯¢ï¼Œè®¡ç®—å€¼çš„åŠ æƒå’Œçš„æŠ€æœ¯</li></ul><p>ç›´è§‰</p><ul><li>åŠ æƒå’Œæ˜¯å€¼ä¸­åŒ…å«çš„ä¿¡æ¯çš„<strong>é€‰æ‹©æ€§æ±‡æ€»</strong>ï¼ŒæŸ¥è¯¢åœ¨å…¶ä¸­ç¡®å®šè¦å…³æ³¨å“ªäº›å€¼</li><li>æ³¨æ„æ˜¯ä¸€ç§è·å–<strong>ä»»æ„ä¸€ç»„è¡¨ç¤º(å€¼)çš„å›ºå®šå¤§å°è¡¨ç¤ºçš„æ–¹æ³•</strong>ï¼Œä¾èµ–äºå…¶ä»–ä¸€äº›è¡¨ç¤º(æŸ¥è¯¢)ã€‚</li></ul><h2 id="æœ‰å‡ ç§æ³¨æ„åŠ›çš„å˜ä½“">5.8 æœ‰å‡ ç§æ³¨æ„åŠ›çš„å˜ä½“</h2><p><img src="/img/nlp/ç¬¬å…«è®²/13.png" /></p><p><img src="/img/nlp/ç¬¬å…«è®²/14.png" /></p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬ä¸ƒè®²-æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ä¸RNNå˜ç§</title>
    <link href="/2022/05/13/%E7%AC%AC%E4%B8%83%E8%AE%B2-%E6%A2%AF%E5%BA%A6%E6%B6%88%E5%A4%B1%E9%97%AE%E9%A2%98%E4%B8%8ERNN%E5%8F%98%E7%A7%8D/"/>
    <url>/2022/05/13/%E7%AC%AC%E4%B8%83%E8%AE%B2-%E6%A2%AF%E5%BA%A6%E6%B6%88%E5%A4%B1%E9%97%AE%E9%A2%98%E4%B8%8ERNN%E5%8F%98%E7%A7%8D/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¢¯åº¦æ¶ˆå¤±">1.æ¢¯åº¦æ¶ˆå¤±</h1><h2 id="æ¢¯åº¦æ¶ˆå¤±é—®é¢˜">1.1 æ¢¯åº¦æ¶ˆå¤±é—®é¢˜</h2><p>æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼šå½“è¿™äº›æ¢¯åº¦å¾ˆå°çš„æ—¶å€™ï¼Œåå‘ä¼ æ’­çš„è¶Šæ·±å…¥ï¼Œæ¢¯åº¦ä¿¡å·å°±ä¼šå˜å¾—è¶Šæ¥è¶Šå°</p><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/1.png" /></p><h2 id="æ¢¯åº¦æ¶ˆå¤±è¯æ˜ç®€è¿°">1.2 æ¢¯åº¦æ¶ˆå¤±è¯æ˜ç®€è¿°</h2><p><span class="math display">\[\boldsymbol{h}^{(t)}=\sigma\left(\boldsymbol{W}_{h}\boldsymbol{h}^{(t-1)}+\boldsymbol{W}_{x}\boldsymbol{x}^{(t)}+\boldsymbol{b}_{1}\right)\]</span></p><p>å› æ­¤é€šè¿‡<strong>é“¾å¼æ³•åˆ™</strong>å¾—åˆ°ï¼š <span class="math display">\[\frac{\partial \boldsymbol{h}^{(t)}}{\partial\boldsymbol{h}^{(t-1)}}=\operatorname{diag}\left(\sigma^{\prime}\left(\boldsymbol{W}_{h}\boldsymbol{h}^{(t-1)}+\boldsymbol{W}_{x}\boldsymbol{x}^{(t)}+\boldsymbol{b}_{1}\right)\right) \boldsymbol{W}_{h}\]</span> è€ƒè™‘ç¬¬<spanclass="math inline">\(i\)</span>æ­¥ä¸Šçš„æŸå¤±æ¢¯åº¦<spanclass="math inline">\(J^{(i)}(\theta)\)</span>ï¼Œç›¸å¯¹äºç¬¬<spanclass="math inline">\(j\)</span>æ­¥ä¸Šçš„éšè—çŠ¶æ€<spanclass="math inline">\(h^{(j)}\)</span>ã€‚å¦‚æœæƒé‡çŸ©é˜µ<spanclass="math inline">\(W_h\)</span>å¾ˆå°ï¼Œé‚£ä¹ˆè¿™ä¸€é¡¹ä¹Ÿä¼šéšç€<spanclass="math inline">\(i\)</span>å’Œ<spanclass="math inline">\(j\)</span>çš„è·ç¦»è¶Šæ¥è¶Šè¿œè€Œå˜å¾—è¶Šæ¥è¶Šå°</p><p>è€ƒè™‘çŸ©é˜µçš„ L2 èŒƒæ•° <span class="math display">\[\left\|\frac{\partial J^{(i)}(\theta)}{\partial\boldsymbol{h}^{(j)}}\right\| \leq\left\|\frac{\partialJ^{(i)}(\theta)}{\partial\boldsymbol{h}^{(i)}}\right\|\left\|\boldsymbol{W}_{h}\right\|^{(i-j)}\prod_{j&lt;t \leqi}\left\|\operatorname{diag}\left(\sigma^{\prime}\left(\boldsymbol{W}_{h}\boldsymbol{h}^{(t-1)}+\boldsymbol{W}_{x}\boldsymbol{x}^{(t)}+\boldsymbol{b}_{1}\right)\right)\right\|\]</span> Pascanu et al è¡¨æ˜ï¼Œå¦‚æœ<spanclass="math inline">\(W_h\)</span>çš„<strong>æœ€å¤§ç‰¹å¾å€¼</strong>&lt;1ï¼Œæ¢¯åº¦<spanclass="math inline">\(\left\|\frac{\partial J^{(i)}(\theta)}{\partial\boldsymbol{h}^{(j)}}\right\|\)</span>å°†å‘ˆ<strong>æŒ‡æ•°è¡°å‡</strong></p><ul><li>è¿™é‡Œçš„ç•Œé™æ˜¯1å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„éçº¿æ€§å‡½æ•°æ˜¯sigmoid</li></ul><p>æœ‰ä¸€ä¸ªç±»ä¼¼çš„è¯æ˜å°†ä¸€ä¸ª<strong>æœ€å¤§çš„ç‰¹å¾å€¼</strong> &gt;1ä¸<strong>æ¢¯åº¦çˆ†ç‚¸</strong>è”ç³»èµ·æ¥</p><h2 id="ä¸ºä»€ä¹ˆæ¢¯åº¦æ¶ˆå¤±æ˜¯ä¸ªé—®é¢˜">1.3 ä¸ºä»€ä¹ˆæ¢¯åº¦æ¶ˆå¤±æ˜¯ä¸ªé—®é¢˜ï¼Ÿ</h2><p>æ¥è‡ªè¿œå¤„çš„æ¢¯åº¦ä¿¡å·ä¼šä¸¢å¤±ï¼Œå› ä¸ºå®ƒæ¯”æ¥è‡ªè¿‘å¤„çš„æ¢¯åº¦ä¿¡å·å°å¾—å¤šã€‚å› æ­¤ï¼Œæ¨¡å‹æƒé‡åªä¼šæ ¹æ®è¿‘æœŸæ•ˆåº”è€Œä¸æ˜¯é•¿æœŸæ•ˆåº”è¿›è¡Œæ›´æ–°ã€‚</p><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/2.png" /></p><p>å¦ä¸€ç§è§£é‡Šï¼š<strong>æ¢¯åº¦</strong>å¯ä»¥è¢«çœ‹ä½œæ˜¯<strong>è¿‡å»å¯¹æœªæ¥çš„å½±å“</strong>çš„è¡¡é‡æ ‡å‡†</p><p>å¦‚æœæ¢¯åº¦åœ¨è¾ƒé•¿ä¸€æ®µè·ç¦»å†…(ä»æ—¶é—´æ­¥<spanclass="math inline">\(t\)</span>åˆ°<spanclass="math inline">\(t+n\)</span>)å˜å¾—è¶Šæ¥è¶Šå°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸èƒ½åˆ¤æ–­ï¼š</p><ul><li>åœ¨æ•°æ®ä¸­ï¼Œæ­¥éª¤<span class="math inline">\(t\)</span>å’Œ<spanclass="math inline">\(t+n\)</span>ä¹‹é—´<strong>æ²¡æœ‰ä¾èµ–å…³ç³»</strong></li><li>æˆ‘ä»¬ç”¨<strong>é”™è¯¯çš„å‚æ•°</strong>æ¥æ•è·<spanclass="math inline">\(t\)</span>å’Œ<spanclass="math inline">\(t+n\)</span>ä¹‹é—´çš„çœŸæ­£ä¾èµ–å…³ç³»</li></ul><h2 id="æ¢¯åº¦æ¶ˆå¤±å¯¹rnnè¯­è¨€æ¨¡å‹çš„å½±å“">1.4æ¢¯åº¦æ¶ˆå¤±å¯¹RNNè¯­è¨€æ¨¡å‹çš„å½±å“</h2><p><code>LM task: When she tried to print her tickets, she found that the printer was out of toner. She went to the stationery store to buy more toner. It was very overpriced. After installing the toner into the printer, she finally printed her ________</code></p><p>ä¸ºäº†ä»è¿™ä¸ªè®­ç»ƒç¤ºä¾‹ä¸­å­¦ä¹ ï¼ŒRNN-LMéœ€è¦å¯¹ç¬¬7æ­¥çš„ <code>tickets</code>å’Œæœ€åçš„ç›®æ ‡å•è¯ <code>tickets</code>ä¹‹é—´çš„<strong>ä¾èµ–å…³ç³»å»ºæ¨¡</strong></p><p>ä½†æ˜¯å¦‚æœæ¢¯åº¦å¾ˆå°ï¼Œæ¨¡å‹å°±<strong>ä¸èƒ½å­¦ä¹ è¿™ç§ä¾èµ–å…³ç³»</strong></p><ul><li>å› æ­¤æ¨¡å‹æ— æ³•åœ¨æµ‹è¯•æ—¶<strong>é¢„æµ‹ç±»ä¼¼çš„é•¿è·ç¦»ä¾èµ–å…³ç³»</strong></li></ul><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/3.png" /></p><p>Correct answer: The writer of the books <u>is</u> planning asequel</p><ul><li><strong>è¯­æ³•è¿‘å› </strong>ï¼šThe <u>writer</u> of the books <u>is</u>ï¼ˆæ­£ç¡®ï¼‰</li><li><strong>é¡ºåºè¿‘å› </strong>ï¼šThe writer of the <u>books</u> <u>is</u>ï¼ˆä¸æ­£ç¡®ï¼‰</li></ul><p>ç”±äºæ¢¯åº¦çš„æ¶ˆå¤±ï¼ŒRNN-LMsæ›´å–„äºä»<strong>é¡ºåºè¿‘å› </strong>å­¦ä¹ è€Œä¸æ˜¯<strong>è¯­æ³•è¿‘å› </strong>ï¼Œæ‰€ä»¥ä»–ä»¬çŠ¯è¿™ç§é”™è¯¯çš„é¢‘ç‡æ¯”æˆ‘ä»¬å¸Œæœ›çš„è¦é«˜[Linzenet al . 2016]</p><h2 id="å¦‚ä½•è§£å†³æ¢¯åº¦æ¶ˆå¤±é—®é¢˜">1.5 å¦‚ä½•è§£å†³æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Ÿ</h2><p>ä¸»è¦é—®é¢˜æ˜¯RNNå¾ˆéš¾å­¦ä¹ åœ¨å¤šä¸ªæ—¶é—´æ­¥é•¿çš„æƒ…å†µä¸‹ä¿å­˜ä¿¡æ¯ï¼Œåœ¨æ™®é€šçš„RNNä¸­ï¼Œéšè—çŠ¶æ€ä¸æ–­è¢«é‡å†™ã€‚<span class="math display">\[\boldsymbol{h}^{(t)}=\sigma\left(\boldsymbol{W}_{h}\boldsymbol{h}^{(t-1)}+\boldsymbol{W}_{x}\boldsymbol{x}^{(t)}+\boldsymbol{b}\right)\]</span> æœ‰æ²¡æœ‰æ›´å¥½ç»“æ„çš„RNNï¼Ÿ</p><h1 id="æ¢¯åº¦çˆ†ç‚¸">2.æ¢¯åº¦çˆ†ç‚¸</h1><h2 id="ä¸ºä»€ä¹ˆæ¢¯åº¦çˆ†ç‚¸æ˜¯ä¸ªé—®é¢˜">2.1 ä¸ºä»€ä¹ˆæ¢¯åº¦çˆ†ç‚¸æ˜¯ä¸ªé—®é¢˜ï¼Ÿ</h2><p>å¦‚æœæ¢¯åº¦è¿‡å¤§ï¼Œåˆ™SGDæ›´æ–°æ­¥éª¤è¿‡å¤§ï¼Œè¿™å¯èƒ½å¯¼è‡´<strong>é”™è¯¯çš„æ›´æ–°</strong>ï¼šæˆ‘ä»¬æ›´æ–°çš„å¤ªå¤šï¼Œå¯¼è‡´é”™è¯¯çš„å‚æ•°é…ç½®(æŸå¤±å¾ˆå¤§)ã€‚</p><p>åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œè¿™å°†å¯¼è‡´ç½‘ç»œä¸­çš„ <strong>Inf</strong> æˆ–<strong>NaN</strong>(ç„¶åä½ å¿…é¡»ä»è¾ƒæ—©çš„æ£€æŸ¥ç‚¹é‡æ–°å¯åŠ¨è®­ç»ƒ)</p><h2 id="æ¢¯åº¦å‰ªè£æ¢¯åº¦çˆ†ç‚¸çš„è§£å†³æ–¹æ¡ˆ">2.2æ¢¯åº¦å‰ªè£ï¼šæ¢¯åº¦çˆ†ç‚¸çš„è§£å†³æ–¹æ¡ˆ</h2><p><strong>æ¢¯åº¦è£å‰ª</strong>ï¼šå¦‚æœæ¢¯åº¦çš„èŒƒæ•°å¤§äºæŸä¸ªé˜ˆå€¼ï¼Œåœ¨åº”ç”¨SGDæ›´æ–°ä¹‹å‰å°†å…¶ç¼©å°</p><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/4.png" /></p><p><strong>ç›´è§‰</strong>ï¼šæœç€åŒæ ·çš„æ–¹å‘è¿ˆå‡ºä¸€æ­¥ï¼Œä½†è¦å°ä¸€ç‚¹</p><p>è¿™æ˜¾ç¤ºäº†ä¸€ä¸ªç®€å•RNNçš„æŸå¤±é¢(éšè—å±‚çŠ¶æ€æ˜¯ä¸€ä¸ªæ ‡é‡ä¸æ˜¯ä¸€ä¸ªå‘é‡)ï¼Œæ‚¬å´–æ˜¯å±é™©çš„ï¼Œå› ä¸ºæœ‰é™¡å¡</p><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/5.png" /></p><p>åœ¨å·¦è¾¹ï¼Œç”±äºé™¡å¡ï¼Œæ¢¯åº¦ä¸‹é™æœ‰<strong>ä¸¤ä¸ªéå¸¸å¤§çš„æ­¥éª¤</strong>ï¼Œå¯¼è‡´æ”€ç™»æ‚¬å´–ç„¶åå‘å³å°„å‡»(éƒ½æ˜¯<strong>åçš„æ›´æ–°</strong>)</p><p>åœ¨å³è¾¹ï¼Œæ¢¯åº¦å‰ªè£å‡å°‘äº†è¿™äº›æ­¥éª¤çš„å¤§å°ï¼Œæ‰€ä»¥å‚æ•°è°ƒæ•´ä¸ä¼šæœ‰å‰§çƒˆçš„æ³¢åŠ¨</p><h1 id="é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œlstm">3.é•¿çŸ­æ—¶è®°å¿†ç½‘ç»œ(LSTM)</h1><h2 id="é•¿çŸ­æ—¶è®°å¿†lstm">3.1 é•¿çŸ­æ—¶è®°å¿†(LSTM)</h2><p>Hochreiterå’ŒSchmidhuberåœ¨1997å¹´æå‡ºäº†ä¸€ç§RNNï¼Œç”¨äºè§£å†³æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ã€‚</p><p>åœ¨ç¬¬<spanclass="math inline">\(t\)</span>æ­¥ï¼Œæœ‰ä¸€ä¸ª<strong>éšè—çŠ¶æ€</strong><spanclass="math inline">\(h^{(t)}\)</span>å’Œä¸€ä¸ª<strong>å•å…ƒçŠ¶æ€</strong><spanclass="math inline">\(c^{(t)}\)</span></p><ul><li>éƒ½æ˜¯é•¿åº¦ä¸º<span class="math inline">\(n\)</span>çš„å‘é‡</li><li>å•å…ƒå­˜å‚¨é•¿æœŸä¿¡æ¯</li><li>LSTMå¯ä»¥ä»å•å…ƒä¸­<strong>æ“¦é™¤</strong>ã€<strong>å†™å…¥</strong>å’Œ<strong>è¯»å–ä¿¡æ¯</strong></li></ul><p>ä¿¡æ¯è¢« æ“¦é™¤ / å†™å…¥ / è¯»å– çš„é€‰æ‹©ç”±ä¸‰ä¸ªå¯¹åº”çš„é—¨æ§åˆ¶</p><ul><li>é—¨ä¹Ÿæ˜¯é•¿åº¦ä¸º<span class="math inline">\(n\)</span>çš„å‘é‡</li><li>åœ¨æ¯ä¸ªæ—¶é—´æ­¥é•¿ä¸Šï¼Œé—¨çš„æ¯ä¸ªå…ƒç´ å¯ä»¥<strong>æ‰“å¼€</strong>(1)ã€<strong>å…³é—­</strong>(0)æˆ–ä»‹äºä¸¤è€…ä¹‹é—´</li><li><strong>é—¨æ˜¯åŠ¨æ€çš„</strong>ï¼šå®ƒä»¬çš„å€¼æ˜¯åŸºäºå½“å‰ä¸Šä¸‹æ–‡è®¡ç®—çš„</li></ul><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/6.png" /></p><p>æˆ‘ä»¬æœ‰ä¸€ä¸ªè¾“å…¥åºåˆ—<spanclass="math inline">\(x^{(t)}\)</span>ï¼Œæˆ‘ä»¬å°†è®¡ç®—ä¸€ä¸ªéšè—çŠ¶æ€<spanclass="math inline">\(h^{(t)}\)</span>å’Œå•å…ƒçŠ¶æ€<spanclass="math inline">\(c^{(t)}\)</span>çš„åºåˆ—ã€‚åœ¨æ—¶é—´æ­¥<spanclass="math inline">\(t\)</span>æ—¶</p><ul><li><p><strong>é—å¿˜é—¨</strong>ï¼šæ§åˆ¶ä¸Šä¸€ä¸ªå•å…ƒçŠ¶æ€çš„ä¿å­˜ä¸é—å¿˜</p></li><li><p><strong>è¾“å…¥é—¨</strong>ï¼šæ§åˆ¶å†™å…¥å•å…ƒæ ¼çš„æ–°å•å…ƒå†…å®¹çš„å“ªäº›éƒ¨åˆ†</p></li><li><p><strong>è¾“å‡ºé—¨</strong>ï¼šæ§åˆ¶å•å…ƒçš„å“ªäº›å†…å®¹è¾“å‡ºåˆ°éšè—çŠ¶æ€</p></li><li><p><strong>æ–°å•å…ƒå†…å®¹</strong>ï¼šè¿™æ˜¯è¦å†™å…¥å•å…ƒçš„æ–°å†…å®¹</p></li><li><p><strong>å•å…ƒçŠ¶æ€</strong>ï¼šåˆ é™¤(â€œå¿˜è®°â€)ä¸Šæ¬¡å•å…ƒçŠ¶æ€ä¸­çš„ä¸€äº›å†…å®¹ï¼Œå¹¶å†™å…¥(â€œè¾“å…¥â€)ä¸€äº›æ–°çš„å•å…ƒå†…å®¹</p></li><li><p><strong>éšè—çŠ¶æ€</strong>ï¼šä»å•å…ƒä¸­è¯»å–(â€œoutputâ€)ä¸€äº›å†…å®¹</p></li><li><p><strong>Sigmoidå‡½æ•°</strong>ï¼šæ‰€æœ‰çš„é—¨çš„å€¼éƒ½åœ¨0åˆ°1ä¹‹é—´</p></li><li><p>é€šè¿‡é€å…ƒç´ çš„ä¹˜ç§¯æ¥åº”ç”¨é—¨</p></li><li><p>è¿™äº›æ˜¯é•¿åº¦ç›¸åŒ(<spanclass="math inline">\(n\)</span>)çš„å‘é‡</p></li></ul><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/7.png" /></p><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/8.png" /></p><h2 id="lstmå¦‚ä½•è§£å†³æ¢¯åº¦æ¶ˆå¤±">3.2 LSTMå¦‚ä½•è§£å†³æ¢¯åº¦æ¶ˆå¤±</h2><p>RNNçš„LSTMæ¶æ„æ›´å®¹æ˜“ä¿å­˜è®¸å¤šæ—¶é—´æ­¥ä¸Šçš„ä¿¡æ¯</p><ul><li>å¦‚æœå¿˜è®°é—¨è®¾ç½®ä¸ºè®°å¾—æ¯ä¸€æ—¶é—´æ­¥ä¸Šçš„æ‰€æœ‰ä¿¡æ¯ï¼Œé‚£ä¹ˆå•å…ƒä¸­çš„ä¿¡æ¯è¢«æ— é™åœ°ä¿å­˜</li><li>ç›¸æ¯”ä¹‹ä¸‹ï¼Œæ™®é€šRNNæ›´éš¾å­¦ä¹ é‡å¤ä½¿ç”¨å¹¶ä¸”åœ¨éšè—çŠ¶æ€ä¸­ä¿å­˜ä¿¡æ¯çš„çŸ©é˜µ<spanclass="math inline">\(W_h\)</span></li></ul><p>LSTMå¹¶ä¸ä¿è¯æ²¡æœ‰<strong>æ¢¯åº¦æ¶ˆå¤±/çˆ†ç‚¸</strong>ï¼Œä½†å®ƒç¡®å®ä¸ºæ¨¡å‹æä¾›äº†ä¸€ç§æ›´å®¹æ˜“çš„æ–¹æ³•æ¥å­¦ä¹ è¿œç¨‹ä¾èµ–å…³ç³»</p><h2 id="lstmsç°å®ä¸–ç•Œçš„æˆåŠŸ">3.3 LSTMsï¼šç°å®ä¸–ç•Œçš„æˆåŠŸ</h2><p>2013-2015å¹´ï¼ŒLSTMå¼€å§‹å®ç°æœ€å…ˆè¿›çš„ç»“æœ</p><ul><li>æˆåŠŸçš„ä»»åŠ¡åŒ…æ‹¬ï¼šæ‰‹å†™è¯†åˆ«ã€è¯­éŸ³è¯†åˆ«ã€æœºå™¨ç¿»è¯‘ã€è§£æã€å›¾åƒå­—å¹•</li><li><strong>LSTMæˆä¸ºä¸»å¯¼æ–¹æ³•</strong></li></ul><p>ç°åœ¨(2019å¹´)ï¼Œå…¶ä»–æ–¹æ³•(<strong>å¦‚Transformers</strong>)åœ¨æŸäº›ä»»åŠ¡ä¸Šå˜å¾—æ›´åŠ ä¸»å¯¼</p><ul><li>ä¾‹å¦‚åœ¨WMT(a MT conference + competition)ä¸­</li><li>åœ¨2016å¹´WMTä¸­ï¼Œæ€»ç»“æŠ¥å‘ŠåŒ…å«â€œRNNâ€44æ¬¡</li><li>åœ¨2018å¹´WMTä¸­ï¼Œæ€»ç»“æŠ¥å‘ŠåŒ…å«â€œRNNâ€9æ¬¡ï¼Œâ€œTransformersâ€ 63æ¬¡</li></ul><h1 id="gruç½‘ç»œ">4.GRUç½‘ç»œ</h1><h2 id="gated-recurrent-unitsgru">4.1 Gated Recurrent Units(GRU)</h2><p>Choç­‰äººåœ¨2014å¹´æå‡ºäº†LSTMçš„ä¸€ä¸ªæ›´ç®€å•çš„æ›¿ä»£æ–¹æ¡ˆï¼Œåœ¨æ¯ä¸ªæ—¶é—´æ­¥<spanclass="math inline">\(t\)</span>ä¸Šï¼Œæˆ‘ä»¬éƒ½æœ‰è¾“å…¥<spanclass="math inline">\(x^{(t)}\)</span>å’Œéšè—çŠ¶æ€<spanclass="math inline">\(h^{(t)}\)</span>(æ²¡æœ‰å•å…ƒçŠ¶æ€)</p><ul><li><p><strong>æ›´æ–°é—¨</strong>ï¼šæ§åˆ¶éšè—çŠ¶æ€çš„å“ªäº›éƒ¨åˆ†è¢«æ›´æ–°ï¼Œæˆ–è€…è¢«ä¿ç•™</p></li><li><p><strong>é‡ç½®é—¨</strong>ï¼šæ§åˆ¶ä¹‹å‰éšè—çŠ¶æ€çš„å“ªäº›éƒ¨åˆ†è¢«ç”¨äºè®¡ç®—æ–°å†…å®¹</p></li><li><p><strong>æ–°çš„éšè—çŠ¶æ€å†…å®¹</strong>ï¼šé‡ç½®é—¨é€‰æ‹©ä¹‹å‰éšè—çŠ¶æ€çš„æœ‰ç”¨éƒ¨åˆ†ã€‚ä½¿ç”¨è¿™ä¸€éƒ¨åˆ†å’Œå½“å‰è¾“å…¥æ¥è®¡ç®—æ–°çš„éšè—çŠ¶æ€å†…å®¹</p></li><li><p><strong>éšè—çŠ¶æ€</strong>ï¼šæ›´æ–°é—¨åŒæ—¶æ§åˆ¶ä»ä»¥å‰çš„éšè—çŠ¶æ€ä¿ç•™çš„å†…å®¹ï¼Œä»¥åŠæ›´æ–°åˆ°æ–°çš„éšè—çŠ¶æ€å†…å®¹çš„å†…å®¹</p></li></ul><p>è¿™å¦‚ä½•è§£å†³æ¶ˆå¤±æ¢¯åº¦ï¼Ÿ</p><ul><li>ä¸LSTMç±»ä¼¼ï¼ŒGRUä½¿é•¿æœŸä¿å­˜ä¿¡æ¯å˜å¾—æ›´å®¹æ˜“(ä¾‹å¦‚ï¼Œå°†updategateè®¾ç½®ä¸º0)</li></ul><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/9.png" /></p><h2 id="lstm-vs-gru">4.2 LSTM vs GRU</h2><p>ç ”ç©¶äººå‘˜æå‡ºäº†è®¸å¤šé—¨æ§RNNå˜ä½“ï¼Œå…¶ä¸­LSTMå’ŒGRUçš„åº”ç”¨æœ€ä¸ºå¹¿æ³›</p><p>æœ€å¤§çš„åŒºåˆ«æ˜¯<strong>GRUè®¡ç®—é€Ÿåº¦æ›´å¿«</strong>ï¼Œå‚æ•°æ›´å°‘ã€‚æ²¡æœ‰ç¡®å‡¿çš„è¯æ®è¡¨æ˜å…¶ä¸­ä¸€ä¸ªæ€»æ˜¯æ¯”å¦ä¸€ä¸ªè¡¨ç°å¾—æ›´å¥½ã€‚<strong>LSTM</strong>æ˜¯ä¸€ä¸ª<strong>å¾ˆå¥½çš„é»˜è®¤é€‰æ‹©</strong>(ç‰¹åˆ«æ˜¯å½“ä½ çš„æ•°æ®å…·æœ‰éå¸¸é•¿çš„ä¾èµ–å…³ç³»ï¼Œæˆ–è€…ä½ æœ‰å¾ˆå¤šè®­ç»ƒæ•°æ®æ—¶)</p><p><strong>ç»éªŒæ³•åˆ™</strong>ï¼šä»LSTMå¼€å§‹ï¼Œä½†æ˜¯å¦‚æœä½ æƒ³è¦æ›´æœ‰æ•ˆç‡ï¼Œå°±åˆ‡æ¢åˆ°GRU</p><h2 id="æ¢¯åº¦æ¶ˆå¤±çˆ†ç‚¸åªæ˜¯rnné—®é¢˜å—">4.3 æ¢¯åº¦æ¶ˆå¤±/çˆ†ç‚¸åªæ˜¯RNNé—®é¢˜å—ï¼Ÿ</h2><p><strong>æ¢¯åº¦æ¶ˆå¤±/çˆ†ç‚¸åªæ˜¯RNNé—®é¢˜å—</strong>ï¼Ÿ</p><p>å¹¶ä¸æ˜¯ï¼Œè¿™å¯¹äºæ‰€æœ‰çš„ç¥ç»ç»“æ„(åŒ…æ‹¬å‰é¦ˆå’Œå·ç§¯ç½‘ç»œ)éƒ½æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œå°¤å…¶æ˜¯å¯¹äºæ·±åº¦ç»“æ„</p><ul><li>ç”±äºé“¾å¼æ³•åˆ™/é€‰æ‹©éçº¿æ€§å‡½æ•°ï¼Œåå‘ä¼ æ’­æ—¶æ¢¯åº¦å¯ä»¥å˜å¾—å¾ˆå°å¾ˆå°</li><li>å› æ­¤ï¼Œè¾ƒä½å±‚æ¬¡çš„å­¦ä¹ éå¸¸ç¼“æ…¢(éš¾ä»¥è®­ç»ƒ)</li><li>è§£å†³æ–¹æ¡ˆï¼šå¤§é‡æ–°çš„æ·±å±‚å‰é¦ˆ /å·ç§¯æ¶æ„ï¼Œ<strong>æ·»åŠ æ›´å¤šçš„ç›´æ¥è¿æ¥</strong>(ä»è€Œä½¿æ¢¯åº¦å¯ä»¥æµåŠ¨)</li></ul><p>ä¾‹å¦‚ï¼š</p><ul><li>æ®‹å·®è¿æ¥åˆåâ€œResNetâ€,ä¹Ÿç§°ä¸ºè·³è½¬è¿æ¥</li><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ ‡è¯†è¿æ¥ä¿å­˜ä¿¡æ¯</li><li>è¿™ä½¿å¾—æ·±å±‚ç½‘ç»œæ›´å®¹æ˜“è®­ç»ƒ</li></ul><p>ä¾‹å¦‚ï¼š</p><ul><li>å¯†é›†è¿æ¥åˆåâ€œDenseNetâ€</li><li>ç›´æ¥å°†æ‰€æœ‰å†…å®¹è¿æ¥åˆ°æ‰€æœ‰å†…å®¹</li></ul><p>ä¾‹å¦‚ï¼š</p><ul><li>Highwayè¿æ¥åˆç§°â€œé«˜é€Ÿç½‘ç»œâ€</li><li>ç±»ä¼¼äºæ®‹å·®è¿æ¥ï¼Œä½†æ ‡è¯†è¿æ¥ä¸è½¬æ¢å±‚ç”±åŠ¨æ€é—¨æ§åˆ¶</li><li>çµæ„Ÿæ¥è‡ªLSTMsï¼Œä½†é€‚ç”¨äºæ·±åº¦å‰é¦ˆ/å·ç§¯ç½‘ç»œ</li></ul><p>ç»“è®ºï¼šè™½ç„¶æ¢¯åº¦æ¶ˆå¤±/çˆ†ç‚¸æ˜¯ä¸€ä¸ªæ™®éçš„é—®é¢˜ï¼Œä½†ç”±äºé‡å¤ä¹˜ä»¥ç›¸åŒçš„æƒçŸ©é˜µï¼ŒRNNå°¤å…¶ä¸ç¨³å®š[Bengioet al, 1994]</p><h2 id="åŒå‘rnnåŠ¨æœº">4.4 åŒå‘RNNï¼šåŠ¨æœº</h2><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/10.png" /></p><p>æˆ‘ä»¬å¯ä»¥æŠŠè¿™ç§éšè—çŠ¶æ€çœ‹ä½œæ˜¯è¿™ä¸ªå¥å­ä¸­å•è¯â€œterriblyâ€çš„ä¸€ç§è¡¨ç¤ºã€‚æˆ‘ä»¬ç§°ä¹‹ä¸ºä¸Šä¸‹æ–‡è¡¨ç¤ºã€‚</p><p>è¿™äº›ä¸Šä¸‹æ–‡è¡¨ç¤ºåªåŒ…å«å…³äºå·¦ä¸Šä¸‹æ–‡çš„ä¿¡æ¯(ä¾‹å¦‚â€œthe movie wasâ€)ã€‚</p><p>é‚£ä¹ˆæ­£ç¡®çš„ä¸Šä¸‹æ–‡å‘¢?</p><ul><li>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œâ€œexcitingâ€åœ¨å³ä¸Šä¸‹æ–‡ä¸­ï¼Œå®ƒä¿®é¥°äº†â€œterriblyâ€çš„æ„æ€(ä»å¦å®šå˜ä¸ºè‚¯å®š)</li></ul><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/11.png" /></p><p>â€œterriblyâ€çš„ä¸Šä¸‹æ–‡è¡¨ç¤ºåŒæ—¶å…·æœ‰å·¦ä¸Šä¸‹æ–‡å’Œå³ä¸Šä¸‹æ–‡</p><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/12.png" /></p><p>è¿™æ˜¯ä¸€ä¸ªè¡¨ç¤ºâ€œè®¡ç®—RNNçš„ä¸€ä¸ªå‘å‰æ­¥éª¤â€çš„é€šç”¨ç¬¦å·â€”â€”å®ƒå¯ä»¥æ˜¯æ™®é€šçš„ã€LSTMæˆ–GRUè®¡ç®—</p><p>æˆ‘ä»¬è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªåŒå‘RNNçš„â€œéšè—çŠ¶æ€â€ã€‚è¿™å°±æ˜¯æˆ‘ä»¬ä¼ é€’ç»™ç½‘ç»œä¸‹ä¸€éƒ¨åˆ†çš„ä¸œè¥¿</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªRNNsæœ‰å„è‡ªçš„æƒé‡</p><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/13.png" /></p><p>åŒå‘ç®­å¤´è¡¨ç¤ºåŒå‘æ€§ï¼Œæ‰€æè¿°çš„éšè—çŠ¶æ€æ˜¯æ­£å‘+åå‘çŠ¶æ€çš„è¿æ¥</p><p>æ³¨æ„ï¼šåŒå‘RNNsåªé€‚ç”¨äºè®¿é—®æ•´ä¸ªè¾“å…¥åºåˆ—çš„æƒ…å†µ</p><ul><li>å®ƒä»¬ä¸é€‚ç”¨äºè¯­è¨€å»ºæ¨¡ï¼Œå› ä¸ºåœ¨LMä¸­ï¼Œä½ åªæœ‰å·¦ä¾§çš„ä¸Šä¸‹æ–‡å¯ç”¨</li></ul><p>å¦‚æœä½ æœ‰å®Œæ•´çš„è¾“å…¥åºåˆ—(ä¾‹å¦‚ä»»ä½•ä¸€ç§ç¼–ç )ï¼Œ<strong>åŒå‘æ€§æ˜¯å¼ºå¤§çš„</strong>(é»˜è®¤æƒ…å†µä¸‹ä½ åº”è¯¥ä½¿ç”¨å®ƒ)</p><p>ä¾‹å¦‚ï¼ŒBERT(æ¥è‡ªtransformerçš„åŒå‘ç¼–ç å™¨è¡¨ç¤º)æ˜¯ä¸€ä¸ªåŸºäºåŒå‘æ€§çš„å¼ºå¤§çš„é¢„è®­ç»ƒçš„ä¸Šä¸‹æ–‡è¡¨ç¤ºç³»ç»Ÿ</p><ul><li>ä½ ä¼šåœ¨è¯¾ç¨‹çš„åé¢å­¦åˆ°æ›´å¤šå…³äºBERTçš„çŸ¥è¯†!</li></ul><h2 id="æ·±å±‚rnn">4.5 æ·±å±‚RNN</h2><p>RNNsåœ¨ä¸€ä¸ªç»´åº¦ä¸Šå·²ç»æ˜¯â€œdeepâ€(å®ƒä»¬å±•å¼€åˆ°è®¸å¤šæ—¶é—´æ­¥é•¿)</p><p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡åº”ç”¨<strong>å¤šä¸ªRNN</strong>ä½¿å®ƒä»¬â€œæ·±å…¥â€åˆ°å¦ä¸€ä¸ªç»´åº¦ï¼šè¿™æ˜¯ä¸€ä¸ªå¤šå±‚RNN</p><p><strong>è¾ƒä½çš„RNN</strong>åº”è¯¥è®¡ç®—<strong>è¾ƒä½çº§åˆ«çš„ç‰¹æ€§</strong>ï¼Œè€Œ<strong>è¾ƒé«˜çš„RNN</strong>åº”è¯¥è®¡ç®—<strong>è¾ƒé«˜çº§åˆ«çš„ç‰¹æ€§</strong></p><p>å¤šå±‚RNNä¹Ÿç§°ä¸ºå †å RNN</p><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/14.png" /></p><p>RNNå±‚<span class="math inline">\(i\)</span>çš„éšè—çŠ¶æ€æ˜¯RNNå±‚<spanclass="math inline">\(i+1\)</span>çš„è¾“å…¥</p><h2 id="æ·±å±‚rnnåœ¨å®è·µä¸­çš„åº”ç”¨">4.6 æ·±å±‚RNNåœ¨å®è·µä¸­çš„åº”ç”¨</h2><p>é«˜æ€§èƒ½çš„RNNsé€šå¸¸æ˜¯å¤šå±‚çš„(ä½†æ²¡æœ‰å·ç§¯æˆ–å‰é¦ˆç½‘ç»œé‚£ä¹ˆæ·±)</p><p>ä¾‹å¦‚ï¼šåœ¨2017å¹´çš„ä¸€ç¯‡è®ºæ–‡ï¼ŒBritz et alå‘ç°åœ¨ç¥ç»æœºå™¨ç¿»è¯‘ä¸­ï¼Œ2åˆ°4å±‚RNNç¼–ç å™¨æ˜¯æœ€å¥½çš„,å’Œ4å±‚RNNè§£ç å™¨</p><ul><li>ä½†æ˜¯ï¼Œ<strong>skip-connections</strong> /<strong>dense-connections</strong> éœ€è¦è®­ç»ƒæ›´æ·±RNNs(ä¾‹å¦‚8å±‚)</li><li>RNNæ— æ³•å¹¶è¡ŒåŒ–ï¼Œè®¡ç®—ä»£ä»·è¿‡å¤§ï¼Œæ‰€ä»¥ä¸ä¼šè¿‡æ·±</li></ul><p>Transformer-based çš„ç½‘ç»œ(å¦‚BERT)å¯ä»¥å¤šè¾¾24å±‚</p><ul><li>BERT æœ‰å¾ˆå¤šskipping-likeçš„è¿æ¥</li></ul><h2 id="æ€»ç»“">4.7 æ€»ç»“</h2><ul><li>LSTMåŠŸèƒ½å¼ºå¤§ï¼Œä½†GRUé€Ÿåº¦æ›´å¿«</li><li>å‰ªè£ä½ çš„æ¢¯åº¦</li><li>å°½å¯èƒ½ä½¿ç”¨åŒå‘æ€§</li><li>å¤šå±‚RNNåŠŸèƒ½å¼ºå¤§ï¼Œä½†å¦‚æœå¾ˆæ·±å¯èƒ½éœ€è¦è·³æ¥/å¯†é›†è¿æ¥</li></ul><p><img src="/img/nlp/ç¬¬ä¸ƒè®²/15.png" /></p><p>å‚è€ƒï¼š</p><p>http://www.showmeai.tech/article-detail/241</p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬å…­è®²-å¾ªç¯ç¥ç»ç½‘ç»œä¸è¯­è¨€æ¨¡å‹</title>
    <link href="/2022/05/12/%E7%AC%AC%E5%85%AD%E8%AE%B2-%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%B8%8E%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/"/>
    <url>/2022/05/12/%E7%AC%AC%E5%85%AD%E8%AE%B2-%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%B8%8E%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="è¯­è¨€æ¨¡å‹">1.è¯­è¨€æ¨¡å‹</h1><h2 id="è¯­è¨€æ¨¡å‹-1">1.1 è¯­è¨€æ¨¡å‹</h2><p>1ã€<strong>è¯­è¨€å»ºæ¨¡</strong>çš„ä»»åŠ¡æ˜¯é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯æ˜¯ä»€ä¹ˆ</p><p>æ›´æ­£å¼çš„è¯´æ³•æ˜¯ï¼šç»™å®šä¸€ä¸ªå•è¯åºåˆ—<spanclass="math inline">\(x^{(1)},x^{(2)},...,x^{(t)}\)</span>ï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªå•è¯<spanclass="math inline">\(x^{(t+1)}\)</span>çš„æ¦‚ç‡åˆ†å¸ƒï¼š <spanclass="math display">\[P(x^{(t+1)}| x^{(t)}, ..., x^{(1)})\]</span></p><ul><li>å…¶ä¸­ï¼Œ<spanclass="math inline">\(x^{(t+1)}\)</span>å¯ä»¥æ˜¯è¯è¡¨ä¸­çš„ä»»æ„å•è¯<spanclass="math inline">\(V={w_1,...,w_v}\)</span></li><li>è¿™æ ·åšçš„ç³»ç»Ÿç§°ä¸º Language Model è¯­è¨€æ¨¡å‹</li></ul><p>2ã€è¿˜å¯ä»¥å°†è¯­è¨€æ¨¡å‹çœ‹ä½œ<strong>è¯„ä¼°ä¸€æ®µæ–‡æœ¬æ˜¯è‡ªç„¶å¥å­ï¼ˆé€šé¡ºåº¦ï¼‰çš„æ¦‚ç‡</strong></p><p>ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€æ®µæ–‡æœ¬<spanclass="math inline">\(x^{(1)},x^{(2)},...,x^{(T)}\)</span>ï¼Œåˆ™è¿™æ®µæ–‡æœ¬çš„æ¦‚ç‡(æ ¹æ®è¯­è¨€æ¨¡å‹)ä¸º<span class="math display">\[\begin{aligned}P\left(\boldsymbol{x}^{(1)}, \ldots, \boldsymbol{x}^{(T)}\right)&amp;=P\left(\boldsymbol{x}^{(1)}\right) \timesP\left(\boldsymbol{x}^{(2)} \mid \boldsymbol{x}^{(1)}\right) \times\cdots \times P\left(\boldsymbol{x}^{(T)} \mid \boldsymbol{x}^{(T-1)},\ldots, \boldsymbol{x}^{(1)}\right) \\&amp;=\prod_{t=1}^{T} P\left(\boldsymbol{x}^{(t)} \mid\boldsymbol{x}^{(t-1)}, \ldots, \boldsymbol{x}^{(1)}\right)\end{aligned}\]</span></p><ul><li>è¯­è¨€æ¨¡å‹æä¾›çš„æ˜¯<span class="math inline">\(\prod_{t=1}^{T}P\left(\boldsymbol{x}^{(t)} \mid \boldsymbol{x}^{(t-1)}, \ldots,\boldsymbol{x}^{(1)}\right)\)</span></li></ul><h2 id="n-gram-è¯­è¨€æ¨¡å‹">1.2 n-gram è¯­è¨€æ¨¡å‹</h2><figure class="highlight fortran"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs fortran">the students <span class="hljs-keyword">opened</span> their __<br></code></pre></div></td></tr></table></figure><p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•å­¦ä¹ ä¸€ä¸ªè¯­è¨€æ¨¡å‹ï¼Ÿ</p><p><strong>å›ç­”</strong>(æ·±åº¦å­¦ä¹ ä¹‹å‰çš„æ—¶æœŸ)ï¼šå­¦ä¹ ä¸€ä¸ª n-gramè¯­è¨€æ¨¡å‹</p><p><strong>å®šä¹‰</strong>ï¼šn-gramæ˜¯ä¸€ä¸ªç”±<spanclass="math inline">\(n\)</span>ä¸ªè¿ç»­å•è¯ç»„æˆçš„å—</p><ul><li><strong>uni</strong>grams: <code>the</code>, <code>students</code>,<code>opened</code>, <code>their</code></li><li><strong>bi</strong>grams: <code>the students</code>,<code>students opened</code>, <code>opened their</code></li><li><strong>tri</strong>grams: <code>the students opened</code>,<code>students opened their</code></li><li><strong>4-</strong>grams:<code>the students opened their</code></li></ul><p><strong>æƒ³æ³•</strong>ï¼šæ”¶é›†å…³äºä¸åŒ n-gramå‡ºç°é¢‘ç‡çš„ç»Ÿè®¡æ•°æ®ï¼Œå¹¶ä½¿ç”¨è¿™äº›æ•°æ®é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬åšä¸€ä¸ªç®€åŒ–å‡è®¾ï¼š<spanclass="math inline">\(x^{(t+1)}\)</span>åªä¾èµ–äºå‰é¢çš„<spanclass="math inline">\(n-1\)</span>ä¸ªå•è¯ <span class="math display">\[P\left(\boldsymbol{x}^{(t+1)} \mid \boldsymbol{x}^{(t)}, \ldots,\boldsymbol{x}^{(1)}\right)=P(\boldsymbol{x}^{(t+1)} \mid\overbrace{\left.\boldsymbol{x}^{(t)}, \ldots,\boldsymbol{x}^{(t-n+2)}\right)}^{n-1 \text { words }}\]</span> <strong>é—®é¢˜</strong>ï¼šå¦‚ä½•å¾—åˆ°n-gramå’Œ(n-1)-gramçš„æ¦‚ç‡ï¼Ÿ</p><p><strong>å›ç­”</strong>ï¼šé€šè¿‡åœ¨ä¸€äº›å¤§å‹æ–‡æœ¬è¯­æ–™åº“ä¸­è®¡ç®—å®ƒä»¬(ç»Ÿè®¡è¿‘ä¼¼)<span class="math display">\[\approx \frac{\operatorname{count}\left(\boldsymbol{x}^{(t+1)},\boldsymbol{x}^{(t)}, \ldots,\boldsymbol{x}^{(t-n+2)}\right)}{\operatorname{count}\left(\boldsymbol{x}^{(t)},\ldots, \boldsymbol{x}^{(t-n+2)}\right)}\]</span></p><h2 id="n-gram-è¯­è¨€æ¨¡å‹ç¤ºä¾‹">1.3 n-gram è¯­è¨€æ¨¡å‹ï¼šç¤ºä¾‹</h2><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨å­¦ä¹ ä¸€ä¸ª <strong>4-gram</strong> çš„è¯­è¨€æ¨¡å‹</p><p><code>as the proctor started the clock, the students opened their ____</code>æˆ‘ä»¬åªéœ€è¦è€ƒè™‘<code>students opened their _____</code></p><ul><li>ä¾‹å¦‚ï¼Œå‡è®¾åœ¨è¯­æ–™åº“ä¸­ï¼š<ul><li><code>students opened their</code> å‡ºç°äº†1000æ¬¡</li><li><code>students opened their books</code> å‡ºç°äº†400æ¬¡</li></ul></li></ul><p><span class="math display">\[P(books|students \ opened \ their) = 0.4\]</span></p><ul><li><code>students opened their exams</code> å‡ºç°äº†100æ¬¡</li></ul><p><span class="math display">\[P(exams|students \ opened \ their) = 0.1\]</span></p><ul><li>æˆ‘ä»¬åº”è¯¥å¿½è§†ä¸Šä¸‹æ–‡ä¸­çš„proctorå—ï¼Ÿ<ul><li>åœ¨æœ¬ä¾‹ä¸­ï¼Œä¸Šä¸‹æ–‡é‡Œå‡ºç°äº† <code>proctor</code>ï¼Œæ‰€ä»¥<code>exams</code> åœ¨è¿™é‡Œçš„ä¸Šä¸‹æ–‡ä¸­åº”è¯¥æ˜¯æ¯” <code>books</code>æ¦‚ç‡æ›´å¤§çš„ã€‚</li></ul></li></ul><h2 id="n-gramè¯­è¨€æ¨¡å‹çš„ç¨€ç–æ€§é—®é¢˜">1.4 n-gramè¯­è¨€æ¨¡å‹çš„ç¨€ç–æ€§é—®é¢˜</h2><p><strong>é—®é¢˜1</strong>ï¼šå¦‚æœ<code>students open their ww</code>ä»æœªå‡ºç°åœ¨æ•°æ®ä¸­ï¼Œé‚£ä¹ˆæ¦‚ç‡å€¼ä¸º0</p><ul><li>(Partial)<strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šä¸ºæ¯ä¸ª<spanclass="math inline">\(w\in V\)</span>æ·»åŠ æå°æ•°<spanclass="math inline">\(\delta\)</span>ï¼Œè¿™å«åšå¹³æ»‘ã€‚è¿™ä½¿å¾—è¯è¡¨ä¸­çš„æ¯ä¸ªå•è¯éƒ½è‡³å°‘æœ‰å¾ˆå°çš„æ¦‚ç‡ã€‚</li></ul><p><strong>é—®é¢˜2</strong>ï¼šå¦‚æœ<code>students open their</code>ä»æœªå‡ºç°åœ¨æ•°æ®ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†æ— æ³•è®¡ç®—ä»»ä½•å•è¯<spanclass="math inline">\(w\)</span>çš„æ¦‚ç‡å€¼</p><ul><li><p>(Partial)<strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šå°†æ¡ä»¶æ”¹ä¸º<code>open their</code>ï¼Œä¹Ÿå«åšåé€€å¤„ç†ã€‚</p></li><li><p>Note/æ³¨æ„: <spanclass="math inline">\(n\)</span>çš„å¢åŠ ä½¿ç¨€ç–æ€§é—®é¢˜å˜å¾—æ›´ç³Ÿã€‚ä¸€èˆ¬æƒ…å†µä¸‹<spanclass="math inline">\(n\)</span>ä¸èƒ½å¤§äº5ã€‚</p></li></ul><h2 id="n-gramè¯­è¨€æ¨¡å‹çš„å­˜å‚¨é—®é¢˜">1.5 n-gramè¯­è¨€æ¨¡å‹çš„å­˜å‚¨é—®é¢˜</h2><p><strong>é—®é¢˜</strong>ï¼šéœ€è¦å­˜å‚¨ä½ åœ¨è¯­æ–™åº“ä¸­çœ‹åˆ°çš„æ‰€æœ‰ n-gramsçš„è®¡æ•°</p><p>å¢åŠ <spanclass="math inline">\(n\)</span>æˆ–å¢åŠ è¯­æ–™åº“éƒ½ä¼šå¢åŠ æ¨¡å‹å¤§å°</p><h2 id="n-gramè¯­è¨€æ¨¡å‹çš„ç”Ÿæˆæ–‡æœ¬">1.6 n-gramè¯­è¨€æ¨¡å‹çš„ç”Ÿæˆæ–‡æœ¬</h2><ul><li><p>å¯ä»¥ä½¿ç”¨è¯­è¨€æ¨¡å‹æ¥ç”Ÿæˆæ–‡æœ¬</p></li><li><p>ä½¿ç”¨trigramè¿è¡Œä»¥ä¸Šç”Ÿæˆè¿‡ç¨‹æ—¶ï¼Œä¼šå¾—åˆ°ä¸Šå›¾å·¦ä¾§çš„æ–‡æœ¬</p></li><li><p>ä»¤äººæƒŠè®¶çš„æ˜¯å…¶å…·æœ‰è¯­æ³•ä½†æ˜¯æ˜¯ä¸è¿è´¯çš„ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å¾ˆå¥½åœ°æ¨¡æ‹Ÿè¯­è¨€ï¼Œæˆ‘ä»¬éœ€è¦åŒæ—¶è€ƒè™‘ä¸‰ä¸ªä»¥ä¸Šçš„å•è¯ã€‚ä½†å¢åŠ <spanclass="math inline">\(n\)</span>ä½¿æ¨¡å‹çš„ç¨€ç–æ€§é—®é¢˜æ¶åŒ–ï¼Œæ¨¡å‹å°ºå¯¸å¢å¤§</p></li></ul><h2 id="å¦‚ä½•æ­å»ºä¸€ä¸ªç¥ç»è¯­è¨€æ¨¡å‹">1.7 å¦‚ä½•æ­å»ºä¸€ä¸ªç¥ç»è¯­è¨€æ¨¡å‹ï¼Ÿ</h2><p>å›å¿†ä¸€ä¸‹è¯­è¨€æ¨¡å‹ä»»åŠ¡</p><ul><li><strong>è¾“å…¥</strong>ï¼šå•è¯åºåˆ—<span class="math inline">\(x^{(1)},x^{(2)}, ...,x^{(t)}\)</span></li><li><strong>è¾“å‡º</strong>ï¼šä¸‹ä¸€æ¬¡å•è¯çš„æ¦‚ç‡<spanclass="math inline">\(P\left(\boldsymbol{x}^{(t+1)} \mid\boldsymbol{x}^{(t)}, \ldots, \boldsymbol{x}^{(1)}\right)\)</span></li></ul><p><img src="/img/nlp/ç¬¬å…­è®²/1.png" /></p><h2 id="å›ºå®šçª—å£çš„ç¥ç»è¯­è¨€æ¨¡å‹">1.8 å›ºå®šçª—å£çš„ç¥ç»è¯­è¨€æ¨¡å‹</h2><p><img src="/img/nlp/ç¬¬å…­è®²/2.png" /></p><p>è¶…è¶Š n-gram è¯­è¨€æ¨¡å‹çš„<strong>æ”¹è¿›</strong></p><ul><li>æ²¡æœ‰ç¨€ç–æ€§é—®é¢˜</li><li>ä¸éœ€è¦è§‚å¯Ÿåˆ°æ‰€æœ‰çš„n-grams</li></ul><p>NNLMå­˜åœ¨çš„<strong>é—®é¢˜</strong></p><ul><li>å›ºå®šçª—å£å¤ªå°</li><li>æ‰©å¤§çª—å£å°±éœ€è¦æ‰©å¤§æƒé‡çŸ©é˜µ<spanclass="math inline">\(W\)</span></li><li>çª—å£å†å¤§ä¹Ÿä¸å¤Ÿç”¨</li><li><span class="math inline">\(x^{(1)}\)</span>å’Œ<spanclass="math inline">\(x^{(2)}\)</span>ä¹˜ä»¥å®Œå…¨ä¸åŒçš„æƒé‡ã€‚è¾“å…¥çš„å¤„ç†ä¸å¯¹ç§°</li></ul><p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç¥ç»ç»“æ„ï¼Œå¯ä»¥å¤„ç†ä»»ä½•é•¿åº¦çš„è¾“å…¥</p><h1 id="å¾ªç¯ç¥ç»ç½‘ç»œrnn">2.å¾ªç¯ç¥ç»ç½‘ç»œ(RNN)</h1><h2 id="å¾ªç¯ç¥ç»ç½‘ç»œrnn-1">2.1 å¾ªç¯ç¥ç»ç½‘ç»œ(RNN)</h2><p><img src="/img/nlp/ç¬¬å…­è®²/3.png" /></p><p><img src="/img/nlp/ç¬¬å…­è®²/4.png" /></p><ul><li>RNNçš„ä¼˜ç‚¹<ul><li>å¯ä»¥å¤„ç†<strong>ä»»æ„é•¿åº¦</strong>çš„è¾“å…¥</li><li>æ­¥éª¤<spanclass="math inline">\(t\)</span>çš„è®¡ç®—(ç†è®ºä¸Š)å¯ä»¥ä½¿ç”¨<strong>è®¸å¤šæ­¥éª¤å‰</strong>çš„ä¿¡æ¯</li><li><strong>æ¨¡å‹å¤§å°ä¸ä¼š</strong>éšç€è¾“å…¥çš„å¢åŠ è€Œ<strong>å¢åŠ </strong></li><li>åœ¨æ¯ä¸ªæ—¶é—´æ­¥ä¸Šåº”ç”¨ç›¸åŒçš„æƒé‡ï¼Œå› æ­¤åœ¨å¤„ç†è¾“å…¥æ—¶å…·æœ‰<strong>å¯¹ç§°æ€§</strong></li></ul></li><li>RNNçš„ç¼ºç‚¹<ul><li>å¾ªç¯ä¸²è¡Œè®¡ç®—é€Ÿåº¦æ…¢</li><li>åœ¨å®è·µä¸­ï¼Œå¾ˆéš¾ä»è®¸å¤šæ­¥éª¤å‰è¿”å›ä¿¡æ¯</li></ul></li></ul><h2 id="è®­ç»ƒä¸€ä¸ªrnnè¯­è¨€æ¨¡å‹">2.2 è®­ç»ƒä¸€ä¸ªRNNè¯­è¨€æ¨¡å‹</h2><p>è·å–ä¸€ä¸ª<strong>è¾ƒå¤§çš„æ–‡æœ¬è¯­æ–™åº“</strong>ï¼Œè¯¥è¯­æ–™åº“æ˜¯ä¸€ä¸ªå•è¯åºåˆ—</p><p>è¾“å…¥RNN-LMï¼›è®¡ç®—æ¯ä¸ªæ­¥éª¤çš„è¾“å‡ºåˆ†å¸ƒ</p><ul><li>å³é¢„æµ‹åˆ°ç›®å‰ä¸ºæ­¢ç»™å®šçš„æ¯ä¸ªå•è¯çš„æ¦‚ç‡åˆ†å¸ƒ</li></ul><p>æ­¥éª¤<spanclass="math inline">\(t\)</span>ä¸Šçš„<strong>æŸå¤±å‡½</strong>æ•°ä¸ºé¢„æµ‹æ¦‚ç‡åˆ†å¸ƒ<spanclass="math inline">\(\hat{y}^{(t)}\)</span>ä¸çœŸå®ä¸‹ä¸€ä¸ªå•è¯<spanclass="math inline">\(y^{(t)}\)</span>(<spanclass="math inline">\(x^{(t+1)}\)</span>çš„ç‹¬çƒ­å‘é‡)ä¹‹é—´çš„<strong>äº¤å‰ç†µ</strong><span class="math display">\[J^{(t)}(\theta)=C E\left(\boldsymbol{y}^{(t)},\hat{\boldsymbol{y}}^{(t)}\right)=-\sum_{w \in V}\boldsymbol{y}_{w}^{(t)} \log \hat{\boldsymbol{y}}_{w}^{(t)}=-\log\hat{\boldsymbol{y}}_{\boldsymbol{x}_{t+1}}^{(t)}\]</span> å°†å…¶å¹³å‡ï¼Œå¾—åˆ°æ•´ä¸ªè®­ç»ƒé›†çš„<strong>æ€»ä½“æŸå¤±</strong> <spanclass="math display">\[J(\theta)=\frac{1}{T} \sum_{t=1}^{T} J^{(t)}(\theta)=\frac{1}{T}\sum_{t=1}^{T}-\log \hat{\boldsymbol{y}}_{\boldsymbol{x}_{t+1}}^{(t)}\]</span> <img src="/img/nlp/ç¬¬å…­è®²/5.png" /></p><p>ç„¶è€Œï¼šè®¡ç®—æ•´ä¸ªè¯­æ–™åº“<spanclass="math inline">\(x^{(1)},...,x^{(T)}\)</span>çš„æŸå¤±å’Œæ¢¯åº¦å¤ªæ˜‚è´µäº†ï¼Œæ‰€ä»¥åœ¨å®è·µä¸­é€šå¸¸æŠŠ<spanclass="math inline">\(x^{(1)},...,x^{(T)}\)</span>çœ‹æˆä¸€ä¸ªå¥å­æˆ–æ˜¯æ–‡æ¡£</p><p>å›å¿†ï¼šéšæœºæ¢¯åº¦ä¸‹é™å…è®¸æˆ‘ä»¬è®¡ç®—å°å—æ•°æ®çš„æŸå¤±å’Œæ¢¯åº¦ï¼Œå¹¶è¿›è¡Œæ›´æ–°</p><p>è®¡ç®—ä¸€ä¸ªå¥å­çš„æŸå¤±<spanclass="math inline">\(J(\theta)\)</span>(å®é™…ä¸Šæ˜¯ä¸€æ‰¹å¥å­)ï¼Œè®¡ç®—æ¢¯åº¦å’Œæ›´æ–°æƒé‡ã€‚é‡å¤ä¸Šè¿°æ“ä½œã€‚</p><h2 id="rnnçš„åå‘ä¼ æ’­">2.3 RNNçš„åå‘ä¼ æ’­</h2><p><strong>é—®é¢˜</strong>ï¼šå…³äºé‡å¤çš„æƒé‡çŸ©é˜µ<spanclass="math inline">\(W_h\)</span>çš„åå¯¼æ•°<spanclass="math inline">\(J^{(t)}(\theta)\)</span></p><p><strong>å›ç­”</strong>ï¼šé‡å¤æƒé‡çš„æ¢¯åº¦æ˜¯æ¯æ¬¡å…¶å‡ºç°æ—¶çš„æ¢¯åº¦çš„æ€»å’Œ <spanclass="math display">\[\frac{\partial J^{(t)}}{\partial\boldsymbol{W}_{\boldsymbol{h}}}=\left.\sum_{i=1}^{t} \frac{\partialJ^{(t)}}{\partial \boldsymbol{W}_{\boldsymbol{h}}}\right|_{(i)}\]</span> <img src="/img/nlp/ç¬¬å…­è®²/6.png" /></p><p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•è®¡ç®—ï¼Ÿ</p><p><strong>å›ç­”</strong>ï¼šåå‘ä¼ æ’­çš„æ—¶é—´æ­¥é•¿<spanclass="math inline">\(i=t,...,0\)</span>ã€‚ç´¯åŠ æ¢¯åº¦ã€‚è¿™ä¸ªç®—æ³•å«åšâ€œbackpropagation through timeâ€</p><h2 id="rnnè¯­è¨€æ¨¡å‹çš„ç”Ÿæˆæ–‡æœ¬">2.4 RNNè¯­è¨€æ¨¡å‹çš„ç”Ÿæˆæ–‡æœ¬</h2><p>å°±åƒn-gramè¯­è¨€æ¨¡å‹ä¸€æ ·ï¼Œä½ å¯ä»¥ä½¿ç”¨RNNè¯­è¨€æ¨¡å‹é€šè¿‡é‡å¤é‡‡æ ·æ¥ç”Ÿæˆæ–‡æœ¬ã€‚é‡‡æ ·è¾“å‡ºæ˜¯ä¸‹ä¸€æ­¥çš„è¾“å…¥ã€‚</p><p><img src="/img/nlp/ç¬¬å…­è®²/7.png" /></p><h1 id="è¯„ä¼°è¯­è¨€æ¨¡å‹">3.è¯„ä¼°è¯­è¨€æ¨¡å‹</h1><h2 id="è¯„ä¼°è¯­è¨€æ¨¡å‹-1">3.1 è¯„ä¼°è¯­è¨€æ¨¡å‹</h2><p>æ ‡å‡†è¯­è¨€æ¨¡å‹è¯„ä¼°æŒ‡æ ‡æ˜¯ perplexity å›°æƒ‘åº¦è¿™ç­‰äºäº¤å‰ç†µæŸå¤±<spanclass="math inline">\(J(\theta)\)</span>çš„æŒ‡æ•° <spanclass="math display">\[=\prod_{t=1}^{T}\left(\frac{1}{\hat{y}_{x_{t+1}}^{(t)}}\right)^{1 /T}=\exp \left(\frac{1}{T} \sum_{t=1}^{T}-\log\hat{\boldsymbol{y}}_{\boldsymbol{x}_{t+1}}^{(t)}\right)=\exp(J(\theta))\]</span> å›°æƒ‘åº¦è¶Šä½æ•ˆæœè¶Šå¥½</p><h2 id="rnnæå¤§åœ°æ”¹å–„äº†å›°æƒ‘åº¦">3.2 RNNæå¤§åœ°æ”¹å–„äº†å›°æƒ‘åº¦</h2><p>è¯­è¨€æ¨¡å‹æ˜¯ä¸€é¡¹åŸºå‡†æµ‹è¯•ä»»åŠ¡ï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬è¡¡é‡æˆ‘ä»¬åœ¨ç†è§£è¯­è¨€æ–¹é¢çš„è¿›å±•</p><ul><li>ç”Ÿæˆä¸‹ä¸€ä¸ªå•è¯ï¼Œéœ€è¦è¯­æ³•ï¼Œå¥æ³•ï¼Œé€»è¾‘ï¼Œæ¨ç†ï¼Œç°å®ä¸–ç•Œçš„çŸ¥è¯†ç­‰</li></ul><p>è¯­è¨€å»ºæ¨¡æ˜¯è®¸å¤šNLPä»»åŠ¡çš„å­ç»„ä»¶ï¼Œå°¤å…¶æ˜¯é‚£äº›æ¶‰åŠç”Ÿæˆæ–‡æœ¬æˆ–ä¼°è®¡æ–‡æœ¬æ¦‚ç‡çš„ä»»åŠ¡</p><ul><li>é¢„æµ‹æ€§æ‰“å­—ã€è¯­éŸ³è¯†åˆ«ã€æ‰‹å†™è¯†åˆ«ã€æ‹¼å†™/è¯­æ³•çº æ­£ã€ä½œè€…è¯†åˆ«ã€æœºå™¨ç¿»è¯‘ã€æ‘˜è¦ã€å¯¹è¯ç­‰ç­‰</li></ul><h2 id="è¦ç‚¹å›é¡¾">3.3 è¦ç‚¹å›é¡¾</h2><p><strong>è¯­è¨€æ¨¡å‹</strong>ï¼ˆLM: LanguageModelï¼‰ï¼šé¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯çš„ç³»ç»Ÿ</p><p>å¾ªç¯ç¥ç»ç½‘ç»œï¼šä¸€ç³»åˆ—ç¥ç»ç½‘ç»œ</p><ul><li>é‡‡ç”¨ä»»æ„é•¿åº¦çš„é¡ºåºè¾“å…¥</li><li>åœ¨æ¯ä¸€æ­¥ä¸Šåº”ç”¨ç›¸åŒçš„æƒé‡</li><li>å¯ä»¥é€‰æ‹©åœ¨æ¯ä¸€æ­¥ä¸Šç”Ÿæˆè¾“å‡º</li></ul><p>å¾ªç¯ç¥ç»ç½‘ç»œ<spanclass="math inline">\(\ne\)</span>è¯­è¨€æ¨¡å‹ï¼Œæˆ‘ä»¬å·²ç»è¯æ˜ï¼ŒRNNsæ˜¯æ„å»ºLMçš„ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ³•ï¼Œä½†RNNsçš„ç”¨å¤„è¦å¤§å¾—å¤š!</p><h2 id="rnnå¯ç”¨äºæ‰“æ ‡ç­¾">3.4 RNNå¯ç”¨äºæ‰“æ ‡ç­¾</h2><p><img src="/img/nlp/ç¬¬å…­è®²/8.png" /></p><h2 id="rnnå¯ç”¨äºå¥å­åˆ†ç±»">3.5 RNNå¯ç”¨äºå¥å­åˆ†ç±»</h2><p>å¦‚ä½•è®¡ç®—å¥å­ç¼–ç </p><p><strong>åŸºç¡€æ–¹å¼</strong>ï¼šä½¿ç”¨æœ€ç»ˆéšå±‚çŠ¶æ€</p><p><img src="/img/nlp/ç¬¬å…­è®²/9.png" /></p><p>é€šå¸¸æ›´å¥½çš„æ–¹å¼ï¼šä½¿ç”¨æ‰€æœ‰éšå±‚çŠ¶æ€çš„é€å…ƒç´ æœ€å€¼æˆ–å‡å€¼ï¼ŒEncoderçš„ç»“æ„åœ¨NLPä¸­éå¸¸å¸¸è§</p><p><img src="/img/nlp/ç¬¬å…­è®²/10.png" /></p><h2 id="rnnè¯­è¨€æ¨¡å‹å¯ç”¨äºç”Ÿæˆæ–‡æœ¬">3.6 RNNè¯­è¨€æ¨¡å‹å¯ç”¨äºç”Ÿæˆæ–‡æœ¬</h2><p>è¿™æ˜¯ä¸€ä¸ªæ¡ä»¶è¯­è¨€æ¨¡å‹çš„ç¤ºä¾‹ã€‚æˆ‘ä»¬ä½¿ç”¨è¯­è¨€æ¨¡å‹ç»„ä»¶ï¼Œå¹¶ä¸”æœ€å…³é”®çš„æ˜¯ï¼Œæˆ‘ä»¬æ ¹æ®æ¡ä»¶æ¥è°ƒæ•´å®ƒ</p><p><img src="/img/nlp/ç¬¬å…­è®²/11.png" /></p><p>å‚è€ƒï¼š</p><p>http://www.showmeai.tech/article-detail/240</p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬äº”è®²-å¥æ³•åˆ†æä¸ä¾å­˜è§£æ</title>
    <link href="/2022/05/12/%E7%AC%AC%E4%BA%94%E8%AE%B2-%E5%8F%A5%E6%B3%95%E5%88%86%E6%9E%90%E4%B8%8E%E4%BE%9D%E5%AD%98%E8%A7%A3%E6%9E%90/"/>
    <url>/2022/05/12/%E7%AC%AC%E4%BA%94%E8%AE%B2-%E5%8F%A5%E6%B3%95%E5%88%86%E6%9E%90%E4%B8%8E%E4%BE%9D%E5%AD%98%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="å¥æ³•ç»“æ„æˆåˆ†ä¸ä¾èµ–">1.å¥æ³•ç»“æ„ï¼šæˆåˆ†ä¸ä¾èµ–</h1><h2 id="è¯­è¨€ç»“æ„çš„ä¸¤ç§è§‚ç‚¹æ— ä¸Šä¸‹æ–‡è¯­æ³•">1.1è¯­è¨€ç»“æ„çš„ä¸¤ç§è§‚ç‚¹ï¼šæ— ä¸Šä¸‹æ–‡è¯­æ³•</h2><p>å¥å­æ˜¯ä½¿ç”¨é€æ­¥åµŒå¥—çš„å•å…ƒæ„å»ºçš„</p><ul><li>å¯ä»¥é€šè¿‡CFGï¼ˆcontext-free grammars æ— ä¸Šä¸‹æ–‡è¯­æ³•ï¼‰è§„åˆ™è¡¨ç¤ºè¯­æ³•</li></ul><p><strong>èµ·æ­¥å•å…ƒ</strong>ï¼šå•è¯è¢«èµ‹äºˆä¸€ä¸ªç±»åˆ«ï¼ˆpart of speech = posè¯æ€§ï¼‰</p><ul><li>the, cat, cuddly, by, door</li><li>Det, N, Adj, P, N</li></ul><p><strong>å•è¯</strong>æŒ‰ç±»åˆ«ç»„åˆæˆ<strong>çŸ­è¯­</strong></p><ul><li>the cuddly cat ï¼šNP =&gt; Det Adj N</li><li>by the door ï¼šPP =&gt;P N P</li></ul><p><strong>çŸ­è¯­</strong>å¯ä»¥é€’å½’åœ°ç»„åˆæˆ<strong>æ›´å¤§çš„çŸ­è¯­</strong></p><ul><li>the cuddly cat by the doorï¼š=&gt; NP â†’ NP PP</li></ul><p>è¡¥å……ï¼š</p><ul><li><strong>Det</strong> æŒ‡çš„æ˜¯<code>Determiner</code>ï¼Œåœ¨è¯­è¨€å­¦ä¸­çš„å«ä¹‰ä¸º <strong>é™å®šè¯</strong></li><li><strong>NP</strong> æŒ‡çš„æ˜¯<code>Noun Phrase</code>ï¼Œåœ¨è¯­è¨€å­¦ä¸­çš„å«ä¹‰ä¸º<strong>åè¯çŸ­è¯­</strong></li><li><strong>VP</strong> æŒ‡çš„æ˜¯<code>Verb Phrase</code>ï¼Œåœ¨è¯­è¨€å­¦ä¸­çš„å«ä¹‰ä¸º<strong>åŠ¨è¯çŸ­è¯­</strong></li><li><strong>P</strong> æŒ‡çš„æ˜¯<code>Preposition</code>ï¼Œåœ¨è¯­è¨€å­¦ä¸­çš„å«ä¹‰ä¸º <strong>ä»‹è¯</strong></li><li><strong>PP</strong> æŒ‡çš„æ˜¯<code>Prepositional Phrase</code>ï¼Œåœ¨è¯­è¨€å­¦ä¸­çš„å«ä¹‰ä¸º<strong>ä»‹è¯çŸ­è¯­</strong></li></ul><p><img src="/img/nlp/ç¬¬äº”è®²/1.png" /></p><h2 id="è¯­è¨€ç»“æ„çš„ä¸¤ç§è§‚ç‚¹ä¾èµ–ç»“æ„">1.2è¯­è¨€ç»“æ„çš„ä¸¤ç§è§‚ç‚¹ï¼šä¾èµ–ç»“æ„</h2><p>ä¸æ˜¯ä½¿ç”¨å„ç§ç±»å‹çš„çŸ­è¯­ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡å•è¯ä¸å…¶ä»–çš„å•è¯å…³ç³»è¡¨ç¤ºå¥å­çš„ç»“æ„ï¼Œæ˜¾ç¤ºå“ªäº›å•è¯ä¾èµ–äº(ä¿®é¥°æˆ–æ˜¯å…¶å‚æ•°)å“ªäº›å…¶ä»–å•è¯</p><p><img src="/img/nlp/ç¬¬äº”è®²/2.png" /></p><ul><li><p>lookæ˜¯æ•´ä¸ªå¥å­çš„æ ¹æºï¼Œlookä¾èµ–äºcrate(æˆ–è€…è¯´crateæ˜¯lookçš„ä¾èµ–</p><ul><li><p><code>in</code>ï¼Œ<code>the</code>ï¼Œ<code>large</code> éƒ½æ˜¯<code>crate</code> çš„ä¾èµ–</p></li><li><p><code>in the kitchen</code> æ˜¯ <code>crate</code> çš„ä¿®é¥°</p></li><li><p><code>in</code>ï¼Œ<code>the</code> éƒ½æ˜¯ <code>kitchen</code>çš„ä¾èµ–</p></li><li><p><code>by the door</code> æ˜¯ <code>crate</code> çš„ä¾èµ–</p></li></ul></li></ul><h2 id="ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å¥å­ç»“æ„">1.3 ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å¥å­ç»“æ„ï¼Ÿ</h2><p>ä¸ºäº†èƒ½å¤Ÿæ­£ç¡®åœ°è§£é‡Šè¯­è¨€ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£å¥å­ç»“æ„</p><p>äººç±»é€šè¿‡å°†å•è¯ç»„åˆæˆæ›´å¤§çš„å•å…ƒæ¥ä¼ è¾¾å¤æ‚çš„æ„æ€ï¼Œä»è€Œäº¤æµå¤æ‚çš„æ€æƒ³</p><p>æˆ‘ä»¬éœ€è¦çŸ¥é“ä»€ä¹ˆä¸ä»€ä¹ˆç›¸å…³è”</p><h2 id="ä»‹è¯çŸ­è¯­ä¾é™„æ­§ä¹‰">1.4 ä»‹è¯çŸ­è¯­ä¾é™„æ­§ä¹‰</h2><p>1ã€<code>San Jose cops kill man with knife</code></p><ul><li>è­¦å¯Ÿç”¨åˆ€æ€äº†é‚£ä¸ªç”·å­<ul><li><code>cops</code> æ˜¯ <code>kill</code> çš„ <code>subject</code>(subject æŒ‡ <strong>ä¸»è¯­</strong>)</li><li><code>man</code> æ˜¯ <code>kill</code> çš„ <code>object</code> (objectæŒ‡ <strong>å®¾è¯­</strong>)</li><li><code>knife</code> æ˜¯ <code>kill</code> çš„ <code>modifier</code>(modifier æŒ‡ <strong>ä¿®é¥°ç¬¦</strong>)</li></ul></li><li>è­¦å¯Ÿæ€äº†é‚£ä¸ªæœ‰åˆ€çš„ç”·å­<ul><li><code>knife</code> æ˜¯ <code>man</code> çš„ <code>modifier</code>(åè¯ä¿®é¥°ç¬¦ï¼Œç®€ç§°ä¸º <code>nmod</code>)</li></ul></li></ul><p>2ã€<code>Scientists count whales from space</code></p><ul><li><code>from space</code>è¿™ä¸€ä»‹è¯çŸ­è¯­ä¿®é¥°çš„æ˜¯å‰é¢çš„åŠ¨è¯<code>count</code>è¿˜æ˜¯åè¯<code>whales</code>?<ul><li>è¿™å°±æ˜¯äººç±»è¯­è¨€å’Œç¼–ç¨‹è¯­è¨€ä¸­ä¸åŒçš„åœ°æ–¹</li></ul></li></ul><h2 id="ä»‹è¯çŸ­è¯­é™„åŠ æ­§ä¹‰æˆå€å¢åŠ ">1.5 ä»‹è¯çŸ­è¯­é™„åŠ æ­§ä¹‰æˆå€å¢åŠ </h2><p>å…³é”®çš„è§£æå†³ç­–æ˜¯æˆ‘ä»¬å¦‚ä½•â€œä¾å­˜â€å„ç§æˆåˆ†</p><ul><li>ä»‹è¯çŸ­è¯­ã€çŠ¶è¯­æˆ–åˆ†è¯çŸ­è¯­ã€ä¸å®šå¼ã€åè°ƒç­‰ã€‚</li></ul><p><code>The board approved [ its acquisition ] [ by Royal Trustco Ltd. ] [ of Toronto ] [ for $27 a share ] [ at its monthly meeting ].</code></p><ul><li><code>board</code> æ˜¯ <code>approved</code>çš„ä¸»è¯­ï¼Œ<code>acquisition</code> æ˜¯ <code>approved</code> çš„è°“è¯­</li><li><code>by Royal Trustco Ltd.</code> æ˜¯ä¿®é¥° <code>acquisition</code>çš„ï¼Œå³è‘£äº‹ä¼šæ‰¹å‡†äº†è¿™å®¶å…¬å¸çš„æ”¶è´­</li><li><code>of Toronto</code> å¯ä»¥ä¿®é¥°<code>approved</code>ï¼Œ<code>acquisition</code>ï¼Œ<code>Royal Trustco Ltd.</code>ä¹‹ä¸€ï¼Œç»è¿‡åˆ†æå¯ä»¥å¾—çŸ¥æ˜¯ä¿®é¥°<code>Royal Trustco Ltd.</code>ï¼Œå³è¡¨ç¤ºè¿™å®¶å…¬å¸çš„ä½ç½®</li><li><code>for $27 a share</code> ä¿®é¥° <code>acquisition</code></li><li><code>at its monthly meeting</code> ä¿®é¥°<code>approved</code>ï¼Œå³è¡¨ç¤ºæ‰¹å‡†çš„æ—¶é—´åœ°ç‚¹</li></ul><p>é¢å¯¹è¿™æ ·å¤æ‚çš„å¥å­ç»“æ„ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘ æŒ‡æ•°çº§çš„å¯èƒ½ç»“æ„ï¼Œè¿™ä¸ªåºåˆ—è¢«ç§°ä¸º <strong>å¡ç‰¹å…°æ•°/Catalan numbers</strong><span class="math display">\[C_{n}=(2 n) ! /[(n+1) ! n !]\]</span></p><h2 id="åè°ƒèŒƒå›´æ¨¡ç³Š">1.6 åè°ƒèŒƒå›´æ¨¡ç³Š</h2><p>1ã€<code>Shuttle veteran and longtime NASA executive Fred Gregory appointed to board</code></p><ul><li>ä¸€ä¸ªäººï¼š<code>[[Shuttle veteran and longtime NASA executive] Fred Gregory] appointed to board</code></li><li>ä¸¤ä¸ªäººï¼š<code>[Shuttle veteran] and [longtime NASA executive Fred Gregory] appointed to board</code></li></ul><p>2ã€<code>Students get first hand job experience</code></p><ul><li><code>first hand</code>è¡¨ç¤ºç¬¬ä¸€æ‰‹çš„ï¼Œç›´æ¥çš„ï¼Œå³å­¦ç”Ÿè·å¾—äº†ç›´æ¥çš„å·¥ä½œç»éªŒ<ul><li><code>first</code> æ˜¯ <code>hand</code> çš„å½¢å®¹è¯ä¿®é¥°è¯­(amod)</li></ul></li><li><code>first</code> ä¿®é¥° <code>experience</code>ï¼Œ<code>hand</code>ä¿®é¥° <code>job</code></li></ul><h2 id="åŠ¨è¯çŸ­è¯­vpä¾å­˜æ­§ä¹‰">1.7 åŠ¨è¯çŸ­è¯­(VP)ä¾å­˜æ­§ä¹‰</h2><p><code>Mutilated body washes up on Rio beach to be used for Olympic beach volleyball</code></p><ul><li><code>to be used for Olympic beach volleyball</code> æ˜¯ åŠ¨è¯çŸ­è¯­(VP)</li><li>ä¿®é¥°çš„æ˜¯ <code>body</code> è¿˜æ˜¯ <code>beach</code></li></ul><h1 id="ä¾èµ–è¯­æ³•ä¸æ ‘åº“">2.ä¾èµ–è¯­æ³•ä¸æ ‘åº“</h1><h2 id="è®ºæ–‡è§£è¯»-ä¾èµ–è·¯å¾„è¯†åˆ«è¯­ä¹‰å…³ç³»">2.1 #è®ºæ–‡è§£è¯»#ä¾èµ–è·¯å¾„è¯†åˆ«è¯­ä¹‰å…³ç³»</h2><p><img src="/img/nlp/ç¬¬äº”è®²/3.png" /></p><h2 id="ä¾å­˜æ–‡æ³•å’Œä¾å­˜ç»“æ„">2.2 ä¾å­˜æ–‡æ³•å’Œä¾å­˜ç»“æ„</h2><p>å…³è”è¯­æ³•å‡è®¾å¥æ³•ç»“æ„åŒ…æ‹¬è¯æ±‡é¡¹ä¹‹é—´çš„å…³ç³»ï¼Œé€šå¸¸æ˜¯äºŒå…ƒä¸å¯¹ç§°å…³ç³»(â€œç®­å¤´â€)ï¼Œç§°ä¸º<strong>ä¾èµ–å…³ç³»</strong></p><p><strong>Dependency Structureæœ‰ä¸¤ç§è¡¨ç°å½¢å¼</strong></p><ol type="1"><li><p><strong>ä¸€ç§æ˜¯ç›´æ¥åœ¨å¥å­ä¸Šæ ‡å‡ºä¾å­˜å…³ç³»ç®­å¤´åŠè¯­æ³•å…³ç³»</strong></p></li><li><p><strong>å¦ä¸€ç§æ˜¯å°†å…¶åšæˆæ ‘çŠ¶æœºæ„(Dependency TreeGraph)</strong></p></li></ol><ul><li>ç®­å¤´é€šå¸¸æ ‡è®°(type)ä¸ºè¯­æ³•å…³ç³»çš„åç§°(ä¸»é¢˜ã€ä»‹è¯å¯¹è±¡ã€appositionç­‰)</li><li>ç®­å¤´è¿æ¥å¤´éƒ¨(head)(è°ƒé€Ÿå™¨ï¼Œä¸Šçº§ï¼Œregent)å’Œä¸€ä¸ªä¾èµ–(ä¿®é¥°è¯ï¼Œä¸‹çº§ï¼Œä¸‹å±)</li><li>é€šå¸¸ï¼Œä¾èµ–å…³ç³»å½¢æˆä¸€æ£µæ ‘(å•å¤´ï¼Œæ— ç¯ï¼Œè¿æ¥å›¾)</li></ul><h2 id="ä¾å­˜è¯­æ³•è§£æå†å²">2.3 ä¾å­˜è¯­æ³•/è§£æå†å²</h2><ul><li>ä¾èµ–ç»“æ„çš„æ¦‚å¿µå¯ä»¥è¿½æº¯åˆ°å¾ˆä¹…ä»¥å‰<ul><li>Paá¹‡iniçš„è¯­æ³•(å…¬å…ƒå‰5ä¸–çºª)</li><li>ä¸€åƒå¹´ï¼Œé˜¿æ‹‰ä¼¯è¯­çš„è¯­æ³•çš„åŸºæœ¬æ–¹æ³•</li></ul></li><li>é€‰åŒº/ä¸Šä¸‹æ–‡æ— å…³æ–‡æ³•æ˜¯ä¸€ä¸ªæ–°å¥‡çš„å‘æ˜<ul><li>20ä¸–çºªå‘æ˜(R.S.Wells,1947; then Chomsky)</li></ul></li><li>ç°ä»£ä¾èµ–å·¥ä½œç»å¸¸æºäº L. TesniÃ¨re(1959)<ul><li>æ˜¯20ä¸–çºªâ€œä¸œæ–¹â€çš„ä¸»å¯¼æ–¹æ³•(ä¿„ç½—æ–¯ï¼Œä¸­å›½ï¼Œâ€¦)<ul><li>æœ‰åˆ©äºæ›´è‡ªç”±çš„è¯­åºè¯­è¨€</li></ul></li></ul></li><li>NLPä¸­æœ€æ—©ç±»å‹çš„è§£æå™¨åœ¨ç¾å›½<ul><li>David Haysæ˜¯ç¾å›½è®¡ç®—è¯­è¨€å­¦çš„åˆ›å§‹äººä¹‹ä¸€ï¼Œä»–å¾ˆæ—©å°±(ç¬¬ä¸€ä¸ª?)æ„å»ºäº†ä¾èµ–è§£æå™¨(Hays1962)</li></ul></li></ul><h2 id="ä¾å­˜è¯­æ³•å’Œä¾èµ–ç»“æ„">2.4 ä¾å­˜è¯­æ³•å’Œä¾èµ–ç»“æ„</h2><ul><li>äººä»¬å¯¹ç®­å¤´æŒ‡å‘çš„æ–¹å¼ä¸ä¸€è‡´ï¼šæœ‰äº›äººæŠŠç®­å¤´æœä¸€ä¸ªæ–¹å‘ç”»ï¼›æœ‰äººæ˜¯åè¿‡æ¥çš„<ul><li>TesniÃ¨re ä»å¤´å¼€å§‹æŒ‡å‘ä¾èµ–ï¼Œæœ¬è¯¾ä½¿ç”¨æ­¤ç§æ–¹å¼</li></ul></li><li>é€šå¸¸æ·»åŠ ä¸€ä¸ªä¼ªæ ¹æŒ‡å‘æ•´ä¸ªå¥å­çš„å¤´éƒ¨ï¼Œè¿™æ ·æ¯ä¸ªå•è¯éƒ½ç²¾ç¡®åœ°ä¾èµ–äºå¦ä¸€ä¸ªèŠ‚ç‚¹</li></ul><p><img src="/img/nlp/ç¬¬äº”è®²/4.png" /></p><h2 id="å¸¦æ³¨é‡Šæ•°æ®çš„å…´èµ·é€šç”¨ä¾å­˜å¥æ³•æ ‘åº“">2.5å¸¦æ³¨é‡Šæ•°æ®çš„å…´èµ·ï¼šé€šç”¨ä¾å­˜å¥æ³•æ ‘åº“</h2><p><img src="/img/nlp/ç¬¬äº”è®²/5.png" /></p><h2 id="å¸¦æ³¨é‡Šæ•°æ®çš„å…´èµ·">2.6 å¸¦æ³¨é‡Šæ•°æ®çš„å…´èµ·</h2><ul><li><p><strong>ä»ä¸€å¼€å§‹ï¼Œæ„å»º treebankä¼¼ä¹æ¯”æ„å»ºè¯­æ³•æ…¢å¾—å¤šï¼Œä¹Ÿæ²¡æœ‰é‚£ä¹ˆæœ‰ç”¨</strong></p></li><li><p>ä½†æ˜¯ treebank ç»™æˆ‘ä»¬æä¾›äº†è®¸å¤šä¸œè¥¿</p><ul><li>å¯é‡ç”¨æ€§<ul><li>è®¸å¤šè§£æå™¨ã€è¯æ€§æ ‡è®°å™¨ç­‰å¯ä»¥æ„å»ºåœ¨å®ƒä¹‹ä¸Š</li><li>è¯­è¨€å­¦çš„å®è´µèµ„æº</li></ul></li><li>å¹¿æ³›çš„è¦†ç›–é¢ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸€äº›ç›´è§‰</li><li>é¢‘ç‡å’Œåˆ†å¸ƒä¿¡æ¯</li><li>ä¸€ç§è¯„ä¼°ç³»ç»Ÿçš„æ–¹æ³•</li></ul></li></ul><h2 id="ä¾èµ–æ¡ä»¶é¦–é€‰é¡¹">2.7 ä¾èµ–æ¡ä»¶é¦–é€‰é¡¹</h2><p><strong>ä¾èµ–é¡¹è§£æçš„ä¿¡æ¯æ¥æºæ˜¯ä»€ä¹ˆ</strong>ï¼Ÿ</p><p>1.<strong>Bilexical affinities</strong> (ä¸¤ä¸ªå•è¯é—´çš„å¯†åˆ‡å…³ç³») -[discussion â†’ issues] æ˜¯çœ‹ä¸Šå»æœ‰é“ç†çš„</p><p>2.<strong>Dependency distance ä¾èµ–è·ç¦»</strong> - ä¸»è¦æ˜¯ä¸ç›¸é‚»è¯</p><p>3.<strong>Intervening material ä»‹äºä¸­é—´çš„ç‰©è´¨</strong> -ä¾èµ–å¾ˆå°‘è·¨è¶Šä»‹äºä¸­é—´çš„åŠ¨è¯æˆ–æ ‡ç‚¹ç¬¦å·</p><p>4.<strong>Valency of heads</strong> - How many dependents on whichside are usual for a head?</p><p><img src="/img/nlp/ç¬¬äº”è®²/6.png" /></p><h2 id="ä¾èµ–å…³ç³»åˆ†æ">2.8 ä¾èµ–å…³ç³»åˆ†æ</h2><ul><li><p>é€šè¿‡ä¸ºæ¯ä¸ªå•è¯é€‰æ‹©å®ƒæ‰€ä¾èµ–çš„å…¶ä»–å•è¯(åŒ…æ‹¬æ ¹)æ¥è§£æä¸€ä¸ªå¥å­</p></li><li><p>é€šå¸¸æœ‰ä¸€äº›é™åˆ¶</p><ul><li>åªæœ‰ä¸€ä¸ªå•è¯æ˜¯ä¾èµ–äºæ ¹çš„</li><li>ä¸å­˜åœ¨å¾ªç¯ Aâ†’Bï¼ŒBâ†’A</li></ul></li><li><p>è¿™ä½¿å¾—ä¾èµ–é¡¹æˆä¸ºæ ‘</p></li><li><p>æœ€åä¸€ä¸ªé—®é¢˜æ˜¯ç®­å¤´æ˜¯å¦å¯ä»¥äº¤å‰(éæŠ•å½±çš„ non-projective)</p><ul><li>æ²¡æœ‰äº¤å‰çš„å°±æ˜¯non-projectice</li></ul></li></ul><p><img src="/img/nlp/ç¬¬äº”è®²/7.png" /></p><h2 id="å°„å½±æ€§">2.9 å°„å½±æ€§</h2><ul><li><p>å®šä¹‰ï¼šå½“å•è¯æŒ‰çº¿æ€§é¡ºåºæ’åˆ—æ—¶ï¼Œæ²¡æœ‰äº¤å‰çš„ä¾èµ–å¼§ï¼Œæ‰€æœ‰çš„å¼§éƒ½åœ¨å•è¯çš„ä¸Šæ–¹</p></li><li><p>ä¸CFGæ ‘å¹¶è¡Œçš„ä¾èµ–å…³ç³»å¿…é¡»æ˜¯æŠ•å½±çš„</p><ul><li>é€šè¿‡å°†æ¯ä¸ªç±»åˆ«çš„ä¸€ä¸ªå­ç±»åˆ«ä½œä¸ºå¤´æ¥å½¢æˆä¾èµ–å…³ç³»</li></ul></li><li><p>ä½†æ˜¯ä¾èµ–ç†è®ºé€šå¸¸å…è®¸éæŠ•å°„ç»“æ„æ¥è§£é‡Šç§»ä½çš„æˆåˆ†</p><ul><li>å¦‚æœæ²¡æœ‰è¿™äº›éæŠ•å°„ä¾èµ–å…³ç³»ï¼Œå°±ä¸å¯èƒ½å¾ˆå®¹æ˜“è·å¾—æŸäº›ç»“æ„çš„è¯­ä¹‰</li></ul></li></ul><h2 id="ä¾å­˜åˆ†ææ–¹æ³•">2.10 ä¾å­˜åˆ†ææ–¹æ³•</h2><p>1.<strong>Dynamic programming</strong></p><ul><li>Eisner(1996)æå‡ºäº†ä¸€ç§å¤æ‚åº¦ä¸º O(n3)çš„èªæ˜ç®—æ³•ï¼Œå®ƒç”Ÿæˆå¤´éƒ¨ä½äºæœ«å°¾è€Œä¸æ˜¯ä¸­é—´çš„è§£æé¡¹</li></ul><p>2.<strong>Graph algorithms</strong></p><ul><li>ä¸ºä¸€ä¸ªå¥å­åˆ›å»ºä¸€ä¸ªæœ€å°ç”Ÿæˆæ ‘</li><li>McDonald et al.â€™s (2005) MSTParserä½¿ç”¨MLåˆ†ç±»å™¨ç‹¬ç«‹åœ°å¯¹ä¾èµ–é¡¹è¿›è¡Œè¯„åˆ†(ä»–ä½¿ç”¨MIRAè¿›è¡Œåœ¨çº¿å­¦ä¹ ï¼Œä½†å®ƒä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ä¸œè¥¿)</li></ul><p>3.<strong>Constraint Satisfaction</strong></p><ul><li>å»æ‰ä¸æ»¡è¶³ç¡¬çº¦æŸçš„è¾¹ Karlsson(1990), etc.</li></ul><p>4.<strong>â€œTransition-based parsingâ€ or â€œdeterministic dependencyparsingâ€</strong></p><ul><li>è‰¯å¥½çš„æœºå™¨å­¦ä¹ åˆ†ç±»å™¨ MaltParser(Nivreet al. 2008)æŒ‡å¯¼ä¸‹çš„ä¾å­˜è´ªå©ªé€‰æ‹©ã€‚å·²è¯æ˜éå¸¸æœ‰æ•ˆã€‚</li></ul><h1 id="åŸºäºè½¬æ¢çš„ä¾å­˜åˆ†ææ¨¡å‹">3.åŸºäºè½¬æ¢çš„ä¾å­˜åˆ†ææ¨¡å‹</h1><h2 id="è®ºæ–‡è§£è¯»-greedy-transition-based-parsing-nivre-2003">3.1#è®ºæ–‡è§£è¯»# Greedy transition-based parsing [Nivre 2003]</h2><ul><li>è´ªå©ªåˆ¤åˆ«ä¾èµ–è§£æå™¨ä¸€ç§ç®€å•å½¢å¼</li><li>è§£æå™¨æ‰§è¡Œä¸€ç³»åˆ—è‡ªåº•å‘ä¸Šçš„æ“ä½œ<ul><li>å¤§è‡´ç±»ä¼¼äºshift-reduceè§£æå™¨ä¸­çš„â€œshiftâ€æˆ–â€œreduceâ€ï¼Œä½†â€œreduceâ€æ“ä½œä¸“é—¨ç”¨äºåˆ›å»ºå¤´åœ¨å·¦æˆ–å³çš„ä¾èµ–é¡¹</li></ul></li><li>è§£æå™¨å¦‚ä¸‹ï¼š<ul><li>æ ˆ<span class="math inline">\(\sigma\)</span>ä»¥ ROOTç¬¦å·å¼€å§‹ï¼Œç”±è‹¥å¹²ç»„<span class="math inline">\(w_i\)</span>æˆ</li><li>ç¼“å­˜<spanclass="math inline">\(\beta\)</span>ä»¥è¾“å…¥åºåˆ—å¼€å§‹ï¼Œç”±è‹¥å¹²<spanclass="math inline">\(w_i\)</span>ç»„æˆ</li><li>ä¸€ä¸ªä¾å­˜å¼§çš„é›†åˆ<spanclass="math inline">\(A\)</span>ï¼Œä¸€å¼€å§‹ä¸ºç©ºã€‚æ¯æ¡è¾¹çš„å½¢å¼æ˜¯<spanclass="math inline">\((w_i,r,w_j)\)</span>ï¼Œå…¶ä¸­<spanclass="math inline">\(r\)</span>æè¿°äº†èŠ‚ç‚¹çš„ä¾å­˜å…³ç³»</li><li>ä¸€ç»„æ“ä½œ</li></ul></li></ul><h2 id="åŸºæœ¬çš„åŸºäºè½¬æ¢çš„ä¾å­˜å…³ç³»è§£æå™¨">3.2åŸºæœ¬çš„åŸºäºè½¬æ¢çš„ä¾å­˜å…³ç³»è§£æå™¨</h2>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬å››è®²-ç¥ç»ç½‘ç»œåå‘ä¼ æ’­ä¸è®¡ç®—å›¾</title>
    <link href="/2022/05/08/%E7%AC%AC%E5%9B%9B%E8%AE%B2-%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD%E4%B8%8E%E8%AE%A1%E7%AE%97%E5%9B%BE/"/>
    <url>/2022/05/08/%E7%AC%AC%E5%9B%9B%E8%AE%B2-%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD%E4%B8%8E%E8%AE%A1%E7%AE%97%E5%9B%BE/</url>
    
    <content type="html"><![CDATA[<h1id="ç®€å•ç¥ç»ç½‘ç»œçš„æ¢¯åº¦çŸ©é˜µä¸å»ºè®®">1.ç®€å•ç¥ç»ç½‘ç»œçš„æ¢¯åº¦çŸ©é˜µä¸å»ºè®®</h1><h2 id="æƒé‡çŸ©é˜µçš„å¯¼æ•°">1.1 æƒé‡çŸ©é˜µçš„å¯¼æ•°</h2><ul><li><p>è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹è®¡ç®—<span class="math inline">\(\frac{\partials}{\partial W}\)</span></p></li><li><p>å†æ¬¡ä½¿ç”¨é“¾å¼æ³•åˆ™:</p></li><li><p><span class="math display">\[\frac{\partial s}{\partial W}=\frac{\partial s}{\partial h}\frac{\partial h}{\partial z} \frac{\partial z}{\partial W}\]</span></p></li><li><p><span class="math display">\[s=u^{T} h, \ \ \ h=f(z),\ \ \ z=Wx+b\]</span></p></li></ul><h2 id="åå‘ä¼ æ’­æ¢¯åº¦æ±‚å¯¼">1.2 åå‘ä¼ æ’­æ¢¯åº¦æ±‚å¯¼</h2><ul><li><p>è¿™ä¸ªå‡½æ•°(ä»ä¸Šæ¬¡å¼€å§‹)</p></li><li><p><span class="math display">\[\frac{\partial s}{\partial W}=\delta \frac{\partial z}{\partialW}=\delta \frac{\partial}{\partial W} W x+b\]</span></p></li><li><p>è€ƒè™‘å•ä¸ªæƒé‡<spanclass="math inline">\(W_{ij}\)</span>çš„å¯¼æ•°</p></li><li><p><span class="math inline">\(W_{ij}\)</span>åªå¯¹<spanclass="math inline">\(z_i\)</span>æœ‰è´¡çŒ®</p></li></ul><p><span class="math display">\[\begin{aligned}\frac{\partial z_{i}}{\partial W_{i j}} &amp;=\frac{\partial}{\partialW_{i j}} W_{i .} x+b_{i} \\&amp;=\frac{\partial}{\partial W_{i j}} \sum_{k=1}^{d} W_{i k}x_{k}=x_{j}\end{aligned}\]</span></p><p><img src="/img/nlp/ç¬¬å››è®²/1.png" /></p><ul><li><p>å¯¹äºå•ä¸ª<spanclass="math inline">\(W_{ij}\)</span>çš„å¯¼æ•°</p></li><li><p><span class="math display">\[\frac{\partial s}{\partial W_{i j}}=\delta_{i} x_{j}\]</span></p></li><li><p>æˆ‘ä»¬æƒ³è¦æ•´ä¸ª<spanclass="math inline">\(W\)</span>çš„æ¢¯åº¦ï¼Œä½†æ˜¯æ¯ç§æƒ…å†µéƒ½æ˜¯ä¸€æ ·çš„</p></li><li><p>è§£å†³æ–¹æ³•ï¼š<strong>å¤–ç§¯</strong></p></li><li><p><span class="math display">\[\begin{aligned}\frac{\partial s}{\partial W} &amp;=\delta^{T} x^{T} \\{[n \times m] } &amp;=[n \times 1][1 \times m]\end{aligned}\]</span></p></li></ul><h2 id="ä¸ºçª—å£æ¨¡å‹æ¨å¯¼æ¢¯åº¦">1.3 ä¸ºçª—å£æ¨¡å‹æ¨å¯¼æ¢¯åº¦</h2><ul><li><p>åˆ°è¾¾å¹¶æ›´æ–°å•è¯å‘é‡çš„æ¢¯åº¦å¯ä»¥ç®€å•åœ°åˆ†è§£ä¸ºæ¯ä¸ªå•è¯å‘é‡çš„æ¢¯åº¦</p></li><li><p>ä»¤<span class="math inline">\(\nabla_{x} J=W^{T}\delta=\delta_{x_{\text {window }}}\)</span></p></li><li><p><span class="math inline">\(X_{\text {window}}=\left[\begin{array}{lllll} X_{\text {museums }} &amp; X_{\text {in }}&amp; X_{\text {Paris }} &amp; X_{\text {are }} &amp; X_{\text {amazing}} \end{array}\right]\)</span></p></li><li><p>åˆ™å¾—åˆ°<span class="math inline">\(\delta_{\text {window}}=\left[\begin{array}{c} \nabla_{x_{\text {museums }}} \\\nabla_{x_{\text {in }}} \\ \nabla_{x_{\text {Pare }}} \\\nabla_{x_{\text {are }}} \\ \nabla_{x_{\text {amazing }}}\end{array}\right] \in \mathbb{R}^{5 d}\)</span></p></li><li><p>æˆ‘ä»¬å°†æ ¹æ®æ¢¯åº¦é€ä¸ªæ›´æ–°å¯¹åº”çš„è¯å‘é‡çŸ©é˜µä¸­çš„è¯å‘é‡ï¼Œæ‰€ä»¥å®é™…ä¸Šæ˜¯å¯¹è¯å‘é‡çŸ©é˜µçš„æ›´æ–°æ˜¯éå¸¸ç¨€ç–çš„</p></li></ul><h2 id="åœ¨çª—å£æ¨¡å‹ä¸­æ›´æ–°å•è¯æ¢¯åº¦">1.4 åœ¨çª—å£æ¨¡å‹ä¸­æ›´æ–°å•è¯æ¢¯åº¦</h2><ul><li>å½“æˆ‘ä»¬å°†æ¢¯åº¦æ›´æ–°åˆ°è¯å‘é‡ä¸­æ—¶ï¼Œè¿™å°†æ›´æ–°å•è¯å‘é‡ï¼Œä½¿å®ƒä»¬(ç†è®ºä¸Š)åœ¨ç¡®å®šå‘½åå®ä½“æ—¶æ›´æœ‰å¸®åŠ©ã€‚</li><li>ä¾‹å¦‚ï¼Œæ¨¡å‹å¯ä»¥äº†è§£åˆ°ï¼Œå½“çœ‹åˆ°<spanclass="math inline">\(x_{in}\)</span>æ˜¯ä¸­å¿ƒè¯ä¹‹å‰çš„å•è¯æ—¶ï¼ŒæŒ‡ç¤ºä¸­å¿ƒè¯æ˜¯ä¸€ä¸ªLocation</li></ul><h2 id="é‡æ–°è®­ç»ƒè¯å‘é‡æ—¶çš„é™·é˜±">1.5 é‡æ–°è®­ç»ƒè¯å‘é‡æ—¶çš„é™·é˜±</h2><ul><li><p><strong>èƒŒæ™¯</strong>ï¼šæˆ‘ä»¬æ­£åœ¨è®­ç»ƒä¸€ä¸ªå•è¯ç”µå½±è¯„è®ºæƒ…ç»ªçš„é€»è¾‘å›å½’åˆ†ç±»æ¨¡å‹</p></li><li><p>åœ¨<strong>è®­ç»ƒæ•°æ®</strong>ä¸­ï¼Œæˆ‘ä»¬æœ‰â€œTVâ€å’Œâ€œtellyâ€</p></li><li><p>åœ¨<strong>æµ‹è¯•æ•°æ®</strong>ä¸­æˆ‘ä»¬æœ‰â€œtelevisionâ€</p></li><li><p><strong>é¢„è®­ç»ƒ</strong>çš„å•è¯å‘é‡æœ‰ä¸‰ä¸ªç›¸ä¼¼ä¹‹å¤„ï¼š</p><p><img src="/img/nlp/ç¬¬å››è®²/2.png" /></p></li><li><p><strong>é—®é¢˜</strong>ï¼šå½“æˆ‘ä»¬æ›´æ–°å‘é‡æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ</p></li><li><p>å›ç­”ï¼š</p><ul><li>é‚£äº›åœ¨è®­ç»ƒæ•°æ®ä¸­å‡ºç°çš„å•è¯ä¼šå››å¤„ç§»åŠ¨</li><li>â€œTVâ€å’Œâ€œtellyâ€</li><li>æ²¡æœ‰åŒ…å«åœ¨è®­ç»ƒæ•°æ®ä¸­çš„è¯æ±‡ä¿æŒåŸæ ·</li><li>â€œtelevisionâ€</li></ul></li></ul><p><img src="/img/nlp/ç¬¬å››è®²/3.png" /></p><h2 id="å…³äºå†è®­ç»ƒçš„å»ºè®®">1.6 å…³äºå†è®­ç»ƒçš„å»ºè®®</h2><ul><li><p><strong>é—®é¢˜</strong>ï¼šåº”è¯¥ä½¿ç”¨å¯ç”¨çš„â€œé¢„è®­ç»ƒâ€è¯å‘é‡å—ï¼Ÿ</p></li><li><p>å›ç­”ï¼š</p><ul><li>å‡ ä¹æ€»æ˜¯ã€Œåº”è¯¥ç”¨ã€</li><li>ä»–ä»¬æ¥å—äº†å¤§é‡çš„æ•°æ®è®­ç»ƒï¼Œæ‰€ä»¥ä»–ä»¬ä¼šçŸ¥é“è®­ç»ƒæ•°æ®ä¸­æ²¡æœ‰çš„å•è¯ï¼Œä¹Ÿä¼šçŸ¥é“æ›´å¤šå…³äºè®­ç»ƒæ•°æ®ä¸­çš„å•è¯</li><li>æ‹¥æœ‰ä¸Šäº¿çš„æ•°æ®è¯­æ–™å—ï¼Ÿé‚£å¯ä»¥éšæœºåˆå§‹åŒ–å¼€å§‹è®­ç»ƒ</li></ul></li><li><p><strong>é—®é¢˜</strong>ï¼šæˆ‘åº”è¯¥æ›´æ–°(â€œfinetuneâ€)æˆ‘è‡ªå·±çš„å•è¯å‘é‡å—ï¼Ÿ</p></li><li><p>å›ç­”ï¼š</p><ul><li>å¦‚æœä½ åªæœ‰ä¸€ä¸ªå°çš„è®­ç»ƒæ•°æ®é›†ï¼Œä¸è¦å¯¹é¢„è®­ç»ƒè¯å‘é‡åšå†è®­ç»ƒ</li><li>å¦‚æœæ‚¨æœ‰ä¸€ä¸ªå¤§å‹æ•°æ®é›†ï¼Œé‚£ä¹ˆåŸºäºä»»åŠ¡è®­ç»ƒæ›´æ–°è¯å‘é‡ï¼ˆ train = update= fine-tune ï¼‰æ•ˆæœä¼šæ›´å¥½</li></ul></li></ul><h1 id="è®¡ç®—å›¾ä¸åå‘ä¼ æ’­">2.è®¡ç®—å›¾ä¸åå‘ä¼ æ’­</h1><h2 id="åå‘ä¼ æ’­">2.1 åå‘ä¼ æ’­</h2><ul><li>æˆ‘ä»¬å‡ ä¹å·²ç»å‘ä½ ä»¬å±•ç¤ºäº†åå‘ä¼ æ’­<ul><li>æ±‚å¯¼å¹¶ä½¿ç”¨(å¹¿ä¹‰)é“¾å¼æ³•åˆ™</li></ul></li><li>å¦ä¸€ä¸ªæŠ€å·§ï¼šåœ¨è®¡ç®—è¾ƒä½å±‚çš„å¯¼æ•°æ—¶ï¼Œæˆ‘ä»¬é‡ç”¨å¯¹è¾ƒæ·±å±‚è®¡ç®—çš„å¯¼æ•°ï¼Œä»¥å‡å°è®¡ç®—é‡</li></ul><h2 id="è®¡ç®—å›¾å’Œåå‘ä¼ æ’­">2.2 è®¡ç®—å›¾å’Œåå‘ä¼ æ’­</h2><ul><li>æˆ‘ä»¬æŠŠç¥ç»ç½‘ç»œæ–¹ç¨‹è¡¨ç¤ºæˆä¸€ä¸ªå›¾<ul><li>æºèŠ‚ç‚¹ï¼šè¾“å…¥</li><li>å†…éƒ¨èŠ‚ç‚¹ï¼šæ“ä½œ</li><li>è¾¹ä¼ é€’æ“ä½œçš„ç»“æœ</li></ul></li></ul><p><span class="math display">\[\begin{array}{l}s=u^{T} h \\h=f(z) \\z=W x+b \\x \quad(\text { input) }\end{array}\]</span></p><p><img src="/img/nlp/ç¬¬å››è®²/4.png" /></p><h2 id="åå‘ä¼ æ’­å•ç¥ç»å…ƒè§†è§’">2.3 åå‘ä¼ æ’­ï¼šå•ç¥ç»å…ƒè§†è§’</h2><ul><li>èŠ‚ç‚¹æ¥æ”¶â€œä¸Šæ¸¸æ¢¯åº¦â€<ul><li>ç›®æ ‡æ˜¯ä¼ é€’æ­£ç¡®çš„â€œä¸‹æ¸¸æ¢¯åº¦â€</li></ul></li><li>æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å±€éƒ¨æ¢¯åº¦ local gradient<ul><li>å®ƒè¾“å‡ºçš„æ¢¯åº¦æ˜¯ä¸å®ƒçš„è¾“å…¥æœ‰å…³</li></ul></li><li>ä¸‹æ¸¸æ¢¯åº¦ = ä¸Šæ¸¸æ¢¯åº¦<spanclass="math inline">\(\times\)</span>å±€éƒ¨æ¢¯åº¦</li></ul><p><img src="/img/nlp/ç¬¬å››è®²/5.png" /></p><ul><li>æœ‰å¤šä¸ªè¾“å…¥çš„èŠ‚ç‚¹å‘¢ï¼Ÿ</li></ul><p><img src="/img/nlp/ç¬¬å››è®²/6.png" /></p><h2 id="åå‘ä¼ æ’­è®¡ç®—å›¾ç¤ºä¾‹">2.4 åå‘ä¼ æ’­è®¡ç®—å›¾ç¤ºä¾‹</h2><p><img src="D:\blog\source\img\nlp\ç¬¬å››è®²\7.png" /></p><h2 id="æ±‚å’Œå½¢æ€çš„æ¢¯åº¦è®¡ç®—">2.5 æ±‚å’Œå½¢æ€çš„æ¢¯åº¦è®¡ç®—</h2><p>ä¸Šå›¾ä¸­çš„<span class="math inline">\(\frac{\partial f}{\partialy}\)</span>çš„æ¢¯åº¦çš„è®¡ç®— <span class="math display">\[\begin{array}{c}a=x+y \\b=\max (y, z) \\f=a b \\\frac{\partial f}{\partial y}=\frac{\partial f}{\partial a}\frac{\partial a}{\partial y}+\frac{\partial f}{\partial b}\frac{\partial b}{\partial y}\end{array}\]</span></p><h2 id="ç›´æŒ‚ç†è§£ç¥ç»å…ƒçš„æ¢¯åº¦ä¼ é€’">2.6 ç›´æŒ‚ç†è§£ç¥ç»å…ƒçš„æ¢¯åº¦ä¼ é€’</h2>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬ä¸‰è®²-ç¥ç»ç½‘ç»œçŸ¥è¯†</title>
    <link href="/2022/05/06/%E7%AC%AC%E4%B8%89%E8%AE%B2-%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/"/>
    <url>/2022/05/06/%E7%AC%AC%E4%B8%89%E8%AE%B2-%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/</url>
    
    <content type="html"><![CDATA[<h1 id="ç¥ç»ç½‘ç»œåŸºç¡€">1 ç¥ç»ç½‘ç»œåŸºç¡€</h1><h2 id="åˆ†ç±»é—®é¢˜åŸºç¡€">1.1 åˆ†ç±»é—®é¢˜åŸºç¡€</h2><p>å¯¹äºåˆ†ç±»é—®é¢˜ï¼Œæˆ‘ä»¬æœ‰è®­ç»ƒ<strong>æ•°æ®é›†</strong>ï¼šå®ƒç”±ä¸€äº›<strong>æ ·æœ¬</strong>ç»„æˆï¼š<span class="math display">\[\{x_i,y_i\}^N_{i=1}\]</span></p><ul><li><spanclass="math inline">\(x_i\)</span>æ˜¯<strong>è¾“å…¥</strong>ï¼Œä¾‹å¦‚å•è¯(ç´¢å¼•æˆ–æ˜¯å‘é‡)ï¼Œå¥å­ï¼Œæ–‡æ¡£ç­‰ç­‰(ç»´åº¦ä¸ºd)</li><li><spanclass="math inline">\(y_i\)</span>æ˜¯æˆ‘ä»¬å°è¯•é¢„æµ‹çš„æ ‡ç­¾(Cä¸ªç±»åˆ«ä¸­çš„ä¸€ä¸ª)ï¼Œä¾‹å¦‚ï¼š<ul><li>ç±»åˆ«ï¼šæ„Ÿæƒ…ï¼Œå‘½åå®ä½“ï¼Œè´­ä¹°/å”®å‡ºçš„å†³å®š</li><li>å…¶ä»–å•è¯</li><li>å¤šè¯åºåˆ—(ä¹‹åä¼šæåˆ°)</li></ul></li></ul><h2 id="åˆ†ç±»é—®é¢˜ç›´è§‚ç†è§£">1.2 åˆ†ç±»é—®é¢˜ç›´è§‚ç†è§£</h2><ul><li><p>ç”¨ä¸€ä¸ªæœ€ç®€å•çš„2ç»´è¯å‘é‡åˆ†ç±»é—®é¢˜ä½œä¸ºæ¡ˆä¾‹</p><ul><li>ä½¿ç”¨softmax / logisticå›å½’</li><li>æ„å»ºçº¿æ€§å†³ç­–è¾¹ç•Œ</li></ul></li><li><p><strong>ä¼ ç»Ÿçš„æœºå™¨å­¦ä¹ /ç»Ÿè®¡å­¦æ–¹æ³•</strong>ï¼šå‡è®¾<spanclass="math inline">\(x_i\)</span>æ˜¯å›ºå®šçš„ï¼Œè®­ç»ƒ softmax/logisticå›å½’çš„æƒé‡<span class="math inline">\(W \in R^{C \timesd}\)</span>æ¥å†³å®šå†³å®šè¾¹ç•Œ(è¶…å¹³é¢)</p></li><li><p><strong>é¢„æµ‹é˜¶æ®µ</strong>ï¼Œå¯¹æ¯ä¸ª<spanclass="math inline">\(x\)</span>ï¼Œé¢„æµ‹:</p></li></ul><p><span class="math display">\[p(y \mid x)=\frac{\exp \left(W_{y} \cdot x\right)}{\sum_{c=1}^{C} \exp\left(W_{c} \cdot x\right)}\]</span></p><h2 id="softmaxåˆ†ç±»å™¨çš„ç»†èŠ‚">1.3 softmaxåˆ†ç±»å™¨çš„ç»†èŠ‚</h2><p>æˆ‘ä»¬å¯ä»¥å°†é¢„æµ‹å‡½æ•°åˆ†ä¸º<strong>ä¸¤ä¸ªæ­¥éª¤</strong>ï¼š</p><h3 id="å°†wçš„ythè¡Œå’Œxä¸­çš„å¯¹åº”è¡Œç›¸ä¹˜å¾—åˆ°åˆ†æ•°">1 å°†<spanclass="math inline">\(W\)</span>çš„<spanclass="math inline">\(y^{th}\)</span>è¡Œå’Œ<spanclass="math inline">\(x\)</span>ä¸­çš„å¯¹åº”è¡Œç›¸ä¹˜å¾—åˆ°åˆ†æ•°ï¼š</h3><p><span class="math display">\[W_{y} \cdot x=\sum_{i=1}^{d} W_{y i} x_{i}=f_{y}\]</span></p><p>å¯¹c=1ï¼Œ2ï¼Œ...ï¼ŒCè®¡ç®—æ‰€æœ‰çš„<spanclass="math inline">\(f_y\)</span></p><h3 id="ä½¿ç”¨softmaxå‡½æ•°è·å¾—å½’ä¸€åŒ–çš„æ¦‚ç‡">2ä½¿ç”¨softmaxå‡½æ•°è·å¾—å½’ä¸€åŒ–çš„æ¦‚ç‡ï¼š</h3><p><span class="math display">\[p(y \mid x)=\frac{\exp \left(f_{y}\right)}{\sum_{c=1}^{C} \exp\left(f_{c}\right)}=\operatorname{softmax}\left(f_{y}\right)\]</span></p><h2 id="softmaxå’Œäº¤å‰ç†µæŸå¤±">1.4 softmaxå’Œäº¤å‰ç†µæŸå¤±</h2><p>åœ¨softmaxåˆ†ç±»å™¨ä¸­æœ€å¸¸ç”¨åˆ°äº¤å‰ç†µæŸå¤±ï¼Œä¹Ÿæ˜¯è´Ÿå¯¹æ•°æ¦‚ç‡å½¢æ€ã€‚</p><p>å¯¹äºæ¯ä¸ªè®­ç»ƒæ ·æœ¬<spanclass="math inline">\((x,y)\)</span>ï¼Œæˆ‘ä»¬çš„ç›®æ ‡<strong>æ˜¯æœ€å¤§åŒ–æ­£ç¡®ç±»</strong><spanclass="math inline">\(y\)</span>çš„æ¦‚ç‡ï¼Œæˆ–è€…æˆ‘ä»¬å¯ä»¥<strong>æœ€å°åŒ–è¯¥ç±»çš„è´Ÿå¯¹æ•°æ¦‚ç‡</strong>:<span class="math display">\[-\log p(y \mid x)=-\log \left(\frac{\exp\left(f_{y}\right)}{\sum_{c=1}^{C} \exp \left(f_{c}\right)}\right)\]</span></p><h2 id="äº¤å‰ç†µæŸå¤±ç†è§£">1.5 äº¤å‰ç†µæŸå¤±ç†è§£</h2><ul><li>äº¤å‰ç†µçš„æ¦‚å¿µæ¥æºäºä¿¡æ¯è®ºï¼Œè¡¡é‡ä¸¤ä¸ªåˆ†å¸ƒä¹‹é—´çš„å·®å¼‚ï¼Œäº¤å‰ç†µè¶Šå¤§ï¼Œå˜é‡çš„å–å€¼è¶Šä¸ç¡®å®šï¼Œåä¹‹åˆ™è¶Šç¡®å®šã€‚</li><li>ä»¤çœŸå®æ¦‚ç‡åˆ†å¸ƒä¸º<spanclass="math inline">\(p\)</span>ï¼Œæˆ‘ä»¬è®¡ç®—çš„æ¨¡å‹æ¦‚ç‡åˆ†å¸ƒä¸º<spanclass="math inline">\(q\)</span></li><li>äº¤å‰ç†µä¸ºï¼š</li></ul><p><span class="math display">\[H(p, q)=-\sum_{c=1}^{C} p(c) \log q(c)\]</span></p><ul><li>å‡è®¾æ ‡å‡†ç­”æ¡ˆçš„æ¦‚ç‡åˆ†å¸ƒæ˜¯ï¼Œåœ¨æ­£ç¡®çš„ç±»ä¸Šä¸º1ï¼Œåœ¨å…¶ä»–ç±»åˆ«ä¸Šä¸º0ï¼š</li></ul><p><span class="math display">\[p=[0,...,0,1,...,0]\]</span></p><ul><li>å› ä¸ºæ˜¯ç‹¬çƒ­å‘é‡(one-hotvector)ï¼Œæ‰€ä»¥å”¯ä¸€å‰©ä¸‹çš„é¡¹æ˜¯çœŸå®ç±»çš„è´Ÿå¯¹æ•°æ¦‚ç‡ã€‚</li></ul><h2 id="å®Œæ•´æ•°æ®é›†ä¸Šçš„åˆ†ç±»">1.6 å®Œæ•´æ•°æ®é›†ä¸Šçš„åˆ†ç±»</h2><p>åœ¨æ•´ä¸ªæ•°æ®é›†<spanclass="math inline">\(\{x_i,y_i\}_{i=1}^N\)</span>ä¸Šçš„äº¤å‰ç†µæŸå¤±å‡½æ•°ï¼Œæ˜¯æ‰€æœ‰æ ·æœ¬çš„äº¤å‰ç†µçš„å‡å€¼<span class="math display">\[J(\theta)=\frac{1}{N} \sum_{i=1}^{N}-\log\left(\frac{e^{f_{y_{i}}}}{\sum_{c=1}^{C} e^{f_{c}}}\right)\]</span> ä¸ä½¿ç”¨ <span class="math display">\[f_{y}=f_{y}(x)=W_{y} \cdot x=\sum_{j=1}^{d} W_{y j} x_{j}\]</span> è€Œæ˜¯ä½¿ç”¨å‘é‡åŒ–çš„å½¢æ€ï¼ŒåŸºäºçŸ©é˜µæ¥è¡¨ç¤º<spanclass="math inline">\(f:f=W_x\)</span></p><h2 id="ä¼ ç»Ÿçš„æœºå™¨å­¦ä¹ ä¼˜åŒ–ç®—æ³•">1.7 ä¼ ç»Ÿçš„æœºå™¨å­¦ä¹ ä¼˜åŒ–ç®—æ³•</h2><p>å¯¹äºä¼ ç»Ÿçš„æœºå™¨å­¦ä¹ ç®—æ³•ï¼ˆå¦‚é€»è¾‘å›å½’ï¼‰æ¥è¯´ï¼Œä¸€èˆ¬æœºå™¨å­¦ä¹ çš„å‚æ•°<spanclass="math inline">\(\theta\)</span>é€šå¸¸åªç”±<spanclass="math inline">\(W\)</span>çš„åˆ—ç»„æˆ <span class="math display">\[\theta=\left[\begin{array}{c}W_{\cdot 1} \\\vdots \\W_{\cdot d}\end{array}\right]=W(:) \in \mathbb{R}^{C d}\]</span> å› æ­¤ï¼Œæˆ‘ä»¬åªé€šè¿‡ä»¥ä¸‹æ–¹å¼<strong>æ›´æ–°å†³ç­–è¾¹ç•Œ</strong> <spanclass="math display">\[\nabla_{\theta} J(\theta)=\left[\begin{array}{c}\nabla_{W_{1}} \\\vdots \\\nabla_{W_{d}}\end{array}\right] \in \mathbb{R}^{C d}\]</span></p><h2 id="ç¥ç»ç½‘ç»œåˆ†ç±»å™¨">1.8 ç¥ç»ç½‘ç»œåˆ†ç±»å™¨</h2><ul><li>å•ç‹¬ä½¿ç”¨çº¿æ€§åˆ†ç±»å™¨Softmax( â‰ˆ logisticå›å½’)å¹¶ä¸ååˆ†å¼ºå¤§</li></ul><p><img src="/img/nlp/ç¬¬ä¸‰è®²/1.png" /></p><ul><li>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒSoftmaxå¾—åˆ°çš„æ˜¯çº¿æ€§å†³ç­–è¾¹ç•Œ<ul><li>å¯¹äºå¤æ‚é—®é¢˜æ¥è¯´ï¼Œå®ƒçš„è¡¨è¾¾èƒ½åŠ›æ˜¯æœ‰é™çš„</li><li>æœ‰ä¸€äº›åˆ†é”™çš„ç‚¹ï¼Œéœ€è¦æ›´å¼ºçš„éçº¿æ€§è¡¨è¾¾èƒ½åŠ›æ¥åŒºåˆ†</li></ul></li></ul><h2 id="ç¥ç»ç½‘ç»œéçº¿æ€§åˆ‡åˆ†">1.9 ç¥ç»ç½‘ç»œéçº¿æ€§åˆ‡åˆ†</h2><ul><li><p>ç¥ç»ç½‘ç»œå¯ä»¥å­¦ä¹ æ›´å¤æ‚çš„å‡½æ•°å’Œéçº¿æ€§å†³ç­–è¾¹ç•Œ</p></li><li><p>tip ï¼šæ›´é«˜çº§çš„åˆ†ç±»éœ€è¦</p><ul><li>è¯å‘é‡</li><li>æ›´æ·±å±‚æ¬¡çš„æ·±å±‚ç¥ç»ç½‘ç»œ</li></ul></li></ul><h2 id="åŸºäºè¯å‘é‡çš„åˆ†ç±»å·®å¼‚">1.10 åŸºäºè¯å‘é‡çš„åˆ†ç±»å·®å¼‚</h2><ul><li>ä¸€èˆ¬åœ¨NLPæ·±åº¦å­¦ä¹ ä¸­ï¼š<ul><li>æˆ‘ä»¬å­¦ä¹ äº†çŸ©é˜µ<span class="math inline">\(W\)</span>å’Œè¯å‘é‡<spanclass="math inline">\(x\)</span>ã€‚</li><li>æˆ‘ä»¬å­¦ä¹ ä¼ ç»Ÿå‚æ•°å’Œè¡¨ç¤ºã€‚</li><li>è¯å‘é‡æ˜¯å¯¹ç‹¬çƒ­å‘é‡çš„é‡æ–°è¡¨ç¤ºâ€”â€”åœ¨ä¸­é—´å±‚å‘é‡ç©ºé—´ä¸­ç§»åŠ¨å®ƒä»¬â€”â€”ä»¥ä¾¿(çº¿æ€§)softmaxåˆ†ç±»å™¨å¯ä»¥æ›´å¥½åœ°åˆ†ç±»ã€‚</li></ul></li><li>å³å°†è¯å‘é‡ç†è§£ä¸ºä¸€å±‚ç¥ç»ç½‘ç»œï¼Œè¾“å…¥å•è¯çš„ç‹¬çƒ­å‘é‡å¹¶è·å¾—å•è¯çš„è¯å‘é‡è¡¨ç¤ºï¼Œå¹¶ä¸”æˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œæ›´æ–°ã€‚</li></ul><p><span class="math display">\[\nabla_{\theta} J(\theta)=\left[\begin{array}{c}\nabla_{W_{1}} \\\vdots \\\nabla_{W_{\text {dardvark }}} \\\vdots \\\nabla_{x_{z e b r a}}\end{array}\right] \in \mathbb{R}^{C d+V d}\]</span></p><ul><li>å…¶ä¸­ï¼Œ<span class="math inline">\(Vd\)</span>æ˜¯æ•°é‡å¾ˆå¤§çš„å‚æ•°ã€‚</li></ul><h2 id="ç¥ç»è®¡ç®—">1.11 ç¥ç»è®¡ç®—</h2><ul><li>An artificial neuron<ul><li>ç¥ç»ç½‘ç»œæœ‰è‡ªå·±çš„æœ¯è¯­åŒ…</li><li>ä½†å¦‚æœä½ äº†è§£ softmaxæ¨¡å‹æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥å¾ˆå®¹æ˜“åœ°ç†è§£ç¥ç»å…ƒçš„æ“ä½œ</li></ul></li><li>Neural computationï¼šç¥ç»è®¡ç®—</li><li>Neural selectivityï¼šç¥ç»é€‰æ‹©æ€§</li><li>Hierarchy of neural processingï¼šç¥ç»å¤„ç†å±‚æ¬¡</li></ul><h2 id="å•ä¸ªç¥ç»å…ƒå¯è§†ä½œäºŒå…ƒé€»è¾‘å›å½’å•å…ƒ">1.12å•ä¸ªç¥ç»å…ƒï¼šå¯è§†ä½œäºŒå…ƒé€»è¾‘å›å½’å•å…ƒ</h2><p><span class="math display">\[h_{w, b}(x)=f\left(w^{T} x+b\right)\]</span></p><p><span class="math display">\[f(z)=\frac{1}{1+e^{-z}}\]</span></p><ul><li><spanclass="math inline">\(b\)</span>ï¼šæˆ‘ä»¬å¯ä»¥æœ‰ä¸€ä¸ªâ€œæ€»æ˜¯æ‰“å¼€â€çš„ç‰¹æ€§ï¼Œå®ƒç»™å‡ºä¸€ä¸ªå…ˆéªŒç±»ï¼Œæˆ–è€…å°†å®ƒä½œä¸ºä¸€ä¸ªåå‘é¡¹åˆ†ç¦»å‡ºæ¥ã€‚</li><li><span class="math inline">\(w\)</span>ï¼Œ<spanclass="math inline">\(b\)</span>æ˜¯ç¥ç»å…ƒçš„å‚æ•°ã€‚</li></ul><h2 id="ä¸€ä¸ªç¥ç»ç½‘ç»œå¤šä¸ªé€»è¾‘å›å½’ç»„åˆ">1.13ä¸€ä¸ªç¥ç»ç½‘ç»œï¼šå¤šä¸ªé€»è¾‘å›å½’ç»„åˆ</h2><ul><li>å¦‚æœæˆ‘ä»¬è¾“å…¥ä¸€ä¸ªå‘é‡é€šè¿‡ä¸€ç³»åˆ—é€»è¾‘å›å½’å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªè¾“å‡ºå‘é‡ã€‚</li><li>ä½†æ˜¯æˆ‘ä»¬ä¸éœ€è¦æå‰å†³å®šè¿™äº›é€»è¾‘å›å½’è¯•å›¾é¢„æµ‹çš„å˜é‡æ˜¯ä»€ä¹ˆã€‚</li></ul><p><img src="/img/nlp/ç¬¬ä¸‰è®²/2.png" /></p><ul><li>æˆ‘ä»¬å¯ä»¥è¾“å…¥å¦ä¸€ä¸ªlogisticå›å½’å‡½æ•°ã€‚</li><li>æŸå¤±å‡½æ•°å°†æŒ‡å¯¼ä¸­é—´éšè—å˜é‡åº”è¯¥æ˜¯ä»€ä¹ˆï¼Œä»¥ä¾¿æ›´å¥½åœ°é¢„æµ‹ä¸‹ä¸€å±‚çš„ç›®æ ‡ã€‚</li></ul><p><img src="/img/nlp/ç¬¬ä¸‰è®²/3.png" /></p><p>æˆ‘ä»¬æ·»åŠ æ›´å¤šå±‚çš„ç¥ç»ç½‘ç»œï¼Œå°±å¾—åˆ°äº†å¤šå±‚æ„ŸçŸ¥å™¨ã€‚</p><p><img src="/img/nlp/ç¬¬ä¸‰è®²/4.png" /></p><h2 id="å•å±‚ç¥ç»ç½‘ç»œçš„çŸ©é˜µå½¢æ€è¡¨ç¤º">1.14 å•å±‚ç¥ç»ç½‘ç»œçš„çŸ©é˜µå½¢æ€è¡¨ç¤º</h2><p>æˆ‘ä»¬æœ‰ï¼š <span class="math display">\[a_{1}=f\left(W_{11} x_{1}+W_{12} x_{2}+W_{13} x_{3}+b_{1}\right)\]</span></p><p><span class="math display">\[a_{2}=f\left(W_{21} x_{1}+W_{22} x_{2}+W_{23} x_{3}+b_{2}\right)\]</span></p><p>åœ¨çŸ©é˜µä¸­ï¼š <span class="math display">\[z=Wx+b\]</span> æ¿€æ´»å‡½æ•°<spanclass="math inline">\(f\)</span>åœ¨è¿ç®—æ—¶æ˜¯element-wiseé€å…ƒç´ çš„ <spanclass="math display">\[f\left(\left[z_{1}, z_{2},z_{3}\right]\right)=\left[f\left(z_{1}\right), f\left(z_{2}\right),f\left(z_{3}\right)\right]\]</span> <img src="/img/nlp/ç¬¬ä¸‰è®²/5.png" /></p><h2 id="éçº¿æ€§å˜æ¢çš„å¿…è¦æ€§">1.15 éçº¿æ€§å˜æ¢çš„å¿…è¦æ€§</h2><ul><li>ä¾‹å¦‚ï¼šå‡½æ•°è¿‘ä¼¼ï¼Œå¦‚å›å½’æˆ–åˆ†ç±»<ul><li>æ²¡æœ‰éçº¿æ€§ï¼Œæ·±åº¦ç¥ç»ç½‘ç»œåªèƒ½åšçº¿æ€§å˜æ¢</li><li>å¤šä¸ªçº¿æ€§å˜æ¢ï¼Œä¹Ÿè¿˜æ˜¯ç»„æˆä¸€ä¸ªçº¿æ€§å˜æ¢<spanclass="math inline">\(W_1W_2x=Wx\)</span></li></ul></li><li>å› ä¸ºçº¿æ€§å˜æ¢æ˜¯ä»¥æŸç§æ–¹å¼æ—‹è½¬å’Œæ‹‰ä¼¸ç©ºé—´ï¼Œå¤šæ¬¡çš„æ—‹è½¬å’Œæ‹‰ä¼¸å¯ä»¥èåˆä¸ºä¸€æ¬¡çº¿æ€§å˜æ¢</li><li>å¯¹äºéçº¿æ€§å‡½æ•°è€Œè¨€ï¼Œä½¿ç”¨æ›´å¤šçš„å±‚ï¼Œä»–ä»¬å¯ä»¥è¿‘ä¼¼æ›´å¤æ‚çš„å‡½æ•°</li></ul><h1 id="å‘½åå®ä½“è¯†åˆ«">2 å‘½åå®ä½“è¯†åˆ«</h1><h2 id="å‘½åå®ä½“è¯†åˆ«ner">2.1 å‘½åå®ä½“è¯†åˆ«(NER)</h2><ul><li>å¯èƒ½çš„ç”¨é€”<ul><li>è·Ÿè¸ªæ–‡æ¡£ä¸­æåˆ°çš„ç‰¹å®šå®ä½“(ç»„ç»‡ã€ä¸ªäººã€åœ°ç‚¹ã€æ­Œæ›²åã€ç”µå½±åç­‰)</li><li>å¯¹äºé—®é¢˜å›ç­”ï¼Œç­”æ¡ˆé€šå¸¸æ˜¯å‘½åå®ä½“</li><li>è®¸å¤šéœ€è¦çš„ä¿¡æ¯å®é™…ä¸Šæ˜¯å‘½åå®ä½“ä¹‹é—´çš„å…³è”</li><li>åŒæ ·çš„æŠ€æœ¯å¯ä»¥æ‰©å±•åˆ°å…¶ä»– slot-filling æ§½å¡«å……åˆ†ç±»</li></ul></li><li>é€šå¸¸åé¢æ˜¯å‘½åå®ä½“é“¾æ¥/è§„èŒƒåŒ–åˆ°çŸ¥è¯†åº“</li></ul><h2 id="å¥å­ä¸­çš„å‘½åå®ä½“è¯†åˆ«">2.2 å¥å­ä¸­çš„å‘½åå®ä½“è¯†åˆ«</h2><p>æˆ‘ä»¬é€šè¿‡åœ¨ä¸Šä¸‹æ–‡ä¸­å¯¹å•è¯è¿›è¡Œåˆ†ç±»ï¼Œç„¶åå°†å®ä½“æå–ä¸ºå•è¯å­åºåˆ—æ¥é¢„æµ‹å®ä½“ã€‚</p><p><img src="/img/nlp/ç¬¬ä¸‰è®²/6.png" /></p><h2 id="nerçš„éš¾ç‚¹">2.3 NERçš„éš¾ç‚¹</h2><ul><li>å¾ˆéš¾è®¡ç®—å‡ºå®ä½“çš„è¾¹ç•Œ<ul><li>ç¬¬ä¸€ä¸ªå®ä½“æ˜¯ â€œFirst National Bankâ€ è¿˜æ˜¯ â€œNational Bankâ€</li></ul></li><li>å¾ˆéš¾çŸ¥é“æŸç‰©æ˜¯å¦æ˜¯ä¸€ä¸ªå®ä½“<ul><li>æ˜¯ä¸€æ‰€åä¸ºâ€œFuture Schoolâ€ çš„å­¦æ ¡ï¼Œè¿˜æ˜¯è¿™æ˜¯ä¸€æ‰€æœªæ¥çš„å­¦æ ¡ï¼Ÿ</li></ul></li><li>å¾ˆéš¾çŸ¥é“æœªçŸ¥/æ–°å¥‡å®ä½“çš„ç±»åˆ«<ul><li>â€œZig Ziglarâ€ ? ä¸€ä¸ªäºº</li></ul></li><li>å®ä½“ç±»æ˜¯æ¨¡ç³Šçš„ï¼Œä¾èµ–äºä¸Šä¸‹æ–‡<ul><li>è¿™é‡Œçš„â€œCharles Schwabâ€ æ˜¯ PER ä¸æ˜¯ ORG</li></ul></li></ul><h1 id="åŸºäºçª—å£æ•°æ®çš„åˆ†ç±»é¢„æµ‹">3.åŸºäºçª—å£æ•°æ®çš„åˆ†ç±»é¢„æµ‹</h1><h2 id="è¯-çª—åˆ†ç±»">3.1. è¯-çª—åˆ†ç±»</h2><ul><li>æ€è·¯ï¼šä¸ºåœ¨ä¸Šä¸‹æ–‡ä¸­çš„è¯­è¨€æ„å»ºåˆ†ç±»å™¨<ul><li>ä¸€èˆ¬æ¥è¯´ï¼Œå¾ˆå°‘å¯¹å•ä¸ªå•è¯è¿›è¡Œåˆ†ç±»</li></ul></li><li>ä¾‹å¦‚ï¼Œä¸Šä¸‹æ–‡ä¸­ä¸€ä¸ªå•è¯çš„å‘½åå®ä½“åˆ†ç±»<ul><li>äººã€åœ°ç‚¹ã€ç»„ç»‡ã€æ²¡æœ‰</li></ul></li><li>åœ¨ä¸Šä¸‹æ–‡ä¸­å¯¹å•è¯è¿›è¡Œåˆ†ç±»çš„ä¸€ä¸ªç®€å•æ–¹æ³•ï¼Œå¯èƒ½æ˜¯å¯¹çª—å£ä¸­çš„å•è¯å‘é‡è¿›è¡Œå¹³å‡ï¼Œå¹¶å¯¹å¹³å‡å‘é‡è¿›è¡Œåˆ†ç±»<ul><li>é—®é¢˜ï¼šè¿™ä¼šä¸¢å¤±ä½ç½®ä¿¡æ¯</li></ul></li></ul><h2 id="çª—å£åˆ†ç±»å™¨softmax">3.2 çª—å£åˆ†ç±»å™¨ï¼šsoftmax</h2><ul><li><p>è®­ç»ƒsoftmaxåˆ†ç±»å™¨å¯¹ä¸­å¿ƒè¯è¿›è¡Œåˆ†ç±»ï¼Œæ–¹æ³•æ˜¯åœ¨ä¸€ä¸ªçª—å£å†…å°†ä¸­å¿ƒè¯å‘¨å›´çš„è¯å‘é‡ä¸²è”èµ·æ¥</p></li><li><p>ä¾‹å­ï¼šåœ¨è¿™å¥è¯çš„ä¸Šä¸‹æ–‡ä¸­å¯¹â€œParisâ€è¿›è¡Œåˆ†ç±»ï¼Œçª—å£é•¿åº¦ä¸º2</p></li><li><p>ç»“æœå‘é‡<span class="math inline">\(x_{w i n d o w}=x \in R^{5d}\)</span>æ˜¯ä¸€ä¸ªåˆ—å‘é‡</p></li></ul><h2 id="æœ€ç®€å•çš„çª—å£åˆ†ç±»å™¨softmax">3.3 æœ€ç®€å•çš„çª—å£åˆ†ç±»å™¨ï¼šSoftmax</h2><p>å¯¹äº<spanclass="math inline">\(x=x_{window}\)</span>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸ä¹‹å‰ç›¸åŒçš„softmaxåˆ†ç±»å™¨<span class="math display">\[\hat{y}_{y}=p(y \mid x)=\frac{\exp \left(\sqrt{W_{y} \cdotx}\right)}{\sum_{c=1}^{C} \exp \left(W_{c} \cdot x\right)}\]</span> <strong>å¦‚ä½•æ›´æ–°å‘é‡</strong>ï¼Ÿ</p><ul><li>ç®€è€Œè¨€ä¹‹ï¼šå°±åƒä¹‹å‰è®²çš„é‚£æ ·ï¼Œæ±‚å¯¼å’Œä¼˜åŒ–</li></ul><h2 id="ç¨å¾®å¤æ‚ä¸€ç‚¹å¤šå±‚æ„ŸçŸ¥å™¨">3.4 ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼šå¤šå±‚æ„ŸçŸ¥å™¨</h2><ul><li><p>å‡è®¾æˆ‘ä»¬è¦å¯¹ä¸­å¿ƒè¯æ˜¯å¦ä¸ºä¸€ä¸ªåœ°ç‚¹ï¼Œè¿›è¡Œåˆ†ç±»</p></li><li><p>ä¸word2vecç±»ä¼¼ï¼Œæˆ‘ä»¬å°†éå†è¯­æ–™åº“ä¸­çš„æ‰€æœ‰ä½ç½®ã€‚ä½†è¿™ä¸€æ¬¡ï¼Œå®ƒå°†å—åˆ°ç›‘ç£ï¼Œåªæœ‰ä¸€äº›ä½ç½®èƒ½å¤Ÿå¾—åˆ°é«˜åˆ†ã€‚</p><ul><li>ä¾‹å¦‚ï¼Œåœ¨ä»–ä»¬çš„ä¸­å¿ƒæœ‰ä¸€ä¸ªå®é™…çš„NERLocationçš„ä½ç½®æ˜¯â€œçœŸå®çš„â€ä½ç½®ä¼šè·å¾—é«˜åˆ†</li></ul></li></ul><h2 id="ç¥ç»ç½‘ç»œå‰é¦ˆè®¡ç®—">3.5 ç¥ç»ç½‘ç»œå‰é¦ˆè®¡ç®—</h2><p>ä½¿ç”¨ç¥ç»æ¿€æ´»<spanclass="math inline">\(a\)</span>ç®€å•åœ°ç»™å‡ºä¸€ä¸ªéæ ‡å‡†åŒ–çš„åˆ†æ•° <spanclass="math display">\[\operatorname{score}(x)=U^{T} a \in \mathbb{R}\]</span> æˆ‘ä»¬ç”¨ä¸€ä¸ªä¸‰å±‚ç¥ç»ç½‘ç»œè®¡ç®—ä¸€ä¸ªçª—å£çš„å¾—åˆ†</p><ul><li>s = score(â€œmuseums in Paris are amazingâ€)</li></ul><p><img src="/img/nlp/ç¬¬ä¸‰è®²/7.png" /></p><h2 id="é™„åŠ å±‚">3.6 é™„åŠ å±‚</h2><p>ä¸­é—´å±‚å­¦ä¹ è¾“å…¥è¯å‘é‡ä¹‹é—´çš„éçº¿æ€§äº¤äº’</p><p><img src="/img/nlp/ç¬¬ä¸‰è®²/8.png" /></p><p>ä¾‹å¦‚ï¼šåªæœ‰å½“â€œmuseumâ€æ˜¯ç¬¬ä¸€ä¸ªå‘é‡æ—¶ï¼Œâ€œinâ€æ”¾åœ¨ç¬¬äºŒä¸ªä½ç½®æ‰é‡è¦</p><h1 id="åŸºäºpytorchå®ç°çš„åˆ†ç±»å™¨">4.åŸºäºpytorchå®ç°çš„åˆ†ç±»å™¨</h1><h2 id="æ›¿ä»£æœ€å¤§è¾¹ç¼˜æŸå¤±">4.1 æ›¿ä»£ï¼šæœ€å¤§è¾¹ç¼˜æŸå¤±</h2><p>å…³äºè®­ç»ƒç›®æ ‡çš„æƒ³æ³•ï¼šè®©çœŸå®çª—å£çš„å¾—åˆ†æ›´é«˜ï¼Œè€Œå…¶ä»–çª—å£çš„å¾—åˆ†æ›´ä½(ç›´åˆ°è¶³å¤Ÿå¥½ä¸ºæ­¢)</p><ul><li><span class="math inline">\(s = score(museums\ in\ Paris\ are\amazing)\)</span></li><li><span class="math inline">\(s_c = socre(Not\ all\ museums\ in\Paris)\)</span></li></ul><p><strong>æœ€å°åŒ–</strong>ï¼š <span class="math display">\[J=max(0,1-s-s_c)\]</span> è¿™æ˜¯ä¸å¯å¾®çš„ï¼Œä½†å®ƒæ˜¯è¿ç»­çš„ â†’ æˆ‘ä»¬å¯ä»¥ç”¨SGD</p><p><strong>è¡¥å……è§£æ</strong></p><ul><li>å•çª—å£çš„ç›®æ ‡å‡½æ•°ä¸º<spanclass="math inline">\(J=max(0,1-s-s_c)\)</span></li><li>æ¯ä¸ªä¸­å¿ƒæœ‰NERä½ç½®çš„çª—å£çš„å¾—åˆ†åº”è¯¥æ¯”ä¸­å¿ƒæ²¡æœ‰ä½ç½®çš„çª—å£é«˜1åˆ†</li><li>è¦è·å¾—å®Œæ•´çš„ç›®æ ‡å‡½æ•°ï¼šä¸ºæ¯ä¸ªçœŸçª—å£é‡‡æ ·å‡ ä¸ªæŸåçš„çª—å£ã€‚å¯¹æ‰€æœ‰è®­ç»ƒæ ·æœ¬çª—å£æ±‚å’Œ</li><li>ç±»ä¼¼äºword2vecä¸­çš„è´ŸæŠ½æ ·</li></ul><h2 id="éšæœºæ¢¯åº¦ä¸‹é™">4.2 éšæœºæ¢¯åº¦ä¸‹é™</h2>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>NLP-Assignment2</title>
    <link href="/2022/05/06/NLP-Assignment2/"/>
    <url>/2022/05/06/NLP-Assignment2/</url>
    
    <content type="html"><![CDATA[<h1 id="assignment2">Assignment2</h1><h2 id="è§£ç­”ç†è§£è¯å‘é‡23åˆ†">è§£ç­”ï¼šç†è§£è¯å‘é‡ï¼ˆ23åˆ†ï¼‰</h2><p>æˆ‘ä»¬å…ˆå¿«é€Ÿå›é¡¾ä¸€ä¸‹word2vecç®—æ³•ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯â€œä¸€ä¸ªè¯çš„å«ä¹‰å¯ä»¥ç”±å®ƒå‘¨å›´çš„è¯æ¥è¡¨ç¤ºâ€ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªä¸­å¿ƒè¯ï¼ˆcenterwordï¼‰ <em>c</em>ï¼Œå’Œè¿™ä¸ªè¯ <em>c</em>å‘¨å›´ä¸Šä¸‹æ–‡æ„æˆçš„çª—å£ï¼Œè¿™ä¸ªçª—å£å†…çš„é™¤äº† <em>c</em>ä¹‹å¤–çš„è¯å«åšå¤–å›´è¯ï¼ˆoutsidewordsï¼‰ã€‚æ¯”å¦‚ä¸‹å›¾ä¸­ï¼Œä¸­å¿ƒè¯æ˜¯â€œbankingâ€ï¼Œçª—å£å¤§å°ä¸º2ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡çª—å£æ˜¯ï¼šâ€œturningâ€ã€â€intoâ€œã€â€crisesâ€œå’Œâ€asâ€œã€‚</p><p><img src="/img/nlp/assignment2/1.jpg"/></p><p>Skip-gramæ¨¡å‹ï¼ˆword2vecæ¯”è¾ƒå¸¸ç”¨çš„ä¸€ç§å®ç°ï¼Œå¦ä¸€ç§æ˜¯cbowï¼‰ç›®çš„æ˜¯å­¦ä¹ æ¦‚ç‡åˆ†å¸ƒ<spanclass="math inline">\(ğ‘ƒ(ğ‘‚|ğ¶)\)</span>ã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±èƒ½è®¡ç®—ç»™å®šçš„ä¸€ä¸ªè¯<span class="math inline">\(o\)</span> å’Œè¯ <spanclass="math inline">\(c\)</span> çš„æ¦‚ç‡ <spanclass="math inline">\(ğ‘ƒ(ğ‘‚=ğ‘œ|ğ¶=ğ‘)\)</span>ï¼ˆå³ï¼Œåœ¨å·²çŸ¥è¯ <spanclass="math inline">\(c\)</span> å‡ºç°çš„æƒ…å†µä¸‹ï¼Œè¯ <spanclass="math inline">\(o\)</span> å‡ºç°çš„æ¦‚ç‡ï¼‰ï¼Œ å…¶ä¸­<spanclass="math inline">\(c\)</span> æ˜¯ä¸­å¿ƒè¯ï¼Œ<spanclass="math inline">\(o\)</span> æ˜¯çª—å£ä¸­éä¸­å¿ƒçš„å¤–å›´è¯ã€‚</p><p>åœ¨word2vecä¸­ï¼Œè¿™ä¸ªæ¡ä»¶æ¦‚ç‡åˆ†å¸ƒæ˜¯é€šè¿‡è®¡ç®—å‘é‡ç‚¹ç§¯ï¼ˆdot-productsï¼‰ï¼Œå†åº”ç”¨naive-softmaxå‡½æ•°å¾—åˆ°çš„ï¼š<span class="math display">\[P(O=o \mid C=c)=\frac{\exp \left(\boldsymbol{u}_{o}^{\top}\boldsymbol{v}_{c}\right)}{\sum_{w \in \operatorname{Vocab}} \exp\left(\boldsymbol{u}_{w}^{\top} \boldsymbol{v}_{c}\right)}\]</span></p><p>è¿™é‡Œï¼Œ<span class="math inline">\(ğ‘¢_o\)</span>å‘é‡ä»£è¡¨å¤–å›´è¯ï¼Œ<spanclass="math inline">\(v_c\)</span>å‘é‡ä»£è¡¨ä¸­å¿ƒè¯ã€‚ä¸ºäº†åŒ…å«è¿™äº›å‘é‡ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªçŸ©é˜µ<span class="math inline">\(ğ‘ˆ\)</span> å’Œ <spanclass="math inline">\(ğ‘‰\)</span> ã€‚ <spanclass="math inline">\(ğ‘ˆ\)</span> çš„åˆ—æ˜¯å¤–å›´è¯ï¼Œ <spanclass="math inline">\(V\)</span> çš„åˆ—æ˜¯ä¸­å¿ƒè¯ï¼Œè¿™ä¸¤çŸ©é˜µéƒ½æœ‰æ‰€æœ‰è¯<spanclass="math inline">\(w \in Vocabulary\)</span>çš„è¡¨ç¤º ã€‚</p><p>å¯¹äºè¯ <span class="math inline">\(c\)</span> å’Œè¯ <spanclass="math inline">\(o\)</span>ï¼ŒæŸå¤±å‡½æ•°ä¸ºå¯¹æ•°å‡ ç‡ï¼š <spanclass="math display">\[\boldsymbol{J}_{naive-softmax}(v_c, o, \boldsymbol{U}) = -log P(O=o \midC=c)\]</span></p><p>å¯ä»¥ä»äº¤å‰ç†µçš„è§’åº¦çœ‹è¿™ä¸ªæŸå¤±å‡½æ•°ã€‚çœŸå®å€¼ä¸º <spanclass="math inline">\(y\)</span> ï¼Œæ˜¯ä¸€ä¸ªç‹¬çƒ­å‘é‡ï¼Œé¢„æµ‹å€¼ <spanclass="math inline">\(\hat{y}\)</span> è®¡ç®—å¾—åˆ°ã€‚å…·ä½“æ¥è¯´ï¼Œ <spanclass="math inline">\(y\)</span>å¦‚æœæ˜¯ç¬¬kä¸ªå•è¯ï¼Œé‚£ä¹ˆå®ƒçš„ç¬¬kç»´ä¸º1ï¼Œå…¶ä½™ç»´éƒ½æ˜¯0ï¼Œè€Œ <spanclass="math inline">\(\hat{y}\)</span>çš„ç¬¬kç»´è¡¨ç¤ºè¿™æ˜¯ç¬¬kä¸ªè¯çš„æ¦‚ç‡å¤§å°ã€‚</p><h3 id="é—®é¢˜a-3åˆ†">é—®é¢˜(a) (3åˆ†)</h3><p>è¯æ˜å…¬å¼(2)ç»™å‡ºçš„naive-softmaxçš„æŸå¤±å‡½æ•°ï¼Œå’Œ <spanclass="math inline">\(y\)</span> ä¸ <spanclass="math inline">\(\hat{y}\)</span>çš„äº¤å‰ç†µæŸå¤±å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œå‡å¦‚ä¸‹æ‰€ç¤ºï¼ˆç­”æ¡ˆæ§åˆ¶åœ¨ä¸€è¡Œï¼‰</p><p><span class="math display">\[-\sum_{w \in V o c a b} y_{w} \log\left(\hat{y}_{w}\right)=-\log \left(\hat{y}_{o}\right)\]</span></p><p><strong>ç­”ï¼š</strong>å› ä¸ºé™¤äº† <span class="math inline">\(o\)</span>ä¹‹å¤–çš„è¯éƒ½ä¸åœ¨çª—å£å†…ï¼Œæ‰€ä»¥åªæœ‰è¯ <span class="math inline">\(o\)</span>å¯¹æŸå¤±å‡½æ•°æœ‰è´¡çŒ®</p><h3 id="é—®é¢˜b-5åˆ†">é—®é¢˜(b) (5åˆ†)</h3><p>è®¡ç®—æŸå¤±å‡½æ•° <spanclass="math inline">\(\boldsymbol{J}_{naive-softmax}(v_c, o,\boldsymbol{U})\)</span> å¯¹ä¸­å¿ƒè¯ <spanclass="math inline">\(v_c\)</span> çš„åå¯¼æ•°ï¼Œç”¨ <spanclass="math inline">\(y\)</span> ï¼Œ<spanclass="math inline">\(\hat{y}\)</span>å’Œ <spanclass="math inline">\(ğ‘ˆ\)</span> æ¥è¡¨ç¤ºã€‚</p><p><strong>ç­”ï¼š</strong> <span class="math display">\[\begin{aligned}J_{\text {naive-softmax} }\left(\boldsymbol{v}_{c}, o,\boldsymbol{U}\right)&amp;=-\log P(O=o | C=c) \\&amp;= -\log \frac{\exp \left(\boldsymbol{u}_{o}^{\top}\boldsymbol{v}_{c}\right)}{\sum_{w \in \operatorname{Vocab} } \exp\left(\boldsymbol{u}_{\boldsymbol{w} }^{\top} \boldsymbol{v}_{c}\right)}\\&amp;= - {u}_{o}^{\top}{v}_{c} + \log \sum_{w \in \operatorname{Vocab} }\exp \left(\boldsymbol{u}_{\boldsymbol{w} }^{\top}\boldsymbol{v}_{c}\right)\end{aligned}\]</span></p><p><span class="math display">\[\begin{aligned}\frac{\partial J_{\text {naive-softmax} }\left(\boldsymbol{v}_{c}, o,\boldsymbol{U}\right)}{\partial  v_c}&amp;= -u_o + \sum_{o \in \operatorname{Vocab} }\frac{\exp(u_o^\topv_c)}{\sum_{w \in \operatorname{Vocab} } \exp\left(\boldsymbol{u}_{\boldsymbol{w} }^{\top} \boldsymbol{v}_{c}\right)}\frac{\partial (u_o^\top v_c)}{\partial v_c}\\&amp;=-u_o + \sum_{o \in \operatorname{Vocab} } P(O=o | C=c)  u_o \\&amp;=- U y + U \hat y \\&amp;= U(\hat y - y)\end{aligned}\]</span></p><h3 id="é—®é¢˜c-5åˆ†">é—®é¢˜(c) (5åˆ†)</h3><p>è®¡ç®—æŸå¤±å‡½æ•° <spanclass="math inline">\(\boldsymbol{J}_{naive-softmax}(v_c, o,\boldsymbol{U})\)</span> å¯¹ä¸Šä¸‹æ–‡çª—å£å†…çš„è¯ <spanclass="math inline">\(w\)</span> çš„åå¯¼æ•°ï¼Œè€ƒè™‘ä¸¤ç§æƒ…å†µï¼Œå³ <spanclass="math inline">\(w\)</span> æ˜¯å¤–å›´è¯ <spanclass="math inline">\(o\)</span>ï¼Œå’Œ <spanclass="math inline">\(w\)</span> ä¸æ˜¯ <spanclass="math inline">\(o\)</span>ï¼Œç”¨ <spanclass="math inline">\(y\)</span> ï¼Œ<spanclass="math inline">\(\hat{y}\)</span>å’Œ <spanclass="math inline">\(v_c\)</span> æ¥è¡¨ç¤ºã€‚</p><p><strong>ç­”ï¼š</strong> <span class="math display">\[\begin{aligned}\frac{\partial J_{\text {naive-softmax} }\left(\boldsymbol{v}_{c}, o,\boldsymbol{U}\right)}{\partial  u_w}&amp;= -v_c 1_{\lbrace w=o \rbrace } + \frac{\exp(u_w^\top v_c)}{\sum_{w\in \operatorname{Vocab} } \exp \left(\boldsymbol{u}_{\boldsymbol{w}}^{\top} \boldsymbol{v}_{c}\right)}\frac{\partial (u_w^\top v_c)}{\partial u_w}\\&amp;=-v_c  1_{\lbrace w=o \rbrace } +  P(O=w | C=c)  v_c \\&amp;=v_c( \hat y_w -  y_w)\end{aligned}\]</span></p><h3 id="é—®é¢˜d-3åˆ†">é—®é¢˜(d) (3åˆ†)</h3><p>sigmoidå‡½æ•°å¦‚å…¬å¼æ‰€ç¤º <span class="math display">\[\sigma(\boldsymbol{x})=\frac{1}{1+e^{-\boldsymbol{x}}}=\frac{e^{\boldsymbol{x}}}{e^{\boldsymbol{x}}+1}\]</span> è¯·è®¡ç®—å‡ºå®ƒå¯¹äº <span class="math inline">\(x\)</span> çš„å¯¼æ•°ï¼Œ<span class="math inline">\(x\)</span> æ˜¯ä¸€ä¸ªå‘é‡</p><p><strong>ç­”ï¼š</strong></p><p>è®¡ç®—é›…å…‹æ¯”çŸ©é˜µå¯å¾— <span class="math display">\[\begin{aligned}\frac{\partial \sigma(x_i )}{\partial x_j }&amp;= \sigma (x_i) (1 -\sigma(x_i)) 1_{\lbrace i=j\rbrace  }\end{aligned}\]</span> æ‰€ä»¥æœ‰ <span class="math display">\[\frac{\partial \sigma(x)}{\partial  x}=\text{diag}(\sigma(x) (1- \sigma(x)))\]</span></p><h3 id="é—®é¢˜e-4åˆ†">é—®é¢˜(e) (4åˆ†)</h3><p>ç°åœ¨æˆ‘ä»¬è€ƒè™‘è´Ÿé‡‡æ ·çš„æŸå¤±å‡½æ•°ã€‚å‡è®¾æœ‰Kä¸ªè´Ÿæ ·æœ¬ï¼Œè¡¨ç¤ºä¸º<spanclass="math inline">\(w_1, w_2, â€¦, w_K\)</span>ï¼Œå®ƒä»¬å¯¹åº”çš„å‘é‡ä¸º <spanclass="math inline">\(u_1, u_2, â€¦, u_K\)</span>ï¼Œå¤–å›´è¯ <spanclass="math inline">\(o \not\in {w_1, w_2, â€¦, w_K}\)</span>ï¼Œåˆ™å¤–å›´è¯<span class="math inline">\(o\)</span> åœ¨ä¸­å¿ƒè¯æ˜¯ <spanclass="math inline">\(c\)</span> æ—¶äº§ç”Ÿçš„æŸå¤±å‡½æ•°å¦‚å…¬å¼æ‰€ç¤ºã€‚ <spanclass="math display">\[\boldsymbol{J}_{\text {neg-sample }}\left(\boldsymbol{v}_{c}, o,\boldsymbol{U}\right)=-\log \left(\sigma\left(\boldsymbol{u}_{o}^{\top}\boldsymbol{v}_{c}\right)\right)-\sum_{k=1}^{K} \log\left(\sigma\left(-\boldsymbol{u}_{k}^{\top}\boldsymbol{v}_{c}\right)\right)\]</span> æ ¹æ®è¯¥æŸå¤±å‡½æ•°ï¼Œé‡æ–°è®¡ç®—é—®é¢˜(b)ã€é—®é¢˜(c)çš„åå¯¼æ•°ï¼Œç”¨ <spanclass="math inline">\(\boldsymbol{u}_o\)</span>ï¼Œ<spanclass="math inline">\(\boldsymbol{v}_c\)</span>ï¼Œ<spanclass="math inline">\(\boldsymbol{u}_k\)</span> æ¥è¡¨ç¤ºã€‚</p><p>å®Œæˆè®¡ç®—åï¼Œç®€è¦è§£é‡Šä¸ºä»€ä¹ˆè¿™ä¸ªæŸå¤±å‡½æ•°æ¯”naive-softmaxæ•ˆç‡æ›´é«˜ã€‚</p><p>æ³¨æ„ï¼šä½ å¯ä»¥ç”¨é—®é¢˜(d)çš„ç­”æ¡ˆæ¥å¸®åŠ©ä½ è®¡ç®—å¯¼æ•°</p><p><strong>ç­”ï¼š</strong> <span class="math display">\[\begin{aligned}\frac{\partial J_{\text {neg-sample} }\left(v_{c}, o,U\right)}{\partial  v_c}&amp;=-\frac{\sigma\left(\boldsymbol{u}_{o}^{\top}\boldsymbol{v}_{c}\right)\left(1- \sigma\left(\boldsymbol{u}_{o}^{\top}\boldsymbol{v}_{c}\right)\right)}{\sigma\left(\boldsymbol{u}_{o}^{\top}\boldsymbol{v}_{c}\right)}u _o-\sum_{k=1}^K\frac{\sigma\left(-\boldsymbol{u}_{k}^{\top}\boldsymbol{v}_{c}\right)\left(1- \sigma\left(-\boldsymbol{u}_{k}^{\top}\boldsymbol{v}_{c}\right)\right)}{\sigma\left(-\boldsymbol{u}_{k}^{\top}\boldsymbol{v}_{c}\right)}(-u_k)\\&amp;= -\left(1- \sigma\left(\boldsymbol{u}_{o}^{\top}\boldsymbol{v}_{c}\right)\right)u_o+ \sum_{k=1}^K  \left(1- \sigma\left(-\boldsymbol{u}_{k}^{\top}\boldsymbol{v}_{c}\right)\right)u_k\\\frac{\partial J_{\text {neg-sample} }\left(v_{c}, o,U\right)}{\partial  u_o}&amp;=-\frac{\sigma\left(\boldsymbol{u}_{o}^{\top}\boldsymbol{v}_{c}\right)\left(1- \sigma\left(\boldsymbol{u}_{o}^{\top}\boldsymbol{v}_{c}\right)\right)}{\sigma\left(\boldsymbol{u}_{o}^{\top}\boldsymbol{v}_{c}\right)}v _c\\&amp;= -\left(1- \sigma\left(\boldsymbol{u}_{o}^{\top}\boldsymbol{v}_{c}\right)\right)v_c \\\frac{\partial J_{\text {neg-sample} }\left(v_{c}, o,U\right)}{\partial  u_k}&amp;=-\frac{\sigma\left(-\boldsymbol{u}_{k}^{\top}\boldsymbol{v}_{c}\right)\left(1- \sigma\left(-\boldsymbol{u}_{k}^{\top}\boldsymbol{v}_{c}\right)\right)}{\sigma\left(-\boldsymbol{u}_{k}^{\top}\boldsymbol{v}_{c}\right)}(-v_c)\\&amp;= \left(1- \sigma\left(-\boldsymbol{u}_{k}^{\top}\boldsymbol{v}_{c}\right)\right)v_c\end{aligned}\]</span></p><ul><li><p>åŸå§‹çš„æŸå¤±å‡½æ•°ä¸­éœ€è¦æ±‚æŒ‡æ•°å’Œï¼Œå¾ˆå®¹æ˜“æº¢å‡ºï¼Œè´Ÿé‡‡æ ·çš„æŸå¤±å‡½æ•°èƒ½å¾ˆå¥½åœ°è§„é¿è¿™ä¸ªé—®é¢˜ã€‚</p></li><li><p>è¯åº“ä» ğ‘‰ğ‘œğ‘ğ‘ğ‘ å˜æˆäº†K+1ä¸ªè¯</p></li><li><p>åœ¨æ±‚å†…å±‚å¯¼æ•°çš„æ—¶å€™ç”¨äº†sigmoidå‡½æ•°</p></li></ul><h3 id="é—®é¢˜f-3åˆ†">é—®é¢˜(f) (3åˆ†)</h3><p>å‡è®¾ä¸­å¿ƒè¯æ˜¯ <span class="math inline">\(c =w_t\)</span>ï¼Œä¸Šä¸‹æ–‡çª—å£æ˜¯<span class="math inline">\([w_{t-m}, â€¦,w_{t-1}, w_t, w_{t+1}, â€¦, w_{t+m}]\)</span>ï¼Œ<spanclass="math inline">\(m\)</span>æ˜¯çª—å£å¤§å°ï¼Œå›é¡¾skip-gramçš„word2vecå®ç°ï¼Œåœ¨è¯¥çª—å£ä¸‹çš„æ€»æŸå¤±å‡½æ•°æ˜¯ï¼š<span class="math display">\[\boldsymbol{J}_{\text {skip-gram }}\left(\boldsymbol{v}_{c}, w_{t-m},\ldots w_{t+m}, \boldsymbol{U}\right)=\sum_{-m \leq j \leq m \atop j\neq 0} \boldsymbol{J}\left(\boldsymbol{v}_{c}, w_{t+j},\boldsymbol{U}\right)\]</span> è¿™é‡Œï¼Œ<spanclass="math inline">\(\boldsymbol{J}(\boldsymbol{v}_c, w_{t+j},\boldsymbol{U})\)</span>æ˜¯å¤–å›´è¯æ˜¯å¤–å›´è¯<spanclass="math inline">\(w_{t+j}\)</span>åœ¨ä¸­å¿ƒè¯åœ¨ä¸­å¿ƒè¯<spanclass="math inline">\(c=w_t\)</span>ä¸‹äº§ç”Ÿçš„æŸå¤±ï¼ŒæŸå¤±å‡½æ•°å¯ä»¥æ˜¯naive-softmaxæˆ–è€…æ˜¯neg-sampleï¼ˆè´Ÿé‡‡æ ·ï¼‰ï¼Œè¿™å–å†³äºå…·ä½“å®ç°ã€‚</p><p>è®¡ç®—ï¼š</p><ol type="i"><li><p>æŸå¤±å‡½æ•°å¯¹ <span class="math inline">\(U\)</span>çš„åå¯¼æ•°</p></li><li><p>æŸå¤±å‡½æ•°å¯¹ <span class="math inline">\(\boldsymbol{v}_c\)</span>çš„åå¯¼æ•°</p></li><li><p>æŸå¤±å‡½æ•°å¯¹ <span class="math inline">\(\boldsymbol{v}_w\)</span>çš„åå¯¼æ•°</p></li></ol><strong>ç­”ï¼š</strong> $$<span class="math display">\[\begin{aligned}\partial \boldsymbol{J}_{\text {skip-gram } }\left(\boldsymbol{v}_{c},w_{t-m}, \dots w_{t+m}, \boldsymbol{U}\right) / \partial \boldsymbol{U}&amp;=\sum_{-m \leq j \leq m \atop j \neq 0} \partial\boldsymbol{J}\left(\boldsymbol{v}_{c}, w_{t+j}, \boldsymbol{U}\right) /\partial \boldsymbol{U} \\\partial \boldsymbol{J}_{\text {skip-gram } }\left(\boldsymbol{v}_{c},w_{t-m}, \dots w_{t+m}, \boldsymbol{U}\right) / \partial\boldsymbol{v_c}&amp;=\sum_{-m \leq j \leq m \atop j \neq 0} \partial\boldsymbol{J}\left(\boldsymbol{v}_{c}, w_{t+j}, \boldsymbol{U}\right) /\partial  \boldsymbol{v_c} \\\partial \boldsymbol{J}_{\text {skip-gram } }\left(\boldsymbol{v}_{c},w_{t-m}, \dots w_{t+m}, \boldsymbol{U}\right) / \partial\boldsymbol{v_w}&amp;=\sum_{-m \leq j \leq m \atop j \neq 0} \partial\boldsymbol{J}\left(\boldsymbol{v}_{c}, w_{t+j}, \boldsymbol{U}\right) /\partial  \boldsymbol{v_w} \\\end{aligned}\]</span><p>$$</p><h2 id="ä»£ç å®ç°word2vec20åˆ†">ä»£ç ï¼šå®ç°word2vecï¼ˆ20åˆ†ï¼‰</h2><p>ç‚¹å‡» <ahref="http://web.stanford.edu/class/cs224n/assignments/a2.zip">æ­¤å¤„</a>ä¸‹è½½ä»£ç ï¼Œpythonç‰ˆæœ¬ &gt;=3.5ï¼Œéœ€è¦å®‰è£…numpyï¼Œä½ åˆ©ç”¨condaæ¥é…ç½®ç¯å¢ƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">conda env create -f env.yml<br>conda activate a2<br></code></pre></div></td></tr></table></figure><p>å†™å®Œä»£ç åï¼Œè¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">conda deactivate<br></code></pre></div></td></tr></table></figure><h3 id="é—®é¢˜a-12åˆ†">é—®é¢˜(a) (12åˆ†)</h3><p>é¦–å…ˆï¼Œå®ç° word2vec.py é‡Œçš„sigmoidå‡½æ•°ï¼Œè¦æ”¯æŒå‘é‡è¾“å…¥ã€‚æ¥ç€å®ç°åŒä¸€ä¸ªæ–‡ä»¶é‡Œçš„ softmaxã€è´Ÿé‡‡æ ·æŸå¤±å’Œå¯¼æ•°ã€‚ç„¶åå®ç°skip-gramçš„æŸå¤±å‡½æ•°å’Œå¯¼æ•°ã€‚å…¨éƒ¨åšå®Œä¹‹åï¼Œè¿è¡Œpythonword2vec.pyæ¥æ£€æŸ¥æ˜¯å¦æ­£ç¡®ã€‚</p><p><strong>ç­”ï¼š</strong></p><h4 id="sigmoid">sigmoid</h4><p>numpyå…·å¤‡å¹¿æ’­ç‰¹æ€§ï¼Œæœ€ç»ˆå¾—åˆ°å‘é‡è¾“å‡º</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">sigmoid</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Compute the sigmoid function for the input here.</span><br><span class="hljs-string">    Arguments:</span><br><span class="hljs-string">    x -- A scalar or numpy array.</span><br><span class="hljs-string">    Return:</span><br><span class="hljs-string">    s -- sigmoid(x)</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-comment">### YOUR CODE HERE</span><br>    s = <span class="hljs-number">1</span> / (<span class="hljs-number">1</span> + np.exp(-x))<br><br>    <span class="hljs-comment">### END YOUR CODE</span><br><br>    <span class="hljs-keyword">return</span> s<br></code></pre></div></td></tr></table></figure><h4 id="naivesoftmaxlossandgradient">naiveSoftmaxLossAndGradient</h4><p>è¿™ä¸ªæ¨¡å‹å…¶å®å°±æ˜¯ä¸€ä¸ªä¸‰å±‚çš„å‰é¦ˆç¥ç»ç½‘ç»œï¼Œåªéœ€è¦æ³¨æ„ç»´åº¦å³å¯ï¼Œæ³¨é‡Šé‡Œå·²ç»æ ‡è®°å‡ºäº†ç»´åº¦ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå•è¯è¡¨ç¤ºæ˜¯åœ¨è¡Œï¼Œè€Œä¸æ˜¯åˆ—ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">### YOUR CODE HERE</span><br><br><span class="hljs-comment">### Please use the provided softmax function (imported earlier in this file)</span><br><span class="hljs-comment">### This numerically stable implementation helps you avoid issues pertaining</span><br><span class="hljs-comment">### to integer overflow. </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    centerWordVec: 1 * d</span><br><span class="hljs-string">    outsideVectors: n * d</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#1 * n</span><br>vec = centerWordVec.dot(outsideVectors.T)<br><span class="hljs-comment">#1 * n</span><br>prob = softmax(vec)<br>loss = -np.log(prob[outsideWordIdx])<br><span class="hljs-comment">#1 * d</span><br>gradCenterVec = -outsideVectors[outsideWordIdx] + prob.dot(outsideVectors)<br><span class="hljs-comment">#n * d</span><br>gradOutsideVecs = prob.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>).dot(centerWordVec.reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>))<br><span class="hljs-comment">#n * d</span><br>gradOutsideVecs[outsideWordIdx] -= centerWordVec<br><span class="hljs-comment">### END YOUR CODE</span><br></code></pre></div></td></tr></table></figure><h4 id="negsamplinglossandgradient">negSamplingLossAndGradient</h4><p>ä¸native-softmaxä¸åŒçš„æ˜¯ï¼š</p><ul><li>åªé€‰å–Kä¸ªéå¤–å›´è¯ä½œä¸ºè´Ÿæ ·æœ¬ï¼ŒåŠ ä¸Š1ä¸ªæ­£ç¡®çš„å¤–å›´è¯ï¼Œå…±K+1ä¸ªè¾“å‡º</li><li>æœ€åä¸€å±‚ä½¿ç”¨sigmoidè¾“å‡ºï¼Œè€Œä¸æ˜¯softmax</li></ul><p>æ³¨æ„ï¼Œåå‘ä¼ æ’­å¾—åˆ°çš„æ˜¯è¿™K+1ä¸ªè¯çš„æ¢¯åº¦ï¼Œæ‰€ä»¥éœ€è¦æŒ¨ä¸ªæ›´æ–°åˆ°<em>æ¢¯åº¦çŸ©é˜µ</em> ä¸­å»</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">### Please use your implementation of sigmoid in here.</span><br><br><span class="hljs-comment"># indices might have same index</span><br><span class="hljs-comment"># extract W</span><br>W = np.zeros((<span class="hljs-built_in">len</span>(indices), outsideVectors.shape[<span class="hljs-number">1</span>]))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(indices)):<br>    W[i] = outsideVectors[indices[i]]<br><br><span class="hljs-comment"># forward</span><br>a = centerWordVec<br>a = a.reshape((a.shape[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>))<br><br>z = np.dot(W, a) <span class="hljs-comment"># (K+1, 1)</span><br>preds = sigmoid(z)<br><br><span class="hljs-comment"># backprop</span><br>y = np.zeros((preds.shape[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>))<br>y[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span> <span class="hljs-comment"># index 0 is target</span><br><br>loss = -(y*np.log(preds) + (<span class="hljs-number">1</span> - y)*np.log(<span class="hljs-number">1</span> - preds)).<span class="hljs-built_in">sum</span>()<br><br>delta = preds - y<br>gradCenterVec = np.dot(W.T, delta) <span class="hljs-comment"># (V, 1)</span><br>gradW = np.dot(delta, a.T) <span class="hljs-comment"># (K+1, V)</span><br>gradCenterVec = gradCenterVec.flatten()<br><br><span class="hljs-comment"># apply gradW into gradOutsideVecs</span><br>gradOutsideVecs = np.zeros_like(outsideVectors)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(indices)):<br>    oi = indices[i]<br>    gradOutsideVecs[oi] += gradW[i]<br></code></pre></div></td></tr></table></figure><h4 id="skipgram">skipgram</h4><p>éå†æ‰€æœ‰çš„å¤–å›´è¯ï¼Œæ±‚å’ŒæŸå¤±å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">ci = word2Ind[currentCenterWord]<br>vc = centerWordVectors[ci]<br><br><span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> outsideWords:<br>    oi = word2Ind[o]<br>    loss_, gradVc, gradUo = word2vecLossAndGradient(vc, oi, outsideVectors, dataset)<br>    gradCenterVecs[ci] += gradVc<br>    gradOutsideVectors += gradUo<br>    loss += loss_<br></code></pre></div></td></tr></table></figure><h3 id="é—®é¢˜b-4åˆ†">é—®é¢˜(b) (4åˆ†)</h3><p>å®Œæˆsgd.pyæ–‡ä»¶çš„SGDä¼˜åŒ–å™¨ï¼Œè¿è¡Œpython sgd.pyæ¥æ£€æŸ¥æ˜¯å¦æ­£ç¡®ã€‚</p><p><strong>ç­”</strong>ï¼š</p><h4 id="sgd">sgd</h4><p>è°ƒç”¨å‡½æ•°å¾—åˆ°æŸå¤±å€¼å’Œæ¢¯åº¦ï¼Œæ›´æ–°å³å¯</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment">### YOUR CODE HERE</span><br>loss, grad = f(x)<br>x -= step * grad<br><br><span class="hljs-comment">### END YOUR CODE</span><br></code></pre></div></td></tr></table></figure><h3 id="é—®é¢˜c-4åˆ†">é—®é¢˜(c) (4åˆ†)</h3><p>è‡³æ­¤æ‰€æœ‰çš„ä»£ç éƒ½å†™å®Œäº†ï¼Œæ¥ä¸‹æ¥æ˜¯ä¸‹è½½æ•°æ®é›†ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨StanformSentimentTreebank(SST)æ•°æ®é›†ï¼Œå®ƒå¯ä»¥ç”¨åœ¨ç®€å•çš„è¯­ä¹‰åˆ†æä»»åŠ¡ä¸­å»ã€‚é€šè¿‡è¿è¡Œ shget_datasets.sh å¯ä»¥è·å¾—è¯¥æ•°æ®é›†ï¼Œä¸‹è½½å®Œæˆåè¿è¡Œ python run.pyå³å¯ã€‚</p><p>æ³¨æ„ï¼šè®­ç»ƒçš„æ—¶é—´å–å†³äºä»£ç æ˜¯å¦é«˜æ•ˆï¼ˆå³ä¾¿æ˜¯é«˜æ•ˆçš„å®ç°ï¼Œä¹Ÿè¦è·‘æ¥è¿‘ä¸€ä¸ªå°æ—¶ï¼‰</p><p>ç»è¿‡40,000æ¬¡è¿­ä»£åï¼Œæœ€ç»ˆç»“æœä¼šä¿å­˜åˆ° word_vectors.png é‡Œã€‚</p><p><strong>ç­”ï¼š</strong></p><p><img src="http://ww1.sinaimg.cn/large/0060yMmAly1gsz2rwoc9sj30hs0dc3zy.jpg" referrerpolicy="no-referrer" /></p><ul><li>åœ¨ä¸Šå›¾ä¸­å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œmale-&gt;famale å’Œ king -&gt; queenè¿™ä¸¤æ¡å‘é‡æ˜¯å¹³è¡Œçš„</li><li>(women, famale)ï¼Œ(enjoyable,annoying) è¿™äº›å«ä¹‰æ¥è¿‘çš„è¯è·ç¦»å¾ˆè¿‘</li></ul>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>NLP-Assignment1</title>
    <link href="/2022/05/05/NLP-Assignment1/"/>
    <url>/2022/05/05/NLP-Assignment1/</url>
    
    <content type="html"><![CDATA[<h1 id="assignment1">Assignment1</h1><p>æ‰€æœ‰ä½¿ç”¨åˆ°çš„å¤´æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># All Import Statements Defined Here</span><br><span class="hljs-comment"># Note: Do not add to this list.</span><br><span class="hljs-comment"># ----------------</span><br><br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">assert</span> sys.version_info[<span class="hljs-number">0</span>]==<span class="hljs-number">3</span><br><span class="hljs-keyword">assert</span> sys.version_info[<span class="hljs-number">1</span>] &gt;= <span class="hljs-number">5</span><br><br><span class="hljs-keyword">from</span> gensim.models <span class="hljs-keyword">import</span> KeyedVectors<br><span class="hljs-keyword">from</span> gensim.test.utils <span class="hljs-keyword">import</span> datapath<br><span class="hljs-keyword">import</span> pprint<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br>plt.rcParams[<span class="hljs-string">&#x27;figure.figsize&#x27;</span>] = [<span class="hljs-number">10</span>, <span class="hljs-number">5</span>]<br><span class="hljs-keyword">import</span> nltk<br>nltk.download(<span class="hljs-string">&#x27;reuters&#x27;</span>)<br><span class="hljs-keyword">from</span> nltk.corpus <span class="hljs-keyword">import</span> reuters<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> scipy <span class="hljs-keyword">as</span> sp<br><span class="hljs-keyword">from</span> sklearn.decomposition <span class="hljs-keyword">import</span> TruncatedSVD<br><span class="hljs-keyword">from</span> sklearn.decomposition <span class="hljs-keyword">import</span> PCA<br><br>START_TOKEN = <span class="hljs-string">&#x27;&lt;START&gt;&#x27;</span><br>END_TOKEN = <span class="hljs-string">&#x27;&lt;END&gt;&#x27;</span><br><br>np.random.seed(<span class="hljs-number">0</span>)<br>random.seed(<span class="hljs-number">0</span>)<br><span class="hljs-comment"># ----------------</span><br></code></pre></div></td></tr></table></figure><h2 id="part-1åŸºäºè®¡æ•°çš„è¯å‘é‡">Part 1ï¼šåŸºäºè®¡æ•°çš„è¯å‘é‡</h2><p>å¤§å¤šæ•°è¯å‘é‡æ¨¡å‹éƒ½æ˜¯åŸºäºä¸€ä¸ªè§‚ç‚¹ï¼š</p><p><strong>You shall know a word by the company it keeps (<ahref="https://en.wikipedia.org/wiki/John_Rupert_Firth">Firth, J. R.1957:11</a>)</strong></p><p>å¤§å¤šæ•°è¯å‘é‡çš„å®ç°çš„æ ¸å¿ƒæ˜¯ <em>ç›¸ä¼¼è¯</em>ï¼Œä¹Ÿå°±æ˜¯åŒä¹‰è¯ï¼Œå› ä¸ºå®ƒä»¬æœ‰ç›¸ä¼¼çš„ä¸Šä¸‹æ–‡ã€‚è¿™é‡Œæˆ‘ä»¬ä»‹ç»ä¸€ç§ç­–ç•¥å«åš<em>å…±ç°çŸ©é˜µ</em> (æ›´å¤šä¿¡æ¯å¯ä»¥æŸ¥çœ‹ <ahref="http://web.stanford.edu/class/cs124/lec/vectorsemantics.video.pdf">è¿™é‡Œ</a>æˆ– <ahref="https://medium.com/data-science-group-iitr/word-embedding-2d05d270b285">è¿™é‡Œ</a>)</p><p>è¿™éƒ¨åˆ†è¦å®ç°çš„æ˜¯ï¼Œç»™å®šè¯­æ–™åº“ï¼Œæ ¹æ®å…±ç°çŸ©é˜µè®¡ç®—è¯å‘é‡ï¼Œå¾—åˆ°è¯­æ–™åº“ä¸­æ¯ä¸ªè¯çš„è¯å‘é‡ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è®¡ç®—è¯­æ–™åº“çš„å•è¯é›†</li><li>è®¡ç®—å…±ç°çŸ©é˜µ</li><li>ä½¿ç”¨SVDé™ç»´</li><li>åˆ†æè¯å‘é‡</li></ul><h3 id="é—®é¢˜1.1å®ç°-dicintct_words">é—®é¢˜1.1ï¼šå®ç° dicintct_words</h3><p>è®¡ç®—è¯­æ–™åº“çš„å•è¯æ•°é‡ã€å•è¯é›†</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">distinct_words</span>(<span class="hljs-params">corpus</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; Determine a list of distinct words for the corpus.</span><br><span class="hljs-string">        Params:</span><br><span class="hljs-string">            corpus (list of list of strings): corpus of documents</span><br><span class="hljs-string">        Return:</span><br><span class="hljs-string">            corpus_words (list of strings): list of distinct words across the corpus, sorted (using python &#x27;sorted&#x27; function)</span><br><span class="hljs-string">            num_corpus_words (integer): number of distinct words across the corpus</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    corpus_words = []<br>    num_corpus_words = -<span class="hljs-number">1</span><br>    <br>    <span class="hljs-comment"># ------------------</span><br>    <span class="hljs-comment"># Write your implementation here.</span><br>    corpus_words =  <span class="hljs-built_in">sorted</span>(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>([word <span class="hljs-keyword">for</span> sentence <span class="hljs-keyword">in</span> corpus <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> sentence])))<br>    num_corpus_words = <span class="hljs-built_in">len</span>(corpus_words)<br><br>    <span class="hljs-comment"># ------------------</span><br><br>    <span class="hljs-keyword">return</span> corpus_words, num_corpus_words<br></code></pre></div></td></tr></table></figure><p>æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># ---------------------</span><br><span class="hljs-comment"># Run this sanity check</span><br><span class="hljs-comment"># Note that this not an exhaustive check for correctness.</span><br><span class="hljs-comment"># ---------------------</span><br><br><span class="hljs-comment"># Define toy corpus</span><br>test_corpus = [<span class="hljs-string">&quot;&#123;&#125; All that glitters isn&#x27;t gold &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(START_TOKEN, END_TOKEN).split(<span class="hljs-string">&quot; &quot;</span>), <span class="hljs-string">&quot;&#123;&#125; All&#x27;s well that ends well &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(START_TOKEN, END_TOKEN).split(<span class="hljs-string">&quot; &quot;</span>)]<br>test_corpus_words, num_corpus_words = distinct_words(test_corpus)<br><br><span class="hljs-comment"># Correct answers</span><br>ans_test_corpus_words = <span class="hljs-built_in">sorted</span>([START_TOKEN, <span class="hljs-string">&quot;All&quot;</span>, <span class="hljs-string">&quot;ends&quot;</span>, <span class="hljs-string">&quot;that&quot;</span>, <span class="hljs-string">&quot;gold&quot;</span>, <span class="hljs-string">&quot;All&#x27;s&quot;</span>, <span class="hljs-string">&quot;glitters&quot;</span>, <span class="hljs-string">&quot;isn&#x27;t&quot;</span>, <span class="hljs-string">&quot;well&quot;</span>, END_TOKEN])<br>ans_num_corpus_words = <span class="hljs-built_in">len</span>(ans_test_corpus_words)<br><br><span class="hljs-comment"># Test correct number of words</span><br><span class="hljs-keyword">assert</span>(num_corpus_words == ans_num_corpus_words), <span class="hljs-string">&quot;Incorrect number of distinct words. Correct: &#123;&#125;. Yours: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(ans_num_corpus_words, num_corpus_words)<br><br><span class="hljs-comment"># Test correct words</span><br><span class="hljs-keyword">assert</span> (test_corpus_words == ans_test_corpus_words), <span class="hljs-string">&quot;Incorrect corpus_words.\nCorrect: &#123;&#125;\nYours:   &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">str</span>(ans_test_corpus_words), <span class="hljs-built_in">str</span>(test_corpus_words))<br><br><span class="hljs-comment"># Print Success</span><br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">80</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Passed All Tests!&quot;</span>)<br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">80</span>)<br></code></pre></div></td></tr></table></figure><h3id="é—®é¢˜1.2å®ç°compute_co_occurrence_matrix">é—®é¢˜1.2ï¼šå®ç°compute_co_occurrence_matrix</h3><p>è®¡ç®—ç»™å®šè¯­æ–™åº“çš„å…±ç°çŸ©é˜µã€‚å…·ä½“æ¥è¯´ï¼Œå¯¹äºæ¯ä¸€ä¸ªè¯<code>w</code>ï¼Œç»Ÿè®¡å‰ã€åæ–¹ <code>window_size</code> ä¸ªè¯çš„å‡ºç°æ¬¡æ•°</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">compute_co_occurrence_matrix</span>(<span class="hljs-params">corpus, window_size=<span class="hljs-number">4</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot; Compute co-occurrence matrix for the given corpus and window_size (default of 4).</span><br><span class="hljs-string">    </span><br><span class="hljs-string">        Note: Each word in a document should be at the center of a window. Words near edges will have a smaller</span><br><span class="hljs-string">              number of co-occurring words.</span><br><span class="hljs-string">              </span><br><span class="hljs-string">              For example, if we take the document &quot;START All that glitters is not gold END&quot; with window size of 4,</span><br><span class="hljs-string">              &quot;All&quot; will co-occur with &quot;START&quot;, &quot;that&quot;, &quot;glitters&quot;, &quot;is&quot;, and &quot;not&quot;.</span><br><span class="hljs-string">    </span><br><span class="hljs-string">        Params:</span><br><span class="hljs-string">            corpus (list of list of strings): corpus of documents</span><br><span class="hljs-string">            window_size (int): size of context window</span><br><span class="hljs-string">        Return:</span><br><span class="hljs-string">            M (numpy matrix of shape (number of corpus words, number of corpus words)): </span><br><span class="hljs-string">                Co-occurence matrix of word counts. </span><br><span class="hljs-string">                The ordering of the words in the rows/columns should be the same as the ordering of the words given by the distinct_words function.</span><br><span class="hljs-string">            word2Ind (dict): dictionary that maps word to index (i.e. row/column number) for matrix M.</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    words, num_words = distinct_words(corpus)<br>    M = np.zeros((num_words, num_words))<br>    word2Ind = <span class="hljs-built_in">dict</span>([(word, index) <span class="hljs-keyword">for</span> index, word <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(words)])<br>    <br>    <span class="hljs-comment"># ------------------</span><br>    <span class="hljs-comment"># Write your implementation here.</span><br>    <span class="hljs-keyword">for</span> sentence <span class="hljs-keyword">in</span> corpus:<br>        current_index = <span class="hljs-number">0</span><br>        sentence_len = <span class="hljs-built_in">len</span>(sentence)<br>        indices = [word2Ind[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sentence]<br>        <span class="hljs-keyword">while</span> current_index &lt; sentence_len:<br>            left  = <span class="hljs-built_in">max</span>(current_index - window_size, <span class="hljs-number">0</span>)<br>            right = <span class="hljs-built_in">min</span>(current_index + window_size + <span class="hljs-number">1</span>, sentence_len) <br>            current_word = sentence[current_index]<br>            current_word_index = word2Ind[current_word]<br>            words_around = indices[left:current_index] + indices[current_index+<span class="hljs-number">1</span>:right]<br>            <br>            <span class="hljs-keyword">for</span> ind <span class="hljs-keyword">in</span> words_around:<br>                M[current_word_index, ind] += <span class="hljs-number">1</span><br>            <br>            current_index += <span class="hljs-number">1</span><br><br>    <span class="hljs-comment"># ------------------</span><br><br>    <span class="hljs-keyword">return</span> M, word2Ind<br></code></pre></div></td></tr></table></figure><p>æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># ---------------------</span><br><span class="hljs-comment"># Run this sanity check</span><br><span class="hljs-comment"># Note that this is not an exhaustive check for correctness.</span><br><span class="hljs-comment"># ---------------------</span><br><br><span class="hljs-comment"># Define toy corpus and get student&#x27;s co-occurrence matrix</span><br>test_corpus = [<span class="hljs-string">&quot;&#123;&#125; All that glitters isn&#x27;t gold &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(START_TOKEN, END_TOKEN).split(<span class="hljs-string">&quot; &quot;</span>), <span class="hljs-string">&quot;&#123;&#125; All&#x27;s well that ends well &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(START_TOKEN, END_TOKEN).split(<span class="hljs-string">&quot; &quot;</span>)]<br>M_test, word2ind_test = compute_co_occurrence_matrix(test_corpus, window_size=<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># Correct M and word2ind</span><br>M_test_ans = np.array( <br>    [[<span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>,],<br>     [<span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>,],<br>     [<span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>,],<br>     [<span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>,],<br>     [<span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">1.</span>,],<br>     [<span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>,],<br>     [<span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>,],<br>     [<span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>,],<br>     [<span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>,],<br>     [<span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>,]]<br>)<br>ans_test_corpus_words = <span class="hljs-built_in">sorted</span>([START_TOKEN, <span class="hljs-string">&quot;All&quot;</span>, <span class="hljs-string">&quot;ends&quot;</span>, <span class="hljs-string">&quot;that&quot;</span>, <span class="hljs-string">&quot;gold&quot;</span>, <span class="hljs-string">&quot;All&#x27;s&quot;</span>, <span class="hljs-string">&quot;glitters&quot;</span>, <span class="hljs-string">&quot;isn&#x27;t&quot;</span>, <span class="hljs-string">&quot;well&quot;</span>, END_TOKEN])<br>word2ind_ans = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(ans_test_corpus_words, <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(ans_test_corpus_words))))<br><br><span class="hljs-comment"># Test correct word2ind</span><br><span class="hljs-keyword">assert</span> (word2ind_ans == word2ind_test), <span class="hljs-string">&quot;Your word2ind is incorrect:\nCorrect: &#123;&#125;\nYours: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(word2ind_ans, word2ind_test)<br><br><span class="hljs-comment"># Test correct M shape</span><br><span class="hljs-keyword">assert</span> (M_test.shape == M_test_ans.shape), <span class="hljs-string">&quot;M matrix has incorrect shape.\nCorrect: &#123;&#125;\nYours: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(M_test.shape, M_test_ans.shape)<br><br><span class="hljs-comment"># Test correct M values</span><br><span class="hljs-keyword">for</span> w1 <span class="hljs-keyword">in</span> word2ind_ans.keys():<br>    idx1 = word2ind_ans[w1]<br>    <span class="hljs-keyword">for</span> w2 <span class="hljs-keyword">in</span> word2ind_ans.keys():<br>        idx2 = word2ind_ans[w2]<br>        student = M_test[idx1, idx2]<br>        correct = M_test_ans[idx1, idx2]<br>        <span class="hljs-keyword">if</span> student != correct:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Correct M:&quot;</span>)<br>            <span class="hljs-built_in">print</span>(M_test_ans)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Your M: &quot;</span>)<br>            <span class="hljs-built_in">print</span>(M_test)<br>            <span class="hljs-keyword">raise</span> AssertionError(<span class="hljs-string">&quot;Incorrect count at index (&#123;&#125;, &#123;&#125;)=(&#123;&#125;, &#123;&#125;) in matrix M. Yours has &#123;&#125; but should have &#123;&#125;.&quot;</span>.<span class="hljs-built_in">format</span>(idx1, idx2, w1, w2, student, correct))<br><br><span class="hljs-comment"># Print Success</span><br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">80</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Passed All Tests!&quot;</span>)<br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">80</span>)<br></code></pre></div></td></tr></table></figure><h3 id="é—®é¢˜1.3å®ç°-reduce_to_k_dim">é—®é¢˜1.3ï¼šå®ç° reduce_to_k_dim</h3><p>è¿™ä¸€æ­¥æ˜¯é™ç»´ã€‚åœ¨é—®é¢˜1.2å¾—åˆ°çš„æ˜¯ä¸€ä¸ªN xNçš„çŸ©é˜µï¼ˆNæ˜¯å•è¯é›†çš„å¤§å°ï¼‰ï¼Œä½¿ç”¨scikit-learnå®ç°çš„SVDï¼ˆå¥‡å¼‚å€¼åˆ†è§£ï¼‰ï¼Œä»è¿™ä¸ªå¤§çŸ©é˜µé‡Œåˆ†è§£å‡ºä¸€ä¸ªå«kä¸ªç‰¹åˆ¶çš„Nx k å°çŸ©é˜µã€‚</p><p><strong>æ³¨æ„</strong>ï¼šåœ¨numpyã€scipyå’Œscikit-learnéƒ½æä¾›äº†ä¸€äº›SVDçš„å®ç°ï¼Œä½†æ˜¯åªæœ‰scipyã€sklearnæœ‰TruncatedSVDï¼Œå¹¶ä¸”åªæœ‰sklearnæä¾›äº†è®¡ç®—å¤§è§„æ¨¡SVDçš„é«˜æ•ˆçš„randomizedç®—æ³•ï¼Œè¯¦æƒ…å‚è€ƒ<ahref="https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.TruncatedSVD.html">sklearn.decomposition.TruncatedSVD</a>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">reduce_to_k_dim</span>(<span class="hljs-params">M, k=<span class="hljs-number">2</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot; Reduce a co-occurence count matrix of dimensionality (num_corpus_words, num_corpus_words)</span><br><span class="hljs-string">        to a matrix of dimensionality (num_corpus_words, k) using the following SVD function from Scikit-Learn:</span><br><span class="hljs-string">            - http://scikit-learn.org/stable/modules/generated/sklearn.decomposition.TruncatedSVD.html</span><br><span class="hljs-string">    </span><br><span class="hljs-string">        Params:</span><br><span class="hljs-string">            M (numpy matrix of shape (number of corpus words, number of corpus words)): co-occurence matrix of word counts</span><br><span class="hljs-string">            k (int): embedding size of each word after dimension reduction</span><br><span class="hljs-string">        Return:</span><br><span class="hljs-string">            M_reduced (numpy matrix of shape (number of corpus words, k)): matrix of k-dimensioal word embeddings.</span><br><span class="hljs-string">                    In terms of the SVD from math class, this actually returns U * S</span><br><span class="hljs-string">    &quot;&quot;&quot;</span>    <br>    n_iters = <span class="hljs-number">10</span>     <span class="hljs-comment"># Use this parameter in your call to `TruncatedSVD`</span><br>    M_reduced = <span class="hljs-literal">None</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Running Truncated SVD over %i words...&quot;</span> % (M.shape[<span class="hljs-number">0</span>]))<br>    <br>    <span class="hljs-comment"># ------------------</span><br>    <span class="hljs-comment"># Write your implementation here.</span><br>    TSVD = TruncatedSVD(n_components=k, n_iter=n_iters)<br>    M_reduced = TSVD.fit_transform(M)<br><br>    <span class="hljs-comment"># ------------------</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Done.&quot;</span>)<br>    <span class="hljs-keyword">return</span> M_reduced<br></code></pre></div></td></tr></table></figure><p>æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># ---------------------</span><br><span class="hljs-comment"># Run this sanity check</span><br><span class="hljs-comment"># Note that this is not an exhaustive check for correctness </span><br><span class="hljs-comment"># In fact we only check that your M_reduced has the right dimensions.</span><br><span class="hljs-comment"># ---------------------</span><br><br><span class="hljs-comment"># Define toy corpus and run student code</span><br>test_corpus = [<span class="hljs-string">&quot;&#123;&#125; All that glitters isn&#x27;t gold &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(START_TOKEN, END_TOKEN).split(<span class="hljs-string">&quot; &quot;</span>), <span class="hljs-string">&quot;&#123;&#125; All&#x27;s well that ends well &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(START_TOKEN, END_TOKEN).split(<span class="hljs-string">&quot; &quot;</span>)]<br>M_test, word2ind_test = compute_co_occurrence_matrix(test_corpus, window_size=<span class="hljs-number">1</span>)<br>M_test_reduced = reduce_to_k_dim(M_test, k=<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Test proper dimensions</span><br><span class="hljs-keyword">assert</span> (M_test_reduced.shape[<span class="hljs-number">0</span>] == <span class="hljs-number">10</span>), <span class="hljs-string">&quot;M_reduced has &#123;&#125; rows; should have &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(M_test_reduced.shape[<span class="hljs-number">0</span>], <span class="hljs-number">10</span>)<br><span class="hljs-keyword">assert</span> (M_test_reduced.shape[<span class="hljs-number">1</span>] == <span class="hljs-number">2</span>), <span class="hljs-string">&quot;M_reduced has &#123;&#125; columns; should have &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(M_test_reduced.shape[<span class="hljs-number">1</span>], <span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Print Success</span><br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">80</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Passed All Tests!&quot;</span>)<br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">80</span>)<br></code></pre></div></td></tr></table></figure><h3 id="é—®é¢˜1.4-å®ç°-plot_embeddings">é—®é¢˜1.4 å®ç° plot_embeddings</h3><p>åŸºäºmatplotlibï¼Œç”¨<code>scatter</code> ç”» â€œÃ—â€ï¼Œç”¨ <code>text</code>å†™å­—</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_embeddings</span>(<span class="hljs-params">M_reduced, word2Ind, words</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; Plot in a scatterplot the embeddings of the words specified in the list &quot;words&quot;.</span><br><span class="hljs-string">        NOTE: do not plot all the words listed in M_reduced / word2Ind.</span><br><span class="hljs-string">        Include a label next to each point.</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        Params:</span><br><span class="hljs-string">            M_reduced (numpy matrix of shape (number of unique words in the corpus , k)): matrix of k-dimensioal word embeddings</span><br><span class="hljs-string">            word2Ind (dict): dictionary that maps word to indices for matrix M</span><br><span class="hljs-string">            words (list of strings): words whose embeddings we want to visualize</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># ------------------</span><br>    <span class="hljs-comment"># Write your implementation here.</span><br>    <br>    <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> words:<br>        index = word2Ind[w]<br>        embedding = M_reduced[index]<br>        x, y  = embedding[<span class="hljs-number">0</span>], embedding[<span class="hljs-number">1</span>]<br>        plt.scatter(x, y, marker=<span class="hljs-string">&#x27;x&#x27;</span>, color=<span class="hljs-string">&#x27;red&#x27;</span>)<br>        plt.text(x, y, word, fontsize=<span class="hljs-number">9</span>)<br>    plt.show()<br>    <span class="hljs-comment"># ------------------</span><br></code></pre></div></td></tr></table></figure><p>æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># ---------------------</span><br><span class="hljs-comment"># Run this sanity check</span><br><span class="hljs-comment"># Note that this is not an exhaustive check for correctness.</span><br><span class="hljs-comment"># The plot produced should look like the &quot;test solution plot&quot; depicted below. </span><br><span class="hljs-comment"># ---------------------</span><br><br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">80</span>)<br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;Outputted Plot:&quot;</span>)<br><br>M_reduced_plot_test = np.array([[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>], [-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>], [<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>], [-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>]])<br>word2ind_plot_test = &#123;<span class="hljs-string">&#x27;test1&#x27;</span>: <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;test2&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;test3&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;test4&#x27;</span>: <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;test5&#x27;</span>: <span class="hljs-number">4</span>&#125;<br>words = [<span class="hljs-string">&#x27;test1&#x27;</span>, <span class="hljs-string">&#x27;test2&#x27;</span>, <span class="hljs-string">&#x27;test3&#x27;</span>, <span class="hljs-string">&#x27;test4&#x27;</span>, <span class="hljs-string">&#x27;test5&#x27;</span>]<br>plot_embeddings(M_reduced_plot_test, word2ind_plot_test, words)<br><br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">80</span>)<br></code></pre></div></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="/img/nlp/assignment1/1.jpg"/></p><h3 id="é—®é¢˜1.5å…±ç°æ‰“å°åˆ†æ">é—®é¢˜1.5ï¼šå…±ç°æ‰“å°åˆ†æ</h3><p>å°†è¯åµŒå…¥åˆ°2ä¸ªç»´åº¦ä¸Šï¼Œå½’ä¸€åŒ–ï¼Œæœ€ç»ˆè¯å‘é‡ä¼šè½åˆ°ä¸€ä¸ªå•ä½åœ†å†…ï¼Œåœ¨åæ ‡ç³»ä¸Šå¯»æ‰¾ç›¸è¿‘çš„è¯ã€‚</p><p>æµ‹è¯•ç”¨ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># -----------------------------</span><br><span class="hljs-comment"># Run This Cell to Produce Your Plot</span><br><span class="hljs-comment"># ------------------------------</span><br>reuters_corpus = read_corpus()<br>M_co_occurrence, word2ind_co_occurrence = compute_co_occurrence_matrix(reuters_corpus)<br>M_reduced_co_occurrence = reduce_to_k_dim(M_co_occurrence, k=<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Rescale (normalize) the rows to make them each of unit-length</span><br>M_lengths = np.linalg.norm(M_reduced_co_occurrence, axis=<span class="hljs-number">1</span>)<br>M_normalized = M_reduced_co_occurrence / M_lengths[:, np.newaxis] <span class="hljs-comment"># broadcasting</span><br><br>words = [<span class="hljs-string">&#x27;barrels&#x27;</span>, <span class="hljs-string">&#x27;bpd&#x27;</span>, <span class="hljs-string">&#x27;ecuador&#x27;</span>, <span class="hljs-string">&#x27;energy&#x27;</span>, <span class="hljs-string">&#x27;industry&#x27;</span>, <span class="hljs-string">&#x27;kuwait&#x27;</span>, <span class="hljs-string">&#x27;oil&#x27;</span>, <span class="hljs-string">&#x27;output&#x27;</span>, <span class="hljs-string">&#x27;petroleum&#x27;</span>, <span class="hljs-string">&#x27;iraq&#x27;</span>]<br><br>plot_embeddings(M_normalized, word2ind_co_occurrence, words)<br></code></pre></div></td></tr></table></figure><p><img src="/img/nlp/assignment1/2.jpg"/></p><h2 id="part-2åŸºäºé¢„æµ‹çš„è¯å‘é‡">Part 2ï¼šåŸºäºé¢„æµ‹çš„è¯å‘é‡</h2><p>ç›®å‰ï¼ŒåŸºäºé¢„æµ‹çš„è¯å‘é‡æ˜¯æœ€æµè¡Œçš„ï¼Œæ¯”å¦‚word2vecã€‚ç°åœ¨æˆ‘ä»¬æ¥æ¢ç´¢word2vecç”Ÿæˆçš„è¯å‘é‡ï¼Œå¦‚æœæƒ³è¦æ·±å…¥äº†è§£ï¼Œå¯ä»¥è¯»ä¸€è¯»<ahref="https://papers.nips.cc/paper/5021-distributed-representations-of-words-and-phrases-and-their-compositionality.pdf">åŸå§‹è®ºæ–‡</a>ã€‚</p><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯ä½¿ç”¨gensimæ¢ç´¢è¯å‘é‡ï¼Œä¸æ˜¯è‡ªå·±å®ç°word2vecï¼Œæ‰€ä½¿ç”¨çš„è¯å‘é‡ç»´åº¦æ˜¯300ï¼Œç”±googleå‘å¸ƒã€‚</p><p>é¦–å…ˆä½¿ç”¨SVDé™ç»´ï¼Œå°†300ç»´é™2ç»´ï¼Œæ–¹ä¾¿æ‰“å°æŸ¥çœ‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_embedding_model</span>():<br>    <span class="hljs-string">&quot;&quot;&quot; Load GloVe Vectors</span><br><span class="hljs-string">        Return:</span><br><span class="hljs-string">            wv_from_bin: All 400000 embeddings, each lengh 200</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">import</span> gensim.downloader <span class="hljs-keyword">as</span> api<br>    wv_from_bin = api.load(<span class="hljs-string">&quot;glove-wiki-gigaword-200&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loaded vocab size %i&quot;</span> % <span class="hljs-built_in">len</span>(wv_from_bin.vocab.keys()))<br>    <span class="hljs-keyword">return</span> wv_from_bin<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># -----------------------------------</span><br><span class="hljs-comment"># Run Cell to Load Word Vectors</span><br><span class="hljs-comment"># Note: This will take a couple minutes</span><br><span class="hljs-comment"># -----------------------------------</span><br>wv_from_bin = load_embedding_model()<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_matrix_of_vectors</span>(<span class="hljs-params">wv_from_bin, required_words=[<span class="hljs-string">&#x27;barrels&#x27;</span>, <span class="hljs-string">&#x27;bpd&#x27;</span>, <span class="hljs-string">&#x27;ecuador&#x27;</span>, <span class="hljs-string">&#x27;energy&#x27;</span>, <span class="hljs-string">&#x27;industry&#x27;</span>, <span class="hljs-string">&#x27;kuwait&#x27;</span>, <span class="hljs-string">&#x27;oil&#x27;</span>, <span class="hljs-string">&#x27;output&#x27;</span>, <span class="hljs-string">&#x27;petroleum&#x27;</span>, <span class="hljs-string">&#x27;iraq&#x27;</span>]</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; Put the GloVe vectors into a matrix M.</span><br><span class="hljs-string">        Param:</span><br><span class="hljs-string">            wv_from_bin: KeyedVectors object; the 400000 GloVe vectors loaded from file</span><br><span class="hljs-string">        Return:</span><br><span class="hljs-string">            M: numpy matrix shape (num words, 200) containing the vectors</span><br><span class="hljs-string">            word2ind: dictionary mapping each word to its row number in M</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">import</span> random<br>    words = <span class="hljs-built_in">list</span>(wv_from_bin.vocab.keys())<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Shuffling words ...&quot;</span>)<br>    random.seed(<span class="hljs-number">224</span>)<br>    random.shuffle(words)<br>    words = words[:<span class="hljs-number">10000</span>]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Putting %i words into word2ind and matrix M...&quot;</span> % <span class="hljs-built_in">len</span>(words))<br>    word2ind = &#123;&#125;<br>    M = []<br>    curInd = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> words:<br>        <span class="hljs-keyword">try</span>:<br>            M.append(wv_from_bin.word_vec(w))<br>            word2ind[w] = curInd<br>            curInd += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">except</span> KeyError:<br>            <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> required_words:<br>        <span class="hljs-keyword">if</span> w <span class="hljs-keyword">in</span> words:<br>            <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">try</span>:<br>            M.append(wv_from_bin.word_vec(w))<br>            word2ind[w] = curInd<br>            curInd += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">except</span> KeyError:<br>            <span class="hljs-keyword">continue</span><br>    M = np.stack(M)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Done.&quot;</span>)<br>    <span class="hljs-keyword">return</span> M, word2ind<br></code></pre></div></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># -----------------------------------------------------------------</span><br><span class="hljs-comment"># Run Cell to Reduce 200-Dimensional Word Embeddings to k Dimensions</span><br><span class="hljs-comment"># Note: This should be quick to run</span><br><span class="hljs-comment"># -----------------------------------------------------------------</span><br>M, word2ind = get_matrix_of_vectors(wv_from_bin)<br>M_reduced = reduce_to_k_dim(M, k=<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Rescale (normalize) the rows to make them each of unit-length</span><br>M_lengths = np.linalg.norm(M_reduced, axis=<span class="hljs-number">1</span>)<br>M_reduced_normalized = M_reduced / M_lengths[:, np.newaxis] <span class="hljs-comment"># broadcasting</span><br></code></pre></div></td></tr></table></figure><h3 id="é—®é¢˜2.1word2vecæ‰“å°åˆ†æ">é—®é¢˜2.1ï¼šword2vecæ‰“å°åˆ†æ</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">words = [<span class="hljs-string">&#x27;barrels&#x27;</span>, <span class="hljs-string">&#x27;bpd&#x27;</span>, <span class="hljs-string">&#x27;ecuador&#x27;</span>, <span class="hljs-string">&#x27;energy&#x27;</span>, <span class="hljs-string">&#x27;industry&#x27;</span>, <span class="hljs-string">&#x27;kuwait&#x27;</span>, <span class="hljs-string">&#x27;oil&#x27;</span>, <span class="hljs-string">&#x27;output&#x27;</span>, <span class="hljs-string">&#x27;petroleum&#x27;</span>, <span class="hljs-string">&#x27;iraq&#x27;</span>]<br>plot_embeddings(M_reduced_normalized, word2ind, words)<br></code></pre></div></td></tr></table></figure><p>å’Œé—®é¢˜1.5ä¸€æ ·</p><h3 id="é—®é¢˜2.2ä¸€è¯å¤šä¹‰">é—®é¢˜2.2ï¼šä¸€è¯å¤šä¹‰</h3><p>æ‰¾åˆ°ä¸€ä¸ªæœ‰å¤šä¸ªå«ä¹‰çš„è¯ï¼ˆæ¯”å¦‚â€œleavesâ€ï¼Œâ€scoopâ€ï¼‰ï¼Œè¿™ç§è¯çš„top-10ç›¸ä¼¼è¯ï¼ˆæ ¹æ®ä½™å¼¦ç›¸ä¼¼åº¦ï¼‰é‡Œæœ‰ä¸¤ä¸ªè¯çš„æ„æ€ä¸ä¸€æ ·ã€‚æ¯”å¦‚â€leavesâ€ï¼ˆå¶å­ï¼ŒèŠ±ç“£ï¼‰çš„top-10è¯é‡Œæœ‰â€vanishesâ€ï¼ˆæ¶ˆå¤±ï¼‰å’Œâ€stalksâ€ï¼ˆèŒç§†ï¼‰ã€‚</p><p><strong>Note</strong>: You should use the<code>wv_from_bin.most_similar(word)</code> function to get the top 10similar words. This function ranks all other words in the vocabularywith respect to their cosine similarity to the given word. For furtherassistance, please check the <strong><ahref="https://radimrehurek.com/gensim/models/keyedvectors.html#gensim.models.keyedvectors.FastTextKeyedVectors.most_similar">GenSimdocumentation</a></strong>.</p><p>è¿™é‡Œæˆ‘æ‰¾åˆ°çš„è¯æ˜¯â€columnâ€ï¼ˆåˆ—ï¼‰ï¼Œå®ƒçš„top-10é‡Œæœ‰â€columnistâ€ï¼ˆä¸“æ ä½œå®¶ï¼‰å’Œâ€articleâ€ï¼ˆæ–‡ç« ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># ------------------</span><br><span class="hljs-comment"># Write your polysemous word exploration code here.</span><br><br>wv_from_bin.most_similar(<span class="hljs-string">&quot;column&quot;</span>)<br><br><span class="hljs-comment"># ------------------</span><br></code></pre></div></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight scheme"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scheme">[(<span class="hljs-symbol">&#x27;columns</span>&#x27;, <span class="hljs-number">0.767943263053894</span>),<br> (<span class="hljs-symbol">&#x27;columnist</span>&#x27;, <span class="hljs-number">0.6541407108306885</span>),<br> (<span class="hljs-symbol">&#x27;article</span>&#x27;, <span class="hljs-number">0.651928186416626</span>),<br> (<span class="hljs-symbol">&#x27;columnists</span>&#x27;, <span class="hljs-number">0.617466926574707</span>),<br> (<span class="hljs-symbol">&#x27;syndicated_column</span>&#x27;, <span class="hljs-number">0.599014401435852</span>),<br> (<span class="hljs-symbol">&#x27;op_ed</span>&#x27;, <span class="hljs-number">0.588202714920044</span>),<br> (<span class="hljs-symbol">&#x27;Op_Ed</span>&#x27;, <span class="hljs-number">0.5801560282707214</span>),<br> (<span class="hljs-symbol">&#x27;op_ed_column</span>&#x27;, <span class="hljs-number">0.5779396891593933</span>),<br> (<span class="hljs-symbol">&#x27;nationally_syndicated_column</span>&#x27;, <span class="hljs-number">0.572504997253418</span>),<br> (<span class="hljs-symbol">&#x27;colum</span>&#x27;, <span class="hljs-number">0.5595961213111877</span>)]<br></code></pre></div></td></tr></table></figure><h3 id="é—®é¢˜2.3è¿‘ä¹‰è¯å’Œåä¹‰è¯">é—®é¢˜2.3ï¼šè¿‘ä¹‰è¯å’Œåä¹‰è¯</h3><p>æ‰¾åˆ°ä¸‰ä¸ªè¯(w1, w2,w3)ï¼Œå…¶ä¸­w1å’Œw2æ˜¯è¿‘ä¹‰è¯ï¼Œw1å’Œw3æ˜¯åä¹‰è¯ï¼Œä½†æ˜¯w1å’Œw3çš„è·ç¦»&lt;w1å’Œw2çš„è·ç¦»ã€‚ä¾‹å¦‚ï¼šw1=â€happyâ€ï¼Œw2=â€cheerfulâ€ï¼Œw3=â€sadâ€</p><p>You should use the the <code>wv_from_bin.distance(w1, w2)</code>function here in order to compute the cosine distance between two words.Please see the <strong><ahref="https://radimrehurek.com/gensim/models/keyedvectors.html#gensim.models.keyedvectors.FastTextKeyedVectors.distance">GenSimdocumentation</a></strong> for further assistance.</p><p>ä¸ºä»€ä¹ˆåä¹‰è¯çš„ç›¸ä¼¼åº¦åè€Œæ›´å¤§å‘¢ï¼ˆè·ç¦»è¶Šå°è¯´æ˜è¶Šç›¸ä¼¼ï¼‰ï¼Ÿå› ä¸ºä»–ä»¬çš„ä¸Šä¸‹æ–‡é€šå¸¸éå¸¸ä¸€è‡´</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># ------------------</span><br><span class="hljs-comment"># Write your synonym &amp; antonym exploration code here.</span><br><br>w1 = <span class="hljs-string">&quot;love&quot;</span><br>w2 = <span class="hljs-string">&quot;like&quot;</span><br>w3 = <span class="hljs-string">&quot;hate&quot;</span><br>w1_w2_dist = wv_from_bin.distance(w1, w2)<br>w1_w3_dist = wv_from_bin.distance(w1, w3)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Synonyms &#123;&#125;, &#123;&#125; have cosine distance: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(w1, w2, w1_w2_dist))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Antonyms &#123;&#125;, &#123;&#125; have cosine distance: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(w1, w3, w1_w3_dist))<br><br><span class="hljs-comment"># ------------------</span><br></code></pre></div></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">Synonyms</span> love, like have cosine distance: <span class="hljs-number">0</span>.<span class="hljs-number">6328612565994263</span><br><span class="hljs-attribute">Antonyms</span> love, hate have cosine distance: <span class="hljs-number">0</span>.<span class="hljs-number">39960432052612305</span><br></code></pre></div></td></tr></table></figure><h3 id="é—®é¢˜2.4ç±»æ¯”">é—®é¢˜2.4ï¼šç±»æ¯”</h3><p>man å¯¹äºkingï¼Œç›¸å½“äºwomanå¯¹äº___ï¼Œè¿™æ ·çš„é—®é¢˜ä¹Ÿå¯ä»¥ç”¨word2vecæ¥è§£å†³ï¼Œå…³äºmost_similarçš„è¯¦ç»†ç”¨æ³•å¯ä»¥å‚è€ƒ<ahref="https://radimrehurek.com/gensim/models/keyedvectors.html#gensim.models.keyedvectors.FastTextKeyedVectors.most_similar">GenSimæ–‡æ¡£</a>ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬æ‰¾å¦å¤–ä¸€ç»„ç±»æ¯”</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># ------------------</span><br><span class="hljs-comment"># Write your analogy exploration code here.</span><br><span class="hljs-comment"># man : him :: woman : her</span><br>pprint.pprint(wv_from_bin.most_similar(positive=[<span class="hljs-string">&#x27;woman&#x27;</span>, <span class="hljs-string">&#x27;him&#x27;</span>], negative=[<span class="hljs-string">&#x27;man&#x27;</span>]))<br><br><span class="hljs-comment"># ------------------</span><br></code></pre></div></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight scheme"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scheme">[(<span class="hljs-symbol">&#x27;her</span>&#x27;, <span class="hljs-number">0.694490909576416</span>),<br> (<span class="hljs-symbol">&#x27;she</span>&#x27;, <span class="hljs-number">0.6385233402252197</span>),<br> (<span class="hljs-symbol">&#x27;me</span>&#x27;, <span class="hljs-number">0.628451406955719</span>),<br> (<span class="hljs-symbol">&#x27;herself</span>&#x27;, <span class="hljs-number">0.6239798665046692</span>),<br> (<span class="hljs-symbol">&#x27;them</span>&#x27;, <span class="hljs-number">0.5843966007232666</span>),<br> (<span class="hljs-symbol">&#x27;She</span>&#x27;, <span class="hljs-number">0.5237804651260376</span>),<br> (<span class="hljs-symbol">&#x27;myself</span>&#x27;, <span class="hljs-number">0.4885627031326294</span>),<br> (<span class="hljs-symbol">&#x27;saidshe</span>&#x27;, <span class="hljs-number">0.48337966203689575</span>),<br> (<span class="hljs-symbol">&#x27;he</span>&#x27;, <span class="hljs-number">0.48184287548065186</span>),<br> (<span class="hljs-symbol">&#x27;Gail_Quets</span>&#x27;, <span class="hljs-number">0.4784894585609436</span>)]<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ­£ç¡®çš„è®¡ç®—å‡ºäº†â€herâ€</p><h3 id="é—®é¢˜2.5é”™è¯¯çš„ç±»æ¯”">é—®é¢˜2.5ï¼šé”™è¯¯çš„ç±»æ¯”</h3><p>æ‰¾åˆ°ä¸€ä¸ªé”™è¯¯çš„ç±»æ¯”ï¼Œæ ‘ï¼šæ ‘å¶ ï¼šï¼šèŠ±ï¼šèŠ±ç“£</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># ------------------</span><br><span class="hljs-comment"># Write your incorrect analogy exploration code here.</span><br><span class="hljs-comment"># tree : leaf :: flower : petal</span><br>pprint.pprint(wv_from_bin.most_similar(positive=[<span class="hljs-string">&#x27;leaf&#x27;</span>, <span class="hljs-string">&#x27;flower&#x27;</span>], negative=[<span class="hljs-string">&#x27;tree&#x27;</span>]))<br><br><span class="hljs-comment"># ------------------</span><br></code></pre></div></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight scheme"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scheme">[(<span class="hljs-symbol">&#x27;floral</span>&#x27;, <span class="hljs-number">0.5532568693161011</span>),<br> (<span class="hljs-symbol">&#x27;marigold</span>&#x27;, <span class="hljs-number">0.5291938185691833</span>),<br> (<span class="hljs-symbol">&#x27;tulip</span>&#x27;, <span class="hljs-number">0.521312952041626</span>),<br> (<span class="hljs-symbol">&#x27;rooted_cuttings</span>&#x27;, <span class="hljs-number">0.5189826488494873</span>),<br> (<span class="hljs-symbol">&#x27;variegation</span>&#x27;, <span class="hljs-number">0.5136324763298035</span>),<br> (<span class="hljs-symbol">&#x27;Asiatic_lilies</span>&#x27;, <span class="hljs-number">0.5132641792297363</span>),<br> (<span class="hljs-symbol">&#x27;gerberas</span>&#x27;, <span class="hljs-number">0.5106234550476074</span>),<br> (<span class="hljs-symbol">&#x27;gerbera_daisies</span>&#x27;, <span class="hljs-number">0.5101010203361511</span>),<br> (<span class="hljs-symbol">&#x27;Verbena_bonariensis</span>&#x27;, <span class="hljs-number">0.5070016980171204</span>),<br> (<span class="hljs-symbol">&#x27;violet</span>&#x27;, <span class="hljs-number">0.5058108568191528</span>)]<br></code></pre></div></td></tr></table></figure><p>ç»“æœè¾“å‡ºçš„é‡Œé¢æ²¡æœ‰â€œèŠ±ç“£â€</p><h3 id="é—®é¢˜2.6åè§åˆ†æ">é—®é¢˜2.6ï¼šåè§åˆ†æ</h3><p>æ³¨æ„åè§æ˜¯å¾ˆé‡è¦çš„æ¯”å¦‚æ€§åˆ«æ­§è§†ã€ç§æ—æ­§è§†ç­‰ï¼Œæ‰§è¡Œä¸‹é¢ä»£ç ï¼Œåˆ†æä¸¤ä¸ªé—®é¢˜ï¼š</p><ol type="a"><li><p>å“ªä¸ªè¯ä¸â€œwomanâ€å’Œâ€œbossâ€æœ€ç›¸ä¼¼ï¼Œå’Œâ€œmanâ€æœ€ä¸ç›¸ä¼¼?</p></li><li><p>å“ªä¸ªè¯ä¸â€œmanâ€å’Œâ€œbossâ€æœ€ç›¸ä¼¼ï¼Œå’Œâ€œwomanâ€æœ€ä¸ç›¸ä¼¼?</p></li></ol><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># Run this cell</span><br><span class="hljs-comment"># Here `positive` indicates the list of words to be similar to and `negative` indicates the list of words to be</span><br><span class="hljs-comment"># most dissimilar from.</span><br>pprint.pprint(wv_from_bin.most_similar(positive=[<span class="hljs-string">&#x27;woman&#x27;</span>, <span class="hljs-string">&#x27;boss&#x27;</span>], negative=[<span class="hljs-string">&#x27;man&#x27;</span>]))<br><span class="hljs-built_in">print</span>()<br>pprint.pprint(wv_from_bin.most_similar(positive=[<span class="hljs-string">&#x27;man&#x27;</span>, <span class="hljs-string">&#x27;boss&#x27;</span>], negative=[<span class="hljs-string">&#x27;woman&#x27;</span>]))<br></code></pre></div></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight scheme"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scheme">[(<span class="hljs-symbol">&#x27;bosses</span>&#x27;, <span class="hljs-number">0.5522644519805908</span>),<br> (<span class="hljs-symbol">&#x27;manageress</span>&#x27;, <span class="hljs-number">0.49151360988616943</span>),<br> (<span class="hljs-symbol">&#x27;exec</span>&#x27;, <span class="hljs-number">0.45940813422203064</span>),<br> (<span class="hljs-symbol">&#x27;Manageress</span>&#x27;, <span class="hljs-number">0.45598435401916504</span>),<br> (<span class="hljs-symbol">&#x27;receptionist</span>&#x27;, <span class="hljs-number">0.4474116563796997</span>),<br> (<span class="hljs-symbol">&#x27;Jane_Danson</span>&#x27;, <span class="hljs-number">0.44480544328689575</span>),<br> (<span class="hljs-symbol">&#x27;Fiz_Jennie_McAlpine</span>&#x27;, <span class="hljs-number">0.44275766611099243</span>),<br> (<span class="hljs-symbol">&#x27;Coronation_Street_actress</span>&#x27;, <span class="hljs-number">0.44275566935539246</span>),<br> (<span class="hljs-symbol">&#x27;supremo</span>&#x27;, <span class="hljs-number">0.4409853219985962</span>),<br> (<span class="hljs-symbol">&#x27;coworker</span>&#x27;, <span class="hljs-number">0.43986251950263977</span>)]<br><br>[(<span class="hljs-symbol">&#x27;supremo</span>&#x27;, <span class="hljs-number">0.6097398400306702</span>),<br> (<span class="hljs-symbol">&#x27;MOTHERWELL_boss</span>&#x27;, <span class="hljs-number">0.5489562153816223</span>),<br> (<span class="hljs-symbol">&#x27;CARETAKER_boss</span>&#x27;, <span class="hljs-number">0.5375303626060486</span>),<br> (<span class="hljs-symbol">&#x27;Bully_Wee_boss</span>&#x27;, <span class="hljs-number">0.5333974361419678</span>),<br> (<span class="hljs-symbol">&#x27;YEOVIL_Town_boss</span>&#x27;, <span class="hljs-number">0.5321705341339111</span>),<br> (<span class="hljs-symbol">&#x27;head_honcho</span>&#x27;, <span class="hljs-number">0.5281980037689209</span>),<br> (<span class="hljs-symbol">&#x27;manager_Stan_Ternent</span>&#x27;, <span class="hljs-number">0.525971531867981</span>),<br> (<span class="hljs-symbol">&#x27;Viv_Busby</span>&#x27;, <span class="hljs-number">0.5256162881851196</span>),<br> (<span class="hljs-symbol">&#x27;striker_Gabby_Agbonlahor</span>&#x27;, <span class="hljs-number">0.5250812768936157</span>),<br> (<span class="hljs-symbol">&#x27;BARNSLEY_boss</span>&#x27;, <span class="hljs-number">0.5238943099975586</span>)]<br></code></pre></div></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªç±»æ¯” ç”·äºº:å¥³äºº ::è€æ¿:___ï¼Œæœ€åˆé€‚çš„è¯åº”è¯¥æ˜¯â€landladyâ€ï¼ˆè€æ¿å¨˜ï¼‰ä¹‹ç±»çš„ï¼Œä½†æ˜¯top-10é‡Œåªæœ‰â€manageressâ€ï¼ˆå¥³ç»ç†ï¼‰ï¼Œâ€receptionistâ€ï¼ˆæ¥å¾…å‘˜ï¼‰ä¹‹ç±»çš„è¯ã€‚</p><p>ç¬¬äºŒä¸ªç±»æ¯” å¥³äºº:ç”·äºº :: è€æ¿:___ï¼Œè¾“å‡ºçš„ä¸çŸ¥é“æ˜¯äº›ä»€ä¹ˆä¸œè¥¿/æ‚è„¸</p><h3 id="é—®é¢˜2.7è‡ªè¡Œåˆ†æåè§">é—®é¢˜2.7ï¼šè‡ªè¡Œåˆ†æåè§</h3><p>è¿™é‡Œæˆ‘æ‰¾çš„ä¾‹å­æ˜¯ï¼š</p><ul><li>ç”·äºº:å¥³äºº :: åŒ»ç”Ÿ:___</li><li>å¥³äºº:ç”·äºº :: åŒ»ç”Ÿ:___</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># ------------------</span><br><span class="hljs-comment"># Write your bias exploration code here.</span><br><br>pprint.pprint(wv_from_bin.most_similar(positive=[<span class="hljs-string">&#x27;woman&#x27;</span>, <span class="hljs-string">&#x27;doctor&#x27;</span>], negative=[<span class="hljs-string">&#x27;man&#x27;</span>]))<br><span class="hljs-built_in">print</span>()<br>pprint.pprint(wv_from_bin.most_similar(positive=[<span class="hljs-string">&#x27;man&#x27;</span>, <span class="hljs-string">&#x27;doctor&#x27;</span>], negative=[<span class="hljs-string">&#x27;woman&#x27;</span>]))<br><br><span class="hljs-comment"># ------------------</span><br></code></pre></div></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight scheme"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scheme">[(<span class="hljs-symbol">&#x27;gynecologist</span>&#x27;, <span class="hljs-number">0.7093892097473145</span>),<br> (<span class="hljs-symbol">&#x27;nurse</span>&#x27;, <span class="hljs-number">0.647728681564331</span>),<br> (<span class="hljs-symbol">&#x27;doctors</span>&#x27;, <span class="hljs-number">0.6471461057662964</span>),<br> (<span class="hljs-symbol">&#x27;physician</span>&#x27;, <span class="hljs-number">0.64389967918396</span>),<br> (<span class="hljs-symbol">&#x27;pediatrician</span>&#x27;, <span class="hljs-number">0.6249487996101379</span>),<br> (<span class="hljs-symbol">&#x27;nurse_practitioner</span>&#x27;, <span class="hljs-number">0.6218312978744507</span>),<br> (<span class="hljs-symbol">&#x27;obstetrician</span>&#x27;, <span class="hljs-number">0.6072014570236206</span>),<br> (<span class="hljs-symbol">&#x27;ob_gyn</span>&#x27;, <span class="hljs-number">0.5986712574958801</span>),<br> (<span class="hljs-symbol">&#x27;midwife</span>&#x27;, <span class="hljs-number">0.5927063226699829</span>),<br> (<span class="hljs-symbol">&#x27;dermatologist</span>&#x27;, <span class="hljs-number">0.5739566683769226</span>)]<br><br>[(<span class="hljs-symbol">&#x27;physician</span>&#x27;, <span class="hljs-number">0.6463665962219238</span>),<br> (<span class="hljs-symbol">&#x27;doctors</span>&#x27;, <span class="hljs-number">0.5858404040336609</span>),<br> (<span class="hljs-symbol">&#x27;surgeon</span>&#x27;, <span class="hljs-number">0.5723941326141357</span>),<br> (<span class="hljs-symbol">&#x27;dentist</span>&#x27;, <span class="hljs-number">0.552364706993103</span>),<br> (<span class="hljs-symbol">&#x27;cardiologist</span>&#x27;, <span class="hljs-number">0.5413815975189209</span>),<br> (<span class="hljs-symbol">&#x27;neurologist</span>&#x27;, <span class="hljs-number">0.5271126627922058</span>),<br> (<span class="hljs-symbol">&#x27;neurosurgeon</span>&#x27;, <span class="hljs-number">0.5249835848808289</span>),<br> (<span class="hljs-symbol">&#x27;urologist</span>&#x27;, <span class="hljs-number">0.5247740149497986</span>),<br> (<span class="hljs-symbol">&#x27;Doctor</span>&#x27;, <span class="hljs-number">0.5240625143051147</span>),<br> (<span class="hljs-symbol">&#x27;internist</span>&#x27;, <span class="hljs-number">0.5183224081993103</span>)]<br></code></pre></div></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªç±»æ¯”ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†â€nurseâ€ï¼ˆæŠ¤å£«ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰åè§çš„ç±»æ¯”</p><h3 id="é—®é¢˜2.8æ€è€ƒåè§é—®é¢˜">é—®é¢˜2.8ï¼šæ€è€ƒåè§é—®é¢˜</h3><p>ä»€ä¹ˆä¼šå¯¼è‡´è¯å‘é‡é‡Œçš„åè§ï¼Ÿ</p><p>å› ä¸ºæ•°æ®é›†ä¸­æœ‰åè§</p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><p>[1] CS224n: Natural Language Processing with Deep Learning,2019-03-12. http://web.stanford.edu/class/cs224n.</p><p>[2]https://github.com/ShowMeAI-Hub/awesome-AI-courses-notes-cheatsheets/tree/main/CS224n-Natural-Language-Processing-with-Deep-Learning/assignment-solutions/Assignment1</p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬äºŒè®²-è¯å‘é‡è¿›é˜¶</title>
    <link href="/2022/05/05/%E7%AC%AC%E4%BA%8C%E8%AE%B2-%E8%AF%8D%E5%90%91%E9%87%8F%E8%BF%9B%E9%98%B6/"/>
    <url>/2022/05/05/%E7%AC%AC%E4%BA%8C%E8%AE%B2-%E8%AF%8D%E5%90%91%E9%87%8F%E8%BF%9B%E9%98%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="ç®—æ³•ä¼˜åŒ–åŸºç¡€">1 ç®—æ³•ä¼˜åŒ–åŸºç¡€</h1><h2 id="è¯å‘é‡æ¢¯åº¦ä¸‹é™ç®—æ³•">1.1 è¯å‘é‡æ¢¯åº¦ä¸‹é™ç®—æ³•</h2><p>é—®é¢˜ï¼šæ¢¯åº¦ä¸‹é™ä¼šä¸€æ¬¡æ€§ä½¿ç”¨æ‰€æœ‰æ•°æ®æ ·æœ¬è¿›è¡Œå‚æ•°æ›´æ–°ï¼Œå¯¹åº”åˆ°æˆ‘ä»¬å½“å‰çš„è¯å‘é‡å»ºæ¨¡é—®é¢˜ï¼Œå°±æ˜¯<spanclass="math inline">\(J(\theta)\)</span>çš„è®¡ç®—éœ€è¦åŸºäºè¯­æ–™åº“æ‰€æœ‰çš„æ ·æœ¬(çª—å£)ï¼Œæ•°æ®è§„æ¨¡éå¸¸å¤§ï¼š</p><ul><li>è®¡ç®—éå¸¸è€—èµ„æº</li><li>è®¡ç®—æ—¶é—´é•¿</li></ul><p>è§£å†³æ–¹æ¡ˆï¼šéšæœºæ¢¯åº¦ä¸‹é™ç®—æ³• Stochastic Gradient Descentï¼ˆSGDï¼‰</p><ul><li>åœ¨å•ä¸ªæ ·æœ¬ä¸­è®¡ç®—å’Œæ›´æ–°å‚æ•°ï¼Œå¹¶éå†æ‰€æœ‰æ ·æœ¬</li></ul><p>ä½†åŸºäºå•ä¸ªæ ·æœ¬æ›´æ–°ä¼šè¡¨ç°ä¸ºå‚æ•°éœ‡è¡å¾ˆå‰å®³ï¼Œæ”¶æ•›è¿‡ç¨‹å¹¶ä¸å¹³ç¨³ï¼Œæ‰€ä»¥å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¼šæ”¹ä¸ºä½¿ç”¨<strong>mini-batchgradient descent</strong></p><h2 id="è¯å‘é‡å»ºæ¨¡ä¸­çš„éšæœºæ¢¯åº¦ä¸‹é™">1.2 è¯å‘é‡å»ºæ¨¡ä¸­çš„éšæœºæ¢¯åº¦ä¸‹é™</h2><ul><li>åº”ç”¨éšæœºæ¢¯åº¦ä¸‹é™ï¼Œåœ¨æ¯ä¸ªçª—å£è®¡ç®—å’Œæ›´æ–°å‚æ•°ï¼Œéå†æ‰€æœ‰æ ·æœ¬</li><li>åœ¨æ¯ä¸ªçª—å£å†…ï¼Œæˆ‘ä»¬æœ€å¤šåªæœ‰<spanclass="math inline">\(2m+1\)</span>ä¸ªè¯ï¼Œå› æ­¤<spanclass="math inline">\(\nabla_{\theta}J_{t}(\theta)\)</span>æ˜¯éå¸¸ç¨€ç–çš„</li></ul><p><span class="math display">\[\nabla_{\theta} J_{t}(\theta)=\left[\begin{array}{l}0 \\\vdots \\\nabla_{v_{\text {like }}} \\\vdots \\0 \\\nabla_{u_{I}} \\\vdots \\\nabla_{u_{\text {learning }}} \\\vdots\end{array}\right] \in \mathbb{R}^{2 d V}\]</span></p><p>ä¸Šé¢æåˆ°çš„ç¨€ç–æ€§é—®é¢˜ï¼Œä¸€ç§è§£å†³æ–¹å¼æ˜¯æˆ‘ä»¬<strong>åªæ›´æ–°å®é™…å‡ºç°çš„å‘é‡</strong></p><ul><li>éœ€è¦ç¨€ç–çŸ©é˜µæ›´æ–°æ“ä½œæ¥åªæ›´æ–°çŸ©é˜µ<spanclass="math inline">\(U\)</span>å’Œ<spanclass="math inline">\(V\)</span>ä¸­çš„ç‰¹å®šè¡Œ</li><li>éœ€è¦ä¿ç•™å•è¯å‘é‡çš„å“ˆå¸Œ/æ•£åˆ—</li></ul><p>å¦‚æœæœ‰æ•°ç™¾ä¸‡ä¸ªå•è¯å‘é‡ï¼Œå¹¶ä¸”è¿›è¡Œåˆ†å¸ƒå¼è®¡ç®—ï¼Œæˆ‘ä»¬æ— éœ€å†ä¼ è¾“å·¨å¤§çš„æ›´æ–°ä¿¡æ¯ï¼ˆæ•°æ®ä¼ è¾“æœ‰æˆæœ¬ï¼‰</p><h2 id="word2vecçš„æ›´å¤šç»†èŠ‚">1.3 Word2vecçš„æ›´å¤šç»†èŠ‚</h2><p>word2vecæœ‰ä¸¤ä¸ªæ¨¡å‹å˜ä½“ï¼š</p><ul><li>1.Skip-grams (SG)ï¼šè¾“å…¥ä¸­å¿ƒè¯å¹¶é¢„æµ‹ä¸Šä¸‹æ–‡ä¸­çš„å•è¯</li><li>2.Continuous Bag of Words(CBOW)ï¼šè¾“å…¥ä¸Šä¸‹æ–‡ä¸­çš„å•è¯å¹¶é¢„æµ‹ä¸­å¿ƒè¯</li></ul><p>ä¹‹å‰ä¸€ç›´ä½¿ç”¨naiveçš„softmax(ç®€å•ä½†ä»£ä»·å¾ˆé«˜çš„è®­ç»ƒæ–¹æ³•)ï¼Œå…¶å®å¯ä»¥ä½¿ç”¨è´Ÿé‡‡æ ·æ–¹æ³•åŠ å¿«è®­ç»ƒé€Ÿç‡</p><h2 id="è´Ÿä¾‹é‡‡æ ·çš„skip-gramæ¨¡å‹ä½œä¸š2">1.4è´Ÿä¾‹é‡‡æ ·çš„skip-gramæ¨¡å‹ï¼ˆä½œä¸š2ï¼‰</h2><p>softmaxä¸­ç”¨äºå½’ä¸€åŒ–çš„åˆ†æ¯çš„è®¡ç®—ä»£ä»·å¤ªé«˜</p><ul><li>æˆ‘ä»¬å°†åœ¨ä½œä¸š2ä¸­å®ç°ä½¿ç”¨ negative sampling/è´Ÿä¾‹é‡‡æ ·æ–¹æ³•çš„ skip-gramæ¨¡å‹ã€‚</li><li>ä½¿ç”¨ä¸€ä¸ª true pair (ä¸­å¿ƒè¯åŠå…¶ä¸Šä¸‹æ–‡çª—å£ä¸­çš„è¯)ä¸å‡ ä¸ª noise pair(ä¸­å¿ƒè¯ä¸éšæœºè¯æ­é…) å½¢æˆçš„æ ·æœ¬ï¼Œè®­ç»ƒäºŒå…ƒé€»è¾‘å›å½’ã€‚</li></ul><p>åŸæ–‡ä¸­çš„(æœ€å¤§åŒ–)ç›®æ ‡å‡½æ•°æ˜¯ï¼š<spanclass="math inline">\(J(\theta)=\frac{1}{T} \sum_{t=1}^{T}J_{t}(\theta)\)</span> <span class="math display">\[J_{t}(\theta)=\log \sigma\left(u_{o}^{T} v_{c}\right)+\sum_{i=1}^{k}\mathbb{E}_{j \sim P(w)}\left[\log \sigma\left(-u_{j}^{T}v_{c}\right)\right]\]</span></p><ul><li>å·¦ä¾§ä¸ºsigmoidå‡½æ•°(å¤§å®¶ä¼šåœ¨åç»­çš„å†…å®¹é‡Œç»å¸¸è§åˆ°å®ƒ)</li><li>æˆ‘ä»¬è¦æœ€å¤§åŒ–2ä¸ªè¯å…±ç°çš„æ¦‚ç‡</li></ul><p>æœ¬è¯¾ä»¥åŠä½œä¸šä¸­çš„ç›®æ ‡å‡½æ•°æ˜¯: <span class="math display">\[J_{n e g-s a m p l e}\left(\boldsymbol{o}, \boldsymbol{v}_{c},\boldsymbol{U}\right)=-\log \left(\sigma\left(\boldsymbol{u}_{o}^{\top}\boldsymbol{v}_{c}\right)\right)-\sum_{k=1}^{K} \log\left(\sigma\left(-\boldsymbol{u}_{k}^{\top}\boldsymbol{v}_{c}\right)\right)\]</span></p><ul><li>æˆ‘ä»¬å–<span class="math inline">\(K\)</span>ä¸ªè´Ÿä¾‹é‡‡æ ·</li><li>æœ€å¤§åŒ–çª—å£ä¸­åŒ…å›´ã€Œä¸­å¿ƒè¯ã€çš„è¿™äº›è¯è¯­å‡ºç°çš„æ¦‚ç‡ï¼Œè€Œæœ€å°åŒ–å…¶ä»–æ²¡æœ‰å‡ºç°çš„éšæœºè¯çš„æ¦‚ç‡</li><li><span class="math inline">\(P(w)=U(w)^{3 / 4} /Z\)</span>æˆ‘ä»¬ç”¨å·¦ä¾§çš„å…¬å¼è¿›è¡ŒæŠ½æ ·ï¼Œå…¶ä¸­<spanclass="math inline">\(U(w)\)</span>â€‹æ˜¯ unigram åˆ†å¸ƒ</li><li>é€šè¿‡ 3/4 æ¬¡æ–¹ï¼Œç›¸å¯¹å‡å°‘å¸¸è§å•è¯çš„é¢‘ç‡ï¼Œå¢å¤§ç¨€æœ‰è¯çš„æ¦‚ç‡</li><li><span class="math inline">\(Z\)</span>ç”¨äºç”Ÿæˆæ¦‚ç‡åˆ†å¸ƒ</li></ul><h1 id="è®¡æ•°ä¸å…±çº¿çŸ©é˜µ">2 è®¡æ•°ä¸å…±çº¿çŸ©é˜µ</h1><h2 id="å…±ç°çŸ©é˜µä¸è¯å‘é‡æ„å»º">2.1 å…±ç°çŸ©é˜µä¸è¯å‘é‡æ„å»º</h2><p>åœ¨è‡ªç„¶è¯­è¨€å¤„ç†é‡Œå¦å¤–ä¸€ä¸ªæ„å»ºè¯å‘é‡çš„æ€è·¯æ˜¯å€ŸåŠ©äº<strong>å…±ç°çŸ©é˜µ</strong>ï¼ˆæˆ‘ä»¬è®¾å…¶ä¸º<spanclass="math inline">\(X\)</span>ï¼‰ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§æ–¹å¼ï¼Œå¯ä»¥åŸºäºçª—å£ï¼ˆwindowï¼‰æˆ–è€…å…¨æ–‡æ¡£ï¼ˆfulldocument)ç»Ÿè®¡ï¼š</p><ul><li><strong>Window</strong>ï¼šä¸word2vecç±»ä¼¼ï¼Œåœ¨æ¯ä¸ªå•è¯å‘¨å›´éƒ½ä½¿ç”¨Windowï¼ŒåŒ…æ‹¬è¯­æ³•(POS)å’Œè¯­ä¹‰ä¿¡æ¯</li><li><strong>Word-document</strong>å…±ç°çŸ©é˜µçš„åŸºæœ¬å‡è®¾æ˜¯åœ¨åŒä¸€ç¯‡æ–‡ç« ä¸­å‡ºç°çš„å•è¯æ›´æœ‰å¯èƒ½ç›¸äº’å…³è”ã€‚å‡è®¾å•è¯<spanclass="math inline">\(i\)</span>å‡ºç°åœ¨æ–‡ç« <spanclass="math inline">\(j\)</span>ä¸­ï¼Œåˆ™çŸ©é˜µå…ƒç´ <spanclass="math inline">\(X_{ij}\)</span>åŠ ä¸€ï¼Œå½“æˆ‘ä»¬å¤„ç†å®Œæ•°æ®åº“ä¸­çš„æ‰€æœ‰æ–‡ç« åï¼Œå°±å¾—åˆ°äº†çŸ©é˜µ<spanclass="math inline">\(X\)</span>ï¼Œå…¶å¤§å°ä¸º<spanclass="math inline">\(|V| \times M\)</span>ï¼Œå…¶ä¸­<spanclass="math inline">\(|V|\)</span>ä¸ºè¯æ±‡é‡ï¼Œè€Œ<spanclass="math inline">\(M\)</span>ä¸ºæ–‡ç« æ•°ã€‚è¿™ä¸€æ„å»ºå•è¯æ–‡ç« co-occurrencematrixçš„æ–¹æ³•ä¹Ÿæ˜¯ç»å…¸çš„Latent SemanticAnalysisæ‰€é‡‡ç”¨çš„ã€è¯­ä¹‰åˆ†æã€‘ã€‚</li></ul><h2 id="åŸºäºçª—å£çš„å…±ç°çŸ©é˜µç¤ºä¾‹">2.2 åŸºäºçª—å£çš„å…±ç°çŸ©é˜µç¤ºä¾‹</h2><p>åˆ©ç”¨æŸä¸ªå®šé•¿çª—å£(é€šå¸¸å–5-10)ä¸­å•è¯ä¸å•è¯åŒæ—¶å‡ºç°çš„æ¬¡æ•°ï¼Œæ¥äº§ç”ŸåŸºäºçª—å£çš„å…±ç°çŸ©é˜µã€‚</p><p>ä¸‹é¢ä»¥çª—å£é•¿åº¦ä¸º1æ¥ä¸¾ä¾‹ï¼Œå‡è®¾æˆ‘ä»¬çš„æ•°æ®åŒ…å«ä»¥ä¸‹å‡ ä¸ªå¥å­ï¼š</p><ul><li>I like deep learning.</li><li>I like NLP.</li><li>I enjoy flying.</li></ul><p>æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„è¯è¯å…±ç°çŸ©é˜µï¼ˆword-word co-occurrence matrixï¼‰</p><p><img src="/img/nlp/ç¬¬äºŒè®²/1.png" /></p><h2 id="åŸºäºç›´æ¥çš„å…±ç°çŸ©é˜µæ„å»ºè¯å‘é‡çš„é—®é¢˜">2.3åŸºäºç›´æ¥çš„å…±ç°çŸ©é˜µæ„å»ºè¯å‘é‡çš„é—®é¢˜</h2><p>ç›´æ¥åŸºäºå…±ç°çŸ©é˜µæ„å»ºè¯å‘é‡ï¼Œä¼šæœ‰ä¸€äº›æ˜æ˜¾çš„é—®é¢˜ï¼Œå¦‚ä¸‹ï¼š</p><ul><li>ä½¿ç”¨å…±ç°æ¬¡æ•°è¡¡é‡å•è¯çš„ç›¸ä¼¼æ€§ï¼Œä½†æ˜¯ä¼šéšç€è¯æ±‡é‡çš„å¢åŠ è€Œå¢å¤§çŸ©é˜µçš„å¤§å°ã€‚</li><li>éœ€è¦å¾ˆå¤šç©ºé—´æ¥å­˜å‚¨è¿™ä¸€é«˜ç»´çŸ©é˜µã€‚</li><li>åç»­çš„åˆ†ç±»æ¨¡å‹ä¹Ÿä¼šç”±äºçŸ©é˜µçš„ç¨€ç–æ€§è€Œå­˜åœ¨ç¨€ç–æ€§é—®é¢˜ï¼Œä½¿å¾—æ•ˆæœä¸ä½³ã€‚</li></ul><h2 id="è§£å†³æ–¹æ¡ˆä½ç»´å‘é‡">2.4 è§£å†³æ–¹æ¡ˆï¼šä½ç»´å‘é‡</h2><p>é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬çš„ä¸€ä¸ªå¤„ç†æ–¹å¼æ˜¯é™ç»´ï¼Œè·å¾—ä½ç»´ç¨ å¯†å‘é‡ã€‚</p><ul><li>é€šå¸¸é™ç»´åˆ°(25-1000)ç»´ï¼Œå’Œword2vecç±»ä¼¼</li></ul><p>å¦‚ä½•é™ç»´å‘¢ï¼Ÿ</p><h2 id="æ–¹æ³•1å¯¹xè¿›è¡Œé™ç»´ä½œä¸š1">2.5 æ–¹æ³•1ï¼šå¯¹Xè¿›è¡Œé™ç»´ï¼ˆä½œä¸š1ï¼‰</h2><p>å¯ä»¥ä½¿ç”¨å¥‡å¼‚å€¼åˆ†è§£ï¼ˆSVDï¼‰æ–¹æ³•å°†å…±ç°çŸ©é˜µ<spanclass="math inline">\(X\)</span>åˆ†è§£ä¸º<span class="math inline">\(U\Sigma V^{T}\)</span>ï¼Œå…¶ä¸­ï¼š</p><ul><li><spanclass="math inline">\(\Sigma\)</span>æ˜¯å¯¹è§’çº¿çŸ©é˜µï¼Œå¯¹è§’çº¿ä¸Šçš„å€¼æ˜¯çŸ©é˜µçš„å¥‡å¼‚å€¼</li><li><span class="math inline">\(U\)</span>ï¼Œ<spanclass="math inline">\(V\)</span>æ˜¯å¯¹åº”äºè¡Œå’Œåˆ—çš„æ­£äº¤åŸº</li></ul><p>ä¸ºäº†å‡å°‘å°ºåº¦åŒæ—¶å°½é‡ä¿å­˜æœ‰æ•ˆä¿¡æ¯ï¼Œå¯ä¿ç•™å¯¹è§’çŸ©é˜µçš„æœ€å¤§çš„<spanclass="math inline">\(k\)</span>ä¸ªå€¼ï¼Œå¹¶å°†çŸ©é˜µ<spanclass="math inline">\(U\)</span>ï¼Œ<spanclass="math inline">\(V\)</span>çš„ç›¸åº”çš„è¡Œåˆ—ä¿ç•™ã€‚</p><ul><li>è¿™æ˜¯ç»å…¸çš„çº¿æ€§ä»£æ•°ç®—æ³•ï¼Œå¯¹äºå¤§å‹çŸ©é˜µè€Œè¨€ï¼Œè®¡ç®—ä»£ä»·æ˜‚è´µã€‚</li></ul><h2 id="è¯å‘é‡svdåˆ†è§£çš„pythonä»£ç ç¤ºä¾‹">2.6è¯å‘é‡SVDåˆ†è§£çš„pythonä»£ç ç¤ºä¾‹</h2><p><img src="/img/nlp/ç¬¬äºŒè®²/2.png" /></p><p>å°†å‘é‡è¿›è¡Œå¯è§†åŒ–</p><p><img src="/img/nlp/ç¬¬äºŒè®²/3.png" /></p><h2 id="è®ºæ–‡è®²è§£">2.7 è®ºæ–‡è®²è§£</h2><h3 id="hacks-to-x-several-used-in-rohde-et-al.-2005">Hacks to X(several used in Rohde et al. 2005)</h3><p>æŒ‰æ¯”ä¾‹è°ƒæ•´ counts ä¼šå¾ˆæœ‰æ•ˆ</p><ul><li>å¯¹é«˜é¢‘è¯è¿›è¡Œç¼©æ”¾(è¯­æ³•æœ‰å¤ªå¤šçš„å½±å“)<ul><li>ä½¿ç”¨logè¿›è¡Œç¼©æ”¾</li><li><span class="math inline">\(\min (X, t), t \approx 100\)</span></li><li>ç›´æ¥å…¨éƒ¨å¿½è§†</li></ul></li><li>åœ¨åŸºäºwindowçš„è®¡æ•°ä¸­ï¼Œæé«˜æ›´åŠ æ¥è¿‘çš„å•è¯çš„è®¡æ•°</li><li>ä½¿ç”¨Personç›¸å…³ç³»æ•°</li></ul><h2 id="è¯å‘é‡åˆ†å¸ƒæ¢ç©¶">2.8 è¯å‘é‡åˆ†å¸ƒæ¢ç©¶</h2><p>å¦‚æœå¯¹è¯å‘é‡è¿›è¡Œç©ºé—´åˆ†å¸ƒï¼Œä¼šå‘ç°åŒä¸€ä¸ªè¯æ±‡çš„é™„è¿‘åˆ†å¸ƒç€å®ƒä¸åŒæ—¶æ€è¯­æ€çš„å•è¯ï¼š</p><ul><li><span class="math inline">\(dirve \to deriver\)</span></li><li><span class="math inline">\(swim \to swimmer\)</span></li><li><span class="math inline">\(teach \to teacher\)</span></li></ul><p>åœ¨å‘é‡ä¸­å‡ºç°çš„æœ‰è¶£çš„å¥æ³•æ¨¡å¼ï¼šè¯­ä¹‰å‘é‡åŸºæœ¬ä¸Šæ˜¯çº¿æ€§ç»„ä»¶ï¼Œè™½ç„¶æœ‰ä¸€äº›æ‘†åŠ¨ï¼Œä½†æ˜¯åŸºæœ¬æ˜¯å­˜åœ¨åŠ¨è¯å’ŒåŠ¨è¯å®æ–½è€…çš„æ–¹å‘ã€‚</p><h2 id="åŸºäºè®¡æ•°-vs.-åŸºäºé¢„ä¼°">2.9 åŸºäºè®¡æ•° VS. åŸºäºé¢„ä¼°</h2><p>æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹åŸºäºå…±ç°çŸ©é˜µè®¡æ•°å’ŒåŸºäºé¢„ä¼°æ¨¡å‹ä¸¤ç§å¾—åˆ°è¯å‘é‡çš„æ–¹å¼</p><p><strong>åŸºäºè®¡æ•°</strong>ï¼šä½¿ç”¨æ•´ä¸ªçŸ©é˜µçš„å…¨å±€ç»Ÿè®¡æ•°æ®æ¥ç›´æ¥ä¼°è®¡</p><ul><li><strong>ä¼˜ç‚¹</strong>ï¼šè®­ç»ƒå¿«é€Ÿï¼›ç»Ÿè®¡æ•°æ®é«˜æ•ˆåˆ©ç”¨</li><li><strong>ç¼ºç‚¹</strong>ï¼šä¸»è¦ç”¨äºæ•æ‰å•è¯ç›¸ä¼¼æ€§ï¼›å¯¹å¤§é‡æ•°æ®ç»™äºˆæ¯”ä¾‹å¤±è°ƒçš„é‡è§†</li></ul><p><strong>åŸºäºé¢„ä¼°æ¨¡å‹</strong>ï¼šå®šä¹‰æ¦‚ç‡åˆ†å¸ƒå¹¶è¯•å›¾é¢„æµ‹å•è¯</p><ul><li><strong>ä¼˜ç‚¹</strong>ï¼šæé«˜å…¶ä»–ä»»åŠ¡çš„æ€§èƒ½ï¼›èƒ½æ•è·é™¤äº†å•è¯ç›¸ä¼¼æ€§ä»¥å¤–çš„å¤æ‚çš„æ¨¡å¼</li><li><strong>ç¼ºç‚¹</strong>ï¼šéšè¯­æ–™åº“å¢å¤§ä¼šå¢å¤§è§„æ¨¡ï¼›ç»Ÿè®¡æ•°æ®çš„ä½æ•ˆä½¿ç”¨ï¼ˆé‡‡æ ·æ˜¯å¯¹ç»Ÿè®¡æ•°æ®çš„ä½æ•ˆä½¿ç”¨ï¼‰</li></ul><h1 id="gloveæ¨¡å‹">3 GloVeæ¨¡å‹</h1><h2 id="è®ºæ–‡è®²è§£-1">3.1 è®ºæ–‡è®²è§£</h2><h3 id="encoding-meaning-in-vector-differences">3.1.1 Encoding meaningin vector differences</h3><p>GloVeæ¨¡å‹å…³é”®æ€æƒ³ï¼šå…±ç°æ¦‚ç‡çš„æ¯”å€¼å¯ä»¥å¯¹meaningcomponentè¿›è¡Œç¼–ç ã€‚å°†ä¸¤ä¸ªæµæ´¾çš„æƒ³æ³•ç»“åˆèµ·æ¥ï¼Œåœ¨ç¥ç»ç½‘ç»œä¸­ä½¿ç”¨è®¡æ•°çŸ©é˜µã€‚</p><p><img src="/img/nlp/ç¬¬äºŒè®²/4.png" /></p><p>ä¾‹å¦‚æˆ‘ä»¬æƒ³åŒºåˆ†çƒ­åŠ›å­¦ä¸Šä¸¤ç§ä¸åŒçŠ¶æ€iceå†°ä¸è’¸æ±½steamï¼Œå¦‚æœåªæ˜¯çœ‹æ¦‚ç‡åˆ™æ•°å€¼å¾ˆå°ï¼Œä¸èƒ½é€éœ²æœ‰æ•ˆçš„ä¿¡æ¯ï¼Œä½†æ˜¯ä»–ä»¬çš„æ¯”å€¼æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ä½¿ç”¨æ¯”å€¼æ›´èƒ½ä½“ç°ä¿¡æ¯ã€‚å›¾ä¸­å¯ä»¥çœ‹å‡ºsolidæ›´å¸¸æ¥æè¿°iceçš„çŠ¶æ€è€Œä¸æ˜¯steamï¼Œæ‰€ä»¥solidåœ¨iceçš„ä¸Šä¸‹æ–‡ä¸­å‡ºç°çš„å‡ ç‡æ›´å¤§ã€‚å¯¹äºgasåˆ™æ°æ°ç›¸åï¼Œè€Œå¯¹äºwaterè¿™ç§æè¿°iceä¸steamå‡å¯æˆ–è€…fashionè¿™ç§ä¸ä¸¤è€…éƒ½æ²¡ä»€ä¹ˆè”ç³»çš„å•è¯ï¼Œåˆ™æ¯”å€¼æ¥è¿‘äº1ã€‚æ‰€ä»¥ç›¸è¾ƒäºå•çº¯çš„å…±ç°æ¦‚ç‡ï¼Œå®é™…ä¸Šå…±ç°æ¦‚ç‡çš„ç›¸å¯¹æ¯”å€¼æ›´æœ‰æ„ä¹‰ã€‚</p><h3id="combining-the-best-of-both-worlds-glove-pennington-et-al.-emnlp-2014">3.1.2Combining the best of both worlds GloVe [Pennington et al., EMNLP2014]</h3><p><span class="math display">\[w_i \cdot w_j = \log P(i|j)\]</span></p><p><span class="math display">\[J=\sum_{i, j=1}^{V} f\left(X_{i j}\right)\left(w_{i}^{T}\tilde{w}_{j}+b_{i}+\tilde{b}_{j}-\log X_{i j}\right)^{2}\]</span></p><ul><li>è®­ç»ƒå¿«é€Ÿ</li><li>å¯ä»¥æ‰©å±•åˆ°å¤§å‹è¯­æ–™åº“</li><li>å³ä½¿æ˜¯å°è¯­æ–™åº“å’Œå°å‘é‡ï¼Œæ€§èƒ½ä¹Ÿå¾ˆå¥½</li></ul><h2 id="gloveçš„ä¸€äº›ç»“æœå±•ç¤º">3.2 GloVeçš„ä¸€äº›ç»“æœå±•ç¤º</h2><p>ä¸‹å›¾æ˜¯ä¸€ä¸ªGloVeè¯å‘é‡ç¤ºä¾‹ï¼Œæˆ‘ä»¬é€šè¿‡GloVeå¾—åˆ°çš„è¯å‘é‡ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°frogï¼ˆé’è›™ï¼‰æœ€æ¥è¿‘çš„ä¸€äº›è¯æ±‡ï¼Œå¯ä»¥çœ‹å‡ºå®ƒä»¬æœ¬èº«æ˜¯å¾ˆç±»ä¼¼çš„åŠ¨ç‰©ã€‚</p><p><img src="/img/nlp/ç¬¬äºŒè®²/5.png" /></p><h1 id="è¯å‘é‡ä¼°è®¡">4 è¯å‘é‡ä¼°è®¡</h1><h2 id="å¦‚ä½•è¯„ä¼°è¯å‘é‡">4.1 å¦‚ä½•è¯„ä¼°è¯å‘é‡ï¼Ÿ</h2><p>æˆ‘ä»¬å¦‚ä½•è¯„ä¼°è¯å‘é‡å‘¢ï¼Œæœ‰å†…åœ¨å’Œå¤–åœ¨ä¸¤ç§æ–¹å¼ï¼š</p><ul><li><strong>å†…åœ¨è¯„ä¼°æ–¹å¼</strong><ul><li>å¯¹ç‰¹å®š/ä¸­é—´å­ä»»åŠ¡è¿›è¡Œè¯„ä¼°</li><li>è®¡ç®—é€Ÿåº¦å¿«</li><li>æœ‰åŠ©äºç†è§£è¿™ä¸ªç³»ç»Ÿ</li><li>ä¸æ¸…æ¥šæ˜¯å¦çœŸçš„æœ‰ç”¨ï¼Œé™¤éä¸å®é™…ä»»åŠ¡å»ºç«‹äº†ç›¸å…³æ€§</li></ul></li><li><strong>å¤–éƒ¨ä»»åŠ¡æ–¹å¼</strong><ul><li>å¯¹çœŸå®ä»»åŠ¡ï¼ˆå¦‚ä¸‹æ¸¸NLPä»»åŠ¡ï¼‰çš„è¯„ä¼°</li><li>è®¡ç®—ç²¾ç¡®åº¦å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´</li><li>ä¸æ¸…æ¥šå­ç³»ç»Ÿé—®é¢˜æ‰€åœ¨ï¼Œæ˜¯äº¤äº’è¿˜æ˜¯å…¶ä»–å­ç³»ç»Ÿé—®é¢˜</li><li>å¦‚æœç”¨å¦ä¸€ä¸ªå­ç³»ç»Ÿæ›¿æ¢ä¸€ä¸ªå­ç³»ç»Ÿå¯ä»¥æé«˜ç²¾ç¡®åº¦</li></ul></li></ul><h2 id="å†…åœ¨è¯å‘é‡è¯„ä¼°">4.2 å†…åœ¨è¯å‘é‡è¯„ä¼°</h2><p>ä¸€ç§å†…åœ¨è¯å‘é‡è¯„ä¼°æ–¹å¼æ˜¯ã€Œ<strong>è¯å‘é‡ç±»æ¯”</strong>ã€ï¼šå¯¹äºå…·å¤‡æŸç§å…³ç³»çš„è¯å¯¹a,bï¼Œåœ¨ç»™å®šè¯cçš„æƒ…å†µä¸‹ï¼Œæ‰¾åˆ°å…·å¤‡ç±»ä¼¼å…³ç³»çš„è¯d<span class="math display">\[a: b:: c: ? \rightarrow d=\arg \max _{i}\frac{\left(x_{b}-x_{a}+x_{c}\right)^{T}x_{i}}{\left\|x_{b}-x_{a}+x_{c}\right\|}\]</span></p><ul><li>é€šè¿‡åŠ æ³•åçš„ä½™å¼¦è·ç¦»æ˜¯å¦èƒ½å¾ˆå¥½åœ°æ•æ‰åˆ°ç›´è§‚çš„è¯­ä¹‰å’Œå¥æ³•ç±»æ¯”é—®é¢˜æ¥è¯„ä¼°å•è¯å‘é‡</li><li>ä»æœç´¢ä¸­ä¸¢å¼ƒè¾“å…¥çš„å•è¯</li><li>é—®é¢˜:å¦‚æœæœ‰ä¿¡æ¯ä½†ä¸æ˜¯çº¿æ€§çš„æ€ä¹ˆåŠï¼Ÿ</li></ul><h2 id="gloveå¯è§†åŒ–æ•ˆæœ">4.3 Gloveå¯è§†åŒ–æ•ˆæœ</h2><p>ä¸‹å›¾ä¸ºGloVeå¾—åˆ°çš„è¯å‘é‡ç©ºé—´åˆ†å¸ƒï¼Œæˆ‘ä»¬å¯¹è¯å‘é‡è¿›è¡Œå‡æ³•è®¡ç®—ï¼Œå¯ä»¥å‘ç°ç±»æ¯”çš„è¯å¯¹æœ‰ç›¸ä¼¼çš„è·ç¦»ã€‚</p><p>brother â€“ sister, man â€“ woman, king - queen</p><p><img src="/img/nlp/ç¬¬äºŒè®²/6.png" /></p><h2 id="ç±»æ¯”ä»»åŠ¡è¯„ä¼°ä¸è¶…å‚æ•°">4.4 ç±»æ¯”ä»»åŠ¡è¯„ä¼°ä¸è¶…å‚æ•°</h2><p><img src="/img/nlp/ç¬¬äºŒè®²/7.png" /></p><p><img src="/img/nlp/ç¬¬äºŒè®²/8.png" /></p><ul><li>æ•°æ®é›†è¶Šå¤§è¶Šå¥½ï¼Œå¹¶ä¸”ç»´åŸºç™¾ç§‘æ•°æ®é›†æ¯”æ–°é—»æ–‡æœ¬æ•°æ®é›†è¦å¥½</li><li>300æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è¯å‘é‡ç»´åº¦</li></ul><h2 id="å¦ä¸€ä¸ªå†…åœ¨çš„è¯å‘é‡è¯„ä¼°">4.5 å¦ä¸€ä¸ªå†…åœ¨çš„è¯å‘é‡è¯„ä¼°</h2><p><img src="/img/nlp/ç¬¬äºŒè®²/9.png" /></p><h2 id="ç›¸å…³æ€§è¯„ä¼°">4.6 ç›¸å…³æ€§è¯„ä¼°</h2><h3 id="section"><img src="/img/nlp/ç¬¬äºŒè®²/10.png" /></h3><h1 id="word-senses">5 word senses</h1><h2 id="è¯ä¹‰ä¸è¯ä¹‰æ­§ä¹‰">5.1 è¯ä¹‰ä¸è¯ä¹‰æ­§ä¹‰</h2><p>å¤§å¤šæ•°å•è¯éƒ½æ˜¯å¤šä¹‰çš„</p><ul><li>ç‰¹åˆ«æ˜¯å¸¸è§å•è¯</li><li>ç‰¹åˆ«æ˜¯å­˜åœ¨å·²ä¹…çš„å•è¯</li></ul><p>ä¾‹å¦‚ï¼špike</p><p>é‚£ä¹ˆï¼Œè¯å‘é‡æ˜¯æ€»ä½“æ•æ‰äº†æ‰€æœ‰è¿™äº›ä¿¡æ¯ï¼Œè¿˜æ˜¯æ‚ä¹±åœ¨ä¸€èµ·äº†å‘¢ï¼Ÿ</p><h2 id="pikeçš„ä¸åŒå«ä¹‰ç¤ºä¾‹">5.2 pikeçš„ä¸åŒå«ä¹‰ç¤ºä¾‹</h2><p><img src="/img/nlp/ç¬¬äºŒè®²/11.png" /></p><h2 id="è®ºæ–‡è®²è§£-2">5.3 è®ºæ–‡è®²è§£</h2><h3id="improving-word-representations-via-global-context-and-multiple-word-prototypes-huang-et-al.-2012">5.3.1Improving Word Representations Via Global Context And Multiple WordPrototypes (Huang et al. 2012)</h3><p><img src="/img/nlp/ç¬¬äºŒè®²/12.png" /></p><p>å°†å¸¸ç”¨è¯çš„æ‰€æœ‰ä¸Šä¸‹æ–‡è¿›è¡Œèšç±»ï¼Œé€šè¿‡è¯¥è¯å¾—åˆ°ä¸€äº›æ¸…æ™°çš„ç°‡ï¼Œä»è€Œå°†è¿™ä¸ªå¸¸ç”¨è¯åˆ†è§£ä¸ºå¤šä¸ªå•è¯ï¼Œä¾‹å¦‚bank1ã€bank2</p><h3id="linear-algebraic-structure-of-word-senses-with-applications-to-polysemy">5.3.2Linear Algebraic Structure of Word Senses, with Applications toPolysemy</h3><ul><li>å•è¯åœ¨æ ‡å‡†å•è¯åµŒå…¥(å¦‚word2vec)ä¸­çš„ä¸åŒå«ä¹‰ä»¥çº¿æ€§å åŠ (åŠ æƒå’Œ)çš„å½¢å¼å­˜åœ¨</li></ul><p><span class="math display">\[v_{pike} = \alpha_1 v_{pike_1} + \alpha_2 v_{pike_2} + \alpha_3v_{pike_3}\]</span></p><ul><li>å…¶ä¸­ï¼Œ<span class="math inline">\(\alpha =\frac{f_{1}}{f_{1}+f_{2}+f_{3}}\)</span></li></ul><p>ä»¤äººæƒŠè®¶çš„ç»“æœï¼š</p><ul><li>åªæ˜¯åŠ æƒå¹³å‡å€¼å°±å·²ç»å¯ä»¥è·å¾—å¾ˆå¥½çš„æ•ˆæœ</li><li>ç”±äºä»ç¨€ç–ç¼–ç ä¸­å¾—åˆ°çš„æ¦‚å¿µï¼Œä½ å®é™…ä¸Šå¯ä»¥å°†æ„Ÿå®˜åˆ†ç¦»å‡ºæ¥(å‰ææ˜¯å®ƒä»¬ç›¸å¯¹æ¯”è¾ƒå¸¸è§)</li></ul><h2 id="å¤–å‘è¯å‘é‡è¯„ä¼°">5.4 å¤–å‘è¯å‘é‡è¯„ä¼°</h2><ul><li>å•è¯å‘é‡çš„å¤–éƒ¨è¯„ä¼°ï¼šè¯å‘é‡å¯ä»¥åº”ç”¨äºNLPçš„å¾ˆå¤šä¸‹æ¸¸ä»»åŠ¡</li><li>ä¸€ä¸ªä¾‹å­æ˜¯åœ¨å‘½åå®ä½“è¯†åˆ«ä»»åŠ¡ä¸­ï¼Œå¯»æ‰¾äººåã€æœºæ„åã€åœ°ç†ä½ç½®åï¼Œè¯å‘é‡éå¸¸æœ‰å¸®åŠ©</li></ul><p><img src="/img/nlp/ç¬¬äºŒè®²/13.png" /></p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>å›æº¯</title>
    <link href="/2022/05/03/%E5%9B%9E%E6%BA%AF/"/>
    <url>/2022/05/03/%E5%9B%9E%E6%BA%AF/</url>
    
    <content type="html"><![CDATA[<h2 id="ç”µè¯å·ç çš„å­—æ¯ç»„åˆ">17ã€ç”µè¯å·ç çš„å­—æ¯ç»„åˆ</h2><p><img src="/img/LeetCode/å­—ç¬¦ä¸²/17.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">letterCombinations</span>(<span class="hljs-params">self, digits: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:<br>        <span class="hljs-keyword">if</span> digits == <span class="hljs-string">&#x27;&#x27;</span>:<br>            <span class="hljs-keyword">return</span> []<br><br>        phoneMap = &#123;<br>        <span class="hljs-string">&#x27;2&#x27;</span>: <span class="hljs-string">&#x27;abc&#x27;</span>,<br>        <span class="hljs-string">&#x27;3&#x27;</span>: <span class="hljs-string">&#x27;def&#x27;</span>,<br>        <span class="hljs-string">&#x27;4&#x27;</span>: <span class="hljs-string">&#x27;ghi&#x27;</span>,<br>        <span class="hljs-string">&#x27;5&#x27;</span>: <span class="hljs-string">&#x27;jkl&#x27;</span>,<br>        <span class="hljs-string">&#x27;6&#x27;</span>: <span class="hljs-string">&#x27;mno&#x27;</span>,<br>        <span class="hljs-string">&#x27;7&#x27;</span>: <span class="hljs-string">&#x27;pqrs&#x27;</span>,<br>        <span class="hljs-string">&#x27;8&#x27;</span>: <span class="hljs-string">&#x27;tuv&#x27;</span>,<br>        <span class="hljs-string">&#x27;9&#x27;</span>: <span class="hljs-string">&#x27;wxyz&#x27;</span>,   <br>        &#125;<br>        <br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">backtrack</span>(<span class="hljs-params">index: <span class="hljs-built_in">int</span></span>):<span class="hljs-comment"># å›æº¯</span><br>            <span class="hljs-keyword">if</span> index == <span class="hljs-built_in">len</span>(digits):<br>                combinations.append(<span class="hljs-string">&#x27;&#x27;</span>.join(combination))<br>            <span class="hljs-keyword">else</span>:<br>                digit = digits[index]<br>                <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> phoneMap[digit]:<br>                    combination.append(ch)<br>                    backtrack(index + <span class="hljs-number">1</span>)<br>                    combination.pop()<br><br>        combination = <span class="hljs-built_in">list</span>()<br>        combinations = <span class="hljs-built_in">list</span>()<br>        backtrack(<span class="hljs-number">0</span>)<br><br>        <span class="hljs-keyword">return</span> combinations<br></code></pre></div></td></tr></table></figure><h2 id="æ‹¬å·ç”Ÿæˆ">22ã€æ‹¬å·ç”Ÿæˆ</h2><p><img src="/img/LeetCode/å­—ç¬¦ä¸²/22.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generateParenthesis</span>(<span class="hljs-params">self, n: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:<br>        ans = []<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">backtrack</span>(<span class="hljs-params">S, left, right</span>):<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(S) == <span class="hljs-number">2</span> * n:<br>                ans.append(<span class="hljs-string">&#x27;&#x27;</span>.join(S))<br>                <span class="hljs-keyword">return</span><br>            <span class="hljs-keyword">if</span> left &lt; n:<br>                S.append(<span class="hljs-string">&#x27;(&#x27;</span>)<br>                backtrack(S, left + <span class="hljs-number">1</span>, right)<br>                S.pop()<br>            <span class="hljs-keyword">if</span> right &lt; left:<br>                S.append(<span class="hljs-string">&#x27;)&#x27;</span>)<br>                backtrack(S, left, right + <span class="hljs-number">1</span>)<br>                S.pop()<br>        backtrack([], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="ç»„åˆæ€»å’Œ">39ã€ç»„åˆæ€»å’Œ</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/39.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">combinationSum</span>(<span class="hljs-params">self, candidates: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], target: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]]:<br>        candidates.sort()<br>        n = <span class="hljs-built_in">len</span>(candidates)<br>        res = []<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">backtrack</span>(<span class="hljs-params">i, tmp_sum, tmp</span>):<br>            <span class="hljs-keyword">if</span>  tmp_sum &gt; target <span class="hljs-keyword">or</span> i == n:<br>                <span class="hljs-keyword">return</span> <br>            <span class="hljs-keyword">if</span> tmp_sum == target:<br>                res.append(tmp)<br>                <span class="hljs-keyword">return</span> <br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i, n):<br>                <span class="hljs-keyword">if</span> tmp_sum + candidates[j] &gt; target:<br>                    <span class="hljs-keyword">break</span><br>                backtrack(j, tmp_sum+candidates[j], tmp+[candidates[j]])<br>        backtrack(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, [])<br>        <span class="hljs-keyword">return</span> res<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>LeetCode</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬ä¸€è®²-NLPä»‹ç»ä¸è¯å‘é‡åˆæ­¥</title>
    <link href="/2022/05/01/%E7%AC%AC%E4%B8%80%E8%AE%B2-NLP%E4%BB%8B%E7%BB%8D%E4%B8%8E%E8%AF%8D%E5%90%91%E9%87%8F%E5%88%9D%E6%AD%A5/"/>
    <url>/2022/05/01/%E7%AC%AC%E4%B8%80%E8%AE%B2-NLP%E4%BB%8B%E7%BB%8D%E4%B8%8E%E8%AF%8D%E5%90%91%E9%87%8F%E5%88%9D%E6%AD%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="è‡ªç„¶è¯­è¨€ä¸è¯æ±‡å«ä¹‰">1 è‡ªç„¶è¯­è¨€ä¸è¯æ±‡å«ä¹‰</h1><h2 id="å¦‚ä½•åœ¨è®¡ç®—æœºé‡Œè¡¨è¾¾è¯çš„æ„ä¹‰">1.1 å¦‚ä½•åœ¨è®¡ç®—æœºé‡Œè¡¨è¾¾è¯çš„æ„ä¹‰</h2><p>è¦ä½¿ç”¨è®¡ç®—æœºå¤„ç†æ–‡æœ¬è¯æ±‡ï¼Œä¸€ç§å¤„ç†æ–¹å¼æ˜¯<strong>WordNet</strong>ï¼šå³æ„å»ºä¸€ä¸ªåŒ…å«åŒä¹‰è¯é›†å’Œä¸Šä½è¯(â€œisaâ€å…³ç³»)çš„åˆ—è¡¨çš„è¾å…¸ã€‚è‹±æ–‡å½“ä¸­ç¡®å®æœ‰è¿™æ ·ä¸€ä¸ªwordnetï¼Œæˆ‘ä»¬åœ¨å®‰è£…å®ŒNLTKå·¥å…·åº“å’Œä¸‹è½½æ•°æ®åŒ…åå¯ä»¥ä½¿ç”¨ï¼Œå¯¹åº”çš„ pythonä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> nltk.corpus <span class="hljs-keyword">import</span> wordnet <span class="hljs-keyword">as</span> wn<br>poses = &#123; <span class="hljs-string">&#x27;n&#x27;</span>:<span class="hljs-string">&#x27;noun&#x27;</span>, <span class="hljs-string">&#x27;v&#x27;</span>:<span class="hljs-string">&#x27;verb&#x27;</span>, <span class="hljs-string">&#x27;s&#x27;</span>:<span class="hljs-string">&#x27;adj (s)&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>:<span class="hljs-string">&#x27;adj&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>:<span class="hljs-string">&#x27;adv&#x27;</span>&#125;<br><span class="hljs-keyword">for</span> synset <span class="hljs-keyword">in</span> wn.synsets(<span class="hljs-string">&quot;good&quot;</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(poses[synset.pos()], <span class="hljs-string">&quot;, &quot;</span>.join([l.name() <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> synset.lemmas()])))<br>        <br><span class="hljs-keyword">from</span> nltk.corpus <span class="hljs-keyword">import</span> wordnet <span class="hljs-keyword">as</span> wn<br>panda = wn.synset(<span class="hljs-string">&quot;panda.n.01&quot;</span>)<br>hyper = <span class="hljs-keyword">lambda</span> s: s.hypernyms()<br><span class="hljs-built_in">list</span>(panda.closure(hyper))<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">noun: good<br>noun: good, goodness<br>noun: good, goodness<br>noun: commodity, trade_good, good<br>adj: good<br>adj (sat): full, good<br>adj: good<br>adj (sat): estimable, good, honorable, respectable<br>adj (sat): beneficial, good<br>adj (sat): good<br>adj (sat): good, just, upright<br>â€¦<br>adverb: well, good<br>adverb: thoroughly, soundly, good<br></code></pre></div></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">[Synset(&#x27;procyonid.n.01&#x27;),<br>Synset(&#x27;carnivore.n.01&#x27;),<br>Synset(&#x27;placental.n.01&#x27;),<br>Synset(&#x27;mammal.n.01&#x27;),<br>Synset(&#x27;vertebrate.n.01&#x27;),<br>Synset(&#x27;chordate.n.01&#x27;),<br>Synset(&#x27;animal.n.01&#x27;),<br>Synset(&#x27;organism.n.01&#x27;),<br>Synset(&#x27;living_thing.n.01&#x27;),<br>Synset(&#x27;whole.n.02&#x27;),<br>Synset(&#x27;object.n.01&#x27;),<br>Synset(&#x27;physical_entity.n.01&#x27;),<br>Synset(&#x27;entity.n.01&#x27;)]<br></code></pre></div></td></tr></table></figure><h2 id="wordnetçš„é—®é¢˜">1.2 WordNetçš„é—®é¢˜</h2><ul><li><p>ä½œä¸ºä¸€ä¸ªèµ„æºå¾ˆå¥½ï¼Œä½†å¿½ç•¥äº†ç»†å¾®å·®åˆ«ã€‚ä¾‹å¦‚â€œproficientâ€è¢«åˆ—ä¸ºâ€œgoodâ€çš„åŒä¹‰è¯ï¼Œè¿™åªæ˜¯åœ¨ä¸€äº›ä¸Šä¸‹æ–‡ä¸­æ˜¯æ­£ç¡®çš„ã€‚</p></li><li><p>ç¼ºå°‘å•è¯çš„æ–°å«ä¹‰ï¼Œéš¾ä»¥æŒç»­æ›´æ–°ã€‚</p></li><li><p>æ˜¯ä¸»è§‚çš„ï¼Œéœ€è¦äººä»¬æ¥åˆ›é€ å’Œè°ƒæ•´ï¼Œæ— æ³•è®¡ç®—å•è¯ç›¸ä¼¼åº¦ã€‚</p></li></ul><h2 id="æ–‡æœ¬è¯æ±‡çš„ç¦»æ•£è¡¨å¾">1.3 æ–‡æœ¬(è¯æ±‡)çš„ç¦»æ•£è¡¨å¾</h2><p>åœ¨ä¼ ç»Ÿçš„è‡ªç„¶è¯­è¨€å¤„ç†ä¸­ï¼Œæˆ‘ä»¬ä¼šå¯¹æ–‡æœ¬åšç¦»æ•£è¡¨å¾ï¼ŒæŠŠè¯è¯­çœ‹ä½œç¦»æ•£çš„ç¬¦å·ï¼šä¾‹å¦‚hotelã€conferenceã€motelç­‰ã€‚</p><p>one-hot vectoræ˜¯åªæœ‰ä¸€ä¸ª1ï¼Œå…¶ä½™å…¨ä¸ºé›¶çš„ç¨€ç–å‘é‡ï¼Œå•è¯å¯ä»¥é€šè¿‡one-hotvectoræ¥è¡¨ç¤ºï¼š <span class="math display">\[\text { motel }=\left[\begin{array}{lllllllllllllll}0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp;0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0\end{array}\right]\]</span></p><p><span class="math display">\[\text { hotel }=\left[\begin{array}{lllllllllllllll}0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp;0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\end{array}\right]\]</span></p><p>åœ¨one-hot vectorä¸­å‘é‡ç»´åº¦ = è¯æ±‡é‡ï¼ˆå¦‚500ï¼Œ000ï¼‰</p><h2 id="ç¦»æ•£è¡¨å¾çš„é—®é¢˜">1.4 ç¦»æ•£è¡¨å¾çš„é—®é¢˜</h2><p>åœ¨ä¸Šè¿°çš„ç‹¬çƒ­å‘é‡ç¦»æ•£è¡¨å¾é‡Œï¼Œæ‰€æœ‰è¯å‘é‡æ˜¯æ­£äº¤çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ã€‚å¯¹äºç‹¬çƒ­å‘é‡ï¼Œæ²¡æœ‰å…³äºç›¸ä¼¼æ€§æ¦‚å¿µï¼Œå¹¶ä¸”å‘é‡ç»´åº¦è¿‡å¤§ã€‚</p><p>å¯¹äºä¸Šè¿°é—®é¢˜æœ‰ä¸€äº›è§£å†³æ€è·¯ï¼š</p><ul><li>â‘ ä½¿ç”¨ç±»ä¼¼WordNetçš„å·¥å…·ä¸­çš„åˆ—è¡¨ï¼Œè·å¾—ç›¸ä¼¼åº¦ï¼Œä½†ä¼šå› ä¸å¤Ÿå®Œæ•´è€Œå¤±è´¥</li><li>â‘¡ é€šè¿‡å¤§é‡æ•°æ®å­¦ä¹ è¯å‘é‡æœ¬èº«ç›¸ä¼¼æ€§ï¼Œè·å¾—æ›´ç²¾ç¡®çš„ç¨ å¯†è¯å‘é‡ç¼–ç </li></ul><h2 id="åŸºäºä¸Šä¸‹æ–‡çš„è¯æ±‡è¡¨å¾">1.5 åŸºäºä¸Šä¸‹æ–‡çš„è¯æ±‡è¡¨å¾</h2><p><strong>è¿‘å¹´æ¥åœ¨æ·±åº¦å­¦ä¹ ä¸­æ¯”è¾ƒæœ‰æ•ˆçš„æ–¹å¼æ˜¯åŸºäºä¸Šä¸‹æ–‡çš„è¯æ±‡è¡¨å¾</strong>ã€‚å®ƒçš„<strong>æ ¸å¿ƒæƒ³æ³•</strong>æ˜¯ï¼šä¸€ä¸ªå•è¯çš„æ„æ€æ˜¯ç”±ç»å¸¸å‡ºç°åœ¨å®ƒé™„è¿‘çš„å•è¯ç»™å‡ºçš„</p><p>è¿™æ˜¯ç°ä»£ç»Ÿè®¡NLPæœ€æˆåŠŸçš„ç†å¿µä¹‹ä¸€ï¼Œæ€»ä½“æ€è·¯æœ‰ç‚¹ç‰©ä»¥ç±»èšï¼Œäººä»¥ç¾¤åˆ†çš„æ„Ÿè§‰ã€‚</p><ul><li>å½“ä¸€ä¸ªå•è¯<spanclass="math inline">\(w\)</span>å‡ºç°åœ¨æ–‡æœ¬ä¸­æ—¶ï¼Œå®ƒçš„ä¸Šä¸‹æ–‡æ˜¯å‡ºç°åœ¨å…¶é™„è¿‘çš„ä¸€ç»„å•è¯(åœ¨ä¸€ä¸ªå›ºå®šå¤§å°çš„çª—å£ä¸­)</li><li>åŸºäºæµ·é‡æ•°æ®ï¼Œä½¿ç”¨<spanclass="math inline">\(w\)</span>çš„è®¸å¤šä¸Šä¸‹æ–‡æ¥æ„å»º<spanclass="math inline">\(w\)</span>çš„è¡¨ç¤º</li></ul><h1 id="word-vectors">2 Word Vectors</h1><h2 id="è¯å‘é‡è¡¨ç¤º">2.1 è¯å‘é‡è¡¨ç¤º</h2><p><strong>Word2vec</strong> (Mikolov et al.2013)æ˜¯ä¸€ä¸ªå­¦ä¹ è¯å‘é‡è¡¨å¾çš„æ¡†æ¶ã€‚</p><ul><li><strong>æ ¸å¿ƒæ€è·¯</strong>å¦‚ä¸‹ï¼š<ul><li>åŸºäºæµ·é‡æ–‡æœ¬è¯­æ–™åº“æ„å»º</li><li>è¯æ±‡è¡¨ä¸­çš„æ¯ä¸ªå•è¯éƒ½ç”±ä¸€ä¸ªå‘é‡è¡¨ç¤ºï¼ˆå­¦ä¹ å®Œæˆåä¼šå›ºå®šï¼‰</li><li>å¯¹åº”è¯­æ–™åº“æ–‡æœ¬ä¸­çš„æ¯ä¸ªä½ç½®<spanclass="math inline">\(t\)</span>ï¼Œæœ‰ä¸€ä¸ªä¸­å¿ƒè¯<spanclass="math inline">\(c\)</span>å’Œä¸€äº›ä¸Šä¸‹æ–‡(â€œå¤–éƒ¨â€)å•è¯<spanclass="math inline">\(o\)</span></li><li>ä½¿ç”¨<span class="math inline">\(c\)</span>å’Œ<spanclass="math inline">\(o\)</span>çš„è¯å‘é‡æ¥è®¡ç®—æ¦‚ç‡<spanclass="math inline">\(P(o|c)\)</span>ï¼Œå³ç»™å®šä¸­å¿ƒè¯æ¨æ–­ä¸Šä¸‹æ–‡è¯æ±‡çš„æ¦‚ç‡ï¼ˆåä¹‹äº¦ç„¶ï¼‰</li><li>ä¸æ–­è°ƒæ•´è¯å‘é‡æ¥æœ€å¤§åŒ–è¿™ä¸ªæ¦‚ç‡</li></ul></li></ul><p><img src="/img/nlp/3.png" /></p><h1 id="word2vec-ç›®æ ‡å‡½æ•°">3 Word2vec ç›®æ ‡å‡½æ•°</h1><h2 id="ä¼¼ç„¶å‡½æ•°">3.1 ä¼¼ç„¶å‡½æ•°</h2><p>å¯¹äºæ¯ä¸ªä½ç½®t = 1, â€¦ , T, åœ¨å¤§å°ä¸º<spanclass="math inline">\(m\)</span>çš„å›ºå®šçª—å£å†…é¢„æµ‹ä¸Šä¸‹æ–‡å•è¯ï¼Œç»™å®šä¸­å¿ƒè¯<spanclass="math inline">\(w_j\)</span>ï¼Œä¼¼ç„¶å‡½æ•°å¯ä»¥è¡¨ç¤ºä¸ºï¼š <spanclass="math display">\[Likelihood = L(\theta) = \prod_{t=1}^{T} \prod_{\substack{-m \leq j \leqm \\ j \neq 0}}P(w_{t+j}|w_t;\theta)\]</span></p><p>ä¸Šè¿°å…¬å¼ä¸­ï¼Œ<spanclass="math inline">\(\theta\)</span>ä¸ºæ¨¡å‹åŒ…å«çš„æ‰€æœ‰å¾…ä¼˜åŒ–æƒé‡å˜é‡</p><h2 id="ç›®æ ‡å‡½æ•°">3.2 ç›®æ ‡å‡½æ•°</h2><p>å¯¹åº”ä¸Šè¿°ä¼¼ç„¶å‡½æ•°çš„ç›®æ ‡å‡½<spanclass="math inline">\(J(\theta)\)</span>å¯ä»¥å–ä½œ(å¹³å‡)è´Ÿå¯¹æ•°ä¼¼ç„¶ï¼š <spanclass="math display">\[Likelihood=-\frac1T \log L(\theta)=-\frac1T \sum_{t=1}^{T}\sum_{\substack{-m \leq j \leq m \\ j \neq 0}} \logP(w_{t+j}|w_t;\theta)\]</span></p><p>æ³¨æ„ï¼š</p><ul><li>ç›®æ ‡å‡½æ•°<spanclass="math inline">\(J(\theta)\)</span>æœ‰æ—¶ä¹Ÿè¢«ç§°ä¸ºâ€œ<strong>ä»£ä»·å‡½æ•°</strong>â€æˆ–â€œ<strong>æŸå¤±å‡½æ•°</strong>â€</li><li>æœ€å°åŒ–ç›®æ ‡å‡½æ•°ä¸æœ€å¤§åŒ–ä¼¼ç„¶å‡½æ•°ï¼ˆé¢„æµ‹æ¦‚ç‡/ç²¾åº¦ï¼‰<strong>ä¸¤è€…ç­‰ä»·</strong></li></ul><p>å¾—åˆ°ç›®æ ‡å‡½æ•°åï¼Œæˆ‘ä»¬å¸Œæœ›æœ€å°åŒ–ç›®æ ‡å‡½æ•°ï¼Œé‚£æˆ‘ä»¬å¦‚ä½•è®¡ç®—<spanclass="math inline">\(P(w_{t+j}|w_t;\theta)\)</span>?</p><p>å¯¹äºæ¯ä¸ªè¯<span class="math inline">\(w\)</span>éƒ½ä¼šç”¨ä¸¤ä¸ªå‘é‡ï¼š</p><ul><li>å½“<spanclass="math inline">\(w\)</span>æ˜¯ä¸­å¿ƒè¯æ—¶ï¼Œæˆ‘ä»¬æ ‡è®°è¯å‘é‡ä¸º<spanclass="math inline">\(v_w\)</span></li><li>å½“<spanclass="math inline">\(w\)</span>æ˜¯ä¸Šä¸‹æ–‡è¯æ—¶ï¼Œæˆ‘ä»¬æ ‡è®°è¯å‘é‡ä¸º<spanclass="math inline">\(u_w\)</span></li></ul><p>åˆ™å¯¹äºä¸€ä¸ªä¸­å¿ƒè¯<spanclass="math inline">\(c\)</span>å’Œä¸€ä¸ªä¸Šä¸‹æ–‡è¯<spanclass="math inline">\(o\)</span>ï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹æ¦‚ç‡è®¡ç®—å…¬å¼ <spanclass="math display">\[P(o \mid c)=\frac{\exp \left(u_{o}^{T} v_{c}\right)}{\sum_{w \in V} \exp\left(u_{w}^{T} v_{c}\right)}\]</span></p><ul><li>å¯¹<spanclass="math inline">\(u_o^Tv_c\)</span>æ˜¯å°†ä¸¤ä¸ªå‘é‡è¿›è¡Œç‚¹ç§¯ï¼Œä¸ºäº†è®¡ç®—ä¸¤ä¸ªè¯å‘é‡çš„ç›¸ä¼¼åº¦ï¼Œç‚¹ç§¯çš„ç»“æœè¶Šå¤§ï¼Œé‚£ä¹ˆç›¸ä¼¼åº¦è¶Šå¤§ã€‚</li><li>æ¨¡å‹çš„è®­ç»ƒæ­£æ˜¯ä¸ºäº†ä½¿å¾—å…·æœ‰ç›¸ä¼¼ä¸Šä¸‹æ–‡çš„å•è¯ï¼Œå…·æœ‰ç›¸ä¼¼çš„å‘é‡</li><li>ç‚¹ç§¯æ˜¯è®¡ç®—ç›¸ä¼¼æ€§çš„ä¸€ç§ç®€å•æ–¹æ³•ï¼Œåœ¨æ³¨æ„åŠ›æœºåˆ¶ä¸­å¸¸ä½¿ç”¨ç‚¹ç§¯è®¡ç®—Score</li></ul><h1 id="word2vecé¢„æµ‹å‡½æ•°">4 Word2vecé¢„æµ‹å‡½æ•°</h1><p>è¿™ä¹Ÿå°±æ˜¯softmax function(<spanclass="math inline">\(R^n\Rightarrow(0,1)^n\)</span>â€‹)çš„ä¸€ä¸ªä¾‹å­ï¼Œå°†<spanclass="math inline">\(x_i\)</span>æ˜ å°„åˆ°<spanclass="math inline">\(p_i\)</span>ï¼š <span class="math display">\[\operatorname{softmax}\left(x_{i}\right)=\frac{\exp\left(x_{i}\right)}{\sum_{j=1}^{n} \exp \left(x_{j}\right)}=p_{i}\]</span> ä¸ºäº†è®­ç»ƒæ¨¡å‹ï¼Œæˆ‘ä»¬å°±è¦æ‰¾å‡ºå‚æ•°æœ€å°åŒ–losså‡½æ•°</p><ul><li><p>Recallï¼š<spanclass="math inline">\(\theta\)</span>é€šè¿‡ä¸€ä¸ªé•¿å‘é‡æ¥ä»£è¡¨æ‰€æœ‰çš„æ¨¡å‹å‚æ•°</p></li><li><p>åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå¯¹äºdç»´å‘é‡å’ŒVä¸ªå•è¯ï¼Œæˆ‘ä»¬å¾—å‡ºï¼š</p></li><li><p><span class="math display">\[\theta=\left[\begin{array}{l}v_{\text {aardvark }} \\v_{a} \\\vdots \\v_{z e b r a} \\u_{a a r d v a r k} \\u_{a} \\\vdots \\u_{z e b r a}\end{array}\right] \in \mathbb{R}^{2 d V}\]</span></p></li><li><p>æ‰€ä»¥æˆ‘ä»¬æ¯ä¸ªå•è¯æœ‰ä¸¤ä¸ªå‘é‡</p></li></ul><p>æˆ‘ä»¬å°±éœ€è¦è®¡ç®—æ‰€æœ‰å‘é‡çš„æ¢¯åº¦è¿›è¡Œæ¢¯åº¦ä¸‹é™ç®—æ³•æ¥æœ€å°åŒ–losså‡½æ•°</p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
      <category>NLP</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>åŒæŒ‡é’ˆ</title>
    <link href="/2022/05/01/%E5%8F%8C%E6%8C%87%E9%92%88/"/>
    <url>/2022/05/01/%E5%8F%8C%E6%8C%87%E9%92%88/</url>
    
    <content type="html"><![CDATA[<h2 id="ç››æ°´æœ€å¤šçš„å®¹å™¨">11ã€ç››æ°´æœ€å¤šçš„å®¹å™¨</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/3.png" /></p><p>æˆ‘ä»¬ä½¿ç”¨åŒæŒ‡é’ˆçš„æ€æƒ³ï¼Œä¸¤ä¸ªæŒ‡é’ˆåˆ†åˆ«ä¸ºæ•°ç»„çš„å¤´å°¾ç»“ç‚¹ï¼Œæ¯è½®éƒ½è¿›è¡Œé¢ç§¯çš„è®¡ç®—ï¼Œå¹¶ä¸”æ¯è½®åªç§»åŠ¨è¾ƒå°ç»“ç‚¹çš„æŒ‡é’ˆã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">maxArea</span>(<span class="hljs-params">self, height: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-built_in">int</span>:<br>        n = <span class="hljs-built_in">len</span>(height)<br>        left = <span class="hljs-number">0</span>    <span class="hljs-comment"># å·¦æŒ‡é’ˆ</span><br>        right = n - <span class="hljs-number">1</span>   <span class="hljs-comment"># å³æŒ‡é’ˆ</span><br>        max_s = <span class="hljs-number">0</span>   <span class="hljs-comment"># é¢ç§¯æœ€å¤§å€¼</span><br>        s = <span class="hljs-number">0</span>   <span class="hljs-comment"># é¢ç§¯</span><br>        l = <span class="hljs-number">0</span>   <span class="hljs-comment"># è¾¹é•¿</span><br>        <span class="hljs-keyword">while</span> right &gt; left:<br>            <span class="hljs-keyword">if</span> height[left] &gt; height[right]:<br>                l = height[right]<br>            <span class="hljs-keyword">else</span>:<br>                l = height[left]<br>            s = (right - left) * l<br>            <span class="hljs-keyword">if</span> s &gt; max_s:<br>                max_s = s<br>            <span class="hljs-keyword">if</span> height[left] &gt; height[right]:<br>                right = right - <span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                left = left + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> max_s<br></code></pre></div></td></tr></table></figure><h2 id="ä¸‰æ•°ä¹‹å’Œ">15ã€ä¸‰æ•°ä¹‹å’Œ</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/15.png" /></p><p>é‡‡ç”¨åŒæŒ‡é’ˆçš„æ€æƒ³ï¼Œä¸ºäº†ä¸ä½¿ä¸‰å…ƒç»„é‡å¤ï¼Œå…ˆå¯¹æ•°ç»„è¿›è¡Œæ’åºã€‚å½“ç¡®å®šäº†ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåªéœ€è¦å¯¹å‰©ä¸‹å…ƒç´ è¿›è¡Œè®¾ç½®å·¦æŒ‡é’ˆå’Œå³æŒ‡é’ˆï¼Œå¦‚æœä¸‰å…ƒç»„å¤§ä¸0ï¼Œå³æŒ‡é’ˆå°±å·¦ç§»ä¸€ä½ï¼Œåä¹‹äº¦ç„¶ã€‚å¦‚æœä¸‰å…ƒç»„ä¹‹å’Œåˆšå¥½ç­‰äº0ï¼Œå°±éœ€è¦å·¦æŒ‡é’ˆå’Œå³æŒ‡é’ˆéƒ½ç§»åŠ¨ä¸€ä½ã€‚è¿™æ—¶å€™è¿˜ä¼šå‡ºç°é‡å¤é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­æ­¤æ—¶éå†çš„å…ƒç´ å’Œä¹‹å‰çš„æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒå°±è¦è·³è¿‡ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">threeSum</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]]:<br>        nums.sort()<br>        n = <span class="hljs-built_in">len</span>(nums)<br>        ans = <span class="hljs-built_in">list</span>()<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<span class="hljs-comment"># å›ºå®šå…¶ä¸­ä¸€ä¸ªå…ƒç´ </span><br>            <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> nums[i] != nums[i - <span class="hljs-number">1</span>]:<br>                k = n - <span class="hljs-number">1</span><br>                j = i + <span class="hljs-number">1</span><br>                <span class="hljs-keyword">while</span> k &gt; j:<span class="hljs-comment"># è¿›è¡ŒåŒæŒ‡é’ˆéå†</span><br>                    <span class="hljs-keyword">if</span> k != n - <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> nums[k] == nums[k + <span class="hljs-number">1</span>]:<span class="hljs-comment"># å¦‚æœå³æŒ‡é’ˆä¹‹å‰å‡ºç°è¿‡å°±è·³è¿‡</span><br>                        k = k - <span class="hljs-number">1</span><br>                        <span class="hljs-keyword">continue</span><br>                    <span class="hljs-keyword">if</span> j != i + <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> nums[j] == nums[j - <span class="hljs-number">1</span>]:<span class="hljs-comment"># å¦‚æœå·¦æŒ‡é’ˆä¹‹å‰å‡ºç°è¿‡å°±è·³è¿‡</span><br>                        j = j + <span class="hljs-number">1</span><br>                        <span class="hljs-keyword">continue</span><br>                    s = nums[i] + nums[j] + nums[k]<br>                    <span class="hljs-keyword">if</span> s == <span class="hljs-number">0</span>:<br>                        ans.append([nums[i], nums[j], nums[k]])<br>                        k = k - <span class="hljs-number">1</span><br>                        j = j + <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">elif</span> s &gt; <span class="hljs-number">0</span>:<br>                        k = k - <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">elif</span> s &lt; <span class="hljs-number">0</span>:<br>                        j = j + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="æœ€æ¥è¿‘çš„ä¸‰æ•°ä¹‹å’Œ">16ã€æœ€æ¥è¿‘çš„ä¸‰æ•°ä¹‹å’Œ</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/16.png" /></p><p>é‡‡ç”¨åŒæŒ‡é’ˆçš„æ€æƒ³ï¼Œå…ˆå¯¹æ•°ç»„è¿›è¡Œæ’åºã€‚å½“ç¡®å®šäº†ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåªéœ€è¦å¯¹å‰©ä¸‹å…ƒç´ è¿›è¡Œè®¾ç½®å·¦æŒ‡é’ˆå’Œå³æŒ‡é’ˆï¼Œå¦‚æœä¸‰å…ƒç»„ä¹‹å’Œå¤§äºtargetï¼Œæˆ‘ä»¬åªéœ€è¦å°†å³èŠ‚ç‚¹å·¦ç§»ä¸€ä½ï¼Œç›¸åäº¦ç„¶ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">threeSumClosest</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], target: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        n = <span class="hljs-built_in">len</span>(nums)<br>        nums.sort()<br>        min_num = <span class="hljs-number">10</span>**<span class="hljs-number">9</span><br>        ans = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>            <span class="hljs-keyword">if</span> i != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> nums[i] == nums[i - <span class="hljs-number">1</span>]:<br>                <span class="hljs-keyword">continue</span><br>            k = n - <span class="hljs-number">1</span><br>            j = i + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">while</span> k &gt; j:<br>                s = nums[i] + nums[j] + nums[k]<br>                <span class="hljs-keyword">if</span> s == target:<br>                    <span class="hljs-keyword">return</span> s<br>                <span class="hljs-keyword">if</span> s &gt; target:<br>                    <span class="hljs-keyword">if</span> s - target &lt; min_num:<br>                        min_num = s - target<br>                        ans = s<br>                    k = k - <span class="hljs-number">1</span><br>                <span class="hljs-keyword">elif</span> s &lt; target:<br>                    <span class="hljs-keyword">if</span> target - s &lt; min_num:<br>                        min_num = target - s<br>                        ans = s<br>                    j = j + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="å››æ•°ä¹‹å’Œ">18ã€å››æ•°ä¹‹å’Œ</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/18.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fourSum</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], target: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]]:<br>        n = <span class="hljs-built_in">len</span>(nums)<br>        <span class="hljs-keyword">if</span> nums == [] <span class="hljs-keyword">or</span> n &lt; <span class="hljs-number">4</span>:<br>            <span class="hljs-keyword">return</span> []<br>        nums.sort()<br>        ans = <span class="hljs-built_in">list</span>()<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n - <span class="hljs-number">3</span>):<br>            <span class="hljs-keyword">if</span> i != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> nums[i] == nums[i - <span class="hljs-number">1</span>]:<br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">if</span> nums[i] + nums[i + <span class="hljs-number">1</span>] + nums[i + <span class="hljs-number">2</span>] + nums[i + <span class="hljs-number">3</span>] &gt; target:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">if</span> nums[i] + nums[n - <span class="hljs-number">1</span>] + nums[n - <span class="hljs-number">2</span>] + nums[n - <span class="hljs-number">3</span>] &lt; target:<br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, n - <span class="hljs-number">2</span>):<br>                <span class="hljs-keyword">if</span> j != i + <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> nums[j] == nums[j - <span class="hljs-number">1</span>]:<br>                    <span class="hljs-keyword">continue</span><br>                <span class="hljs-keyword">if</span> nums[i] + nums[j] + nums[j + <span class="hljs-number">1</span>] + nums[j + <span class="hljs-number">2</span>] &gt; target:<br>                    <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">if</span> nums[i] + nums[n - <span class="hljs-number">1</span>] + nums[n - <span class="hljs-number">2</span>] + nums[n - <span class="hljs-number">3</span>] &lt; target:<br>                    <span class="hljs-keyword">continue</span><br>                k = j + <span class="hljs-number">1</span><br>                l = n - <span class="hljs-number">1</span><br>                <span class="hljs-keyword">while</span> k &lt; l:<br>                    <span class="hljs-built_in">sum</span> = nums[i] + nums[j] + nums[k] + nums[l]<br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">sum</span> &lt; target:<br>                        k = k + <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">sum</span> &gt; target:<br>                        l = l - <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">sum</span> == target:<br>                        ans.append([nums[i], nums[j], nums[k], nums[l]])<br>                        <span class="hljs-keyword">while</span> k &lt; l <span class="hljs-keyword">and</span> nums[k] == nums[k + <span class="hljs-number">1</span>]:<br>                            k = k + <span class="hljs-number">1</span><br>                        k = k + <span class="hljs-number">1</span><br>                        <span class="hljs-keyword">while</span> k &lt; l <span class="hljs-keyword">and</span> nums[l] == nums[l - <span class="hljs-number">1</span>]:<br>                            l = l - <span class="hljs-number">1</span><br>                        l = l - <span class="hljs-number">1</span> <br><br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬nä¸ªç»“ç‚¹">19ã€åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬Nä¸ªç»“ç‚¹</h2><p><img src="/img/LeetCode/é“¾è¡¨/19.png" /></p><p>é‡‡ç”¨åŒæŒ‡é’ˆçš„æ€æƒ³ï¼Œå·¦å³æŒ‡é’ˆéƒ½ä¸ºæŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œé¦–å…ˆå³æŒ‡é’ˆå‘åéå†nä¸ªç»“ç‚¹ï¼Œæœ€åè®©å·¦å³ä¸€èµ·å‘åéå†ç›´è‡³å³æŒ‡é’ˆæŒ‡å‘çš„ä¸ºæœ€åä¸€ä¸ªç»“ç‚¹ï¼Œè¿™æ—¶å€™å·¦æŒ‡é’ˆæŒ‡å‘çš„å°±æ˜¯å€’æ•°ç¬¬nä¸ªç»“ç‚¹çš„å‰ä¸€ä¸ªç»“ç‚¹ï¼Œå°±å¯ä»¥è¿›è¡Œåˆ é™¤çš„æ“ä½œäº†ã€‚</p><p>ä½†æ˜¯æœ‰ä¸€ä¸ªç‰¹æ®Šæƒ…å†µï¼Œå¦‚æœåˆ é™¤çš„æ˜¯å¤´ç»“ç‚¹ï¼Œä¸Šè¿°ä¸æˆç«‹ï¼Œæ‰€ä»¥è¦å•ç‹¬è¿›è¡Œä¸€ä¸ªifåˆ¤æ–­ï¼Œå¦‚æœå³æŒ‡é’ˆå‘åéå†nä¸ªç»“ç‚¹åä¸ºç©ºï¼Œé‚£ä¹ˆåˆ é™¤çš„å°±æ˜¯å¤´ç»“ç‚¹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># Definition for singly-linked list.</span><br><span class="hljs-comment"># class ListNode:</span><br><span class="hljs-comment">#     def __init__(self, val=0, next=None):</span><br><span class="hljs-comment">#         self.val = val</span><br><span class="hljs-comment">#         self.next = next</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">removeNthFromEnd</span>(<span class="hljs-params">self, head: ListNode, n: <span class="hljs-built_in">int</span></span>) -&gt; ListNode:<br>        right = head<br>        left = head<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>            right = right.<span class="hljs-built_in">next</span><br>        <span class="hljs-keyword">if</span> right == <span class="hljs-literal">None</span>:<span class="hljs-comment"># å¦‚æœè¦åˆ é™¤çš„æ˜¯å¤´ç»“ç‚¹</span><br>            left = left.<span class="hljs-built_in">next</span><br>            <span class="hljs-keyword">return</span> left<br>        <span class="hljs-keyword">while</span> right.<span class="hljs-built_in">next</span> != <span class="hljs-literal">None</span>:<br>            left = left.<span class="hljs-built_in">next</span><br>            right = right.<span class="hljs-built_in">next</span><br>        left.<span class="hljs-built_in">next</span> = left.<span class="hljs-built_in">next</span>.<span class="hljs-built_in">next</span><br>        <span class="hljs-keyword">return</span> head<br></code></pre></div></td></tr></table></figure><h2 id="åˆ é™¤æœ‰åºæ•°ç»„ä¸­çš„é‡å¤é¡¹">26ã€åˆ é™¤æœ‰åºæ•°ç»„ä¸­çš„é‡å¤é¡¹</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/26.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">removeDuplicates</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">if</span> nums == []:<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>        n = <span class="hljs-built_in">len</span>(nums)<br>        left, right = <span class="hljs-number">1</span>, <span class="hljs-number">1</span><br>        <span class="hljs-keyword">while</span> right &lt; n:<br>            <span class="hljs-keyword">if</span> nums[right] != nums[right - <span class="hljs-number">1</span>]:<br>                nums[left] = nums[right]<br>                left = left + <span class="hljs-number">1</span><br>            right = right + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> left<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>LeetCode</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>åŠ¨æ€è§„åˆ’</title>
    <link href="/2022/04/29/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/"/>
    <url>/2022/04/29/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/</url>
    
    <content type="html"><![CDATA[<h2 id="æœ€é•¿å›æ–‡å­ä¸²">4ã€æœ€é•¿å›æ–‡å­ä¸²</h2><p><img src="/img/LeetCode/å­—ç¬¦ä¸²/2.png" /></p><p>æœ¬é¢˜ä½¿ç”¨çš„åŠ¨æ€è§„åˆ’çš„æ€æƒ³ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰s[i+1:j-1]<em>s</em>[<em>i</em>+1:<em>j</em>âˆ’1] æ˜¯å›æ–‡ä¸²ï¼Œå¹¶ä¸”s<em>s</em> çš„ç¬¬ i<em>i</em> å’Œ j<em>j</em>ä¸ªå­—æ¯ç›¸åŒæ—¶ï¼Œs[i:j]<em>s</em>[<em>i</em>:<em>j</em>] æ‰ä¼šæ˜¯å›æ–‡ä¸²ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">longestPalindrome</span>(<span class="hljs-params">self, s: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>        n = <span class="hljs-built_in">len</span>(s)<br>        <span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">2</span>:  <span class="hljs-comment"># å¦‚æœå­—ç¬¦ä¸²é•¿ä¸º1</span><br>            <span class="hljs-keyword">return</span> s<br>        <br>        <span class="hljs-built_in">max</span> = <span class="hljs-number">1</span><br>        left = <span class="hljs-number">0</span><br>        <span class="hljs-comment"># dp[i][j]ä»£è¡¨æ˜¯s[i...j]æ˜¯å¦ä¸ºå›æ–‡ä¸²</span><br>        dp = [[<span class="hljs-literal">False</span>] * n <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n)]<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>            dp[i][i] = <span class="hljs-literal">True</span><br><br>        <span class="hljs-keyword">for</span> L <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>, n + <span class="hljs-number">1</span>):<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>                right = L + i - <span class="hljs-number">1</span><br>                <span class="hljs-keyword">if</span> right &gt;= n:<br>                    <span class="hljs-keyword">break</span><br>                <br>                <span class="hljs-keyword">if</span> s[i] != s[right]:<br>                    dp[i][right] = <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">if</span> right - i &lt; <span class="hljs-number">3</span>:<br>                        dp[i][right] = <span class="hljs-literal">True</span><br>                    <span class="hljs-keyword">else</span>:<br>                        dp[i][right] = dp[i + <span class="hljs-number">1</span>][right - <span class="hljs-number">1</span>]<br><br>                <span class="hljs-keyword">if</span> dp[i][right] <span class="hljs-keyword">and</span> L &gt; <span class="hljs-built_in">max</span>:<br>                    <span class="hljs-built_in">max</span> = L<br>                    left = i<br>        <span class="hljs-keyword">return</span> s[left:left+<span class="hljs-built_in">max</span>]<br></code></pre></div></td></tr></table></figure><h2 id="æœ€å¤§å­æ•°ç»„å’Œ">53ã€æœ€å¤§å­æ•°ç»„å’Œ</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/53.png" /></p><p>çœ‹åˆ°è¿™ç§åŒºé—´çš„ï¼Œå¯ä»¥æƒ³åˆ°åŠ¨æ€è§„åˆ’</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">maxSubArray</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(nums)):<br>            nums[i] += <span class="hljs-built_in">max</span>(nums[i - <span class="hljs-number">1</span>], <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(nums)<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>LeetCode</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>å­—ç¬¦ä¸²</title>
    <link href="/2022/04/29/%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    <url>/2022/04/29/%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²">3ã€æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²</h2><p><img src="/img/LeetCode/å­—ç¬¦ä¸²/1.png" /></p><p>æ–¹æ³•ä¸€ï¼šæš´åŠ›è§£</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lengthOfLongestSubstring</span>(<span class="hljs-params">self, s: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        occ = <span class="hljs-built_in">set</span>()<br>        n = <span class="hljs-built_in">len</span>(s)<br>        <span class="hljs-comment"># rkä¸ºå·¦æŒ‡é’ˆï¼Œansä¸ºæ— é‡å¤å­ä¸²é•¿åº¦</span><br>        rk, ans = -<span class="hljs-number">1</span>, <span class="hljs-number">0</span><br>        flag = <span class="hljs-number">0</span>    <span class="hljs-comment"># å¾ªç¯ä¸­æ— é‡å¤å­ä¸²é•¿åº¦</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>            rk = i<br>            flag = <span class="hljs-number">0</span><br>            <span class="hljs-keyword">while</span> rk &lt; n <span class="hljs-keyword">and</span> s[rk] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> occ:<br>                occ.add(s[rk])<br>                flag = flag + <span class="hljs-number">1</span><br>                rk = rk + <span class="hljs-number">1</span><br>            ans = flag <span class="hljs-keyword">if</span> flag &gt; ans <span class="hljs-keyword">else</span> ans<br>            occ.clear()<br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><p>æ–¹æ³•äºŒï¼š</p><p>æ¯æ¬¡å¾ªç¯æ²¡å¿…è¦æŠŠé›†åˆé‡Œçš„å…ƒç´ å…¨éƒ¨åˆ é™¤ï¼Œå¯ä»¥æ¯æ¬¡åªåˆ é™¤ä¸Šä¸€è½®å¾ªç¯çš„æœ€å·¦è¾¹ç»“ç‚¹</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lengthOfLongestSubstring</span>(<span class="hljs-params">self, s: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        occ = <span class="hljs-built_in">set</span>()<br>        n = <span class="hljs-built_in">len</span>(s)<br>        <span class="hljs-comment"># rkä¸ºå·¦æŒ‡é’ˆï¼Œansä¸ºæ— é‡å¤å­ä¸²é•¿åº¦</span><br>        rk, ans = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>        flag = <span class="hljs-number">0</span>    <span class="hljs-comment"># å¾ªç¯ä¸­æ— é‡å¤å­ä¸²é•¿åº¦</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>            <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span>:<br>                occ.remove(s[i - <span class="hljs-number">1</span>])<br>                flag = flag - <span class="hljs-number">1</span><br>            <span class="hljs-keyword">while</span> rk &lt; n <span class="hljs-keyword">and</span> s[rk] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> occ:<br>                occ.add(s[rk])<br>                rk = rk + <span class="hljs-number">1</span><br>                flag = flag + <span class="hljs-number">1</span><br>            ans = flag <span class="hljs-keyword">if</span> flag &gt; ans <span class="hljs-keyword">else</span> ans<br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="æœ€é•¿å›æ–‡å­ä¸²">4ã€æœ€é•¿å›æ–‡å­ä¸²</h2><p><img src="/img/LeetCode/å­—ç¬¦ä¸²/2.png" /></p><p>æœ¬é¢˜ä½¿ç”¨çš„åŠ¨æ€è§„åˆ’çš„æ€æƒ³ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰s[i+1:j-1]<em>s</em>[<em>i</em>+1:<em>j</em>âˆ’1] æ˜¯å›æ–‡ä¸²ï¼Œå¹¶ä¸”s<em>s</em> çš„ç¬¬ i<em>i</em> å’Œ j<em>j</em>ä¸ªå­—æ¯ç›¸åŒæ—¶ï¼Œs[i:j]<em>s</em>[<em>i</em>:<em>j</em>] æ‰ä¼šæ˜¯å›æ–‡ä¸²ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">longestPalindrome</span>(<span class="hljs-params">self, s: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>        n = <span class="hljs-built_in">len</span>(s)<br>        <span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">2</span>:  <span class="hljs-comment"># å¦‚æœå­—ç¬¦ä¸²é•¿ä¸º1</span><br>            <span class="hljs-keyword">return</span> s<br>        <br>        <span class="hljs-built_in">max</span> = <span class="hljs-number">1</span><br>        left = <span class="hljs-number">0</span><br>        <span class="hljs-comment"># dp[i][j]ä»£è¡¨æ˜¯s[i...j]æ˜¯å¦ä¸ºå›æ–‡ä¸²</span><br>        dp = [[<span class="hljs-literal">False</span>] * n <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n)]<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>            dp[i][i] = <span class="hljs-literal">True</span><br><br>        <span class="hljs-keyword">for</span> L <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>, n + <span class="hljs-number">1</span>):<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>                right = L + i - <span class="hljs-number">1</span><br>                <span class="hljs-keyword">if</span> right &gt;= n:<br>                    <span class="hljs-keyword">break</span><br>                <br>                <span class="hljs-keyword">if</span> s[i] != s[right]:<br>                    dp[i][right] = <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">if</span> right - i &lt; <span class="hljs-number">3</span>:<br>                        dp[i][right] = <span class="hljs-literal">True</span><br>                    <span class="hljs-keyword">else</span>:<br>                        dp[i][right] = dp[i + <span class="hljs-number">1</span>][right - <span class="hljs-number">1</span>]<br><br>                <span class="hljs-keyword">if</span> dp[i][right] <span class="hljs-keyword">and</span> L &gt; <span class="hljs-built_in">max</span>:<br>                    <span class="hljs-built_in">max</span> = L<br>                    left = i<br>        <span class="hljs-keyword">return</span> s[left:left+<span class="hljs-built_in">max</span>]<br></code></pre></div></td></tr></table></figure><h2 id="zå­—å½¢å˜æ¢">6ã€Zå­—å½¢å˜æ¢</h2><p><img src="/img/LeetCode/å­—ç¬¦ä¸²/3.png" /></p><p>ä½¿ç”¨äºŒç»´çŸ©é˜µè¿›è¡Œæ¨¡æ‹Ÿï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">convert</span>(<span class="hljs-params">self, s: <span class="hljs-built_in">str</span>, numRows: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>        n = <span class="hljs-built_in">len</span>(s)<br>        <span class="hljs-keyword">if</span> numRows == <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> numRows &gt;= n:<br>            <span class="hljs-keyword">return</span> s<br>        t = <span class="hljs-number">2</span> * numRows - <span class="hljs-number">2</span><br>        col = (n + t - <span class="hljs-number">1</span>) // t * (numRows - <span class="hljs-number">1</span>)<br>        matrix = [[<span class="hljs-string">&#x27;&#x27;</span>] * col <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(numRows)]<br>        x, y = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i, ch <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(s):<br>            matrix[x][y] = ch<br>            <span class="hljs-keyword">if</span> i % t &lt; numRows - <span class="hljs-number">1</span>:<br>                x = x + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                x = x - <span class="hljs-number">1</span><br>                y = y + <span class="hljs-number">1</span><br>        ans = <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(numRows):<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(col):<br>                <span class="hljs-keyword">if</span> matrix[i][j]:<br>                    ans = ans + matrix[i][j]<br><br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="å­—ç¬¦ä¸²è½¬æ¢æ•´æ•°">7ã€å­—ç¬¦ä¸²è½¬æ¢æ•´æ•°</h2><p><img src="/img/LeetCode/å­—ç¬¦ä¸²/4.png" /></p><p><img src="/img/LeetCode/å­—ç¬¦ä¸²/5.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">myAtoi</span>(<span class="hljs-params">self, s: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        flag = <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">if</span> s == <span class="hljs-string">&#x27;&#x27;</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i, ch <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(s):<br>            <span class="hljs-keyword">if</span> ch != <span class="hljs-string">&#x27; &#x27;</span>:<br>                s = s[i:]<br>                <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">if</span> s[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;-&#x27;</span>:<br>            flag = <span class="hljs-literal">True</span><br>            s = s[<span class="hljs-number">1</span>:]<br>        <span class="hljs-keyword">elif</span> s[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;+&#x27;</span>:<br>            s = s[<span class="hljs-number">1</span>:]<br>        a = <span class="hljs-number">0</span><br>        ans = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i, ch <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(s):<br>            <span class="hljs-keyword">if</span> ch.isdigit() == <span class="hljs-literal">False</span>:<br>                <span class="hljs-keyword">break</span><br>            a = <span class="hljs-built_in">int</span>(ch)<br>            ans = ans * <span class="hljs-number">10</span> + a<br>        <span class="hljs-keyword">if</span> flag:<br>            ans = -<span class="hljs-number">1</span> * ans<br>        <span class="hljs-keyword">if</span> ans &gt; <span class="hljs-number">2</span> ** <span class="hljs-number">31</span> - <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> ** <span class="hljs-number">31</span> - <span class="hljs-number">1</span><br>        <span class="hljs-keyword">elif</span> ans &lt; -(<span class="hljs-number">2</span> ** <span class="hljs-number">31</span>):<br>            <span class="hljs-keyword">return</span> -(<span class="hljs-number">2</span> ** <span class="hljs-number">31</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="æœ€é•¿å…¬å…±å‰ç¼€">14ã€æœ€é•¿å…¬å…±å‰ç¼€</h2><p><img src="/img/LeetCode/å­—ç¬¦ä¸²/6.png" /></p><p>æƒ³æ³•ä¸ºæ¨ªå‘å¯¹æ¯”ï¼ŒæŒ‰ç…§åˆ—è¡¨é¡ºåºå¼€å§‹é€æ­¥ç®—æ³•å‰xä¸ªå­—ç¬¦ä¸²çš„æœ€é•¿å‰ç¼€ï¼Œç›´è‡³å¾—åˆ°æœ€ç»ˆçš„æœ€é•¿å‰ç¼€</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">longestCommonPrefix</span>(<span class="hljs-params">self, strs: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        flag = strs[<span class="hljs-number">0</span>]<span class="hljs-comment"># å‰å‡ ä¸ªå­—ç¬¦ä¸²çš„æœ€é•¿å‰ç¼€</span><br>        a = <span class="hljs-string">&quot;&quot;</span><span class="hljs-comment"># æœ¬å­—ç¬¦ä¸²ä¸flagçš„æœ€é•¿å‰ç¼€</span><br>        ans = <span class="hljs-string">&quot;&quot;</span><br>        n = <span class="hljs-built_in">len</span>(strs)<br>        <span class="hljs-keyword">if</span> n == <span class="hljs-number">1</span>:<span class="hljs-comment"># å¦‚æœåªæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œé‚£å°±ç›´æ¥è¾“å‡º</span><br>            <span class="hljs-keyword">return</span> strs[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">for</span> i, s <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(strs):<br>            <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span>:<span class="hljs-comment"># å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²é‚£å°±è·³è¿‡</span><br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">for</span> j, ch <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(s):<span class="hljs-comment"># æœ¬å­—ç¬¦ä¸²ä¸flagè¿›è¡Œæ¯”å¯¹</span><br>                <span class="hljs-keyword">if</span> j &lt; <span class="hljs-built_in">len</span>(flag) <span class="hljs-keyword">and</span> ch == flag[j]:<br>                    a = a + ch<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">break</span><br>            flag = a<br>            a = <span class="hljs-string">&quot;&quot;</span><br>            <span class="hljs-keyword">if</span> i == n - <span class="hljs-number">1</span>:<span class="hljs-comment"># å¦‚æœæ˜¯æœ€åä¸€ä¸ªç»“ç‚¹ï¼Œé‚£å°±æ˜¯æœ€ç»ˆæœ€é•¿å‰ç¼€äº†</span><br>                ans = flag<br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="ç”µè¯å·ç çš„å­—æ¯ç»„åˆ">17ã€ç”µè¯å·ç çš„å­—æ¯ç»„åˆ</h2><p><img src="/img/LeetCode/å­—ç¬¦ä¸²/17.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">letterCombinations</span>(<span class="hljs-params">self, digits: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:<br>        <span class="hljs-keyword">if</span> digits == <span class="hljs-string">&#x27;&#x27;</span>:<br>            <span class="hljs-keyword">return</span> []<br><br>        phoneMap = &#123;<br>        <span class="hljs-string">&#x27;2&#x27;</span>: <span class="hljs-string">&#x27;abc&#x27;</span>,<br>        <span class="hljs-string">&#x27;3&#x27;</span>: <span class="hljs-string">&#x27;def&#x27;</span>,<br>        <span class="hljs-string">&#x27;4&#x27;</span>: <span class="hljs-string">&#x27;ghi&#x27;</span>,<br>        <span class="hljs-string">&#x27;5&#x27;</span>: <span class="hljs-string">&#x27;jkl&#x27;</span>,<br>        <span class="hljs-string">&#x27;6&#x27;</span>: <span class="hljs-string">&#x27;mno&#x27;</span>,<br>        <span class="hljs-string">&#x27;7&#x27;</span>: <span class="hljs-string">&#x27;pqrs&#x27;</span>,<br>        <span class="hljs-string">&#x27;8&#x27;</span>: <span class="hljs-string">&#x27;tuv&#x27;</span>,<br>        <span class="hljs-string">&#x27;9&#x27;</span>: <span class="hljs-string">&#x27;wxyz&#x27;</span>,   <br>        &#125;<br>        <br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">backtrack</span>(<span class="hljs-params">index: <span class="hljs-built_in">int</span></span>):<span class="hljs-comment"># å›æº¯</span><br>            <span class="hljs-keyword">if</span> index == <span class="hljs-built_in">len</span>(digits):<br>                combinations.append(<span class="hljs-string">&#x27;&#x27;</span>.join(combination))<br>            <span class="hljs-keyword">else</span>:<br>                digit = digits[index]<br>                <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> phoneMap[digit]:<br>                    combination.append(ch)<br>                    backtrack(index + <span class="hljs-number">1</span>)<br>                    combination.pop()<br><br>        combination = <span class="hljs-built_in">list</span>()<br>        combinations = <span class="hljs-built_in">list</span>()<br>        backtrack(<span class="hljs-number">0</span>)<br><br>        <span class="hljs-keyword">return</span> combinations<br></code></pre></div></td></tr></table></figure><h2 id="æœ‰æ•ˆçš„æ‹¬å·">20ã€æœ‰æ•ˆçš„æ‹¬å·</h2><p><img src="/img/LeetCode/å­—ç¬¦ä¸²/20.png" /></p><p>é‡‡ç”¨äº†æ ˆçš„æ€æƒ³ï¼Œå°†ç¬¦å·ä¾æ¬¡å…¥æ ˆè¿›è¡Œåˆ¤æ–­</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">isValid</span>(<span class="hljs-params">self, s: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:<br>        stack = <span class="hljs-built_in">list</span>()<br>        <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> s:<br>            <span class="hljs-keyword">if</span> ch == <span class="hljs-string">&#x27;)&#x27;</span>:<br>                <span class="hljs-keyword">if</span> stack == []:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>                temp = stack.pop()<br>                <span class="hljs-keyword">if</span> temp != <span class="hljs-string">&#x27;(&#x27;</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">elif</span> ch == <span class="hljs-string">&#x27;&#125;&#x27;</span>:<br>                <span class="hljs-keyword">if</span> stack == []:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>                temp = stack.pop()<br>                <span class="hljs-keyword">if</span> temp != <span class="hljs-string">&#x27;&#123;&#x27;</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">elif</span> ch == <span class="hljs-string">&#x27;]&#x27;</span>:<br>                <span class="hljs-keyword">if</span> stack == []:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>                temp = stack.pop()<br>                <span class="hljs-keyword">if</span> temp != <span class="hljs-string">&#x27;[&#x27;</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">else</span>:<br>                stack.append(ch)<br>        <span class="hljs-keyword">if</span> stack:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br></code></pre></div></td></tr></table></figure><h2 id="åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨">21ã€åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨</h2><p><img src="/img/LeetCode/å­—ç¬¦ä¸²/21.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># Definition for singly-linked list.</span><br><span class="hljs-comment"># class ListNode:</span><br><span class="hljs-comment">#     def __init__(self, val=0, next=None):</span><br><span class="hljs-comment">#         self.val = val</span><br><span class="hljs-comment">#         self.next = next</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">mergeTwoLists</span>(<span class="hljs-params">self, list1: <span class="hljs-type">Optional</span>[ListNode], list2: <span class="hljs-type">Optional</span>[ListNode]</span>) -&gt; <span class="hljs-type">Optional</span>[ListNode]:<br>        head = ListNode(<span class="hljs-number">0</span>, <span class="hljs-literal">None</span>)<br>        temp = head<br>        first = list1<br>        second = list2<br>        <span class="hljs-keyword">while</span> first <span class="hljs-keyword">and</span> second:<br>            <span class="hljs-keyword">if</span> first.val &lt;= second.val:<br>                temp.<span class="hljs-built_in">next</span> = first<br>                temp = temp.<span class="hljs-built_in">next</span><br>                first = first.<span class="hljs-built_in">next</span><br>            <span class="hljs-keyword">elif</span> first.val &gt; second.val:<br>                temp.<span class="hljs-built_in">next</span> = second<br>                temp = temp.<span class="hljs-built_in">next</span><br>                second = second.<span class="hljs-built_in">next</span><br>        <br>        temp.<span class="hljs-built_in">next</span> = first <span class="hljs-keyword">if</span> first <span class="hljs-keyword">else</span> second<br>        <br>        <span class="hljs-keyword">return</span> head.<span class="hljs-built_in">next</span><br></code></pre></div></td></tr></table></figure><h2 id="æ‹¬å·ç”Ÿæˆ">22ã€æ‹¬å·ç”Ÿæˆ</h2><p><img src="/img/LeetCode/å­—ç¬¦ä¸²/22.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generateParenthesis</span>(<span class="hljs-params">self, n: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:<br>        ans = []<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">backtrack</span>(<span class="hljs-params">S, left, right</span>):<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(S) == <span class="hljs-number">2</span> * n:<br>                ans.append(<span class="hljs-string">&#x27;&#x27;</span>.join(S))<br>                <span class="hljs-keyword">return</span><br>            <span class="hljs-keyword">if</span> left &lt; n:<br>                S.append(<span class="hljs-string">&#x27;(&#x27;</span>)<br>                backtrack(S, left + <span class="hljs-number">1</span>, right)<br>                S.pop()<br>            <span class="hljs-keyword">if</span> right &lt; left:<br>                S.append(<span class="hljs-string">&#x27;)&#x27;</span>)<br>                backtrack(S, left, right + <span class="hljs-number">1</span>)<br>                S.pop()<br>        backtrack([], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>LeetCode</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>å“ˆå¸Œè¡¨</title>
    <link href="/2022/04/28/%E5%93%88%E5%B8%8C%E8%A1%A8/"/>
    <url>/2022/04/28/%E5%93%88%E5%B8%8C%E8%A1%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="ä¸¤æ•°ç›¸åŠ ">1ã€ä¸¤æ•°ç›¸åŠ </h2><p><img src="/img/LeetCode/å“ˆå¸Œè¡¨/1.png" /></p><p>è¿™æ ·æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå¯¹äºæ¯ä¸€ä¸ª<code>x</code>ï¼Œæˆ‘ä»¬é¦–å…ˆæŸ¥è¯¢å“ˆå¸Œè¡¨ä¸­æ˜¯å¦å­˜åœ¨<code>target - x</code>ï¼Œç„¶åå°† <code>x</code>æ’å…¥åˆ°å“ˆå¸Œè¡¨ä¸­ï¼Œå³å¯ä¿è¯ä¸ä¼šè®© <code>x</code> å’Œè‡ªå·±åŒ¹é…ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">twoSum</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], target: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]:<br>        hashtable = <span class="hljs-built_in">dict</span>()<br>        <span class="hljs-keyword">for</span> i, num <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(nums):<br>            <span class="hljs-keyword">if</span> target - num <span class="hljs-keyword">in</span> hashtable:<br>                <span class="hljs-keyword">return</span> [hashtable[target - num], i]<br>            <span class="hljs-keyword">else</span>:<br>                hashtable[num] = i<br>        <span class="hljs-keyword">return</span> []<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>LeetCode</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>é“¾è¡¨</title>
    <link href="/2022/04/28/%E9%93%BE%E8%A1%A8/"/>
    <url>/2022/04/28/%E9%93%BE%E8%A1%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="ä¸¤æ•°ç›¸åŠ ">2ã€ä¸¤æ•°ç›¸åŠ </h2><p><img src="/img/LeetCode/é“¾è¡¨/2.png" /></p><p>é‡‡ç”¨é€’å½’çš„æ€æƒ³ï¼Œå½“æŸä¸ªé“¾è¡¨å½“å‰èŠ‚ç‚¹å­˜åœ¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æˆ–è¿›ä½ç¬¦ä¸º1æ—¶ï¼Œå¾€ä¸‹é€’å½’ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># Definition for singly-linked list.</span><br><span class="hljs-comment"># class ListNode:</span><br><span class="hljs-comment">#     def __init__(self, val=0, next=None):</span><br><span class="hljs-comment">#         self.val = val</span><br><span class="hljs-comment">#         self.next = next</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">addTwoNumbers</span>(<span class="hljs-params">self, l1: <span class="hljs-type">Optional</span>[ListNode], l2: <span class="hljs-type">Optional</span>[ListNode], carryflag = <span class="hljs-number">0</span></span>) -&gt; <span class="hljs-type">Optional</span>[ListNode]:<br>        n1, n2 = l1.val <span class="hljs-keyword">if</span> l1 <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>, l2.val <span class="hljs-keyword">if</span> l2 <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>        s = n1 + n2 + carryflag<br>        val, carry_flag = s % <span class="hljs-number">10</span>, <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> s &gt; <span class="hljs-number">9</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>        next1, next2 = l1.<span class="hljs-built_in">next</span> <span class="hljs-keyword">if</span> l1 <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>, l2.<span class="hljs-built_in">next</span> <span class="hljs-keyword">if</span> l2 <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> next1 <span class="hljs-keyword">or</span> next2 <span class="hljs-keyword">or</span> carry_flag:<br>            <span class="hljs-keyword">return</span> ListNode(val, self.addTwoNumbers(next1, next2, carry_flag))<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> ListNode(val)<br></code></pre></div></td></tr></table></figure><h2 id="åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬nä¸ªç»“ç‚¹">19ã€åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬Nä¸ªç»“ç‚¹</h2><p><img src="/img/LeetCode/é“¾è¡¨/19.png" /></p><p>é‡‡ç”¨åŒæŒ‡é’ˆçš„æ€æƒ³ï¼Œå·¦å³æŒ‡é’ˆéƒ½ä¸ºæŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œé¦–å…ˆå³æŒ‡é’ˆå‘åéå†nä¸ªç»“ç‚¹ï¼Œæœ€åè®©å·¦å³ä¸€èµ·å‘åéå†ç›´è‡³å³æŒ‡é’ˆæŒ‡å‘çš„ä¸ºæœ€åä¸€ä¸ªç»“ç‚¹ï¼Œè¿™æ—¶å€™å·¦æŒ‡é’ˆæŒ‡å‘çš„å°±æ˜¯å€’æ•°ç¬¬nä¸ªç»“ç‚¹çš„å‰ä¸€ä¸ªç»“ç‚¹ï¼Œå°±å¯ä»¥è¿›è¡Œåˆ é™¤çš„æ“ä½œäº†ã€‚</p><p>ä½†æ˜¯æœ‰ä¸€ä¸ªç‰¹æ®Šæƒ…å†µï¼Œå¦‚æœåˆ é™¤çš„æ˜¯å¤´ç»“ç‚¹ï¼Œä¸Šè¿°ä¸æˆç«‹ï¼Œæ‰€ä»¥è¦å•ç‹¬è¿›è¡Œä¸€ä¸ªifåˆ¤æ–­ï¼Œå¦‚æœå³æŒ‡é’ˆå‘åéå†nä¸ªç»“ç‚¹åä¸ºç©ºï¼Œé‚£ä¹ˆåˆ é™¤çš„å°±æ˜¯å¤´ç»“ç‚¹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># Definition for singly-linked list.</span><br><span class="hljs-comment"># class ListNode:</span><br><span class="hljs-comment">#     def __init__(self, val=0, next=None):</span><br><span class="hljs-comment">#         self.val = val</span><br><span class="hljs-comment">#         self.next = next</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">removeNthFromEnd</span>(<span class="hljs-params">self, head: ListNode, n: <span class="hljs-built_in">int</span></span>) -&gt; ListNode:<br>        right = head<br>        left = head<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>            right = right.<span class="hljs-built_in">next</span><br>        <span class="hljs-keyword">if</span> right == <span class="hljs-literal">None</span>:<span class="hljs-comment"># å¦‚æœè¦åˆ é™¤çš„æ˜¯å¤´ç»“ç‚¹</span><br>            left = left.<span class="hljs-built_in">next</span><br>            <span class="hljs-keyword">return</span> left<br>        <span class="hljs-keyword">while</span> right.<span class="hljs-built_in">next</span> != <span class="hljs-literal">None</span>:<br>            left = left.<span class="hljs-built_in">next</span><br>            right = right.<span class="hljs-built_in">next</span><br>        left.<span class="hljs-built_in">next</span> = left.<span class="hljs-built_in">next</span>.<span class="hljs-built_in">next</span><br>        <span class="hljs-keyword">return</span> head<br></code></pre></div></td></tr></table></figure><h2 id="äº®äº®äº¤æ¢é“¾è¡¨ä¸­çš„ç»“ç‚¹">24ã€äº®äº®äº¤æ¢é“¾è¡¨ä¸­çš„ç»“ç‚¹</h2><p><img src="/img/LeetCode/é“¾è¡¨/24.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># Definition for singly-linked list.</span><br><span class="hljs-comment"># class ListNode:</span><br><span class="hljs-comment">#     def __init__(self, val=0, next=None):</span><br><span class="hljs-comment">#         self.val = val</span><br><span class="hljs-comment">#         self.next = next</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">swapPairs</span>(<span class="hljs-params">self, head: ListNode</span>) -&gt; ListNode:<br>        <span class="hljs-keyword">if</span> head == <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">return</span> head<br>        temp = ListNode(<span class="hljs-number">0</span>, head)<br>        first = temp<br>        second = temp.<span class="hljs-built_in">next</span><br><br>        <span class="hljs-keyword">while</span> second <span class="hljs-keyword">and</span> second.<span class="hljs-built_in">next</span>:<br>            first.<span class="hljs-built_in">next</span> = second.<span class="hljs-built_in">next</span><br>            second.<span class="hljs-built_in">next</span> = second.<span class="hljs-built_in">next</span>.<span class="hljs-built_in">next</span><br>            first.<span class="hljs-built_in">next</span>.<span class="hljs-built_in">next</span> = second<br>            <br>            first = second<br>            second = second.<span class="hljs-built_in">next</span><br>        <span class="hljs-keyword">return</span> temp.<span class="hljs-built_in">next</span><br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>LeetCode</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>æ•°ç»„åŠæ•°å­¦</title>
    <link href="/2022/04/28/%E6%95%B0%E7%BB%84%E5%8F%8A%E6%95%B0%E5%AD%A6/"/>
    <url>/2022/04/28/%E6%95%B0%E7%BB%84%E5%8F%8A%E6%95%B0%E5%AD%A6/</url>
    
    <content type="html"><![CDATA[<h2 id="æ•´æ•°åè½¬">7ã€æ•´æ•°åè½¬</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/1.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reverse</span>(<span class="hljs-params">self, x: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        ans = <span class="hljs-number">0</span><br>        flag = <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">if</span> x &lt; <span class="hljs-number">0</span>:<br>            flag = <span class="hljs-literal">True</span><br>            x = -<span class="hljs-number">1</span> * x<br>        a = <span class="hljs-number">0</span>   <span class="hljs-comment"># é™¤æ³•ä½™æ•°</span><br>        <span class="hljs-keyword">while</span> x != <span class="hljs-number">0</span>:<br>            a = x % <span class="hljs-number">10</span><br>            x = x // <span class="hljs-number">10</span><br>            ans = ans * <span class="hljs-number">10</span> + a<br>        <span class="hljs-keyword">if</span> flag:<br>            ans = -<span class="hljs-number">1</span> * ans<br>        <span class="hljs-keyword">if</span> ans &gt; <span class="hljs-number">2</span> ** <span class="hljs-number">31</span> - <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> ans &lt; -(<span class="hljs-number">2</span> ** <span class="hljs-number">31</span>):<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="å›æ–‡æ•°">9ã€å›æ–‡æ•°</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/2.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">isPalindrome</span>(<span class="hljs-params">self, x: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">bool</span>:<br>        <span class="hljs-keyword">if</span> x &lt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        a = self.reverse(x) <span class="hljs-comment"># æ•´æ•°åè½¬</span><br>        <span class="hljs-keyword">if</span> a == x:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reverse</span>(<span class="hljs-params">self, x: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        ans = <span class="hljs-number">0</span><br>        a = <span class="hljs-number">0</span>   <span class="hljs-comment"># é™¤æ³•ä½™æ•°</span><br>        <span class="hljs-keyword">while</span> x != <span class="hljs-number">0</span>:<br>            a = x % <span class="hljs-number">10</span><br>            x = x // <span class="hljs-number">10</span><br>            ans = ans * <span class="hljs-number">10</span> + a<br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="ç››æ°´æœ€å¤šçš„å®¹å™¨">11ã€ç››æ°´æœ€å¤šçš„å®¹å™¨</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/3.png" /></p><p>æˆ‘ä»¬ä½¿ç”¨åŒæŒ‡é’ˆçš„æ€æƒ³ï¼Œä¸¤ä¸ªæŒ‡é’ˆåˆ†åˆ«ä¸ºæ•°ç»„çš„å¤´å°¾ç»“ç‚¹ï¼Œæ¯è½®éƒ½è¿›è¡Œé¢ç§¯çš„è®¡ç®—ï¼Œå¹¶ä¸”æ¯è½®åªç§»åŠ¨è¾ƒå°ç»“ç‚¹çš„æŒ‡é’ˆã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">maxArea</span>(<span class="hljs-params">self, height: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-built_in">int</span>:<br>        n = <span class="hljs-built_in">len</span>(height)<br>        left = <span class="hljs-number">0</span>    <span class="hljs-comment"># å·¦æŒ‡é’ˆ</span><br>        right = n - <span class="hljs-number">1</span>   <span class="hljs-comment"># å³æŒ‡é’ˆ</span><br>        max_s = <span class="hljs-number">0</span>   <span class="hljs-comment"># é¢ç§¯æœ€å¤§å€¼</span><br>        s = <span class="hljs-number">0</span>   <span class="hljs-comment"># é¢ç§¯</span><br>        l = <span class="hljs-number">0</span>   <span class="hljs-comment"># è¾¹é•¿</span><br>        <span class="hljs-keyword">while</span> right &gt; left:<br>            <span class="hljs-keyword">if</span> height[left] &gt; height[right]:<br>                l = height[right]<br>            <span class="hljs-keyword">else</span>:<br>                l = height[left]<br>            s = (right - left) * l<br>            <span class="hljs-keyword">if</span> s &gt; max_s:<br>                max_s = s<br>            <span class="hljs-keyword">if</span> height[left] &gt; height[right]:<br>                right = right - <span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                left = left + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> max_s<br></code></pre></div></td></tr></table></figure><h2 id="æ•´æ•°è½¬ç½—é©¬æ•°å­—">12ã€æ•´æ•°è½¬ç½—é©¬æ•°å­—</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/4.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    A = [<br>        (<span class="hljs-number">1000</span>, <span class="hljs-string">&quot;M&quot;</span>),<br>        (<span class="hljs-number">900</span>, <span class="hljs-string">&quot;CM&quot;</span>),<br>        (<span class="hljs-number">500</span>, <span class="hljs-string">&quot;D&quot;</span>),<br>        (<span class="hljs-number">400</span>, <span class="hljs-string">&quot;CD&quot;</span>),<br>        (<span class="hljs-number">100</span>, <span class="hljs-string">&quot;C&quot;</span>),<br>        (<span class="hljs-number">90</span>, <span class="hljs-string">&quot;XC&quot;</span>),<br>        (<span class="hljs-number">50</span>, <span class="hljs-string">&quot;L&quot;</span>),<br>        (<span class="hljs-number">40</span>, <span class="hljs-string">&quot;XL&quot;</span>),<br>        (<span class="hljs-number">10</span>, <span class="hljs-string">&quot;X&quot;</span>),<br>        (<span class="hljs-number">9</span>, <span class="hljs-string">&quot;IX&quot;</span>),<br>        (<span class="hljs-number">5</span>, <span class="hljs-string">&quot;V&quot;</span>),<br>        (<span class="hljs-number">4</span>, <span class="hljs-string">&quot;IV&quot;</span>),<br>        (<span class="hljs-number">1</span>, <span class="hljs-string">&quot;I&quot;</span>),<br>    ]<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">intToRoman</span>(<span class="hljs-params">self, num: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>        ans = <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-keyword">for</span> value, s <span class="hljs-keyword">in</span> self.A:<br>            <span class="hljs-keyword">while</span> num &gt;= value:<br>                num = num - value<br>                ans = ans + s<br>            <span class="hljs-keyword">if</span> num == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">break</span><br>        <br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="ç½—é©¬æ•°å­—è½¬æ•´æ•°">13ã€ç½—é©¬æ•°å­—è½¬æ•´æ•°</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/5.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    A = &#123;<br>        <span class="hljs-string">&#x27;I&#x27;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&#x27;V&#x27;</span>: <span class="hljs-number">5</span>,<br>        <span class="hljs-string">&#x27;X&#x27;</span>: <span class="hljs-number">10</span>,<br>        <span class="hljs-string">&#x27;L&#x27;</span>: <span class="hljs-number">50</span>,<br>        <span class="hljs-string">&#x27;C&#x27;</span>: <span class="hljs-number">100</span>,<br>        <span class="hljs-string">&#x27;D&#x27;</span>: <span class="hljs-number">500</span>,<br>        <span class="hljs-string">&#x27;M&#x27;</span>: <span class="hljs-number">1000</span>,<br>    &#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">romanToInt</span>(<span class="hljs-params">self, s: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        ans = <span class="hljs-number">0</span><br>        n = <span class="hljs-built_in">len</span>(s)<br>        <span class="hljs-keyword">for</span> i, ch <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(s):<br>            <span class="hljs-keyword">if</span> i &lt; n - <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> self.A[ch] &lt; self.A[s[i+<span class="hljs-number">1</span>]]:<br>                ans = ans - self.A[ch]<br>            <span class="hljs-keyword">else</span>:<br>                ans = ans + self.A[ch]<br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="ä¸‰æ•°ä¹‹å’Œ">15ã€ä¸‰æ•°ä¹‹å’Œ</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/15.png" /></p><p>é‡‡ç”¨åŒæŒ‡é’ˆçš„æ€æƒ³ï¼Œä¸ºäº†ä¸ä½¿ä¸‰å…ƒç»„é‡å¤ï¼Œå…ˆå¯¹æ•°ç»„è¿›è¡Œæ’åºã€‚å½“ç¡®å®šäº†ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåªéœ€è¦å¯¹å‰©ä¸‹å…ƒç´ è¿›è¡Œè®¾ç½®å·¦æŒ‡é’ˆå’Œå³æŒ‡é’ˆï¼Œå¦‚æœä¸‰å…ƒç»„å¤§ä¸0ï¼Œå³æŒ‡é’ˆå°±å·¦ç§»ä¸€ä½ï¼Œåä¹‹äº¦ç„¶ã€‚å¦‚æœä¸‰å…ƒç»„ä¹‹å’Œåˆšå¥½ç­‰äº0ï¼Œå°±éœ€è¦å·¦æŒ‡é’ˆå’Œå³æŒ‡é’ˆéƒ½ç§»åŠ¨ä¸€ä½ã€‚è¿™æ—¶å€™è¿˜ä¼šå‡ºç°é‡å¤é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­æ­¤æ—¶éå†çš„å…ƒç´ å’Œä¹‹å‰çš„æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒå°±è¦è·³è¿‡ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">threeSum</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]]:<br>        nums.sort()<br>        n = <span class="hljs-built_in">len</span>(nums)<br>        ans = <span class="hljs-built_in">list</span>()<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<span class="hljs-comment"># å›ºå®šå…¶ä¸­ä¸€ä¸ªå…ƒç´ </span><br>            <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> nums[i] != nums[i - <span class="hljs-number">1</span>]:<br>                k = n - <span class="hljs-number">1</span><br>                j = i + <span class="hljs-number">1</span><br>                <span class="hljs-keyword">while</span> k &gt; j:<span class="hljs-comment"># è¿›è¡ŒåŒæŒ‡é’ˆéå†</span><br>                    <span class="hljs-keyword">if</span> k != n - <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> nums[k] == nums[k + <span class="hljs-number">1</span>]:<span class="hljs-comment"># å¦‚æœå³æŒ‡é’ˆä¹‹å‰å‡ºç°è¿‡å°±è·³è¿‡</span><br>                        k = k - <span class="hljs-number">1</span><br>                        <span class="hljs-keyword">continue</span><br>                    <span class="hljs-keyword">if</span> j != i + <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> nums[j] == nums[j - <span class="hljs-number">1</span>]:<span class="hljs-comment"># å¦‚æœå·¦æŒ‡é’ˆä¹‹å‰å‡ºç°è¿‡å°±è·³è¿‡</span><br>                        j = j + <span class="hljs-number">1</span><br>                        <span class="hljs-keyword">continue</span><br>                    s = nums[i] + nums[j] + nums[k]<br>                    <span class="hljs-keyword">if</span> s == <span class="hljs-number">0</span>:<br>                        ans.append([nums[i], nums[j], nums[k]])<br>                        k = k - <span class="hljs-number">1</span><br>                        j = j + <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">elif</span> s &gt; <span class="hljs-number">0</span>:<br>                        k = k - <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">elif</span> s &lt; <span class="hljs-number">0</span>:<br>                        j = j + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="æœ€æ¥è¿‘çš„ä¸‰æ•°ä¹‹å’Œ">16ã€æœ€æ¥è¿‘çš„ä¸‰æ•°ä¹‹å’Œ</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/16.png" /></p><p>é‡‡ç”¨åŒæŒ‡é’ˆçš„æ€æƒ³ï¼Œå…ˆå¯¹æ•°ç»„è¿›è¡Œæ’åºã€‚å½“ç¡®å®šäº†ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåªéœ€è¦å¯¹å‰©ä¸‹å…ƒç´ è¿›è¡Œè®¾ç½®å·¦æŒ‡é’ˆå’Œå³æŒ‡é’ˆï¼Œå¦‚æœä¸‰å…ƒç»„ä¹‹å’Œå¤§äºtargetï¼Œæˆ‘ä»¬åªéœ€è¦å°†å³èŠ‚ç‚¹å·¦ç§»ä¸€ä½ï¼Œç›¸åäº¦ç„¶ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">threeSumClosest</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], target: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        n = <span class="hljs-built_in">len</span>(nums)<br>        nums.sort()<br>        min_num = <span class="hljs-number">10</span>**<span class="hljs-number">9</span><br>        ans = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>            <span class="hljs-keyword">if</span> i != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> nums[i] == nums[i - <span class="hljs-number">1</span>]:<br>                <span class="hljs-keyword">continue</span><br>            k = n - <span class="hljs-number">1</span><br>            j = i + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">while</span> k &gt; j:<br>                s = nums[i] + nums[j] + nums[k]<br>                <span class="hljs-keyword">if</span> s == target:<br>                    <span class="hljs-keyword">return</span> s<br>                <span class="hljs-keyword">if</span> s &gt; target:<br>                    <span class="hljs-keyword">if</span> s - target &lt; min_num:<br>                        min_num = s - target<br>                        ans = s<br>                    k = k - <span class="hljs-number">1</span><br>                <span class="hljs-keyword">elif</span> s &lt; target:<br>                    <span class="hljs-keyword">if</span> target - s &lt; min_num:<br>                        min_num = target - s<br>                        ans = s<br>                    j = j + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="å››æ•°ä¹‹å’Œ">18ã€å››æ•°ä¹‹å’Œ</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/18.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fourSum</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], target: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]]:<br>        n = <span class="hljs-built_in">len</span>(nums)<br>        <span class="hljs-keyword">if</span> nums == [] <span class="hljs-keyword">or</span> n &lt; <span class="hljs-number">4</span>:<br>            <span class="hljs-keyword">return</span> []<br>        nums.sort()<br>        ans = <span class="hljs-built_in">list</span>()<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n - <span class="hljs-number">3</span>):<br>            <span class="hljs-keyword">if</span> i != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> nums[i] == nums[i - <span class="hljs-number">1</span>]:<br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">if</span> nums[i] + nums[i + <span class="hljs-number">1</span>] + nums[i + <span class="hljs-number">2</span>] + nums[i + <span class="hljs-number">3</span>] &gt; target:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">if</span> nums[i] + nums[n - <span class="hljs-number">1</span>] + nums[n - <span class="hljs-number">2</span>] + nums[n - <span class="hljs-number">3</span>] &lt; target:<br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, n - <span class="hljs-number">2</span>):<br>                <span class="hljs-keyword">if</span> j != i + <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> nums[j] == nums[j - <span class="hljs-number">1</span>]:<br>                    <span class="hljs-keyword">continue</span><br>                <span class="hljs-keyword">if</span> nums[i] + nums[j] + nums[j + <span class="hljs-number">1</span>] + nums[j + <span class="hljs-number">2</span>] &gt; target:<br>                    <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">if</span> nums[i] + nums[n - <span class="hljs-number">1</span>] + nums[n - <span class="hljs-number">2</span>] + nums[n - <span class="hljs-number">3</span>] &lt; target:<br>                    <span class="hljs-keyword">continue</span><br>                k = j + <span class="hljs-number">1</span><br>                l = n - <span class="hljs-number">1</span><br>                <span class="hljs-keyword">while</span> k &lt; l:<br>                    <span class="hljs-built_in">sum</span> = nums[i] + nums[j] + nums[k] + nums[l]<br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">sum</span> &lt; target:<br>                        k = k + <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">sum</span> &gt; target:<br>                        l = l - <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">sum</span> == target:<br>                        ans.append([nums[i], nums[j], nums[k], nums[l]])<br>                        <span class="hljs-keyword">while</span> k &lt; l <span class="hljs-keyword">and</span> nums[k] == nums[k + <span class="hljs-number">1</span>]:<br>                            k = k + <span class="hljs-number">1</span><br>                        k = k + <span class="hljs-number">1</span><br>                        <span class="hljs-keyword">while</span> k &lt; l <span class="hljs-keyword">and</span> nums[l] == nums[l - <span class="hljs-number">1</span>]:<br>                            l = l - <span class="hljs-number">1</span><br>                        l = l - <span class="hljs-number">1</span> <br><br>        <span class="hljs-keyword">return</span> ans<br></code></pre></div></td></tr></table></figure><h2 id="åˆ é™¤æœ‰åºæ•°ç»„ä¸­çš„é‡å¤é¡¹">26ã€åˆ é™¤æœ‰åºæ•°ç»„ä¸­çš„é‡å¤é¡¹</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/26.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">removeDuplicates</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">if</span> nums == []:<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>        n = <span class="hljs-built_in">len</span>(nums)<br>        left, right = <span class="hljs-number">1</span>, <span class="hljs-number">1</span><br>        <span class="hljs-keyword">while</span> right &lt; n:<br>            <span class="hljs-keyword">if</span> nums[right] != nums[right - <span class="hljs-number">1</span>]:<br>                nums[left] = nums[right]<br>                left = left + <span class="hljs-number">1</span><br>            right = right + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> left<br></code></pre></div></td></tr></table></figure><h2 id="ä¸‹ä¸€ä¸ªæ’åˆ—">31ã€ä¸‹ä¸€ä¸ªæ’åˆ—</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/31.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">nextPermutation</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Do not return anything, modify nums in-place instead.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        i = <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">2</span><br>        <span class="hljs-keyword">while</span> i &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> nums[i] &gt;= nums[i + <span class="hljs-number">1</span>]:<br>            i -= <span class="hljs-number">1</span><br>        j = <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> i &gt;= <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">while</span> j &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> nums[i] &gt;= nums[j]:<br>                j -= <span class="hljs-number">1</span><br>            nums[i], nums[j] = nums[j], nums[i]<br>        left, right = i + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span><br>        <span class="hljs-keyword">while</span> left &lt; right:<br>            nums[left], nums[right] = nums[right], nums[left]<br>            left += <span class="hljs-number">1</span><br>            right -= <span class="hljs-number">1</span><br></code></pre></div></td></tr></table></figure><h2 id="æœç´¢æ—‹è½¬æ’åºæ•°ç»„">33ã€æœç´¢æ—‹è½¬æ’åºæ•°ç»„</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/33.png" /></p><p>çœ‹åˆ°æœ‰åºçš„æ•°ç»„ï¼Œç„¶åå¯¹å…¶æŸ¥æ‰¾ï¼Œä¸€èˆ¬æœ€å…ˆè¦æƒ³åˆ°çš„æ˜¯äºŒåˆ†æŸ¥æ‰¾</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], target: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> nums:<br>            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span><br>        i = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">if</span> nums[<span class="hljs-number">0</span>] &gt; nums[<span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span>]:<br>            <span class="hljs-keyword">while</span> i &lt; <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> nums[i] &lt; nums[i + <span class="hljs-number">1</span>]:<br>             i += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> target &gt; nums[<span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span>]:<br>                left = <span class="hljs-number">0</span><br>                right = i<br>            <span class="hljs-keyword">elif</span> target &lt; nums[<span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span>]:<br>                left = i + <span class="hljs-number">1</span><br>                right = <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span><br>            <span class="hljs-keyword">elif</span> target == nums[<span class="hljs-built_in">len</span>(nums) -<span class="hljs-number">1</span>]:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            left, right = <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span><br>        <br>        <span class="hljs-keyword">while</span> left &lt;= right:<br>            mid = (left + right) // <span class="hljs-number">2</span><br>            <span class="hljs-keyword">if</span> target == nums[mid]:<br>                <span class="hljs-keyword">return</span> mid<br>            <span class="hljs-keyword">elif</span> target &lt; nums[mid]:<br>                right = mid - <span class="hljs-number">1</span><br>            <span class="hljs-keyword">elif</span> target &gt; nums[mid]:<br>                left = mid + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span><br></code></pre></div></td></tr></table></figure><h2id="åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ª">34ã€åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ª</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/34.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">searchRange</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], target: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]:<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> nums:<br>            <span class="hljs-keyword">return</span> [-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">binarySearch</span>(<span class="hljs-params">nums, target</span>):<br>            left, right = <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span><br>            <span class="hljs-keyword">while</span> left &lt;= right:<br>                mid = (left + right) // <span class="hljs-number">2</span><br>                <span class="hljs-keyword">if</span> nums[mid] &gt;= target:<br>                    right = mid - <span class="hljs-number">1</span><br>                <span class="hljs-keyword">elif</span> nums[mid] &lt; target:<br>                    left = mid + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">return</span> left<br>        a = binarySearch(nums, target)<br>        b = binarySearch(nums, target + <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> a == <span class="hljs-built_in">len</span>(nums) <span class="hljs-keyword">or</span> nums[a] != target:<br>            <span class="hljs-keyword">return</span>[-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span>[a, b - <span class="hljs-number">1</span>]<br></code></pre></div></td></tr></table></figure><h2 id="powx-n">50ã€Pow(x, n)</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/50.png" /></p><p>ä½¿ç”¨é€’å½’çš„æ€æƒ³ï¼Œç›´æ¥å¾ªç¯ä¼šå¯¼è‡´è¿è¡Œæ—¶é—´è¿‡é•¿</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">myPow</span>(<span class="hljs-params">self, x: <span class="hljs-built_in">float</span>, n: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">float</span>:<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">quickPow</span>(<span class="hljs-params">N</span>):<br>            <span class="hljs-keyword">if</span> N == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">1.0</span><br>            y = quickPow(N // <span class="hljs-number">2</span>)<br>            <span class="hljs-keyword">return</span> y * y <span class="hljs-keyword">if</span> N % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> y * y * x<br>        <span class="hljs-keyword">return</span> quickPow(n) <span class="hljs-keyword">if</span> n &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1.0</span> / quickPow(-n)<br></code></pre></div></td></tr></table></figure><h2 id="æœ€å¤§å­æ•°ç»„å’Œ">53ã€æœ€å¤§å­æ•°ç»„å’Œ</h2><p><img src="/img/LeetCode/æ•°ç»„åŠæ•°å­¦/53.png" /></p><p>çœ‹åˆ°è¿™ç§åŒºé—´çš„ï¼Œå¯ä»¥æƒ³åˆ°åŠ¨æ€è§„åˆ’</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">maxSubArray</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(nums)):<br>            nums[i] += <span class="hljs-built_in">max</span>(nums[i - <span class="hljs-number">1</span>], <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(nums)<br></code></pre></div></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>LeetCode</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>pytorch</title>
    <link href="/2022/04/27/pytorch/"/>
    <url>/2022/04/27/pytorch/</url>
    
    <content type="html"><![CDATA[<h1 id="pytorch">PyTorch</h1><h2 id="dataset">1ã€DataSet</h2><p>DataSetï¼šæä¾›ä¸€ç§æ–¹æ³•å»è·å–æ•°æ®åŠå…¶label</p><p>ä½¿ç”¨çš„æ•°æ®é›†ä¸ºèœœèœ‚ä¸èš‚èšçš„å›¾åƒæ•°æ®é›†ï¼Œåˆ†åˆ«ä¿å­˜åœ¨dataset/train/beesä»¥åŠdataset/train/ants</p><p>DataSetéœ€è¦é€šè¿‡ç»§æ‰¿é‡è½½æ‰èƒ½ä½¿ç”¨ï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> Dataset<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyData</span>(<span class="hljs-title class_ inherited__">Dataset</span>):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, root_dir, label_dir</span>):<span class="hljs-comment"># read data &amp; preprocess</span><br>        self.root_dir = root_dir    <span class="hljs-comment"># æ ¹ç›®å½•</span><br>        self.label_dir = label_dir  <span class="hljs-comment"># æ ‡è®°ç›®å½•</span><br>        self.path = os.path.join(self.root_dir, self.label_dir)     <span class="hljs-comment"># åœ°å€ç›¸åŠ </span><br>        self.img_path = os.listdir(self.path)   <span class="hljs-comment"># ç”Ÿæˆå›¾ç‰‡æ–‡ä»¶åˆ—è¡¨</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, index</span>):<span class="hljs-comment"># returns one sample at a time</span><br>        img_name = self.img_path[index]   <span class="hljs-comment"># æ–‡ä»¶å</span><br>        img_item_path = os.path.join(self.root_dir, self.label_dir, img_name)<br>        img = Image.<span class="hljs-built_in">open</span>(img_item_path)<br>        label = self.label_dir<br>        <span class="hljs-keyword">return</span> img, label<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<span class="hljs-comment"># returns the size of the dataset</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.img_path)<br><br><br><span class="hljs-comment"># è¯»å–èš‚èšå’Œèœœèœ‚çš„å›¾ç‰‡æ•°æ®é›†</span><br>root_dir = <span class="hljs-string">&quot;dataset/train&quot;</span><br>ants_label_dir = <span class="hljs-string">&quot;ants&quot;</span><br>bees_label_dir = <span class="hljs-string">&quot;bees&quot;</span><br>ants_dataset = MyData(root_dir, ants_label_dir)<br>bees_dataset = MyData(root_dir, bees_label_dir)<br><br><span class="hljs-comment"># å°†ä¸¤ä¸ªæ•°æ®é›†è¿›è¡Œåˆå¹¶ï¼Œæˆä¸ºè®­ç»ƒæ•°æ®é›†</span><br>train_dataset = ants_dataset + bees_dataset<br></code></pre></div></td></tr></table></figure><h2 id="dataloader">2ã€DataLoader</h2><p>DataSetå°±ç›¸å½“äºæ˜¯ä¸€æ•´ä¸ªæ•°æ®é›†ï¼Œè€ŒDataLoaderæ˜¯å–å‡ºå…¶ä¸­ä¸€éƒ¨åˆ†åˆ°ç¥ç»ç½‘ç»œä¸­è¿›è¡Œä½¿ç”¨ã€‚</p><p>ä½¿ç”¨çš„æ˜¯torchvisionæ‰€æä¾›çš„æ•°æ®é›†ã€‚DataLoaderä¸­çš„å‚æ•°åˆ†åˆ«é‡Šä¹‰å¦‚ä¸‹ï¼š</p><ul><li>datasetï¼šæˆ‘ä»¬æ‰€ä½¿ç”¨çš„æ•°æ®é›†ï¼Œå³datasetç±»å‹æ•°æ®</li><li>batch_sizeï¼šä¸€æ¬¡æŠ“å–å¤šå°‘ä¸ªæ•°æ®</li><li>shuffleï¼šæŠ“å–æ—¶æ˜¯å¦æ‰“ä¹±é¡ºåº</li><li>num_workersï¼šä»£è¡¨åˆ›å»ºäº†å¤šå°‘ä¸ªworkerè¿›ç¨‹ï¼Œ0è¡¨ç¤ºåªæœ‰ä¸»è¿›ç¨‹å»åŠ è½½batchæ•°æ®ï¼Œ1è¡¨ç¤ºæœ‰ä¸€ä¸ªworkerè¿›ç¨‹åŠ è½½batchæ•°æ®</li><li>drop_lastï¼šæ— æ³•æ•´é™¤æ—¶ï¼Œæœ€åå‰©ä½™çš„å‡ æ¡æ•°æ®è¦ä¸è¦å»é™¤</li></ul><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torchvision<br><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> DataLoader<br><br><span class="hljs-comment"># å‡†å¤‡çš„æµ‹è¯•æ•°æ®é›†</span><br><span class="hljs-keyword">from</span> torch.utils.tensorboard <span class="hljs-keyword">import</span> SummaryWriter<br><br>test_data = torchvision.datasets.CIFAR10(<span class="hljs-string">&quot;./dataset&quot;</span>, train=<span class="hljs-literal">False</span>, transform=torchvision.transforms.ToTensor(), download=<span class="hljs-literal">True</span>)<br><br>test_loader = DataLoader(dataset=test_data, batch_size=<span class="hljs-number">64</span>, shuffle=<span class="hljs-literal">True</span>, num_workers=<span class="hljs-number">0</span>, drop_last=<span class="hljs-literal">False</span>)<br><br>writer = SummaryWriter(<span class="hljs-string">&quot;dataloader&quot;</span>)<br>step = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> test_loader:<br>    imgs, targets = data<br>    writer.add_images(<span class="hljs-string">&quot;test_data&quot;</span>, imgs, step)<br>    step = step + <span class="hljs-number">1</span><br><br>writer.close()<br></code></pre></div></td></tr></table></figure><p>æœ€åæ˜¾ç¤ºç»“æœå¦‚ä¸‹ï¼š</p><p><img src="/img/pytorch/1.png" /></p><h2 id="tensorboard">3ã€TensorBoard</h2><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡TensorBoardå¯ä»¥æŸ¥çœ‹å›¾åƒ</p><h3 id="è¾“å‡ºå‡½æ•°å›¾åƒ">3.1è¾“å‡ºå‡½æ•°å›¾åƒ</h3><p>é¦–å…ˆæˆ‘ä»¬é€šè¿‡TensorBoardæ¥ç»˜åˆ¶y=xçš„å›¾åƒï¼Œæˆ‘ä»¬éœ€è¦å…ˆç”Ÿæˆä¸€ä¸ªå®ä¾‹ï¼Œéšåé€šè¿‡add_scalar()æ–¹æ³•æ¥æ·»åŠ ï¼Œå‚æ•°åˆ†åˆ«ä¸ºåç§°ï¼Œyè½´çš„å€¼ï¼Œxè½´çš„å€¼ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch.utils.tensorboard <span class="hljs-keyword">import</span> SummaryWriter<br><br><span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªå®ä¾‹,å­˜å‚¨åœ¨logsæ–‡ä»¶å¤¹ä¸‹</span><br>writer = SummaryWriter(<span class="hljs-string">&quot;logs&quot;</span>)<br><br><span class="hljs-comment"># y = xå›¾åƒ</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):<br>    writer.add_scalar(<span class="hljs-string">&quot;y=x&quot;</span>, i, i)<br><br>writer.close()<br></code></pre></div></td></tr></table></figure><p>å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶å°è¾“å…¥å¦‚ä¸‹æŒ‡ä»¤æ¥è§‚çœ‹å›¾åƒ</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">tensorboard --logdir=logs<br></code></pre></div></td></tr></table></figure><p>è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡6006ç«¯å£æ¥æŸ¥çœ‹å›¾åƒï¼Œä½†æ˜¯å¦‚æœæœ‰å¾ˆå¤štensorboardéƒ½è¦æŸ¥çœ‹å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©è‡ªå®šä¹‰ç«¯å£æŸ¥çœ‹ï¼Œä¾‹å¦‚æˆ‘ä»¬è¦é€‰æ‹©6007ç«¯å£æ¥æŸ¥çœ‹ï¼ŒæŒ‡ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">tensorboard --logdir=logs --port=6007<br></code></pre></div></td></tr></table></figure><p><img src="/img/pytorch/2.png" /></p><p>è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°y=xçš„å›¾åƒ</p><p>å¦‚æœæ˜¯y=2xçš„å›¾åƒåˆ™éœ€è¦ä¿®æ”¹ä»£ç ä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># y = 2xå›¾åƒ</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):<br>    writer.add_scalar(<span class="hljs-string">&quot;y=2x&quot;</span>, <span class="hljs-number">2</span>*i, i)<br></code></pre></div></td></tr></table></figure><h3 id="è¾“å‡ºå›¾ç‰‡">3.2è¾“å‡ºå›¾ç‰‡</h3><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡TensorBoardæ¥æ˜¾ç¤ºæˆ‘ä»¬çš„å›¾ç‰‡ï¼Œé€šè¿‡TensorBoardçš„add_image()æ–¹æ³•ï¼Œå‚æ•°åˆ†åˆ«ä¸ºåç§°ã€å›¾ç‰‡ï¼ˆéœ€è¦ä¸ºtensorç±»å‹æˆ–è€…numpyç±»å‹ï¼‰ã€global_stepã€ç±»å‹ï¼ˆå› ä¸ºé»˜è®¤çš„ç±»å‹ä¸ºæ˜¯ï¼ˆ3ï¼ŒHï¼ŒWï¼‰å³é€šé“(channel)ä¸º3ï¼ŒHä¸ºé«˜åº¦ï¼ŒWä¸ºå®½åº¦ï¼‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch.utils.tensorboard <span class="hljs-keyword">import</span> SummaryWriter<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br><span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªå®ä¾‹,å­˜å‚¨åœ¨logsæ–‡ä»¶å¤¹ä¸‹</span><br>writer = SummaryWriter(<span class="hljs-string">&quot;logs&quot;</span>)<br>image_path = <span class="hljs-string">&quot;dataset/train/ants/0013035.jpg&quot;</span><br>img_PIL = Image.<span class="hljs-built_in">open</span>(image_path)<br>img_array = np.array(img_PIL)<br><br>writer.add_image(<span class="hljs-string">&quot;test&quot;</span>, img_array, <span class="hljs-number">1</span>, dataformats=<span class="hljs-string">&#x27;HWC&#x27;</span>)<br><br>writer.close()<br></code></pre></div></td></tr></table></figure><h2 id="ç¥ç»ç½‘ç»œçš„åŸºæœ¬éª¨æ¶">4ã€ç¥ç»ç½‘ç»œçš„åŸºæœ¬éª¨æ¶</h2><p>åŸºæœ¬éª¨æ¶æ˜¯é€šè¿‡å¯¹nn.Moduleçš„ç»§æ‰¿é‡å†™å®ç°çš„ï¼Œå¤§ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModel</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>().__init__()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span></span>):<br>        output = <span class="hljs-built_in">input</span> + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> output<br><br>res = MyModel()<br>x = torch.tensor(<span class="hljs-number">1.0</span>)<br>output = res(x)<span class="hljs-comment"># æœ‰__call__æ–¹æ³•æ¥è°ƒç”¨ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å°†xè¾“å…¥ï¼Œä¸ç”¨æˆ‘ä»¬æ¥è°ƒç”¨forward()æ–¹æ³•</span><br><span class="hljs-built_in">print</span>(output)<br><br></code></pre></div></td></tr></table></figure><p>æœ€åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ§åˆ¶å°è¾“å‡ºä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">tensor(2.)<br></code></pre></div></td></tr></table></figure><h2 id="å·ç§¯å±‚">5ã€å·ç§¯å±‚</h2><p>é¦–å…ˆå¯¹äºå·ç§¯å±‚çš„å­¦ä¹ ï¼Œè¦äº†è§£å·ç§¯å±‚çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨torch.nn.functionalä¸­çš„æ–¹æ³•ï¼ˆä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨torch.nnï¼Œå…¶å¯¹functionalè¿›è¡Œäº†å°è£…ï¼Œè¿™é‡Œæ˜¯ä¸ºäº†äº†è§£å¦‚ä½•å·ç§¯ï¼‰è¿›è¡Œå­¦ä¹ ï¼Œé¦–å…ˆè¦å¯¹conv2dçš„strideå‚æ•°è¿›è¡Œäº†è§£ï¼Œstrideæ—¶è®¡ç®—å·ç§¯æ—¶ç§»åŠ¨çš„æ­¥é•¿ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»£ç æ¥äº†è§£ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><br><span class="hljs-built_in">input</span> = torch.tensor([[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>],<br>                      [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>],<br>                      [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>                      [<span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>],<br>                      [<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]])<br><br>kernel = torch.tensor([[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>],<br>                       [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>],<br>                       [<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>]])<br><br><span class="hljs-built_in">input</span> = torch.reshape(<span class="hljs-built_in">input</span>, (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>))<br>kernel = torch.reshape(kernel, (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>))<br><br>output = F.conv2d(<span class="hljs-built_in">input</span>, kernel, stride=<span class="hljs-number">1</span>)<br><span class="hljs-built_in">print</span>(output)<br><br>output2 = F.conv2d(<span class="hljs-built_in">input</span>, kernel, stride=<span class="hljs-number">2</span>)<br><span class="hljs-built_in">print</span>(output2)<br></code></pre></div></td></tr></table></figure><p>è¾“å‡ºç»“æœä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">tensor([[[[10, 12, 12],<br>          [18, 16, 16],<br>          [13,  9,  3]]]])<br>tensor([[[[10, 12],<br>          [13,  3]]]])<br></code></pre></div></td></tr></table></figure><p>å›¾ç¤ºä¸ºï¼š</p><p><img src="/img/pytorch/4.png" /></p><p>éšåæˆ‘ä»¬è¦å­¦ä¹ çš„æ˜¯conv2dä¸­çš„paddingå‚æ•°ï¼Œå®ƒæ˜¯å¯¹è¾“å…¥å›¾åƒçš„å‘¨å›´è¿›è¡Œå¡«å……ï¼Œå¹¶è®¾ç½®å¡«å……å€¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">output3 = F.conv2d(<span class="hljs-built_in">input</span>, kernel, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">1</span>)<br><span class="hljs-built_in">print</span>(output3)<br></code></pre></div></td></tr></table></figure><p>è¾“å‡ºç»“æœä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">tensor([[[[ 1,  3,  4, 10,  8],<br>          [ 5, 10, 12, 12,  6],<br>          [ 7, 18, 16, 16,  8],<br>          [11, 13,  9,  3,  4],<br>          [14, 13,  9,  7,  4]]]])<br></code></pre></div></td></tr></table></figure><p>å›¾ç¤ºä¸ºï¼š</p><p><img src="/img/pytorch/5.png" /></p><p>ç°åœ¨å¯¹å·ç§¯å±‚çš„çŸ¥è¯†è¿›è¡Œäº†å­¦ä¹ åæ­£å¼æ¥æ—¶å­¦ä¹ å·ç§¯å±‚æ˜¯å¦‚ä½•æ­å»ºçš„ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨çš„æ˜¯torch.nnä¸­çš„conv2dæ–¹æ³•ï¼Œå…¶æ–¹æ³•çš„å‚æ•°è§£é‡Šåœ¨å®˜æ–¹æ–‡æ¡£ä¸­å¦‚ä¸‹ï¼š</p><ul><li><strong>in_channels</strong> (<ahref="https://docs.python.org/3/library/functions.html#int"><em>int</em></a>)â€“ Number of channels in the input image</li><li><strong>out_channels</strong> (<ahref="https://docs.python.org/3/library/functions.html#int"><em>int</em></a>)â€“ Number of channels produced by the convolution</li><li><strong>kernel_size</strong> (<ahref="https://docs.python.org/3/library/functions.html#int"><em>int</em></a><em>or</em> <ahref="https://docs.python.org/3/library/stdtypes.html#tuple"><em>tuple</em></a>)â€“ Size of the convolving kernel</li><li><strong>stride</strong> (<ahref="https://docs.python.org/3/library/functions.html#int"><em>int</em></a><em>or</em> <ahref="https://docs.python.org/3/library/stdtypes.html#tuple"><em>tuple</em></a><em>,</em><em>optional</em>) â€“ Stride of the convolution. Default: 1</li><li><strong>padding</strong> (<ahref="https://docs.python.org/3/library/functions.html#int"><em>int</em></a><em>,</em><ahref="https://docs.python.org/3/library/stdtypes.html#tuple"><em>tuple</em></a><em>or</em> <ahref="https://docs.python.org/3/library/stdtypes.html#str"><em>str</em></a><em>,</em><em>optional</em>) â€“ Padding added to all four sides of the input.Default: 0</li><li><strong>padding_mode</strong> (*string**,* <em>optional</em>) â€“<code>'zeros'</code>, <code>'reflect'</code>, <code>'replicate'</code>or <code>'circular'</code>. Default: <code>'zeros'</code></li><li><strong>dilation</strong> (<ahref="https://docs.python.org/3/library/functions.html#int"><em>int</em></a><em>or</em> <ahref="https://docs.python.org/3/library/stdtypes.html#tuple"><em>tuple</em></a><em>,</em><em>optional</em>) â€“ Spacing between kernel elements. Default: 1</li><li><strong>groups</strong> (<ahref="https://docs.python.org/3/library/functions.html#int"><em>int</em></a><em>,</em><em>optional</em>) â€“ Number of blocked connections from input channelsto output channels. Default: 1</li><li><strong>bias</strong> (<ahref="https://docs.python.org/3/library/functions.html#bool"><em>bool</em></a><em>,</em><em>optional</em>) â€“ If <code>True</code>, adds a learnable bias to theoutput. Default: <code>True</code></li></ul><p><img src="/img/pytorch/3.png" /></p><p>æˆ‘ä»¬ç®€å•çš„å¯¹å›¾åƒè¿›è¡Œå·ç§¯å¤„ç†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torchvision<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torch.nn <span class="hljs-keyword">import</span> Conv2d<br><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> DataLoader<br><span class="hljs-keyword">from</span> torch.utils.tensorboard <span class="hljs-keyword">import</span> SummaryWriter<br><br>test_data = torchvision.datasets.CIFAR10(<span class="hljs-string">&quot;./dataset&quot;</span>, train=<span class="hljs-literal">False</span>, transform=torchvision.transforms.ToTensor(),<br>                                         download=<span class="hljs-literal">True</span>)<br>dataloader = DataLoader(dataset=test_data, batch_size=<span class="hljs-number">64</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModel</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(MyModel, self).__init__()<br>        self.conv1 = Conv2d(in_channels=<span class="hljs-number">3</span>, out_channels=<span class="hljs-number">6</span>, kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        x = self.conv1(x)<br>        <span class="hljs-keyword">return</span> x<br><br><br>myModel = MyModel()<br><br>writer = SummaryWriter(<span class="hljs-string">&quot;logs&quot;</span>)<br>step = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> dataloader:<br>    imgs, targets = data<br>    output = myModel(imgs)<br>    <span class="hljs-comment"># print(imgs.shape)</span><br>    <span class="hljs-comment"># print(output.shape)</span><br><br>    <span class="hljs-comment"># torch.Size([64, 3, 32, 32])</span><br>    writer.add_images(<span class="hljs-string">&quot;input&quot;</span>, imgs, step)<br>    <span class="hljs-comment"># torch.Size([64, 6, 32, 32]) -&gt; [xxx, 3, 32, 32]ï¼Œå› ä¸ºout_channelsä¸º6æ²¡åŠæ³•addè¿›å»</span><br>    output = torch.reshape(output, (-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">30</span>, <span class="hljs-number">30</span>))<br>    writer.add_images(<span class="hljs-string">&quot;output&quot;</span>, output, step)<br><br>    step = step + <span class="hljs-number">1</span><br></code></pre></div></td></tr></table></figure><p>è¿è¡Œç»“æœåœ¨tensorboardä¸Šæ˜¾ç¤ºä¸ºï¼š</p><p><img src="/img/pytorch/6.png" /></p><p><img src="/img/pytorch/7.png" /></p><h2 id="æ± åŒ–å±‚">6ã€æ± åŒ–å±‚</h2><p>æˆ‘ä»¬è¦ä½¿ç”¨çš„æ˜¯torch.nnä¸­çš„MaxPool2dæ–¹æ³•ï¼Œå…¶ä¸­å‚æ•°è§£é‡Šä¸ºï¼š</p><ul><li><strong>kernel_size</strong> â€“ the size of the window to take a maxover</li><li><strong>stride</strong> â€“ the stride of the window. Default value is<code>kernel_size</code></li><li><strong>padding</strong> â€“ implicit zero padding to be added on bothsides</li><li><strong>dilation</strong> â€“ a parameter that controls the stride ofelements in the window</li><li><strong>return_indices</strong> â€“ if <code>True</code>, will returnthe max indices along with the outputs. Useful for <ahref="https://pytorch.org/docs/stable/generated/torch.nn.MaxUnpool2d.html#torch.nn.MaxUnpool2d"><code>torch.nn.MaxUnpool2d</code></a>later</li><li><strong>ceil_mode</strong> â€“ when True, will use ceil instead offloor to compute the output shape</li></ul><p>å¯¹äºceil_modeçš„ä¸¤ç§æƒ…å†µå¦‚ä¸‹å›¾ç¤ºæ„ï¼š</p><p><img src="/img/pytorch/8.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torch.nn <span class="hljs-keyword">import</span> MaxPool2d<br><br><span class="hljs-built_in">input</span> = torch.tensor([[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>],<br>                      [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>],<br>                      [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],<br>                      [<span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>],<br>                      [<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]], dtype=torch.float32)<br><span class="hljs-built_in">input</span> = torch.reshape(<span class="hljs-built_in">input</span>, (-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>))<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModel</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(MyModel, self).__init__()<br>        self.maxpool1 = MaxPool2d(kernel_size=<span class="hljs-number">3</span>, ceil_mode=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span></span>):<br>        output = self.maxpool1(<span class="hljs-built_in">input</span>)<br>        <span class="hljs-keyword">return</span> output<br><br><br>myModel = MyModel()<br>output = myModel(<span class="hljs-built_in">input</span>)<br><span class="hljs-built_in">print</span>(output)<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">tensor([[[[2., 3.],<br>          [5., 1.]]]])<br></code></pre></div></td></tr></table></figure><p>å½“æˆ‘ä»¬å°†ceil_modeä¿®æ”¹ä¸ºFalseåï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">self.maxpool1 = MaxPool2d(kernel_size=<span class="hljs-number">3</span>, ceil_mode=<span class="hljs-literal">False</span>)<br></code></pre></div></td></tr></table></figure><p>ç»“æœä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">tensor([[[[2.]]]])<br></code></pre></div></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ç›´è§‚çš„æ„Ÿå—ä¸€ä¸‹æœ€å¤§æ± åŒ–åçš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥å°†è¾“å…¥æ¢æˆæˆ‘ä»¬çš„æ•°æ®é›†ï¼Œåœ¨tensorboardä¸ŠæŸ¥çœ‹è¾“å…¥è¾“å‡ºçš„å·®åˆ«ï¼š</p><p><img src="/img/pytorch/9.png" /></p><h2 id="éçº¿æ€§æ¿€æ´»">7ã€éçº¿æ€§æ¿€æ´»</h2><p>é¦–å…ˆæˆ‘ä»¬è¦ä½¿ç”¨çš„æ˜¯torch.nnä¸­çš„ReLUæ–¹æ³•</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torch.nn <span class="hljs-keyword">import</span> ReLU<br><br><span class="hljs-built_in">input</span> = torch.tensor([[<span class="hljs-number">1</span>, -<span class="hljs-number">0.5</span>],<br>                      [-<span class="hljs-number">1</span>, <span class="hljs-number">3</span>]])<br><br><span class="hljs-built_in">input</span> = torch.reshape(<span class="hljs-built_in">input</span>, (-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>))<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModel</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(MyModel, self).__init__()<br>        self.relu1 = ReLU()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span></span>):<br>        output = self.relu1(<span class="hljs-built_in">input</span>)<br>        <span class="hljs-keyword">return</span> output<br><br><br>myModel = MyModel()<br>output = myModel(<span class="hljs-built_in">input</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">input</span>)<br><span class="hljs-built_in">print</span>(output)<br></code></pre></div></td></tr></table></figure><p>ç»“æœä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">tensor([[[[ 1.0000, -0.5000],<br>          [-1.0000,  3.0000]]]])<br>tensor([[[[1., 0.],<br>          [0., 3.]]]])<br></code></pre></div></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬ä½¿ç”¨torch.nnä¸­çš„Sigmoidæ–¹æ³•æ›´ç›´è§‚çš„æ¥æŸ¥çœ‹ç»“æœï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torchvision<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torch.nn <span class="hljs-keyword">import</span> Sigmoid<br><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> DataLoader<br><span class="hljs-keyword">from</span> torch.utils.tensorboard <span class="hljs-keyword">import</span> SummaryWriter<br><br>test_data = torchvision.datasets.CIFAR10(<span class="hljs-string">&quot;./dataset&quot;</span>, train=<span class="hljs-literal">False</span>, transform=torchvision.transforms.ToTensor(),<br>                                         download=<span class="hljs-literal">True</span>)<br>dataloader = DataLoader(dataset=test_data, batch_size=<span class="hljs-number">64</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModel</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(MyModel, self).__init__()<br>        self.sigmoid1 = Sigmoid()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span></span>):<br>        output = self.sigmoid1(<span class="hljs-built_in">input</span>)<br>        <span class="hljs-keyword">return</span> output<br><br>myModel = MyModel()<br>writer = SummaryWriter(<span class="hljs-string">&quot;logs_sigmoid&quot;</span>)<br>step = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> dataloader:<br>    imgs, target = data<br>    output = myModel(imgs)<br>    writer.add_images(<span class="hljs-string">&quot;input&quot;</span>, imgs, step)<br>    writer.add_images(<span class="hljs-string">&quot;output&quot;</span>, output, step)<br>    step = step + <span class="hljs-number">1</span><br><br>writer.close()<br></code></pre></div></td></tr></table></figure><p>åœ¨tensorboardä¸­æŸ¥çœ‹è¿è¡Œç»“æœï¼š</p><p><img src="/img/pytorch/10.png" /></p><h2 id="çº¿æ€§å±‚-åŠå…¶ä»–å±‚">8ã€çº¿æ€§å±‚ åŠå…¶ä»–å±‚</h2><p>ä¸»è¦è¿˜æ˜¯æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p><h2id="æ­å»ºå°å®ä¾‹å’Œsequentialçš„ä½¿ç”¨">9ã€æ­å»ºå°å®ä¾‹å’ŒSequentialçš„ä½¿ç”¨</h2><p>æˆ‘ä»¬ä½¿ç”¨ä¹‹å‰å­¦ä¹ è¿‡çš„åŸºç¡€æ¥æ­å»ºä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œï¼Œä¾‹å¦‚æˆ‘ä»¬æ¥æ­å»ºcifar10çš„æ¨¡å‹ï¼Œå…¶å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/img/pytorch/11.png" /></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModel</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(MyModel, self).__init__()<br>        self.conv1 = Conv2d(<span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">5</span>, padding=<span class="hljs-number">2</span>)<br>        self.maxpool1 = MaxPool2d(<span class="hljs-number">2</span>)<br>        self.conv2 = Conv2d(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">5</span>, padding=<span class="hljs-number">2</span>)<br>        self.maxpool2 = MaxPool2d(<span class="hljs-number">2</span>)<br>        self.conv3 = Conv2d(<span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">5</span>, padding=<span class="hljs-number">2</span>)<br>        self.maxpool3 = MaxPool2d(<span class="hljs-number">2</span>)<br>        self.flatten = Flatten()<br>        self.linear1 = Linear(<span class="hljs-number">1024</span>, <span class="hljs-number">64</span>)<br>        self.linear2 = Linear(<span class="hljs-number">64</span>, <span class="hljs-number">10</span>)<br><br>        self.model1 = Sequential(<br>            Conv2d(<span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">5</span>, padding=<span class="hljs-number">2</span>)<br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        x = self.conv1(x)<br>        x = self.maxpool1(x)<br>        x = self.conv2(x)<br>        x = self.maxpool2(x)<br>        x = self.conv2(x)<br>        x = self.maxpool2(x)<br>        x = self.flatten(x)<br>        x = self.linear1(x)<br>        x = self.linear2(x)<br>        <span class="hljs-keyword">return</span> x<br></code></pre></div></td></tr></table></figure><p>å¼•å…¥äº†Sequentialæ–¹æ³•åå¯ä»¥å°†æˆ‘ä»¬æ­å»ºçš„æ¨¡å‹ç®€å†™å‡ºæ¥</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModel</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.model1 = Sequential(<br>            Conv2d(<span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">5</span>, padding=<span class="hljs-number">2</span>),<br>            MaxPool2d(<span class="hljs-number">2</span>),<br>            Conv2d(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">5</span>, padding=<span class="hljs-number">2</span>),<br>            MaxPool2d(<span class="hljs-number">2</span>),<br>            Conv2d(<span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">5</span>, padding=<span class="hljs-number">2</span>),<br>            MaxPool2d(<span class="hljs-number">2</span>),<br>            Flatten(),<br>            Linear(<span class="hljs-number">1024</span>, <span class="hljs-number">64</span>),<br>            Linear(<span class="hljs-number">64</span>, <span class="hljs-number">10</span>)<br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        x = self.model1(x)<br>        <span class="hljs-keyword">return</span> x<br></code></pre></div></td></tr></table></figure><h2 id="æŸå¤±å‡½æ•°ä¸åå‘ä¼ æ’­">10ã€æŸå¤±å‡½æ•°ä¸åå‘ä¼ æ’­</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨torch.nnä¸­çš„L1Lossä»¥åŠMSELossæ–¹æ³•æ¥æ„é€ æŸå¤±å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-built_in">input</span> = torch.tensor([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], dtype=torch.float32)<br>target = torch.tensor([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>], dtype=torch.float32)<br><br><span class="hljs-built_in">input</span> = torch.reshape(<span class="hljs-built_in">input</span>, (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>))<br>target = torch.reshape(target, (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>))<br><br>loss = L1Loss(reduction=<span class="hljs-string">&#x27;sum&#x27;</span>)<br>result = loss(<span class="hljs-built_in">input</span>, target)<br><br>loss_mse = nn.MSELoss()<br>result_mse = loss_mse(<span class="hljs-built_in">input</span>, target)<br><br><span class="hljs-built_in">print</span>(result)<br><span class="hljs-built_in">print</span>(result_mse)<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œç»“æœä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">tensor(2.)<br>tensor(1.3333)<br></code></pre></div></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨äº¤å‰ç†µä½œä¸ºæŸå¤±å‡½æ•°æ¥è¿›è¡Œåå‘ä¼ æ’­ï¼Œåˆ©ç”¨backwardæ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">myModel = MyModel()<br>loss = nn.CrossEntropyLoss()<br><span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> dataloader:<br>    imgs, targets = data<br>    output = myModel(imgs)<br>    result_loss = loss(output, targets)<br>    result_loss.backward()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ok&quot;</span>)<br></code></pre></div></td></tr></table></figure><h2 id="ä¼˜åŒ–å™¨">11ã€ä¼˜åŒ–å™¨</h2><p>ä½¿ç”¨torch.optimä¸­çš„ä¼˜åŒ–å™¨:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">myModel = MyModel()<br>loss = nn.CrossEntropyLoss()<br>optim = torch.optim.SGD(myModel.parameters(), lr=<span class="hljs-number">0.01</span>)<br><span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>):<br>    runing_loss = <span class="hljs-number">0.0</span><br>    <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> dataloader:<br>        imgs, targets = data<br>        output = myModel(imgs)<br>        result_loss = loss(output, targets)<br>        optim.zero_grad()<span class="hljs-comment"># å°†æ¢¯åº¦åˆå§‹åŒ–ä¸º0</span><br>        result_loss.backward()<br>        optim.step()<span class="hljs-comment"># è¿›è¡Œä¼˜åŒ–</span><br>        runing_loss = runing_loss + result_loss<br>    <span class="hljs-built_in">print</span>(runing_loss)<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">tensor(<span class="hljs-number">18666.8984</span>, grad_fn=&lt;AddBackward0&gt;)<br>tensor(<span class="hljs-number">16161.6846</span>, grad_fn=&lt;AddBackward0&gt;)<br>tensor(<span class="hljs-number">15338.8057</span>, grad_fn=&lt;AddBackward0&gt;)<br>...<br></code></pre></div></td></tr></table></figure><p><code>torch.optim.lr_scheduler</code>æ¨¡å—æä¾›äº†ä¸€äº›æ ¹æ®epochè®­ç»ƒæ¬¡æ•°æ¥è°ƒæ•´å­¦ä¹ ç‡ï¼ˆlearningrateï¼‰çš„æ–¹æ³•ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šè®¾ç½®éšç€epochçš„å¢å¤§è€Œé€æ¸å‡å°å­¦ä¹ ç‡ä»è€Œè¾¾åˆ°æ›´å¥½çš„è®­ç»ƒæ•ˆæœã€‚</p><p><code>torch.optim.lr_scheduler.LambdaLR</code>ä¸­å¤§éƒ¨åˆ†è°ƒæ•´å­¦ä¹ ç‡çš„æ–¹æ³•éƒ½æ˜¯æ ¹æ®epochè®­ç»ƒæ¬¡æ•°</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">torch</span>.optim.lr_scheduler.LambdaLR(optimizer, lr_lambda, last_epoch=-<span class="hljs-number">1</span>)<br></code></pre></div></td></tr></table></figure><p>æ›´æ–°ç­–ç•¥ï¼š <span class="math display">\[new\_lr=\lambda \times initial\_lr\]</span> å…¶ä¸­new_lræ˜¯å¾—åˆ°çš„æ–°çš„å­¦ä¹ ç‡ï¼Œinitial_lræ˜¯åˆå§‹çš„å­¦ä¹ ç‡ï¼Œ<spanclass="math inline">\(\lambda\)</span>æ˜¯é€šè¿‡å‚æ•°lr_lambdaå’Œepochå¾—åˆ°çš„ã€‚</p><p>å‚æ•°ï¼š</p><p>optimizer ï¼ˆOptimizerï¼‰ï¼šè¦æ›´æ”¹å­¦ä¹ ç‡çš„ä¼˜åŒ–å™¨ï¼› lr_lambdaï¼ˆfunctionor listï¼‰ï¼šæ ¹æ®epochè®¡ç®—<spanclass="math inline">\(\lambda\)</span>çš„å‡½æ•°ï¼›æˆ–è€…æ˜¯ä¸€ä¸ªlistçš„è¿™æ ·çš„functionï¼Œåˆ†åˆ«è®¡ç®—å„ä¸ªparametergroupsçš„å­¦ä¹ ç‡æ›´æ–°ç”¨åˆ°çš„<span class="math inline">\(\lambda\)</span>ï¼›last_epochï¼ˆintï¼‰ï¼šæœ€åä¸€ä¸ªepochçš„indexï¼Œå¦‚æœæ˜¯è®­ç»ƒäº†å¾ˆå¤šä¸ªepochåä¸­æ–­äº†ï¼Œç»§ç»­è®­ç»ƒï¼Œè¿™ä¸ªå€¼å°±ç­‰äºåŠ è½½çš„æ¨¡å‹çš„epochã€‚é»˜è®¤ä¸º-1è¡¨ç¤ºä»å¤´å¼€å§‹è®­ç»ƒï¼Œå³ä»epoch=1å¼€å§‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">net_1 = model()<br><br>optimizer_1 = torch.optim.Adam(net_1.parameters(), lr = initial_lr)<br>scheduler_1 = LambdaLR(optimizer_1, lr_lambda=<span class="hljs-keyword">lambda</span> epoch: <span class="hljs-number">1</span>/(epoch+<span class="hljs-number">1</span>))<br></code></pre></div></td></tr></table></figure><h2 id="ç°æœ‰ç½‘ç»œæ¨¡å‹çš„ä½¿ç”¨ä¸ä¿®æ”¹">12ã€ç°æœ‰ç½‘ç»œæ¨¡å‹çš„ä½¿ç”¨ä¸ä¿®æ”¹</h2><p>æˆ‘ä»¬ä½¿ç”¨torchvisionä¸­ç°æœ‰çš„vgg16æ¨¡å‹è¿›è¡Œä½¿ç”¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">vgg16_true = torchvison.models.vgg16(pretrained=<span class="hljs-literal">True</span>)<br><span class="hljs-comment"># æ·»åŠ å±‚</span><br>vgg16_true.classifier.add_module(<span class="hljs-string">&#x27;add_linear&#x27;</span>, nn.Linear(<span class="hljs-number">1000</span>, <span class="hljs-number">10</span>))<br><span class="hljs-comment"># ä¿®æ”¹å±‚</span><br>vgg16_true.classifier[<span class="hljs-number">6</span>] = nn.Linear(<span class="hljs-number">4096</span>, <span class="hljs-number">10</span>)<br></code></pre></div></td></tr></table></figure><h2 id="ç½‘ç»œæ¨¡å‹çš„ä¿å­˜ä¸è¯»å–">13ã€ç½‘ç»œæ¨¡å‹çš„ä¿å­˜ä¸è¯»å–</h2><p>ä¿å­˜æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">vgg16 = torchvision.models.vgg16(pretrained=<span class="hljs-literal">False</span>)<br><span class="hljs-comment"># ä¿å­˜æ–¹æ³•1</span><br>torch.save(vgg16, <span class="hljs-string">&quot;vgg16_method1.pth&quot;</span>)<br><br><span class="hljs-comment"># ä¿å­˜æ–¹æ³•äºŒï¼Œå°†æ¨¡å‹å‚æ•°ä¿å­˜ä¸ºå­—å…¸ï¼ˆå®˜æ–¹æ¨èï¼‰</span><br>torch.save(vgg16.state_dict(), <span class="hljs-string">&quot;vgg16_method2.pth&quot;</span>)<br></code></pre></div></td></tr></table></figure><p>è¯»å–æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># æ–¹æ³•1ä¿å­˜çš„æ¨¡å‹è¿›è¡Œè¯»å–</span><br>model = torch.load(<span class="hljs-string">&quot;vgg16_method1.pth&quot;</span>)<br><br><span class="hljs-comment"># æ–¹æ³•2ä¿å­˜çš„æ¨¡å‹è¿›è¡Œè¯»å–</span><br>vgg16 = vgg16 = torchvision.models.vgg16(pretrained=<span class="hljs-literal">False</span>)<br>vgg16.load_state_dict(torch.load(<span class="hljs-string">&quot;vgg16_method1.pth&quot;</span>))<br></code></pre></div></td></tr></table></figure><h2 id="å®Œæ•´çš„æ¨¡å‹è®­ç»ƒ">14ã€å®Œæ•´çš„æ¨¡å‹è®­ç»ƒ</h2><p>model.pyï¼šç”¨äºä¿å­˜ç½‘ç»œæ¨¡å‹</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModel</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(MyModel, self).__init__()<br>        self.model = nn.Sequential(<br>            nn.Conv2d(<span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>),<br>            nn.MaxPool2d(<span class="hljs-number">2</span>),<br>            nn.Conv2d(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>),<br>            nn.MaxPool2d(<span class="hljs-number">2</span>),<br>            nn.Conv2d(<span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>),<br>            nn.MaxPool2d(<span class="hljs-number">2</span>),<br>            nn.Flatten(),<br>            nn.Linear(<span class="hljs-number">64</span> * <span class="hljs-number">4</span> * <span class="hljs-number">4</span>, <span class="hljs-number">64</span>),<br>            nn.Linear(<span class="hljs-number">64</span>, <span class="hljs-number">10</span>)<br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        x = self.model(x)<br>        <span class="hljs-keyword">return</span> x<br><br><br><span class="hljs-comment"># éªŒè¯</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    myModel = MyModel()<br>    <span class="hljs-built_in">input</span> = torch.ones((<span class="hljs-number">64</span>, <span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>))<br>    output = myModel(<span class="hljs-built_in">input</span>)<br>    <span class="hljs-built_in">print</span>(output.shape)<br></code></pre></div></td></tr></table></figure><p>train.pyï¼šè¿›è¡Œç½‘ç»œè®­ç»ƒ</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torchvision<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> DataLoader<br><span class="hljs-keyword">from</span> torch.utils.tensorboard <span class="hljs-keyword">import</span> SummaryWriter<br><br><span class="hljs-keyword">from</span> model <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># å‡†å¤‡æ•°æ®é›†</span><br>train_data = torchvision.datasets.CIFAR10(<span class="hljs-string">&quot;./dataset&quot;</span>, train=<span class="hljs-literal">True</span>, transform=torchvision.transforms.ToTensor(),<br>                                         download=<span class="hljs-literal">True</span>)<br>test_data = torchvision.datasets.CIFAR10(<span class="hljs-string">&quot;./dataset&quot;</span>, train=<span class="hljs-literal">False</span>, transform=torchvision.transforms.ToTensor(),<br>                                         download=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># è·å–æ•°æ®é›†é•¿åº¦</span><br>train_data_length = <span class="hljs-built_in">len</span>(train_data)<br>test_data_length = <span class="hljs-built_in">len</span>(test_data)<br><br><span class="hljs-comment"># åˆ©ç”¨DataLoaderåŠ è½½æ•°æ®</span><br>train_dataloader = DataLoader(train_data, batch_size=<span class="hljs-number">64</span>)<br>test_dataloader = DataLoader(test_data, batch_size=<span class="hljs-number">64</span>)<br><br><span class="hljs-comment"># åˆ›å»ºç½‘ç»œæ¨¡å‹</span><br>myModel = MyModel()<br><br><span class="hljs-comment"># æŸå¤±å‡½æ•°</span><br>loss_fn = nn.CrossEntropyLoss()<br><br><span class="hljs-comment"># ä¼˜åŒ–å™¨</span><br>learning_rate = <span class="hljs-number">0.01</span><br>optimizer = torch.optim.SGD(myModel.parameters(), lr=learning_rate)<br><br><span class="hljs-comment"># è®¾ç½®è®­ç»ƒç½‘ç»œçš„ä¸€äº›å‚æ•°</span><br><span class="hljs-comment"># è®°å½•è®­ç»ƒçš„æ¬¡æ•°</span><br>total_train_step = <span class="hljs-number">0</span><br><span class="hljs-comment"># è®°å½•æµ‹è¯•çš„æ¬¡æ•°</span><br>total_test_step = <span class="hljs-number">0</span><br><span class="hljs-comment"># è®­ç»ƒè®ºæ•°</span><br>epoch = <span class="hljs-number">10</span><br><br><span class="hljs-comment"># æ·»åŠ tensorboard</span><br>writer = SummaryWriter(<span class="hljs-string">&quot;logs_train&quot;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(epoch):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;------ç¬¬%dè½®è®­ç»ƒå¼€å§‹------&quot;</span> % (i+<span class="hljs-number">1</span>))<br><br>    <span class="hljs-comment"># è®­ç»ƒæ­¥éª¤å¼€å§‹</span><br>    myModel.train()<br>    <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> train_dataloader:<br>        imgs, targets = data<br>        outputs = myModel(imgs)<br>        loss = loss_fn(outputs, targets)<br><br>        <span class="hljs-comment"># ä¼˜åŒ–å™¨ä¼˜åŒ–æ¨¡å‹</span><br>        <span class="hljs-comment"># åˆ©ç”¨ä¼˜åŒ–å™¨è¿›è¡Œæ¢¯åº¦æ¸…é›¶</span><br>        optimizer.zero_grad()<br>        <span class="hljs-comment"># åå‘ä¼ æ’­</span><br>        loss.backward()<br>        optimizer.step()<br><br>        total_train_step = total_train_step + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> total_train_step % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;è®­ç»ƒæ¬¡æ•°ï¼š&#123;&#125;ï¼Œlossï¼š&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(total_train_step, loss.item()))<br>            writer.add_scalar(<span class="hljs-string">&quot;train_loss&quot;</span>, loss.item(), total_train_step)<br><br>    <span class="hljs-comment"># æµ‹è¯•æ­¥éª¤å¼€å§‹</span><br>    myModel.<span class="hljs-built_in">eval</span>()<br>    total_test_loss = <span class="hljs-number">0</span><br>    total_accuracy = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> test_dataloader:<br>            imgs, targets = data<br>            outputs = myModel(imgs)<br>            loss = loss_fn(outputs, targets)<br>            total_test_loss = total_test_loss + loss.item()<br>            accuracy = (outputs.argmax(<span class="hljs-number">1</span>) == targets).<span class="hljs-built_in">sum</span>()<br>            total_accuracy = total_accuracy + accuracy<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ•´ä½“æµ‹è¯•é›†ä¸Šçš„Lossï¼š&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(total_test_loss))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ•´ä½“æµ‹è¯•é›†ä¸Šçš„æ­£ç¡®ç‡ï¼š&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(total_accuracy/test_data_length))<br>    writer.add_scalar(<span class="hljs-string">&quot;test_loss&quot;</span>, total_test_loss, total_test_step)<br>    writer.add_scalar(<span class="hljs-string">&quot;test_accuracy&quot;</span>, total_accuracy/test_data_length, total_test_step)<br>    total_test_step = total_test_step + <span class="hljs-number">1</span><br><br>    <span class="hljs-comment"># ä¿å­˜æ¯è½®çš„æ•°æ®</span><br>    torch.save(myModel, <span class="hljs-string">&quot;myModel_&#123;&#125;.pth&quot;</span>.<span class="hljs-built_in">format</span>(i))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;æ¨¡å‹å·²ä¿å­˜&quot;</span>)<br><br>writer.close()<br></code></pre></div></td></tr></table></figure><h2 id="ä½¿ç”¨gpuè®­ç»ƒ">15ã€ä½¿ç”¨GPUè®­ç»ƒ</h2><h3 id="æ–¹æ³•ä¸€">æ–¹æ³•ä¸€</h3><p>æˆ‘ä»¬éœ€è¦å¯¹ç½‘ç»œæ¨¡å‹ã€æ•°æ®ã€æŸå¤±å‡½æ•°è¿›è¡Œä¿®æ”¹</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># æ„å»ºæ¨¡å‹</span><br>myModel = MyModel()<br><span class="hljs-keyword">if</span> torch.cuda.is_available():<br>    myModel = myModel.cuda()<br>    <br><span class="hljs-comment"># æŸå¤±å‡½æ•°</span><br>loss_fn = nn.CrossEntropyLoss()<br><span class="hljs-keyword">if</span> torch.cuda.is_available():<br>    loss_fn = loss_fn.cuda()<br>    <br>imgs, targets = data<br><span class="hljs-keyword">if</span> torch.cuda.is_available():<br>imgs = imgs.cuda()<br>targets = targets.cuda()<br></code></pre></div></td></tr></table></figure><h3 id="æ–¹æ³•äºŒ">æ–¹æ³•äºŒ</h3><p>éœ€è¦åœ¨æ–‡ä»¶æœ€å¼€å§‹å®šä¹‰è®­ç»ƒçš„è®¾å¤‡</p><p>æ­¤æ—¶ä¸ºå°†è®¾å¤‡è®¾ç½®ä¸ºcpu</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># å®šä¹‰è®­ç»ƒçš„è®¾å¤‡</span><br>device = torch.device(<span class="hljs-string">&quot;cpu&quot;</span>)<br><br><span class="hljs-comment"># æ„å»ºæ¨¡å‹</span><br>myModel = MyModel()<br>myModel.to(device)<span class="hljs-comment"># æ¨¡å‹å’ŒæŸå¤±å‡½æ•°ä¸ç”¨é‡æ–°èµ‹å€¼</span><br><br><span class="hljs-comment"># æŸå¤±å‡½æ•°</span><br>loss_fn = nn.CrossEntropyLoss()<br>loss_fn.to(device)<br><br>imgs, targets = data<br>imgs = imgs.to(device)<span class="hljs-comment"># æ•°æ®éœ€è¦é‡æ–°èµ‹å€¼</span><br>targets = targets.to(device)<br></code></pre></div></td></tr></table></figure><p>å¦‚æœè¦ä½¿ç”¨gpuéœ€è¦å¦‚ä¸‹è®¾ç½®ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># å®šä¹‰è®­ç»ƒçš„è®¾å¤‡</span><br>device = torch.device(<span class="hljs-string">&quot;cuda&quot;</span>)<br></code></pre></div></td></tr></table></figure><p>å¦‚æœæœ‰å¤šä¸ªgpuï¼Œå¯ä»¥æŒ‰ç…§å¦‚ä¸‹é€‰æ‹©è®¾ç½®ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># å®šä¹‰è®­ç»ƒçš„è®¾å¤‡</span><br>device = torch.device(<span class="hljs-string">&quot;cudaï¼š0&quot;</span>)<br></code></pre></div></td></tr></table></figure><h2 id="æ¨¡å‹éªŒè¯å¥—è·¯">16ã€æ¨¡å‹éªŒè¯å¥—è·¯</h2><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">image_path = <span class="hljs-string">&quot;./img/dog.png&quot;</span><br><br>image = Image.<span class="hljs-built_in">open</span>(image_path)<br>image = image.convert(<span class="hljs-string">&#x27;RGB&#x27;</span>)<br><br>transform = torchvision.transforms.Compose([torchvision.transforms.Resize((<span class="hljs-number">32</span>, <span class="hljs-number">32</span>)),<br>                                            torchvision.transforms.ToTensor()])<br><br>image = transform(image)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModel</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(MyModel, self).__init__()<br>        self.model = nn.Sequential(<br>            nn.Conv2d(<span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>),<br>            nn.MaxPool2d(<span class="hljs-number">2</span>),<br>            nn.Conv2d(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>),<br>            nn.MaxPool2d(<span class="hljs-number">2</span>),<br>            nn.Conv2d(<span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>),<br>            nn.MaxPool2d(<span class="hljs-number">2</span>),<br>            nn.Flatten(),<br>            nn.Linear(<span class="hljs-number">64</span> * <span class="hljs-number">4</span> * <span class="hljs-number">4</span>, <span class="hljs-number">64</span>),<br>            nn.Linear(<span class="hljs-number">64</span>, <span class="hljs-number">10</span>)<br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        x = self.model(x)<br>        <span class="hljs-keyword">return</span> x<br><br><br>myModel = torch.load(<span class="hljs-string">&quot;myModel_0.pth&quot;</span>)<br><span class="hljs-built_in">print</span>(myModel)<br>image = torch.reshape(image, (<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>))<br>myModel.<span class="hljs-built_in">eval</span>()<br><span class="hljs-keyword">with</span> torch.no_grad():<br>    output = myModel(image)<br><span class="hljs-built_in">print</span>(output)<br><span class="hljs-built_in">print</span>(output.argmax(<span class="hljs-number">1</span>))<br></code></pre></div></td></tr></table></figure><p>è¾“å‡ºä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">tensor([[ 0.3308,  0.0307,  0.9064,  0.9474,  0.2715,  0.8123, -0.4077,  0.2044,<br>         -0.4149, -1.0106]])<br>tensor([3])<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€åé¢„æµ‹æˆ‘ä»¬çš„å›¾ç‰‡å±äºç¬¬ä¸‰ç±»</p><h2 id="lstm">17ã€LSTM</h2><p><strong>è¾“å…¥çš„å‚æ•°åˆ—è¡¨åŒ…æ‹¬:</strong></p><ul><li>input_sizeè¾“å…¥æ•°æ®çš„ç‰¹å¾ç»´æ•°ï¼Œé€šå¸¸å°±æ˜¯embedding_dim(è¯å‘é‡çš„ç»´åº¦)</li><li>hidden_sizeã€€LSTMä¸­éšå±‚çš„ç»´åº¦</li><li>num_layersã€€å¾ªç¯ç¥ç»ç½‘ç»œçš„å±‚æ•°</li><li>biasã€€ç”¨ä¸ç”¨åç½®ï¼Œdefault=True</li><li>batch_firstè¿™ä¸ªè¦æ³¨æ„ï¼Œé€šå¸¸æˆ‘ä»¬è¾“å…¥çš„æ•°æ®shape=(batch_size,seq_length,embedding_dim),è€Œbatch_firsté»˜è®¤æ˜¯False,æ‰€ä»¥æˆ‘ä»¬çš„è¾“å…¥æ•°æ®æœ€å¥½é€è¿›LSTMä¹‹å‰å°†batch_sizeä¸seq_lengthè¿™ä¸¤ä¸ªç»´åº¦è°ƒæ¢</li><li>dropoutã€€é»˜è®¤æ˜¯0ï¼Œä»£è¡¨ä¸ç”¨dropout</li><li>bidirectionalé»˜è®¤æ˜¯falseï¼Œä»£è¡¨ä¸ç”¨åŒå‘LSTM</li></ul><p><strong>è¾“å…¥æ•°æ®åŒ…æ‹¬input,(h_0,c_0):</strong></p><ul><li>inputå°±æ˜¯shape=(seq_length,batch_size,input_size)çš„å¼ é‡</li><li>h_0æ˜¯shape=(num_layers*num_directions,batch_size,hidden_size)çš„å¼ é‡ï¼Œå®ƒåŒ…å«äº†åœ¨å½“å‰è¿™ä¸ªbatch_sizeä¸­æ¯ä¸ªå¥å­çš„åˆå§‹éšè—çŠ¶æ€ã€‚å…¶ä¸­num_layerså°±æ˜¯LSTMçš„å±‚æ•°ã€‚å¦‚æœbidirectional=True,num_directions=2,å¦åˆ™å°±æ˜¯ï¼‘ï¼Œè¡¨ç¤ºåªæœ‰ä¸€ä¸ªæ–¹å‘ã€‚</li><li>c_0å’Œh_0çš„å½¢çŠ¶ç›¸åŒï¼Œå®ƒåŒ…å«çš„æ˜¯åœ¨å½“å‰è¿™ä¸ªbatch_sizeä¸­çš„æ¯ä¸ªå¥å­çš„åˆå§‹ç»†èƒçŠ¶æ€ã€‚h_0,c_0å¦‚æœä¸æä¾›ï¼Œé‚£ä¹ˆé»˜è®¤æ˜¯ï¼ã€‚</li></ul><p><strong>è¾“å‡ºæ•°æ®åŒ…æ‹¬output,(h_n,c_n):</strong></p><ul><li>outputçš„shape=(seq_length,batch_size,num_directions*hidden_size),å®ƒåŒ…å«çš„æ˜¯LSTMçš„æœ€åä¸€æ—¶é—´æ­¥çš„è¾“å‡ºç‰¹å¾(h_t),ï½”æ˜¯batch_sizeä¸­æ¯ä¸ªå¥å­çš„é•¿åº¦ã€‚</li><li>h_n.shape==(num_directions * num_layers,batch,hidden_size)</li><li>h_nåŒ…å«çš„æ˜¯å¥å­çš„æœ€åä¸€ä¸ªå•è¯ï¼ˆä¹Ÿå°±æ˜¯æœ€åä¸€ä¸ªæ—¶é—´æ­¥ï¼‰çš„éšè—çŠ¶æ€ï¼Œc_nåŒ…å«çš„æ˜¯å¥å­çš„æœ€åä¸€ä¸ªå•è¯çš„ç»†èƒçŠ¶æ€ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½ä¸å¥å­çš„é•¿åº¦seq_lengthæ— å…³ã€‚</li><li>output[-1]ä¸h_næ˜¯ç›¸ç­‰çš„ï¼Œå› ä¸ºoutput[-1]åŒ…å«çš„æ­£æ˜¯batch_sizeä¸ªå¥å­ä¸­æ¯ä¸€ä¸ªå¥å­çš„æœ€åä¸€ä¸ªå•è¯çš„éšè—çŠ¶æ€ï¼Œæ³¨æ„LSTMä¸­çš„éšè—çŠ¶æ€å…¶å®å°±æ˜¯è¾“å‡ºï¼Œcellstateç»†èƒçŠ¶æ€æ‰æ˜¯LSTMä¸­ä¸€ç›´éšè—çš„ï¼Œè®°å½•ç€ä¿¡æ¯ã€‚</li></ul><h2 id="lstmcell">18ã€LSTMcell</h2><p>ä¸Šè¿°çš„nn.LSTMæ¨¡å—ä¸€æ¬¡æ„é€ å®Œè‹¥å¹²å±‚çš„LSTM,ä½†æ˜¯ä¸ºäº†å¯¹æ¨¡å‹æœ‰æ›´åŠ çµæ´»çš„å¤„nnä¸­è¿˜æœ‰ä¸€ä¸ªLSTMCellæ¨¡å—ï¼Œæ˜¯ç»„æˆLSTMæ•´ä¸ªåºåˆ—è®¡ç®—è¿‡ç¨‹çš„åŸºæœ¬ç»„æˆå•å…ƒï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œsequenceä¸­ä¸€ä¸ªwordçš„è®¡ç®—ã€‚</p><p>åŒæ—¶å®ƒçš„å‚æ•°ä¹Ÿå°±åªæœ‰3ä¸ªï¼šè¾“å…¥ç»´åº¦ï¼ŒéšèŠ‚ç‚¹æ•°æ®ç»´åº¦ï¼Œæ˜¯å¦å¸¦æœ‰åç½®ã€‚ä»…æä¾›æœ€åŸºæœ¬ä¸€ä¸ªLSTMå•å…ƒç»“æ„ï¼Œæƒ³è¦å®Œæ•´çš„è¿›è¡Œä¸€ä¸ªåºåˆ—çš„è®­ç»ƒçš„è¦è¿˜è¦è‡ªå·±ç¼–å†™ä¼ æ’­å‡½æ•°æŠŠcellé—´çš„è¾“å…¥è¾“å‡ºè¿æ¥èµ·æ¥ã€‚ä½†æ˜¯æƒ³è¦è‡ªå®šä¹‰ä¸åŒcelléšèŠ‚ç‚¹ç»´åº¦çš„å¤šå±‚LSTMçš„è¯ï¼Œè¿™ä¸ªæ¨¡å—è¿˜æ˜¯æŒºæœ‰ç”¨çš„ã€‚</p><h2 id="pad_sequence">19ã€pad_sequence</h2><p><strong>sequences</strong>ï¼šè¡¨ç¤ºè¾“å…¥æ ·æœ¬åºåˆ—ï¼Œä¸º list ç±»å‹ï¼Œlistä¸­çš„å…ƒç´ ä¸º tensor ç±»å‹ã€‚ tensor çš„ size ä¸º L * F ã€‚å…¶ä¸­ï¼ŒLä¸ºå•ä¸ªåºåˆ—çš„é•¿åº¦ï¼ŒF ä¸ºåºåˆ—ä¸­æ¯ä¸ªæ—¶é—´æ­¥ï¼ˆtimestepï¼‰ç‰¹å¾çš„ä¸ªæ•°ï¼Œæ ¹æ®ä»»åŠ¡çš„ä¸åŒ F çš„ç»´åº¦ä¼šæœ‰æ‰€ä¸åŒã€‚</p><p><strong>batch_first</strong>ï¼šä¸º True å¯¹åº” [batch_size, seq_len,feature]ï¼›False å¯¹åº”[seq_len, batch_size,feature]ï¼Œä»ä¹ æƒ¯ä¸Šæ¥è®²ä¸€èˆ¬è®¾ç½®ä¸º True æ¯”è¾ƒç¬¦åˆæˆ‘ä»¬çš„è®¤çŸ¥ã€‚</p><p><strong>padding_value</strong>ï¼šå¡«å……å€¼ï¼Œé»˜è®¤å€¼ä¸º 0 ã€‚</p><p><strong>è¯´æ˜</strong></p><p>ä¸»è¦ç”¨æ¥å¯¹æ ·æœ¬è¿›è¡Œå¡«å……ï¼Œå¡«å……å€¼ä¸€èˆ¬ä¸º 0ã€‚æˆ‘ä»¬åœ¨è®­ç»ƒç½‘ç»œæ—¶ï¼Œä¸€èˆ¬ä¼šé‡‡ç”¨ä¸€ä¸ªä¸€ä¸ª mini-batchçš„æ–¹å¼ï¼Œå°†è®­ç»ƒæ ·æœ¬æ•°æ®å–‚ç»™ç½‘ç»œã€‚åœ¨ PyTorch é‡Œé¢æ•°æ®éƒ½æ˜¯ä»¥ tensorçš„å½¢å¼å­˜åœ¨ï¼Œä¸€ä¸ª mini-batch å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªé«˜ç»´çš„ tensorï¼Œæ¯ä¸ªåºåˆ—æ•°æ®çš„é•¿åº¦å¿…é¡»ç›¸åŒæ‰èƒ½ç»„æˆä¸€ä¸ª tensor ã€‚ä¸ºäº†ä½¿ç½‘ç»œå¯ä»¥å¤„ç†mini-batch å½¢å¼çš„æ•°æ®ï¼Œå°±å¿…é¡»å¯¹åºåˆ—æ ·æœ¬è¿›è¡Œå¡«å……ï¼Œä¿è¯ä¸€ä¸ª mini-batché‡Œé¢çš„æ•°æ®é•¿åº¦æ˜¯ç›¸åŒçš„ã€‚</p><p>åœ¨ PyTorch é‡Œé¢ä¸€èˆ¬æ˜¯ä½¿ç”¨ DataLoader è¿›è¡Œæ•°æ®åŠ è½½ï¼Œè¿”å› mini-batchå½¢å¼çš„æ•°æ®ï¼Œå†å°†æ­¤æ•°æ®å–‚ç»™ç½‘ç»œè¿›è¡Œè®­ç»ƒã€‚æˆ‘ä»¬ä¸€èˆ¬ä¼šè‡ªå®šä¹‰ä¸€ä¸ª collate_fnå‡½æ•°ï¼Œå®Œæˆå¯¹æ•°æ®çš„å¡«å……ã€‚</p><p><strong>ç¤ºä¾‹</strong></p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> Dataset, DataLoader<br><span class="hljs-keyword">from</span> torch.nn.utils.rnn <span class="hljs-keyword">import</span> pad_sequence,pack_padded_sequence,pack_sequence,pad_packed_sequence<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyData</span>(<span class="hljs-title class_ inherited__">Dataset</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, data</span>):<br>        self.data = data<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.data)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):<br>        <span class="hljs-keyword">return</span> self.data[idx]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">collate_fn</span>(<span class="hljs-params">data</span>):<br>    data.sort(key=<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">len</span>(x), reverse=<span class="hljs-literal">True</span>)<br>    data = pad_sequence(data, batch_first=<span class="hljs-literal">True</span>, padding_value=<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> data<br><br>a = torch.tensor([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>])<br>b = torch.tensor([<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>])<br>c = torch.tensor([<span class="hljs-number">7</span>,<span class="hljs-number">8</span>])<br>d = torch.tensor([<span class="hljs-number">9</span>])<br>train_x = [a, b, c, d]<br><br>data = MyData(train_x)<br>data_loader = DataLoader(data, batch_size=<span class="hljs-number">2</span>, shuffle=<span class="hljs-literal">True</span>, collate_fn=collate_fn)<br><span class="hljs-comment"># é‡‡ç”¨é»˜è®¤çš„ collate_fn ä¼šæŠ¥é”™</span><br><span class="hljs-comment">#data_loader = DataLoader(data, batch_size=2, shuffle=True) </span><br>batch_x = <span class="hljs-built_in">iter</span>(data_loader).<span class="hljs-built_in">next</span>()<br></code></pre></div></td></tr></table></figure><p>è¿è¡Œç¨‹åºï¼Œå¾—åˆ° batch_x çš„å€¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># batch_x</span><br>tensor([[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>        [<span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]])<br></code></pre></div></td></tr></table></figure><p>ä» batch_x çš„å€¼å¯ä»¥çœ‹å‡ºï¼Œç¬¬äºŒè¡Œå¡«å……äº†ä¸‰ä¸ª 0ï¼Œä½¿å…¶é•¿åº¦å’Œç¬¬ä¸€è¡Œä¿æŒä¸€è‡´ã€‚</p><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå¯¹äºé•¿åº¦ä¸åŒçš„åºåˆ—ï¼Œä½¿ç”¨é»˜è®¤çš„ collate_fnå‡½æ•°ï¼Œä¸è‡ªå®šä¹‰ collate_fn å‡½æ•°å®Œæˆå¯¹åºåˆ—çš„å¡«å……ï¼Œä¸Šé¢çš„ç¨‹åºå°±ä¼šæŠ¥é”™ã€‚</p><h2 id="pack_padded_sequence">20ã€pack_padded_sequence</h2><p><strong>å‚æ•°</strong></p><p><strong>input</strong>ï¼šç»è¿‡ pad_sequence å¤„ç†ä¹‹åçš„æ•°æ®ã€‚</p><p><strong>lengths</strong>ï¼šmini-batchä¸­å„ä¸ªåºåˆ—çš„å®é™…é•¿åº¦ã€‚</p><p><strong>batch_first</strong>ï¼šTrue å¯¹åº” [batch_size, seq_len,feature] ï¼›</p><p>False å¯¹åº” [seq_len, batch_size, feature] ã€‚</p><p><strong>enforce_sorted</strong>ï¼šå¦‚æœæ˜¯ Trueï¼Œåˆ™è¾“å…¥åº”è¯¥æ˜¯æŒ‰é•¿åº¦é™åºæ’åºçš„åºåˆ—ã€‚å¦‚æœæ˜¯ Falseï¼Œä¼šåœ¨å‡½æ•°å†…éƒ¨è¿›è¡Œæ’åºã€‚é»˜è®¤å€¼ä¸º True ã€‚</p><p><strong>è¯´æ˜</strong></p><p>è¿™ä¸ª pack çš„æ„æ€å¯ä»¥ç†è§£ä¸ºå‹ç´§æˆ–å‹ç¼©ï¼Œå› ä¸ºæ•°æ®åœ¨ç»è¿‡å¡«å……ä¹‹åï¼Œä¼šæœ‰å¾ˆå¤šå†—ä½™çš„padding_valueï¼Œæ‰€ä»¥éœ€è¦å‹ç¼©ä¸€ä¸‹ã€‚</p><p>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¿™ä¸ªå‡½æ•°å‘¢ï¼Ÿ</p><p>RNN è¯»å–æ•°æ®çš„æ–¹å¼ï¼šç½‘ç»œæ¯æ¬¡åƒè¿›å»ä¸€ç»„åŒæ ·æ—¶é—´æ­¥ ï¼ˆtime stepï¼‰çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ mini-batch çš„æ‰€æœ‰æ ·æœ¬ä¸­ä¸‹æ ‡ç›¸åŒçš„æ•°æ®ï¼Œç„¶åè·å¾—ä¸€ä¸ªmini-batch çš„è¾“å‡ºï¼›å†ç§»åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´æ­¥ ï¼ˆtime stepï¼‰ï¼Œå†è¯»å…¥ mini-batchä¸­æ‰€æœ‰è¯¥æ—¶é—´æ­¥çš„æ•°æ®ï¼Œå†è¾“å‡ºï¼›ç›´åˆ°å¤„ç†å®Œæ‰€æœ‰çš„æ—¶é—´æ­¥æ•°æ®ã€‚</p><p>ç¬¬ä¸€ä¸ªæ—¶é—´æ­¥ï¼š</p><p><img src="/img/pytorch/12.png" /></p><p>ç¬¬äºŒä¸ªæ—¶é—´æ­¥ï¼š</p><p><img src="/img/pytorch/13.png" /></p><p>mini-batch ä¸­çš„ 0 åªæ˜¯ç”¨æ¥åšæ•°æ®å¯¹é½çš„ padding_value ï¼Œå¦‚æœè¿›è¡Œforward è®¡ç®—æ—¶ï¼ŒæŠŠ padding_valueä¹Ÿè€ƒè™‘è¿›å»ï¼Œå¯èƒ½ä¼šå¯¼è‡´RNNé€šè¿‡äº†éå¸¸å¤šæ— ç”¨çš„padding_valueï¼Œè¿™æ ·ä¸ä»…æµªè´¹è®¡ç®—èµ„æºï¼Œæœ€åå¾—åˆ°çš„å€¼å¯èƒ½è¿˜ä¼šå­˜åœ¨è¯¯å·®ã€‚å¯¹äºä¸Šé¢çš„åºåˆ—2 çš„æ•°æ®ï¼Œé€šè¿‡ RNN ç½‘ç»œï¼š</p><p><img src="/img/pytorch/14.png" /></p><p>å®é™…ä¸Šä»ç¬¬ 2 ä¸ªæ—¶é—´æ­¥å¼€å§‹ä¸€ç›´åˆ°æœ€åçš„è®¡ç®—éƒ½æ˜¯å¤šä½™çš„ï¼Œè¾“å…¥éƒ½æ˜¯æ— æ•ˆçš„padding_value è€Œå·²ã€‚</p><p>ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºï¼Œä¸ºäº†ä½¿ RNN å¯ä»¥é«˜æ•ˆçš„è¯»å–æ•°æ®è¿›è¡Œè®­ç»ƒï¼Œå°±éœ€è¦åœ¨pad ä¹‹åå†ä½¿ç”¨ pack_padded_sequence å¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤æ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»æŠŠè¾“å…¥æ•°æ®æŒ‰ç…§åºåˆ—é•¿åº¦ä»å¤§åˆ°å°æ’åˆ—åæ‰èƒ½é€å…¥pack_padded_sequence ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</p><p><strong>ç¤ºä¾‹</strong></p><p>åªéœ€è¦å°†ä¸Šé¢çš„ä¾‹å­ä¸­çš„ collate_fnå‡½æ•°ç¨ä½œä¿®æ”¹å³å¯ï¼Œå…¶ä½™éƒ¨åˆ†ä¿æŒä¸å˜ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">collate_fn</span>(<span class="hljs-params">data</span>):<br>    data.sort(key=<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">len</span>(x), reverse=<span class="hljs-literal">True</span>)<br>    seq_len = [s.size(<span class="hljs-number">0</span>) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> data] <span class="hljs-comment"># è·å–æ•°æ®çœŸå®çš„é•¿åº¦</span><br>    data = pad_sequence(data, batch_first=<span class="hljs-literal">True</span>)    <br>    data = pack_padded_sequence(data, seq_len, batch_first=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">return</span> data<br></code></pre></div></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># batch_x</span><br>PackedSequence(data=tensor([<span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]), <br>               batch_sizes=tensor([<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]), <br>               sorted_indices=<span class="hljs-literal">None</span>, unsorted_indices=<span class="hljs-literal">None</span>)<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œè¾“å‡ºè¿”å›ä¸€ä¸ª PackedSequence å¯¹è±¡ï¼Œå®ƒä¸»è¦åŒ…å«ä¸¤éƒ¨åˆ†ï¼šdata å’Œbatch_sizes ã€‚</p><p><img src="/img/pytorch/15.png" /></p><p>å¡«å……å€¼ 0 å°±è¢«è·³è¿‡äº†ã€‚batch_sizeä¸­çš„å€¼ï¼Œå®é™…ä¸Šå°±æ˜¯å‘Šè¯‰ç½‘ç»œæ¯ä¸ªæ—¶é—´æ­¥éœ€è¦åƒè¿›å»å¤šå°‘æ•°æ®ã€‚</p><p>å¦‚æœä»”ç»†çœ‹ï¼Œå…¶å®è¾“å‡ºçš„ PackedSequence å¯¹è±¡è¿˜åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†sorted_indices å’Œunsorted_indices ã€‚å‰é¢è¯´åˆ° pack_padded_sequenceè¿˜æœ‰ä¸€ä¸ªå‚æ•° <strong>enforce_sorted</strong> ï¼Œå¦‚æœæ˜¯ Trueï¼Œåˆ™è¾“å…¥åº”è¯¥æ˜¯æŒ‰é•¿åº¦é™åºæ’åºçš„åºåˆ—ã€‚å¦‚æœæ˜¯ Falseï¼Œä¼šåœ¨å‡½æ•°å†…éƒ¨è¿›è¡Œæ’åºã€‚é»˜è®¤å€¼ä¸º True ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨è¾“å…¥pack_padded_sequence å‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸å¯¹æ•°æ®è¿›è¡Œæ’åºã€‚</p><p>ç°åœ¨æˆ‘ä»¬å°† enforce_sorted è®¾ç½®ä¸º Falseï¼Œä¸”è¾“å…¥æ•°æ®ä¸é¢„å…ˆè¿›è¡Œæ’åºã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">data = [torch.tensor([<span class="hljs-number">9</span>]), <br>        torch.tensor([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]),<br>        torch.tensor([<span class="hljs-number">5</span>,<span class="hljs-number">6</span>])]<br><br>seq_len = [s.size(<span class="hljs-number">0</span>) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> data]<br>data = pad_sequence(data, batch_first=<span class="hljs-literal">True</span>)    <br>data = pack_padded_sequence(data, seq_len, batch_first=<span class="hljs-literal">True</span>, enforce_sorted=<span class="hljs-literal">False</span>)<br></code></pre></div></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">PackedSequence(data=tensor([<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">9</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]), <br>               batch_sizes=tensor([<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]), <br>               sorted_indices=tensor([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>]), <br>               unsorted_indices=tensor([<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>]))<br></code></pre></div></td></tr></table></figure><p>sorted_indices = tensor([1, 2, 0]ï¼Œè¡¨ç¤ºæ’åºä¹‹åçš„ç»“æœä¸åŸå§‹ data ä¸­çš„tensor çš„ä¸‹æ ‡å¯¹åº”å…³ç³»ã€‚1 è¡¨ç¤ºåŸå§‹ data ä¸­ ç¬¬ 1è¡Œæœ€é•¿ï¼Œæ’åºä¹‹åæ’åœ¨æœ€å‰é¢ï¼Œå…¶æ¬¡æ˜¯ç¬¬ 2 è¡Œã€ç¬¬ 0 è¡Œã€‚</p><p>å‡è®¾æ’åºä¹‹åçš„ç»“æœä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">sort_data = [torch.tensor([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]),<br>             torch.tensor([<span class="hljs-number">5</span>,<span class="hljs-number">6</span>])<br>             torch.tensor([<span class="hljs-number">9</span>]), <br>             ]<br></code></pre></div></td></tr></table></figure><p>unsorted_indices = tensor([2, 0, 1]ï¼Œè¡¨ç¤ºæœªæ’åºå‰ç»“æœã€‚2 è¡¨ç¤ºsort_data çš„ç¬¬ 2 è¡Œå¯¹åº” data ä¸­ç¬¬ 0 è¡Œï¼›0 è¡¨ç¤º sort_data çš„ç¬¬ 0 è¡Œå¯¹åº”data ä¸­çš„ç¬¬ 1 è¡Œï¼›1 è¡¨ç¤º sort_data çš„ç¬¬ 1 è¡Œå¯¹åº” data ä¸­çš„ç¬¬ 2 è¡Œã€‚</p><h2 id="pack_sequence">21ã€pack_sequence</h2><p><strong>å‚æ•°</strong></p><p><strong>sequences</strong>ï¼šè¾“å…¥æ ·æœ¬åºåˆ—ï¼Œä¸º list ç±»å‹ï¼Œlistä¸­çš„å…ƒç´ ä¸º tensor ï¼›tensor çš„ size ä¸º L * Fï¼Œå…¶ä¸­ï¼ŒL ä¸ºå•ä¸ªåºåˆ—çš„é•¿åº¦ï¼ŒFä¸ºåºåˆ—ä¸­æ¯ä¸ªæ—¶é—´æ­¥ï¼ˆtime stepï¼‰ç‰¹å¾çš„ä¸ªæ•°ï¼Œæ ¹æ®ä»»åŠ¡çš„ä¸åŒ Fçš„ç»´åº¦ä¼šæœ‰æ‰€ä¸åŒã€‚</p><p><strong>enforce_sorted</strong>ï¼šå¦‚æœæ˜¯ Trueï¼Œåˆ™è¾“å…¥åº”è¯¥æ˜¯æŒ‰é•¿åº¦é™åºæ’åºçš„åºåˆ—ã€‚å¦‚æœæ˜¯ Falseï¼Œä¼šåœ¨å‡½æ•°å†…éƒ¨è¿›è¡Œæ’åºã€‚é»˜è®¤å€¼ä¸º True ã€‚</p><p><strong>è¯´æ˜</strong></p><p>æˆ‘ä»¬çœ‹çœ‹ PyTorch ä¸­çš„æºç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">pack_sequence</span>(<span class="hljs-params">sequences, enforce_sorted=<span class="hljs-literal">True</span></span>): <br>lengths = torch.as_tensor([v.size(<span class="hljs-number">0</span>) <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> sequences]) <br><span class="hljs-keyword">return</span> pack_padded_sequence(pad_sequence(sequences),lengths,enforce_sorted=enforce_sorted)<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥çœ‹å‡º pack_sequence å®é™…ä¸Šå°±æ˜¯å¯¹ pad_sequence å’Œpack_padded_sequenceæ“ä½œçš„ä¸€ä¸ªå°è£…ã€‚é€šè¿‡ä¸€ä¸ªå‡½æ•°å®Œæˆäº†ä¸¤æ­¥æ‰èƒ½å®Œæˆçš„å·¥ä½œã€‚</p><p><strong>ç¤ºä¾‹</strong></p><p>å‰é¢çš„ collate_fn å‡½æ•°å¯ä»¥è¿›ä¸€æ­¥ä¿®æ”¹ä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">collate_fn</span>(<span class="hljs-params">data</span>):<br>    data.sort(key=<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">len</span>(x), reverse=<span class="hljs-literal">True</span>)<br>   <br>    data = pack_sequence(data)<br>    <span class="hljs-comment">#seq_len = [s.size(0) for s in data]</span><br>    <span class="hljs-comment">#data = pad_sequence(data, batch_first=True)    </span><br>    <span class="hljs-comment">#data = pack_padded_sequence(data, seq_len, batch_first=True)</span><br>    <span class="hljs-keyword">return</span> data<br></code></pre></div></td></tr></table></figure><p>è¾“å‡ºç»“æœä¸å‰é¢ç›¸åŒï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># batch_x</span><br>PackedSequence(data=tensor([<span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]), <br>               batch_sizes=tensor([<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]), <br>               sorted_indices=<span class="hljs-literal">None</span>, unsorted_indices=<span class="hljs-literal">None</span>)<br></code></pre></div></td></tr></table></figure><h2 id="pad_packed_sequence">22ã€pad_packed_sequence</h2><p><strong>å‚æ•°</strong></p><p><strong>sequences</strong>ï¼šPackedSequence å¯¹è±¡ï¼Œå°†è¦è¢«å¡«å……çš„ batchï¼›</p><p><strong>batch_first</strong>ï¼šä¸€èˆ¬è®¾ç½®ä¸º Trueï¼Œè¿”å›çš„æ•°æ®æ ¼å¼ä¸º[batch_size, seq_len, feature] ï¼›</p><p><strong>padding_value</strong>ï¼šå¡«å……å€¼ï¼›</p><p><strong>total_length</strong>ï¼šå¦‚æœä¸æ˜¯<code>None</code>ï¼Œè¾“å‡ºå°†è¢«å¡«å……åˆ°é•¿åº¦ï¼š<code>total_length</code>ã€‚</p><p><strong>è¯´æ˜</strong></p><p>å¦‚æœåœ¨å–‚ç»™ç½‘ç»œæ•°æ®çš„æ—¶å€™ï¼Œç”¨äº† pack_sequence è¿›è¡Œæ‰“åŒ…ï¼Œpytorch çš„ RNNä¹Ÿä¼šæŠŠè¾“å‡º out æ‰“åŒ…æˆä¸€ä¸ª PackedSequence å¯¹è±¡ã€‚</p><p>è¿™ä¸ªå‡½æ•°å®é™…ä¸Šæ˜¯ pack_padded_sequenceå‡½æ•°çš„é€†å‘æ“ä½œã€‚å°±æ˜¯æŠŠå‹ç´§çš„åºåˆ—å†å¡«å……å›æ¥ã€‚</p><p>ä¸ºå•¥è¦å¡«å……å›æ¥å‘¢ï¼Ÿæˆ‘çš„ç†è§£æ˜¯ï¼Œåœ¨ collate_fn å‡½æ•°é‡Œé¢é€šå¸¸ä¹Ÿä¼šè°ƒç”¨pad_sequence å¯¹ label è¿›è¡Œå¡«å……ï¼ŒRNN çš„è¾“å‡ºç»“æœä¸ºäº†å’Œ labelå¯¹é½ï¼Œéœ€è¦å°†å‹ç´§çš„åºåˆ—å†å¡«å……å›æ¥ï¼Œæ–¹ä¾¿åç»­çš„è®¡ç®—ã€‚</p><p><strong>ç¤ºä¾‹</strong></p><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸‹é¢çš„ç¨‹åºä¸­ï¼Œä¸ºäº†äº§ç”Ÿç¬¦åˆ LSTM è¾“å…¥æ ¼å¼ [batch_size,seq_len, feature] çš„æ•°æ®ï¼Œä½¿ç”¨äº†å‡½æ•° unsqueeze è¿›è¡Œå‡ç»´å¤„ç†ã€‚å…¶ä¸­ï¼Œbatch_size æ˜¯<strong>æ ·æœ¬æ•°</strong>ï¼Œseq_lenæ˜¯<strong>åºåˆ—é•¿åº¦</strong>ï¼Œfeature æ˜¯<strong>ç‰¹å¾æ•°</strong>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyData</span>(<span class="hljs-title class_ inherited__">Dataset</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, data</span>):<br>        self.data = data<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.data)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):<br>        <span class="hljs-keyword">return</span> self.data[idx]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">collate_fn</span>(<span class="hljs-params">data</span>):<br>    data.sort(key=<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">len</span>(x), reverse=<span class="hljs-literal">True</span>)<br>    seq_len = [s.size(<span class="hljs-number">0</span>) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> data]<br>    data = pad_sequence(data, batch_first=<span class="hljs-literal">True</span>).<span class="hljs-built_in">float</span>()    <br>    data = data.unsqueeze(-<span class="hljs-number">1</span>)<br>    data = pack_padded_sequence(data, seq_len, batch_first=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">return</span> data<br><br>a = torch.tensor([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>])<br>b = torch.tensor([<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>])<br>c = torch.tensor([<span class="hljs-number">7</span>,<span class="hljs-number">8</span>])<br>d = torch.tensor([<span class="hljs-number">9</span>])<br>train_x = [a, b, c, d]<br><br>data = MyData(train_x)<br>data_loader = DataLoader(data, batch_size=<span class="hljs-number">2</span>, shuffle=<span class="hljs-literal">True</span>, collate_fn=collate_fn)<br>batch_x = <span class="hljs-built_in">iter</span>(data_loader).<span class="hljs-built_in">next</span>()<br><br>rnn = nn.LSTM(<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, batch_first=<span class="hljs-literal">True</span>)<br>h0 = torch.rand(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>).<span class="hljs-built_in">float</span>()<br>c0 = torch.rand(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>).<span class="hljs-built_in">float</span>()<br>out, (h1, c1) = rnn(batch_x, (h0, c0))<br></code></pre></div></td></tr></table></figure><p>å¾—åˆ° out çš„ç»“æœå¦‚ä¸‹ï¼Œæ˜¯ä¸€ä¸ª PackedSequence ç±»å‹çš„å¯¹è±¡ï¼Œä¸å‰é¢è°ƒç”¨pack_padded_sequence å¾—åˆ°çš„ç»“æœç±»å‹ç›¸åŒã€‚</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># out</span><br>PackedSequence(data=tensor([[-<span class="hljs-number">1.3302e-04</span>,  <span class="hljs-number">5.7754e-02</span>,  <span class="hljs-number">4.3181e-02</span>,  <span class="hljs-number">6.4226e-02</span>],<br>        [-<span class="hljs-number">2.8673e-02</span>,  <span class="hljs-number">3.9089e-02</span>, -<span class="hljs-number">2.6875e-03</span>,  <span class="hljs-number">4.2686e-03</span>],<br>        [-<span class="hljs-number">1.0216e-01</span>,  <span class="hljs-number">2.5236e-02</span>, -<span class="hljs-number">1.2230e-01</span>,  <span class="hljs-number">5.1524e-02</span>],<br>        [-<span class="hljs-number">1.6211e-01</span>,  <span class="hljs-number">2.1079e-02</span>, -<span class="hljs-number">1.5849e-01</span>,  <span class="hljs-number">5.2800e-02</span>],<br>        [-<span class="hljs-number">1.5774e-01</span>,  <span class="hljs-number">2.6749e-02</span>, -<span class="hljs-number">1.3333e-01</span>,  <span class="hljs-number">4.7894e-02</span>]],<br>       grad_fn=&lt;CatBackward&gt;), <br>       batch_sizes=tensor([<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]), <br>       sorted_indices=<span class="hljs-literal">None</span>, unsorted_indices=<span class="hljs-literal">None</span>)<br></code></pre></div></td></tr></table></figure><p>å¯¹ out è°ƒç”¨ pad_packed_sequence è¿›è¡Œå¡«å……ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">out_pad, out_len = pad_packed_sequence(out, batch_first=<span class="hljs-literal">True</span>)<br></code></pre></div></td></tr></table></figure><p>out_pad å’Œ out_len çš„ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># out_pad </span><br>tensor([[[-<span class="hljs-number">1.3302e-04</span>,  <span class="hljs-number">5.7754e-02</span>,  <span class="hljs-number">4.3181e-02</span>,  <span class="hljs-number">6.4226e-02</span>],<br>         [-<span class="hljs-number">1.0216e-01</span>,  <span class="hljs-number">2.5236e-02</span>, -<span class="hljs-number">1.2230e-01</span>,  <span class="hljs-number">5.1524e-02</span>],<br>         [-<span class="hljs-number">1.6211e-01</span>,  <span class="hljs-number">2.1079e-02</span>, -<span class="hljs-number">1.5849e-01</span>,  <span class="hljs-number">5.2800e-02</span>],<br>         [-<span class="hljs-number">1.5774e-01</span>,  <span class="hljs-number">2.6749e-02</span>, -<span class="hljs-number">1.3333e-01</span>,  <span class="hljs-number">4.7894e-02</span>]],<br><br>        [[-<span class="hljs-number">2.8673e-02</span>,  <span class="hljs-number">3.9089e-02</span>, -<span class="hljs-number">2.6875e-03</span>,  <span class="hljs-number">4.2686e-03</span>],<br>         [ <span class="hljs-number">0.0000e+00</span>,  <span class="hljs-number">0.0000e+00</span>,  <span class="hljs-number">0.0000e+00</span>,  <span class="hljs-number">0.0000e+00</span>],<br>         [ <span class="hljs-number">0.0000e+00</span>,  <span class="hljs-number">0.0000e+00</span>,  <span class="hljs-number">0.0000e+00</span>,  <span class="hljs-number">0.0000e+00</span>],<br>         [ <span class="hljs-number">0.0000e+00</span>,  <span class="hljs-number">0.0000e+00</span>,  <span class="hljs-number">0.0000e+00</span>,  <span class="hljs-number">0.0000e+00</span>]]],<br>       grad_fn=&lt;TransposeBackward0&gt;)<br><br><span class="hljs-comment"># out_len</span><br>tensor([<span class="hljs-number">4</span>, <span class="hljs-number">1</span>])<br></code></pre></div></td></tr></table></figure><p>å†å›æƒ³ä¸‹æˆ‘ä»¬è°ƒç”¨ pad_sequence å¡«å……ä¹‹åçš„è¾“å…¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># batch_x</span><br>tensor([[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>        [<span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]])<br></code></pre></div></td></tr></table></figure><p>è¿™ä¸ª out_pad ç»“æœå…¶å®å°±å’Œæˆ‘ä»¬å¡«å……ä¹‹åçš„è¾“å…¥å¯¹åº”èµ·æ¥äº†ã€‚</p><h2 id="cat">22ã€cat</h2><p>å‡ºäº†ä¸¤ä¸ªå¼ é‡Aå’ŒBï¼Œåˆ†åˆ«æ˜¯2è¡Œ3åˆ—ï¼Œ4è¡Œ3åˆ—ã€‚å³ä»–ä»¬éƒ½æ˜¯2ç»´å¼ é‡ã€‚å› ä¸ºåªæœ‰ä¸¤ç»´ï¼Œè¿™æ ·åœ¨ç”¨torch.catæ‹¼æ¥çš„æ—¶å€™å°±æœ‰ä¸¤ç§æ‹¼æ¥æ–¹å¼ï¼šæŒ‰è¡Œæ‹¼æ¥å’ŒæŒ‰åˆ—æ‹¼æ¥ã€‚å³æ‰€è°“çš„ç»´æ•°0å’Œç»´æ•°1.</p><p>C=torch.cat((A,B),0)å°±è¡¨ç¤ºæŒ‰ç»´æ•°0ï¼ˆè¡Œï¼‰æ‹¼æ¥Aå’ŒBï¼Œä¹Ÿå°±æ˜¯ç«–ç€æ‹¼æ¥ï¼ŒAä¸ŠBä¸‹ã€‚æ­¤æ—¶éœ€è¦æ³¨æ„ï¼šåˆ—æ•°å¿…é¡»ä¸€è‡´ï¼Œå³ç»´æ•°1æ•°å€¼è¦ç›¸åŒï¼Œè¿™é‡Œéƒ½æ˜¯3åˆ—ï¼Œæ–¹èƒ½åˆ—å¯¹é½ã€‚æ‹¼æ¥åçš„Cçš„ç¬¬0ç»´æ˜¯ä¸¤ä¸ªç»´æ•°0æ•°å€¼å’Œï¼Œå³2+4=6</p><p>C=torch.cat((A,B),1)å°±è¡¨ç¤ºæŒ‰ç»´æ•°1ï¼ˆåˆ—ï¼‰æ‹¼æ¥Aå’ŒBï¼Œä¹Ÿå°±æ˜¯æ¨ªç€æ‹¼æ¥ï¼ŒAå·¦Bå³ã€‚æ­¤æ—¶éœ€è¦æ³¨æ„ï¼šè¡Œæ•°å¿…é¡»ä¸€è‡´ï¼Œå³ç»´æ•°0æ•°å€¼è¦ç›¸åŒï¼Œè¿™é‡Œéƒ½æ˜¯2è¡Œï¼Œæ–¹èƒ½è¡Œå¯¹é½ã€‚æ‹¼æ¥åçš„Cçš„ç¬¬1ç»´æ˜¯ä¸¤ä¸ªç»´æ•°1æ•°å€¼å’Œï¼Œå³3+4=7</p><h2 id="torch.split">23ã€torch.split</h2><p><code>torch.split(tensor, split_size_or_sections, dim=0)</code></p><p>torch.split()ä½œç”¨å°†tensoråˆ†æˆå—ç»“æ„ã€‚</p><p>å‚æ•°ï¼š</p><ul><li>tesnorï¼šinputï¼Œå¾…åˆ†è¾“å…¥</li><li>split_size_or_sectionsï¼šéœ€è¦åˆ‡åˆ†çš„å¤§å°(int or list )</li><li>dimï¼šåˆ‡åˆ†ç»´åº¦</li><li>outputï¼šåˆ‡åˆ†åå—ç»“æ„ &lt;class 'tuple'&gt;</li><li>å½“split_size_or_sectionsä¸º<strong>int</strong>æ—¶ï¼Œtenorç»“æ„å’Œsplit_size_or_sectionsï¼Œæ­£å¥½åŒ¹é…ï¼Œé‚£ä¹ˆouputå°±æ˜¯å¤§å°ç›¸åŒçš„å—ç»“æ„ã€‚å¦‚æœæŒ‰ç…§split_size_or_sectionsç»“æ„ï¼Œtensorä¸å¤Ÿäº†ï¼Œé‚£ä¹ˆå°±æŠŠå‰©ä¸‹çš„é‚£éƒ¨åˆ†åšä¸€ä¸ªå—å¤„ç†ã€‚</li><li>å½“split_size_or_sectionsä¸º<strong>list</strong>æ—¶ï¼Œé‚£ä¹ˆtensorç»“æ„ä¼šä¸€å…±åˆ‡åˆ†æˆlen(list)è¿™ä¹ˆå¤šçš„å°å—ï¼Œæ¯ä¸ªå°å—ä¸­çš„å¤§å°æŒ‰ç…§listä¸­çš„å¤§å°å†³å®šï¼Œå…¶ä¸­listä¸­çš„æ•°å­—æ€»å’Œåº”ç­‰äºè¯¥ç»´åº¦çš„å¤§å°ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼ˆæ³¨æ„è¿™é‡Œä¸split_size_or_sectionsä¸ºintæ—¶çš„æƒ…å†µä¸åŒï¼‰ã€‚</li></ul><h2id="torch.squeezeå’Œtorch.unsqueeze">24ã€torch.squeezeå’Œtorch.unsqueeze</h2><p>â¼€ã€å…ˆçœ‹torch.squeeze()è¿™ä¸ªå‡½æ•°ä¸»è¦å¯¹æ•°æ®çš„ç»´åº¦è¿›â¾å‹ç¼©ï¼Œå»æ‰ç»´æ•°ä¸º1çš„çš„ç»´åº¦ï¼Œâ½å¦‚æ˜¯â¼€â¾æˆ–è€…â¼€åˆ—è¿™ç§ï¼Œâ¼€ä¸ªâ¼€â¾ä¸‰åˆ—ï¼ˆ1,3ï¼‰çš„æ•°å»æ‰ç¬¬â¼€ä¸ªç»´æ•°ä¸ºâ¼€çš„ç»´åº¦ä¹‹åå°±å˜æˆï¼ˆ3ï¼‰â¾ã€‚</p><ul><li>1.squeeze(a)å°±æ˜¯å°†aä¸­æ‰€æœ‰ä¸º1çš„ç»´åº¦åˆ æ‰ã€‚ä¸ä¸º1çš„ç»´åº¦æ²¡æœ‰å½±å“ã€‚</li><li>2.a.squeeze(N) å°±æ˜¯å»æ‰aä¸­æŒ‡å®šçš„ç»´æ•°ä¸ºâ¼€çš„ç»´åº¦ã€‚</li><li>3.è¿˜æœ‰â¼€ç§å½¢å¼å°±æ˜¯b=torch.squeeze(aï¼ŒN)aä¸­å»æ‰æŒ‡å®šçš„ç»´æ•°Nä¸ºâ¼€çš„ç»´åº¦ã€‚</li></ul><p>â¼†ã€å†çœ‹torch.unsqueeze()è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯å¯¹æ•°æ®ç»´åº¦è¿›â¾æ‰©å……ã€‚</p><ul><li>1.ç»™æŒ‡å®šä½ç½®åŠ ä¸Šç»´æ•°ä¸ºâ¼€çš„ç»´åº¦ï¼Œâ½å¦‚åŸæœ¬æœ‰ä¸ªä¸‰â¾çš„æ•°æ®ï¼ˆ3ï¼‰ï¼Œåœ¨0çš„ä½ç½®åŠ äº†â¼€ç»´å°±å˜æˆâ¼€â¾ä¸‰åˆ—ï¼ˆ1,3ï¼‰ã€‚a.unsqueeze(N)å°±æ˜¯åœ¨aä¸­æŒ‡å®šä½ç½®NåŠ ä¸Šâ¼€ä¸ªç»´æ•°ä¸º1çš„ç»´åº¦ã€‚</li><li>2.è¿˜æœ‰â¼€ç§å½¢å¼å°±æ˜¯b=torch.unsqueeze(aï¼ŒN)aå°±æ˜¯åœ¨aä¸­æŒ‡å®šä½ç½®NåŠ ä¸Šâ¼€ä¸ªç»´æ•°ä¸º1çš„ç»´åº¦</li></ul><h2 id="nn.embedding">25ã€nn.Embedding</h2><p><code>torch.nn.Embedding(num_embeddings, embedding_dim, padding_idx=None,max_norm=None,  norm_type=2.0,   scale_grad_by_freq=False, sparse=False,  _weight=None)</code></p><p>å…¶ä¸ºä¸€ä¸ªç®€å•çš„å­˜å‚¨å›ºå®šå¤§å°çš„è¯å…¸çš„åµŒå…¥å‘é‡çš„æŸ¥æ‰¾è¡¨ï¼Œæ„æ€å°±æ˜¯è¯´ï¼Œç»™ä¸€ä¸ªç¼–å·ï¼ŒåµŒå…¥å±‚å°±èƒ½è¿”å›è¿™ä¸ªç¼–å·å¯¹åº”çš„åµŒå…¥å‘é‡ï¼ŒåµŒå…¥å‘é‡åæ˜ äº†å„ä¸ªç¼–å·ä»£è¡¨çš„ç¬¦å·ä¹‹é—´çš„è¯­ä¹‰å…³ç³»ã€‚</p><p>è¾“å…¥ä¸ºä¸€ä¸ªç¼–å·åˆ—è¡¨ï¼Œè¾“å‡ºä¸ºå¯¹åº”çš„ç¬¦å·åµŒå…¥å‘é‡åˆ—è¡¨ã€‚</p><p><strong>å‚æ•°è§£é‡Š</strong></p><ul><li>num_embeddings (python:int) â€“è¯å…¸çš„å¤§å°å°ºå¯¸ï¼Œæ¯”å¦‚æ€»å…±å‡ºç°5000ä¸ªè¯ï¼Œé‚£å°±è¾“å…¥5000ã€‚æ­¤æ—¶indexä¸ºï¼ˆ0-4999ï¼‰</li><li>embedding_dim (python:int) â€“åµŒå…¥å‘é‡çš„ç»´åº¦ï¼Œå³ç”¨å¤šå°‘ç»´æ¥è¡¨ç¤ºä¸€ä¸ªç¬¦å·ã€‚</li><li>padding_idx (python:int, optional) â€“å¡«å……idï¼Œæ¯”å¦‚ï¼Œè¾“å…¥é•¿åº¦ä¸º100ï¼Œä½†æ˜¯æ¯æ¬¡çš„å¥å­é•¿åº¦å¹¶ä¸ä¸€æ ·ï¼Œåé¢å°±éœ€è¦ç”¨ç»Ÿä¸€çš„æ•°å­—å¡«å……ï¼Œè€Œè¿™é‡Œå°±æ˜¯æŒ‡å®šè¿™ä¸ªæ•°å­—ï¼Œè¿™æ ·ï¼Œç½‘ç»œåœ¨é‡åˆ°å¡«å……idæ—¶ï¼Œå°±ä¸ä¼šè®¡ç®—å…¶ä¸å…¶å®ƒç¬¦å·çš„ç›¸å…³æ€§ã€‚<strong>ï¼ˆåˆå§‹åŒ–ä¸º0ï¼‰</strong></li><li>max_norm (python:float, optional) â€“æœ€å¤§èŒƒæ•°ï¼Œå¦‚æœåµŒå…¥å‘é‡çš„èŒƒæ•°è¶…è¿‡äº†è¿™ä¸ªç•Œé™ï¼Œå°±è¦è¿›è¡Œå†å½’ä¸€åŒ–ã€‚</li><li>norm_type (python:float, optional) â€“æŒ‡å®šåˆ©ç”¨ä»€ä¹ˆèŒƒæ•°è®¡ç®—ï¼Œå¹¶ç”¨äºå¯¹æ¯”max_normï¼Œé»˜è®¤ä¸º2èŒƒæ•°ã€‚</li><li>scale_grad_by_freq (boolean, optional) â€“æ ¹æ®å•è¯åœ¨mini-batchä¸­å‡ºç°çš„é¢‘ç‡ï¼Œå¯¹æ¢¯åº¦è¿›è¡Œæ”¾ç¼©ã€‚é»˜è®¤ä¸ºFalse.</li><li>sparse (bool, optional) â€“è‹¥ä¸ºTrue,åˆ™ä¸æƒé‡çŸ©é˜µç›¸å…³çš„æ¢¯åº¦è½¬å˜ä¸ºç¨€ç–å¼ é‡ã€‚</li></ul><h2 id="torch.bmm">26ã€torch.bmm</h2><p>è®¡ç®—ä¸¤ä¸ªtorchçš„çŸ©é˜µä¹˜æ³•</p><p>å‡½æ•°å®šä¹‰ï¼š</p><p><code>def bmm(self: Tensor,mat2: Tensor,*,out: Optional[Tensor] = None) -&gt; Tensor</code></p><p>å‡½æ•°çš„ä¼ å…¥å‚æ•°å¾ˆç®€å•ï¼Œä¸¤ä¸ªä¸‰ç»´<ahref="https://so.csdn.net/so/search?q=çŸ©é˜µ&amp;spm=1001.2101.3001.7020">çŸ©é˜µ</a>è€Œå·²ï¼Œåªæ˜¯è¦æ³¨æ„è¿™ä¸¤ä¸ªçŸ©é˜µçš„shapeæœ‰ä¸€äº›è¦æ±‚ï¼š</p><p><code>res = torch.bmm(ma, mb)</code></p><p><code>ma: [a, b, c]</code></p><p><code>mb: [a, c, d]</code></p>]]></content>
    
    
    <categories>
      
      <category>Deep Learning</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>çº¿æ€§æ¨¡å‹</title>
    <link href="/2022/04/26/%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8B/"/>
    <url>/2022/04/26/%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="çº¿æ€§æ¨¡å‹">çº¿æ€§æ¨¡å‹</h1><h2 id="çº¿æ€§å›å½’">1ã€çº¿æ€§å›å½’</h2><p>å‡å¦‚å’±ä»¬æœ‰ä¸€ä¸ªæ•°æ®é›†ï¼Œé‡Œé¢çš„æ•°æ®æ˜¯ä¿„å‹’å†ˆå·æ³¢ç‰¹å…°å¸‚çš„ <spanclass="math inline">\(47\)</span> å¥—æˆ¿å±‹çš„é¢ç§¯å’Œä»·æ ¼ï¼š</p><table><thead><tr class="header"><th style="text-align: center;">å±…ä½é¢ç§¯ï¼ˆå¹³æ–¹è‹±å°ºï¼‰</th><th style="text-align: center;">ä»·æ ¼ï¼ˆåƒç¾å…ƒï¼‰</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><spanclass="math inline">\(2104\)</span></td><td style="text-align: center;"><spanclass="math inline">\(400\)</span></td></tr><tr class="even"><td style="text-align: center;"><spanclass="math inline">\(1600\)</span></td><td style="text-align: center;"><spanclass="math inline">\(330\)</span></td></tr><tr class="odd"><td style="text-align: center;"><spanclass="math inline">\(2400\)</span></td><td style="text-align: center;"><spanclass="math inline">\(369\)</span></td></tr><tr class="even"><td style="text-align: center;"><spanclass="math inline">\(1416\)</span></td><td style="text-align: center;"><spanclass="math inline">\(232\)</span></td></tr><tr class="odd"><td style="text-align: center;"><spanclass="math inline">\(3000\)</span></td><td style="text-align: center;"><spanclass="math inline">\(540\)</span></td></tr><tr class="even"><td style="text-align: center;">â€¦â€¦</td><td style="text-align: center;">â€¦â€¦</td></tr></tbody></table><p><img src="/img/çº¿æ€§æ¨¡å‹/1.png" /></p><p>å¦‚æœæ¥äº†ä¸€ä¸ªæ–°çš„é¢ç§¯ï¼Œå‡è®¾åœ¨é”€å”®ä»·é’±çš„è®°å½•ä¸­æ²¡æœ‰çš„ï¼Œæˆ‘ä»¬æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸€æ¡æ›²çº¿å»å°½é‡å‡†çš„æ‹Ÿåˆè¿™äº›æ•°æ®ï¼Œç„¶åå¦‚æœæœ‰æ–°çš„è¾“å…¥è¿‡æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ›²çº¿ä¸Šè¿™ä¸ªç‚¹å¯¹åº”çš„å€¼è¿”å›ã€‚è¿™å°±æ˜¯çº¿æ€§å›å½’çš„æ€æƒ³ã€‚</p><p>ä¸ºäº†è®©æˆ‘ä»¬çš„æˆ¿å±‹æ¡ˆä¾‹æ›´æœ‰æ„æ€ï¼Œå’±ä»¬ç¨å¾®å¯¹æ•°æ®é›†è¿›è¡Œä¸€ä¸‹è¡¥å……ï¼Œå¢åŠ ä¸Šæ¯ä¸€ä¸ªæˆ¿å±‹çš„å§å®¤æ•°ç›®ï¼š</p><table><thead><tr class="header"><th style="text-align: center;">å±…ä½é¢ç§¯ï¼ˆå¹³æ–¹è‹±å°ºï¼‰</th><th style="text-align: center;">å§å®¤æ•°ç›®</th><th style="text-align: center;">ä»·æ ¼ï¼ˆåƒç¾å…ƒï¼‰</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><spanclass="math inline">\(2104\)</span></td><td style="text-align: center;"><spanclass="math inline">\(3\)</span></td><td style="text-align: center;"><spanclass="math inline">\(400\)</span></td></tr><tr class="even"><td style="text-align: center;"><spanclass="math inline">\(1600\)</span></td><td style="text-align: center;"><spanclass="math inline">\(3\)</span></td><td style="text-align: center;"><spanclass="math inline">\(330\)</span></td></tr><tr class="odd"><td style="text-align: center;"><spanclass="math inline">\(2400\)</span></td><td style="text-align: center;"><spanclass="math inline">\(3\)</span></td><td style="text-align: center;"><spanclass="math inline">\(369\)</span></td></tr><tr class="even"><td style="text-align: center;"><spanclass="math inline">\(1416\)</span></td><td style="text-align: center;"><spanclass="math inline">\(2\)</span></td><td style="text-align: center;"><spanclass="math inline">\(232\)</span></td></tr><tr class="odd"><td style="text-align: center;"><spanclass="math inline">\(3000\)</span></td><td style="text-align: center;"><spanclass="math inline">\(4\)</span></td><td style="text-align: center;"><spanclass="math inline">\(540\)</span></td></tr><tr class="even"><td style="text-align: center;">â€¦â€¦</td><td style="text-align: center;">â€¦â€¦</td><td style="text-align: center;">â€¦â€¦</td></tr></tbody></table><p>ä¹Ÿæ˜¯åŒæ ·çš„æ–¹æ³•ï¼Œæ­¤æ—¶çš„è‡ªå˜é‡å°±å˜æˆäº†äºŒç»´å‘é‡ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„æœºå™¨å­¦ä¹ çš„è¿‡ç¨‹ï¼Œé¦–å…ˆç»™å‡ºä¸€ä¸ªè¾“å…¥æ•°æ®ï¼Œæˆ‘ä»¬çš„ç®—æ³•ä¼šé€šè¿‡ä¸€ç³»åˆ—çš„è¿‡ç¨‹å¾—åˆ°ä¸€ä¸ªä¼°è®¡çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æœ‰èƒ½åŠ›å¯¹æ²¡æœ‰è§è¿‡çš„æ–°æ•°æ®ç»™å‡ºä¸€ä¸ªæ–°çš„ä¼°è®¡ï¼Œä¹Ÿè¢«ç§°ä¸ºæ„å»ºä¸€ä¸ªæ¨¡å‹ã€‚å°±å¦‚åŒä¸Šé¢çš„çº¿æ€§å›å½’å‡½æ•°ã€‚</p><p><img src="/img/çº¿æ€§æ¨¡å‹/2.png" /></p><p>çº¿æ€§å›å½’å‡è®¾ç‰¹å¾å’Œç»“æœæ»¡è¶³çº¿æ€§å…³ç³»ã€‚å…¶å®çº¿æ€§å…³ç³»çš„è¡¨è¾¾èƒ½åŠ›éå¸¸å¼ºå¤§ï¼Œæ¯ä¸ªç‰¹å¾å¯¹ç»“æœçš„å½±å“å¼ºå¼±å¯ä»¥æœ‰å‰é¢çš„å‚æ•°ä½“ç°ï¼Œè€Œä¸”æ¯ä¸ªç‰¹å¾å˜é‡å¯ä»¥é¦–å…ˆæ˜ å°„åˆ°ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åå†å‚ä¸çº¿æ€§è®¡ç®—ã€‚è¿™æ ·å°±å¯ä»¥è¡¨è¾¾ç‰¹å¾ä¸ç»“æœä¹‹é—´çš„éçº¿æ€§å…³ç³»ã€‚</p><p>æˆ‘ä»¬ç”¨<span class="math inline">\(x_1\)</span>ï¼Œ<spanclass="math inline">\(x_2\)</span>å»æè¿°featureé‡Œé¢çš„åˆ†é‡ï¼Œæ¯”å¦‚ <spanclass="math inline">\(x_1\)</span>=å±…ä½é¢ç§¯ï¼Œ<spanclass="math inline">\(x_2\)</span>=å§å®¤æ•°ç›®ï¼Œæˆ‘ä»¬å¯ä»¥åšå‡ºä¸€ä¸ªä¼°è®¡å‡½æ•°ï¼š<span class="math display">\[h_\theta  (x) = \theta_0 + \theta_1 \times x_1 + \theta_2 \times x_2\]</span> ç®€åŒ–ä¸€ä¸‹å°±ä¸ºï¼š <span class="math display">\[h(x) = \sum^n_{i=0}  \theta_i x_i = \theta^T x\]</span> æˆ‘ä»¬ç¨‹åºä¹Ÿéœ€è¦ä¸€ä¸ªæœºåˆ¶å»è¯„ä¼°æˆ‘ä»¬<spanclass="math inline">\(\theta\)</span>æ˜¯å¦æ¯”è¾ƒå¥½ï¼Œæ‰€ä»¥è¯´éœ€è¦å¯¹æˆ‘ä»¬åšå‡ºçš„<spanclass="math inline">\(h\)</span>å‡½æ•°è¿›è¡Œè¯„ä¼°ï¼Œä¸€èˆ¬è¿™ä¸ªå‡½æ•°ç§°ä¸ºæŸå¤±å‡½æ•°ï¼ˆloss functionï¼‰æˆ–è€…é”™è¯¯å‡½æ•°(errorfunction)ï¼Œæè¿°<span class="math inline">\(h\)</span>å‡½æ•°ä¸å¥½çš„ç¨‹åº¦ï¼Œåœ¨ä¸‹é¢ï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªå‡½æ•°ä¸º<spanclass="math inline">\(J\)</span>å‡½æ•°ï¼š <span class="math display">\[J(\theta) = \frac 12 \sum^m_{i=1}(h_\theta(x^{(i)})-y^{(i)})^2\]</span> å¦‚ä½•è°ƒæ•´<span class="math inline">\(\theta\)</span>ä»¥ä½¿å¾—<spanclass="math inline">\(J(\theta)\)</span>å–å¾—æœ€å°å€¼æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œå…¶ä¸­æœ‰æœ€å°äºŒä¹˜æ³•(leastsquares method)å’Œæ¢¯åº¦ä¸‹é™æ³•ç­‰ã€‚</p><h3 id="æœ€å°äºŒä¹˜æ³•">1.1 æœ€å°äºŒä¹˜æ³•</h3><p>ç»™å®šä¸€ä¸ªè®­ç»ƒé›†ï¼ŒæŠŠ<strong>è®¾è®¡çŸ©é˜µï¼ˆdesign matrixï¼‰</strong> <spanclass="math inline">\(x\)</span> è®¾ç½®ä¸ºä¸€ä¸ª <spanclass="math inline">\(m\times n\)</span>çŸ©é˜µï¼ˆå®é™…ä¸Šï¼Œå¦‚æœè€ƒè™‘åˆ°æˆªè·é¡¹ï¼Œä¹Ÿå°±æ˜¯ <spanclass="math inline">\(\theta_0\)</span> é‚£ä¸€é¡¹ï¼Œå°±åº”è¯¥æ˜¯ <spanclass="math inline">\(m\times (n+1)\)</span>çŸ©é˜µï¼‰ï¼Œè¿™ä¸ªçŸ©é˜µé‡Œé¢åŒ…å«äº†è®­ç»ƒæ ·æœ¬çš„è¾“å…¥å€¼ä½œä¸ºæ¯ä¸€è¡Œï¼š</p><p><span class="math display">\[X =\begin{bmatrix}(x^{(1)}) ^T\\(x^{(2)}) ^T\\\vdots \\(x^{(m)}) ^T\\\end{bmatrix}\]</span></p><p>ç„¶åï¼Œå’±ä»¬è®¾ <span class="math inline">\(\vec{y}\)</span> æ˜¯ä¸€ä¸ª<span class="math inline">\(m\)</span> ç»´å‘é‡ï¼ˆm-dimensionalvectorï¼‰ï¼Œå…¶ä¸­åŒ…å«äº†è®­ç»ƒé›†ä¸­çš„æ‰€æœ‰ç›®æ ‡å€¼ï¼š</p><p><span class="math display">\[Y =\begin{bmatrix}y^{(1)}\\y^{(2)}\\\vdots \\y^{(m)}\\\end{bmatrix}\]</span></p><p>å‡è®¾<span class="math inline">\(h_\theta(x_1,x_2,...,x_m)=\theta_0+\theta_1 \times x_1 + \theta_2 \times x_2 + ... +\theta \timesx_m\)</span>â€‹ çš„çŸ©é˜µè¡¨è¾¾å¼ä¸º <span class="math display">\[h_\theta(x)=X_\theta\]</span> æŸå¤±å‡½æ•°å®šä¹‰ä¸ºï¼š <span class="math display">\[\frac \partial {\partial\theta_j}J(\theta) = \frac12 (X_\theta - Y) ^ T(X_\theta - T)\]</span> è¿™æ—¶å€™æˆ‘ä»¬è¦å¯¹è¿™ä¸ªæŸå¤±å‡½æ•°çš„ <spanclass="math inline">\(\theta\)</span> å‘é‡è¿›è¡Œæ±‚å¯¼å–0ï¼Œç»“æœå¦‚ä¸‹å¼ï¼š<span class="math display">\[\theta = (X^T X)^{-1} X^T Y\]</span></p><h3 id="æ¢¯åº¦ä¸‹é™ç®—æ³•">1.2 æ¢¯åº¦ä¸‹é™ç®—æ³•</h3><p>æˆ‘ä»¬å¸Œæœ›é€‰æ‹©ä¸€ä¸ªèƒ½è®© <span class="math inline">\(J(\theta)\)</span>æœ€å°çš„ <span class="math inline">\(\theta\)</span>å€¼ã€‚æ€ä¹ˆåšå‘¢ï¼Œå’±ä»¬å…ˆç”¨ä¸€ä¸ªæœç´¢çš„ç®—æ³•ï¼Œä»æŸä¸€ä¸ªå¯¹ <spanclass="math inline">\(\theta\)</span> çš„â€œåˆå§‹çŒœæµ‹å€¼â€ï¼Œç„¶åå¯¹ <spanclass="math inline">\(\theta\)</span> å€¼ä¸æ–­è¿›è¡Œè°ƒæ•´ï¼Œæ¥è®© <spanclass="math inline">\(J(\theta)\)</span>é€æ¸å˜å°ï¼Œæœ€å¥½æ˜¯ç›´åˆ°æˆ‘ä»¬èƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªä½¿ <spanclass="math inline">\(J(\theta)\)</span> æœ€å°çš„ <spanclass="math inline">\(\theta\)</span>ã€‚å…·ä½“æ¥è¯´ï¼Œå’±ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨æ¢¯åº¦ä¸‹é™æ³•ï¼ˆgradientdescent algorithmï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯ä»æŸä¸€ä¸ª <spanclass="math inline">\(\theta\)</span>çš„åˆå§‹å€¼å¼€å§‹ï¼Œç„¶åé€æ¸é‡å¤æ›´æ–°ï¼š</p><p><span class="math display">\[\theta_j := \theta_j - \alpha \frac \partial {\partial\theta_j}J(\theta)\]</span></p><p>ï¼ˆä¸Šé¢çš„è¿™ä¸ªæ›´æ–°è¦åŒæ—¶å¯¹åº”ä» <span class="math inline">\(0\)</span>åˆ° <span class="math inline">\(n\)</span> çš„æ‰€æœ‰<spanclass="math inline">\(j\)</span> å€¼è¿›è¡Œã€‚ï¼‰è¿™é‡Œçš„ <spanclass="math inline">\(\alpha\)</span>ä¹Ÿç§°ä¸ºå­¦ä¹ é€Ÿç‡ã€‚è¿™ä¸ªç®—æ³•æ˜¯å¾ˆè‡ªç„¶çš„ï¼Œé€æ­¥é‡å¤æœå‘ <spanclass="math inline">\(J\)</span> é™ä½æœ€å¿«çš„æ–¹å‘ç§»åŠ¨ã€‚</p><p>è¦å®ç°è¿™ä¸ªç®—æ³•ï¼Œå’±ä»¬éœ€è¦è§£å†³ç­‰å·å³è¾¹çš„å¯¼æ•°é¡¹ã€‚é¦–å…ˆæ¥è§£å†³åªæœ‰ä¸€ç»„è®­ç»ƒæ ·æœ¬<span class="math inline">\((x, y)\)</span>çš„æƒ…å†µï¼Œè¿™æ ·å°±å¯ä»¥å¿½ç•¥æ‰ç­‰å·å³è¾¹å¯¹ <spanclass="math inline">\(J\)</span> çš„æ±‚å’Œé¡¹ç›®äº†ã€‚å…¬å¼å°±ç®€åŒ–ä¸‹é¢è¿™æ ·ï¼š</p><p><span class="math display">\[\begin{aligned}\frac \partial {\partial\theta_j}J(\theta) &amp; = \frac \partial{\partial\theta_j} \frac  12(h_\theta(x)-y)^2\\&amp; = 2 \cdot\frac 12(h_\theta(x)-y)\cdot \frac \partial{\partial\theta_j}  (h_\theta(x)-y) \\&amp; = (h_\theta(x)-y)\cdot \frac \partial{\partial\theta_j}(\sum^n_{i=0} \theta_ix_i-y) \\&amp; = (h_\theta(x)-y) x_j\end{aligned}\]</span></p><p>å¯¹å•ä¸ªè®­ç»ƒæ ·æœ¬ï¼Œæ›´æ–°è§„åˆ™å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><span class="math display">\[\theta_j := \theta_j + \alpha (y^{(i)}-h_\theta (x^{(i)}))x_j^{(i)}\]</span></p><p>ç¬¬ä¸€ç§å°±æ˜¯ä¸‹é¢è¿™ä¸ªç®—æ³•ï¼š</p>$<span class="math display">\[\begin{aligned}&amp;\qquad é‡å¤ç›´åˆ°æ”¶æ•› \{ \\&amp;\qquad\qquad\theta_j := \theta_j + \alpha\sum^m_{i=1}(y^{(i)}-h_\theta (x^{(i)}))x_j^{(i)}\quad(å¯¹æ¯ä¸ªj) \\&amp;\qquad\}\end{aligned}\]</span><p>$</p><p>è¯»è€…å¾ˆå®¹æ˜“èƒ½è¯æ˜ï¼Œåœ¨ä¸Šé¢è¿™ä¸ªæ›´æ–°è§„åˆ™ä¸­æ±‚å’Œé¡¹çš„å€¼å°±æ˜¯<spanclass="math inline">\(\frac {\partial J(\theta)}{\partial\theta_j}\)</span> ï¼ˆè¿™æ˜¯å› ä¸ºå¯¹ <span class="math inline">\(J\)</span>çš„åŸå§‹å®šä¹‰ï¼‰ã€‚æ‰€ä»¥è¿™ä¸ªæ›´æ–°è§„åˆ™å®é™…ä¸Šå°±æ˜¯å¯¹åŸå§‹çš„æˆæœ¬å‡½æ•°<spanclass="math inline">\(J\)</span>è¿›è¡Œç®€å•çš„æ¢¯åº¦ä¸‹é™ã€‚è¿™ä¸€æ–¹æ³•åœ¨æ¯ä¸€ä¸ªæ­¥é•¿å†…æ£€æŸ¥æ‰€æœ‰æ•´ä¸ªè®­ç»ƒé›†ä¸­çš„æ‰€æœ‰æ ·æœ¬ï¼Œä¹Ÿå«åš<strong>æ‰¹é‡æ¢¯åº¦ä¸‹é™æ³•ï¼ˆbatchgradientdescent</strong>ï¼‰ã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œå› ä¸ºæ¢¯åº¦ä¸‹é™æ³•å®¹æ˜“è¢«å±€éƒ¨æœ€å°å€¼å½±å“ï¼Œè€Œæˆ‘ä»¬è¦è§£å†³çš„è¿™ä¸ªçº¿æ€§å›å½’çš„ä¼˜åŒ–é—®é¢˜åªèƒ½æœ‰ä¸€ä¸ªå…¨å±€çš„è€Œä¸æ˜¯å±€éƒ¨çš„æœ€ä¼˜è§£ï¼›å› æ­¤ï¼Œæ¢¯åº¦ä¸‹é™æ³•åº”è¯¥æ€»æ˜¯æ”¶æ•›åˆ°å…¨å±€æœ€å°å€¼ï¼ˆå‡è®¾å­¦ä¹ é€Ÿç‡<span class="math inline">\(\alpha\)</span> ä¸è®¾ç½®çš„è¿‡å¤§ï¼‰ã€‚</p><p>å¯¹å’±ä»¬ä¹‹å‰çš„æˆ¿å±‹æ•°æ®é›†è¿›è¡Œæ‰¹é‡æ¢¯åº¦ä¸‹é™æ¥æ‹Ÿåˆ <spanclass="math inline">\(\theta\)</span>ï¼ŒæŠŠæˆ¿å±‹ä»·æ ¼å½“ä½œæˆ¿å±‹é¢ç§¯çš„å‡½æ•°æ¥è¿›è¡Œé¢„æµ‹ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ç»“æœæ˜¯ <spanclass="math inline">\(\theta_0 = 71.27, \theta_1 =0.1345\)</span>ã€‚å¦‚æœæŠŠ <spanclass="math inline">\(h_{\theta}(x)\)</span> ä½œä¸ºä¸€ä¸ªå®šä¹‰åŸŸåœ¨ <spanclass="math inline">\(x\)</span>ä¸Šçš„å‡½æ•°æ¥æŠ•å½±ï¼ŒåŒæ—¶ä¹ŸæŠ•ä¸Šè®­ç»ƒé›†ä¸­çš„å·²æœ‰æ•°æ®ç‚¹ï¼Œä¼šå¾—åˆ°ä¸‹é¢è¿™å¹…å›¾ï¼š</p><p><img src="/img/çº¿æ€§æ¨¡å‹/3.png" /></p><p>å¦‚æœåœ¨æ•°æ®é›†ä¸­æ·»åŠ ä¸Šå§å®¤æ•°ç›®ä½œä¸ºè¾“å…¥ç‰¹å¾ï¼Œé‚£ä¹ˆå¾—åˆ°çš„ç»“æœå°±æ˜¯ <spanclass="math inline">\(\theta_0 = 89.60, \theta_1 = 0.1392, \theta_2 =âˆ’8.738\)</span>â€‹ã€‚è¿™ä¸ªç»“æœå°±æ˜¯ç”¨æ‰¹é‡æ¢¯åº¦ä¸‹é™æ³•æ¥è·å¾—çš„ã€‚</p><p>æ­¤å¤–è¿˜æœ‰å¦å¤–ä¸€ç§æ–¹æ³•èƒ½å¤Ÿæ›¿ä»£æ‰¹é‡æ¢¯åº¦ä¸‹é™æ³•ï¼Œè¿™ç§æ–¹æ³•æ•ˆæœä¹Ÿä¸é”™ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>$<span class="math display">\[\begin{aligned}&amp;\qquadå¾ªç¯ï¼š\{ \\&amp;\qquad\qquad iä»1åˆ°m,\{   \\&amp;\qquad\qquad\qquad\theta_j :=\theta_j  +\alpha(y^{(i)}-h_{\theta}(x^{(i)}))x_j^{(i)} \qquad(å¯¹æ¯ä¸ª j)\\&amp;\qquad\qquad\}  \\&amp;\qquad\}\end{aligned}\]</span><p>$</p><p>åœ¨è¿™ä¸ªç®—æ³•é‡Œï¼Œæˆ‘ä»¬å¯¹æ•´ä¸ªè®­ç»ƒé›†è¿›è¡Œäº†å¾ªç¯éå†ï¼Œæ¯æ¬¡é‡åˆ°ä¸€ä¸ªè®­ç»ƒæ ·æœ¬ï¼Œæ ¹æ®æ¯ä¸ªå•ä¸€è®­ç»ƒæ ·æœ¬çš„è¯¯å·®æ¢¯åº¦æ¥å¯¹å‚æ•°è¿›è¡Œæ›´æ–°ã€‚è¿™ä¸ªç®—æ³•å«åš<strong>éšæœºæ¢¯åº¦ä¸‹é™æ³•ï¼ˆstochasticgradient descentï¼‰</strong>ï¼Œæˆ–è€…å«<strong>å¢é‡æ¢¯åº¦ä¸‹é™æ³•ï¼ˆincrementalgradientdescentï¼‰</strong>ã€‚æ‰¹é‡æ¢¯åº¦ä¸‹é™æ³•è¦åœ¨è¿è¡Œç¬¬ä¸€æ­¥ä¹‹å‰å…ˆå¯¹æ•´ä¸ªè®­ç»ƒé›†è¿›è¡Œæ‰«æéå†ï¼Œå½“è®­ç»ƒé›†çš„è§„æ¨¡<span class="math inline">\(m\)</span>å˜å¾—å¾ˆå¤§çš„æ—¶å€™ï¼Œå¼•èµ·çš„æ€§èƒ½å¼€é”€å°±å¾ˆä¸åˆ’ç®—äº†ï¼›éšæœºæ¢¯åº¦ä¸‹é™æ³•å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œè€Œæ˜¯å¯ä»¥ç«‹å³å¼€å§‹ï¼Œå¯¹æŸ¥è¯¢åˆ°çš„æ¯ä¸ªæ ·æœ¬éƒ½è¿›è¡Œè¿ç®—ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œéšæœºæ¢¯åº¦ä¸‹é™æ³•æŸ¥æ‰¾åˆ°è¶³å¤Ÿæ¥è¿‘æœ€ä½å€¼çš„<span class="math inline">\(\theta\)</span>çš„é€Ÿåº¦è¦æ¯”æ‰¹é‡æ¢¯åº¦ä¸‹é™æ³•æ›´å¿«ä¸€äº›ã€‚ï¼ˆä¹Ÿè¦æ³¨æ„ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šä¸€ç›´æ— æ³•æ”¶æ•›ï¼ˆconvergeï¼‰åˆ°æœ€å°å€¼ï¼Œè¿™æ—¶å€™<span class="math inline">\(\theta\)</span> ä¼šä¸€ç›´åœ¨ <spanclass="math inline">\(J(\theta)\)</span>æœ€å°å€¼é™„è¿‘éœ‡è¡ï¼›ä¸è¿‡é€šå¸¸æƒ…å†µä¸‹åœ¨æœ€å°å€¼é™„è¿‘çš„è¿™äº›å€¼å¤§å¤šæ•°å…¶å®ä¹Ÿè¶³å¤Ÿé€¼è¿‘äº†ï¼Œè¶³ä»¥æ»¡è¶³å’±ä»¬çš„ç²¾åº¦è¦æ±‚ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç”¨ã€‚ï¼‰ç”±äºè¿™äº›åŸå› ï¼Œç‰¹åˆ«æ˜¯åœ¨è®­ç»ƒé›†å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œéšæœºæ¢¯åº¦ä¸‹é™å¾€å¾€æ¯”æ‰¹é‡æ¢¯åº¦ä¸‹é™æ›´å—é’çã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Machine Learning</category>
      
    </categories>
    
    
  </entry>
  
  
  
  
</search>
