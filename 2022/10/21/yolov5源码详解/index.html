

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="è‚˜å­å¼€">
  <meta name="keywords" content="">
  
    <meta name="description" content="yolo.yaml  ä»¥yolov5s.yamlä¸ºä¾‹  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849# YOLOv5 ğŸš€ by Ultralytics, GPL-3.0 license# Parametersnc: 80  # number of clas">
<meta property="og:type" content="article">
<meta property="og:title" content="yolov5æºç è¯¦è§£">
<meta property="og:url" content="http://example.com/2022/10/21/yolov5%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="è‚˜å­å¼€çš„åšå®¢">
<meta property="og:description" content="yolo.yaml  ä»¥yolov5s.yamlä¸ºä¾‹  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849# YOLOv5 ğŸš€ by Ultralytics, GPL-3.0 license# Parametersnc: 80  # number of clas">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-10-21T08:52:26.000Z">
<meta property="article:modified_time" content="2022-10-31T02:33:45.493Z">
<meta property="article:author" content="è‚˜å­å¼€">
<meta name="twitter:card" content="summary_large_image">
  
  
  <title>yolov5æºç è¯¦è§£ - è‚˜å­å¼€çš„åšå®¢</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/nnfx-dark.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>è‚˜å­å¼€çš„åšå®¢</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/bg/bg2.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="yolov5æºç è¯¦è§£">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-10-21 16:52" pubdate>
        2022å¹´10æœˆ21æ—¥ ä¸‹åˆ
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      44k å­—
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      370 åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">yolov5æºç è¯¦è§£</h1>
            
            <div class="markdown-body">
              <h1 id="yolo.yaml">yolo.yaml</h1>
<ul>
<li>ä»¥yolov5s.yamlä¸ºä¾‹</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-comment"># YOLOv5 ğŸš€ by Ultralytics, GPL-3.0 license</span><br><br><span class="hljs-comment"># Parameters</span><br><span class="hljs-attr">nc:</span> <span class="hljs-number">80</span>  <span class="hljs-comment"># number of classes</span><br><span class="hljs-attr">depth_multiple:</span> <span class="hljs-number">0.33</span>  <span class="hljs-comment"># model depth multiple</span><br><span class="hljs-attr">width_multiple:</span> <span class="hljs-number">0.50</span>  <span class="hljs-comment"># layer channel multiple</span><br><span class="hljs-attr">anchors:</span><br>  <span class="hljs-bullet">-</span> [<span class="hljs-number">10</span>,<span class="hljs-number">13</span>, <span class="hljs-number">16</span>,<span class="hljs-number">30</span>, <span class="hljs-number">33</span>,<span class="hljs-number">23</span>]  <span class="hljs-comment"># P3/8</span><br>  <span class="hljs-bullet">-</span> [<span class="hljs-number">30</span>,<span class="hljs-number">61</span>, <span class="hljs-number">62</span>,<span class="hljs-number">45</span>, <span class="hljs-number">59</span>,<span class="hljs-number">119</span>]  <span class="hljs-comment"># P4/16</span><br>  <span class="hljs-bullet">-</span> [<span class="hljs-number">116</span>,<span class="hljs-number">90</span>, <span class="hljs-number">156</span>,<span class="hljs-number">198</span>, <span class="hljs-number">373</span>,<span class="hljs-number">326</span>]  <span class="hljs-comment"># P5/32</span><br><br><span class="hljs-comment"># YOLOv5 v6.0 backbone</span><br><span class="hljs-attr">backbone:</span><br>  <span class="hljs-comment"># [from, number, module, args]</span><br>  [[<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">64</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>]],  <span class="hljs-comment"># 0-P1/2</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">128</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]],  <span class="hljs-comment"># 1-P2/4</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">128</span>]],<br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]],  <span class="hljs-comment"># 3-P3/8</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">6</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">256</span>]],<br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]],  <span class="hljs-comment"># 5-P4/16</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">9</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">512</span>]],<br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">1024</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]],  <span class="hljs-comment"># 7-P5/32</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">1024</span>]],<br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">SPPF</span>, [<span class="hljs-number">1024</span>, <span class="hljs-number">5</span>]],  <span class="hljs-comment"># 9</span><br>  ]<br><br><span class="hljs-comment"># YOLOv5 v6.0 head</span><br><span class="hljs-attr">head:</span><br>  [[<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">512</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]],<br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">nn.Upsample</span>, [<span class="hljs-string">None</span>, <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;nearest&#x27;</span>]],<br>   [[<span class="hljs-number">-1</span>, <span class="hljs-number">6</span>], <span class="hljs-number">1</span>, <span class="hljs-string">Concat</span>, [<span class="hljs-number">1</span>]],  <span class="hljs-comment"># cat backbone P4</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">512</span>, <span class="hljs-literal">False</span>]],  <span class="hljs-comment"># 13</span><br><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">256</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]],<br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">nn.Upsample</span>, [<span class="hljs-string">None</span>, <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;nearest&#x27;</span>]],<br>   [[<span class="hljs-number">-1</span>, <span class="hljs-number">4</span>], <span class="hljs-number">1</span>, <span class="hljs-string">Concat</span>, [<span class="hljs-number">1</span>]],  <span class="hljs-comment"># cat backbone P3</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">256</span>, <span class="hljs-literal">False</span>]],  <span class="hljs-comment"># 17 (P3/8-small)</span><br><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">256</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]],<br>   [[<span class="hljs-number">-1</span>, <span class="hljs-number">14</span>], <span class="hljs-number">1</span>, <span class="hljs-string">Concat</span>, [<span class="hljs-number">1</span>]],  <span class="hljs-comment"># cat head P4</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">512</span>, <span class="hljs-literal">False</span>]],  <span class="hljs-comment"># 20 (P4/16-medium)</span><br><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-string">Conv</span>, [<span class="hljs-number">512</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]],<br>   [[<span class="hljs-number">-1</span>, <span class="hljs-number">10</span>], <span class="hljs-number">1</span>, <span class="hljs-string">Concat</span>, [<span class="hljs-number">1</span>]],  <span class="hljs-comment"># cat head P5</span><br>   [<span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-string">C3</span>, [<span class="hljs-number">1024</span>, <span class="hljs-literal">False</span>]],  <span class="hljs-comment"># 23 (P5/32-large)</span><br><br>   [[<span class="hljs-number">17</span>, <span class="hljs-number">20</span>, <span class="hljs-number">23</span>], <span class="hljs-number">1</span>, <span class="hljs-string">Detect</span>, [<span class="hljs-string">nc</span>, <span class="hljs-string">anchors</span>]],  <span class="hljs-comment"># Detect(P3, P4, P5)</span><br>  ]<br><br></code></pre></div></td></tr></table></figure>
<h1 id="yolo.py">yolo.py</h1>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># é¡¹ç›®åœ°å€ä¿å­˜</span><br>FILE = Path(__file__).resolve()<br>ROOT = FILE.parents[<span class="hljs-number">1</span>]  <span class="hljs-comment"># YOLOv5 root directory</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(ROOT) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> sys.path:<br>    sys.path.append(<span class="hljs-built_in">str</span>(ROOT))  <span class="hljs-comment"># add ROOT to PATH</span><br><span class="hljs-keyword">if</span> platform.system() != <span class="hljs-string">&#x27;Windows&#x27;</span>:<br>    ROOT = Path(os.path.relpath(ROOT, Path.cwd()))  <span class="hljs-comment"># relative</span><br>    <br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Detect</span>(nn.Module):<br>    stride = <span class="hljs-literal">None</span>  <span class="hljs-comment"># strides computed during build</span><br>    onnx_dynamic = <span class="hljs-literal">False</span>  <span class="hljs-comment"># ONNX export parameter</span><br>    export = <span class="hljs-literal">False</span>  <span class="hljs-comment"># export mode</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, nc=<span class="hljs-number">80</span>, anchors=(<span class="hljs-params"></span>), ch=(<span class="hljs-params"></span>), inplace=<span class="hljs-literal">True</span></span>):  <span class="hljs-comment"># detection layer</span><br>        <span class="hljs-built_in">super</span>().__init__()<br>        self.nc = nc  <span class="hljs-comment"># number of classes</span><br>        self.no = nc + <span class="hljs-number">5</span>  <span class="hljs-comment"># number of outputs per anchor</span><br>        self.nl = <span class="hljs-built_in">len</span>(anchors)  <span class="hljs-comment"># number of detection layers</span><br>        self.na = <span class="hljs-built_in">len</span>(anchors[<span class="hljs-number">0</span>]) // <span class="hljs-number">2</span>  <span class="hljs-comment"># number of anchors</span><br>        self.grid = [torch.zeros(<span class="hljs-number">1</span>)] * self.nl  <span class="hljs-comment"># init grid</span><br>        self.anchor_grid = [torch.zeros(<span class="hljs-number">1</span>)] * self.nl  <span class="hljs-comment"># init anchor grid</span><br>        self.register_buffer(<span class="hljs-string">&#x27;anchors&#x27;</span>, torch.tensor(anchors).<span class="hljs-built_in">float</span>().view(self.nl, -<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))  <span class="hljs-comment"># shape(nl,na,2)</span><br>        self.m = nn.ModuleList(nn.Conv2d(x, self.no * self.na, <span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ch)  <span class="hljs-comment"># output conv</span><br>        self.inplace = inplace  <span class="hljs-comment"># use in-place ops (e.g. slice assignment)</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        z = []  <span class="hljs-comment"># inference output</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.nl):<br>            x[i] = self.m[i](x[i])  <span class="hljs-comment"># conv</span><br>            bs, _, ny, nx = x[i].shape  <span class="hljs-comment"># x(bs,255,20,20) to x(bs,3,20,20,85)</span><br>            <span class="hljs-comment"># permute()ç”¨äºtensorçš„è¡Œåˆ—è¿›è¡Œäº¤æ¢</span><br>            <span class="hljs-comment"># contiguous()ä¸åœ¨å…ƒæ•°æ®ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œä¼šè¿›è¡Œæ·±æ‹·è´</span><br>            x[i] = x[i].view(bs, self.na, self.no, ny, nx).permute(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>).contiguous()<br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.training:  <span class="hljs-comment"># inference</span><br>                <span class="hljs-keyword">if</span> self.onnx_dynamic <span class="hljs-keyword">or</span> self.grid[i].shape[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] != x[i].shape[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>]:<br>                    self.grid[i], self.anchor_grid[i] = self._make_grid(nx, ny, i)<br><br>                y = x[i].sigmoid()<br>                <span class="hljs-keyword">if</span> self.inplace:<br>                    y[..., <span class="hljs-number">0</span>:<span class="hljs-number">2</span>] = (y[..., <span class="hljs-number">0</span>:<span class="hljs-number">2</span>] * <span class="hljs-number">2</span> + self.grid[i]) * self.stride[i]  <span class="hljs-comment"># xy</span><br>                    y[..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>] = (y[..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>] * <span class="hljs-number">2</span>) ** <span class="hljs-number">2</span> * self.anchor_grid[i]  <span class="hljs-comment"># wh</span><br>                <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># for YOLOv5 on AWS Inferentia https://github.com/ultralytics/yolov5/pull/2953</span><br>                    xy, wh, conf = y.split((<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, self.nc + <span class="hljs-number">1</span>), <span class="hljs-number">4</span>)  <span class="hljs-comment"># y.tensor_split((2, 4, 5), 4)  # torch 1.8.0</span><br>                    xy = (xy * <span class="hljs-number">2</span> + self.grid[i]) * self.stride[i]  <span class="hljs-comment"># xy</span><br>                    wh = (wh * <span class="hljs-number">2</span>) ** <span class="hljs-number">2</span> * self.anchor_grid[i]  <span class="hljs-comment"># wh</span><br>                    y = torch.cat((xy, wh, conf), <span class="hljs-number">4</span>)<br>                z.append(y.view(bs, -<span class="hljs-number">1</span>, self.no))<br><br>        <span class="hljs-keyword">return</span> x <span class="hljs-keyword">if</span> self.training <span class="hljs-keyword">else</span> (torch.cat(z, <span class="hljs-number">1</span>),) <span class="hljs-keyword">if</span> self.export <span class="hljs-keyword">else</span> (torch.cat(z, <span class="hljs-number">1</span>), x)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_make_grid</span>(<span class="hljs-params">self, nx=<span class="hljs-number">20</span>, ny=<span class="hljs-number">20</span>, i=<span class="hljs-number">0</span></span>):<br>        d = self.anchors[i].device<br>        t = self.anchors[i].dtype<br>        shape = <span class="hljs-number">1</span>, self.na, ny, nx, <span class="hljs-number">2</span>  <span class="hljs-comment"># grid shape</span><br>        <span class="hljs-comment"># arange()ç”¨äºç”Ÿæˆå¼ é‡</span><br>        y, x = torch.arange(ny, device=d, dtype=t), torch.arange(nx, device=d, dtype=t)<br>        <span class="hljs-keyword">if</span> check_version(torch.__version__, <span class="hljs-string">&#x27;1.10.0&#x27;</span>):  <span class="hljs-comment"># torch&gt;=1.10.0 meshgrid workaround for torch&gt;=0.7 compatibility</span><br>            <span class="hljs-comment"># meshgrid()ç”¨äºç”Ÿæˆç½‘æ ¼ï¼Œå¯ç”¨äºç”Ÿæˆåæ ‡ï¼Œè¡Œæ•°ä¸ºç¬¬ä¸€ä¸ªå¼ é‡çš„å…ƒç´ ä¸ªæ•°ï¼Œåˆ—æ•°ä¸ºç¬¬äºŒä¸ªå¼ é‡çš„å…ƒç´ ä¸ªæ•°</span><br>            <span class="hljs-comment"># yv: ny * nx, xv: ny * nx</span><br>            <span class="hljs-comment"># example: y = tensor([1, 2, 3, 4]), x = tensor([5, 6, 7])</span><br>            <span class="hljs-comment"># yv = [[1, 1, 1], </span><br>            <span class="hljs-comment">#       [2, 2, 2], </span><br>            <span class="hljs-comment">#       [3, 3, 3], </span><br>            <span class="hljs-comment">#       [4, 4, 4]]</span><br>            <span class="hljs-comment"># xv = [[5, 6, 7], </span><br>            <span class="hljs-comment">#       [5, 6, 7], </span><br>            <span class="hljs-comment">#       [5, 6, 7], </span><br>            <span class="hljs-comment">#       [5, 6, 7]]</span><br>            yv, xv = torch.meshgrid(y, x, indexing=<span class="hljs-string">&#x27;ij&#x27;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            yv, xv = torch.meshgrid(y, x)<br>        <span class="hljs-comment"># stack()ç”¨äºæ‹¼æ¥å¼ é‡ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæ‹¼æ¥çš„ç»´åº¦</span><br>        <span class="hljs-comment"># expand()ç”¨æ¥æ‰©å±•ç»´åº¦</span><br>        grid = torch.stack((xv, yv), <span class="hljs-number">2</span>).expand(shape) - <span class="hljs-number">0.5</span>  <span class="hljs-comment"># add grid offset, i.e. y = 2.0 * x - 0.5</span><br>        anchor_grid = (self.anchors[i] * self.stride[i]).view((<span class="hljs-number">1</span>, self.na, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)).expand(shape)<br>        <span class="hljs-keyword">return</span> grid, anchor_grid<br>    <br>    <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span>(nn.Module):<br>    <span class="hljs-comment"># YOLOv5 model</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, cfg=<span class="hljs-string">&#x27;yolov5s.yaml&#x27;</span>, ch=<span class="hljs-number">3</span>, nc=<span class="hljs-literal">None</span>, anchors=<span class="hljs-literal">None</span></span>):  <span class="hljs-comment"># model, input channels, number of classes</span><br>        <span class="hljs-built_in">super</span>().__init__()<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(cfg, <span class="hljs-built_in">dict</span>):<br>            self.yaml = cfg  <span class="hljs-comment"># model dict</span><br>        <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># is *.yaml</span><br>            <span class="hljs-keyword">import</span> yaml  <span class="hljs-comment"># for torch hub</span><br>            self.yaml_file = Path(cfg).name<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(cfg, encoding=<span class="hljs-string">&#x27;ascii&#x27;</span>, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>                self.yaml = yaml.safe_load(f)  <span class="hljs-comment"># model dict</span><br><br>        <span class="hljs-comment"># Define model</span><br>        ch = self.yaml[<span class="hljs-string">&#x27;ch&#x27;</span>] = self.yaml.get(<span class="hljs-string">&#x27;ch&#x27;</span>, ch)  <span class="hljs-comment"># input channelsï¼Œå¦‚æœyamlæ–‡ä»¶ä¸­æ²¡æœ‰chï¼Œåˆ™å†™å…¥</span><br>        <span class="hljs-keyword">if</span> nc <span class="hljs-keyword">and</span> nc != self.yaml[<span class="hljs-string">&#x27;nc&#x27;</span>]:	<br>            LOGGER.info(<span class="hljs-string">f&quot;Overriding model.yaml nc=<span class="hljs-subst">&#123;self.yaml[<span class="hljs-string">&#x27;nc&#x27;</span>]&#125;</span> with nc=<span class="hljs-subst">&#123;nc&#125;</span>&quot;</span>)<br>            self.yaml[<span class="hljs-string">&#x27;nc&#x27;</span>] = nc  <span class="hljs-comment"># override yaml value</span><br>        <span class="hljs-keyword">if</span> anchors:<br>            LOGGER.info(<span class="hljs-string">f&#x27;Overriding model.yaml anchors with anchors=<span class="hljs-subst">&#123;anchors&#125;</span>&#x27;</span>)<br>            self.yaml[<span class="hljs-string">&#x27;anchors&#x27;</span>] = <span class="hljs-built_in">round</span>(anchors)  <span class="hljs-comment"># override yaml valueï¼Œround()å››èˆäº”å…¥</span><br>        self.model, self.save = parse_model(deepcopy(self.yaml), ch=[ch])  <span class="hljs-comment"># model, savelist</span><br>        self.names = [<span class="hljs-built_in">str</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.yaml[<span class="hljs-string">&#x27;nc&#x27;</span>])]  <span class="hljs-comment"># default names</span><br>        self.inplace = self.yaml.get(<span class="hljs-string">&#x27;inplace&#x27;</span>, <span class="hljs-literal">True</span>)<br><br>        <span class="hljs-comment"># Build strides, anchors</span><br>        m = self.model[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># Detect()</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m, Detect):<br>            s = <span class="hljs-number">256</span>  <span class="hljs-comment"># 2x min stride</span><br>            m.inplace = self.inplace<br>            <span class="hljs-comment"># æ­¥é•¿æœ€åç»“æœä¸º[8, 16, 32]</span><br>            m.stride = torch.tensor([s / x.shape[-<span class="hljs-number">2</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self.forward(torch.zeros(<span class="hljs-number">1</span>, ch, s, s))])  <span class="hljs-comment"># forward</span><br>            <span class="hljs-comment"># æ£€æµ‹anchoré¡ºåºæœ‰æ²¡æœ‰é”™</span><br>            check_anchor_order(m)  <span class="hljs-comment"># must be in pixel-space (not grid-space)</span><br>            <span class="hljs-comment"># anchoréœ€è¦é™¤ä»¥æ­¥é•¿æ¥å¾—åˆ°æœ€åå†ç‰¹å¾å›¾ä¸Šçš„å¤§å°</span><br>            m.anchors /= m.stride.view(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>            self.stride = m.stride<br>            <span class="hljs-comment"># ä¹±ä¸ƒå…«ç³Ÿçš„åˆå§‹åŒ–</span><br>            self._initialize_biases()  <span class="hljs-comment"># only run once</span><br><br>        <span class="hljs-comment"># Init weights, biases</span><br>        initialize_weights(self)<br>        self.info()<br>        LOGGER.info(<span class="hljs-string">&#x27;&#x27;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, augment=<span class="hljs-literal">False</span>, profile=<span class="hljs-literal">False</span>, visualize=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-comment"># åˆ†ä¸ºæ˜¯å¦æ•°æ®å¢å¼ºåçš„å‰å‘ä¼ æ’­</span><br>        <span class="hljs-keyword">if</span> augment:<br>            <span class="hljs-keyword">return</span> self._forward_augment(x)  <span class="hljs-comment"># augmented inference, None</span><br>        <span class="hljs-keyword">return</span> self._forward_once(x, profile, visualize)  <span class="hljs-comment"># single-scale inference, train</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_forward_augment</span>(<span class="hljs-params">self, x</span>):<br>        img_size = x.shape[-<span class="hljs-number">2</span>:]  <span class="hljs-comment"># height, width</span><br>        s = [<span class="hljs-number">1</span>, <span class="hljs-number">0.83</span>, <span class="hljs-number">0.67</span>]  <span class="hljs-comment"># scales</span><br>        f = [<span class="hljs-literal">None</span>, <span class="hljs-number">3</span>, <span class="hljs-literal">None</span>]  <span class="hljs-comment"># flips (2-ud, 3-lr)</span><br>        y = []  <span class="hljs-comment"># outputs</span><br>        <span class="hljs-keyword">for</span> si, fi <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(s, f):<br>            xi = scale_img(x.flip(fi) <span class="hljs-keyword">if</span> fi <span class="hljs-keyword">else</span> x, si, gs=<span class="hljs-built_in">int</span>(self.stride.<span class="hljs-built_in">max</span>()))<br>            yi = self._forward_once(xi)[<span class="hljs-number">0</span>]  <span class="hljs-comment"># forward</span><br>            <span class="hljs-comment"># cv2.imwrite(f&#x27;img_&#123;si&#125;.jpg&#x27;, 255 * xi[0].cpu().numpy().transpose((1, 2, 0))[:, :, ::-1])  # save</span><br>            yi = self._descale_pred(yi, fi, si, img_size)<br>            y.append(yi)<br>        y = self._clip_augmented(y)  <span class="hljs-comment"># clip augmented tails</span><br>        <span class="hljs-keyword">return</span> torch.cat(y, <span class="hljs-number">1</span>), <span class="hljs-literal">None</span>  <span class="hljs-comment"># augmented inference, train</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_forward_once</span>(<span class="hljs-params">self, x, profile=<span class="hljs-literal">False</span>, visualize=<span class="hljs-literal">False</span></span>):<br>        y, dt = [], []  <span class="hljs-comment"># outputs</span><br>        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> self.model:<br>            <span class="hljs-keyword">if</span> m.f != -<span class="hljs-number">1</span>:  <span class="hljs-comment"># if not from previous layer</span><br>                x = y[m.f] <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m.f, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> [x <span class="hljs-keyword">if</span> j == -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> y[j] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> m.f]  <span class="hljs-comment"># from earlier layers</span><br>            <span class="hljs-keyword">if</span> profile:<br>                self._profile_one_layer(m, x, dt)<br>            x = m(x)  <span class="hljs-comment"># run</span><br>            y.append(x <span class="hljs-keyword">if</span> m.i <span class="hljs-keyword">in</span> self.save <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>)  <span class="hljs-comment"># save output</span><br>            <span class="hljs-keyword">if</span> visualize:<br>                feature_visualization(x, m.<span class="hljs-built_in">type</span>, m.i, save_dir=visualize)<br>        <span class="hljs-keyword">return</span> x<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_descale_pred</span>(<span class="hljs-params">self, p, flips, scale, img_size</span>):<br>        <span class="hljs-comment"># de-scale predictions following augmented inference (inverse operation)</span><br>        <span class="hljs-keyword">if</span> self.inplace:<br>            p[..., :<span class="hljs-number">4</span>] /= scale  <span class="hljs-comment"># de-scale</span><br>            <span class="hljs-keyword">if</span> flips == <span class="hljs-number">2</span>:<br>                p[..., <span class="hljs-number">1</span>] = img_size[<span class="hljs-number">0</span>] - p[..., <span class="hljs-number">1</span>]  <span class="hljs-comment"># de-flip ud</span><br>            <span class="hljs-keyword">elif</span> flips == <span class="hljs-number">3</span>:<br>                p[..., <span class="hljs-number">0</span>] = img_size[<span class="hljs-number">1</span>] - p[..., <span class="hljs-number">0</span>]  <span class="hljs-comment"># de-flip lr</span><br>        <span class="hljs-keyword">else</span>:<br>            x, y, wh = p[..., <span class="hljs-number">0</span>:<span class="hljs-number">1</span>] / scale, p[..., <span class="hljs-number">1</span>:<span class="hljs-number">2</span>] / scale, p[..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>] / scale  <span class="hljs-comment"># de-scale</span><br>            <span class="hljs-keyword">if</span> flips == <span class="hljs-number">2</span>:<br>                y = img_size[<span class="hljs-number">0</span>] - y  <span class="hljs-comment"># de-flip ud</span><br>            <span class="hljs-keyword">elif</span> flips == <span class="hljs-number">3</span>:<br>                x = img_size[<span class="hljs-number">1</span>] - x  <span class="hljs-comment"># de-flip lr</span><br>            p = torch.cat((x, y, wh, p[..., <span class="hljs-number">4</span>:]), -<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> p<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_clip_augmented</span>(<span class="hljs-params">self, y</span>):<br>        <span class="hljs-comment"># Clip YOLOv5 augmented inference tails</span><br>        nl = self.model[-<span class="hljs-number">1</span>].nl  <span class="hljs-comment"># number of detection layers (P3-P5)</span><br>        g = <span class="hljs-built_in">sum</span>(<span class="hljs-number">4</span> ** x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(nl))  <span class="hljs-comment"># grid points</span><br>        e = <span class="hljs-number">1</span>  <span class="hljs-comment"># exclude layer count</span><br>        i = (y[<span class="hljs-number">0</span>].shape[<span class="hljs-number">1</span>] // g) * <span class="hljs-built_in">sum</span>(<span class="hljs-number">4</span> ** x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(e))  <span class="hljs-comment"># indices</span><br>        y[<span class="hljs-number">0</span>] = y[<span class="hljs-number">0</span>][:, :-i]  <span class="hljs-comment"># large</span><br>        i = (y[-<span class="hljs-number">1</span>].shape[<span class="hljs-number">1</span>] // g) * <span class="hljs-built_in">sum</span>(<span class="hljs-number">4</span> ** (nl - <span class="hljs-number">1</span> - x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(e))  <span class="hljs-comment"># indices</span><br>        y[-<span class="hljs-number">1</span>] = y[-<span class="hljs-number">1</span>][:, i:]  <span class="hljs-comment"># small</span><br>        <span class="hljs-keyword">return</span> y<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_profile_one_layer</span>(<span class="hljs-params">self, m, x, dt</span>):<br>        c = <span class="hljs-built_in">isinstance</span>(m, Detect)  <span class="hljs-comment"># is final layer, copy input as inplace fix</span><br>        o = thop.profile(m, inputs=(x.copy() <span class="hljs-keyword">if</span> c <span class="hljs-keyword">else</span> x,), verbose=<span class="hljs-literal">False</span>)[<span class="hljs-number">0</span>] / <span class="hljs-number">1E9</span> * <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> thop <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>  <span class="hljs-comment"># FLOPs</span><br>        t = time_sync()<br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>            m(x.copy() <span class="hljs-keyword">if</span> c <span class="hljs-keyword">else</span> x)<br>        dt.append((time_sync() - t) * <span class="hljs-number">100</span>)<br>        <span class="hljs-keyword">if</span> m == self.model[<span class="hljs-number">0</span>]:<br>            LOGGER.info(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;time (ms)&#x27;</span>:&gt;10s&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;GFLOPs&#x27;</span>:&gt;10s&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;params&#x27;</span>:&gt;10s&#125;</span>  <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;module&#x27;</span>&#125;</span>&quot;</span>)<br>        LOGGER.info(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;dt[-<span class="hljs-number">1</span>]:<span class="hljs-number">10.2</span>f&#125;</span> <span class="hljs-subst">&#123;o:<span class="hljs-number">10.2</span>f&#125;</span> <span class="hljs-subst">&#123;m.np:<span class="hljs-number">10.0</span>f&#125;</span>  <span class="hljs-subst">&#123;m.<span class="hljs-built_in">type</span>&#125;</span>&#x27;</span>)<br>        <span class="hljs-keyword">if</span> c:<br>            LOGGER.info(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">sum</span>(dt):<span class="hljs-number">10.2</span>f&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;-&#x27;</span>:&gt;10s&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;-&#x27;</span>:&gt;10s&#125;</span>  Total&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_initialize_biases</span>(<span class="hljs-params">self, cf=<span class="hljs-literal">None</span></span>):  <span class="hljs-comment"># initialize biases into Detect(), cf is class frequency</span><br>        <span class="hljs-comment"># https://arxiv.org/abs/1708.02002 section 3.3</span><br>        <span class="hljs-comment"># cf = torch.bincount(torch.tensor(np.concatenate(dataset.labels, 0)[:, 0]).long(), minlength=nc) + 1.</span><br>        m = self.model[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># Detect() module</span><br>        <span class="hljs-keyword">for</span> mi, s <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(m.m, m.stride):  <span class="hljs-comment"># from</span><br>            b = mi.bias.view(m.na, -<span class="hljs-number">1</span>)  <span class="hljs-comment"># conv.bias(255) to (3,85)</span><br>            b.data[:, <span class="hljs-number">4</span>] += math.log(<span class="hljs-number">8</span> / (<span class="hljs-number">640</span> / s) ** <span class="hljs-number">2</span>)  <span class="hljs-comment"># obj (8 objects per 640 image)</span><br>            b.data[:, <span class="hljs-number">5</span>:] += math.log(<span class="hljs-number">0.6</span> / (m.nc - <span class="hljs-number">0.999999</span>)) <span class="hljs-keyword">if</span> cf <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> torch.log(cf / cf.<span class="hljs-built_in">sum</span>())  <span class="hljs-comment"># cls</span><br>            mi.bias = torch.nn.Parameter(b.view(-<span class="hljs-number">1</span>), requires_grad=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_print_biases</span>(<span class="hljs-params">self</span>):<br>        m = self.model[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># Detect() module</span><br>        <span class="hljs-keyword">for</span> mi <span class="hljs-keyword">in</span> m.m:  <span class="hljs-comment"># from</span><br>            b = mi.bias.detach().view(m.na, -<span class="hljs-number">1</span>).T  <span class="hljs-comment"># conv.bias(255) to (3,85)</span><br>            LOGGER.info(<br>                (<span class="hljs-string">&#x27;%6g Conv2d.bias:&#x27;</span> + <span class="hljs-string">&#x27;%10.3g&#x27;</span> * <span class="hljs-number">6</span>) % (mi.weight.shape[<span class="hljs-number">1</span>], *b[:<span class="hljs-number">5</span>].mean(<span class="hljs-number">1</span>).tolist(), b[<span class="hljs-number">5</span>:].mean()))<br><br>    <span class="hljs-comment"># def _print_weights(self):</span><br>    <span class="hljs-comment">#     for m in self.model.modules():</span><br>    <span class="hljs-comment">#         if type(m) is Bottleneck:</span><br>    <span class="hljs-comment">#             LOGGER.info(&#x27;%10.3g&#x27; % (m.w.detach().sigmoid() * 2))  # shortcut weights</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fuse</span>(<span class="hljs-params">self</span>):  <span class="hljs-comment"># fuse model Conv2d() + BatchNorm2d() layers</span><br>        LOGGER.info(<span class="hljs-string">&#x27;Fusing layers... &#x27;</span>)<br>        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> self.model.modules():<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m, (Conv, DWConv)) <span class="hljs-keyword">and</span> <span class="hljs-built_in">hasattr</span>(m, <span class="hljs-string">&#x27;bn&#x27;</span>):<br>                m.conv = fuse_conv_and_bn(m.conv, m.bn)  <span class="hljs-comment"># update conv</span><br>                <span class="hljs-built_in">delattr</span>(m, <span class="hljs-string">&#x27;bn&#x27;</span>)  <span class="hljs-comment"># remove batchnorm</span><br>                m.forward = m.forward_fuse  <span class="hljs-comment"># update forward</span><br>        self.info()<br>        <span class="hljs-keyword">return</span> self<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">info</span>(<span class="hljs-params">self, verbose=<span class="hljs-literal">False</span>, img_size=<span class="hljs-number">640</span></span>):  <span class="hljs-comment"># print model information</span><br>        model_info(self, verbose, img_size)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_apply</span>(<span class="hljs-params">self, fn</span>):<br>        <span class="hljs-comment"># Apply to(), cpu(), cuda(), half() to model tensors that are not parameters or registered buffers</span><br>        self = <span class="hljs-built_in">super</span>()._apply(fn)<br>        m = self.model[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># Detect()</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m, Detect):<br>            m.stride = fn(m.stride)<br>            m.grid = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(fn, m.grid))<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m.anchor_grid, <span class="hljs-built_in">list</span>):<br>                m.anchor_grid = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(fn, m.anchor_grid))<br>        <span class="hljs-keyword">return</span> self<br>    <br>    <br><span class="hljs-comment"># è§£ææ¨¡å‹ï¼Œè¿”å›yamlä¸­æ‰€å±•ç¤ºçš„æ¨¡å‹ï¼Œsavelist</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_model</span>(<span class="hljs-params">d, ch</span>):  <span class="hljs-comment"># model_dict, input_channels(3)</span><br>    LOGGER.info(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;&#x27;</span>:&gt;<span class="hljs-number">3</span>&#125;</span><span class="hljs-subst">&#123;<span class="hljs-string">&#x27;from&#x27;</span>:&gt;<span class="hljs-number">18</span>&#125;</span><span class="hljs-subst">&#123;<span class="hljs-string">&#x27;n&#x27;</span>:&gt;<span class="hljs-number">3</span>&#125;</span><span class="hljs-subst">&#123;<span class="hljs-string">&#x27;params&#x27;</span>:&gt;<span class="hljs-number">10</span>&#125;</span>  <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;module&#x27;</span>:&lt;<span class="hljs-number">40</span>&#125;</span><span class="hljs-subst">&#123;<span class="hljs-string">&#x27;arguments&#x27;</span>:&lt;<span class="hljs-number">30</span>&#125;</span>&quot;</span>)<br>    anchors, nc, gd, gw = d[<span class="hljs-string">&#x27;anchors&#x27;</span>], d[<span class="hljs-string">&#x27;nc&#x27;</span>], d[<span class="hljs-string">&#x27;depth_multiple&#x27;</span>], d[<span class="hljs-string">&#x27;width_multiple&#x27;</span>]<br>    na = (<span class="hljs-built_in">len</span>(anchors[<span class="hljs-number">0</span>]) // <span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(anchors, <span class="hljs-built_in">list</span>) <span class="hljs-keyword">else</span> anchors  <span class="hljs-comment"># number of anchors</span><br>    no = na * (nc + <span class="hljs-number">5</span>)  <span class="hljs-comment"># number of outputs = anchors * (classes + 5)</span><br><br>    layers, save, c2 = [], [], ch[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># layers, savelist, ch out</span><br>    <span class="hljs-comment"># å¼€å§‹è¯»å…¥backboneå’Œheadçš„æ¨¡å‹å‚æ•°</span><br>    <span class="hljs-keyword">for</span> i, (f, n, m, args) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(d[<span class="hljs-string">&#x27;backbone&#x27;</span>] + d[<span class="hljs-string">&#x27;head&#x27;</span>]):  <span class="hljs-comment"># from, number, module, args</span><br>        m = <span class="hljs-built_in">eval</span>(m) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> m  <span class="hljs-comment"># eval strings</span><br>        <span class="hljs-keyword">for</span> j, a <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(args):<br>            <span class="hljs-keyword">try</span>:<br>                args[j] = <span class="hljs-built_in">eval</span>(a) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(a, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> a  <span class="hljs-comment"># eval strings</span><br>            <span class="hljs-keyword">except</span> NameError:<br>                <span class="hljs-keyword">pass</span><br><br>        n = n_ = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">round</span>(n * gd), <span class="hljs-number">1</span>) <span class="hljs-keyword">if</span> n &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> n  <span class="hljs-comment"># depth gainï¼Œæ ¹æ®æ¨¡å‹å¤§å°æ¥å°†moduleæ•°é‡ä¹˜ä»¥depth_multiple</span><br>        <span class="hljs-keyword">if</span> m <span class="hljs-keyword">in</span> (Conv, GhostConv, Bottleneck, GhostBottleneck, SPP, SPPF, DWConv, MixConv2d, Focus, CrossConv,<br>                 BottleneckCSP, C3, C3TR, C3SPP, C3Ghost):<br>            c1, c2 = ch[f], args[<span class="hljs-number">0</span>]	<span class="hljs-comment"># c1ä¸ºè¾“å…¥é€šé“æ•°ï¼Œc2ä¸ºè¾“å‡º</span><br>            <span class="hljs-keyword">if</span> c2 != no:  <span class="hljs-comment"># if not output</span><br>                <span class="hljs-comment"># make_divisibleä¸­è¿”å›math.ceil(c2 * gw / 8) * 8</span><br>                <span class="hljs-comment"># ä¸ºäº†ä½¿é€šé“æ•°ä¸º8çš„å€æ•°</span><br>                c2 = make_divisible(c2 * gw, <span class="hljs-number">8</span>)	<br>			<span class="hljs-comment"># argsçš„åˆ—è¡¨ä¸º[è¾“å…¥é€šé“æ•°ï¼Œè¾“å‡ºé€šé“æ•°ï¼Œyamlæ–‡ä»¶ä¸­åé¢çš„å‚æ•°]</span><br>            args = [c1, c2, *args[<span class="hljs-number">1</span>:]]<br>            <span class="hljs-comment"># å¦‚æœmoduleä¸ºä¸‹é¢è¿™äº›moduleï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸‰ä½æ”¾å…¥éœ€è¦å¾ªç¯çš„æ•°é‡n</span><br>            <span class="hljs-keyword">if</span> m <span class="hljs-keyword">in</span> [BottleneckCSP, C3, C3TR, C3Ghost]:<br>                args.insert(<span class="hljs-number">2</span>, n)  <span class="hljs-comment"># number of repeats</span><br>                n = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">elif</span> m <span class="hljs-keyword">is</span> nn.BatchNorm2d:<br>            <span class="hljs-comment"># å¦‚æœmæ˜¯BatchNorm2dï¼Œé‚£ä¹ˆå‚æ•°å°±ä¸ºä¸Šä¸€ä¸ªmoduleçš„è¾“å‡ºé€šé“æ•°</span><br>            args = [ch[f]]<br>        <span class="hljs-keyword">elif</span> m <span class="hljs-keyword">is</span> Concat:<br>            <span class="hljs-comment"># å¦‚æœmæ˜¯Concatï¼Œé‚£ä¹ˆè¾“å‡ºé€šé“æ•°c2å°±ä¸ºæ¥çš„å‡ ä¸ªmoduleçš„è¾“å‡ºé€šé“æ•°ä¹‹å’Œ</span><br>            c2 = <span class="hljs-built_in">sum</span>(ch[x] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> f)<br>        <span class="hljs-keyword">elif</span> m <span class="hljs-keyword">is</span> Detect:<br>            <span class="hljs-comment"># å¦‚æœmæ˜¯Detectï¼Œé‚£ä¹ˆå‚æ•°å°±åŠ ä¸Šä¸ºæ¥çš„å‡ ä¸ªmoduleçš„è¾“å‡ºé€šé“æ•°çš„åˆ—è¡¨</span><br>            args.append([ch[x] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> f])<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(args[<span class="hljs-number">1</span>], <span class="hljs-built_in">int</span>):  <span class="hljs-comment"># number of anchors</span><br>                args[<span class="hljs-number">1</span>] = [<span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(args[<span class="hljs-number">1</span>] * <span class="hljs-number">2</span>))] * <span class="hljs-built_in">len</span>(f)<br>        <span class="hljs-keyword">elif</span> m <span class="hljs-keyword">is</span> Contract:<br>            c2 = ch[f] * args[<span class="hljs-number">0</span>] ** <span class="hljs-number">2</span><br>        <span class="hljs-keyword">elif</span> m <span class="hljs-keyword">is</span> Expand:<br>            c2 = ch[f] // args[<span class="hljs-number">0</span>] ** <span class="hljs-number">2</span><br>        <span class="hljs-keyword">else</span>:<br>            c2 = ch[f]<br><br>        <span class="hljs-comment"># å°†yamlçš„moduleæ·»åŠ åˆ°nn.Sequentialä¸­</span><br>        m_ = nn.Sequential(*(m(*args) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n))) <span class="hljs-keyword">if</span> n &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> m(*args)  <span class="hljs-comment"># module</span><br>        t = <span class="hljs-built_in">str</span>(m)[<span class="hljs-number">8</span>:-<span class="hljs-number">2</span>].replace(<span class="hljs-string">&#x27;__main__.&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)  <span class="hljs-comment"># module type</span><br>        np = <span class="hljs-built_in">sum</span>(x.numel() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> m_.parameters())  <span class="hljs-comment"># number params</span><br>        m_.i, m_.f, m_.<span class="hljs-built_in">type</span>, m_.np = i, f, t, np  <span class="hljs-comment"># attach index, &#x27;from&#x27; index, type, number params</span><br>        LOGGER.info(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;i:&gt;<span class="hljs-number">3</span>&#125;</span><span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(f):&gt;<span class="hljs-number">18</span>&#125;</span><span class="hljs-subst">&#123;n_:&gt;<span class="hljs-number">3</span>&#125;</span><span class="hljs-subst">&#123;np:<span class="hljs-number">10.0</span>f&#125;</span>  <span class="hljs-subst">&#123;t:&lt;<span class="hljs-number">40</span>&#125;</span><span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(args):&lt;<span class="hljs-number">30</span>&#125;</span>&#x27;</span>)  <span class="hljs-comment"># print</span><br>        save.extend(x % i <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> ([f] <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(f, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> f) <span class="hljs-keyword">if</span> x != -<span class="hljs-number">1</span>)  <span class="hljs-comment"># append to savelist</span><br>        layers.append(m_)	<span class="hljs-comment"># layeråˆ—è¡¨ä¸­æ·»åŠ æ­¤æ—¶éå†çš„module</span><br>        <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span>:	<span class="hljs-comment"># å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªmoduleï¼Œå…ˆæ¸…ç©ºchåˆ—è¡¨</span><br>            ch = []<br>        ch.append(c2)	<span class="hljs-comment"># åœ¨chä¸­æ·»åŠ è¾“å‡ºé€šé“æ•°</span><br>    <span class="hljs-keyword">return</span> nn.Sequential(*layers), <span class="hljs-built_in">sorted</span>(save)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    parser = argparse.ArgumentParser()<br>    parser.add_argument(<span class="hljs-string">&#x27;--cfg&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-string">&#x27;yolov5s.yaml&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;model.yaml&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;--batch-size&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">1</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;total batch size for all GPUs&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;--device&#x27;</span>, default=<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;cuda device, i.e. 0 or 0,1,2,3 or cpu&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;--profile&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;profile model speed&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;--line-profile&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;profile model speed layer by layer&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;--test&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;test all yolo*.yaml&#x27;</span>)<br>    opt = parser.parse_args()<br>    opt.cfg = check_yaml(opt.cfg)  <span class="hljs-comment"># check YAML</span><br>    print_args(<span class="hljs-built_in">vars</span>(opt))<br>    device = select_device(opt.device)<br><br>    <span class="hljs-comment"># Create model</span><br>    im = torch.rand(opt.batch_size, <span class="hljs-number">3</span>, <span class="hljs-number">640</span>, <span class="hljs-number">640</span>).to(device)<br>    model = Model(opt.cfg).to(device)<br><br>    <span class="hljs-comment"># Options</span><br>    <span class="hljs-keyword">if</span> opt.line_profile:  <span class="hljs-comment"># profile layer by layer</span><br>        _ = model(im, profile=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-keyword">elif</span> opt.profile:  <span class="hljs-comment"># profile forward-backward</span><br>        results = profile(<span class="hljs-built_in">input</span>=im, ops=[model], n=<span class="hljs-number">3</span>)<br><br>    <span class="hljs-keyword">elif</span> opt.test:  <span class="hljs-comment"># test all models</span><br>        <span class="hljs-keyword">for</span> cfg <span class="hljs-keyword">in</span> Path(ROOT / <span class="hljs-string">&#x27;models&#x27;</span>).rglob(<span class="hljs-string">&#x27;yolo*.yaml&#x27;</span>):<br>            <span class="hljs-keyword">try</span>:<br>                _ = Model(cfg)<br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Error in <span class="hljs-subst">&#123;cfg&#125;</span>: <span class="hljs-subst">&#123;e&#125;</span>&#x27;</span>)<br></code></pre></div></td></tr></table></figure>
<h1 id="train.py">train.py</h1>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># è¯»å–æ–‡ä»¶åœ°å€</span><br>FILE = Path(__file__).resolve()<br>ROOT = FILE.parents[<span class="hljs-number">0</span>]  <span class="hljs-comment"># YOLOv5 root directory</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(ROOT) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> sys.path:<br>    sys.path.append(<span class="hljs-built_in">str</span>(ROOT))  <span class="hljs-comment"># add ROOT to PATH</span><br>ROOT = Path(os.path.relpath(ROOT, Path.cwd()))  <span class="hljs-comment"># relative</span><br><br><span class="hljs-comment"># ç”¨äºå¤šGPUè®­ç»ƒ</span><br><span class="hljs-comment"># rankä»£è¡¨è¿›ç¨‹åºå·ï¼Œlocal_rankä»£è¡¨gpu</span><br>LOCAL_RANK = <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">&#x27;LOCAL_RANK&#x27;</span>, -<span class="hljs-number">1</span>))  <span class="hljs-comment"># https://pytorch.org/docs/stable/elastic/run.html</span><br>RANK = <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">&#x27;RANK&#x27;</span>, -<span class="hljs-number">1</span>))<br><span class="hljs-comment"># world_sizeä»£è¡¨æœ‰å¤šå°‘è¿›ç¨‹</span><br>WORLD_SIZE = <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">&#x27;WORLD_SIZE&#x27;</span>, <span class="hljs-number">1</span>))<br><span class="hljs-comment"># å’±ä»¬å•å¡å°±æ˜¯LOCAL_RANK=-1, RANK=-1, WORLD_SIZE=1</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">hyp, opt, device, callbacks</span>):  <span class="hljs-comment"># hyp is path/to/hyp.yaml or hyp dictionary</span><br>    save_dir, epochs, batch_size, weights, single_cls, evolve, data, cfg, resume, noval, nosave, workers, freeze = \<br>        Path(opt.save_dir), opt.epochs, opt.batch_size, opt.weights, opt.single_cls, opt.evolve, opt.data, opt.cfg, \<br>        opt.resume, opt.noval, opt.nosave, opt.workers, opt.freeze<br>    callbacks.run(<span class="hljs-string">&#x27;on_pretrain_routine_start&#x27;</span>)<br><br>    <span class="hljs-comment"># æ¥ä¸‹æ¥å°±æ˜¯å„ç§ä¹±ä¸ƒå…«ç³Ÿçš„å‡†å¤‡å·¥ä½œäº†</span><br>    <span class="hljs-comment"># æ–°å»ºæ–‡ä»¶å¤¹</span><br>    w = save_dir / <span class="hljs-string">&#x27;weights&#x27;</span>  <span class="hljs-comment"># weights dir</span><br>    (w.parent <span class="hljs-keyword">if</span> evolve <span class="hljs-keyword">else</span> w).mkdir(parents=<span class="hljs-literal">True</span>, exist_ok=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># make dir</span><br>    last, best = w / <span class="hljs-string">&#x27;last.pt&#x27;</span>, w / <span class="hljs-string">&#x27;best.pt&#x27;</span><br><br>    <span class="hljs-comment"># è¶…å‚æ•°çš„å‡†å¤‡</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(hyp, <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(hyp, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            hyp = yaml.safe_load(f)  <span class="hljs-comment"># load hyps dict</span><br>    LOGGER.info(colorstr(<span class="hljs-string">&#x27;hyperparameters: &#x27;</span>) + <span class="hljs-string">&#x27;, &#x27;</span>.join(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;k&#125;</span>=<span class="hljs-subst">&#123;v&#125;</span>&#x27;</span> <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> hyp.items()))<br><br>    <span class="hljs-comment"># ä¿å­˜è¿è¡Œè®¾ç½®</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> evolve:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(save_dir / <span class="hljs-string">&#x27;hyp.yaml&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            yaml.safe_dump(hyp, f, sort_keys=<span class="hljs-literal">False</span>)<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(save_dir / <span class="hljs-string">&#x27;opt.yaml&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            yaml.safe_dump(<span class="hljs-built_in">vars</span>(opt), f, sort_keys=<span class="hljs-literal">False</span>)<br><br>    <span class="hljs-comment"># æ—¥å¿—</span><br>    data_dict = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> [-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]:<br>        loggers = Loggers(save_dir, weights, opt, hyp, LOGGER)  <span class="hljs-comment"># loggers instance</span><br>        <span class="hljs-keyword">if</span> loggers.wandb:<br>            <span class="hljs-comment"># è®­ç»ƒé›†è·¯å¾„</span><br>            data_dict = loggers.wandb.data_dict<br>            <span class="hljs-keyword">if</span> resume:	<span class="hljs-comment"># å¦‚æœæ¢å¤æ–­ç‚¹</span><br>                weights, epochs, hyp, batch_size = opt.weights, opt.epochs, opt.hyp, opt.batch_size<br><br>        <span class="hljs-comment"># Register actions</span><br>        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> methods(loggers):<br>            callbacks.register_action(k, callback=<span class="hljs-built_in">getattr</span>(loggers, k))<br><br>    <span class="hljs-comment"># é…ç½®</span><br>    plots = <span class="hljs-keyword">not</span> evolve <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> opt.noplots  <span class="hljs-comment"># create plots</span><br>    cuda = device.<span class="hljs-built_in">type</span> != <span class="hljs-string">&#x27;cpu&#x27;</span>	<span class="hljs-comment"># è®¾å¤‡</span><br>    init_seeds(<span class="hljs-number">1</span> + RANK)	<span class="hljs-comment"># è®¾ç½®éšæœºæ•°ç§å­</span><br>    <span class="hljs-comment"># åˆ†å¸ƒå¼è®­ç»ƒçš„ä¸œè¥¿</span><br>    <span class="hljs-keyword">with</span> torch_distributed_zero_first(LOCAL_RANK):<br>        data_dict = data_dict <span class="hljs-keyword">or</span> check_dataset(data)  <span class="hljs-comment"># check if None</span><br>    <br>    <span class="hljs-comment"># è®­ç»ƒé›†è·¯å¾„</span><br>    train_path, val_path = data_dict[<span class="hljs-string">&#x27;train&#x27;</span>], data_dict[<span class="hljs-string">&#x27;val&#x27;</span>]<br>    nc = <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> single_cls <span class="hljs-keyword">else</span> <span class="hljs-built_in">int</span>(data_dict[<span class="hljs-string">&#x27;nc&#x27;</span>])  <span class="hljs-comment"># classæ•°é‡</span><br>    names = [<span class="hljs-string">&#x27;item&#x27;</span>] <span class="hljs-keyword">if</span> single_cls <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(data_dict[<span class="hljs-string">&#x27;names&#x27;</span>]) != <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> data_dict[<span class="hljs-string">&#x27;names&#x27;</span>]  <span class="hljs-comment"># classåå­—</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(names) == nc, <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(names)&#125;</span> names found for nc=<span class="hljs-subst">&#123;nc&#125;</span> dataset in <span class="hljs-subst">&#123;data&#125;</span>&#x27;</span>  <span class="hljs-comment"># check</span><br>    is_coco = <span class="hljs-built_in">isinstance</span>(val_path, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">and</span> val_path.endswith(<span class="hljs-string">&#x27;coco/val2017.txt&#x27;</span>)  <span class="hljs-comment"># çœ‹æ˜¯ä¸æ˜¯COCOæ•°æ®é›†</span><br><br>    <span class="hljs-comment"># æ­å»ºæ¨¡å‹</span><br>    check_suffix(weights, <span class="hljs-string">&#x27;.pt&#x27;</span>)  <span class="hljs-comment"># æ£€æŸ¥æƒé‡æ–‡ä»¶æ˜¯ä¸æ˜¯æ­£ç¡®åç¼€</span><br>    pretrained = weights.endswith(<span class="hljs-string">&#x27;.pt&#x27;</span>)	<span class="hljs-comment"># æ˜¯ä¸æ˜¯.ptç»“å°¾æ¥åˆ¤æ–­æ˜¯å¦é¢„è®­ç»ƒ</span><br>    <span class="hljs-keyword">if</span> pretrained: <span class="hljs-comment"># å¦‚æœæœ‰é¢„è®­ç»ƒ</span><br>        <span class="hljs-keyword">with</span> torch_distributed_zero_first(LOCAL_RANK):<br>            weights = attempt_download(weights)  <span class="hljs-comment"># æœ¬åœ°æ²¡æ‰¾åˆ°å°±ä¸‹è½½</span><br>        <span class="hljs-comment"># è½½å…¥æƒé‡ï¼Œå¹¶ä¸”å°†æ£€æŸ¥ç‚¹åŠ è½½åˆ°CPUé˜²æ­¢CUDAå†…å­˜æ³„æ¼</span><br>        ckpt = torch.load(weights, map_location=<span class="hljs-string">&#x27;cpu&#x27;</span>) <br>        <span class="hljs-comment"># æ­å»ºæ¨¡å‹ï¼Œè¿™ä¸€å—æœ‰ç‚¹å°ä¹±ï¼Œä¸å¤ªæ‡‚</span><br>        model = Model(cfg <span class="hljs-keyword">or</span> ckpt[<span class="hljs-string">&#x27;model&#x27;</span>].yaml, ch=<span class="hljs-number">3</span>, nc=nc, anchors=hyp.get(<span class="hljs-string">&#x27;anchors&#x27;</span>)).to(device)<br>        exclude = [<span class="hljs-string">&#x27;anchor&#x27;</span>] <span class="hljs-keyword">if</span> (cfg <span class="hljs-keyword">or</span> hyp.get(<span class="hljs-string">&#x27;anchors&#x27;</span>)) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> resume <span class="hljs-keyword">else</span> []  <span class="hljs-comment"># exclude keys</span><br>        csd = ckpt[<span class="hljs-string">&#x27;model&#x27;</span>].<span class="hljs-built_in">float</span>().state_dict()  <span class="hljs-comment"># checkpoint state_dict as FP32</span><br>        csd = intersect_dicts(csd, model.state_dict(), exclude=exclude)  <span class="hljs-comment"># intersect</span><br>        model.load_state_dict(csd, strict=<span class="hljs-literal">False</span>)  <span class="hljs-comment"># load</span><br>        LOGGER.info(<span class="hljs-string">f&#x27;Transferred <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(csd)&#125;</span>/<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(model.state_dict())&#125;</span> items from <span class="hljs-subst">&#123;weights&#125;</span>&#x27;</span>)  <span class="hljs-comment"># report</span><br>    <span class="hljs-keyword">else</span>: <span class="hljs-comment"># å¦‚æœæ²¡æœ‰é¢„è®­ç»ƒ</span><br>        <span class="hljs-comment"># ç›´æ¥æ­å»ºæ¨¡å‹</span><br>        model = Model(cfg, ch=<span class="hljs-number">3</span>, nc=nc, anchors=hyp.get(<span class="hljs-string">&#x27;anchors&#x27;</span>)).to(device)<br><br>    <span class="hljs-comment"># å†»ç»“æ¨¡å‹</span><br>    freeze = [<span class="hljs-string">f&#x27;model.<span class="hljs-subst">&#123;x&#125;</span>.&#x27;</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> (freeze <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(freeze) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-built_in">range</span>(freeze[<span class="hljs-number">0</span>]))]  <span class="hljs-comment"># layers to freeze</span><br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> model.named_parameters():<br>        v.requires_grad = <span class="hljs-literal">True</span>  <span class="hljs-comment"># train all layers</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(x <span class="hljs-keyword">in</span> k <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> freeze):	<span class="hljs-comment"># å¦‚æœæœ‰äº›å±‚éœ€è¦è¢«å†»ç»“</span><br>            LOGGER.info(<span class="hljs-string">f&#x27;freezing <span class="hljs-subst">&#123;k&#125;</span>&#x27;</span>)<br>            v.requires_grad = <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># å›¾åƒå¤§å°</span><br>    gs = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">int</span>(model.stride.<span class="hljs-built_in">max</span>()), <span class="hljs-number">32</span>)  <span class="hljs-comment"># grid size (max stride)</span><br>    imgsz = check_img_size(opt.imgsz, gs, floor=gs * <span class="hljs-number">2</span>)  <span class="hljs-comment"># verify imgsz is gs-multiple</span><br><br>    <span class="hljs-comment"># Batch size</span><br>    <span class="hljs-keyword">if</span> RANK == -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> batch_size == -<span class="hljs-number">1</span>:  <span class="hljs-comment"># single-GPU only, estimate best batch size</span><br>        batch_size = check_train_batch_size(model, imgsz)<br>        loggers.on_params_update(&#123;<span class="hljs-string">&quot;batch_size&quot;</span>: batch_size&#125;)<br><br>    <span class="hljs-comment"># ä¼˜åŒ–å™¨</span><br>    nbs = <span class="hljs-number">64</span>  <span class="hljs-comment"># nominal batch size</span><br>    accumulate = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">round</span>(nbs / batch_size), <span class="hljs-number">1</span>)  <span class="hljs-comment"># accumulate loss before optimizing</span><br>    hyp[<span class="hljs-string">&#x27;weight_decay&#x27;</span>] *= batch_size * accumulate / nbs  <span class="hljs-comment"># scale weight_decay</span><br>    LOGGER.info(<span class="hljs-string">f&quot;Scaled weight_decay = <span class="hljs-subst">&#123;hyp[<span class="hljs-string">&#x27;weight_decay&#x27;</span>]&#125;</span>&quot;</span>)<br><br>    g = [], [], []  <span class="hljs-comment"># optimizer parameter groups</span><br>    bn = <span class="hljs-built_in">tuple</span>(v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> nn.__dict__.items() <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;Norm&#x27;</span> <span class="hljs-keyword">in</span> k)  <span class="hljs-comment"># normalization layers, i.e. BatchNorm2d()</span><br>    <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> model.modules():<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(v, <span class="hljs-string">&#x27;bias&#x27;</span>) <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(v.bias, nn.Parameter):  <span class="hljs-comment"># bias</span><br>            g[<span class="hljs-number">2</span>].append(v.bias)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(v, bn):  <span class="hljs-comment"># weight (no decay)</span><br>            g[<span class="hljs-number">1</span>].append(v.weight)<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(v, <span class="hljs-string">&#x27;weight&#x27;</span>) <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(v.weight, nn.Parameter):  <span class="hljs-comment"># weight (with decay)</span><br>            g[<span class="hljs-number">0</span>].append(v.weight)<br><br>    <span class="hljs-keyword">if</span> opt.optimizer == <span class="hljs-string">&#x27;Adam&#x27;</span>:<br>        optimizer = Adam(g[<span class="hljs-number">2</span>], lr=hyp[<span class="hljs-string">&#x27;lr0&#x27;</span>], betas=(hyp[<span class="hljs-string">&#x27;momentum&#x27;</span>], <span class="hljs-number">0.999</span>))  <span class="hljs-comment"># adjust beta1 to momentum</span><br>    <span class="hljs-keyword">elif</span> opt.optimizer == <span class="hljs-string">&#x27;AdamW&#x27;</span>:<br>        optimizer = AdamW(g[<span class="hljs-number">2</span>], lr=hyp[<span class="hljs-string">&#x27;lr0&#x27;</span>], betas=(hyp[<span class="hljs-string">&#x27;momentum&#x27;</span>], <span class="hljs-number">0.999</span>))  <span class="hljs-comment"># adjust beta1 to momentum</span><br>    <span class="hljs-keyword">else</span>:<br>        optimizer = SGD(g[<span class="hljs-number">2</span>], lr=hyp[<span class="hljs-string">&#x27;lr0&#x27;</span>], momentum=hyp[<span class="hljs-string">&#x27;momentum&#x27;</span>], nesterov=<span class="hljs-literal">True</span>)<br><br>    optimizer.add_param_group(&#123;<span class="hljs-string">&#x27;params&#x27;</span>: g[<span class="hljs-number">0</span>], <span class="hljs-string">&#x27;weight_decay&#x27;</span>: hyp[<span class="hljs-string">&#x27;weight_decay&#x27;</span>]&#125;)  <span class="hljs-comment"># add g0 with weight_decay</span><br>    optimizer.add_param_group(&#123;<span class="hljs-string">&#x27;params&#x27;</span>: g[<span class="hljs-number">1</span>]&#125;)  <span class="hljs-comment"># add g1 (BatchNorm2d weights)</span><br>    LOGGER.info(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;colorstr(<span class="hljs-string">&#x27;optimizer:&#x27;</span>)&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-built_in">type</span>(optimizer).__name__&#125;</span> with parameter groups &quot;</span><br>                <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(g[<span class="hljs-number">1</span>])&#125;</span> weight (no decay), <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(g[<span class="hljs-number">0</span>])&#125;</span> weight, <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(g[<span class="hljs-number">2</span>])&#125;</span> bias&quot;</span>)<br>    <span class="hljs-keyword">del</span> g<br><br>    <span class="hljs-comment"># çœ‹ä¼˜åŒ–å™¨è¦ä¸è¦ä½™å¼¦å­¦ä¹ ç‡</span><br>    <span class="hljs-keyword">if</span> opt.cos_lr:<br>        lf = one_cycle(<span class="hljs-number">1</span>, hyp[<span class="hljs-string">&#x27;lrf&#x27;</span>], epochs)  <span class="hljs-comment"># cosine 1-&gt;hyp[&#x27;lrf&#x27;]</span><br>    <span class="hljs-keyword">else</span>:<br>        lf = <span class="hljs-keyword">lambda</span> x: (<span class="hljs-number">1</span> - x / epochs) * (<span class="hljs-number">1.0</span> - hyp[<span class="hljs-string">&#x27;lrf&#x27;</span>]) + hyp[<span class="hljs-string">&#x27;lrf&#x27;</span>]  <span class="hljs-comment"># linear</span><br>    <span class="hljs-comment"># ç”¨äºè°ƒæ•´å­¦ä¹ ç‡çš„ä¼˜åŒ–å™¨ï¼Œè¿™ä¸ªä¸æ‡‚å¯ä»¥ç‚¹æˆ‘åšå®¢é¡¶ä¸Šçš„åˆ†ç±»ï¼Œé€‰æ‹©Deep Learningä¸­çš„pytorchæ–‡ç« é‡Œé¢çš„ä¼˜åŒ–å™¨é‚£ä¸€å°èŠ‚</span><br>    scheduler = lr_scheduler.LambdaLR(optimizer, lr_lambda=lf)  <span class="hljs-comment"># plot_lr_scheduler(optimizer, scheduler, epochs)</span><br><br>    <span class="hljs-comment"># EMAï¼Œä¿æŒæ¨¡å‹state_dictï¼ˆå‚æ•°å’Œç¼“å†²åŒºï¼‰ä¸­æ‰€æœ‰å†…å®¹çš„ç§»åŠ¨å¹³å‡å€¼</span><br>    ema = ModelEMA(model) <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> [-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>] <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># æ¢å¤æ–­ç‚¹</span><br>    start_epoch, best_fitness = <span class="hljs-number">0</span>, <span class="hljs-number">0.0</span><br>    <span class="hljs-keyword">if</span> pretrained:	<span class="hljs-comment"># å¦‚æœé¢„è®­ç»ƒ</span><br>        <span class="hljs-comment"># Optimizer</span><br>        <span class="hljs-keyword">if</span> ckpt[<span class="hljs-string">&#x27;optimizer&#x27;</span>] <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            optimizer.load_state_dict(ckpt[<span class="hljs-string">&#x27;optimizer&#x27;</span>])<br>            best_fitness = ckpt[<span class="hljs-string">&#x27;best_fitness&#x27;</span>]<br><br>        <span class="hljs-comment"># EMA</span><br>        <span class="hljs-keyword">if</span> ema <span class="hljs-keyword">and</span> ckpt.get(<span class="hljs-string">&#x27;ema&#x27;</span>):<br>            ema.ema.load_state_dict(ckpt[<span class="hljs-string">&#x27;ema&#x27;</span>].<span class="hljs-built_in">float</span>().state_dict())<br>            ema.updates = ckpt[<span class="hljs-string">&#x27;updates&#x27;</span>]<br><br>        <span class="hljs-comment"># Epochs</span><br>        start_epoch = ckpt[<span class="hljs-string">&#x27;epoch&#x27;</span>] + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> resume:<br>            <span class="hljs-keyword">assert</span> start_epoch &gt; <span class="hljs-number">0</span>, <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;weights&#125;</span> training to <span class="hljs-subst">&#123;epochs&#125;</span> epochs is finished, nothing to resume.&#x27;</span><br>        <span class="hljs-keyword">if</span> epochs &lt; start_epoch:<br>            LOGGER.info(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;weights&#125;</span> has been trained for <span class="hljs-subst">&#123;ckpt[<span class="hljs-string">&#x27;epoch&#x27;</span>]&#125;</span> epochs. Fine-tuning for <span class="hljs-subst">&#123;epochs&#125;</span> more epochs.&quot;</span>)<br>            epochs += ckpt[<span class="hljs-string">&#x27;epoch&#x27;</span>]  <span class="hljs-comment"># finetune additional epochs</span><br><br>        <span class="hljs-keyword">del</span> ckpt, csd<br><br>    <span class="hljs-comment"># åˆ†å¸ƒå¼</span><br>    <span class="hljs-keyword">if</span> cuda <span class="hljs-keyword">and</span> RANK == -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> torch.cuda.device_count() &gt; <span class="hljs-number">1</span>:<br>        LOGGER.warning(<span class="hljs-string">&#x27;WARNING: DP not recommended, use torch.distributed.run for best DDP Multi-GPU results.\n&#x27;</span><br>                       <span class="hljs-string">&#x27;See Multi-GPU Tutorial at https://github.com/ultralytics/yolov5/issues/475 to get started.&#x27;</span>)<br>        model = torch.nn.DataParallel(model)<br><br>    <span class="hljs-comment"># SyncBatchNorm</span><br>    <span class="hljs-keyword">if</span> opt.sync_bn <span class="hljs-keyword">and</span> cuda <span class="hljs-keyword">and</span> RANK != -<span class="hljs-number">1</span>:<br>        model = torch.nn.SyncBatchNorm.convert_sync_batchnorm(model).to(device)<br>        LOGGER.info(<span class="hljs-string">&#x27;Using SyncBatchNorm()&#x27;</span>)<br><br>    <span class="hljs-comment"># Trainloader</span><br>    train_loader, dataset = create_dataloader(train_path,<br>                                              imgsz,<br>                                              batch_size // WORLD_SIZE,<br>                                              gs,<br>                                              single_cls,<br>                                              hyp=hyp,<br>                                              augment=<span class="hljs-literal">True</span>,<br>                                              cache=<span class="hljs-literal">None</span> <span class="hljs-keyword">if</span> opt.cache == <span class="hljs-string">&#x27;val&#x27;</span> <span class="hljs-keyword">else</span> opt.cache,<br>                                              rect=opt.rect,<br>                                              rank=LOCAL_RANK,<br>                                              workers=workers,<br>                                              image_weights=opt.image_weights,<br>                                              quad=opt.quad,<br>                                              prefix=colorstr(<span class="hljs-string">&#x27;train: &#x27;</span>),<br>                                              shuffle=<span class="hljs-literal">True</span>)<br>    mlc = <span class="hljs-built_in">int</span>(np.concatenate(dataset.labels, <span class="hljs-number">0</span>)[:, <span class="hljs-number">0</span>].<span class="hljs-built_in">max</span>())  <span class="hljs-comment"># max label class</span><br>    nb = <span class="hljs-built_in">len</span>(train_loader)  <span class="hljs-comment"># number of batches</span><br>    <span class="hljs-keyword">assert</span> mlc &lt; nc, <span class="hljs-string">f&#x27;Label class <span class="hljs-subst">&#123;mlc&#125;</span> exceeds nc=<span class="hljs-subst">&#123;nc&#125;</span> in <span class="hljs-subst">&#123;data&#125;</span>. Possible class labels are 0-<span class="hljs-subst">&#123;nc - <span class="hljs-number">1</span>&#125;</span>&#x27;</span><br><br>    <span class="hljs-comment"># åˆæ˜¯ä¸€å †ä¹±ä¹±çš„ï¼Œçœ‹äº†ä¹Ÿæ²¡å•¥ç”¨ï¼Œå°±æ˜¯åœ¨åˆ›å»ºéªŒè¯é›†çš„dataloader</span><br>    <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> [-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]:<br>        val_loader = create_dataloader(val_path,<br>                                       imgsz,<br>                                       batch_size // WORLD_SIZE * <span class="hljs-number">2</span>,<br>                                       gs,<br>                                       single_cls,<br>                                       hyp=hyp,<br>                                       cache=<span class="hljs-literal">None</span> <span class="hljs-keyword">if</span> noval <span class="hljs-keyword">else</span> opt.cache,<br>                                       rect=<span class="hljs-literal">True</span>,<br>                                       rank=-<span class="hljs-number">1</span>,<br>                                       workers=workers * <span class="hljs-number">2</span>,<br>                                       pad=<span class="hljs-number">0.5</span>,<br>                                       prefix=colorstr(<span class="hljs-string">&#x27;val: &#x27;</span>))[<span class="hljs-number">0</span>]<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resume:<br>            labels = np.concatenate(dataset.labels, <span class="hljs-number">0</span>)<br>            <span class="hljs-comment"># c = torch.tensor(labels[:, 0])  # classes</span><br>            <span class="hljs-comment"># cf = torch.bincount(c.long(), minlength=nc) + 1.  # frequency</span><br>            <span class="hljs-comment"># model._initialize_biases(cf.to(device))</span><br>            <span class="hljs-keyword">if</span> plots:<br>                plot_labels(labels, names, save_dir)<br><br>            <span class="hljs-comment"># Anchors</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> opt.noautoanchor:<br>                check_anchors(dataset, model=model, thr=hyp[<span class="hljs-string">&#x27;anchor_t&#x27;</span>], imgsz=imgsz)<br>            model.half().<span class="hljs-built_in">float</span>()  <span class="hljs-comment"># pre-reduce anchor precision</span><br><br>        callbacks.run(<span class="hljs-string">&#x27;on_pretrain_routine_end&#x27;</span>)<br><br>    <span class="hljs-comment"># åˆ†å¸ƒå¼è®­ç»ƒ</span><br>    <span class="hljs-keyword">if</span> cuda <span class="hljs-keyword">and</span> RANK != -<span class="hljs-number">1</span>:<br>        model = DDP(model, device_ids=[LOCAL_RANK], output_device=LOCAL_RANK)<br><br>    <span class="hljs-comment"># Model attributes</span><br>    nl = de_parallel(model).model[-<span class="hljs-number">1</span>].nl  <span class="hljs-comment"># number of detection layers (to scale hyps)</span><br>    hyp[<span class="hljs-string">&#x27;box&#x27;</span>] *= <span class="hljs-number">3</span> / nl  <span class="hljs-comment"># scale to layers</span><br>    hyp[<span class="hljs-string">&#x27;cls&#x27;</span>] *= nc / <span class="hljs-number">80</span> * <span class="hljs-number">3</span> / nl  <span class="hljs-comment"># scale to classes and layers</span><br>    hyp[<span class="hljs-string">&#x27;obj&#x27;</span>] *= (imgsz / <span class="hljs-number">640</span>) ** <span class="hljs-number">2</span> * <span class="hljs-number">3</span> / nl  <span class="hljs-comment"># scale to image size and layers</span><br>    hyp[<span class="hljs-string">&#x27;label_smoothing&#x27;</span>] = opt.label_smoothing<br>    model.nc = nc  <span class="hljs-comment"># attach number of classes to model</span><br>    model.hyp = hyp  <span class="hljs-comment"># attach hyperparameters to model</span><br>    model.class_weights = labels_to_class_weights(dataset.labels, nc).to(device) * nc  <span class="hljs-comment"># attach class weights</span><br>    model.names = names<br><br>    <span class="hljs-comment"># ç»ˆäºå¯ä»¥å¼€å§‹è®­ç»ƒå•¦</span><br>    t0 = time.time()	<span class="hljs-comment"># æ¥æä¸ªè¡¨</span><br>    nw = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">round</span>(hyp[<span class="hljs-string">&#x27;warmup_epochs&#x27;</span>] * nb), <span class="hljs-number">100</span>)  <span class="hljs-comment"># number of warmup iterations, max(3 epochs, 100 iterations)</span><br>    <span class="hljs-comment"># nw = min(nw, (epochs - start_epoch) / 2 * nb)  # limit warmup to &lt; 1/2 of training</span><br>    last_opt_step = -<span class="hljs-number">1</span><br>    maps = np.zeros(nc)  <span class="hljs-comment"># mAP per class</span><br>    results = (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># P, R, mAP@.5, mAP@.5-.95, val_loss(box, obj, cls)</span><br>    scheduler.last_epoch = start_epoch - <span class="hljs-number">1</span>  <span class="hljs-comment"># do not move</span><br>    scaler = amp.GradScaler(enabled=cuda)	<span class="hljs-comment"># å¸®åŠ©æ–¹ä¾¿åœ°æ‰§è¡Œæ¢¯åº¦ç¼©æ”¾æ­¥éª¤ã€‚</span><br>    stopper = EarlyStopping(patience=opt.patience)<br>    compute_loss = ComputeLoss(model)  <span class="hljs-comment"># åˆå§‹åŒ–losså‡½æ•°ï¼Œå¦‚æœè¦ä¿®æ”¹losså‡½æ•°å°±å¯ä»¥å»utils/loss.pyä¿®æ”¹</span><br>    callbacks.run(<span class="hljs-string">&#x27;on_train_start&#x27;</span>)<br>    LOGGER.info(<span class="hljs-string">f&#x27;Image sizes <span class="hljs-subst">&#123;imgsz&#125;</span> train, <span class="hljs-subst">&#123;imgsz&#125;</span> val\n&#x27;</span><br>                <span class="hljs-string">f&#x27;Using <span class="hljs-subst">&#123;train_loader.num_workers * WORLD_SIZE&#125;</span> dataloader workers\n&#x27;</span><br>                <span class="hljs-string">f&quot;Logging results to <span class="hljs-subst">&#123;colorstr(<span class="hljs-string">&#x27;bold&#x27;</span>, save_dir)&#125;</span>\n&quot;</span><br>                <span class="hljs-string">f&#x27;Starting training for <span class="hljs-subst">&#123;epochs&#125;</span> epochs...&#x27;</span>)<br>    <span class="hljs-comment"># å¼€å§‹epochè¿­ä»£äº†</span><br>    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(start_epoch, epochs):  <span class="hljs-comment"># epoch ------------------------------------------------------------------</span><br>        callbacks.run(<span class="hljs-string">&#x27;on_train_epoch_start&#x27;</span>)<br>        model.train()<br><br>        <span class="hljs-comment"># Update image weights (optional, single-GPU only)</span><br>        <span class="hljs-keyword">if</span> opt.image_weights:<br>            cw = model.class_weights.cpu().numpy() * (<span class="hljs-number">1</span> - maps) ** <span class="hljs-number">2</span> / nc  <span class="hljs-comment"># class weights</span><br>            iw = labels_to_image_weights(dataset.labels, nc=nc, class_weights=cw)  <span class="hljs-comment"># image weights</span><br>            dataset.indices = random.choices(<span class="hljs-built_in">range</span>(dataset.n), weights=iw, k=dataset.n)  <span class="hljs-comment"># rand weighted idx</span><br><br>        <span class="hljs-comment"># Update mosaic border (optional)</span><br>        <span class="hljs-comment"># b = int(random.uniform(0.25 * imgsz, 0.75 * imgsz + gs) // gs * gs)</span><br>        <span class="hljs-comment"># dataset.mosaic_border = [b - imgsz, -b]  # height, width borders</span><br><br>        mloss = torch.zeros(<span class="hljs-number">3</span>, device=device)  <span class="hljs-comment"># mean losses</span><br>        <span class="hljs-keyword">if</span> RANK != -<span class="hljs-number">1</span>:<br>            train_loader.sampler.set_epoch(epoch)<br>        pbar = <span class="hljs-built_in">enumerate</span>(train_loader)	<br>        LOGGER.info((<span class="hljs-string">&#x27;\n&#x27;</span> + <span class="hljs-string">&#x27;%10s&#x27;</span> * <span class="hljs-number">7</span>) % (<span class="hljs-string">&#x27;Epoch&#x27;</span>, <span class="hljs-string">&#x27;gpu_mem&#x27;</span>, <span class="hljs-string">&#x27;box&#x27;</span>, <span class="hljs-string">&#x27;obj&#x27;</span>, <span class="hljs-string">&#x27;cls&#x27;</span>, <span class="hljs-string">&#x27;labels&#x27;</span>, <span class="hljs-string">&#x27;img_size&#x27;</span>))<br>        <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> (-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>):<br>            pbar = tqdm(pbar, total=nb, bar_format=<span class="hljs-string">&#x27;&#123;l_bar&#125;&#123;bar:10&#125;&#123;r_bar&#125;&#123;bar:-10b&#125;&#x27;</span>)  <span class="hljs-comment"># è¿›åº¦æ¡</span><br>        optimizer.zero_grad()	<span class="hljs-comment"># ä¼˜åŒ–å™¨æ¢¯åº¦æ¸…é›¶</span><br>        <span class="hljs-comment"># ä¸€ä¸ªä¸ªbatchå¼€å§‹è®­ç»ƒ</span><br>        <span class="hljs-keyword">for</span> i, (imgs, targets, paths, _) <span class="hljs-keyword">in</span> pbar:  <span class="hljs-comment"># batch -------------------------------------------------------------</span><br>            callbacks.run(<span class="hljs-string">&#x27;on_train_batch_start&#x27;</span>)<br>            ni = i + nb * epoch  <span class="hljs-comment"># number integrated batches (since train start)</span><br>            imgs = imgs.to(device, non_blocking=<span class="hljs-literal">True</span>).<span class="hljs-built_in">float</span>() / <span class="hljs-number">255</span>  <span class="hljs-comment"># uint8 to float32, 0-255 to 0.0-1.0</span><br><br>            <span class="hljs-comment"># çƒ­èº«çƒ­èº«</span><br>            <span class="hljs-keyword">if</span> ni &lt;= nw:<br>                xi = [<span class="hljs-number">0</span>, nw]  <span class="hljs-comment"># x interp</span><br>                <span class="hljs-comment"># compute_loss.gr = np.interp(ni, xi, [0.0, 1.0])  # iou loss ratio (obj_loss = 1.0 or iou)</span><br>                accumulate = <span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, np.interp(ni, xi, [<span class="hljs-number">1</span>, nbs / batch_size]).<span class="hljs-built_in">round</span>())<br>                <span class="hljs-keyword">for</span> j, x <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(optimizer.param_groups):<br>                    <span class="hljs-comment"># bias lr falls from 0.1 to lr0, all other lrs rise from 0.0 to lr0</span><br>                    x[<span class="hljs-string">&#x27;lr&#x27;</span>] = np.interp(ni, xi, [hyp[<span class="hljs-string">&#x27;warmup_bias_lr&#x27;</span>] <span class="hljs-keyword">if</span> j == <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0.0</span>, x[<span class="hljs-string">&#x27;initial_lr&#x27;</span>] * lf(epoch)])<br>                    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;momentum&#x27;</span> <span class="hljs-keyword">in</span> x:<br>                        x[<span class="hljs-string">&#x27;momentum&#x27;</span>] = np.interp(ni, xi, [hyp[<span class="hljs-string">&#x27;warmup_momentum&#x27;</span>], hyp[<span class="hljs-string">&#x27;momentum&#x27;</span>]])<br><br>            <span class="hljs-comment"># å¦‚æœéœ€è¦å¤šå°ºåº¦è®­ç»ƒ</span><br>            <span class="hljs-keyword">if</span> opt.multi_scale:<br>                sz = random.randrange(imgsz * <span class="hljs-number">0.5</span>, imgsz * <span class="hljs-number">1.5</span> + gs) // gs * gs  <span class="hljs-comment"># size</span><br>                sf = sz / <span class="hljs-built_in">max</span>(imgs.shape[<span class="hljs-number">2</span>:])  <span class="hljs-comment"># scale factor</span><br>                <span class="hljs-keyword">if</span> sf != <span class="hljs-number">1</span>:<br>                    ns = [math.ceil(x * sf / gs) * gs <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> imgs.shape[<span class="hljs-number">2</span>:]]  <span class="hljs-comment"># new shape (stretched to gs-multiple)</span><br>                    imgs = nn.functional.interpolate(imgs, size=ns, mode=<span class="hljs-string">&#x27;bilinear&#x27;</span>, align_corners=<span class="hljs-literal">False</span>)<br><br>            <span class="hljs-comment"># å‰å‘ä¼ æ’­ç„¶åè®¡ç®—loss</span><br>            <span class="hljs-keyword">with</span> amp.autocast(enabled=cuda):<br>                pred = model(imgs)  <span class="hljs-comment"># forward</span><br>                loss, loss_items = compute_loss(pred, targets.to(device))  <span class="hljs-comment"># loss scaled by batch_size</span><br>                <span class="hljs-keyword">if</span> RANK != -<span class="hljs-number">1</span>:<br>                    loss *= WORLD_SIZE  <span class="hljs-comment"># gradient averaged between devices in DDP mode</span><br>                <span class="hljs-keyword">if</span> opt.quad:<br>                    loss *= <span class="hljs-number">4.</span><br><br>            <span class="hljs-comment"># åå‘ä¼ æ’­</span><br>            scaler.scale(loss).backward()<br><br>            <span class="hljs-comment"># ä¼˜åŒ–</span><br>            <span class="hljs-keyword">if</span> ni - last_opt_step &gt;= accumulate:<br>                scaler.step(optimizer)  <span class="hljs-comment"># optimizer.step</span><br>                scaler.update()<br>                optimizer.zero_grad()<br>                <span class="hljs-keyword">if</span> ema:<br>                    ema.update(model)<br>                last_opt_step = ni<br><br>            <span class="hljs-comment"># æ—¥å¿—è®°å½•</span><br>            <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> (-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>):<br>                mloss = (mloss * i + loss_items) / (i + <span class="hljs-number">1</span>)  <span class="hljs-comment"># update mean losses</span><br>                mem = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;torch.cuda.memory_reserved() / <span class="hljs-number">1E9</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>:<span class="hljs-number">.3</span>g&#125;</span>G&#x27;</span>  <span class="hljs-comment"># (GB)</span><br>                pbar.set_description((<span class="hljs-string">&#x27;%10s&#x27;</span> * <span class="hljs-number">2</span> + <span class="hljs-string">&#x27;%10.4g&#x27;</span> * <span class="hljs-number">5</span>) %<br>                                     (<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;epoch&#125;</span>/<span class="hljs-subst">&#123;epochs - <span class="hljs-number">1</span>&#125;</span>&#x27;</span>, mem, *mloss, targets.shape[<span class="hljs-number">0</span>], imgs.shape[-<span class="hljs-number">1</span>]))<br>                callbacks.run(<span class="hljs-string">&#x27;on_train_batch_end&#x27;</span>, ni, model, imgs, targets, paths, plots)<br>                <span class="hljs-keyword">if</span> callbacks.stop_training:<br>                    <span class="hljs-keyword">return</span><br>            <span class="hljs-comment"># end batch ------------------------------------------------------------------------------------------------</span><br><br>        <span class="hljs-comment"># æ›´æ–°ä¼˜åŒ–å™¨çš„å­¦ä¹ ç‡</span><br>        lr = [x[<span class="hljs-string">&#x27;lr&#x27;</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> optimizer.param_groups]  <span class="hljs-comment"># for loggers</span><br>        scheduler.step()<br><br>        <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> (-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>):<br>            <span class="hljs-comment"># mAP</span><br>            callbacks.run(<span class="hljs-string">&#x27;on_train_epoch_end&#x27;</span>, epoch=epoch)<br>            ema.update_attr(model, include=[<span class="hljs-string">&#x27;yaml&#x27;</span>, <span class="hljs-string">&#x27;nc&#x27;</span>, <span class="hljs-string">&#x27;hyp&#x27;</span>, <span class="hljs-string">&#x27;names&#x27;</span>, <span class="hljs-string">&#x27;stride&#x27;</span>, <span class="hljs-string">&#x27;class_weights&#x27;</span>])<br>            final_epoch = (epoch + <span class="hljs-number">1</span> == epochs) <span class="hljs-keyword">or</span> stopper.possible_stop<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> noval <span class="hljs-keyword">or</span> final_epoch:  <span class="hljs-comment"># Calculate mAP</span><br>                results, maps, _ = val.run(data_dict,	<span class="hljs-comment"># æµ‹è¯•è®¡ç®—mAPï¼Œç»†çœ‹å¯ä»¥å»çœ‹åŒçº§ç›®å½•çš„val.py</span><br>                                           batch_size=batch_size // WORLD_SIZE * <span class="hljs-number">2</span>,<br>                                           imgsz=imgsz,<br>                                           model=ema.ema,<br>                                           single_cls=single_cls,<br>                                           dataloader=val_loader,<br>                                           save_dir=save_dir,<br>                                           plots=<span class="hljs-literal">False</span>,<br>                                           callbacks=callbacks,<br>                                           compute_loss=compute_loss)<br><br>            <span class="hljs-comment"># æ›´æ–°æœ€å¥½çš„mAP</span><br>            fi = fitness(np.array(results).reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>))  <span class="hljs-comment"># weighted combination of [P, R, mAP@.5, mAP@.5-.95]</span><br>            <span class="hljs-keyword">if</span> fi &gt; best_fitness:<br>                best_fitness = fi<br>            log_vals = <span class="hljs-built_in">list</span>(mloss) + <span class="hljs-built_in">list</span>(results) + lr<br>            callbacks.run(<span class="hljs-string">&#x27;on_fit_epoch_end&#x27;</span>, log_vals, epoch, best_fitness, fi)<br><br>            <span class="hljs-comment"># ä¿å­˜æ¨¡å‹</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> nosave) <span class="hljs-keyword">or</span> (final_epoch <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> evolve):  <span class="hljs-comment"># if save</span><br>                ckpt = &#123;<br>                    <span class="hljs-string">&#x27;epoch&#x27;</span>: epoch,<br>                    <span class="hljs-string">&#x27;best_fitness&#x27;</span>: best_fitness,<br>                    <span class="hljs-string">&#x27;model&#x27;</span>: deepcopy(de_parallel(model)).half(),<br>                    <span class="hljs-string">&#x27;ema&#x27;</span>: deepcopy(ema.ema).half(),<br>                    <span class="hljs-string">&#x27;updates&#x27;</span>: ema.updates,<br>                    <span class="hljs-string">&#x27;optimizer&#x27;</span>: optimizer.state_dict(),<br>                    <span class="hljs-string">&#x27;wandb_id&#x27;</span>: loggers.wandb.wandb_run.<span class="hljs-built_in">id</span> <span class="hljs-keyword">if</span> loggers.wandb <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,<br>                    <span class="hljs-string">&#x27;date&#x27;</span>: datetime.now().isoformat()&#125;<br><br>                <span class="hljs-comment"># ä¿å­˜æœ€å¥½çš„å’Œæœ€åä¸€ä¸ªçš„æ¨¡å‹</span><br>                torch.save(ckpt, last)<br>                <span class="hljs-keyword">if</span> best_fitness == fi:<br>                    torch.save(ckpt, best)<br>                <span class="hljs-keyword">if</span> (epoch &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">and</span> (opt.save_period &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">and</span> (epoch % opt.save_period == <span class="hljs-number">0</span>):<br>                    torch.save(ckpt, w / <span class="hljs-string">f&#x27;epoch<span class="hljs-subst">&#123;epoch&#125;</span>.pt&#x27;</span>)<br>                <span class="hljs-keyword">del</span> ckpt<br>                callbacks.run(<span class="hljs-string">&#x27;on_model_save&#x27;</span>, last, epoch, final_epoch, best_fitness, fi)<br><br>            <span class="hljs-comment"># Stop Single-GPU</span><br>            <span class="hljs-keyword">if</span> RANK == -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> stopper(epoch=epoch, fitness=fi):<br>                <span class="hljs-keyword">break</span><br><br>            <span class="hljs-comment"># Stop DDP <span class="hljs-doctag">TODO:</span> known issues shttps://github.com/ultralytics/yolov5/pull/4576</span><br>            <span class="hljs-comment"># stop = stopper(epoch=epoch, fitness=fi)</span><br>            <span class="hljs-comment"># if RANK == 0:</span><br>            <span class="hljs-comment">#    dist.broadcast_object_list([stop], 0)  # broadcast &#x27;stop&#x27; to all ranks</span><br><br>        <span class="hljs-comment"># Stop DPP</span><br>        <span class="hljs-comment"># with torch_distributed_zero_first(RANK):</span><br>        <span class="hljs-comment"># if stop:</span><br>        <span class="hljs-comment">#    break  # must break all DDP ranks</span><br><br>        <span class="hljs-comment"># end epoch ----------------------------------------------------------------------------------------------------</span><br>    <span class="hljs-comment"># end training -----------------------------------------------------------------------------------------------------</span><br>    <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> (-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>):<br>        LOGGER.info(<span class="hljs-string">f&#x27;\n<span class="hljs-subst">&#123;epoch - start_epoch + <span class="hljs-number">1</span>&#125;</span> epochs completed in <span class="hljs-subst">&#123;(time.time() - t0) / <span class="hljs-number">3600</span>:<span class="hljs-number">.3</span>f&#125;</span> hours.&#x27;</span>)<br>        <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> last, best:<br>            <span class="hljs-keyword">if</span> f.exists():<br>                strip_optimizer(f)  <span class="hljs-comment"># strip optimizers</span><br>                <span class="hljs-keyword">if</span> f <span class="hljs-keyword">is</span> best:<br>                    LOGGER.info(<span class="hljs-string">f&#x27;\nValidating <span class="hljs-subst">&#123;f&#125;</span>...&#x27;</span>)<br>                    results, _, _ = val.run(	<span class="hljs-comment"># æµ‹è¯•æœ€å¥½æ¨¡å‹çš„mAP</span><br>                        data_dict,<br>                        batch_size=batch_size // WORLD_SIZE * <span class="hljs-number">2</span>,<br>                        imgsz=imgsz,<br>                        model=attempt_load(f, device).half(),<br>                        iou_thres=<span class="hljs-number">0.65</span> <span class="hljs-keyword">if</span> is_coco <span class="hljs-keyword">else</span> <span class="hljs-number">0.60</span>,  <span class="hljs-comment"># best pycocotools results at 0.65</span><br>                        single_cls=single_cls,<br>                        dataloader=val_loader,<br>                        save_dir=save_dir,<br>                        save_json=is_coco,<br>                        verbose=<span class="hljs-literal">True</span>,<br>                        plots=plots,<br>                        callbacks=callbacks,<br>                        compute_loss=compute_loss)  <span class="hljs-comment"># val best model with plots</span><br>                    <span class="hljs-keyword">if</span> is_coco:<br>                        callbacks.run(<span class="hljs-string">&#x27;on_fit_epoch_end&#x27;</span>, <span class="hljs-built_in">list</span>(mloss) + <span class="hljs-built_in">list</span>(results) + lr, epoch, best_fitness, fi)<br><br>        callbacks.run(<span class="hljs-string">&#x27;on_train_end&#x27;</span>, last, best, plots, epoch, results)<br>        LOGGER.info(<span class="hljs-string">f&quot;Results saved to <span class="hljs-subst">&#123;colorstr(<span class="hljs-string">&#x27;bold&#x27;</span>, save_dir)&#125;</span>&quot;</span>)<br><br>    torch.cuda.empty_cache()<br>    <span class="hljs-keyword">return</span> results<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_opt</span>(<span class="hljs-params">known=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-comment"># è¿›è¡Œå‘½ä»¤è¡Œå‚æ•°è§£æ</span><br>    parser = argparse.ArgumentParser()<br>    <span class="hljs-comment"># è¦ä½¿ç”¨çš„æƒé‡æ–‡ä»¶</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--weights&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=ROOT / <span class="hljs-string">&#x27;yolov5s.pt&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;initial weights path&#x27;</span>)<br>    <span class="hljs-comment"># ä½¿ç”¨çš„æ¨¡å‹çš„yamlæ–‡ä»¶ä½ç½®</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--cfg&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;model.yaml path&#x27;</span>)<br>    <span class="hljs-comment"># æ•°æ®é›†çš„yamlä½ç½®</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--data&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=ROOT / <span class="hljs-string">&#x27;data/coco128.yaml&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;dataset.yaml path&#x27;</span>)<br>    <span class="hljs-comment"># è¶…å‚æ•°yamlä½ç½®</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--hyp&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=ROOT / <span class="hljs-string">&#x27;data/hyps/hyp.scratch-low.yaml&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;hyperparameters path&#x27;</span>)<br>    <span class="hljs-comment"># è®¾ç½®epoch</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--epochs&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">300</span>)<br>    <span class="hljs-comment"># è®¾ç½®batch_size</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--batch-size&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">16</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;total batch size for all GPUs, -1 for autobatch&#x27;</span>)<br>    <span class="hljs-comment"># è®¾ç½®ç…§ç‰‡size</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--imgsz&#x27;</span>, <span class="hljs-string">&#x27;--img&#x27;</span>, <span class="hljs-string">&#x27;--img-size&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">640</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;train, val image size (pixels)&#x27;</span>)<br>    <span class="hljs-comment"># å»é™¤åœ¨ä»¿å°„å˜æ¢æˆ(640,640)æ—¶çš„å†—ä½™æ•°æ®ï¼Œä»¤çŸ­è¾¹æ»¡è¶³32çš„å€æ•°å³å¯</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--rect&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;rectangular training&#x27;</span>)<br>    <span class="hljs-comment"># æ¢å¤æœ€è¿‘çš„è®­ç»ƒï¼Œå³æ–­ç‚¹</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--resume&#x27;</span>, nargs=<span class="hljs-string">&#x27;?&#x27;</span>, const=<span class="hljs-literal">True</span>, default=<span class="hljs-literal">False</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;resume most recent training&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦åªä¿ç•™æœ€åä¸€è½®çš„ptæ–‡ä»¶</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--nosave&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;only save final checkpoint&#x27;</span>)<br>    <span class="hljs-comment"># åªåœ¨æœ€åä¸€è½®ä¸Šé¢æµ‹è¯•map</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--noval&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;only validate final epoch&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦ç¦ç”¨è‡ªåŠ¨é”šæ¡†ï¼Œé»˜è®¤å¼€å¯ï¼Œå¯ä»¥ç®€åŒ–è®­ç»ƒè¿‡ç¨‹</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--noautoanchor&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;disable AutoAnchor&#x27;</span>)<br>    <span class="hljs-comment"># å¼€å¯åä¸ä¿å­˜ç»˜å›¾æ–‡ä»¶</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--noplots&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;save no plot files&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦ä½¿ç”¨é—ä¼ ç®—æ³•æ¥è¿›è¡Œè¶…å‚æ•°è¿›åŒ–ï¼Œä¼šæ¶ˆè€—å¤§é‡çš„èµ„æºå’Œæ—¶é—´</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--evolve&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, nargs=<span class="hljs-string">&#x27;?&#x27;</span>, const=<span class="hljs-number">300</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;evolve hyperparameters for x generations&#x27;</span>)<br>    <span class="hljs-comment"># ä¸‹è½½è°·æ­Œäº‘ç›˜çš„ä¸œè¥¿ï¼Œæ²¡ç”¨ï¼</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--bucket&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;gsutil bucket&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦æå‰ç¼“å­˜ç…§ç‰‡åˆ°å†…å­˜ï¼ŒåŠ å¿«è®­ç»ƒé€Ÿåº¦</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--cache&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, nargs=<span class="hljs-string">&#x27;?&#x27;</span>, const=<span class="hljs-string">&#x27;ram&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;--cache images in &quot;ram&quot; (default) or &quot;disk&quot;&#x27;</span>)<br>    <span class="hljs-comment"># å›¾åƒåŠ æƒç­–ç•¥ï¼Œé»˜è®¤ä¸å¼€å¯ï¼Œè§£å†³æ ·æœ¬ä¸å‡è¡¡ï¼Œå¯¹äºä¸Šä¸€è½®è®­ç»ƒä¸å¥½çš„ç…§ç‰‡ï¼Œä¸‹ä¸€è½®åŠ ä¸€äº›æƒé‡</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--image-weights&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;use weighted image selection for training&#x27;</span>)<br>    <span class="hljs-comment"># æŒ‡å®šè®¾å¤‡ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ¤æ–­</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--device&#x27;</span>, default=<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;cuda device, i.e. 0 or 0,1,2,3 or cpu&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦å¯åŠ¨å¤šå°ºåº¦è®­ç»ƒï¼Œé»˜è®¤ä¸å¼€å¯ï¼Œä¼šä½¿ç”¨ä¸åŒè¾“å…¥å°ºåº¦çš„å›¾ç‰‡ï¼Œå¯ä»¥å¢å¼ºæ¨¡å‹çš„é²æ£’æ€§</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--multi-scale&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;vary img-size +/- 50%%&#x27;</span>)<br>    <span class="hljs-comment"># è®­ç»ƒé›†æ˜¯å¤šç±»åˆ«è¿˜æ˜¯å•ç±»åˆ«ï¼Œé»˜è®¤å¤šç±»åˆ«</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--single-cls&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;train multi-class data as single-class&#x27;</span>)<br>    <span class="hljs-comment"># ä¼˜åŒ–å™¨ï¼Œé»˜è®¤SGDï¼Œå¯ä»¥ä½¿ç”¨SGDï¼ŒAdamï¼ŒAdamW</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--optimizer&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, choices=[<span class="hljs-string">&#x27;SGD&#x27;</span>, <span class="hljs-string">&#x27;Adam&#x27;</span>, <span class="hljs-string">&#x27;AdamW&#x27;</span>], default=<span class="hljs-string">&#x27;SGD&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;optimizer&#x27;</span>)<br>    <span class="hljs-comment"># å¤šGPUåˆ†å¸ƒå¼è®­ç»ƒ</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--sync-bn&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;use SyncBatchNorm, only available in DDP mode&#x27;</span>)<br>    <span class="hljs-comment"># æœ€å¤§workersçš„æ•°é‡</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--workers&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">8</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;max dataloader workers (per RANK in DDP mode)&#x27;</span>)<br>    <span class="hljs-comment"># è®­ç»ƒå¥½çš„æ¨¡å‹ä¿å­˜åœ°å€</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--project&#x27;</span>, default=ROOT / <span class="hljs-string">&#x27;runs/train&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;save to project/name&#x27;</span>)<br>    <span class="hljs-comment"># æ¨¡å‹çš„ä¿å­˜æ–‡ä»¶å¤¹å</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--name&#x27;</span>, default=<span class="hljs-string">&#x27;exp&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;save to project/name&#x27;</span>)<br>    <span class="hljs-comment"># æ¯æ¬¡é¢„æµ‹æ¨¡å‹çš„ç»“æœæ˜¯å¦ä¿å­˜åœ¨åŸæ¥çš„æ–‡ä»¶å¤¹ï¼Œå¦‚æœæŒ‡å®šäº†è¿™ä¸ªå‚æ•°çš„è¯ï¼Œé‚£ä¹ˆæœ¬æ¬¡é¢„æµ‹çš„ç»“æœè¿˜æ˜¯ä¿å­˜åœ¨ä¸Šä¸€æ¬¡ä¿å­˜çš„æ–‡ä»¶å¤¹é‡Œï¼Œå¦‚æœä¸æŒ‡å®šå°±æ˜¯æ¯æ¬¡é¢„æµ‹ç»“æœä¿å­˜ä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹ä¸‹ã€‚</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--exist-ok&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;existing project/name ok, do not increment&#x27;</span>)<br>    <span class="hljs-comment"># å¦‚æœå¼€å¯çš„è¯å¯¹é«˜åˆ†è¾¨ç‡çš„æ•°æ®é›†æ•ˆæœæ¯”è¾ƒå¥½</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--quad&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;quad dataloader&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦å¼€å¯ä½™å¼¦å­¦ä¹ ç‡</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--cos-lr&#x27;</span>, action=<span class="hljs-string">&#x27;store_true&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;cosine LR scheduler&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦å¯¹æ ‡ç­¾è¿›è¡Œå¹³æ»‘å¤„ç†ï¼Œé»˜è®¤ä¸å¼€å¯ï¼Œåœ¨è®­ç»ƒæ ·æœ¬ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯æ‰€æœ‰sampleéƒ½æ ‡æ³¨æ­£ç¡®ï¼Œå¦‚æœæŸä¸ªæ ·æœ¬æ ‡æ³¨é”™è¯¯ï¼Œå°±å¯èƒ½äº§ç”Ÿè´Ÿé¢å°è±¡ï¼Œå¦‚æœæˆ‘ä»¬æœ‰åŠæ³•å‘Šè¯‰æ¨¡å‹ï¼Œæ ·æœ¬çš„æ ‡ç­¾ä¸ä¸€å®šæ­£ç¡®</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--label-smoothing&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">float</span>, default=<span class="hljs-number">0.0</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Label smoothing epsilon&#x27;</span>)<br>    <span class="hljs-comment"># å¦‚æœæ¨¡å‹åœ¨è®¾å®šçš„è½®æ•°ä¸­ä¸€ç›´æ²¡æœ‰æå‡ï¼Œé‚£å°±ç»ˆæ­¢è®­ç»ƒ</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--patience&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">100</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;EarlyStopping patience (epochs without improvement)&#x27;</span>)<br>    <span class="hljs-comment"># æŒ‡å®šå†»ç»“å±‚ï¼Œå°±æ˜¯ä»¤ä¸€äº›å±‚çš„å‚æ•°ä¸å˜ï¼Œä¸è®­ç»ƒ</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--freeze&#x27;</span>, nargs=<span class="hljs-string">&#x27;+&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=[<span class="hljs-number">0</span>], <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Freeze layers: backbone=10, first3=0 1 2&#x27;</span>)<br>    <span class="hljs-comment"># å¤šå°‘ä¸ªepochä¿å­˜ä¸€æ¬¡checkpoints</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--save-period&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=-<span class="hljs-number">1</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Save checkpoint every x epochs (disabled if &lt; 1)&#x27;</span>)<br>    <span class="hljs-comment"># ç”¨äºå¤šå¡è®­ç»ƒï¼Œå•å¡ä¸ç”¨è®¾ç½®</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--local_rank&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=-<span class="hljs-number">1</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;DDP parameter, do not modify&#x27;</span>)<br><br>    <span class="hljs-comment"># Weights &amp; Biases arguments</span><br>    <span class="hljs-comment"># åœ¨çº¿å¯è§†åŒ–å·¥å…·</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--entity&#x27;</span>, default=<span class="hljs-literal">None</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;W&amp;B: Entity&#x27;</span>)<br>    <span class="hljs-comment"># æ˜¯å¦ä¸Šä¼ æ•°æ®é›†åˆ°wandb table</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--upload_dataset&#x27;</span>, nargs=<span class="hljs-string">&#x27;?&#x27;</span>, const=<span class="hljs-literal">True</span>, default=<span class="hljs-literal">False</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;W&amp;B: Upload data, &quot;val&quot; option&#x27;</span>)<br>    <span class="hljs-comment"># è®¾ç½®ç•Œæ¡†å›¾åƒè®°å½•é—´éš”</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--bbox_interval&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=-<span class="hljs-number">1</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;W&amp;B: Set bounding-box image logging interval&#x27;</span>)<br>    <span class="hljs-comment"># ä½œè€…è¿˜æœªå®ç°</span><br>    parser.add_argument(<span class="hljs-string">&#x27;--artifact_alias&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-string">&#x27;latest&#x27;</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;W&amp;B: Version of dataset artifact to use&#x27;</span>)<br>	<span class="hljs-comment"># parse_known_args()è¿”å›çš„æ˜¯ä¸€ä¸ªæœ‰ä¸¤ä¸ªå…ƒç´ çš„å…ƒç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯NameSpaceï¼Œç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ªåˆ—è¡¨ã€‚</span><br>    <span class="hljs-comment"># NameSpaceå°±æ˜¯æˆ‘ä»¬å‘½ä»¤è¡Œè¾“å…¥çš„ä¸œè¥¿</span><br>    <span class="hljs-comment"># parse_args()åªæœ‰ä¸€ä¸ªNameSpace</span><br>    opt = parser.parse_known_args()[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> known <span class="hljs-keyword">else</span> parser.parse_args()<br>    <span class="hljs-keyword">return</span> opt<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">opt, callbacks=Callbacks(<span class="hljs-params"></span>)</span>):<br>    <span class="hljs-comment"># Checks</span><br>    <span class="hljs-keyword">if</span> RANK <span class="hljs-keyword">in</span> (-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>):<br>        print_args(<span class="hljs-built_in">vars</span>(opt))<br>        check_git_status()<br>        check_requirements(exclude=[<span class="hljs-string">&#x27;thop&#x27;</span>])<br><br>    <span class="hljs-comment"># å¦‚æœä½¿ç”¨æ–­ç‚¹è®­ç»ƒ</span><br>    <span class="hljs-keyword">if</span> opt.resume <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> check_wandb_resume(opt) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> opt.evolve:  <span class="hljs-comment"># resume an interrupted run</span><br>        <span class="hljs-comment"># get_last_run()è¿”å›æœ€åä¸€æ¬¡è®­ç»ƒçš„ptåœ°å€</span><br>        ckpt = opt.resume <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(opt.resume, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> get_latest_run()  <span class="hljs-comment"># specified or most recent path</span><br>        <span class="hljs-comment"># æŸ¥çœ‹æ˜¯å¦åœ°å€æ­£ç¡®</span><br>        <span class="hljs-keyword">assert</span> os.path.isfile(ckpt), <span class="hljs-string">&#x27;ERROR: --resume checkpoint does not exist&#x27;</span><br>        <span class="hljs-comment"># æ‰“å¼€ä¸Šæ¬¡è®­ç»ƒçš„optå‚æ•°æ–‡ä»¶</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(Path(ckpt).parent.parent / <span class="hljs-string">&#x27;opt.yaml&#x27;</span>, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            <span class="hljs-comment"># æ›¿æ¢å‚æ•°</span><br>            opt = argparse.Namespace(**yaml.safe_load(f)) <br>        <span class="hljs-comment"># è®¾ç½®å…¶ä¸­ä¸€äº›å‚æ•°</span><br>        opt.cfg, opt.weights, opt.resume = <span class="hljs-string">&#x27;&#x27;</span>, ckpt, <span class="hljs-literal">True</span>  <span class="hljs-comment"># reinstate</span><br>        LOGGER.info(<span class="hljs-string">f&#x27;Resuming training from <span class="hljs-subst">&#123;ckpt&#125;</span>&#x27;</span>)<br>    <span class="hljs-comment"># å¦‚æœä¸ä½¿ç”¨æ–­ç‚¹è®­ç»ƒ</span><br>	<span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># æŸ¥çœ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±ä»ç½‘ä¸Šä¸‹è½½</span><br>        opt.data, opt.cfg, opt.hyp, opt.weights, opt.project = \<br>            check_file(opt.data), check_yaml(opt.cfg), check_yaml(opt.hyp), <span class="hljs-built_in">str</span>(opt.weights), <span class="hljs-built_in">str</span>(opt.project)  <br>        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(opt.cfg) <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(opt.weights), <span class="hljs-string">&#x27;either --cfg or --weights must be specified&#x27;</span><br>        <span class="hljs-comment"># å¦‚æœä½¿ç”¨é—ä¼ ç®—æ³•æ›´æ–°è¶…å‚æ•°</span><br>        <span class="hljs-keyword">if</span> opt.evolve:<br>            <span class="hljs-comment"># å¦‚æœä½¿ç”¨é»˜è®¤çš„ä¿å­˜è·¯å¾„ï¼Œé‚£ä¹ˆä¿®æ”¹æˆruns/evolve</span><br>            <span class="hljs-keyword">if</span> opt.project == <span class="hljs-built_in">str</span>(ROOT / <span class="hljs-string">&#x27;runs/train&#x27;</span>): <br>                opt.project = <span class="hljs-built_in">str</span>(ROOT / <span class="hljs-string">&#x27;runs/evolve&#x27;</span>)<br>            opt.exist_ok, opt.resume = opt.resume, <span class="hljs-literal">False</span>  <span class="hljs-comment"># pass resume to exist_ok and disable resume</span><br>        <span class="hljs-comment"># å¦‚æœnameå‚æ•°è®¾ç½®ä¸ºcfgï¼Œé‚£ä¹ˆä½¿ç”¨model.yamlä½œä¸ºåå­—</span><br>        <span class="hljs-keyword">if</span> opt.name == <span class="hljs-string">&#x27;cfg&#x27;</span>:<br>            opt.name = Path(opt.cfg).stem <br>        opt.save_dir = <span class="hljs-built_in">str</span>(increment_path(Path(opt.project) / opt.name, exist_ok=opt.exist_ok))<br><br>    <span class="hljs-comment"># DDP mode</span><br>    <span class="hljs-comment"># æ²¡ç”¨ä¸ç”¨çœ‹</span><br>    device = select_device(opt.device, batch_size=opt.batch_size)<br>    <span class="hljs-keyword">if</span> LOCAL_RANK != -<span class="hljs-number">1</span>:<br>        msg = <span class="hljs-string">&#x27;is not compatible with YOLOv5 Multi-GPU DDP training&#x27;</span><br>        <span class="hljs-keyword">assert</span> <span class="hljs-keyword">not</span> opt.image_weights, <span class="hljs-string">f&#x27;--image-weights <span class="hljs-subst">&#123;msg&#125;</span>&#x27;</span><br>        <span class="hljs-keyword">assert</span> <span class="hljs-keyword">not</span> opt.evolve, <span class="hljs-string">f&#x27;--evolve <span class="hljs-subst">&#123;msg&#125;</span>&#x27;</span><br>        <span class="hljs-keyword">assert</span> opt.batch_size != -<span class="hljs-number">1</span>, <span class="hljs-string">f&#x27;AutoBatch with --batch-size -1 <span class="hljs-subst">&#123;msg&#125;</span>, please pass a valid --batch-size&#x27;</span><br>        <span class="hljs-keyword">assert</span> opt.batch_size % WORLD_SIZE == <span class="hljs-number">0</span>, <span class="hljs-string">f&#x27;--batch-size <span class="hljs-subst">&#123;opt.batch_size&#125;</span> must be multiple of WORLD_SIZE&#x27;</span><br>        <span class="hljs-keyword">assert</span> torch.cuda.device_count() &gt; LOCAL_RANK, <span class="hljs-string">&#x27;insufficient CUDA devices for DDP command&#x27;</span><br>        torch.cuda.set_device(LOCAL_RANK)<br>        device = torch.device(<span class="hljs-string">&#x27;cuda&#x27;</span>, LOCAL_RANK)<br>        dist.init_process_group(backend=<span class="hljs-string">&quot;nccl&quot;</span> <span class="hljs-keyword">if</span> dist.is_nccl_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;gloo&quot;</span>)<br><br>    <span class="hljs-comment"># Train</span><br>    <span class="hljs-comment"># å¦‚æœä¸ä½¿ç”¨é—ä¼ ç®—æ³•æ›´æ–°è¶…å‚æ•°</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> opt.evolve:<br>        <span class="hljs-comment"># å°†æ•°æ®ä¼ è¿›train()é‡Œé¢ï¼Œå¼€å§‹çœ‹train()ï¼</span><br>        train(opt.hyp, opt, device, callbacks)<br>        <span class="hljs-keyword">if</span> WORLD_SIZE &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> RANK == <span class="hljs-number">0</span>:<br>            LOGGER.info(<span class="hljs-string">&#x27;Destroying process group... &#x27;</span>)<br>            dist.destroy_process_group()<br><br>    <span class="hljs-comment"># å¦‚æœä½¿ç”¨é—ä¼ ç®—æ³•æ›´æ–°è¶…å‚æ•°ï¼Œä¸€èˆ¬ä¸ç”¨å¯ä»¥ä¸ç”¨çœ‹ï¼Œmain()çœ‹åˆ°è¿™å°±è¡Œäº†ï¼Œå¦‚æœéœ€è¦å†ç»†çœ‹</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># Hyperparameter evolution metadata (mutation scale 0-1, lower_limit, upper_limit)</span><br>        meta = &#123;<br>            <span class="hljs-string">&#x27;lr0&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">1e-5</span>, <span class="hljs-number">1e-1</span>),  <span class="hljs-comment"># initial learning rate (SGD=1E-2, Adam=1E-3)</span><br>            <span class="hljs-string">&#x27;lrf&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># final OneCycleLR learning rate (lr0 * lrf)</span><br>            <span class="hljs-string">&#x27;momentum&#x27;</span>: (<span class="hljs-number">0.3</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.98</span>),  <span class="hljs-comment"># SGD momentum/Adam beta1</span><br>            <span class="hljs-string">&#x27;weight_decay&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.001</span>),  <span class="hljs-comment"># optimizer weight decay</span><br>            <span class="hljs-string">&#x27;warmup_epochs&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">5.0</span>),  <span class="hljs-comment"># warmup epochs (fractions ok)</span><br>            <span class="hljs-string">&#x27;warmup_momentum&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.95</span>),  <span class="hljs-comment"># warmup initial momentum</span><br>            <span class="hljs-string">&#x27;warmup_bias_lr&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.2</span>),  <span class="hljs-comment"># warmup initial bias lr</span><br>            <span class="hljs-string">&#x27;box&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.02</span>, <span class="hljs-number">0.2</span>),  <span class="hljs-comment"># box loss gain</span><br>            <span class="hljs-string">&#x27;cls&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">4.0</span>),  <span class="hljs-comment"># cls loss gain</span><br>            <span class="hljs-string">&#x27;cls_pw&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">2.0</span>),  <span class="hljs-comment"># cls BCELoss positive_weight</span><br>            <span class="hljs-string">&#x27;obj&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">4.0</span>),  <span class="hljs-comment"># obj loss gain (scale with pixels)</span><br>            <span class="hljs-string">&#x27;obj_pw&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">2.0</span>),  <span class="hljs-comment"># obj BCELoss positive_weight</span><br>            <span class="hljs-string">&#x27;iou_t&#x27;</span>: (<span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.7</span>),  <span class="hljs-comment"># IoU training threshold</span><br>            <span class="hljs-string">&#x27;anchor_t&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">8.0</span>),  <span class="hljs-comment"># anchor-multiple threshold</span><br>            <span class="hljs-string">&#x27;anchors&#x27;</span>: (<span class="hljs-number">2</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">10.0</span>),  <span class="hljs-comment"># anchors per output grid (0 to ignore)</span><br>            <span class="hljs-string">&#x27;fl_gamma&#x27;</span>: (<span class="hljs-number">0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">2.0</span>),  <span class="hljs-comment"># focal loss gamma (efficientDet default gamma=1.5)</span><br>            <span class="hljs-string">&#x27;hsv_h&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.1</span>),  <span class="hljs-comment"># image HSV-Hue augmentation (fraction)</span><br>            <span class="hljs-string">&#x27;hsv_s&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.9</span>),  <span class="hljs-comment"># image HSV-Saturation augmentation (fraction)</span><br>            <span class="hljs-string">&#x27;hsv_v&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.9</span>),  <span class="hljs-comment"># image HSV-Value augmentation (fraction)</span><br>            <span class="hljs-string">&#x27;degrees&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">45.0</span>),  <span class="hljs-comment"># image rotation (+/- deg)</span><br>            <span class="hljs-string">&#x27;translate&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.9</span>),  <span class="hljs-comment"># image translation (+/- fraction)</span><br>            <span class="hljs-string">&#x27;scale&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.9</span>),  <span class="hljs-comment"># image scale (+/- gain)</span><br>            <span class="hljs-string">&#x27;shear&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">10.0</span>),  <span class="hljs-comment"># image shear (+/- deg)</span><br>            <span class="hljs-string">&#x27;perspective&#x27;</span>: (<span class="hljs-number">0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.001</span>),  <span class="hljs-comment"># image perspective (+/- fraction), range 0-0.001</span><br>            <span class="hljs-string">&#x27;flipud&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># image flip up-down (probability)</span><br>            <span class="hljs-string">&#x27;fliplr&#x27;</span>: (<span class="hljs-number">0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># image flip left-right (probability)</span><br>            <span class="hljs-string">&#x27;mosaic&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># image mixup (probability)</span><br>            <span class="hljs-string">&#x27;mixup&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),  <span class="hljs-comment"># image mixup (probability)</span><br>            <span class="hljs-string">&#x27;copy_paste&#x27;</span>: (<span class="hljs-number">1</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>)&#125;  <span class="hljs-comment"># segment copy-paste (probability)</span><br><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(opt.hyp, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            hyp = yaml.safe_load(f)  <span class="hljs-comment"># load hyps dict</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;anchors&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> hyp:  <span class="hljs-comment"># anchors commented in hyp.yaml</span><br>                hyp[<span class="hljs-string">&#x27;anchors&#x27;</span>] = <span class="hljs-number">3</span><br>        opt.noval, opt.nosave, save_dir = <span class="hljs-literal">True</span>, <span class="hljs-literal">True</span>, Path(opt.save_dir)  <span class="hljs-comment"># only val/save final epoch</span><br>        <span class="hljs-comment"># ei = [isinstance(x, (int, float)) for x in hyp.values()]  # evolvable indices</span><br>        evolve_yaml, evolve_csv = save_dir / <span class="hljs-string">&#x27;hyp_evolve.yaml&#x27;</span>, save_dir / <span class="hljs-string">&#x27;evolve.csv&#x27;</span><br>        <span class="hljs-keyword">if</span> opt.bucket:<br>            os.system(<span class="hljs-string">f&#x27;gsutil cp gs://<span class="hljs-subst">&#123;opt.bucket&#125;</span>/evolve.csv <span class="hljs-subst">&#123;evolve_csv&#125;</span>&#x27;</span>)  <span class="hljs-comment"># download evolve.csv if exists</span><br><br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(opt.evolve):  <span class="hljs-comment"># generations to evolve</span><br>            <span class="hljs-keyword">if</span> evolve_csv.exists():  <span class="hljs-comment"># if evolve.csv exists: select best hyps and mutate</span><br>                <span class="hljs-comment"># Select parent(s)</span><br>                parent = <span class="hljs-string">&#x27;single&#x27;</span>  <span class="hljs-comment"># parent selection method: &#x27;single&#x27; or &#x27;weighted&#x27;</span><br>                x = np.loadtxt(evolve_csv, ndmin=<span class="hljs-number">2</span>, delimiter=<span class="hljs-string">&#x27;,&#x27;</span>, skiprows=<span class="hljs-number">1</span>)<br>                n = <span class="hljs-built_in">min</span>(<span class="hljs-number">5</span>, <span class="hljs-built_in">len</span>(x))  <span class="hljs-comment"># number of previous results to consider</span><br>                x = x[np.argsort(-fitness(x))][:n]  <span class="hljs-comment"># top n mutations</span><br>                w = fitness(x) - fitness(x).<span class="hljs-built_in">min</span>() + <span class="hljs-number">1E-6</span>  <span class="hljs-comment"># weights (sum &gt; 0)</span><br>                <span class="hljs-keyword">if</span> parent == <span class="hljs-string">&#x27;single&#x27;</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(x) == <span class="hljs-number">1</span>:<br>                    <span class="hljs-comment"># x = x[random.randint(0, n - 1)]  # random selection</span><br>                    x = x[random.choices(<span class="hljs-built_in">range</span>(n), weights=w)[<span class="hljs-number">0</span>]]  <span class="hljs-comment"># weighted selection</span><br>                <span class="hljs-keyword">elif</span> parent == <span class="hljs-string">&#x27;weighted&#x27;</span>:<br>                    x = (x * w.reshape(n, <span class="hljs-number">1</span>)).<span class="hljs-built_in">sum</span>(<span class="hljs-number">0</span>) / w.<span class="hljs-built_in">sum</span>()  <span class="hljs-comment"># weighted combination</span><br><br>                <span class="hljs-comment"># Mutate</span><br>                mp, s = <span class="hljs-number">0.8</span>, <span class="hljs-number">0.2</span>  <span class="hljs-comment"># mutation probability, sigma</span><br>                npr = np.random<br>                npr.seed(<span class="hljs-built_in">int</span>(time.time()))<br>                g = np.array([meta[k][<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> hyp.keys()])  <span class="hljs-comment"># gains 0-1</span><br>                ng = <span class="hljs-built_in">len</span>(meta)<br>                v = np.ones(ng)<br>                <span class="hljs-keyword">while</span> <span class="hljs-built_in">all</span>(v == <span class="hljs-number">1</span>):  <span class="hljs-comment"># mutate until a change occurs (prevent duplicates)</span><br>                    v = (g * (npr.random(ng) &lt; mp) * npr.randn(ng) * npr.random() * s + <span class="hljs-number">1</span>).clip(<span class="hljs-number">0.3</span>, <span class="hljs-number">3.0</span>)<br>                <span class="hljs-keyword">for</span> i, k <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(hyp.keys()):  <span class="hljs-comment"># plt.hist(v.ravel(), 300)</span><br>                    hyp[k] = <span class="hljs-built_in">float</span>(x[i + <span class="hljs-number">7</span>] * v[i])  <span class="hljs-comment"># mutate</span><br><br>            <span class="hljs-comment"># Constrain to limits</span><br>            <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> meta.items():<br>                hyp[k] = <span class="hljs-built_in">max</span>(hyp[k], v[<span class="hljs-number">1</span>])  <span class="hljs-comment"># lower limit</span><br>                hyp[k] = <span class="hljs-built_in">min</span>(hyp[k], v[<span class="hljs-number">2</span>])  <span class="hljs-comment"># upper limit</span><br>                hyp[k] = <span class="hljs-built_in">round</span>(hyp[k], <span class="hljs-number">5</span>)  <span class="hljs-comment"># significant digits</span><br><br>            <span class="hljs-comment"># Train mutation</span><br>            results = train(hyp.copy(), opt, device, callbacks)<br>            callbacks = Callbacks()<br>            <span class="hljs-comment"># Write mutation results</span><br>            print_mutation(results, hyp.copy(), save_dir, opt.bucket)<br><br>        <span class="hljs-comment"># Plot results</span><br>        plot_evolve(evolve_csv)<br>        LOGGER.info(<span class="hljs-string">f&#x27;Hyperparameter evolution finished <span class="hljs-subst">&#123;opt.evolve&#125;</span> generations\n&#x27;</span><br>                    <span class="hljs-string">f&quot;Results saved to <span class="hljs-subst">&#123;colorstr(<span class="hljs-string">&#x27;bold&#x27;</span>, save_dir)&#125;</span>\n&quot;</span><br>                    <span class="hljs-string">f&#x27;Usage example: $ python train.py --hyp <span class="hljs-subst">&#123;evolve_yaml&#125;</span>&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">**kwargs</span>):<br>    <span class="hljs-comment"># Usage: import train; train.run(data=&#x27;coco128.yaml&#x27;, imgsz=320, weights=&#x27;yolov5m.pt&#x27;)</span><br>    opt = parse_opt(<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> kwargs.items():<br>        <span class="hljs-comment"># æ„æ€æ˜¯opt.k = v</span><br>        <span class="hljs-built_in">setattr</span>(opt, k, v)<br>    main(opt)<br>    <span class="hljs-keyword">return</span> opt<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    opt = parse_opt()<br>    main(opt)<br></code></pre></div></td></tr></table></figure>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Deep-Learning/">Deep Learning</a>
                    
                      <a class="hover-with-bg" href="/categories/Deep-Learning/cv/">cv</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/09/30/yolov1/">
                        <span class="hidden-mobile">yolov1</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                

              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        loader: {
          load: ['ui/lazy']
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" ></script>

  











<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script>


</body>
</html>
